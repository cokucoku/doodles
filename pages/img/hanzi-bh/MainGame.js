var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
var dObject = (function () {
    function dObject() {
        this.objectId = dObject.g_objectId++;
    }
    dObject.InitStatic = function (fun) {
        dObject.s_initStatic.push(fun);
    };
    dObject.CallInitStatic = function () {
        for (var i = 0; i < dObject.s_initStatic.length; i++)
            dObject.s_initStatic[i]();
        dObject.s_initStatic.clear();
    };
    dObject.g_objectId = 1;
    dObject.s_initStatic = new Array();
    return dObject;
}());
var __dShaderUniformData = (function () {
    function __dShaderUniformData() {
        this.flag = 0;
        this.f1 = 0;
        this.f2 = 0;
        this.f3 = 0;
        this.f4 = 0;
        this.iData = 0;
        this.mat = null;
    }
    return __dShaderUniformData;
}());
var dShader = (function (_super) {
    __extends(dShader, _super);
    function dShader() {
        var _this = _super.call(this) || this;
        _this.m_attributeNameList = null;
        _this.m_vertexTypeList = null;
        _this.m_hVertexShader = null;
        _this.m_hFragmentShader = null;
        _this.m_hProgram = null;
        _this.m_vecAttributeList = new Array();
        _this.m_mapUniformLocationBuffer = new Map();
        _this.m_mapUniformData = new Map();
        for (var i = 0; i < 8; i++)
            _this.SetUniformI("sTexture" + i, i);
        dInterface.ptr.m_vecShaders.push(_this);
        return _this;
    }
    dShader.prototype.Release = function () {
        if (this.m_hVertexShader) {
            dInterface.ptr.webgl.deleteShader(this.m_hVertexShader);
            this.m_hVertexShader = null;
        }
        if (this.m_hFragmentShader) {
            dInterface.ptr.webgl.deleteShader(this.m_hFragmentShader);
            this.m_hFragmentShader = null;
        }
        if (this.m_hProgram) {
            dInterface.ptr.webgl.deleteProgram(this.m_hProgram);
            this.m_hProgram = null;
        }
        dInterface.ptr.m_vecShaders.remove(this);
    };
    dShader.GetAllShaders = function () {
        return dInterface.ptr.m_vecShaders;
    };
    dShader.prototype.Init = function (strVertex, strFragment, attributeNameList) {
        var webgl = dInterface.ptr.webgl;
        if (!webgl)
            return;
        this.m_attributeNameList = attributeNameList;
        this.m_hVertexShader = webgl.createShader(webgl.VERTEX_SHADER);
        this.m_hFragmentShader = webgl.createShader(webgl.FRAGMENT_SHADER);
        webgl.shaderSource(this.m_hVertexShader, strVertex);
        webgl.shaderSource(this.m_hFragmentShader, strFragment);
        webgl.compileShader(this.m_hVertexShader);
        webgl.compileShader(this.m_hFragmentShader);
        if (!webgl.getShaderParameter(this.m_hVertexShader, webgl.COMPILE_STATUS)) {
            console.log("getShaderParameter(this.m_hVertexShader error");
            console.log(webgl.getShaderInfoLog(this.m_hVertexShader));
            return;
        }
        if (!webgl.getShaderParameter(this.m_hFragmentShader, webgl.COMPILE_STATUS)) {
            console.log("getShaderParameter(this.m_hFragmentShader error");
            console.log(webgl.getShaderInfoLog(this.m_hFragmentShader));
            return;
        }
        this.m_hProgram = webgl.createProgram();
        webgl.attachShader(this.m_hProgram, this.m_hVertexShader);
        webgl.attachShader(this.m_hProgram, this.m_hFragmentShader);
        webgl.linkProgram(this.m_hProgram);
        if (!webgl.getProgramParameter(this.m_hProgram, webgl.LINK_STATUS)) {
            console.log("getProgramParameter(this.m_hProgram, webgl.LINK_STATUS error");
            console.log(webgl.getProgramInfoLog(this.m_hProgram));
            return;
        }
        webgl.useProgram(this.m_hProgram);
        this.m_vecAttributeList = new Array(attributeNameList.length);
        for (var i = 0; i < attributeNameList.length; i++)
            this.m_vecAttributeList[i] = this._GetAttribLocation(attributeNameList[i]);
    };
    dShader.prototype.GetAttributeNameList = function () {
        return this.m_attributeNameList;
    };
    dShader.prototype.SetUniformV2 = function (strName, v, z, w) {
        if (z === void 0) { z = 0; }
        if (w === void 0) { w = 0; }
        this.SetUniformF(strName, v.x, v.y, z, w);
    };
    dShader.prototype.SetUniformV3 = function (strName, v, w) {
        if (w === void 0) { w = 0; }
        this.SetUniformF(strName, v.x, v.y, v.z, w);
    };
    dShader.prototype.SetUniformV4 = function (strName, v) {
        this.SetUniformF(strName, v.x, v.y, v.z, v.w);
    };
    dShader.prototype.SetUniformF = function (strName, x, y, z, w) {
        var uniformData;
        if (!this.m_mapUniformData.has(strName))
            this.m_mapUniformData.set(strName, uniformData = new __dShaderUniformData());
        else
            uniformData = this.m_mapUniformData.get(strName);
        uniformData.flag = 1;
        uniformData.f1 = x;
        uniformData.f2 = y;
        uniformData.f3 = z;
        uniformData.f4 = w;
        ;
    };
    dShader.prototype.SetUniformI = function (strName, x) {
        var uniformData;
        if (!this.m_mapUniformData.has(strName))
            this.m_mapUniformData.set(strName, uniformData = new __dShaderUniformData());
        else
            uniformData = this.m_mapUniformData.get(strName);
        uniformData.flag = 2;
        uniformData.iData = x;
    };
    dShader.prototype.SetUniformMatrix = function (strName, mat, index) {
        if (index === void 0) { index = -1; }
        var uniformData;
        if (!this.m_mapUniformData.has(strName))
            this.m_mapUniformData.set(strName, uniformData = new __dShaderUniformData());
        else
            uniformData = this.m_mapUniformData.get(strName);
        uniformData.flag = 3;
        if (uniformData.mat == null)
            uniformData.mat = [];
        mat.ToArray(uniformData.mat);
        uniformData.iData = index;
    };
    dShader.prototype._Use = function () {
        dInterface.ptr.webgl.useProgram(this.m_hProgram);
        if (dInterface.ptr.m_pLastUseShader != this) {
            this._UpdateUniform();
            dInterface.ptr.m_pLastUseShader = this;
        }
    };
    dShader.prototype._Begin = function () {
        for (var i = 0; i < this.m_vecAttributeList.length; i++)
            dInterface.ptr.webgl.enableVertexAttribArray(this.m_vecAttributeList[i]);
    };
    dShader.prototype._End = function () {
        for (var i = 0; i < this.m_vecAttributeList.length; i++)
            dInterface.ptr.webgl.disableVertexAttribArray(this.m_vecAttributeList[i]);
    };
    dShader.prototype._GetAttribLocation = function (strName) {
        return dInterface.ptr.webgl.getAttribLocation(this.m_hProgram, strName);
    };
    dShader.prototype._GetUniformLocation = function (strName) {
        if (!this.m_mapUniformLocationBuffer.has(strName))
            this.m_mapUniformLocationBuffer.set(strName, dInterface.ptr.webgl.getUniformLocation(this.m_hProgram, strName));
        return this.m_mapUniformLocationBuffer.get(strName);
    };
    dShader.prototype._UpdateUniform = function () {
        var e_1, _a;
        var webgl = dInterface.ptr.webgl;
        try {
            for (var _b = __values(this.m_mapUniformData.keys()), _c = _b.next(); !_c.done; _c = _b.next()) {
                var name = _c.value;
                var uniformData = this.m_mapUniformData.get(name);
                var loc = this._GetUniformLocation(name);
                if (loc) {
                    if (uniformData.flag == 1) {
                        webgl.uniform4f(loc, uniformData.f1, uniformData.f2, uniformData.f3, uniformData.f4);
                    }
                    else if (uniformData.flag == 2) {
                        webgl.uniform1i(loc, uniformData.iData);
                    }
                    else if (uniformData.flag == 3) {
                        webgl.uniformMatrix4fv(loc, false, uniformData.mat);
                    }
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    dShader.prototype.SetWindowSize = function (w, h) {
    };
    dShader.GetHeader = function () {
        return "#ifdef GL_ES\n" +
            "#define LOWP lowp\n" +
            "#define HIGHP highp\n" +
            "#define MEDIUMP mediump\n" +
            "precision highp float;\n" +
            "#else\n" +
            "#define LOWP\n" +
            "#define HIGHP\n" +
            "#define MEDIUMP\n" +
            "#endif\n";
    };
    dShader.prototype.GetAllShaders = function () {
        return dInterface.ptr.m_vecShaders;
    };
    dShader.prototype.isInRender = function (pSprite, matWorld) {
        return 0;
    };
    dShader.prototype.GetVertexTypeList = function () {
        return this.m_vertexTypeList;
    };
    dShader.VertexTypeListEquals = function (a, b) {
        if (a == null || b == null || a.length != b.length)
            return false;
        for (var i = 0, n = a.length; i < n; i++) {
            if ((a[i] & 0xff) != (b[i] & 0xff))
                return false;
        }
        return true;
    };
    dShader.prototype.OnBindSprite = function (p) {
    };
    return dShader;
}(dObject));
var dSprite = (function (_super) {
    __extends(dSprite, _super);
    function dSprite() {
        var _this = _super.call(this) || this;
        _this.m_fPosX = 0.0;
        _this.m_fPosY = 0.0;
        _this.m_fPosZ = 0.0;
        _this.m_fWidth = 0.0;
        _this.m_fHeight = 0.0;
        _this.m_fDepth = 0.0;
        _this.m_fAnchorU = 0.0;
        _this.m_fAnchorV = 0.0;
        _this.m_fAnchorW = 0.0;
        _this.m_fScaleX = 1.0;
        _this.m_fScaleY = 1.0;
        _this.m_fScaleZ = 1.0;
        _this.m_fRotation = 0.0;
        _this.m_fRotationX = 0.0;
        _this.m_fRotationY = 0.0;
        _this.m_bShow = true;
        _this.m_pSpriteFather = null;
        _this.m_vecChildSprite = new Array();
        _this.m_fAlpha = 1.0;
        _this.m_nColorARGB = 0xFFFFFFFF;
        _this.m_matColorTransform = new dMatrix();
        _this.m_bClipChild = false;
        _this.m_nBlendMode = dSprite.DEFAULT_BLEND_MODE;
        _this.m_nSpriteFrame = 0;
        _this.m_pBindShader = null;
        _this.m_pBindMeshData = null;
        _this.m_nEnableZReadWrite = 0;
        _this.m_nEnableCulling = 0;
        _this.m_onTouchEvent = null;
        _this.m_pSetBitmapData = new Array(8);
        _this.m_bForceRender = false;
        _this.m_mapUniformData = new Map();
        _this.m_pSetBitmapDataSourceRect = null;
        _this.m_bHandleMouse = false;
        _this.m_bTransparentMouse = false;
        _this.m_bDestroyed = false;
        _this.m_matSpriteMatrixLocal = new dMatrix();
        _this.m_nLayoutAlign = 0;
        _this.m_strSpriteName = "";
        _this.m_vecLinkSprite = null;
        _this.m_nEnableClearFlag = 0;
        _this.m_matRenderMatrixSelf = new dMatrix();
        _this.m_matRenderMatrixWorld = new dMatrix();
        _this.m_bRenderMatrixDirty = true;
        _this.m_bRenderMatrixSelfDirty = true;
        _this.m_rcRenderForClip = new dRect();
        _this.m_vecFrameData = null;
        _this.SetShader(dSpriteDefaultShader.Instance());
        _this.SetMeshData(dSpriteDefaultShader.Instance().GetMeshData());
        _this._UpdateColor();
        _this._UpdateColorTransform();
        return _this;
    }
    dSprite.prototype.Destroy = function () {
        this.RemoveParent();
        this.m_bDestroyed = true;
    };
    dSprite.prototype.isDestroyed = function () {
        return this.m_bDestroyed;
    };
    dSprite.prototype.AddChild = function (pChild, at) {
        if (at === void 0) { at = -1; }
        if (pChild == null)
            return;
        if (pChild == this)
            throw "add child error";
        if (pChild.m_pSpriteFather != this) {
            if (pChild.m_pSpriteFather != null)
                pChild.RemoveParent();
            pChild.m_pSpriteFather = this;
            pChild.m_bRenderMatrixDirty = true;
            pChild.m_bRenderMatrixSelfDirty = true;
            if (at == -1)
                this.m_vecChildSprite.push(pChild);
            else
                this.m_vecChildSprite.insert(at, pChild);
        }
        else {
            if (at == -1)
                at = this.m_vecChildSprite.length - 1;
            if (this.m_vecChildSprite.indexOf(pChild) != at) {
                this.SetChildAt(pChild, at);
            }
        }
    };
    dSprite.prototype.RemoveChild = function (pChild) {
        if (pChild)
            pChild.RemoveParent();
    };
    dSprite.prototype.RemoveAllChild = function (bDestory) {
        if (bDestory === void 0) { bDestory = false; }
        for (var i = this.m_vecChildSprite.length - 1; i >= 0; i--) {
            if (bDestory)
                this.m_vecChildSprite[i].Destroy();
            this.RemoveChild(this.m_vecChildSprite[i]);
        }
    };
    dSprite.prototype.RemoveParent = function () {
        if (this.m_pSpriteFather != null) {
            this.m_pSpriteFather.m_vecChildSprite.remove(this);
            this.m_pSpriteFather = null;
        }
    };
    dSprite.prototype.GetParent = function () {
        return this.m_pSpriteFather;
    };
    dSprite.prototype.SetChildAt = function (pChild, at) {
        var find = this.m_vecChildSprite.indexOf(pChild);
        if (find != -1) {
            this.m_vecChildSprite.erase(find);
            if (at == -1)
                this.m_vecChildSprite.push(pChild);
            else
                this.m_vecChildSprite.insert(at, pChild);
        }
    };
    dSprite.prototype.GetChildList = function () {
        return this.m_vecChildSprite;
    };
    dSprite.prototype.GetChildListAt = function (at) {
        var vec = this.GetChildList();
        if (at >= 0 && at < vec.length)
            return vec[at];
        return null;
    };
    dSprite.prototype.SortChild = function (onSortFun) {
        var pSpriteBufferForSort = new Array();
        pSpriteBufferForSort.copy(this.m_vecChildSprite);
        pSpriteBufferForSort.sort(onSortFun);
        for (var i = 0, n = pSpriteBufferForSort.length; i < n; i++) {
            this.AddChild(pSpriteBufferForSort[i], i);
        }
    };
    dSprite.prototype.isInRoot = function () {
        var pRoot = dThread.GetRootSprite();
        var pFather = this.m_pSpriteFather;
        while (pFather != null) {
            if (pFather == pRoot)
                return true;
            pFather = pFather.m_pSpriteFather;
        }
        return false;
    };
    dSprite.prototype.isShowInRoot = function () {
        if (!this.isShow())
            return false;
        var pRoot = dThread.GetRootSprite();
        var pFather = this.GetParent();
        while (pFather != null) {
            if (pFather == pRoot)
                return true;
            if (!pFather.isShow())
                return false;
            pFather = pFather.m_pSpriteFather;
        }
        return false;
    };
    dSprite.prototype._AddLinkSprite = function (pSprite) {
        if (pSprite == this)
            return;
        if (this.m_vecLinkSprite == null)
            this.m_vecLinkSprite = new Array();
        if (this.m_vecLinkSprite.indexOf(pSprite) != -1)
            this.m_vecLinkSprite.remove(pSprite);
        this.m_vecLinkSprite.push(pSprite);
    };
    dSprite.prototype.AddLinkSprite = function (pSprite) {
        this._AddLinkSprite(pSprite);
        pSprite._AddLinkSprite(this);
    };
    dSprite.prototype._RemoveLinkSprite = function (pSprite) {
        if (this.m_vecLinkSprite != null && this.m_vecLinkSprite.indexOf(pSprite) != -1) {
            this.m_vecLinkSprite.remove(pSprite);
        }
    };
    dSprite.prototype.RemoveLinkSprite = function (pSprite) {
        this._RemoveLinkSprite(pSprite);
        pSprite._RemoveLinkSprite(this);
    };
    dSprite.prototype.GetLinkList = function () {
        return this.m_vecLinkSprite;
    };
    dSprite.prototype.isLinkOther = function (pOther) {
        if (this.m_vecLinkSprite == null)
            return false;
        return this.m_vecLinkSprite.indexOf(pOther) != -1;
    };
    dSprite.prototype.SetFrameDataList = function (dataList) {
        this.m_vecFrameData = dataList;
    };
    dSprite.prototype.SetFrame = function (frame, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = true; }
        if (this.m_nSpriteFrame != frame) {
            this.m_nSpriteFrame = frame;
            if (this.m_vecFrameData != null) {
                if (frame >= 0 && frame < this.m_vecFrameData.length) {
                    var frameData = this.m_vecFrameData[dMath.ToInt(frame)];
                    this.SetPos3D(frameData.x, frameData.y, frameData.z);
                    this.SetScale3D(frameData.sx, frameData.sy, frameData.sz);
                    this.SetRotation(frameData.rz);
                    if (frameData.rx != 0 && frameData.ry != 0)
                        this.SetRotationXY(frameData.rx, frameData.ry);
                    this.SetShow(frameData.visible != 0);
                    this.SetColor(frameData.spriteColor, false);
                    this.SetAlpha(frameData.alpha, false);
                }
            }
            if (bSetToChild) {
                for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
                    this.m_vecChildSprite[i].SetFrame(frame, bSetToChild);
            }
        }
    };
    dSprite.prototype.GetFrame = function () {
        return this.m_nSpriteFrame;
    };
    dSprite.prototype.GetMaxFrame = function () {
        return 0;
    };
    Object.defineProperty(dSprite.prototype, "spriteFrame", {
        get: function () {
            return this.GetFrame();
        },
        set: function (value) {
            this.SetFrame(value);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "spriteName", {
        get: function () {
            return this.m_strSpriteName;
        },
        set: function (str) {
            this.m_strSpriteName = str;
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.FindChild = function (strChildName) {
        for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
            if (this.m_vecChildSprite[i].spriteName == strChildName)
                return this.m_vecChildSprite[i];
        return null;
    };
    dSprite.prototype.SetPos = function (x, y) {
        if (this.m_fPosX != x || this.m_fPosY != y) {
            this.m_fPosX = x;
            this.m_fPosY = y;
            this.UpdateLocal();
            if (this.m_onTouchEvent)
                this.m_onTouchEvent.SetPos(x, y);
        }
    };
    dSprite.prototype.GetPosVector2 = function () {
        return new dVector2(this.positionX, this.positionY);
    };
    dSprite.prototype.SetPosVector2 = function (v) {
        this.SetPos(v.x, v.y);
    };
    dSprite.prototype.GetPosVector3 = function () {
        return new dVector3(this.positionX, this.positionY, this.positionZ);
    };
    dSprite.prototype.SetPosVector3 = function (v) {
        this.SetPos3D(v.x, v.y, v.z);
    };
    dSprite.prototype.GetPosX = function () {
        return this.m_fPosX;
    };
    dSprite.prototype.GetPosY = function () {
        return this.m_fPosY;
    };
    dSprite.prototype.GetPosZ = function () {
        return this.m_fPosZ;
    };
    Object.defineProperty(dSprite.prototype, "positionX", {
        get: function () {
            return this.GetPosX();
        },
        set: function (data) {
            this.SetPos(data, this.GetPosY());
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "positionY", {
        get: function () {
            return this.GetPosY();
        },
        set: function (data) {
            this.SetPos(this.GetPosX(), data);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "positionZ", {
        get: function () {
            return this.GetPosZ();
        },
        set: function (data) {
            this.SetPos3D(this.GetPosX(), this.GetPosY(), data);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "width", {
        get: function () {
            return this.GetWidth();
        },
        set: function (data) {
            this.SetSize(data, this.GetHeight());
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "height", {
        get: function () {
            return this.GetHeight();
        },
        set: function (data) {
            this.SetSize(this.GetWidth(), data);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "depth", {
        get: function () {
            return this.GetDepth();
        },
        set: function (data) {
            this.SetSize3D(this.width, this.height, data);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetAnchor = function (u, v) {
        if (this.m_fAnchorU != u || this.m_fAnchorV != v) {
            this.m_fAnchorU = u;
            this.m_fAnchorV = v;
            this.m_bRenderMatrixSelfDirty = true;
        }
    };
    dSprite.prototype.SetAnchor3D = function (u, v, w) {
        if (this.m_fAnchorU != u || this.m_fAnchorV != v || this.m_fAnchorW != w) {
            this.m_fAnchorU = u;
            this.m_fAnchorV = v;
            this.m_fAnchorW = w;
        }
    };
    dSprite.prototype.GetAnchorU = function () {
        return this.m_fAnchorU;
    };
    dSprite.prototype.GetAnchorV = function () {
        return this.m_fAnchorV;
    };
    dSprite.prototype.GetAnchorW = function () {
        return this.m_fAnchorW;
    };
    Object.defineProperty(dSprite.prototype, "anchorU", {
        get: function () {
            return this.GetAnchorU();
        },
        set: function (value) {
            this.SetAnchor(value, this.GetAnchorV());
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "anchorV", {
        get: function () {
            return this.GetAnchorV();
        },
        set: function (value) {
            this.SetAnchor(this.GetAnchorU(), value);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "anchorW", {
        get: function () {
            return this.GetAnchorW();
        },
        set: function (value) {
            this.SetAnchor3D(this.GetAnchorU(), this.GetAnchorV(), value);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetScale = function (x, y) {
        if (this.m_fScaleX != x || this.m_fScaleY != y) {
            this.m_fScaleX = x;
            this.m_fScaleY = y;
            this.UpdateLocal();
            if (this.m_onTouchEvent != null)
                this.m_onTouchEvent.SetScale(x, y);
        }
    };
    dSprite.prototype.GetScaleX = function () {
        return this.m_fScaleX;
    };
    dSprite.prototype.GetScaleY = function () {
        return this.m_fScaleY;
    };
    dSprite.prototype.GetScaleZ = function () {
        return this.m_fScaleZ;
    };
    dSprite.prototype.GetScaleX_World = function (rootStop, bWithRoot) {
        if (rootStop === void 0) { rootStop = null; }
        if (bWithRoot === void 0) { bWithRoot = true; }
        var mat = this.GetMatrixWorld(rootStop, bWithRoot);
        var sca = new dVector3();
        mat.Decompose(null, sca, null);
        return sca.x;
    };
    dSprite.prototype.GetScaleY_World = function (rootStop, bWithRoot) {
        if (rootStop === void 0) { rootStop = null; }
        if (bWithRoot === void 0) { bWithRoot = true; }
        var mat = this.GetMatrixWorld(rootStop, bWithRoot);
        var sca = new dVector3();
        mat.Decompose(null, sca, null);
        return sca.y;
    };
    Object.defineProperty(dSprite.prototype, "scaleX", {
        get: function () {
            return this.GetScaleX();
        },
        set: function (data) {
            this.SetScale(data, this.GetScaleY());
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "scaleY", {
        get: function () {
            return this.GetScaleY();
        },
        set: function (data) {
            this.SetScale(this.GetScaleX(), data);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "scaleZ", {
        get: function () {
            return this.GetScaleZ();
        },
        set: function (data) {
            this.SetScale3D(this.GetScaleX(), this.GetScaleY(), data);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetRotation = function (angle) {
        if (this.m_fRotation != angle) {
            this.m_fRotation = angle;
            this.UpdateLocal();
        }
    };
    dSprite.prototype.GetRotation = function () {
        return this.m_fRotation;
    };
    Object.defineProperty(dSprite.prototype, "rotation", {
        get: function () {
            return this.m_fRotation;
        },
        set: function (data) {
            this.SetRotation(data);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.GetPosX_World = function (rootStop, bWithRoot) {
        if (rootStop === void 0) { rootStop = null; }
        if (bWithRoot === void 0) { bWithRoot = true; }
        return this.GetMatrixWorld(rootStop, bWithRoot)._41;
    };
    dSprite.prototype.GetPosY_World = function (rootStop, bWithRoot) {
        if (rootStop === void 0) { rootStop = null; }
        if (bWithRoot === void 0) { bWithRoot = true; }
        return this.GetMatrixWorld(rootStop, bWithRoot)._42;
    };
    dSprite.prototype.GetPosZ_World = function (rootStop, bWithRoot) {
        if (rootStop === void 0) { rootStop = null; }
        if (bWithRoot === void 0) { bWithRoot = true; }
        return this.GetMatrixWorld(rootStop, bWithRoot)._43;
    };
    dSprite.prototype.GetPos_World = function (rootStop, bWithRoot) {
        if (rootStop === void 0) { rootStop = null; }
        if (bWithRoot === void 0) { bWithRoot = true; }
        var mat = this.GetMatrixWorld(rootStop, bWithRoot);
        return new dVector3(mat._41, mat._42, mat._43);
    };
    dSprite.prototype.GetPos_World3D = function (rootStop, bWithRoot) {
        if (rootStop === void 0) { rootStop = null; }
        if (bWithRoot === void 0) { bWithRoot = true; }
        var mat = this.GetMatrixWorld(rootStop, bWithRoot);
        return new dVector3(mat._41, mat._42, mat._43);
    };
    dSprite.prototype.SetRotationXY = function (x, y) {
        if (this.GetRotationX() != x || this.GetRotationY() != y) {
            this.m_fRotationX = x;
            this.m_fRotationY = y;
            this.UpdateLocal();
        }
    };
    dSprite.prototype.GetRotationX = function () {
        return this.m_fRotationX;
    };
    dSprite.prototype.GetRotationY = function () {
        return this.m_fRotationY;
    };
    Object.defineProperty(dSprite.prototype, "rotationX", {
        get: function () {
            return this.GetRotationX();
        },
        set: function (x) {
            this.SetRotationXY(x, this.GetRotationY());
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "rotationY", {
        get: function () {
            return this.GetRotationY();
        },
        set: function (y) {
            this.SetRotationXY(this.GetRotationX(), y);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetMatrixLocal = function (mat) {
        if (this.m_matSpriteMatrixLocal != mat)
            this.m_matSpriteMatrixLocal.Copy(mat);
        var vPos = new dVector3();
        var vScale = new dVector3();
        var matRot = new dMatrix();
        mat.Decompose(vPos, vScale, matRot);
        this.SetPos3D(vPos.x, vPos.y, vPos.z);
        this.SetScale3D(vScale.x, vScale.y, vScale.z);
        this.SetRotationMatrix(matRot);
    };
    dSprite.prototype.GetMatrixLocal = function () {
        this.m_matSpriteMatrixLocal.Scaling(this.m_fScaleX, this.m_fScaleY, this.m_fScaleZ);
        if (this.m_fRotationX != 0 || this.m_fRotationY != 0)
            this.m_matSpriteMatrixLocal.RotationEulerAppend(this.m_fRotationX, this.m_fRotationY, this.m_fRotation);
        else if (this.m_fRotation != 0)
            this.m_matSpriteMatrixLocal.RotationZAppend(dMath.AngleToRadian(this.m_fRotation));
        this.m_matSpriteMatrixLocal._41 += this.m_fPosX;
        this.m_matSpriteMatrixLocal._42 += this.m_fPosY;
        this.m_matSpriteMatrixLocal._43 += this.m_fPosZ;
        return this.m_matSpriteMatrixLocal;
    };
    dSprite.prototype._GetMatrixWorld = function (outData, rootStop, bWithRoot) {
        var p = this;
        while (p != null) {
            if (!bWithRoot && p == rootStop)
                break;
            dMatrix.Multiply(outData, outData, p.GetMatrixLocal());
            if (p == rootStop)
                break;
            p = p.GetParent();
        }
    };
    dSprite.prototype.GetMatrixWorld = function (rootStop, bWithRoot) {
        if (rootStop === void 0) { rootStop = null; }
        if (bWithRoot === void 0) { bWithRoot = true; }
        if (rootStop == this)
            return this.GetMatrixLocal();
        var ret = new dMatrix();
        ret.Identity();
        this._GetMatrixWorld(ret, rootStop, bWithRoot);
        return ret;
    };
    dSprite.prototype.SetSize = function (w, h) {
        if (this.m_fWidth != w || this.m_fHeight != h) {
            this.m_fWidth = w;
            this.m_fHeight = h;
            this.UpdateLocal();
            if (this.m_onTouchEvent != null)
                this.m_onTouchEvent.SetSize(w, h);
        }
    };
    dSprite.prototype.SetSize3D = function (w, h, d) {
        if (this.m_fWidth != w || this.m_fHeight != h || this.m_fDepth != d) {
            this.SetSize(w, h);
            this.m_fDepth = d;
            this.UpdateLocal();
            if (this.m_onTouchEvent != null)
                this.m_onTouchEvent.SetSize3D(w, h, d);
        }
    };
    dSprite.prototype.GetWidth = function () {
        return this.m_fWidth;
    };
    dSprite.prototype.GetHeight = function () {
        return this.m_fHeight;
    };
    dSprite.prototype.GetDepth = function () {
        return this.m_fDepth;
    };
    dSprite.prototype.SetShow = function (bShow) {
        if (this.m_bShow != bShow) {
            this.m_bShow = bShow;
        }
    };
    dSprite.prototype.isShow = function () {
        return this.m_bShow;
    };
    Object.defineProperty(dSprite.prototype, "visible", {
        get: function () {
            return this.isShow();
        },
        set: function (bVisible) {
            this.SetShow(bVisible);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetMatrix3D = function (mat) {
        var pos = new dVector3();
        var sca = new dVector3();
        var matRot = new dMatrix();
        mat.Decompose(pos, sca, matRot);
        this.SetPos3D(pos.x, pos.y, pos.z);
        this.SetScale3D(sca.x, sca.y, sca.z);
        this.SetRotationMatrix(matRot);
    };
    dSprite.prototype.SetPos3D = function (x, y, z) {
        if (this.m_fPosX != x || this.m_fPosY != y) {
            this.m_fPosZ = z;
            this.SetPos(x, y);
        }
        else if (this.m_fPosZ != z) {
            this.m_fPosZ = z;
            this.UpdateLocal();
        }
    };
    dSprite.prototype.GetPos3D = function () {
        return new dVector3(this.m_fPosX, this.m_fPosY, this.m_fPosZ);
    };
    dSprite.prototype.SetScale3D = function (x, y, z) {
        if (this.m_fScaleX != x || this.m_fScaleY != y || this.m_fScaleZ != z) {
            this.SetScale(x, y);
            this.m_fScaleZ = z;
            this.UpdateLocal();
            if (this.m_onTouchEvent != null)
                this.m_onTouchEvent.SetScale3D(x, y, z);
        }
    };
    dSprite.prototype.GetScale3D = function () {
        return new dVector3(this.m_fScaleX, this.m_fScaleY, this.m_fScaleZ);
    };
    dSprite.prototype.GetSize3D = function () {
        return new dVector3(this.m_fWidth, this.m_fHeight, this.m_fDepth);
    };
    dSprite.prototype.SetRotationQuaternion = function (q) {
        var v = q.QuaternionToEuler();
        this.SetRotationEuler(v);
    };
    dSprite.prototype.GetRotationQuaternion = function () {
        return new dVector4().QuaternionFromEuler(this.GetRotationEuler());
    };
    dSprite.prototype.SetRotationEuler = function (v) {
        if (this.m_fRotation != v.z || this.m_fRotationX != v.x || this.m_fRotationY != v.y) {
            this.m_fRotation = v.z;
            this.m_fRotationX = v.x;
            this.m_fRotationY = v.y;
            this.UpdateLocal();
        }
    };
    dSprite.prototype.GetRotationEuler = function () {
        return new dVector3(this.m_fRotationX, this.m_fRotationY, this.m_fRotation);
    };
    dSprite.prototype.SetRotationMatrix = function (mat) {
        var v = mat.ToRotationEuler();
        this.SetRotationEuler(v);
    };
    dSprite.prototype.GetRotationMatrix = function () {
        var mat = new dMatrix();
        if (this.m_fRotationX == 0 && this.m_fRotationY == 0) {
            if (this.m_fRotation == 0)
                return dMatrix.IDENTITY;
            return mat.RotationZ(dMath.AngleToRadian(this.m_fRotation));
        }
        return mat.RotationEuler(this.m_fRotationX, this.m_fRotationY, this.m_fRotation);
    };
    dSprite.prototype.GetRotation3D = function () {
        return new dVector3(this.rotationX, this.rotationY, this.rotation);
    };
    dSprite.prototype.UpdateLocal = function () {
        this.m_bRenderMatrixDirty = true;
        this.m_bRenderMatrixSelfDirty = true;
    };
    dSprite.prototype.SetClipChild = function (bClip) {
        if (this.m_bClipChild != bClip) {
            this.m_bClipChild = bClip;
        }
    };
    dSprite.prototype.isClipChild = function () {
        return this.m_bClipChild;
    };
    Object.defineProperty(dSprite.prototype, "clipChild", {
        get: function () {
            return this.isClipChild();
        },
        set: function (bClip) {
            this.SetClipChild(bClip);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetHandleMouse = function (bHandle) {
        if (this.m_bHandleMouse != bHandle) {
            this.m_bHandleMouse = bHandle;
        }
    };
    dSprite.prototype.isHandleMouse = function () {
        return this.m_bHandleMouse;
    };
    Object.defineProperty(dSprite.prototype, "handleMouse", {
        get: function () {
            return this.isHandleMouse();
        },
        set: function (bHandle) {
            this.SetHandleMouse(bHandle);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetTransparentMouse = function (bTransparent, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        this.m_bTransparentMouse = bTransparent;
        if (bSetToChild) {
            for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
                this.m_vecChildSprite[i].SetTransparentMouse(bTransparent, bSetToChild);
        }
    };
    dSprite.prototype.isTransparentMouse = function () {
        return this.m_bTransparentMouse;
    };
    dSprite.prototype.SetTouchEvent = function (onCallback) {
        this.m_onTouchEvent = onCallback;
    };
    dSprite.prototype.GetTouchEvent = function () {
        return this.m_onTouchEvent;
    };
    dSprite.prototype.OnTouchDown = function (x, y, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnTouchDown(x, y, delta);
    };
    dSprite.prototype.OnMultyTouchDown = function (id, x, y, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnMultyTouchDown(id, x, y, delta);
    };
    dSprite.prototype.OnMButtonTouchDown = function (x, y, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnMButtonTouchDown(x, y, delta);
    };
    dSprite.prototype.OnRButtonTouchDown = function (x, y, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnRButtonTouchDown(x, y, delta);
    };
    dSprite.prototype.OnTouchMove = function (x, y, offx, offy, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnTouchMove(x, y, offx, offy, delta);
    };
    dSprite.prototype.OnMultyTouchMove = function (id, x, y, offx, offy, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnMultyTouchMove(id, x, y, offx, offy, delta);
    };
    dSprite.prototype.OnMButtonTouchMove = function (x, y, offx, offy, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnMButtonTouchMove(x, y, offx, offy, delta);
    };
    dSprite.prototype.OnRButtonTouchMove = function (x, y, offx, offy, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnRButtonTouchMove(x, y, offx, offy, delta);
    };
    dSprite.prototype.OnTouchUp = function (x, y) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnTouchUp(x, y);
    };
    dSprite.prototype.OnMultyTouchUp = function (id, x, y) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnMultyTouchUp(id, x, y);
    };
    dSprite.prototype.OnMButtonTouchUp = function (x, y) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnMButtonTouchUp(x, y);
    };
    dSprite.prototype.OnRButtonTouchUp = function (x, y) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnRButtonTouchUp(x, y);
    };
    dSprite.prototype.OnMouseWheel = function (x, y, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnMouseWheel(x, y, delta);
    };
    dSprite.prototype._FireKeyDownEvent = function (keyCode) {
        var vecChild = this.m_vecChildSprite;
        for (var i = vecChild.length - 1; i >= 0; i--) {
            var p = vecChild[i]._FireKeyDownEvent(keyCode);
            if (p)
                return p;
        }
        if (this.OnKeyDown(keyCode))
            return this;
        return null;
    };
    dSprite.prototype.OnKeyDown = function (keyCode) {
        if (this.m_onTouchEvent != null)
            return this.m_onTouchEvent.OnKeyDown(keyCode);
        return false;
    };
    dSprite.prototype.OnKeyUp = function (keyCode) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnKeyUp(keyCode);
    };
    dSprite.prototype.SetLayoutAlign = function (alignH, alignV) {
        this.m_nLayoutAlign = alignV << 16 | alignH;
    };
    Object.defineProperty(dSprite.prototype, "layoutAlignH", {
        get: function () {
            return this.m_nLayoutAlign & 0xFFFF;
        },
        set: function (value) {
            this.m_nLayoutAlign = (this.m_nLayoutAlign & 0xFFFF0000) | value;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "layoutAlignV", {
        get: function () {
            return this.m_nLayoutAlign >>> 16;
        },
        set: function (value) {
            this.m_nLayoutAlign = (this.m_nLayoutAlign & 0xFFFF) | (value << 16);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.LayoutToSize = function (width, height) {
        var oldWidth = this.GetWidth();
        var oldHeight = this.GetHeight();
        var fatherAnchorU = this.anchorU;
        var fatherAnchorV = this.anchorV;
        for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++) {
            var p = this.m_vecChildSprite[i];
            var newWidth = p.width;
            var newHeight = p.height;
            var off_x = 0;
            if (p.layoutAlignH == dSprite.LAYOUT_ALIGN_LEFT_TOP)
                off_x = (oldWidth - width) * (fatherAnchorU);
            else if (p.layoutAlignH == dSprite.LAYOUT_ALIGN_RIGHT_BOTTOM)
                off_x = (width - oldWidth) * (1 - fatherAnchorU);
            else if (p.layoutAlignH == dSprite.LAYOUT_ALIGN_DEFAULT)
                off_x = (width - oldWidth) * (0.5 - fatherAnchorU);
            var off_y = 0;
            if (p.layoutAlignV == dSprite.LAYOUT_ALIGN_LEFT_TOP)
                off_y = (oldHeight - height) * (fatherAnchorV);
            else if (p.layoutAlignV == dSprite.LAYOUT_ALIGN_RIGHT_BOTTOM)
                off_y = (height - oldHeight) * (1 - fatherAnchorV);
            else if (p.layoutAlignV == dSprite.LAYOUT_ALIGN_DEFAULT)
                off_y = (height - oldHeight) * (0.5 - fatherAnchorV);
            if (p.layoutAlignH == dSprite.LAYOUT_ALIGN_SCALE) {
                p.scaleX *= width / oldWidth;
                off_x = (oldWidth - width) * (fatherAnchorU) + (width - oldWidth) * (p.anchorU - fatherAnchorU);
            }
            if (p.layoutAlignV == dSprite.LAYOUT_ALIGN_SCALE) {
                p.scaleY *= height / oldHeight;
                off_y = (oldHeight - height) * (fatherAnchorV) + (height - oldHeight) * (p.anchorV - fatherAnchorV);
            }
            if (p.layoutAlignH == dSprite.LAYOUT_ALIGN_RESIZE) {
                newWidth = p.width + width - oldWidth;
                off_x = (width - oldWidth) * (p.anchorU - fatherAnchorU);
            }
            if (p.layoutAlignV == dSprite.LAYOUT_ALIGN_RESIZE) {
                newHeight = p.height + height - oldHeight;
                off_y = (height - oldHeight) * (p.anchorV - fatherAnchorV);
            }
            if (p.layoutAlignH == dSprite.LAYOUT_ALIGN_FIXED) {
                p.scaleX *= height / oldHeight;
                off_x = (oldWidth - width) * (fatherAnchorU - p.anchorU);
            }
            if (p.layoutAlignV == dSprite.LAYOUT_ALIGN_FIXED) {
                p.scaleY *= width / oldWidth;
                off_y = (oldHeight - height) * (fatherAnchorV - p.anchorV);
            }
            if (off_x != 0 || off_y != 0)
                p.SetPos(p.GetPosX() + off_x, p.GetPosY() + off_y);
            if (newWidth != p.width || newHeight != p.height)
                p.LayoutToSize(newWidth, newHeight);
        }
        this.SetSize(width, height);
    };
    Object.defineProperty(dSprite.prototype, "alpha", {
        get: function () {
            return this.GetAlpha();
        },
        set: function (v) {
            this.SetAlpha(v);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetAlpha = function (alpha, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        if (alpha < 0)
            alpha = 0;
        else if (alpha > 1)
            alpha = 1;
        if (this.m_fAlpha != alpha) {
            this.m_fAlpha = alpha;
            this._UpdateColor();
        }
        if (bSetToChild) {
            for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
                this.m_vecChildSprite[i].SetAlpha(alpha, true);
        }
    };
    dSprite.prototype.GetAlpha = function () {
        return this.m_fAlpha;
    };
    Object.defineProperty(dSprite.prototype, "spriteColor", {
        get: function () {
            return this.GetColor();
        },
        set: function (color) {
            this.SetColor(color);
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetColor = function (colorARGB, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        colorARGB = (colorARGB & 0x7fffffff) + ((colorARGB & 0x80000000) ? 0x80000000 : 0);
        if (this.m_nColorARGB != colorARGB) {
            this.m_nColorARGB = colorARGB;
            this._UpdateColor();
        }
        if (bSetToChild) {
            for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
                this.m_vecChildSprite[i].SetColor(colorARGB, bSetToChild);
        }
    };
    dSprite.prototype.GetColor = function () {
        return this.m_nColorARGB;
    };
    dSprite.prototype.SetBlendMode = function (mode, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        if (this.m_nBlendMode != mode) {
            this.m_nBlendMode = mode;
        }
        if (bSetToChild) {
            for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
                this.m_vecChildSprite[i].SetBlendMode(mode, bSetToChild);
        }
    };
    dSprite.prototype.GetBlendMode = function () {
        return this.m_nBlendMode;
    };
    Object.defineProperty(dSprite.prototype, "blendMode", {
        get: function () {
            return this.GetBlendMode();
        },
        set: function (mode) {
            this.SetBlendMode(mode);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dSprite.prototype, "wireframe", {
        get: function () {
            return (this.GetBlendMode() & dSprite.BLEND_MODE_WIREFRAME) != 0;
        },
        set: function (bWireframe) {
            if (bWireframe)
                this.SetBlendMode(this.GetBlendMode() | dSprite.BLEND_MODE_WIREFRAME);
            else
                this.SetBlendMode(this.GetBlendMode() & (~dSprite.BLEND_MODE_WIREFRAME));
        },
        enumerable: false,
        configurable: true
    });
    dSprite.prototype.SetEnableCulling = function (disable_front_back) {
        this.m_nEnableCulling = disable_front_back;
    };
    dSprite.prototype.SetColorTransform = function (mat, bWithChild) {
        if (bWithChild === void 0) { bWithChild = false; }
        if (mat == null)
            mat = dMatrix.IDENTITY;
        this.m_matColorTransform = mat;
        this._UpdateColorTransform();
        if (bWithChild) {
            for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
                this.m_vecChildSprite[i].SetColorTransform(mat, bWithChild);
        }
    };
    dSprite.prototype.GetColorTransform = function () {
        if (this.m_matColorTransform == null)
            return dMatrix.IDENTITY;
        return this.m_matColorTransform;
    };
    dSprite.prototype.SetBrightness = function (value, bWithChild) {
        if (bWithChild === void 0) { bWithChild = false; }
        this.SetColorTransform(new dMatrix().Translation(value, value, value), bWithChild);
    };
    dSprite.prototype.GetBrightness = function () {
        var mat = this.GetColorTransform();
        return (mat._41 + mat._42 + mat._43) / 3.0;
    };
    dSprite.prototype.SetContrast = function (value, bWithChild) {
        if (bWithChild === void 0) { bWithChild = false; }
        var mat = new dMatrix();
        mat.Scaling(value, value, value);
        this.SetColorTransform(mat, bWithChild);
    };
    dSprite.prototype.GetContrast = function () {
        var mat = this.GetColorTransform();
        return (mat._11 + mat._22 + mat._33) / 3.0;
    };
    dSprite.prototype.SetGray = function (bGray, bWithChild) {
        if (bGray === void 0) { bGray = true; }
        if (bWithChild === void 0) { bWithChild = false; }
        var mat = new dMatrix();
        if (bGray) {
            mat._11 = 0.333333;
            mat._12 = 0.333333;
            mat._13 = 0.333333;
            mat._14 = 0;
            mat._21 = 0.333333;
            mat._22 = 0.333333;
            mat._23 = 0.333333;
            mat._24 = 0;
            mat._31 = 0.333333;
            mat._32 = 0.333333;
            mat._33 = 0.333333;
            mat._34 = 0;
            mat._41 = 0;
            mat._42 = 0;
            mat._43 = 0;
            mat._44 = 1;
        }
        else
            mat.Identity();
        this.SetColorTransform(mat, bWithChild);
    };
    dSprite.HueToMatrix = function (value) {
        if (value < -180)
            value = -180;
        else if (value > 180)
            value = 180;
        value = value / 180 * dMath.dPI;
        if (value == 0)
            return dMatrix.IDENTITY;
        var cosVal = dMath.Cos(value);
        var sinVal = dMath.Sin(value);
        var lumR = 0.213;
        var lumG = 0.715;
        var lumB = 0.072;
        var mat = new dMatrix();
        mat._11 = lumR + cosVal * (1 - lumR) + sinVal * (-lumR);
        mat._21 = lumG + cosVal * (-lumG) + sinVal * (-lumG);
        mat._31 = lumB + cosVal * (-lumB) + sinVal * (1 - lumB);
        mat._41 = 0;
        mat._12 = lumR + cosVal * (-lumR) + sinVal * (0.143);
        mat._22 = lumG + cosVal * (1 - lumG) + sinVal * (0.140);
        mat._32 = lumB + cosVal * (-lumB) + sinVal * (-0.283);
        mat._42 = 0;
        mat._13 = lumR + cosVal * (-lumR) + sinVal * (-(1 - lumR));
        mat._23 = lumG + cosVal * (-lumG) + sinVal * (lumG);
        mat._33 = lumB + cosVal * (1 - lumB) + sinVal * (lumB);
        mat._43 = 0;
        mat._44 = 1;
        return mat;
    };
    dSprite.prototype.AdjustHue = function (value, bWithChild) {
        if (bWithChild === void 0) { bWithChild = false; }
        var mat = dSprite.HueToMatrix(value);
        this.SetColorTransform(mat.Mul(this.GetColorTransform()), bWithChild);
    };
    dSprite.prototype.AdjustSaturation = function (value, bWithChild) {
        if (bWithChild === void 0) { bWithChild = false; }
        if (value < -100)
            value = -100;
        else if (value > 100)
            value = 100;
        if (value == 0)
            return;
        var x = 1 + ((value > 0) ? 3 * value / 100 : value / 100);
        var lumR = 0.3086;
        var lumG = 0.6094;
        var lumB = 0.0820;
        var mat = new dMatrix();
        mat._11 = lumR * (1 - x) + x, lumG * (1 - x);
        mat._12 = lumB * (1 - x);
        mat._21 = lumR * (1 - x);
        mat._22 = lumG * (1 - x) + x, lumB * (1 - x);
        mat._31 = lumR * (1 - x);
        mat._32 = lumG * (1 - x), lumB * (1 - x) + x;
        mat._44 = 1;
        this.SetColorTransform(mat.Mul(this.GetColorTransform()), bWithChild);
    };
    dSprite.prototype._UpdateColor = function () {
        var color = this.m_nColorARGB;
        if (color == 0xffffffff)
            this.SetUniformF("color", 1, 1, 1, this.m_fAlpha);
        else {
            var a = ((color & 0xFF000000) >>> 24) / 255.0;
            var r = ((color & 0x00FF0000) >> 16) / 255.0;
            var g = ((color & 0x0000FF00) >> 8) / 255.0;
            var b = ((color & 0x000000FF)) / 255.0;
            this.SetUniformF("color", r, g, b, a * this.m_fAlpha);
        }
    };
    dSprite.prototype._UpdateColorTransform = function () {
        if (this.m_matColorTransform != null)
            this.SetUniformMatrix("colorMatrix", this.m_matColorTransform);
        else
            this.SetUniformMatrix("colorMatrix", dMatrix.IDENTITY);
    };
    dSprite.prototype.SetBitmapData = function (bmp, pSourceRect, at, sampleType) {
        if (pSourceRect === void 0) { pSourceRect = null; }
        if (at === void 0) { at = 0; }
        if (sampleType === void 0) { sampleType = 0; }
        this.m_pSetBitmapData[at] = bmp;
        if (at == 0)
            this.m_pSetBitmapDataSourceRect = pSourceRect;
    };
    dSprite.prototype.GetBitmapData = function (at) {
        if (at === void 0) { at = 0; }
        return this.m_pSetBitmapData[at];
    };
    dSprite.prototype.GetBitmapSourceRect = function () {
        if (!this.m_pSetBitmapDataSourceRect)
            this.m_pSetBitmapDataSourceRect = new dRect(0, 0, 1, 1);
        return this.m_pSetBitmapDataSourceRect;
    };
    dSprite.prototype.SetShader = function (pShader, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        if (this.m_pBindShader != pShader) {
            this.m_pBindShader = pShader;
            if (this.m_pBindShader != null)
                this.m_pBindShader.OnBindSprite(this);
            if (bSetToChild) {
                for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
                    this.m_vecChildSprite[i].SetShader(pShader, bSetToChild);
            }
        }
    };
    dSprite.prototype.GetShader = function () {
        return this.m_pBindShader;
    };
    dSprite.prototype.SetMeshData = function (pMeshData) {
        this.m_pBindMeshData = pMeshData;
        return this;
    };
    dSprite.prototype.GetMeshData = function () {
        return this.m_pBindMeshData;
    };
    dSprite.prototype.DrawToBitmapData = function (bitmapData) {
        var webgl = dInterface.ptr.webgl;
        dSprite.EnableScissorTest(true, 0, 0, bitmapData.GetWidth(), bitmapData.GetHeight(), bitmapData.GetWidth(), bitmapData.GetHeight(), null, false);
        var oldFBO = webgl.getParameter(webgl.FRAMEBUFFER_BINDING);
        var oldRBO = webgl.getParameter(webgl.RENDERBUFFER_BINDING);
        if (bitmapData.m_pBufferData.m_pTexture == null) {
            bitmapData.m_pBufferData.m_pTexture = webgl.createTexture();
            webgl.bindTexture(webgl.TEXTURE_2D, bitmapData.m_pBufferData.m_pTexture);
            webgl.texImage2D(webgl.TEXTURE_2D, 0, webgl.RGBA, bitmapData.GetWidth(), bitmapData.GetHeight(), 0, webgl.RGBA, webgl.UNSIGNED_BYTE, null);
            webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_MIN_FILTER, webgl.NEAREST);
            webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_MAG_FILTER, webgl.NEAREST);
            webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_WRAP_S, webgl.CLAMP_TO_EDGE);
            webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_WRAP_T, webgl.CLAMP_TO_EDGE);
            bitmapData.m_pBufferData.m_pRenderToTextureRboDepth = webgl.createRenderbuffer();
            webgl.bindRenderbuffer(webgl.RENDERBUFFER, bitmapData.m_pBufferData.m_pRenderToTextureRboDepth);
            webgl.renderbufferStorage(webgl.RENDERBUFFER, webgl.DEPTH_COMPONENT16, bitmapData.GetWidth(), bitmapData.GetHeight());
            bitmapData.m_pBufferData.m_pRenderToTextureFbo = webgl.createFramebuffer();
            webgl.bindFramebuffer(webgl.FRAMEBUFFER, bitmapData.m_pBufferData.m_pRenderToTextureFbo);
            webgl.framebufferTexture2D(webgl.FRAMEBUFFER, webgl.COLOR_ATTACHMENT0, webgl.TEXTURE_2D, bitmapData.m_pBufferData.m_pTexture, 0);
            webgl.framebufferRenderbuffer(webgl.FRAMEBUFFER, webgl.DEPTH_ATTACHMENT, webgl.RENDERBUFFER, bitmapData.m_pBufferData.m_pRenderToTextureRboDepth);
        }
        else
            webgl.bindFramebuffer(webgl.FRAMEBUFFER, bitmapData.m_pBufferData.m_pRenderToTextureFbo);
        webgl.viewport(0, 0, bitmapData.GetWidth(), bitmapData.GetHeight());
        webgl.clearDepth(1.0);
        webgl.clearStencil(0);
        webgl.clearColor(0, 0, 0, 0);
        this._EnableDepthTest(2);
        webgl.clear(webgl.COLOR_BUFFER_BIT | webgl.DEPTH_BUFFER_BIT | webgl.STENCIL_BUFFER_BIT);
        this.Render(bitmapData.GetWidth(), bitmapData.GetHeight());
        webgl.viewport(0, 0, dInterface.ptr.GetWindowWidth(), dInterface.ptr.GetWindowHeight());
        webgl.bindFramebuffer(webgl.FRAMEBUFFER, oldFBO);
        webgl.bindRenderbuffer(webgl.RENDERBUFFER, oldRBO);
    };
    dSprite.prototype.SetEnableClear = function (flag) {
        this.m_nEnableClearFlag = flag;
    };
    dSprite.prototype.isInRender = function (matWorld) {
        if (this.m_pBindShader == null)
            return 0;
        return this.m_pBindShader.isInRender(this, matWorld);
    };
    dSprite.prototype.SetEnableZReadWrite = function (disable_r_rw, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        this.m_nEnableZReadWrite = disable_r_rw;
        if (bSetToChild) {
            for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
                this.m_vecChildSprite[i].SetEnableZReadWrite(disable_r_rw, bSetToChild);
        }
    };
    dSprite.prototype.SetUniformF = function (name, f1, f2, f3, f4) {
        var p = this;
        var uniformData;
        if (!p.m_mapUniformData.has(name))
            p.m_mapUniformData.set(name, uniformData = new __dSpriteUniformData());
        else
            uniformData = p.m_mapUniformData.get(name);
        uniformData.flag = 1;
        uniformData.f1 = f1;
        uniformData.f2 = f2;
        uniformData.f3 = f3;
        uniformData.f4 = f4;
    };
    dSprite.prototype.SetUniformI = function (name, iData) {
        var p = this;
        var uniformData;
        if (!p.m_mapUniformData.has(name))
            p.m_mapUniformData.set(name, uniformData = new __dSpriteUniformData());
        else
            uniformData = p.m_mapUniformData.get(name);
        uniformData.flag = 2;
        uniformData.iData = iData;
    };
    dSprite.prototype.SetUniformMatrix = function (name, mat, index) {
        if (index === void 0) { index = -1; }
        var p = this;
        var uniformData;
        if (!p.m_mapUniformData.has(name))
            p.m_mapUniformData.set(name, uniformData = new __dSpriteUniformData());
        else
            uniformData = p.m_mapUniformData.get(name);
        uniformData.flag = 3;
        if (uniformData.mat == null)
            uniformData.mat = [];
        mat.ToArray(uniformData.mat);
    };
    dSprite.prototype.RemoveUniform = function (name) {
        if (this.m_mapUniformData.has(name))
            this.m_mapUniformData.remove(name);
    };
    dSprite.prototype.ComputeMatrixSelf = function (matWorld) {
        if (this.m_bRenderMatrixSelfDirty) {
            var mat2 = this.m_matRenderMatrixSelf;
            mat2.Scaling(this.m_fWidth, this.m_fHeight, this.m_fDepth);
            mat2.TranslationFast(this.m_fWidth * (-this.m_fAnchorU), this.m_fHeight * (-this.m_fAnchorV), this.m_fDepth * (-this.m_fAnchorW));
            mat2.MulAppend(matWorld);
            this.m_bRenderMatrixSelfDirty = false;
            this.SetUniformMatrix("mWorld", mat2);
        }
    };
    dSprite.prototype.Render = function (windowWidth, windowHeight) {
        this._Render(dMatrix.IDENTITY, windowWidth, windowHeight, false);
    };
    dSprite.prototype._Render = function (mat, windowWidth, windowHeight, bFatherMatrixDirty) {
        if (this.m_bShow) {
            this.PrepareRender();
            var matWorld = this.m_matRenderMatrixWorld;
            if (bFatherMatrixDirty) {
                this.m_bRenderMatrixDirty = true;
                this.m_bRenderMatrixSelfDirty = true;
            }
            if (this.m_bRenderMatrixDirty) {
                matWorld.Scaling(this.m_fScaleX, this.m_fScaleY, this.m_fScaleZ);
                if (this.m_fRotation != 0.0 || this.m_fRotationX != 0.0 || this.m_fRotationY != 0.0) {
                    if (this.m_fRotationX != 0 || this.m_fRotationY != 0)
                        matWorld.RotationEulerAppend(this.m_fRotationX, this.m_fRotationY, this.m_fRotation);
                    else
                        matWorld.RotationZAppend(dMath.AngleToRadian(this.m_fRotation));
                    matWorld.TranslationAppend(this.m_fPosX, this.m_fPosY, this.m_fPosZ);
                }
                else
                    matWorld.TranslationFast(this.m_fPosX, this.m_fPosY, this.m_fPosZ);
                matWorld.MulAppend(mat);
                bFatherMatrixDirty = true;
            }
            var clipRect;
            if (this.m_bClipChild) {
                this.ComputeMatrixSelf(matWorld);
                var orthoMatrix = new dMatrix();
                orthoMatrix.OrthoRH(windowWidth, windowHeight, 0, 99999);
                dMatrix.Multiply(orthoMatrix, this.m_matRenderMatrixSelf, orthoMatrix);
                var matWVP = orthoMatrix;
                matWVP.TranslationAppend(-1, -1, 0);
                matWVP.ScalingAppend(1, -1, 1);
                this.m_rcRenderForClip.Copy(dSprite.GetScissorTest());
                if (dSprite.EnableScissorTest(true, 0, 0, 0, 0, windowWidth, windowHeight, matWVP, true)) {
                    clipRect = this.m_rcRenderForClip;
                    var curScissorTest = dSprite.GetScissorTest();
                    if (curScissorTest.Width() == 0 || curScissorTest.Height() == 0) {
                        dSprite.EnableScissorTest(true, clipRect.left, clipRect.top, clipRect.Width(), clipRect.Height(), windowWidth, windowHeight, null, false);
                        return;
                    }
                }
            }
            var inRender;
            if (this.m_fAlpha > 0) {
                inRender = this.isInRender(matWorld);
                if ((this.m_pSetBitmapData[0] || this.m_bForceRender) && inRender == 1) {
                    this.ComputeMatrixSelf(matWorld);
                    this.SetUniformF("isAlphaPremultiplied", this.isAlphaPremultiplied(), 0, 0, 0);
                    this.SpriteRender();
                }
            }
            this.m_bRenderMatrixDirty = false;
            if (inRender != -1) {
                this._RenderChild(matWorld, windowWidth, windowHeight, bFatherMatrixDirty);
            }
            if (clipRect != null)
                dSprite.EnableScissorTest(true, clipRect.left, clipRect.top, clipRect.Width(), clipRect.Height(), windowWidth, windowHeight, null, false);
        }
        else {
            this.m_bRenderMatrixDirty = true;
            this.m_bRenderMatrixSelfDirty = true;
        }
    };
    dSprite.prototype._RenderChild = function (matWorld, windowWidth, windowHeight, bFatherMatrixDirty) {
        for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++)
            this.m_vecChildSprite[i]._Render(matWorld, windowWidth, windowHeight, bFatherMatrixDirty);
    };
    dSprite.prototype.isAlphaPremultiplied = function () {
        return 1;
    };
    dSprite.prototype.PrepareRender = function () {
    };
    dSprite.prototype.SpriteRender = function () {
        var p = this;
        p._EnableDepthTest(p.m_nEnableZReadWrite);
        p._EnableCulling(p.m_nEnableCulling);
        p._EnableBlend(p.m_nBlendMode & 3, p.isAlphaPremultiplied() != 0);
        if (p.m_nEnableClearFlag & 1)
            p._ClearZBuffer();
        var shader = p.m_pBindShader;
        var meshData = p.m_pBindMeshData;
        if (shader != null && meshData != null) {
            shader._Use();
            var bSetTextureOk = true;
            for (var i = 0; i < 8; i++) {
                if (!p.m_pSetBitmapData[i])
                    break;
                if (!p.m_pSetBitmapData[i]._SetTexture(i))
                    bSetTextureOk = false;
                else if (i == 0) {
                    var rcSource = this.m_pSetBitmapDataSourceRect;
                    if (rcSource) {
                        var bmpWidth = 1;
                        var bmpHeight = 1;
                        var vUV_x = rcSource.left / bmpWidth;
                        var vUV_y = rcSource.top / bmpHeight;
                        var vUV_z = rcSource.Width() / bmpWidth;
                        var vUV_w = rcSource.Height() / bmpHeight;
                        this.SetUniformF("uvTrans", vUV_x, vUV_y + vUV_w, vUV_z, -vUV_w);
                    }
                    else
                        this.SetUniformF("uvTrans", 0, 1, 1, -1);
                }
            }
            this._UpdateUniform(shader);
            if (bSetTextureOk) {
                shader._Begin();
                meshData._Draw(shader);
                meshData._UnDraw();
                shader._End();
            }
            for (var i = 0; i < 8; i++) {
                if (!p.m_pSetBitmapData[i])
                    break;
                p.m_pSetBitmapData[i]._UnSetTexture(i);
            }
        }
    };
    dSprite.prototype._UpdateUniform = function (shader) {
        var e_2, _a;
        var webgl = dInterface.ptr.webgl;
        try {
            for (var _b = __values(this.m_mapUniformData.keys()), _c = _b.next(); !_c.done; _c = _b.next()) {
                var name = _c.value;
                var uniformData = this.m_mapUniformData.get(name);
                var loc = shader._GetUniformLocation(name);
                if (loc) {
                    if (uniformData.flag == 1) {
                        webgl.uniform4f(loc, uniformData.f1, uniformData.f2, uniformData.f3, uniformData.f4);
                    }
                    else if (uniformData.flag == 2) {
                        webgl.uniform1i(loc, uniformData.iData);
                    }
                    else if (uniformData.flag == 3) {
                        webgl.uniformMatrix4fv(loc, false, uniformData.mat);
                    }
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_2) throw e_2.error; }
        }
    };
    dSprite.prototype.CollectionChildWithoutThis = function (x, y, bHandleMouseOnly) {
        if (bHandleMouseOnly === void 0) { bHandleMouseOnly = true; }
        var vecChild = this.m_vecChildSprite;
        for (var i = vecChild.length - 1; i >= 0; i--) {
            var clip_left = this.GetAnchorU() * this.GetWidth();
            var clip_top = this.GetAnchorV() * this.GetHeight();
            var ret = vecChild[i]._CollectSprite(x, y, 1, 1, 0, 0, clip_left, clip_top, dMath.Abs(this.GetWidth() * this.GetScaleX()) + clip_left, dMath.Abs(this.GetHeight() * this.GetScaleY()) + clip_top, bHandleMouseOnly, this.isHandleMouse());
            if (bHandleMouseOnly) {
                while (ret != null && ret != this) {
                    if (ret.isHandleMouse())
                        break;
                    ret = ret.GetParent();
                }
            }
            if (ret != null && ret != this)
                return ret;
        }
        return null;
    };
    dSprite.prototype.CollectionChild = function (x, y, bHandleMouseOnly) {
        if (bHandleMouseOnly === void 0) { bHandleMouseOnly = true; }
        var pos_x = this.GetPosX();
        var pos_y = this.GetPosY();
        var clip_left = pos_x - this.GetAnchorU() * this.GetWidth();
        var clip_top = pos_y - this.GetAnchorV() * this.GetHeight();
        var ret = this._CollectSprite(x, y, 1, 1, 0, 0, clip_left, clip_top, dMath.Abs(this.GetWidth() * this.GetScaleX()) + clip_left, dMath.Abs(this.GetHeight() * this.GetScaleY()) + clip_top, bHandleMouseOnly, this.isHandleMouse());
        if (ret != null) {
            if (bHandleMouseOnly) {
                while (ret != null) {
                    if (ret.isHandleMouse())
                        break;
                    ret = ret.GetParent();
                }
            }
        }
        return ret;
    };
    dSprite.prototype._isForceCheckCollectRot = function () {
        return false;
    };
    dSprite.prototype._CollectSprite = function (mousex, mousey, scalex, scaley, x, y, clip_left, clip_top, clip_right, clip_bottom, bHandleMouseCheck, bRootHandleMouse) {
        if (this.isShow()) {
            if (this.GetScaleX() < 0 || this.GetScaleY() < 0 || this.GetRotation() != 0.0 || this._isForceCheckCollectRot()) {
                var mat = new dMatrix();
                mat.Scaling(scalex, scaley, 1);
                mat.TranslationAppend(x, y, 0);
                return dSprite._CollectSpriteRot(mousex, mousey, this, mat, bHandleMouseCheck, bRootHandleMouse || this.isHandleMouse());
            }
            var vecChild = this.m_vecChildSprite;
            x += this.GetPosX() * scalex;
            y += this.GetPosY() * scaley;
            scalex *= this.GetScaleX();
            scaley *= this.GetScaleY();
            var width = dMath.Abs(this.GetWidth() * scalex);
            var height = dMath.Abs(this.GetHeight() * scaley);
            x -= (this.GetAnchorU() * width);
            y -= (this.GetAnchorV() * height);
            if (this.isClipChild()) {
                if (clip_left < x)
                    clip_left = x;
                if (clip_top < y)
                    clip_top = y;
                if (clip_right > (x + width))
                    clip_right = (x + width);
                if (clip_bottom > (y + height))
                    clip_bottom = (y + height);
            }
            var clip_width = clip_right - clip_left;
            var clip_height = clip_bottom - clip_top;
            if (clip_width <= 0 || clip_height <= 0)
                return null;
            for (var i = vecChild.length - 1; i >= 0; i--) {
                var img = vecChild[i];
                var ret = img._CollectSprite(mousex, mousey, scalex, scaley, x + this.GetAnchorU() * width, y + this.GetAnchorV() * height, clip_left, clip_top, clip_right, clip_bottom, bHandleMouseCheck, bRootHandleMouse || img.isHandleMouse());
                if (ret != null)
                    return ret;
            }
            if (bRootHandleMouse && !this.isTransparentMouse() || !bHandleMouseCheck) {
                if (mousex >= clip_left && mousex <= clip_right && mousey >= clip_top && mousey <= clip_bottom &&
                    mousex >= x && mousey >= y && mousex < x + width && mousey < y + height) {
                    return this;
                }
            }
        }
        return null;
    };
    dSprite._CollectSpriteRot = function (x, y, pObj, mat, bHandleMouseCheck, bRootHandleMouse) {
        if (pObj.isShow() && !dMath.EqualsZero(pObj.GetScaleX()) && !dMath.EqualsZero(pObj.GetScaleY())) {
            var matTemp1 = pObj.GetMatrixLocal().Mul(mat);
            var vecChild = pObj.m_vecChildSprite;
            for (var i = vecChild.length - 1; i >= 0; i--) {
                if (!dMath.EqualsZero(vecChild[i].GetScaleX()) && !dMath.EqualsZero(vecChild[i].GetScaleY())) {
                    var ret = this._CollectSpriteRot(x, y, vecChild[i], matTemp1, bHandleMouseCheck, bRootHandleMouse || vecChild[i].isHandleMouse());
                    if (ret != null)
                        return ret;
                }
            }
            if (bRootHandleMouse && !pObj.isTransparentMouse() || !bHandleMouseCheck) {
                if (!dMath.EqualsZero(pObj.GetWidth()) && !dMath.EqualsZero(pObj.GetHeight())) {
                    if (!dSprite.s_pCheckCollectionData)
                        dSprite.s_pCheckCollectionData = new CheckCollectionData();
                    var data = dSprite.s_pCheckCollectionData;
                    var matWorld = data.matWorld.Scaling(pObj.GetWidth(), pObj.GetHeight(), 1).TranslationAppend(-pObj.GetWidth() * pObj.GetAnchorU(), -pObj.GetHeight() * pObj.GetAnchorV(), 0).MulAppend(matTemp1);
                    var points = data.ResetPoints();
                    for (var i = 0; i < 4; i++) {
                        points[i].Transform(matWorld);
                    }
                    data.P.SetValue(x, y, 0);
                    if (pObj._CheckCollectionWithData(pObj, data)) {
                        return pObj;
                    }
                }
            }
        }
        return null;
    };
    dSprite.prototype._CheckCollectionWithData = function (p, data) {
        return data.CheckPointInTriangle();
    };
    dSprite.prototype._EnableDepthTest = function (disable_r_rw) {
        var webgl = dInterface.ptr.webgl;
        if (disable_r_rw == 0)
            webgl.disable(webgl.DEPTH_TEST);
        else if (disable_r_rw == 1) {
            webgl.enable(webgl.DEPTH_TEST);
            webgl.depthFunc(webgl.LEQUAL);
            webgl.depthMask(false);
        }
        else if (disable_r_rw == 2) {
            webgl.enable(webgl.DEPTH_TEST);
            webgl.depthFunc(webgl.LEQUAL);
            webgl.depthMask(true);
        }
    };
    dSprite.prototype._EnableCulling = function (disable_front_back) {
        var webgl = dInterface.ptr.webgl;
        if (disable_front_back == 0)
            webgl.disable(webgl.CULL_FACE);
        else if (disable_front_back == 1) {
            webgl.enable(webgl.CULL_FACE);
            webgl.cullFace(webgl.FRONT);
        }
        else if (disable_front_back == 2) {
            webgl.enable(webgl.CULL_FACE);
            webgl.cullFace(webgl.BACK);
        }
    };
    dSprite.prototype._EnableWireFrame = function (bEnable) {
    };
    dSprite.prototype._EnableBlend = function (nType, bSrcAlphaBlended) {
        var webgl = dInterface.ptr.webgl;
        if (nType == dSprite.BLEND_MODE_NORMAL) {
            webgl.enable(webgl.BLEND);
            webgl.blendEquation(webgl.FUNC_ADD);
            if (bSrcAlphaBlended)
                webgl.blendFunc(webgl.ONE, webgl.ONE_MINUS_SRC_ALPHA);
            else
                webgl.blendFunc(webgl.SRC_ALPHA, webgl.ONE_MINUS_SRC_ALPHA);
        }
        else if (nType == dSprite.BLEND_MODE_ADD) {
            webgl.enable(webgl.BLEND);
            webgl.blendEquation(webgl.FUNC_ADD);
            webgl.blendFunc(webgl.SRC_ALPHA, webgl.ONE);
        }
        else if (nType == dSprite.BLEND_MODE_SUB) {
            webgl.enable(webgl.BLEND);
            webgl.blendEquation(webgl.FUNC_REVERSE_SUBTRACT);
            webgl.blendFunc(webgl.SRC_ALPHA, webgl.ONE);
        }
    };
    dSprite.prototype._ClearZBuffer = function () {
        dInterface.ptr.webgl.clear(dInterface.ptr.webgl.DEPTH_BUFFER_BIT);
    };
    dSprite.GetScissorTest = function () {
        if (!dSprite.m_rcCurScissorTestRect)
            dSprite.m_rcCurScissorTestRect = new dRect();
        return dSprite.m_rcCurScissorTestRect;
    };
    dSprite._dglScissor = function (left, top, width, height, windowWidth, windowHeight, bMergeRect) {
        if (left < 0) {
            width += left;
            left = 0;
        }
        if (top < 0) {
            height += top;
            top = 0;
        }
        var rc = new dRect();
        var scissorTest = this.GetScissorTest();
        if (bMergeRect) {
            rc.SetPosSize(left, top, width, height);
            if (rc.left < scissorTest.left)
                rc.left = scissorTest.left;
            if (rc.top < scissorTest.top)
                rc.top = scissorTest.top;
            if (rc.right > scissorTest.right)
                rc.right = scissorTest.right;
            if (rc.bottom > scissorTest.bottom)
                rc.bottom = scissorTest.bottom;
            left = rc.left;
            top = rc.top;
            width = rc.Width();
            height = rc.Height();
        }
        if (left + width > windowWidth)
            width = windowWidth - left;
        if (top + height > windowHeight)
            height = windowHeight - top;
        if (width < 0)
            width = 0;
        if (height < 0)
            height = 0;
        scissorTest.SetPosSize(left, top, width, height);
        dInterface.ptr.webgl.enable(dInterface.ptr.webgl.SCISSOR_TEST);
        dInterface.ptr.webgl.scissor(left, windowHeight - height - top, width, height);
        return true;
    };
    dSprite.EnableScissorTest = function (bEnable, x, y, width, height, windowWidth, windowHeight, matWorld, bMergeRect) {
        if (bEnable) {
            if (matWorld != null) {
                var vRect = [new dVector3(), new dVector3(), new dVector3(), new dVector3()];
                vRect[0].SetValue(0, 0, 0);
                vRect[1].SetValue(0, 1, 0);
                vRect[2].SetValue(1, 0, 0);
                vRect[3].SetValue(1, 1, 0);
                for (var i = 0; i < 4; i++) {
                    vRect[i].Transform(matWorld);
                    vRect[i].x = (vRect[i].x + 1.0) / 2.0 * dThread.GetRootBackgroudSprite().width;
                    vRect[i].y = (-vRect[i].y + 1.0) / 2.0 * dThread.GetRootBackgroudSprite().height;
                }
                if (dMath.FloatEquals(vRect[0].x, vRect[1].x, 0.001) && dMath.FloatEquals(vRect[2].x, vRect[3].x, 0.001) &&
                    dMath.FloatEquals(vRect[0].y, vRect[2].y, 0.001) && dMath.FloatEquals(vRect[1].y, vRect[3].y, 0.001)) {
                    x = dMath.Min(vRect[0].x, vRect[2].x);
                    width = dMath.Abs(vRect[2].x - vRect[0].x);
                    y = dMath.Min(vRect[0].y, vRect[1].y);
                    height = dMath.Abs(vRect[1].y - vRect[0].y);
                }
                else if (dMath.FloatEquals(vRect[0].x, vRect[2].x, 0.001) && dMath.FloatEquals(vRect[1].x, vRect[3].x, 0.001) &&
                    dMath.FloatEquals(vRect[0].y, vRect[1].y, 0.001) && dMath.FloatEquals(vRect[2].y, vRect[3].y, 0.001)) {
                    x = dMath.Min(vRect[0].x, vRect[1].x);
                    width = dMath.Abs(vRect[1].x - vRect[0].x);
                    y = dMath.Min(vRect[0].y, vRect[2].y);
                    height = dMath.Abs(vRect[2].y - vRect[0].y);
                }
                else {
                    return false;
                }
                var left = x;
                var top = y;
                var right = width + left;
                var bottom = height + top;
                return dSprite._dglScissor(dMath.ToInt(left), dMath.ToInt(top), dMath.Ceil(right) - dMath.ToInt(left), dMath.Ceil(bottom) - dMath.ToInt(top), windowWidth, windowHeight, bMergeRect);
            }
            else {
                var left = x;
                var top = y;
                var right = width + left;
                var bottom = height + top;
                return dSprite._dglScissor(dMath.ToInt(left), dMath.ToInt(top), dMath.Ceil(right) - dMath.ToInt(left), dMath.Ceil(bottom) - dMath.ToInt(top), windowWidth, windowHeight, bMergeRect);
            }
        }
        else {
            dInterface.ptr.webgl.disable(dInterface.ptr.webgl.SCISSOR_TEST);
        }
        return true;
    };
    dSprite.prototype._dSpriteGetBoundRectRot = function (rc, mat, bWithHideSprite) {
        var mat2 = new dMatrix();
        mat2.Scaling(this.GetWidth(), this.GetHeight(), 1.0);
        mat2.TranslationAppend(this.GetWidth() * (-this.GetAnchorU()), this.GetHeight() * (-this.GetAnchorV()), 0);
        mat2.MulAppend(mat);
        var vec = new Array(4);
        vec[0] = new dVector3(0, 0);
        vec[1] = new dVector3(0, 1);
        vec[2] = new dVector3(1, 0);
        vec[3] = new dVector3(1, 1);
        for (var i = 0; i < 4; i++) {
            vec[i].Transform(mat2);
            if (rc.left > vec[i].x)
                rc.left = vec[i].x;
            if (rc.top > vec[i].y)
                rc.top = vec[i].y;
            if (rc.right < vec[i].x)
                rc.right = vec[i].x;
            if (rc.bottom < vec[i].y)
                rc.bottom = vec[i].y;
        }
        for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++) {
            var p = this.m_vecChildSprite[i];
            if (bWithHideSprite || !bWithHideSprite && p.isShow()) {
                p._dSpriteGetBoundRectRot(rc, p.GetMatrixLocal().Mul(mat), bWithHideSprite);
            }
        }
    };
    dSprite.prototype._dSpriteGetBoundRect = function (x, y, rc, fScaleX, fScaleY, bWithHideSprite, clip) {
        if (this.rotation == 0 || this.scaleX < 0 || this.scaleY < 0) {
            var xx = x - this.GetWidth() * this.GetAnchorU() * this.GetScaleX() * fScaleX;
            var yy = y - this.GetHeight() * this.GetAnchorV() * this.GetScaleY() * fScaleY;
            if (rc.left > xx)
                rc.left = xx;
            if (rc.top > yy)
                rc.top = yy;
            if (rc.right < xx + this.GetWidth() * fScaleX * this.GetScaleX())
                rc.right = xx + this.GetWidth() * fScaleX * this.GetScaleX();
            if (rc.bottom < yy + this.GetHeight() * fScaleY * this.GetScaleY())
                rc.bottom = yy + this.GetHeight() * fScaleY * this.GetScaleY();
            if (clip != null) {
                if (rc.left < clip.left)
                    rc.left = clip.left;
                if (rc.right > clip.right)
                    rc.right = clip.right;
                if (rc.top < clip.top)
                    rc.top = clip.top;
                if (rc.bottom > clip.bottom)
                    rc.bottom = clip.bottom;
            }
        }
        else {
            return this._dSpriteGetBoundRectRot(rc, this.GetMatrixLocal(), bWithHideSprite);
        }
        if (this.clipChild) {
            if (clip == null)
                clip = new dRect().Copy(rc);
            else {
                clip = new dRect().Copy(clip);
                clip.Clip(rc);
            }
        }
        for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++) {
            var p = this.m_vecChildSprite[i];
            if (bWithHideSprite || !bWithHideSprite && p.isShow()) {
                p._dSpriteGetBoundRect(p.GetPosX() * fScaleX * this.GetScaleX() + x, p.GetPosY() * fScaleY * this.GetScaleY() + y, rc, fScaleX * this.GetScaleX(), fScaleY * this.GetScaleY(), bWithHideSprite, clip);
            }
        }
    };
    dSprite.prototype.GetBoundRect = function (bWithHideSprite, bWithSelf, bCheckClipChild) {
        if (bWithHideSprite === void 0) { bWithHideSprite = true; }
        if (bWithSelf === void 0) { bWithSelf = true; }
        if (bCheckClipChild === void 0) { bCheckClipChild = false; }
        var rc = new dRect();
        if (bWithSelf) {
            rc.SetPosSize(-this.width * this.anchorU, -this.height * this.anchorV, this.width, this.height);
        }
        for (var i = 0, n = this.m_vecChildSprite.length; i < n; i++) {
            var p = this.m_vecChildSprite[i];
            if (bWithHideSprite || !bWithHideSprite && p.isShow()) {
                p._dSpriteGetBoundRect(p.GetPosX() * this.GetScaleX(), p.GetPosY() * this.GetScaleY(), rc, this.GetScaleX(), this.GetScaleY(), bWithHideSprite, this.clipChild ? rc : null);
            }
        }
        return rc;
    };
    dSprite.prototype.LoadFromJson = function (j) {
        if (j.hasOwnProperty("x") && j.hasOwnProperty("y"))
            this.SetPos(dMath.ParseFloat(j.x), dMath.ParseFloat(j.y));
        if (j.hasOwnProperty("z"))
            this.positionZ = dMath.ParseFloat(j.z);
        if (j.hasOwnProperty("width") && j.hasOwnProperty("height"))
            this.SetSize(dMath.ParseFloat(j.width), dMath.ParseFloat(j.height));
        if (j.hasOwnProperty("depth"))
            this.depth = dMath.ParseFloat(j.depth);
        if (j.hasOwnProperty("scaleX") && j.hasOwnProperty("scaleY"))
            this.SetScale(dMath.ParseFloat(j.scaleX), dMath.ParseFloat(j.scaleY));
        if (j.hasOwnProperty("scaleZ"))
            this.scaleZ = dMath.ParseFloat(j.scaleZ);
        if (j.hasOwnProperty("anchorU") && j.hasOwnProperty("anchorV"))
            this.SetAnchor(dMath.ParseFloat(j.anchorU), dMath.ParseFloat(j.anchorV));
        if (j.hasOwnProperty("rotation"))
            this.SetRotation(dMath.ParseFloat(j.rotation));
        if (j.hasOwnProperty("spriteColor")) {
            var colorARGB = dMath.ParseInt(j.spriteColor);
            colorARGB = (colorARGB & 0x7fffffff) + ((colorARGB & 0x80000000) ? 0x80000000 : 0);
            this.SetColor(colorARGB);
        }
        if (j.hasOwnProperty("alpha"))
            this.SetAlpha(dMath.ParseFloat(j.alpha));
        if (j.hasOwnProperty("visible"))
            this.SetShow(Boolean(dMath.ParseInt(j.visible)));
        if (j.hasOwnProperty("rotationX"))
            this.rotationX = dMath.ParseFloat(j.rotationX);
        if (j.hasOwnProperty("rotationY"))
            this.rotationY = dMath.ParseFloat(j.rotationY);
        if (j.hasOwnProperty("clipChild"))
            this.clipChild = Boolean(dMath.ParseInt(j.clipChild));
        if (j.hasOwnProperty("layoutAlignH"))
            this.layoutAlignH = dMath.ParseInt(j.layoutAlignH);
        if (j.hasOwnProperty("layoutAlignV"))
            this.layoutAlignV = dMath.ParseInt(j.layoutAlignV);
        if (j.hasOwnProperty("blendMode"))
            this.SetBlendMode(dMath.ParseInt(j.blendMode));
        if (j.hasOwnProperty("spriteFrame"))
            this.SetFrame(dMath.ParseInt(j.spriteFrame));
    };
    dSprite.s_pCheckCollectionData = null;
    dSprite.s_pCurrentInputingBox = null;
    dSprite.MOUSE_LBUTTONDOWN = 1;
    dSprite.MOUSE_LBUTTONUP = 2;
    dSprite.MOUSE_MBUTTONDOWN = 3;
    dSprite.MOUSE_MBUTTONUP = 4;
    dSprite.MOUSE_RBUTTONDOWN = 5;
    dSprite.MOUSE_RBUTTONUP = 6;
    dSprite.MOUSE_IN = 7;
    dSprite.MOUSE_OUT = 8;
    dSprite.MOUSE_WHEEL = 9;
    dSprite.KEY_DOWN = 10;
    dSprite.KEY_UP = 11;
    dSprite.TEXT_INPUT = 14;
    dSprite.TEXT_INPUT_CANCEL = 15;
    dSprite.TEXT_FOCUS_IN = 16;
    dSprite.TEXT_FOCUS_LOST = 17;
    dSprite.MOUSE_MOVE = 18;
    dSprite.MOUSE_GESTURE = 19;
    dSprite.MOUSE_LDRAG_BEGIN = 20;
    dSprite.MOUSE_LDRAG = 21;
    dSprite.MOUSE_LDRAG_END = 22;
    dSprite.ERROR_EVENT = 23;
    dSprite.MOUSE_STYLE_ARROW = 0;
    dSprite.MOUSE_STYLE_HAND = 1;
    dSprite.MOUSE_STYLE_EDIT = 2;
    dSprite.INPUTBOX_STYLE_HSCROLL = 1;
    dSprite.INPUTBOX_STYLE_VSCROLL = 2;
    dSprite.INPUTBOX_STYLE_CANENTERLINE = 4;
    dSprite.INPUBBOX_STYPE_AUTOENTERLINE = 8;
    dSprite.INPUTBOX_STYLE_PASSWORD = 16;
    dSprite.BLEND_MODE_NORMAL = 0;
    dSprite.BLEND_MODE_ADD = 1;
    dSprite.BLEND_MODE_SUB = 2;
    dSprite.BLEND_MODE_TEX_FILTER_POINT = 4;
    dSprite.BLEND_MODE_ZWRITE_DISABLE = 8;
    dSprite.BLEND_MODE_ZREAD_DISABLE = 16;
    dSprite.BLEND_MODE_FRUSTUM_TEST_DISABLE = 32;
    dSprite.BLEND_MODE_TOON_RENDER = 64;
    dSprite.BLEND_MODE_BLUR = 128;
    dSprite.BLEND_MODE_WIREFRAME = 256;
    dSprite.BLEND_MODE_BLEND_TEXTURE = 512;
    dSprite.BLEND_MODE_ONLY_WIREFRAME = 1024;
    dSprite.BLEND_MODE_CLEAR_ZBUFFER = 2048;
    dSprite.DEFAULT_BLEND_MODE = dSprite.BLEND_MODE_NORMAL;
    dSprite.CULL_NONE = 0;
    dSprite.CULL_FRONT = 1;
    dSprite.CULL_BACK = 2;
    dSprite.DEPTHTEST_DISABLE = 0;
    dSprite.DEPTHTEST_READ = 1;
    dSprite.DEPTHTEST_READWRITE = 2;
    dSprite.LAYOUT_ALIGN_DEFAULT = 0;
    dSprite.LAYOUT_ALIGN_LEFT_TOP = 1;
    dSprite.LAYOUT_ALIGN_RIGHT_BOTTOM = 2;
    dSprite.LAYOUT_ALIGN_SCALE = 3;
    dSprite.LAYOUT_ALIGN_RATIO = 4;
    dSprite.LAYOUT_ALIGN_RESIZE = 5;
    dSprite.LAYOUT_ALIGN_FIXED = 6;
    dSprite.SAMPLE_TYPE_CLAMP = 0;
    dSprite.SAMPLE_TYPE_REPEAT = 1;
    dSprite.SAMPLE_TYPE_MIRROR = 2;
    dSprite.m_rcCurScissorTestRect = null;
    return dSprite;
}(dObject));
var __dSpriteUniformData = (function () {
    function __dSpriteUniformData() {
        this.flag = 0;
        this.f1 = 0;
        this.f2 = 0;
        this.f3 = 0;
        this.f4 = 0;
        this.iData = 0;
        this.mat = null;
    }
    return __dSpriteUniformData;
}());
var dSpriteDefaultShader = (function (_super) {
    __extends(dSpriteDefaultShader, _super);
    function dSpriteDefaultShader() {
        var _this = _super.call(this) || this;
        _this.m_pMeshData = null;
        _this.m_orthoMatrix = new dMatrix();
        _this.m_pStreamMeshData = new dMeshData();
        _this.m_vertexDecl = [dMeshData.Vertex_Type_Pos3, dMeshData.Vertex_Type_UV2];
        var strVertex = dShader.GetHeader() +
            "uniform mat4 mWorld;\n" +
            "uniform mat4 mOrtho;\n" +
            "uniform mat4 mTransScreen;\n" +
            "uniform vec4 color;\n" +
            "uniform vec4 uvTrans;\n" +
            "varying vec2 textureCoordinate;\n" +
            "varying vec4 diffuse;\n" +
            "attribute vec4 Position0;\n" +
            "attribute vec2 TextureUV0;\n" +
            "void main(void) \n" +
            "{\n" +
            "gl_Position = mTransScreen * mOrtho * mWorld * Position0;\n" +
            "textureCoordinate.x = TextureUV0.x * uvTrans.z + uvTrans.x;\n" +
            "textureCoordinate.y = TextureUV0.y * uvTrans.w + uvTrans.y;\n" +
            "diffuse = color;\n" +
            "}";
        var strFragment = dShader.GetHeader() +
            "varying vec2 textureCoordinate;\n" +
            "varying vec4 diffuse;\n" +
            "uniform mat4 colorMatrix;\n" +
            "uniform sampler2D sTexture0;\n" +
            "uniform vec4 isAlphaPremultiplied;\n" +
            "void main(void) \n" +
            "{\n" +
            "vec4 finalColor = texture2D(sTexture0, textureCoordinate);\n" +
            "finalColor = colorMatrix * finalColor;\n" +
            "finalColor = clamp(finalColor, 0.0, 1.0);\n" +
            "finalColor *= diffuse;\n" +
            "float preAlpha = max(1.0 - isAlphaPremultiplied.x, diffuse.w);\n" +
            "finalColor.xyz *= preAlpha;\n" +
            "gl_FragColor = finalColor;\n" +
            "}";
        _this.Init(strVertex, strFragment, ["Position0", "TextureUV0"]);
        var vertices = [
            0.0, 0.0, 0.0, 0.0, 1.0,
            1.0, 0.0, 0.0, 1.0, 1.0,
            0.0, 1.0, 0.0, 0.0, 0.0,
            1.0, 1.0, 0.0, 1.0, 0.0
        ];
        var indices = [
            1, 0, 2,
            1, 2, 3
        ];
        var arr = new dByteArray();
        arr.SetEndian(dByteArray.LITTLE_ENDIAN);
        for (var i = 0; i < 4 * 5; i += 5) {
            arr.WriteFloat(vertices[i]);
            arr.WriteFloat(vertices[i + 1]);
            arr.WriteFloat(vertices[i + 2]);
            arr.WriteFloat(vertices[i + 3]);
            arr.WriteFloat(vertices[i + 4]);
        }
        arr.SetPosition(0);
        _this.m_pMeshData = new dMeshData();
        _this.m_pMeshData.SetData(null, 4, indices, _this.m_vertexDecl, dMeshData.ACCESS_WRITE_TYPE_STATIC_DRAW, vertices);
        var mat = new dMatrix();
        mat.Scaling(1, -1, 1);
        mat.TranslationAppend(-1, 1, 0);
        _this.SetUniformMatrix("mTransScreen", mat);
        _this.SetUniformF("isAlphaPremultiplied", 1, 1, 1, 1);
        _this.m_vertexTypeList = [dMeshData.Vertex_Type_Pos3, dMeshData.Vertex_Type_UV2];
        _this.SetWindowSize(dInterface.ptr.GetWindowWidth(), dInterface.ptr.GetWindowHeight());
        return _this;
    }
    dSpriteDefaultShader.Instance = function () {
        if (!dSpriteDefaultShader.s_pInstance)
            dSpriteDefaultShader.s_pInstance = new dSpriteDefaultShader();
        return dSpriteDefaultShader.s_pInstance;
    };
    dSpriteDefaultShader.prototype.GetMeshData = function () {
        return this.m_pMeshData;
    };
    dSpriteDefaultShader.prototype.SetWindowSize = function (width, height) {
        this.m_orthoMatrix.OrthoRH(width, height, 0.0, 99999.0);
        this.SetUniformMatrix("mOrtho", this.m_orthoMatrix);
    };
    dSpriteDefaultShader.prototype.isInRender = function (pSprite, matWorld) {
        if (pSprite.GetScaleX() == 0 || pSprite.GetScaleY() == 0 || pSprite.GetScaleZ() == 0 || pSprite.GetWidth() == 0 || pSprite.GetHeight() == 0)
            return 0;
        pSprite.ComputeMatrixSelf(matWorld);
        matWorld = pSprite.m_matRenderMatrixSelf;
        if (matWorld._12 == 0 && matWorld._13 == 0 && matWorld._14 == 0 &&
            matWorld._21 == 0 && matWorld._23 == 0 && matWorld._24 == 0) {
            var w = dMath.Abs(matWorld._11);
            var h = dMath.Abs(matWorld._22);
            var left = matWorld._41;
            var top = matWorld._42;
            if (matWorld._11 < 0)
                left -= w;
            if (matWorld._22 < 0)
                top -= h;
            var rc = dSprite.GetScissorTest();
            if (left + w < rc.left || left > rc.right || top + h < rc.top || top > rc.bottom)
                return 0;
        }
        return 1;
    };
    dSpriteDefaultShader.prototype.OnBindSprite = function (p) {
        p.SetEnableZReadWrite(dSprite.DEPTHTEST_DISABLE);
    };
    dSpriteDefaultShader.s_pInstance = null;
    return dSpriteDefaultShader;
}(dShader));
var dSpriteDefault3DShader = (function (_super) {
    __extends(dSpriteDefault3DShader, _super);
    function dSpriteDefault3DShader() {
        var _this = _super.call(this) || this;
        var strVertex = dShader.GetHeader() +
            "uniform mat4 mWorld;\n" +
            "uniform mat4 mView;\n" +
            "uniform mat4 mProjection;\n" +
            "uniform mat4 mTransScreen;\n" +
            "uniform vec4 color;\n" +
            "uniform vec4 uvTrans;\n" +
            "varying vec2 textureCoordinate;\n" +
            "varying vec4 diffuse;\n" +
            "attribute vec4 Position0;\n" +
            "attribute vec2 TextureUV0;\n" +
            "void main(void) \n" +
            "{\n" +
            "gl_Position = mProjection * mView * mWorld * mTransScreen * Position0;\n" +
            "textureCoordinate.x = TextureUV0.x * uvTrans.z + uvTrans.x;\n" +
            "textureCoordinate.y = TextureUV0.y * uvTrans.w + uvTrans.y;\n" +
            "diffuse = color;\n" +
            "}";
        var strFragment = dShader.GetHeader() +
            "varying vec2 textureCoordinate;\n" +
            "varying vec4 diffuse;\n" +
            "uniform mat4 colorMatrix;\n" +
            "uniform sampler2D sTexture0;\n" +
            "uniform vec4 isAlphaPremultiplied;\n" +
            "uniform vec4 fogColor;\n" +
            "uniform vec4 fogStartEnd;\n" +
            "float fog_linear(float dist, float start, const float end) {return 1.0 - clamp((end - dist) / (end - start), 0.0, 1.0);}\n" +
            "void main(void) \n" +
            "{\n" +
            "vec4 finalColor = texture2D(sTexture0, textureCoordinate);\n" +
            "finalColor = colorMatrix * finalColor;\n" +
            "finalColor = clamp(finalColor, 0.0, 1.0);\n" +
            "finalColor *= diffuse;\n" +
            "float preAlpha = max(1.0 - isAlphaPremultiplied.x, diffuse.w);\n" +
            "finalColor.xyz *= preAlpha;\n" +
            "if ( finalColor.w == 0.0 ) discard;\n" +
            "float fogFactor = fog_linear(gl_FragCoord.z / gl_FragCoord.w, fogStartEnd.x, fogStartEnd.y);\n" +
            "gl_FragColor = mix(finalColor, fogColor, fogFactor);\n" +
            "}";
        _this.Init(strVertex, strFragment, ["Position0", "TextureUV0"]);
        _this.SetUniformMatrix("mTransScreen", new dMatrix().Translation(-0.5, -0.5, 0).Mul(new dMatrix().RotationX(dMath.AngleToRadian(180))).Mul(new dMatrix().Translation(0.5, 0.5, 0)));
        _this.SetUniformF("isAlphaPremultiplied", 1, 1, 1, 1);
        _this.m_vertexTypeList = [dMeshData.Vertex_Type_Pos3, dMeshData.Vertex_Type_UV2];
        return _this;
    }
    dSpriteDefault3DShader.Instance = function () {
        if (dSpriteDefault3DShader.s_pInstance == null)
            dSpriteDefault3DShader.s_pInstance = new dSpriteDefault3DShader();
        return dSpriteDefault3DShader.s_pInstance;
    };
    dSpriteDefault3DShader.prototype.isInRender = function (pSprite, matWorld) {
        return 1;
    };
    dSpriteDefault3DShader.prototype.OnBindSprite = function (p) {
        p.SetEnableZReadWrite(dSprite.DEPTHTEST_READWRITE);
    };
    dSpriteDefault3DShader.s_pInstance = null;
    return dSpriteDefault3DShader;
}(dShader));
var CheckCollectionData = (function () {
    function CheckCollectionData() {
        this.matWorld = new dMatrix();
        this.P = new dVector3();
        this.points = [new dVector3(), new dVector3(), new dVector3(), new dVector3()];
    }
    CheckCollectionData.prototype.ResetPoints = function () {
        this.points[0].SetValue(0, 0, 0);
        this.points[1].SetValue(1, 0, 0);
        this.points[2].SetValue(1, 1, 0);
        this.points[3].SetValue(0, 1, 0);
        return this.points;
    };
    CheckCollectionData.prototype.CheckPointInTriangle = function () {
        return dMath.PointInTriangle(this.points[0], this.points[1], this.points[2], this.P) ||
            dMath.PointInTriangle(this.points[0], this.points[2], this.points[3], this.P);
    };
    return CheckCollectionData;
}());
var dBaseControl = (function (_super) {
    __extends(dBaseControl, _super);
    function dBaseControl() {
        var _this = _super.call(this) || this;
        _this.m_pEvent = null;
        _this.m_bEnabled = true;
        _this.m_bSelection = false;
        _this.m_bBeginDsc = false;
        _this.SetAnchor(0.5, 0.5);
        return _this;
    }
    dBaseControl.prototype.BeginDsc = function () {
        this.m_bBeginDsc = true;
    };
    dBaseControl.prototype.EndDsc = function () {
        this.m_bBeginDsc = false;
    };
    dBaseControl.prototype.SetEvent = function (evt) {
        this.m_pEvent = evt;
    };
    dBaseControl.prototype.GetEvent = function () {
        return this.m_pEvent;
    };
    dBaseControl.prototype.GetTypeName = function () {
        return "";
    };
    dBaseControl.prototype.GetView = function () {
        return this;
    };
    dBaseControl.prototype.isEnable = function () {
        return this.m_bEnabled;
    };
    dBaseControl.prototype.SetEnable = function (b) {
        this.m_bEnabled = b;
    };
    Object.defineProperty(dBaseControl.prototype, "renderAs3D", {
        get: function () {
            return false;
        },
        set: function (b3d) {
            if (b3d) {
                this.SetShader(dSpriteDefault3DShader.Instance());
                this.SetEnableZReadWrite(dSprite.DEPTHTEST_READWRITE);
            }
            else {
                this.SetShader(dSpriteDefaultShader.Instance());
                this.SetEnableZReadWrite(dSprite.DEPTHTEST_DISABLE);
            }
            var vec = this.GetChildList();
            for (var i = 0, n = vec.length; i < n; i++)
                if (vec[i] instanceof dBaseControl)
                    vec[i].renderAs3D = b3d;
        },
        enumerable: false,
        configurable: true
    });
    dBaseControl.prototype.SetSelection = function (bSelect, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        this.m_bSelection = bSelect;
        if (bSetToChild) {
            var child = this.GetChildList();
            for (var i = 0, n = child.length; i < n; i++)
                if (child[i] instanceof dBaseControl)
                    child[i].SetSelection(bSelect, bSetToChild);
        }
    };
    dBaseControl.prototype.SpriteRender = function () {
        if (this.m_bSelection) {
            var bmp = this.GetBitmapData();
            this.SetBitmapData(dBitmapData.WHITE_BITMAPDATA);
            var color = this.spriteColor;
            this.spriteColor = (~color) | 0xff000000;
            this.SetBlendMode(this.GetBlendMode());
            _super.prototype.SpriteRender.call(this);
            this.SetBitmapData(bmp);
            this.spriteColor = color;
            this.SetBlendMode(this.GetBlendMode());
            _super.prototype.SpriteRender.call(this);
        }
        else
            _super.prototype.SpriteRender.call(this);
    };
    dBaseControl.prototype.CollectionRay = function (_orig, _dir, ptOut, bBoundingBoxOnly, mat) {
        if (ptOut === void 0) { ptOut = null; }
        if (bBoundingBoxOnly === void 0) { bBoundingBoxOnly = false; }
        if (mat === void 0) { mat = null; }
        var matLocal = mat;
        if (matLocal == null)
            matLocal = this.GetMatrixLocal();
        var matLocalInverse = new dMatrix().Copy(matLocal).Inverse();
        var orig = new dVector3().Copy(_orig);
        var dir = new dVector3().Copy(_dir);
        orig.Transform(matLocalInverse);
        dir.TransformNormal(matLocalInverse);
        var pBoundingBox = this.GetBoundingBox();
        if (pBoundingBox.isCollectionRay(orig, dir)) {
            if (bBoundingBoxOnly)
                return true;
            var vertices = [
                new dVector3(pBoundingBox.x1, pBoundingBox.y1, pBoundingBox.z1),
                new dVector3(pBoundingBox.x1, pBoundingBox.y2, pBoundingBox.z1),
                new dVector3(pBoundingBox.x2, pBoundingBox.y1, pBoundingBox.z1),
                new dVector3(pBoundingBox.x2, pBoundingBox.y2, pBoundingBox.z1)
            ];
            var ib = [0, 1, 2, 1, 2, 3];
            var tuvOut = new dVector3();
            var pt = new dVector3();
            var colLength;
            var bColed;
            for (var j = 0, n2 = ib.length; j < n2; j += 3) {
                var p1 = vertices[ib[j]];
                var p2 = vertices[ib[j + 1]];
                var p3 = vertices[ib[j + 2]];
                if (dMath.RayTriangleIntersection(orig, dir, p1, p2, p3, tuvOut)) {
                    if (ptOut == null)
                        return true;
                    var u = tuvOut.x;
                    var v = tuvOut.y;
                    pt.x = (1.0 - u - v) * p1.x + u * p2.x + v * p3.x;
                    pt.y = (1.0 - u - v) * p1.y + u * p2.y + v * p3.y;
                    pt.z = (1.0 - u - v) * p1.z + u * p2.z + v * p3.z;
                    var len = pt.LengthTo(orig);
                    if (!bColed || colLength > len) {
                        bColed = true;
                        ptOut.Copy(pt);
                        colLength = len;
                    }
                }
            }
            if (bColed) {
                if (ptOut != null)
                    ptOut.Transform(matLocal);
                return true;
            }
        }
        return false;
    };
    dBaseControl.prototype.GetBoundingBox = function () {
        var ret = new dBoundingBox();
        ret.x1 = -this.width * this.anchorU;
        ret.y1 = -this.height * this.anchorV;
        ret.z1 = -this.depth * this.anchorW;
        ret.x2 = ret.x1 + this.width;
        ret.y2 = ret.y1 + this.height;
        ret.z2 = ret.z1 + this.depth;
        return ret;
    };
    dBaseControl.prototype.LoadFromJson = function (j) {
        _super.prototype.LoadFromJson.call(this, j);
        if (j.hasOwnProperty("renderAs3D"))
            this.renderAs3D = Boolean(j.renderAs3D);
    };
    return dBaseControl;
}(dSprite));
var BasePage = (function (_super) {
    __extends(BasePage, _super);
    function BasePage() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    BasePage.prototype.Update = function () {
        if (this.GetEnergyBar() != null) {
            this.GetEnergyBar().Update();
            this.GetEnergyBar().visible = GDefine.EnableEnergy;
        }
    };
    BasePage.prototype.OnBack = function () {
    };
    BasePage.prototype.OnPerSecond = function () {
    };
    BasePage.prototype.OnFadeFinish = function () {
    };
    BasePage.prototype.GetEnergyBar = function () {
        return null;
    };
    BasePage.prototype.isFadeOutRemove = function () {
        return false;
    };
    BasePage.prototype.FadeInOut = function (isIn, onComplete, isTurnBack) {
        if (isIn) {
            if (isTurnBack) {
                var whiteImageList = new Array();
                for (var i = 0; i < 4; i++) {
                    var whiteImage = new dImage();
                    whiteImage.pureColor = true;
                    whiteImage.SetAnchor(0, 0);
                    if (i == 0) {
                        whiteImage.SetSize(dThread.GetWindowWidth() + 400, 200);
                        whiteImage.SetPos(-200, -whiteImage.height);
                    }
                    else if (i == 1) {
                        whiteImage.SetSize(dThread.GetWindowWidth() + 400, 200);
                        whiteImage.SetPos(-200, dThread.GetWindowHeight());
                    }
                    else if (i == 2) {
                        whiteImage.SetSize(200, dThread.GetWindowHeight());
                        whiteImage.SetPos(-whiteImage.width, 0);
                    }
                    else if (i == 3) {
                        whiteImage.SetSize(200, dThread.GetWindowHeight());
                        whiteImage.SetPos(dThread.GetWindowWidth(), 0);
                    }
                    this.AddChild(whiteImage);
                    whiteImageList.push(whiteImage);
                }
                this.SetScale(0.9, 0.9);
                this.positionX += dThread.GetWindowWidth() / 2 * 0.1;
                this.positionY += dThread.GetWindowHeight() / 2 * 0.1;
                CCActionManager.Instance().AddAction(new CCSequence([
                    new CCSpawn([
                        new CCScaleTo(0.5, 1, 1),
                        new CCMoveBy(0.5, -dThread.GetWindowWidth() / 2 * 0.1, -dThread.GetWindowHeight() / 2 * 0.1)
                    ]),
                    new CCCallFunc(function () {
                        for (var i = 0; i < whiteImageList.length; i++)
                            whiteImageList[i].RemoveParent();
                    })
                ]), this);
                if (onComplete != null)
                    onComplete(this);
            }
            else {
                this.positionX += dThread.GetWindowWidth();
                CCActionManager.Instance().AddAction(new CCSequence([
                    new CCMoveBy(0.5, -dThread.GetWindowWidth(), 0),
                    new CCCallFunc(onComplete)
                ]), this);
            }
        }
        else {
            if (isTurnBack) {
                CCActionManager.Instance().AddAction(new CCSequence([
                    new CCMoveBy(0.5, dThread.GetWindowWidth(), 0),
                    new CCRemoveSelf()
                ]), this);
                if (onComplete != null)
                    onComplete(this);
            }
            else {
                var whiteImageList = new Array();
                for (var i = 0; i < 4; i++) {
                    var whiteImage = new dImage();
                    whiteImage.pureColor = true;
                    whiteImage.SetAnchor(0, 0);
                    if (i == 0) {
                        whiteImage.SetSize(dThread.GetWindowWidth() + 400, 200);
                        whiteImage.SetPos(-200, -whiteImage.height);
                    }
                    else if (i == 1) {
                        whiteImage.SetSize(dThread.GetWindowWidth() + 400, 200);
                        whiteImage.SetPos(-200, dThread.GetWindowHeight());
                    }
                    else if (i == 2) {
                        whiteImage.SetSize(200, dThread.GetWindowHeight());
                        whiteImage.SetPos(-whiteImage.width, 0);
                    }
                    else if (i == 3) {
                        whiteImage.SetSize(200, dThread.GetWindowHeight());
                        whiteImage.SetPos(dThread.GetWindowWidth(), 0);
                    }
                    this.AddChild(whiteImage);
                    whiteImageList.push(whiteImage);
                }
                CCActionManager.Instance().AddAction(new CCSequence([
                    new CCSpawn([
                        new CCScaleTo(0.5, 0.9, 0.9),
                        new CCMoveBy(0.5, dThread.GetWindowWidth() / 2 * 0.1, dThread.GetWindowHeight() / 2 * 0.1)
                    ]),
                    new CCCallFunc(function () {
                        for (var i = 0; i < whiteImageList.length; i++)
                            whiteImageList[i].RemoveParent();
                    }),
                    new CCRemoveSelf()
                ]), this);
                if (onComplete != null)
                    onComplete(this);
            }
        }
    };
    BasePage.prototype.MoveInOut = function (isIn, onComplete, bAniInverse) {
        var _this = this;
        var dir = bAniInverse ? -1 : 1;
        if (isIn) {
            this.positionX = dThread.GetWindowWidth() * 1.0 * dir;
            CCActionManager.Instance().AddAction(new CCSequence([
                new CCMoveTo(0.5, 0, 0),
                new CCCallFunc(onComplete)
            ]), this);
        }
        else {
            onComplete(this);
            CCActionManager.Instance().AddAction(new CCSequence([
                new CCDelayTime(0.05),
                new CCMoveTo(0.5, -dThread.GetWindowWidth() * 1.0 * dir, 0),
                new CCCallFunc(function () {
                    if (_this != null) {
                        _this.Destroy();
                        _this.RemoveParent();
                    }
                })
            ]), this);
        }
    };
    BasePage.prototype.ScaleInOut = function (isIn, p, delay, onComplete) {
        if (isIn) {
            p.SetScale(0, 0);
            dBitmapData.SetGlobalImageLoadComplete(function () {
                CCActionManager.Instance().AddAction(new CCSequence([
                    new CCDelayTime(delay),
                    new CCScaleTo(0.1, 1.2, 1.2),
                    new CCScaleTo(0.1, 1, 1),
                    new CCCallFunc(onComplete)
                ]), p);
            });
        }
        else {
            CCActionManager.Instance().AddAction(new CCSequence([
                new CCDelayTime(delay),
                new CCScaleTo(0.1, 1.2, 1.2),
                new CCScaleTo(0.1, 0, 0),
                new CCCallFunc(onComplete)
            ]), p);
        }
    };
    BasePage.prototype.ScaleInOutList = function (isIn, list, onComplete, delay) {
        if (delay === void 0) { delay = 0; }
        var callback = new dCompleteCallback(this);
        for (var i = 0; i < list.length; i++) {
            this.ScaleInOut(isIn, list[i], i * 0.1 + delay, callback.CreateCompleteFun_Normal());
        }
        callback.SetCompleteFun(onComplete);
    };
    BasePage.prototype.GetSpriteGoundRect = function (p) {
        var rc = new dRect();
        rc.SetPosSize(-p.width * p.anchorU, -p.height * p.anchorV, p.width, p.height);
        return rc;
    };
    BasePage.prototype.FlyInOut = function (isIn, p, delay, up, onComplete) {
        if (isIn) {
            var rc = this.GetSpriteGoundRect(p);
            var srcPosY;
            if (up) {
                srcPosY = -rc.Height() * (1 - p.anchorV);
            }
            else {
                srcPosY = dThread.GetWindowHeight() + rc.Height() * p.anchorV;
            }
            var destPosY = p.positionY;
            var destPosX = p.positionX;
            p.positionY = srcPosY;
            p.positionX = (p.positionX - dThread.GetWindowWidth() * p.anchorU) * 2 + dThread.GetWindowWidth() * p.anchorU;
            dBitmapData.SetGlobalImageLoadComplete(function () {
                CCActionManager.Instance().AddAction(new CCSequence([
                    new CCDelayTime(delay),
                    new CCEaseBackOut(new CCMoveTo(0.3, destPosX, destPosY)),
                    new CCCallFunc(onComplete)
                ]), p);
            });
        }
        else {
            var rc = this.GetSpriteGoundRect(p);
            var destPosY;
            if (up) {
                destPosY = -rc.Height() * (1 - p.anchorV);
            }
            else {
                destPosY = dThread.GetWindowHeight() + rc.Height() * p.anchorV;
            }
            var destPosX = (p.positionX - dThread.GetWindowWidth() * p.anchorU) * 2 + dThread.GetWindowWidth() * p.anchorU;
            CCActionManager.Instance().AddAction(new CCSequence([
                new CCDelayTime(delay),
                new CCEaseBackIn(new CCMoveTo(0.3, destPosX, destPosY)),
                new CCCallFunc(onComplete)
            ]), p);
        }
    };
    BasePage.prototype.FlyInOutList = function (isIn, upList, downList, onComplete) {
        var _this = this;
        var vecOldPosUp = new Array();
        var vecOldPosDown = new Array();
        if (upList != null && !isIn) {
            vecOldPosUp.resize(upList.length);
            for (var i = 0; i < upList.length; i++)
                vecOldPosUp[i] = new dVector2(upList[i].positionX, upList[i].positionY);
        }
        if (downList != null && !isIn) {
            vecOldPosDown.resize(downList.length);
            for (var i = 0; i < downList.length; i++)
                vecOldPosDown[i] = new dVector2(downList[i].positionX, downList[i].positionY);
        }
        var callback = new dCompleteCallback(this);
        if (upList != null) {
            for (var i = 0; i < upList.length; i++) {
                this.FlyInOut(isIn, upList[i], i * (0.1 / upList.length), 1, callback.CreateCompleteFun_Normal());
            }
        }
        if (downList != null) {
            for (var i = 0; i < downList.length; i++) {
                this.FlyInOut(isIn, downList[i], i * (0.1 / downList.length), 0, callback.CreateCompleteFun_Normal());
            }
        }
        callback.SetCompleteFun(function () {
            if (!isIn) {
                for (var i = 0; i < vecOldPosUp.length; i++)
                    upList[i].SetPos(vecOldPosUp[i].x, vecOldPosUp[i].y);
                for (var i = 0; i < vecOldPosDown.length; i++)
                    downList[i].SetPos(vecOldPosDown[i].x, vecOldPosDown[i].y);
            }
            if (onComplete != null)
                onComplete(_this);
        });
    };
    BasePage.prototype.OpenPanel = function (HandleMousePanel, panel, onComplete, bAni) {
        var _this = this;
        if (onComplete === void 0) { onComplete = null; }
        if (bAni === void 0) { bAni = true; }
        panel.LayoutToSize(this.width, this.height);
        HandleMousePanel.visible = true;
        panel.visible = true;
        var vec = panel.GetChildList();
        var vecUp = new Array();
        var vecDown = new Array();
        for (var i = 0; i < vec.length; i++) {
            vecUp.push(vec[i]);
        }
        this.FlyInOutList(true, vecUp, vecDown, function () {
            HandleMousePanel.visible = false;
            if (onComplete != null)
                onComplete(_this);
        });
    };
    BasePage.prototype.ClosePanel = function (HandleMousePanel, panel, onComplete, bAni) {
        var _this = this;
        if (onComplete === void 0) { onComplete = null; }
        if (bAni === void 0) { bAni = true; }
        HandleMousePanel.visible = true;
        var vec = panel.GetChildList();
        var vecUp = new Array();
        var vecDown = new Array();
        for (var i = 0; i < vec.length; i++) {
            if (vec[i].positionY < dThread.GetWindowHeight() / 2)
                vecUp.push(vec[i]);
            else
                vecDown.push(vec[i]);
        }
        this.FlyInOutList(false, vecUp, vecDown, function () {
            panel.visible = false;
            HandleMousePanel.visible = false;
            if (onComplete != null)
                onComplete(_this);
        });
    };
    return BasePage;
}(dBaseControl));
var ChangeScreen = (function (_super) {
    __extends(ChangeScreen, _super);
    function ChangeScreen() {
        var _this = _super.call(this) || this;
        _this.circle = null;
        _this.SetSize(dThread.GetWindowWidth(), dThread.GetWindowHeight());
        _this.circle = new dImage();
        _this.circle.LoadFromFile("data/dot2.png");
        _this.AddChild(_this.circle);
        _this.spriteName = "ChangeScreen";
        return _this;
    }
    ChangeScreen.prototype.PlayFadeIn = function (onComplete, p) {
        this.circle.SetScale(0, 0);
        if (p)
            this.circle.SetPos(p.GetPosX_World(PageManager.Instance(), false), p.GetPosY_World(PageManager.Instance(), false));
        else
            this.circle.SetPos(this.width / 2, this.height / 2);
        var scale = dMath.Max(this.width, this.height) / 512 + 1;
        this.circle.alpha = 1;
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCScaleTo(0.6, scale, scale),
            new CCCallFunc(onComplete)
        ]), this.circle);
    };
    ChangeScreen.prototype.PlayFadeOut = function (onComplete) {
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCFadeOut(0.4),
            new CCCallFunc(onComplete)
        ]), this.circle);
    };
    return ChangeScreen;
}(dSprite));
var dImage = (function (_super) {
    __extends(dImage, _super);
    function dImage() {
        var _this = _super.call(this) || this;
        _this.m_pImageBitmapData = null;
        return _this;
    }
    Object.defineProperty(dImage.prototype, "pureColor", {
        get: function () {
            return this.GetBitmapData() == dBitmapData.WHITE_BITMAPDATA;
        },
        set: function (bSet) {
            if (bSet)
                _super.prototype.SetBitmapData.call(this, dBitmapData.WHITE_BITMAPDATA);
            else
                this.SetBitmapData(this.m_pImageBitmapData);
        },
        enumerable: false,
        configurable: true
    });
    dImage.prototype.LoadFromFile = function (strImage, onLoadComplete, bAutoResize, rcSource) {
        var _this = this;
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (bAutoResize === void 0) { bAutoResize = true; }
        if (rcSource === void 0) { rcSource = null; }
        if (strImage != null && this.GetFileName() != strImage) {
            if (strImage != "") {
                if (bAutoResize)
                    this.SetSize(0, 0);
                var bmp = new dBitmapData();
                this.SetBitmapData(bmp, rcSource);
                bmp.LoadFromFile(strImage, function () {
                    if (bAutoResize && _this.GetWidth() == 0 && _this.GetHeight() == 0) {
                        if (rcSource == null)
                            _this.SetSize(bmp.GetWidth(), bmp.GetHeight());
                        else
                            _this.SetSize(bmp.GetWidth() * rcSource.Width(), bmp.GetHeight() * rcSource.Height());
                    }
                    if (onLoadComplete)
                        onLoadComplete(_this);
                });
            }
            else if (this.GetBitmapData() != null) {
                this.SetBitmapData(null);
                if (onLoadComplete)
                    onLoadComplete(this);
            }
        }
        else {
            if (onLoadComplete)
                onLoadComplete(this);
        }
        return this;
    };
    dImage.prototype.SetLoadCompleteCallback = function (onComplete) {
        var _this = this;
        if (this.GetBitmapData() == null || !this.GetBitmapData().isLoading())
            onComplete(this);
        else {
            new dTimer(this).Create(100, 0, function (sender) {
                if (_this.GetBitmapData() == null || !_this.GetBitmapData().isLoading()) {
                    onComplete(_this);
                    sender.Stop();
                }
            });
        }
    };
    dImage.prototype.SetBitmapData = function (bmp, pSourceRect, at, sampleType) {
        if (pSourceRect === void 0) { pSourceRect = null; }
        if (at === void 0) { at = 0; }
        if (sampleType === void 0) { sampleType = 0; }
        if (at == 0)
            this.m_pImageBitmapData = bmp;
        _super.prototype.SetBitmapData.call(this, bmp, pSourceRect, at, sampleType);
    };
    dImage.prototype.SetSizeAsBitmapData = function () {
        if (this.m_pImageBitmapData != null)
            this.SetSize(this.m_pImageBitmapData.GetWidth(), this.m_pImageBitmapData.GetHeight());
    };
    dImage.prototype.GetFileName = function () {
        if (this.GetBitmapData() == null)
            return "";
        return this.GetBitmapData().GetResourceFileName();
    };
    Object.defineProperty(dImage.prototype, "resourceFileName", {
        get: function () {
            return this.GetFileName();
        },
        set: function (fileName) {
            this.LoadFromFile(fileName, null, false);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dImage.prototype, "resourceFileNameWithAutoResize", {
        set: function (fileName) {
            this.LoadFromFile(fileName, null, true);
        },
        enumerable: false,
        configurable: true
    });
    dImage.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("resourceFileName"))
            this.resourceFileName = json.resourceFileName;
        if (json.hasOwnProperty("pureColor"))
            this.pureColor = json.pureColor;
    };
    dImage.prototype.isLoading = function () {
        if (this.GetBitmapData() != null)
            return this.GetBitmapData().isLoading();
        return true;
    };
    return dImage;
}(dBaseControl));
var ColorfulEffect = (function (_super) {
    __extends(ColorfulEffect, _super);
    function ColorfulEffect(type) {
        if (type === void 0) { type = 0; }
        var _this = _super.call(this) || this;
        _this.m_vecImages = new Array();
        _this.m_fAddImageTime = 0;
        _this.SetLayoutAlign(dSprite.LAYOUT_ALIGN_LEFT_TOP, dSprite.LAYOUT_ALIGN_LEFT_TOP);
        if (type == 0) {
            for (var i = 0; i < 60; i++) {
                var p = _this.CreateImage();
                p.SetPos(dMath.Random() * dThread.GetWindowWidth(), dMath.Random() * dThread.GetWindowHeight());
                _this.AddChild(p);
                _this.m_vecImages.push(p);
            }
            new dTimer(_this).Create(0, 0, function (sender, iTimer, fTimer) {
                if (_this.GetParent() != null && _this.visible) {
                    _this.SetPos(-_this.GetParent().GetPosX_World(PageManager.Instance()), -_this.GetParent().GetPosY_World(PageManager.Instance()));
                    _this.m_fAddImageTime += fTimer;
                    if (_this.m_fAddImageTime > 0.15) {
                        _this.m_fAddImageTime = 0;
                        var p = _this.CreateImage();
                        p.SetPos(dMath.Random() * dThread.GetWindowWidth(), -50);
                        _this.AddChild(p);
                        _this.m_vecImages.push(p);
                    }
                    for (var i = 0; i < _this.m_vecImages.length; i++) {
                        var p = _this.m_vecImages[i];
                        p.rotation += p.rotSpeed * fTimer;
                        p.positionX += p.moveSpeedX * fTimer;
                        p.positionY += p.moveSpeedY * fTimer;
                        if (p.positionY > dThread.GetWindowHeight() + 50) {
                            p.RemoveParent();
                            _this.m_vecImages.erase(i);
                            i--;
                        }
                    }
                }
            });
        }
        else {
            var v = new dVector2();
            for (var i = 0; i < 60; i++) {
                var p = _this.CreateImage();
                _this.AddChild(p);
                p.moveSpeedX = dMath.RandomRange(-1, 1) * 1500;
                p.moveSpeedY = -dMath.Random() * 2800;
                _this.m_vecImages.push(p);
            }
            new dTimer(_this).Create(0, 0, function (sender, iTimer, fTimer) {
                if (_this.GetParent() != null && _this.visible) {
                    for (var i = 0; i < _this.m_vecImages.length; i++) {
                        var p = _this.m_vecImages[i];
                        p.rotation += p.rotSpeed * fTimer;
                        p.positionX += p.moveSpeedX * fTimer;
                        p.positionY += p.moveSpeedY * fTimer;
                        p.moveSpeedY += fTimer * 5500;
                        if (p.positionY + _this.positionY > dThread.GetWindowHeight() + 50) {
                            p.RemoveParent();
                            _this.m_vecImages.erase(i);
                            i--;
                        }
                    }
                }
            });
        }
        return _this;
    }
    ColorfulEffect.prototype.CreateImage = function () {
        var p = new ColorfulImage();
        p.pureColor = true;
        p.SetTransparentMouse(true);
        p.SetSize(dMath.RandomRange(20, 50), dMath.RandomRange(20, 50));
        var rnd = dMath.RandomI() % 5;
        var color = -1;
        switch (rnd) {
            case 0:
                color = 0xffd961ff;
                break;
            case 1:
                color = 0xffffd85d;
                break;
            case 2:
                color = 0xffec453e;
                break;
            case 3:
                color = 0xff5dc441;
                break;
            case 4:
                color = 0xff2cc3ef;
                break;
        }
        p.spriteColor = color;
        p.rotation = dMath.Random() * 360;
        p.rotSpeed = dMath.RandomRange(-200, 200);
        p.moveSpeedY = dMath.RandomRange(200, 500);
        p.moveSpeedX = dMath.RandomRange(-50, 50);
        return p;
    };
    return ColorfulEffect;
}(dSprite));
var ColorfulImage = (function (_super) {
    __extends(ColorfulImage, _super);
    function ColorfulImage() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.moveSpeedX = 0;
        _this.moveSpeedY = 0;
        _this.rotSpeed = 0;
        return _this;
    }
    return ColorfulImage;
}(dImage));
var EnergyBar = (function (_super) {
    __extends(EnergyBar, _super);
    function EnergyBar() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        new dTimer(_this).Create(1000, 0, function () {
            _this.Update();
        }).Apply();
        _this.AddButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            PageManager.Instance().OpenPanel(null, new AddEnergyPanel());
        }));
        return _this;
    }
    EnergyBar.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Back", "classType": "dScale9", "height": 84, "resourceFileName": "data/goldback.png", "width": 225, "x": 6, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Icon", "classType": "dImage", "height": 120, "resourceFileName": "data/energyicon.png", "scaleX": 0.866667, "scaleY": 0.866667, "width": 72, "x": -90.199951, "y": -1 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Number", "classType": "dBitmapFont", "fontSize": 48, "height": 48.75, "resourceFileName": "data/fontNumber.json", "spriteColor": -4622029, "text": "0", "width": 27, "x": 1, "y": -7 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Time", "classType": "dBitmapFont", "fontSize": 32, "height": 32.5, "resourceFileName": "data/fontNumber.json", "text": "00:00", "width": 80.5, "x": 4, "y": 56 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "AddButton", "classType": "dButton", "height": 103, "resourceFileName": "data/addbutton.png", "scaleX": 0.92233, "scaleY": 0.92233, "width": 92, "x": 112.427185, "y": 1 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 90, "width": 350, "x": 0, "y": 0 }; };
    EnergyBar.prototype.Update = function () {
        if (SaveData.Instance().passStage < EnergyBar.FREE_ENERGY_STAGE) {
            this.Number.text = "";
        }
        else
            this.Number.text = String(SaveData.Instance().energy);
        if (SaveData.Instance().energy >= GDefine.MAX_ENERGY || SaveData.Instance().passStage < EnergyBar.FREE_ENERGY_STAGE)
            this.Time.visible = false;
        else {
            this.Time.visible = true;
            var timeRemain = GDefine.ADD_ENERGY_TIME - SaveData.Instance().energyAddTime;
            if (timeRemain < 0)
                timeRemain = 0;
            var second = timeRemain % 60;
            var minute = timeRemain / 60;
            this.Time.text = dStringUtils.FormatInt(minute, 2) + ":" + dStringUtils.FormatInt(second, 2);
        }
    };
    EnergyBar.prototype.FlashEnergy = function () {
        CCActionManager.Instance().RemoveAllActionsFromTarget(this.Number);
        var color = dMath.ColorToValue(0xffffffff);
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCTintTo(0.1, 1, 0, 0, 1, false, false),
            new CCTintTo(0.1, color.x, color.y, color.z, color.w, false, false),
            new CCTintTo(0.1, 1, 0, 0, 1, false, false),
            new CCTintTo(0.1, color.x, color.y, color.z, color.w, false, false)
        ]), this.Number);
    };
    EnergyBar.FREE_ENERGY_STAGE = 0;
    return EnergyBar;
}(dSprite));
var GDefine = (function () {
    function GDefine() {
    }
    GDefine.ToMinuteSecondTime = function (fTime) {
        var time = fTime * 1000;
        var minute = dMath.ToInt(time / 60000);
        var second = (time % 60000) / 1000;
        return dStringUtils.FormatInt(minute, 2) + ":" + dStringUtils.FormatInt(second, 2);
    };
    GDefine.PlayButtonSound = function () {
        dSound.PlaySound("data/sound/button.mp3");
    };
    GDefine.MyAppName = "Hanziduobianhua";
    GDefine.MyAppName2 = "";
    GDefine.MAX_ENERGY = 5;
    GDefine.ADD_ENERGY_TIME = 1800;
    GDefine.EnableEnergy = false;
    return GDefine;
}());
var GamePage = (function (_super) {
    __extends(GamePage, _super);
    function GamePage(stagedata) {
        var _this = _super.call(this) || this;
        _this.m_pGameWorld = null;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.m_pGameWorld = new GameWorld(stagedata);
        _this.GameLayer.AddChild(_this.m_pGameWorld);
        _this.m_pGameWorld.SetPos(-_this.m_pGameWorld.width * _this.anchorU, -_this.m_pGameWorld.height * _this.anchorV);
        _this.Update();
        return _this;
    }
    GamePage.prototype._dscData = function () { return { "_child": [{ "anchorU": 0, "anchorV": 0, "className": "GameLayer", "classType": "dSprite", "height": 1920, "layoutAlignH": 1, "layoutAlignV": 1, "width": 1080, "x": 0, "y": 0 }], "anchorU": 0, "anchorV": 0, "classType": "dSprite", "height": 1920, "width": 1080, "x": 0, "y": 0 }; };
    GamePage.prototype.Update = function () {
        _super.prototype.Update.call(this);
    };
    GamePage.prototype.Destroy = function () {
        _super.prototype.Destroy.call(this);
        this.m_pGameWorld.Destroy();
    };
    GamePage.prototype.LayoutToSize = function (width, height) {
        _super.prototype.LayoutToSize.call(this, width, height);
        this.m_pGameWorld.LayoutToSize(width, height);
    };
    return GamePage;
}(BasePage));
var HandIcon = (function (_super) {
    __extends(HandIcon, _super);
    function HandIcon() {
        var _this = _super.call(this) || this;
        _this.imgX = 0;
        _this.imgY = 0;
        _this.m_vecDot = new Array();
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.imgX = _this.TabView_Image2.positionX;
        _this.imgY = _this.TabView_Image2.positionY;
        return _this;
    }
    HandIcon.prototype._dscData = function () { return { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 247, "resourceFileName": "data/hand.png", "width": 245, "x": 63, "y": 48 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image2", "classType": "dImage", "height": 247, "resourceFileName": "data/hand.png", "rotation": -17.18874, "scaleX": 0.95, "scaleY": 0.95, "visible": 0, "width": 245, "x": 68, "y": 22 }], "anchorU": 0.5, "anchorV": 0.5, "className": "TabView", "classType": "dTabView", "height": 0, "width": 0, "x": 0, "y": 0 }], "anchorU": 0, "anchorV": 0, "classType": "dSprite", "height": 0, "width": 0, "x": 0, "y": 0 }; };
    HandIcon.prototype.PlayTouchMove = function (vecPoints, repeatCount) {
        var _this = this;
        if (repeatCount === void 0) { repeatCount = 1; }
        if (vecPoints.length == 0)
            return;
        this.TabView.spriteFrame = 0;
        this.TabView_Image2.visible = this.TabView_Image1.visible = false;
        var actions = new Array();
        actions.push(new CCMoveTo(0, this.imgX, this.imgY));
        actions.push(new CCShow());
        actions.push(new CCCallFunc(function () {
            _this.TabView.spriteFrame = 0;
        }));
        actions.push(new CCDelayTime(0.5));
        actions.push(new CCCallFunc(function () {
            _this.TabView.spriteFrame = 1;
        }));
        actions.push(new CCDelayTime(0.2));
        this.SetPos(vecPoints[0].x, vecPoints[0].y);
        for (var i = 1; i < vecPoints.length; i++)
            actions.push(new CCMoveTo(1, vecPoints[i].x - this.positionX + this.imgX, vecPoints[i].y - this.positionY + this.imgY));
        actions.push(new CCDelayTime(0.5));
        actions.push(new CCHide());
        actions.push(new CCCallFunc(function () {
            for (var i = 0; i < _this.m_vecDot.length; i++)
                _this.m_vecDot[i].RemoveParent();
            _this.m_vecDot.clear();
        }));
        actions.push(new CCDelayTime(0.5));
        if (repeatCount == 1)
            actions.push(new CCRemoveTarget(this));
        CCActionManager.Instance().AddAction(new CCRepeat(new CCSequence(actions), repeatCount), this.TabView_Image2);
        this.PlayAddDot();
    };
    HandIcon.prototype.PlayAddDot = function () {
        var _this = this;
        new dTimer(this).Create(100, 0, function () {
            if (_this.TabView_Image2.visible || _this.TabView_Image1.visible) {
                var dot = new dImage();
                dot.LoadFromFile("data/dot.png");
                dot.spriteColor = 0xff000000;
                dot.SetSize(20, 20);
                dot.SetPos(_this.TabView_Image2.positionX - _this.imgX, _this.TabView_Image2.positionY - _this.imgY);
                _this.AddChild(dot, 0);
                _this.m_vecDot.push(dot);
            }
        }).Apply();
    };
    HandIcon.prototype.PlayClick = function () {
        var _this = this;
        CCActionManager.Instance().AddAction(new CCRepeatForever(new CCSequence([
            new CCDelayTime(0.3),
            new CCCallFunc(function () {
                _this.TabView.spriteFrame = 1;
            }),
            new CCDelayTime(0.3),
            new CCCallFunc(function () {
                _this.TabView.spriteFrame = 0;
            })
        ])), this);
    };
    HandIcon.prototype.PlayDragFood = function (targetX, targetY) {
        var _this = this;
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCDelayTime(0.5),
            new CCCallFunc(function () {
                _this.TabView.spriteFrame = 1;
            }),
            new CCDelayTime(0.2),
            new CCMoveTo(1, targetX, targetY),
            new CCDelayTime(0.2),
            new CCRemoveSelf()
        ]), this);
    };
    return HandIcon;
}(dSprite));
var JsonExcel = (function () {
    function JsonExcel() {
    }
    JsonExcel._LoadFromFile = function (data, cls, fileName, onComplete) {
        var arr = new dByteArray();
        arr.LoadFromFile(fileName, function () {
            var json = JSON.parse(arr.ToStringBuffer());
            for (var i = 0; i < json.data.length; i++) {
                var entry = new cls();
                for (var key in json.data[i]) {
                    if (entry.hasOwnProperty(key)) {
                        var type = typeof (Object(entry)[key]);
                        if (type == "string") {
                            Object(entry)[key] = json.data[i][key];
                        }
                        else if (type == "boolean") {
                            Object(entry)[key] = json.data[i][key] == "true";
                        }
                        else {
                            if (json.data[i][key].charCodeAt(0) == "[".charCodeAt(0) || Object(entry)[key] instanceof Array) {
                                if (Object(entry)[key] instanceof Array && typeof (Object(entry)[key][0]) == "number" ||
                                    Object(entry)[key] instanceof Array && Object(entry)[key][0] instanceof Array && typeof (Object(entry)[key][0][0]) == "number")
                                    Object(entry)[key] = JsonExcel._ToArrayI(json.data[i][key]);
                                else
                                    Object(entry)[key] = JsonExcel._ToArrayS(json.data[i][key]);
                            }
                            else
                                Object(entry)[key] = dMath.ParseFloat(json.data[i][key]);
                        }
                    }
                }
                data.push(entry);
            }
            if (onComplete)
                onComplete(null);
        });
    };
    JsonExcel.SplitArray = function (str) {
        if (str.charCodeAt(0) == "[".charCodeAt(0) && str.charCodeAt(1) == "[".charCodeAt(0)) {
            var ret = new Array();
            var inSquare = 0;
            var s2 = "";
            for (var i = 1; i < str.length - 1; i++) {
                var s = str.charAt(i);
                if (s == "[")
                    inSquare++;
                else if (s == "]")
                    inSquare--;
                if (inSquare == 0 && s == ",") {
                    ret.push(s2);
                    s2 = "";
                }
                else
                    s2 += s;
            }
            if (s2.length)
                ret.push(s2);
            return ret;
        }
        else
            return str.substring(1, str.length - 1).split(",");
    };
    JsonExcel._ToArrayS = function (str) {
        var ret = new Array();
        if (str.charCodeAt(0) == "[".charCodeAt(0)) {
            var split = JsonExcel.SplitArray(str);
            for (var i = 0; i < split.length; i++) {
                if (split[i].charCodeAt(0) == "[".charCodeAt(0))
                    ret.push(JsonExcel._ToArrayS(split[i]));
                else
                    ret.push(split[i]);
            }
        }
        return ret;
    };
    JsonExcel._ToArrayI = function (str) {
        var ret = new Array();
        if (str.charCodeAt(0) == "[".charCodeAt(0)) {
            var split = JsonExcel.SplitArray(str);
            for (var i = 0; i < split.length; i++) {
                if (split[i].charCodeAt(0) == "[".charCodeAt(0))
                    ret.push(JsonExcel._ToArrayI(split[i]));
                else
                    ret.push(Number(split[i]));
            }
        }
        return ret;
    };
    JsonExcel._Query = function (key, value, data, s_mapData) {
        if (!(value instanceof String))
            value = String(value);
        if (!s_mapData.has(key)) {
            var _map = new Map();
            s_mapData.set(key, _map);
            for (var i = 0; i < data.length; i++) {
                _map.set(String(Object(data[i])[key]), data[i]);
            }
        }
        var ret = s_mapData.get(key).get(value);
        if (!ret)
            ret = null;
        return ret;
    };
    return JsonExcel;
}());
var LoginPage = (function (_super) {
    __extends(LoginPage, _super);
    function LoginPage() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        var safeAreaTop = dThread.GetSafeAreaTop();
        if (safeAreaTop > 0) {
            _this.TitleBack.positionY += safeAreaTop;
        }
        _this.SetHandleMouse(true);
        _this.TitleBack_MoreButton.visible = MyAd.hasMoreGame();
        _this.TitleBack_MoreButton_Text.text = MyAd.GetMoreGameText();
        _this.TitleBack_MoreButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            MoreGamePanel.ShowAdMoreGame();
        }));
        _this.TitleBack_SettingButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            PageManager.Instance().OpenPanel(null, new SettingPanel(false));
        }));
        _this.TitleBack_MenuButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            PageManager.Instance().OpenPanel(null, new SelectLevelPanel());
        }));
        _this.StartButton.repeatType = true;
        _this.StartButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dSound.PlaySound("data/sound/button.mp3");
            PageManager.Instance().SubEnergy(function () {
                var stageData = new StageData();
                stageData.stage = SaveData.Instance().passStage + 1;
                PageManager.Instance().ChangePage(GamePage, stageData);
            });
        }));
        return _this;
    }
    LoginPage.prototype._dscData = function () { return { "_child": [{ "anchorU": 0, "anchorV": 0, "className": "Back", "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 993, "resourceFileName": "", "width": 989, "x": 546, "y": 975 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Logo", "classType": "dImage", "height": 336, "resourceFileName": "img/hanzi-bh/loading/loading_logo.png", "width": 1024, "x": 547, "y": 563 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "JianKang", "classType": "dImage", "height": 118, "layoutAlignV": 2, "resourceFileName": "img/hanzi-bh/loading/loading_jiankang.png", "spriteColor": -11331053, "width": 955, "x": 540, "y": 1757 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dWindowRefrance1", "classType": "ShiLingButton", "layoutAlignV": 2, "x": 961, "y": 1612 }, { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 32, "height": 36.5, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "", "width": 64, "x": 0, "y": 60 }], "anchorU": 0.5, "anchorV": 0.5, "className": "SettingButton", "classType": "dButtonScale9", "height": 88, "layoutAlignH": 2, "resourceFileName": "data/setting.png", "width": 92, "x": 441, "y": 114 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 32, "height": 36.5, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "", "width": 64, "x": 0, "y": 60 }], "anchorU": 0.5, "anchorV": 0.5, "className": "MenuButton", "classType": "dButtonScale9", "height": 76, "layoutAlignH": 2, "resourceFileName": "data/menubutton.png", "width": 91, "x": 319, "y": 114 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 32, "height": 37.5, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "", "width": 128, "x": 0, "y": 60 }], "anchorU": 0.5, "anchorV": 0.5, "className": "MoreButton", "classType": "dButton", "height": 85, "layoutAlignH": 2, "resourceFileName": "data/morebutton.png", "width": 127, "x": 177.111023, "y": 114 }], "alpha": 0.392157, "anchorU": 0.5, "anchorV": 0, "className": "TitleBack", "classType": "dImage", "height": 209, "layoutAlignH": 5, "layoutAlignV": 1, "resourceFileName": "", "width": 1080, "x": 540, "y": 0 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 60, "height": 69.375, "resourceFileName": "data/font64.json", "text": "", "width": 240, "x": 0, "y": -7 }], "anchorU": 0.5, "anchorV": 0.5, "className": "StartButton", "classType": "dButtonScale9", "height": 133, "resourceFileName": "data/button1.png", "width": 399, "x": 540, "y": 1336.5 }], "anchorU": 0, "anchorV": 0, "classType": "dSprite", "height": 1920, "width": 1080, "x": 0, "y": 0 }; };
    return LoginPage;
}(BasePage));
var dThread = (function (_super) {
    __extends(dThread, _super);
    function dThread() {
        var _this = _super.call(this) || this;
        _this.m_nFixedRenderWidth = 0;
        _this.m_nFixedRenderHeight = 0;
        _this.m_fTopOffset = 0;
        _this.m_fBottomOffset = 0;
        _this.m_nFixedRanderWidthLimit = 0;
        _this.m_nFixedRanderHeightLimit = 0;
        dInterface.ptr.m_pMainThread = _this;
        _this.m_pRootBackgroudSprite = new dSprite();
        _this.m_pRootSprite = new dSprite();
        _this.m_pRootBackgroudSprite.AddChild(_this.m_pRootSprite);
        return _this;
    }
    dThread.prototype.AddChild = function (pSprite, at) {
        if (at === void 0) { at = -1; }
        this.m_pRootSprite.AddChild(pSprite, at);
    };
    dThread.prototype.SetFixedRenderSize = function (width, height) {
        this.m_nFixedRenderWidth = width;
        this.m_nFixedRenderHeight = height;
        if (this.m_pRootSprite != null && this.m_nFixedRenderWidth != 0 && this.m_nFixedRenderHeight != 0) {
            this.m_pRootSprite.SetSize(this.m_nFixedRenderWidth, this.m_nFixedRenderHeight);
        }
    };
    dThread.GetRootBackgroudSprite = function () {
        if (dInterface.ptr.m_pMainThread)
            return dInterface.ptr.m_pMainThread.m_pRootBackgroudSprite;
        return null;
    };
    dThread.GetRootSprite = function () {
        if (dInterface.ptr.m_pMainThread)
            return dInterface.ptr.m_pMainThread.m_pRootSprite;
        return null;
    };
    dThread.GetWindowWidth = function () {
        if (dThread.GetRootSprite())
            return dThread.GetRootSprite().width;
        return 0;
    };
    dThread.GetWindowHeight = function () {
        if (dThread.GetRootSprite())
            return dThread.GetRootSprite().height;
        return 0;
    };
    dThread.prototype.FrameWindowResize = function (width, height) {
        this._FrameUpdateSize(width, height);
        if (this.m_pRootSprite != null)
            this.OnFrameWindowResize(this.m_pRootSprite.GetWidth(), this.m_pRootSprite.GetHeight());
        else
            this.OnFrameWindowResize(width, height);
    };
    dThread.prototype._FrameUpdateSize = function (width, height) {
        if (this.m_pRootBackgroudSprite != null)
            this.m_pRootBackgroudSprite.SetSize(width, height);
        var root = this.m_pRootSprite;
        var fixedRenderWidth = this.m_nFixedRenderWidth;
        var fixedRenderHeight = this.m_nFixedRenderHeight;
        if (root != null) {
            height -= this.m_fTopOffset + this.m_fBottomOffset;
            root.positionY = this.m_fTopOffset;
            if (fixedRenderWidth == 0 && fixedRenderHeight == 0) {
                root.SetSize(width, height);
                root.SetScale3D(1, 1, 1);
            }
            else if (fixedRenderWidth != 0 && fixedRenderHeight != 0) {
                var fp = width / height;
                if (fp > fixedRenderWidth / fixedRenderHeight) {
                    root.SetSize(fp * fixedRenderHeight, fixedRenderHeight);
                    root.SetScale3D(width / root.width, width / root.width, width / root.width);
                }
                else {
                    root.SetSize(fixedRenderWidth, height / width * fixedRenderWidth);
                    root.SetScale3D(height / root.height, height / root.height, height / root.height);
                }
            }
            else if (fixedRenderWidth != 0) {
                var height2 = height / width * fixedRenderWidth;
                if (this.m_nFixedRanderHeightLimit != 0 && height2 < this.m_nFixedRanderHeightLimit) {
                    var width2 = height / this.m_nFixedRanderHeightLimit * fixedRenderWidth;
                    root.SetSize(fixedRenderWidth, this.m_nFixedRanderHeightLimit);
                    root.SetScale3D(width2 / fixedRenderWidth, width2 / fixedRenderWidth, width2 / fixedRenderWidth);
                    root.positionX = (width - width2) / 2;
                }
                else {
                    root.SetSize(fixedRenderWidth, height2);
                    root.SetScale3D(width / fixedRenderWidth, width / fixedRenderWidth, width / fixedRenderWidth);
                    root.positionX = 0;
                }
            }
            else if (fixedRenderHeight != 0) {
                root.SetSize(width / height * fixedRenderHeight, fixedRenderHeight);
                root.SetScale3D(height / fixedRenderHeight, height / fixedRenderHeight, height / fixedRenderHeight);
            }
        }
    };
    dThread.prototype.OnFrameWindowResize = function (width, height) {
    };
    dThread.prototype.OnFrameTouchEvent = function (type, id, x, y, delta) {
    };
    dThread.prototype.OnFrameActive = function (bActive) {
    };
    dThread.SetAdRewardedLoadingCallback = function (callback) {
    };
    dThread.isWindowActive = function () {
        return dInterface.ptr.m_bWindowActive;
    };
    dThread.OpenWebPage = function (url) {
        dInterface.ptr.OpenWebPage(url);
    };
    dThread.ShowHtmlDialog = function (fileName) {
        dInterface.ptr.ShowHtmlDialog(fileName);
    };
    dThread.ShowMarketplaceDetailTask = function () {
    };
    dThread.GetDeviceInfo = function (arg) {
        return "";
    };
    dThread.GetSdkName = function () {
        return dInterface.ptr.GetSdkName();
    };
    dThread.GetChannelName = function () {
        return dInterface.ptr.GetChannelName();
    };
    dThread.GetUserDeviceId = function () {
        return dInterface.ptr.GetUserDeviceId();
    };
    dThread.GetSafeAreaTop = function () {
        return dInterface.ptr.GetSafeAreaTop() / dThread.GetRootSprite().scaleY;
    };
    dThread.GetSafeAreaBottom = function () {
        return dInterface.ptr.GetSafeAreaBottom() / dThread.GetRootSprite().scaleY;
    };
    dThread.GetPackageVersionCode = function () {
        return dInterface.ptr.GetPackageVersionCode();
    };
    dThread.GetPackageName = function () {
        return dInterface.ptr.GetPackageName();
    };
    dThread.MarketplaceReviewTask = function () {
    };
    return dThread;
}(dObject));
var Main = (function (_super) {
    __extends(Main, _super);
    function Main() {
        var _this = _super.call(this) || this;
        console.log("Main Start");
        dLabel.s_globalFontOffsetY = 0.2;
        dInterface.ptr.SetMultiTouchPointCount(0);
        _this.SetFixedRenderSize(1080, 1920);
        _this.InitUi();
        _this.InitGame();
        return _this;
    }
    Main.prototype.OnFrameActive = function (bActive) {
        _super.prototype.OnFrameActive.call(this, bActive);
    };
    Main.prototype.InitGame = function () {
        var _this = this;
        var pUpdatePanel = new UpdatePanel();
        this.AddChild(pUpdatePanel);
        pUpdatePanel.LayoutToSize(dThread.GetWindowWidth(), dThread.GetWindowHeight());
        pUpdatePanel.OnPrivacyAgree(function () {
            MyAd.InitMyAd(GDefine.MyAppName);
            dInterface.ptr.LoadSubPackage(["data"], function () {
                SaveData.Instance().Load(function () {
                    GameWorld.Perload(function () {
                        pUpdatePanel.OnProgressComplete(function () {
                            var pPageManager = new PageManager();
                            _this.AddChild(pPageManager);
                            PageManager.Instance().SetSize(dThread.GetWindowWidth(), dThread.GetWindowHeight());
                            PageManager.Instance().Init();
                            pUpdatePanel.RemoveParent();
                            SaveData.Instance().UpdateSound();
                            dSound.PlaySound("data/sound/window.mp3");
                            pPageManager.ChangePage(LoginPage, null, null, null, null, false);
                        });
                    });
                });
            });
        });
    };
    Main.prototype.OnFrameWindowResize = function (width, height) {
        if (PageManager.Instance() != null)
            PageManager.Instance().SetSize(width, height);
    };
    Main.prototype.InitUi = function () {
        dControlLoader.SetOnCreateConsole(function (className) {
            switch (className) {
                case "AddKeyPanel": return new AddKeyPanel();
                case "ShiLingButton": return new ShiLingButton();
                case "MyAdBanner": return new MyAdBanner();
                case "LightEff": return new LightEff();
                case "StageBar": return new StageBar();
                case "EnergyBar": return new EnergyBar();
            }
            return null;
        });
    };
    return Main;
}(dThread));
setTimeout(function () {
    dObject.CallInitStatic();
    dInterface.ptr.InitUserDeviceId(function () {
        new Main();
    });
});
var MessageBoxPanel = (function (_super) {
    __extends(MessageBoxPanel, _super);
    function MessageBoxPanel(id, bHasClose, onOk, onClose) {
        if (bHasClose === void 0) { bHasClose = false; }
        if (onOk === void 0) { onOk = null; }
        if (onClose === void 0) { onClose = null; }
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        if (!bHasClose)
            _this.Panel_CloseButton.visible = false;
        _this.Panel_Title_TitleText.text = "";
        _this.Panel_OkButton_Text.text = "";
        if (id == MessageBoxPanel.Type_NotEnouphGold) {
            _this.Panel_Text.text = "";
        }
        else if (id == MessageBoxPanel.Type_NotEnouphGem) {
            _this.Panel_Text.text = "";
        }
        else if (id == MessageBoxPanel.Type_NotEnouphNut) {
            _this.Panel_Text.text = "";
        }
        else if (id == MessageBoxPanel.Type_NotEnouphDiamond) {
            _this.Panel_Text.text = "";
        }
        _this.Panel_OkButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dSound.PlaySound("data/sound/window.mp3");
            PageManager.Instance().ClosePanel(null, _this);
            if (onOk != null)
                onOk(_this);
        }));
        _this.Panel_CloseButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dSound.PlaySound("data/sound/window.mp3");
            PageManager.Instance().ClosePanel(null, _this);
            if (onClose != null)
                onClose(_this);
        }));
        return _this;
    }
    MessageBoxPanel.prototype._dscData = function () { return { "_child": [{ "_child": [{ "align": 0, "anchorU": 0.5, "anchorV": 0.5, "autoWrap": 1, "className": "Text", "classType": "dBitmapFont", "fontSize": 48, "height": 48.75, "resourceFileName": "data/font64.json", "spriteColor": -10592674, "text": "aaa", "width": 762, "x": 0, "y": -62 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 40.625, "resourceFileName": "data/font64.json", "spriteColor": -12632257, "text": "OK", "width": 53.125, "x": 0, "y": -5 }], "anchorU": 0.5, "anchorV": 0.5, "className": "OkButton", "classType": "dButtonScale9", "height": 106, "resourceFileName": "data/button1.png", "width": 279, "x": 0, "y": 217.5 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "TitleText", "classType": "dBitmapFont", "fontSize": 64, "height": 78, "resourceFileName": "data/font64.json", "text": "Tip", "width": 80, "x": 0, "y": -4 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Title", "classType": "dImage", "height": 144, "resourceFileName": "data/title.png", "width": 590, "x": 0, "y": -372.5 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "MyAdPanel", "classType": "MyAdBanner", "height": 300, "width": 944, "x": 0, "y": 742 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton", "classType": "dButton", "height": 98, "resourceFileName": "data/closebutton.png", "width": 98, "x": 441, "y": -371 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Panel", "classType": "dScale9", "height": 800, "resourceFileName": "data/window.png", "width": 944, "x": 540, "y": 936.5 }], "anchorU": 0, "anchorV": 0, "className": "StageClearPanel", "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": 1124073472, "width": 1080, "x": 0, "y": 0 }; };
    MessageBoxPanel.Type_Need2Animals = 1;
    MessageBoxPanel.Type_UnlockWorldMap = 2;
    MessageBoxPanel.Type_NotEnouphGold = 3;
    MessageBoxPanel.Type_NotEnouphGem = 4;
    MessageBoxPanel.Type_NotEnouphNut = 5;
    MessageBoxPanel.Type_NotEnouphDiamond = 6;
    return MessageBoxPanel;
}(dImage));
var MyAdBanner = (function (_super) {
    __extends(MyAdBanner, _super);
    function MyAdBanner() {
        var _this = _super.call(this) || this;
        _this.visible = false;
        if (MyAdBanner.lastCloseBannerTime == -123)
            MyAdBanner.lastCloseBannerTime = -MyAd.GetBannerStepTime();
        new dTimer().Create(50, 0, function (sender) {
            var curTime = dTimer.GetTickCount();
            if (_this.GetParent() != null && _this.GetParent().isShowInRoot()) {
                if (!MyAd.isShowAdBanner() && curTime >= MyAdBanner.lastCloseBannerTime + MyAd.GetBannerStepTime()) {
                    MyAd.ShowAdBanner(true);
                }
            }
            else {
                if (MyAd.isShowAdBanner()) {
                    sender.Stop();
                    MyAdBanner.lastCloseBannerTime = curTime;
                    MyAd.ShowAdBanner(false);
                }
            }
        });
        return _this;
    }
    MyAdBanner.prototype._dscData = function () { return { "anchorU": 0, "anchorV": 0, "classType": "dSprite", "height": 270, "width": 1080, "x": 0, "y": 0 }; };
    MyAdBanner.lastCloseBannerTime = -123;
    return MyAdBanner;
}(dSprite));
var PageManager = (function (_super) {
    __extends(PageManager, _super);
    function PageManager() {
        var _this = _super.call(this) || this;
        _this.m_pCurrentPage = null;
        _this.m_pChangeCover = new dImage();
        _this.m_pBallonLayer = new dSprite();
        _this.m_pHandleMousePanel = null;
        _this.m_pTopLayer = new dSprite();
        _this.m_fAddBallonTime = 60;
        PageManager.s_pInstance = _this;
        _this.m_pChangeCover.SetAnchor(0, 0);
        _this.m_pChangeCover.pureColor = true;
        _this.m_pChangeCover.spriteColor = 0;
        _this.m_pChangeCover.alpha = 1;
        _this.m_pChangeCover.SetHandleMouse(true);
        _this.m_pChangeCover.visible = false;
        _this.AddChild(_this.m_pChangeCover);
        _this.m_pHandleMousePanel = new dImage();
        _this.m_pHandleMousePanel.SetAnchor(0, 0);
        _this.m_pHandleMousePanel.pureColor = true;
        _this.m_pHandleMousePanel.spriteColor = 0;
        _this.m_pHandleMousePanel.alpha = 1;
        _this.m_pHandleMousePanel.SetHandleMouse(true);
        _this.m_pHandleMousePanel.visible = false;
        _this.AddChild(_this.m_pBallonLayer);
        _this.AddChild(_this.m_pTopLayer);
        _this.AddChild(_this.m_pHandleMousePanel);
        return _this;
    }
    PageManager.prototype.Init = function () {
        var _this = this;
        var nowLongTime = dDateTime.NowTime().ToLongTime();
        if (SaveData.Instance().saveTime != 0) {
            var subTime = nowLongTime - SaveData.Instance().saveTime;
            if (subTime > 0) {
                var offlineTime = subTime / 1000;
                this.PassTime(offlineTime);
            }
        }
        new dTimer(this).Create(0, 0, function (sender, iTimer, fTimer) {
            _this.PassTime(fTimer);
        });
        new dTimer(this).Create(1000, 0, function () {
            SaveData.Instance().saveTime = dDateTime.NowTime().ToLongTime();
        }).Apply();
        new dTimer(this).Create(60000, 0, function () {
            SaveData.Instance().WriteToDisk();
        });
        PrivacyDialog.ShowPrivacyDialog();
    };
    PageManager.prototype.PassTime = function (fTimer) {
        if (SaveData.Instance().energy < GDefine.MAX_ENERGY) {
            SaveData.Instance().energyAddTime += fTimer;
            while (SaveData.Instance().energyAddTime > GDefine.ADD_ENERGY_TIME && SaveData.Instance().energy < GDefine.MAX_ENERGY) {
                SaveData.Instance().energyAddTime -= GDefine.ADD_ENERGY_TIME;
                SaveData.Instance().energy++;
                if (PageManager.Instance().GetCurrentPage() != null && PageManager.Instance().GetCurrentPage().GetEnergyBar() != null)
                    PageManager.Instance().GetCurrentPage().GetEnergyBar().Update();
                SaveData.Instance().WriteToDisk();
            }
        }
        else {
            SaveData.Instance().energyAddTime = 0;
        }
    };
    PageManager.prototype.SubEnergy = function (onComplete, bCheckOnly) {
        if (bCheckOnly === void 0) { bCheckOnly = false; }
        if (!GDefine.EnableEnergy) {
            if (onComplete != null)
                onComplete(this);
        }
        else {
            if (SaveData.Instance().energy <= 0) {
                PageManager.Instance().OpenPanel(null, new AddEnergyPanel());
            }
            else {
                if (!bCheckOnly) {
                    SaveData.Instance().energy--;
                    SaveData.Instance().WriteToDisk();
                    this.UpdateCurPage();
                }
                if (onComplete != null)
                    onComplete(this);
            }
        }
    };
    PageManager.prototype.GetTopLayer = function () {
        return this.m_pTopLayer;
    };
    PageManager.prototype.isInTop = function (p) {
        var vec = this.m_pTopLayer.GetChildList();
        if (vec.length > 0 && vec.last() == p)
            return true;
        return false;
    };
    PageManager.Instance = function () {
        return PageManager.s_pInstance;
    };
    PageManager.prototype.ShowTip = function (text) {
        dSound.PlaySound("data/sound/button.mp3");
        var tipBar = new TipBar(text);
        this.m_pTopLayer.AddChild(tipBar);
    };
    PageManager.prototype.OpenPanel = function (HandleMousePanel, panel, onComplete, bAni) {
        if (onComplete === void 0) { onComplete = null; }
        if (bAni === void 0) { bAni = true; }
        if (bAni) {
            _super.prototype.OpenPanel.call(this, this.m_pHandleMousePanel, panel, onComplete);
            this.m_pTopLayer.AddChild(panel);
        }
        else {
            panel.LayoutToSize(this.width, this.height);
            this.m_pTopLayer.AddChild(panel);
        }
    };
    PageManager.prototype.ClosePanel = function (HandleMousePanel, panel, onComplete, bAni) {
        var _this = this;
        if (onComplete === void 0) { onComplete = null; }
        if (bAni === void 0) { bAni = true; }
        if (bAni) {
            _super.prototype.ClosePanel.call(this, this.m_pHandleMousePanel, panel, function () {
                panel.RemoveParent();
                if (onComplete != null)
                    onComplete(_this);
            });
        }
        else {
            panel.RemoveParent();
            panel.Destroy();
            if (onComplete != null)
                onComplete(this);
        }
    };
    PageManager.prototype.ChangeScreenFadeIn = function (onComplete, bPlayAni, isTurnBack) {
        this.m_pChangeCover.SetSize(dThread.GetWindowWidth(), dThread.GetWindowHeight());
        this.m_pChangeCover.visible = true;
        if (bPlayAni && this.m_pCurrentPage != null)
            this.m_pCurrentPage.FadeInOut(false, onComplete, isTurnBack);
        else if (onComplete != null)
            onComplete(this);
    };
    PageManager.prototype.ChangeScreenFadeOut = function (onComplete, bPlayAni, isTurnBack) {
        this.m_pChangeCover.SetSize(dThread.GetWindowWidth(), dThread.GetWindowHeight());
        if (bPlayAni && this.m_pCurrentPage != null)
            this.m_pCurrentPage.FadeInOut(true, onComplete, isTurnBack);
        else if (onComplete != null)
            onComplete(this);
    };
    PageManager.prototype.ChangePage = function (className, arg, onRemove, bPlaySound, onComplete, bPlayAni, bTurnBack) {
        var _this = this;
        if (arg === void 0) { arg = null; }
        if (onRemove === void 0) { onRemove = null; }
        if (bPlaySound === void 0) { bPlaySound = true; }
        if (onComplete === void 0) { onComplete = null; }
        if (bPlayAni === void 0) { bPlayAni = true; }
        if (bTurnBack === void 0) { bTurnBack = false; }
        SaveData.Instance().WriteToDisk();
        this.ChangeScreenFadeIn(function () {
            if (_this.m_pCurrentPage != null && (_this.m_pCurrentPage.isFadeOutRemove() || !bPlayAni)) {
                _this.m_pCurrentPage.Destroy();
                _this.m_pCurrentPage.RemoveParent();
            }
            if (onRemove != null)
                onRemove(_this);
            var pCurrentPage = new className(arg);
            _this.AddChild(pCurrentPage);
            if (_this.m_pCurrentPage != null && !_this.m_pCurrentPage.isFadeOutRemove() && bTurnBack) {
                _this.AddChild(_this.m_pCurrentPage);
            }
            _this.m_pCurrentPage = pCurrentPage;
            _this.AddChild(_this.m_pChangeCover);
            _this.AddChild(_this.m_pBallonLayer);
            _this.AddChild(_this.m_pTopLayer);
            _this.AddChild(_this.m_pHandleMousePanel);
            var width = dThread.GetWindowWidth();
            var height = dThread.GetWindowHeight();
            _this.m_pCurrentPage.LayoutToSize(width, height);
            _this.ChangeScreenFadeOut(function () {
                _this.m_pChangeCover.visible = false;
                _this.m_pCurrentPage.OnFadeFinish();
            }, bPlayAni, bTurnBack);
            if (onComplete != null)
                onComplete(_this.m_pCurrentPage);
        }, bPlayAni, bTurnBack);
    };
    PageManager.prototype.GetCurrentPage = function () {
        return this.m_pCurrentPage;
    };
    PageManager.prototype.UpdateCurPage = function () {
        if (this.m_pCurrentPage != null)
            this.m_pCurrentPage.Update();
    };
    PageManager.prototype.SetSize = function (w, h) {
        _super.prototype.SetSize.call(this, w, h);
        if (this.m_pCurrentPage != null)
            this.m_pCurrentPage.LayoutToSize(w, h);
        if (this.m_pHandleMousePanel != null)
            this.m_pHandleMousePanel.SetSize(w, h);
        if (this.m_pTopLayer != null)
            this.m_pTopLayer.LayoutToSize(w, h);
    };
    PageManager.s_pInstance = null;
    return PageManager;
}(BasePage));
var PrivacyDialog = (function (_super) {
    __extends(PrivacyDialog, _super);
    function PrivacyDialog(showYinSi, showYongHu) {
        if (showYinSi === void 0) { showYinSi = false; }
        if (showYongHu === void 0) { showYongHu = false; }
        var _this = _super.call(this) || this;
        _this.m_bShowYongHu = false;
        _this.m_PrivacyLines = null;
        _this.m_YongHuLines = null;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        _this.Panel2.SetHandleMouse(true);
        _this.Panel2.visible = false;
        _this.Panel_Window_YinSiButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            _this.ShowYinSi();
        }));
        _this.Panel_Window_yongHuButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            _this.ShowYongHu();
        }));
        _this.Panel2_BackButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            if (showYinSi || showYongHu)
                PageManager.Instance().ClosePanel(null, _this, null, false);
            else
                _this.Panel2.visible = false;
        }));
        _this.Panel_Window_YesButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dByteArray.WriteStorage(GDefine.MyAppName + "_privacy_agree_", "1");
            _this.RemoveParent();
        }));
        _this.Panel_Window_NoButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dInterface.ptr.ExitApp();
        }));
        _this.m_PrivacyLines = _this.TextToLines(_this.PrivacyText());
        _this.m_YongHuLines = _this.TextToLines(_this.YongHuText());
        for (var i = 0; i < 40; i++) {
            var bar = new dSprite();
            bar.SetSize(_this.Panel2_ListBox.width, 60);
            var label = new dLabel();
            label.SetAnchor(0, 0);
            label.spriteColor = 0xff000000;
            label.fontSize = 40;
            bar.AddChild(label);
            bar.userData = label;
            _this.Panel2_ListBox.AddChild(bar);
        }
        _this.Panel2_ListBox.SetEvent(new dEvent().SetOnListShowVirtualChild(function (sender, childIndex, virtualIndex) {
            var label = _this.Panel2_ListBox.GetChildListAt(childIndex).userData;
            if (_this.m_bShowYongHu)
                label.text = virtualIndex < _this.m_YongHuLines.length ? _this.m_YongHuLines[virtualIndex] : "";
            else
                label.text = virtualIndex < _this.m_PrivacyLines.length ? _this.m_PrivacyLines[virtualIndex] : "";
        }));
        if (showYinSi)
            _this.ShowYinSi();
        else if (showYongHu)
            _this.ShowYongHu();
        return _this;
    }
    PrivacyDialog.prototype._dscData = function () { return { "_child": [{ "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "autoWrap": 1, "className": "Text", "classType": "dLabel", "fontSize": 36, "height": 432, "spriteColor": -6589434, "text": "\n\n\n\n", "width": 755, "x": 6.5, "y": -2 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 52, "height": 52, "spriteColor": -791858, "text": "", "width": 106, "x": 0, "y": -9 }], "anchorU": 0.5, "anchorV": 0.5, "className": "YesButton", "classType": "dButtonScale9", "height": 114, "resourceFileName": "data/button1.png", "width": 319, "x": 185, "y": 530.210266 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 40, "height": 40, "spriteColor": -791858, "text": "", "width": 82, "x": 0, "y": -5 }], "anchorU": 0.5, "anchorV": 0.5, "className": "NoButton", "classType": "dButtonScale9", "height": 114, "resourceFileName": "data/button1.png", "width": 319, "x": -185.360535, "y": 532.157654 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Title", "classType": "dLabel", "fontSize": 64, "height": 64, "spriteColor": -6927597, "text": "", "width": 260, "x": 0, "y": -321 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -12434878, "text": "", "width": 132, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Line", "classType": "dImage", "height": 3, "pureColor": 1, "spriteColor": -12434878, "width": 150, "x": 0, "y": 21 }], "anchorU": 0.5, "anchorV": 0.5, "className": "YinSiButton", "classType": "dButton", "height": 80, "resourceFileName": "", "width": 220, "x": -142.5, "y": 317 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -12434878, "text": "", "width": 132, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Line", "classType": "dImage", "height": 3, "pureColor": 1, "spriteColor": -12434878, "width": 150, "x": 0, "y": 21 }], "anchorU": 0.5, "anchorV": 0.5, "className": "yongHuButton", "classType": "dButton", "height": 80, "resourceFileName": "", "width": 220, "x": 142, "y": 317 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Window", "classType": "dScale9", "height": 884, "resourceFileName": "data/window.png", "width": 956, "x": 540, "y": 902 }], "anchorU": 0, "anchorV": 0, "className": "Panel", "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -2147483648, "width": 1080, "x": 0, "y": 0 }, { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 10, "pureColor": 1, "rotation": -40, "spriteColor": -16777216, "width": 60, "x": -6, "y": -13 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 10, "pureColor": 1, "rotation": 40, "spriteColor": -16777216, "width": 60, "x": -6, "y": 20 }], "anchorU": 0.5, "anchorV": 0.5, "className": "BackButton", "classType": "dButton", "height": 150, "layoutAlignH": 1, "layoutAlignV": 1, "resourceFileName": "", "width": 150, "x": 113, "y": 148, "z": 3.87344 }, { "anchorU": 0, "anchorV": 0, "canDragH": 0, "canDragV": 1, "className": "ListBox", "classType": "dListBox", "clipChild": 1, "height": 1676, "layoutAlignV": 5, "vertical": 1, "viewPosX": 0, "viewPosY": 0, "width": 1000, "x": 39, "y": 248 }], "anchorU": 0, "anchorV": 0, "className": "Panel2", "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "visible": 0, "width": 1080, "x": 0, "y": 0 }], "anchorU": 0, "anchorV": 0, "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": 2113929216, "width": 1080, "x": 0, "y": 0 }; };
    PrivacyDialog.prototype.ShowYinSi = function () {
        this.Panel2.visible = true;
        this.m_bShowYongHu = false;
        this.Panel2_ListBox.SetVirtualChildCount(this.m_PrivacyLines.length);
        this.Panel2_ListBox.ScrollToTop(false);
        this.Panel2_ListBox.UpdateVirtualChild();
    };
    PrivacyDialog.prototype.ShowYongHu = function () {
        this.Panel2.visible = true;
        this.m_bShowYongHu = true;
        this.Panel2_ListBox.SetVirtualChildCount(this.m_YongHuLines.length);
        this.Panel2_ListBox.ScrollToTop(false);
        this.Panel2_ListBox.UpdateVirtualChild();
    };
    PrivacyDialog.ShowPrivacyDialog = function () {
        if (MyAd.isNeedShowPrivacyDialog()) {
            dByteArray.ReadStorage(GDefine.MyAppName + "_privacy_agree_", function (res) {
                if (res != "1") {
                    PageManager.Instance().OpenPanel(null, new PrivacyDialog(), null, false);
                }
            });
        }
    };
    PrivacyDialog.prototype.TextToLines = function (str) {
        var ret = new Array();
        var split = str.split("\n");
        var textCountPerLine = 25;
        for (var i = 0; i < split.length; i++) {
            var str2 = split[i];
            if (str2.length > textCountPerLine) {
                for (var j = 0; j < str2.length; j += textCountPerLine)
                    ret.push(str2.substring(j, j + textCountPerLine));
            }
            else
                ret.push(str2);
        }
        return ret;
    };
    PrivacyDialog.prototype.PrivacyText = function () {
        var str = "\n" +
            "20211215\n" +
            "20211215\n" +
            (MyAd.isNeedShowPrivacyAppName() ? ("" + GDefine.MyAppName2 + "\n") : "") +
            "\n" +
            "\"\"\"\"\"\")\n" +
            "\n" +
            "\n" +
            ":\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            ":\n" +
            "1.\n" +
            "2.\n" +
            "3.\n" +
            "4.\n" +
            "\n" +
            ":\n" +
            "1.\n" +
            "IMEIWLAN\n" +
            "2.\n" +
            "\n" +
            "3.\n" +
            "\n" +
            "4.\n" +
            "SDK\n" +
            "APP\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "1.;\n" +
            "2.\n" +
            "3.\n" +
            "4.\n" +
            "5.\n" +
            "6.\n" +
            "7.\n" +
            "8.\n" +
            "9.\n" +
            "10.\n" +
            "11.\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "1.\n" +
            "\n" +
            "\n" +
            "2.\n" +
            "1\n" +
            "2\n" +
            "3.\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "1.\n" +
            "2.\n" +
            "3.\n" +
            "4.\n" +
            "5.\n" +
            "6.\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "createmaster@hotmail.com30\n" +
            "createmaster@hotmail.com\n" +
            "\n" +
            "\n" +
            "18\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\n" +
            "\ncreatemaster@hotmail.com\n";
        if (dThread.GetSdkName() == "qq")
            str += "16-1315\n";
        return str;
    };
    PrivacyDialog.prototype.YongHuText = function () {
        return "\n" +
            "\n" +
            "1.\n" +
            "1.1.1818\n" +
            "1.2.\n" +
            "1.3.\n" +
            "1.4.\n" +
            "1.5.\n" +
            "(1)\n" +
            "(2)\n" +
            "(3)\n" +
            "(4)\n" +
            "(5)\n" +
            "(6)\n" +
            "(7)\n" +
            "(8)\n" +
            "(9)\n" +
            "1.6.\n" +
            "1.7.\n" +
            "1.8.\n" +
            "1.9.\n" +
            "1.10.\n" +
            "1.11.\n" +
            "2.\n" +
            "2.1.\n" +
            "2.2.\n" +
            "2.3.\n" +
            "3.\n" +
            "3.1.\n" +
            "3.2.\n" +
            "4.\n" +
            "4.1.\n" +
            "4.2.\n" +
            "1()/();URL;\n" +
            "2;\n" +
            "3()/();\n" +
            "4\n" +
            "5\n" +
            "5.\n" +
            "5.1.\n" +
            "5.2.\n" +
            "5.3.\n" +
            "6.\n" +
            "6.1.\n" +
            "6.2.\n" +
            "7.\n" +
            "7.1.\n" +
            "7.2.60\n" +
            "7.3.\n";
    };
    return PrivacyDialog;
}(dImage));
var SaveData = (function () {
    function SaveData() {
        this.m_nVersion = 0;
        this.enableSound = true;
        this.enableMusic = true;
        this.m_nGold = 0;
        this.passStage = 0;
        this.vip = 0;
        this.energy = 9;
        this.energyAddTime = 0;
        this.saveTime = 0;
        this.gem = 0;
    }
    SaveData.prototype._LoadJson = function (onComplete) {
        dByteArray.ReadStorage(GDefine.MyAppName + "_savedata", onComplete);
    };
    SaveData.prototype.Load = function (onComplete) {
        var _this = this;
        this._LoadJson(function (res) {
            if (res) {
                var json = JSON.parse(res);
                for (var key in _this) {
                    if (json.hasOwnProperty(key)) {
                        var type = typeof (_this[key]);
                        if (type == "string") {
                            _this[key] = String(json[key]);
                        }
                        else if (type == "boolean") {
                            _this[key] = Boolean(json[key]);
                        }
                        else if (type == "number") {
                            _this[key] = dMath.ParseFloat(json[key]);
                        }
                        else
                            _this[key] = json[key];
                    }
                }
                onComplete();
            }
            else
                onComplete();
        });
    };
    SaveData.Instance = function () {
        if (!SaveData.s_pInstance)
            SaveData.s_pInstance = new SaveData();
        return SaveData.s_pInstance;
    };
    SaveData.prototype.UpdateSound = function () {
        if (this.enableSound) {
            dSound.SetGlobalSoundVolume(1);
        }
        else {
            dSound.SetGlobalSoundVolume(0);
        }
        if (this.enableMusic) {
            dSound.SetGlobalMusicVolume(1);
        }
        else {
            dSound.SetGlobalMusicVolume(0);
        }
    };
    SaveData.prototype.WriteToDisk = function () {
        var _this = this;
        if (!SaveData.s_saveTimer) {
            SaveData.s_saveTimer = new dTimer().Create(1000, 1, function () {
                SaveData.s_saveTimer = null;
                var str = JSON.stringify(_this);
                dByteArray.WriteStorage(GDefine.MyAppName + "_savedata", str);
            });
        }
    };
    Object.defineProperty(SaveData.prototype, "gold", {
        get: function () {
            return this.m_nGold;
        },
        set: function (value) {
            this.m_nGold = value;
        },
        enumerable: false,
        configurable: true
    });
    SaveData.s_pInstance = null;
    SaveData.s_saveTimer = null;
    return SaveData;
}());
var dButton = (function (_super) {
    __extends(dButton, _super);
    function dButton() {
        var _this = _super.call(this) || this;
        _this.m_bCheckPixel = false;
        _this.m_bButtonDown = false;
        _this.m_pNormal = null;
        _this.m_pTouchDown = null;
        _this.m_pDisable = null;
        _this.m_fTouchDownX = 0;
        _this.m_fTouchDownY = 0;
        _this.m_bToggle = false;
        _this.m_bToggleDowned = false;
        _this.touchDownScaleMode = true;
        _this.m_bTouchDownScaled = false;
        _this.SetHandleMouse(true);
        return _this;
    }
    dButton.prototype.SetTouchDownScaleMode = function (bScaleMode) {
        this.touchDownScaleMode = bScaleMode;
    };
    Object.defineProperty(dButton.prototype, "resourceFileName", {
        get: function () {
            return this.GetFileName();
        },
        set: function (fileName) {
            this.LoadFromFile(fileName, false);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dButton.prototype, "downImage", {
        get: function () {
            return this.GetTouchDownFileName();
        },
        set: function (fileName) {
            this.LoadTouchDownFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dButton.prototype, "disableImage", {
        get: function () {
            return this.GetDisableFileName();
        },
        set: function (fileName) {
            this.LoadDisableFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dButton.prototype, "toggleMode", {
        get: function () {
            return this.m_bToggle;
        },
        set: function (bSet) {
            this.m_bToggle = bSet;
        },
        enumerable: false,
        configurable: true
    });
    dButton.prototype.SetSize = function (w, h) {
        _super.prototype.SetSize.call(this, w, h);
        if (this.m_pNormal != null)
            this.m_pNormal.SetSize(w, h);
        if (this.m_pTouchDown != null)
            this.m_pTouchDown.SetSize(w, h);
        if (this.m_pDisable != null)
            this.m_pDisable.SetSize(w, h);
    };
    dButton.prototype.SetColor = function (colorARGB, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetColor.call(this, colorARGB, bSetToChild);
        if (!bSetToChild) {
            if (this.m_pNormal != null)
                this.m_pNormal.SetColor(colorARGB);
            if (this.m_pTouchDown != null)
                this.m_pTouchDown.SetColor(colorARGB);
            if (this.m_pDisable != null)
                this.m_pDisable.SetColor(colorARGB);
        }
    };
    dButton.prototype.SetAlpha = function (alpha, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetAlpha.call(this, alpha, bSetToChild);
        if (!bSetToChild) {
            if (this.m_pNormal != null)
                this.m_pNormal.SetAlpha(alpha, false);
            if (this.m_pTouchDown != null)
                this.m_pTouchDown.SetAlpha(alpha, false);
            if (this.m_pDisable != null)
                this.m_pDisable.SetAlpha(alpha, false);
        }
    };
    dButton.prototype.SetGray = function (bGray, bWithChild) {
        if (bGray === void 0) { bGray = true; }
        if (bWithChild === void 0) { bWithChild = false; }
        _super.prototype.SetGray.call(this, bGray, bWithChild);
        if (!bWithChild) {
            if (this.m_pNormal != null)
                this.m_pNormal.SetGray(bGray, bWithChild);
            if (this.m_pTouchDown != null)
                this.m_pTouchDown.SetGray(bGray, bWithChild);
            if (this.m_pDisable != null)
                this.m_pDisable.SetGray(bGray, bWithChild);
        }
    };
    dButton.prototype.CreateImage = function () {
        return new dImage();
    };
    dButton.prototype.SetSizeAsImage = function () {
        if (this.m_pNormal != null && this.m_pNormal.GetBitmapData() != null)
            this.SetSize(this.m_pNormal.GetBitmapData().GetWidth(), this.m_pNormal.GetBitmapData().GetHeight());
    };
    dButton.prototype.LoadFromFile = function (strImage, bAutoResize, onComplete) {
        if (bAutoResize === void 0) { bAutoResize = true; }
        if (onComplete === void 0) { onComplete = null; }
        var a = this;
        if (strImage == null)
            strImage = "";
        if (strImage != null && a.GetFileName() != strImage) {
            if (strImage != "") {
                if (a.m_pNormal == null) {
                    a.m_pNormal = a.CreateImage();
                    a.m_pNormal.spriteColor = a.spriteColor;
                    a.m_pNormal.SetAnchor(a.GetAnchorU(), a.GetAnchorV());
                    a.AddChild(a.m_pNormal, 0);
                }
                var bmp = new dBitmapData();
                bmp.LoadFromFile(strImage, function () {
                    a.m_pNormal.SetBitmapData(bmp);
                    if (bAutoResize) {
                        if (bmp != null && a.GetWidth() == 0 && a.GetHeight() == 0) {
                            a.m_pNormal.SetSize(bmp.GetWidth(), bmp.GetHeight());
                            a.SetSize(a.GetMaxWidth(), a.GetMaxHeight());
                        }
                    }
                    if (onComplete)
                        onComplete(a);
                });
                a.m_pNormal.SetBitmapData(bmp);
                if (!bAutoResize) {
                    a.m_pNormal.SetSize(a.width, a.height);
                }
            }
            else if (a.m_pNormal != null) {
                a.m_pNormal.RemoveParent();
                a.m_pNormal = null;
            }
        }
    };
    dButton.prototype.GetBitmapData = function (at) {
        if (at === void 0) { at = 0; }
        if (this.m_pNormal != null)
            return this.m_pNormal.GetBitmapData(at);
        return _super.prototype.GetBitmapData.call(this, at);
    };
    dButton.prototype.LoadTouchDownFromFile = function (strImage, bAutoResize, onComplete) {
        if (bAutoResize === void 0) { bAutoResize = true; }
        if (onComplete === void 0) { onComplete = null; }
        var a = this;
        if (strImage == null)
            strImage = "";
        if (strImage != null && a.GetTouchDownFileName() != strImage) {
            if (strImage != "") {
                if (a.m_pTouchDown == null) {
                    a.m_pTouchDown = a.CreateImage();
                    a.m_pTouchDown.spriteColor = a.spriteColor;
                    a.m_pTouchDown.SetAnchor(a.GetAnchorU(), a.GetAnchorV());
                    a.AddChild(a.m_pTouchDown, 0);
                }
                var bmp = new dBitmapData();
                bmp.LoadFromFile(strImage, function () {
                    a.m_pTouchDown.SetBitmapData(bmp);
                    if (bAutoResize) {
                        if (bmp != null) {
                            a.m_pTouchDown.SetSize(bmp.GetWidth(), bmp.GetHeight());
                            a.SetSize(a.GetMaxWidth(), a.GetMaxHeight());
                        }
                    }
                    if (onComplete)
                        onComplete(a);
                });
                a.m_pTouchDown.SetBitmapData(bmp);
                if (!bAutoResize) {
                    a.m_pTouchDown.SetSize(this.width, this.height);
                }
                a.m_pTouchDown.visible = false;
            }
            else if (a.m_pTouchDown != null) {
                a.m_pTouchDown.RemoveParent();
                a.m_pTouchDown = null;
            }
        }
    };
    dButton.prototype.LoadDisableFromFile = function (strImage, bAutoResize, onComplete) {
        if (bAutoResize === void 0) { bAutoResize = true; }
        if (onComplete === void 0) { onComplete = null; }
        var a = this;
        if (strImage == null)
            strImage = "";
        if (strImage != null && a.GetDisableFileName() != strImage) {
            if (strImage != "") {
                if (a.m_pDisable == null) {
                    a.m_pDisable = a.CreateImage();
                    a.m_pDisable.spriteColor = a.spriteColor;
                    a.m_pDisable.SetAnchor(a.GetAnchorU(), a.GetAnchorV());
                    a.AddChild(a.m_pDisable, 0);
                }
                var bmp = new dBitmapData();
                bmp.LoadFromFile(strImage, function () {
                    a.m_pDisable.SetBitmapData(bmp);
                    if (bAutoResize) {
                        if (bmp != null) {
                            a.m_pDisable.SetSize(bmp.GetWidth(), bmp.GetHeight());
                            a.SetSize(a.GetMaxWidth(), a.GetMaxHeight());
                        }
                    }
                    if (onComplete)
                        onComplete(a);
                });
                a.m_pDisable.SetBitmapData(bmp);
                if (!bAutoResize) {
                    a.m_pDisable.SetSize(this.width, this.height);
                }
            }
            else if (a.m_pDisable != null) {
                a.m_pDisable.RemoveParent();
                a.m_pDisable = null;
            }
        }
    };
    dButton.prototype.GetMaxWidth = function () {
        var a = this;
        var width = 0;
        if (a.m_pNormal != null && width < a.m_pNormal.width)
            width = a.m_pNormal.width;
        if (a.m_pTouchDown != null && width < a.m_pTouchDown.width)
            width = a.m_pTouchDown.width;
        if (a.m_pDisable != null && width < a.m_pDisable.width)
            width = a.m_pDisable.width;
        return width;
    };
    dButton.prototype.GetMaxHeight = function () {
        var a = this;
        var height = 0;
        if (a.m_pNormal != null && height < a.m_pNormal.height)
            height = a.m_pNormal.height;
        if (a.m_pTouchDown != null && height < a.m_pTouchDown.height)
            height = a.m_pTouchDown.height;
        if (a.m_pDisable != null && height < a.m_pDisable.height)
            height = a.m_pDisable.height;
        return height;
    };
    dButton.prototype.SetAnchor = function (u, v) {
        _super.prototype.SetAnchor.call(this, u, v);
        if (this.m_pNormal != null)
            this.m_pNormal.SetAnchor(u, v);
        if (this.m_pTouchDown != null)
            this.m_pTouchDown.SetAnchor(u, v);
        if (this.m_pDisable != null)
            this.m_pDisable.SetAnchor(u, v);
    };
    dButton.prototype.GetFileName = function () {
        if (this.m_pNormal && this.m_pNormal.GetBitmapData())
            return this.m_pNormal.GetBitmapData().GetResourceFileName();
        return "";
    };
    dButton.prototype.GetTouchDownFileName = function () {
        if (this.m_pTouchDown && this.m_pTouchDown.GetBitmapData())
            return this.m_pTouchDown.GetBitmapData().GetResourceFileName();
        return "";
    };
    dButton.prototype.GetDisableFileName = function () {
        if (this.m_pDisable && this.m_pDisable.GetBitmapData())
            return this.m_pDisable.GetBitmapData().GetResourceFileName();
        return "";
    };
    dButton.prototype.GetTouchDownX = function () {
        return this.m_fTouchDownX;
    };
    dButton.prototype.GetTouchDownY = function () {
        return this.m_fTouchDownY;
    };
    dButton.prototype.OnTouchDown = function (x, y, delta) {
        var a = this;
        if (a.isEnable()) {
            a.m_fTouchDownX = x;
            a.m_fTouchDownY = y;
            a.m_bButtonDown = true;
            if (a.m_pTouchDown == null) {
                if (a.touchDownScaleMode) {
                    if (!a.m_bTouchDownScaled) {
                        a.m_bTouchDownScaled = true;
                        a.SetScale(a.scaleX * 0.95, a.scaleY * 0.95);
                    }
                }
            }
            else {
                if (a.m_bToggle) {
                    a.m_bToggleDowned = !a.m_bToggleDowned;
                    if (a.m_pTouchDown)
                        a.m_pTouchDown.SetShow(a.m_bToggleDowned);
                    if (a.m_pNormal)
                        a.m_pNormal.SetShow(!a.m_bToggleDowned);
                }
                else {
                    if (a.m_pTouchDown)
                        a.m_pTouchDown.SetShow(true);
                    if (a.m_pNormal)
                        a.m_pNormal.SetShow(false);
                }
            }
            if (a.m_pEvent != null)
                a.m_pEvent.OnButtonDown(this);
        }
    };
    dButton.prototype.OnTouchUp = function (x, y) {
        var a = this;
        a.m_bButtonDown = false;
        if (a.m_pTouchDown != null && !a.m_bToggle) {
            this.m_pTouchDown.SetShow(false);
            this.m_pNormal.SetShow(true);
        }
        else {
            if (a.touchDownScaleMode) {
                if (a.m_bTouchDownScaled) {
                    a.m_bTouchDownScaled = false;
                    a.SetScale(a.scaleX / 0.95, a.scaleY / 0.95);
                }
            }
        }
        if (a.isEnable() && a.m_pEvent != null) {
            a.m_pEvent.OnButtonUp(this);
        }
    };
    dButton.prototype.SetButtonDown = function (bDown) {
        var a = this;
        if (a.m_bToggle) {
            a.m_bToggleDowned = bDown;
            if (a.m_pTouchDown != null)
                a.m_pTouchDown.SetShow(a.m_bToggleDowned);
            if (a.m_pNormal)
                a.m_pNormal.SetShow(!a.m_bToggleDowned);
        }
    };
    dButton.prototype.isButtonDown = function () {
        var a = this;
        if (a.m_bToggle)
            return a.m_bToggleDowned;
        return a.m_bButtonDown;
    };
    dButton.prototype.SetColorTransform = function (mat, bWithChild) {
        if (bWithChild === void 0) { bWithChild = false; }
        _super.prototype.SetColorTransform.call(this, mat, bWithChild);
        if (!bWithChild) {
            if (this.m_pDisable != null)
                this.m_pDisable.SetColorTransform(mat);
            if (this.m_pNormal != null)
                this.m_pNormal.SetColorTransform(mat);
            if (this.m_pTouchDown != null)
                this.m_pTouchDown.SetColorTransform(mat);
        }
    };
    dButton.prototype.SetEnable = function (b) {
        _super.prototype.SetEnable.call(this, b);
        if (this.m_pDisable != null)
            this.m_pDisable.SetShow(!b);
        if (this.m_pNormal != null)
            this.m_pNormal.SetShow(b || this.m_pDisable == null);
        if (this.m_pTouchDown != null)
            this.m_pTouchDown.SetShow(false);
    };
    dButton.prototype.LoadFromJson = function (j) {
        _super.prototype.LoadFromJson.call(this, j);
        if (j.hasOwnProperty("resourceFileName"))
            this.resourceFileName = j.resourceFileName;
        if (j.hasOwnProperty("downImage"))
            this.downImage = j.downImage;
        if (j.hasOwnProperty("disableImage"))
            this.disableImage = j.disableImage;
        if (j.hasOwnProperty("toggleMode"))
            this.toggleMode = Boolean(dMath.ParseInt(j.toggleMode));
    };
    dButton.prototype.GetNormalImage = function () {
        return this.m_pNormal;
    };
    return dButton;
}(dBaseControl));
var ShiLingButton = (function (_super) {
    __extends(ShiLingButton, _super);
    function ShiLingButton() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.visible = MyAd.isNeedShowShiLing();
        _this.SetEvent(new dEvent().SetOnButtonDown(function () {
            var panel = new dImage();
            panel.SetAnchor(0, 0);
            panel.SetHandleMouse(true);
            panel.SetSize(1080, 1920);
            panel.pureColor = true;
            panel.spriteColor = 0x80000000;
            var image2 = new dImage();
            image2.LoadFromFile("img/hanzi-bh/loading/loading_8plustext.png");
            image2.SetPos(540, 955);
            panel.AddChild(image2);
            var pTouchEvent = new dSprite();
            pTouchEvent.OnTouchDown = function (x, y, delta) {
                panel.RemoveParent();
            };
            panel.SetTouchEvent(pTouchEvent);
            new dTimer(panel).Create(0, 0, function () {
                if (panel.GetParent() != null)
                    dThread.GetRootSprite().AddChild(panel);
            });
            dThread.GetRootSprite().AddChild(panel);
            panel.LayoutToSize(dThread.GetWindowWidth(), dThread.GetWindowHeight());
        }));
        return _this;
    }
    ShiLingButton.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 552, "resourceFileName": "img/hanzi-bh/loading/loading_8plus.png", "scaleX": 0.3, "scaleY": 0.3, "width": 432, "x": 0, "y": 0 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dButton", "height": 165, "resourceFileName": "", "width": 129, "x": 0, "y": 0 }; };
    return ShiLingButton;
}(dButton));
var TipBar = (function (_super) {
    __extends(TipBar, _super);
    function TipBar(text) {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.Text.text = text;
        _this.SetPos(PageManager.Instance().width / 2, PageManager.Instance().height / 2);
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCEaseBackOut(new CCMoveBy(0.5, 0, -150)),
            new CCDelayTime(0.8),
            new CCSpawn([
                new CCMoveBy(0.5, 0, -100),
                new CCFadeOut(0.5)
            ]),
            new CCRemoveSelf()
        ]), _this);
        return _this;
    }
    TipBar.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontFace": "", "fontSize": 40, "height": 40, "text": "", "width": 1, "x": 1, "y": -3 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 90, "resourceFileName": "data/tip.png", "width": 985, "x": 0, "y": 0 }; };
    return TipBar;
}(dImage));
var UpdatePanel = (function (_super) {
    __extends(UpdatePanel, _super);
    function UpdatePanel() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        dSound.StopMusic();
        _this.m_complateCallback = new dCompleteCallback(_this);
        _this.JianKang_Zhuzuo.visible = MyAd.isNeedShowZhuZuo();
        _this.JianKang_Zhuzuo_Text1.text = MyAd.GetZhuZuoName(GDefine.MyAppName);
        new dTimer(_this).Create(0, 0, function () {
            if (dThread.GetWindowWidth() != _this.width || dThread.GetWindowHeight() != _this.height) {
                _this.LayoutToSize(dThread.GetWindowWidth(), dThread.GetWindowHeight());
            }
        });
        _this.visible = false;
        dBitmapData.SetGlobalImageLoadComplete(function () {
            _this.visible = true;
        });
        return _this;
    }
    UpdatePanel.prototype._dscData = function () { return { "_child": [{ "anchorU": 0, "anchorV": 0, "className": "Back", "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Logo", "classType": "dImage", "height": 336, "resourceFileName": "img/hanzi-bh/loading/loading_logo.png", "width": 1024, "x": 547, "y": 563 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "ProBk", "classType": "dScale9", "height": 37, "resourceFileName": "img/hanzi-bh/loading/loading_progress2.png", "spriteColor": -16777216, "width": 702, "x": 540, "y": 1426 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Progress", "classType": "dProgress", "height": 28, "resourceFileName": "img/hanzi-bh/loading/loading_progress1.png", "scale9Type": 1, "spriteColor": -18631, "width": 694, "x": 540, "y": 1426 }, { "_child": [{ "_child": [{ "anchorU": 0, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 32, "height": 33.333336, "resourceFileName": "img/hanzi-bh/loading/loadingfont64.json", "spriteColor": -11331053, "text": "2023SR0786691", "width": 230, "x": 216, "y": -5 }, { "anchorU": 0, "anchorV": 0.5, "className": "Text1", "classType": "dBitmapFont", "fontSize": 28, "height": 32.083332, "resourceFileName": "img/hanzi-bh/loading/loadingfont64.json", "spriteColor": -11331053, "text": "", "width": 84, "x": -286, "y": -1 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Zhuzuo", "classType": "dImage", "height": 29, "resourceFileName": "img/hanzi-bh/loading/loading_zhuzuo.png", "spriteColor": -11331053, "width": 847, "x": 0, "y": 104 }], "anchorU": 0.5, "anchorV": 0.5, "className": "JianKang", "classType": "dImage", "height": 118, "layoutAlignV": 2, "resourceFileName": "img/hanzi-bh/loading/loading_jiankang.png", "spriteColor": -11331053, "width": 955, "x": 540, "y": 1757 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Percent", "classType": "dBitmapFont", "fontSize": 48, "height": 49, "resourceFileName": "img/hanzi-bh/loading/loadingfont64.json", "spriteColor": -11331053, "text": "0%", "width": 63, "x": 540, "y": 1472 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dWindowRefrance1", "classType": "ShiLingButton", "layoutAlignV": 2, "x": 961, "y": 1612 }], "anchorU": 0, "anchorV": 0, "classType": "dSprite", "height": 1920, "width": 1080, "x": 0, "y": 0 }; };
    UpdatePanel.prototype.Start = function () {
        var _this = this;
        this.m_complateCallback.Add();
        new dTimer(this).Create(10, 101, function (sender, iTimer, fTimer) {
            _this.Progress.SetValueAndMax(iTimer, 100);
            _this.Percent.text = iTimer + "%";
            if (sender.isLastRepeat()) {
                new dTimer(_this).Create(500, 1, function () {
                    _this.m_complateCallback.DoComplete();
                });
            }
        }).Apply();
    };
    UpdatePanel.prototype.OnPrivacyAgree = function (onComplete) {
        var _this = this;
        this.Progress.SetValueAndMax(0, 100);
        this.Percent.text = "0%";
        new dTimer().Create(0, 0, function (sender) {
            if (dInterface.ptr.isPrivacyAgree()) {
                _this.Start();
                sender.Stop();
                onComplete(_this);
            }
        });
    };
    UpdatePanel.prototype.OnProgressComplete = function (onComplete) {
        this.m_complateCallback.SetCompleteFun(onComplete);
    };
    return UpdatePanel;
}(dImage));
var XmlLoader = (function () {
    function XmlLoader() {
        this.m_strName = "";
        this.m_mapAttribute = new Map();
        this.m_strData = "";
        this.m_vecChild = new Array();
        this.m_pFather = null;
        this.m_vecComment = null;
        this.m_mapHeader = null;
    }
    Object.defineProperty(XmlLoader.prototype, "child", {
        get: function () {
            return this.m_vecChild;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(XmlLoader.prototype, "name", {
        get: function () {
            return this.m_strName;
        },
        enumerable: false,
        configurable: true
    });
    XmlLoader.prototype.PaserToWord = function (str) {
        var ret = new Array();
        var start = -1;
        var end = -1;
        var bYinHaoSingle = false;
        var bYinHaoDouble = false;
        var nArrowBrance = 0;
        var bInComment = false;
        for (var i = 0, n = str.length; i < n; i++) {
            var s2 = str.charCodeAt(i);
            if (s2 == '<'.charCodeAt(0)) {
                if (str.charCodeAt(i + 1) == '!'.charCodeAt(0) && str.charCodeAt(i + 2) == '['.charCodeAt(0) &&
                    str.charCodeAt(i + 3) == 'C'.charCodeAt(0) &&
                    str.charCodeAt(i + 4) == 'D'.charCodeAt(0) &&
                    str.charCodeAt(i + 5) == 'A'.charCodeAt(0) &&
                    str.charCodeAt(i + 6) == 'T'.charCodeAt(0) &&
                    str.charCodeAt(i + 7) == 'A'.charCodeAt(0) &&
                    str.charCodeAt(i + 8) == '['.charCodeAt(0)) {
                    var s = "";
                    for (var j = i + 9; j < n; j++) {
                        var s3 = str.charAt(j);
                        if (s3 == "]" && str.charCodeAt(j + 1) == ']'.charCodeAt(0) && str.charCodeAt(j + 2) == '>'.charCodeAt(0)) {
                            i = j + 2;
                            break;
                        }
                        else
                            s += s3;
                    }
                    ret.push(s);
                    continue;
                }
                else
                    nArrowBrance++;
            }
            if (!bYinHaoSingle && !bYinHaoDouble && !bInComment && nArrowBrance != 0) {
                if (s2 == '\''.charCodeAt(0))
                    bYinHaoSingle = true;
                else if (s2 == '"'.charCodeAt(0))
                    bYinHaoDouble = true;
                else if (s2 == '<'.charCodeAt(0) || s2 == '>'.charCodeAt(0) || s2 == '='.charCodeAt(0) || s2 == ' '.charCodeAt(0) || s2 == '\t'.charCodeAt(0) || s2 == '?'.charCodeAt(0) || s2 == '\r'.charCodeAt(0) || s2 == '\n'.charCodeAt(0) ||
                    s2 == ','.charCodeAt(0) || s2 == '['.charCodeAt(0) || s2 == ']'.charCodeAt(0) || s2 == '{'.charCodeAt(0) || s2 == '}'.charCodeAt(0) ||
                    s2 == '/'.charCodeAt(0) && str.charCodeAt(i + 1) == '>'.charCodeAt(0)) {
                    var s3 = str.charAt(i);
                    var s = null;
                    if (start != -1 && end != -1)
                        ret.push(s = str.substring(start, end));
                    if (s2 != ' '.charCodeAt(0) && s2 != '\t'.charCodeAt(0) && s2 != '\n'.charCodeAt(0) && s2 != '\r'.charCodeAt(0))
                        ret.push(s3);
                    if (s == "!--")
                        bInComment = true;
                    start = end = -1;
                }
                else {
                    if (start == -1)
                        start = i;
                    end = i + 1;
                }
            }
            else {
                if (bYinHaoSingle && s2 == '\''.charCodeAt(0)) {
                    bYinHaoSingle = false;
                    ret.push(str.substring(start, end));
                    start = end = -1;
                }
                else if (bYinHaoDouble && s2 == '"'.charCodeAt(0)) {
                    bYinHaoDouble = false;
                    ret.push(str.substring(start, end));
                    start = end = -1;
                }
                else if (bInComment && s2 == ' '.charCodeAt(0) && str.charCodeAt(i + 1) == '-'.charCodeAt(0) && str.charCodeAt(i + 2) == '-'.charCodeAt(0) && str.charCodeAt(i + 3) == '>'.charCodeAt(0)) {
                    ret.push(str.substring(start, end));
                    start = end = -1;
                    bInComment = false;
                }
                else if (s2 != '\n'.charCodeAt(0) && s2 != '\r'.charCodeAt(0)) {
                    if (start == -1)
                        start = i;
                    end = i + 1;
                }
            }
            if (s2 == '>'.charCodeAt(0))
                nArrowBrance--;
        }
        return ret;
    };
    XmlLoader.prototype.PaserFromWord = function (pDest, vecWord, start, strEndName) {
        var nextnext = null;
        while (start < vecWord.length && vecWord[start++] == "<") {
            var next = vecWord[start++];
            if (strEndName != null && strEndName == next) {
                start -= 2;
                break;
            }
            var xml = new XmlLoader();
            xml.m_strName = next;
            next = vecWord[start++];
            var strEnd = null;
            if (xml.m_strName == "?")
                strEnd = "?";
            else if (xml.m_strName == "!--")
                strEnd = "--";
            else
                strEnd = "/" + xml.m_strName;
            if (next == ">") {
                while (start < vecWord.length) {
                    next = vecWord[start++];
                    if (next == "<") {
                        if (vecWord[start] == strEnd) {
                            start += 2;
                            break;
                        }
                        else {
                            start = this.PaserFromWord(xml, vecWord, start - 1, strEnd);
                        }
                    }
                    else if (vecWord[start] == "=") {
                        xml.m_mapAttribute.set(next, this.TransFromXmlValue(vecWord[start + 1]));
                        start += 2;
                    }
                    else
                        xml.m_strData = next;
                }
            }
            else {
                start--;
                while (start < vecWord.length) {
                    next = vecWord[start++];
                    if (start < vecWord.length)
                        nextnext = vecWord[start];
                    else
                        nextnext = "";
                    if (xml.m_strName == "!--") {
                        if (next == "--" && next == strEnd && nextnext == ">") {
                            start++;
                            break;
                        }
                        else
                            xml.m_strData = next;
                    }
                    else {
                        if (next == "<") {
                            if (vecWord[start] == strEnd) {
                                start += 2;
                                break;
                            }
                            else {
                                start = this.PaserFromWord(xml, vecWord, start - 1, strEnd);
                            }
                        }
                        else if ((next == "/" || next == "?" && next == strEnd) && nextnext == ">") {
                            start++;
                            break;
                        }
                        else if (next != ">") {
                            if (vecWord[start] == "=") {
                                xml.m_mapAttribute.set(next, this.TransFromXmlValue(vecWord[start + 1]));
                                start += 2;
                            }
                            else
                                xml.m_strData = next;
                        }
                        else if (start < vecWord.length - 1 && vecWord[start] == "<")
                            xml.m_strData = "";
                    }
                }
            }
            if (xml.m_strName == "?")
                this.m_mapHeader = xml.m_mapAttribute;
            else if (xml.m_strName == "!--") {
                if (pDest.m_vecComment == null)
                    pDest.m_vecComment = new Array();
                pDest.m_vecComment.push(xml.m_strData);
            }
            else
                pDest.AddChild(xml);
        }
        return start;
    };
    XmlLoader.prototype.TransFromXmlValue = function (str) {
        str = dStringUtils.ReplaceAll(str, "\\n", "\n");
        str = dStringUtils.ReplaceAll(str, "\\r", "\r");
        str = dStringUtils.ReplaceAll(str, "&amp;", "&");
        str = dStringUtils.ReplaceAll(str, "&quot;", "\"");
        str = dStringUtils.ReplaceAll(str, "&lt;", "<");
        str = dStringUtils.ReplaceAll(str, "&gt;", ">");
        return str;
    };
    XmlLoader.prototype.AddChild = function (data) {
        if (data != null) {
            data.m_pFather = this;
            this.m_vecChild.push(data);
        }
        return data;
    };
    XmlLoader.prototype.FromString = function (str) {
        var vecWord = this.PaserToWord(str);
        this.PaserFromWord(this, vecWord, 0, null);
        return this;
    };
    return XmlLoader;
}());
var CanDrag = (function () {
    function CanDrag(target) {
        var _this = this;
        this.m_target = null;
        this.m_dragStartPos = new dVector2();
        this.m_startPos = new dVector2();
        this.isTouchUpSetOrgPos = false;
        this.canDragOutsideScreen = false;
        this.touchUpShowWrong = false;
        this.onTouchUp = null;
        this.onTouchUps = new Array();
        this.onTouchDown = null;
        this.onDrag = null;
        this.canDragH = true;
        this.canDragV = true;
        this.isTouchMoved = false;
        this.dragLimitLengthH = null;
        this.dragLimitLengthV = null;
        this.curTouchMovePos = new dVector2();
        this.onLongTouch = null;
        this.m_longTouchTimer = null;
        this.m_touchMoveAdd = new dVector2();
        this.enable = true;
        this.onDoubleClick = null;
        this.lastClickTime = -10000;
        this.touchDownMakeToTop = true;
        this.touchDownPlaySound = null;
        this.touchUpPlaySound = null;
        this.m_target = target;
        this.m_startPos.SetValue(this.m_target.positionX, this.m_target.positionY);
        target.SetHandleMouse(true);
        target.OnTouchMove = function (x, y, offx, offy, delta) {
            if (!_this.enable)
                return;
            if (_this.m_longTouchTimer && _this.m_touchMoveAdd.Length() > 10) {
                _this.m_longTouchTimer.Restart();
            }
            _this.curTouchMovePos.SetValue(x, y);
            offx *= target.scaleX;
            offy *= target.scaleY;
            _this.m_touchMoveAdd.x += offx;
            _this.m_touchMoveAdd.y += offy;
            _this.isTouchMoved = true;
            if (_this.canDragH)
                target.positionX += offx;
            if (_this.canDragV)
                target.positionY += offy;
            var offx2 = 0;
            var offy2 = 0;
            if (_this.dragLimitLengthH) {
                if (target.positionX < _this.m_startPos.x + _this.dragLimitLengthH.x)
                    target.positionX = _this.m_startPos.x + _this.dragLimitLengthH.x;
                else if (target.positionX > _this.m_startPos.x + _this.dragLimitLengthH.y)
                    target.positionX = _this.m_startPos.x + _this.dragLimitLengthH.y;
            }
            if (_this.dragLimitLengthV) {
                if (target.positionY < _this.m_startPos.y + _this.dragLimitLengthV.x)
                    target.positionY = _this.m_startPos.y + _this.dragLimitLengthV.x;
                else if (target.positionY > _this.m_startPos.y + _this.dragLimitLengthV.y)
                    target.positionY = _this.m_startPos.y + _this.dragLimitLengthV.y;
            }
            if (!_this.canDragOutsideScreen) {
                var parnet = target.GetParent();
                if (target.width > parnet.width) {
                    if (target.positionX < parnet.width * 0.5 - target.width * target.anchorU)
                        target.positionX = parnet.width * 0.5 - target.width * target.anchorU;
                    else if (target.positionX > -parnet.width * 0.5 + target.width * target.anchorU)
                        target.positionX = -parnet.width * 0.5 + target.width * target.anchorU;
                }
                else {
                    if (target.positionX < -parnet.width * 0.5 + target.width * target.anchorU * target.scaleX + offx2)
                        target.positionX = -parnet.width * 0.5 + target.width * target.anchorU * target.scaleX + offx2;
                    else if (target.positionX > parnet.width * 0.5 - target.width * target.anchorU * target.scaleX + offx2)
                        target.positionX = parnet.width * 0.5 - target.width * target.anchorU * target.scaleX + offx2;
                }
                var yOff = 0;
                if (target.height > parnet.height) {
                    if (target.positionY < parnet.height * 0.5 - target.height * target.anchorV)
                        target.positionY = parnet.height * 0.5 - target.height * target.anchorV;
                    else if (target.positionY > -parnet.height * 0.5 + target.height * target.anchorV)
                        target.positionY = -parnet.height * 0.5 + target.height * target.anchorV;
                }
                else {
                    if (target.positionY < -parnet.height * 0.5 - yOff + target.height * target.anchorV * target.scaleY + offy2)
                        target.positionY = -parnet.height * 0.5 - yOff + target.height * target.anchorV * target.scaleY + offy2;
                    else if (target.positionY > parnet.height * 0.5 - yOff - target.height * target.anchorV * target.scaleY + offy2)
                        target.positionY = parnet.height * 0.5 - yOff - target.height * target.anchorV * target.scaleY + offy2;
                }
            }
            if (_this.onDrag)
                _this.onDrag(_this);
        };
        if (target instanceof dButton) {
            target.SetEvent(new dEvent().SetOnButtonUp(function () {
                if (_this.onTouchUp)
                    _this.onTouchUp(_this);
                for (var i = 0; i < _this.onTouchUps.length; i++)
                    _this.onTouchUps[i](_this);
                if (_this.isTouchUpSetOrgPos)
                    target.SetPos(_this.m_startPos.x, _this.m_startPos.y);
                _this.isTouchMoved = false;
            }));
        }
        else {
            target.OnTouchDown = function (x, y) {
                if (_this.onTouchDown)
                    _this.onTouchDown(_this);
                if (_this.touchDownMakeToTop)
                    target.GetParent().AddChild(target);
                if (_this.touchDownPlaySound)
                    dSound.PlaySound(_this.touchDownPlaySound);
                _this.m_touchMoveAdd.SetValue(0, 0);
                _this.m_dragStartPos.SetValue(target.positionX, target.positionY);
                if (_this.onLongTouch) {
                    _this.m_longTouchTimer = new dTimer(target).Create(500, 1, function () {
                        if (_this.onLongTouch)
                            _this.onLongTouch(_this);
                        _this.m_longTouchTimer = null;
                    });
                }
                var time = dTimer.GetTickCount();
                if (time - _this.lastClickTime < 500) {
                    if (_this.onDoubleClick)
                        _this.onDoubleClick(_this);
                }
                _this.lastClickTime = time;
            };
            target.OnTouchUp = function (x, y) {
                if (_this.m_longTouchTimer) {
                    _this.m_longTouchTimer.Stop();
                    _this.m_longTouchTimer = null;
                }
                if (_this.touchUpPlaySound)
                    dSound.PlaySound(_this.touchUpPlaySound);
                if (_this.onTouchUp)
                    _this.onTouchUp(_this);
                for (var i = 0; i < _this.onTouchUps.length; i++)
                    _this.onTouchUps[i](_this);
                if (_this.isTouchUpSetOrgPos)
                    target.SetPos(_this.m_startPos.x, _this.m_startPos.y);
                _this.isTouchMoved = false;
            };
        }
    }
    CanDrag.prototype.GetDragOffset = function () {
        return new dVector2(this.m_target.positionX - this.m_startPos.x, this.m_target.positionY - this.m_startPos.y);
    };
    return CanDrag;
}());
var CanRotation = (function () {
    function CanRotation(target) {
        var _this = this;
        this.m_target = null;
        this.enable = true;
        this.onDrag = null;
        this.onTouchUp = null;
        this.isTouchUpSetOrgPos = false;
        this.touchUpShowWrong = false;
        this.isTouchMoved = false;
        this.onTouchDown = null;
        this.m_touchDownAngle = 0;
        this.m_touchDownAngle2 = 0;
        this.m_angleStep = 0;
        this.m_target = target;
        target.SetHandleMouse(true);
        target.OnTouchMove = function (x, y, offx, offy, delta) {
            if (!_this.enable)
                return;
            _this.isTouchMoved = true;
            var dir = new dVector2(x, y);
            dir.Normalize();
            target.rotation = dir.ToAngle() + _this.m_touchDownAngle - _this.m_touchDownAngle2;
            target.rotation %= 360;
            while (target.rotation < 0)
                target.rotation += 360;
            if (_this.onDrag)
                _this.onDrag(_this);
        };
        if (target instanceof dButton) {
            target.SetEvent(new dEvent().SetOnButtonUp(function () {
                if (!_this.enable)
                    return;
                if (_this.onTouchUp)
                    _this.onTouchUp(_this);
                if (_this.isTouchUpSetOrgPos)
                    target.SetRotation(0);
                _this.isTouchMoved = false;
            }));
        }
        else {
            target.OnTouchDown = function (x, y) {
                if (!_this.enable)
                    return;
                _this.m_touchDownAngle = target.rotation;
                var dir = new dVector2(x, y);
                dir.Normalize();
                _this.m_touchDownAngle2 = dir.ToAngle();
                if (_this.onTouchDown)
                    _this.onTouchDown(_this);
            };
            target.OnTouchUp = function (x, y) {
                if (!_this.enable)
                    return;
                if (_this.m_angleStep != 0) {
                    var angle = target.rotation;
                    while (angle < 0)
                        angle += 360;
                    if (angle > 180)
                        angle = angle - 360;
                    angle = dMath.Floor((angle + _this.m_angleStep / 2) / _this.m_angleStep);
                    angle *= _this.m_angleStep;
                    angle += 360;
                    angle %= 360;
                    target.rotation = angle;
                }
                if (_this.onTouchUp)
                    _this.onTouchUp(_this);
                if (_this.isTouchUpSetOrgPos)
                    target.SetRotation(0);
                _this.isTouchMoved = false;
            };
        }
    }
    return CanRotation;
}());
var GameWorld = (function (_super) {
    __extends(GameWorld, _super);
    function GameWorld(stageData) {
        var _this = _super.call(this) || this;
        _this.m_stageData = null;
        _this.m_bGameClear = false;
        _this.m_bGameOver = false;
        _this.m_vecSubRights = new Array();
        _this.m_arrHinted = new Map();
        _this.m_blankShowSmoke = true;
        _this.m_bHinted = false;
        _this.m_levelBase = null;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        MyShareRecording.Instance().StartRecord();
        _this.m_stageData = stageData;
        _this.m_stageData.stage = ((_this.m_stageData.stage - 1) % StageData.GetMaxStage()) + 1;
        var safeAreaTop = dThread.GetSafeAreaTop();
        if (safeAreaTop > 0) {
            _this.TitleBack.positionY += safeAreaTop;
            _this.GameLayer.positionY += safeAreaTop / 2;
        }
        _this.SetHandleMouse(true);
        _this.GameLayer.SetTransparentMouse(true);
        _this.ClearHandleMouse.SetHandleMouse(true);
        _this.ClearHandleMouse.visible = false;
        _this.TitleBack_MoreButton.visible = MyAd.hasMoreGame();
        _this.TitleBack_MoreButton_Text.text = MyAd.GetMoreGameText();
        _this.TitleBack_MoreButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            MoreGamePanel.ShowAdMoreGame();
        }));
        _this.TitleBack_SettingButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            PageManager.Instance().OpenPanel(null, new SettingPanel(true));
        }));
        _this.TitleBack_HintButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dSound.PlaySound("data/sound/button.mp3");
            PageManager.Instance().UpdateCurPage();
            PageManager.Instance().OpenPanel(null, new HintPanel(_this.m_stageData.stage, _this));
        }));
        _this.TitleBack_MenuButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dSound.PlaySound("data/sound/button.mp3");
            PageManager.Instance().OpenPanel(null, new SelectLevelPanel());
        }));
        _this.TitleBack_BackButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dSound.PlaySound("data/sound/button.mp3");
            PageManager.Instance().ChangePage(LoginPage, null);
        }));
        _this.TitleBack_StageText.text = "" + stageData.stage + "";
        _this.m_stageData.stageEntry = StageData.GetStageEntryFromIndex(_this.m_stageData.stage - 1);
        _this.TitleBack_TimePanel.visible = false;
        _this.TitleBack_QuestName_Text.text = _this.m_stageData.stageEntry.type;
        if (stageData.stageEntry.type == "") {
            _this.m_levelBase = new LevelTianyibi();
        }
        else if (stageData.stageEntry.type == "") {
            _this.m_levelBase = new LevelYiyibi();
        }
        else if (stageData.stageEntry.type == "" || stageData.stageEntry.type == "") {
            _this.m_levelBase = new LevelPinhanzi();
        }
        else if (stageData.stageEntry.type == "") {
            _this.m_levelBase = new LevelCaizimi();
        }
        else if (stageData.stageEntry.type == "") {
            _this.m_levelBase = new LevelChengyu();
        }
        else if (stageData.stageEntry.type == "") {
            _this.m_levelBase = new LevelYibushou();
        }
        else if (stageData.stageEntry.type == "") {
            _this.m_levelBase = new LevelZhaobutong();
        }
        _this.m_levelBase.Init(_this);
        _this.GameLayer.AddChild(_this.m_levelBase);
        return _this;
    }
    GameWorld.prototype._dscData = function () { return { "_child": [{ "anchorU": 0, "anchorV": 0, "className": "Back", "classType": "dImage", "clipChild": 1, "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "GameLayer", "classType": "dScale9", "height": 1920, "resourceFileName": "", "width": 1080, "x": 540, "y": 960 }, { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 32, "height": 36.5, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "", "width": 64, "x": 0, "y": 60 }], "anchorU": 0.5, "anchorV": 0.5, "className": "SettingButton", "classType": "dButtonScale9", "height": 88, "layoutAlignH": 2, "resourceFileName": "data/setting.png", "width": 92, "x": 458, "y": 109 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 32, "height": 37.5, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "", "width": 128, "x": 0, "y": 60 }], "anchorU": 0.5, "anchorV": 0.5, "className": "MoreButton", "classType": "dButton", "height": 85, "layoutAlignH": 2, "resourceFileName": "data/morebutton.png", "width": 127, "x": 197.111023, "y": 109 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "HintButton", "classType": "dButtonScale9", "height": 104, "layoutAlignH": 1, "layoutAlignV": 2, "resourceFileName": "data/hintbutton.png", "width": 245, "x": -253.5, "y": 109 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 32, "height": 36.5, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "", "width": 64, "x": 0, "y": 60 }], "anchorU": 0.5, "anchorV": 0.5, "className": "MenuButton", "classType": "dButtonScale9", "height": 76, "layoutAlignH": 2, "resourceFileName": "data/menubutton.png", "width": 91, "x": 332, "y": 109 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "StageText", "classType": "dBitmapFont", "fontSize": 60, "height": 70.3125, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "1", "width": 150.9375, "x": 0, "y": 126 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "BackButton", "classType": "dButtonScale9", "height": 119, "layoutAlignH": 1, "resourceFileName": "data/backbutton.png", "scaleX": 0.9, "scaleY": 0.9, "width": 119.951996, "x": -452.023987, "y": 109 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 20, "resourceFileName": "data/dot.png", "spriteColor": -8604753, "width": 20, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 48, "height": 56.25, "resourceFileName": "data/font64.json", "spriteColor": -8604753, "text": "", "width": 288, "x": 15, "y": -2 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 20, "resourceFileName": "data/dot.png", "spriteColor": -8604753, "width": 20, "x": -5, "y": 0 }], "alignType": 0, "anchorU": 0.5, "anchorV": 0.5, "className": "QuestName", "classType": "dLayoutHBox", "height": 64, "space": 10, "width": 369, "x": 3, "y": 228 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 48, "height": 56.25, "resourceFileName": "data/font64.json", "spriteColor": -8604753, "text": ":", "width": 105.75, "x": -33.5, "y": -2 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Time", "classType": "dBitmapFont", "fontSize": 48, "height": 54, "resourceFileName": "data/font64.json", "spriteColor": -4630710, "text": "60", "width": 57, "x": 0, "y": -2 }], "alignType": 0, "anchorU": 0.5, "anchorV": 0.5, "className": "TimePanel", "classType": "dLayoutHBox", "height": 64, "space": 10, "width": 369, "x": 336, "y": 228 }], "alpha": 0.392157, "anchorU": 0.5, "anchorV": 0, "className": "TitleBack", "classType": "dImage", "height": 209, "layoutAlignH": 5, "layoutAlignV": 1, "resourceFileName": "", "width": 1080, "x": 540, "y": 0 }, { "anchorU": 0, "anchorV": 0, "className": "ClearHandleMouse", "classType": "dSprite", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "visible": 0, "width": 1080, "x": 0, "y": 0 }], "anchorU": 0, "anchorV": 0, "classType": "dSprite", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "width": 1080, "x": 0, "y": 0 }; };
    GameWorld.prototype.Destroy = function () {
        _super.prototype.Destroy.call(this);
        this.m_levelBase.Destroy();
    };
    GameWorld.prototype.SetSize = function (w, h) {
        _super.prototype.SetSize.call(this, w, h);
    };
    GameWorld.prototype.GetStageData = function () {
        return this.m_stageData;
    };
    GameWorld.prototype.GetLevelBase = function () {
        return this.m_levelBase;
    };
    GameWorld.prototype.ShowClear = function (delay, isSkipEff, playSound) {
        var _this = this;
        if (delay === void 0) { delay = 0; }
        if (isSkipEff === void 0) { isSkipEff = false; }
        if (playSound === void 0) { playSound = true; }
        this.ClearHandleMouse.visible = true;
        this.m_bGameClear = true;
        if (playSound)
            dSound.PlaySound("data/sound/right.mp3");
        new dTimer(this).Create(delay, 1, function () {
            if (isSkipEff)
                _this.OnStageClear(0);
            else {
                var pStageClearEff = new StageClearEff(function () {
                    _this.OnStageClear(0);
                });
                pStageClearEff.LayoutToSize(_this.width, _this.height);
                var pColorfulEffect = new ColorfulEffect(1);
                _this.AddChild(pColorfulEffect);
                pColorfulEffect.SetPos(pStageClearEff.ClearText.positionX, pStageClearEff.ClearText.positionY);
                _this.AddChild(pStageClearEff);
            }
        });
    };
    GameWorld.prototype.OnStageClear = function (delay) {
        var _this = this;
        if (delay === void 0) { delay = 1000; }
        this.ClearHandleMouse.visible = true;
        this.m_bGameClear = true;
        new dTimer(this).Create(delay, 1, function () {
            dSound.PlaySound("data/sound/window.mp3");
            PageManager.Instance().OpenPanel(null, new StageClearPanel(_this.m_stageData));
        });
    };
    GameWorld.prototype.isGameClear = function () {
        return this.m_bGameClear;
    };
    GameWorld.prototype.ShowRight = function (pos, target) {
        if (target === void 0) { target = null; }
        if (target) {
            pos = new dVector2(target.GetPosX_World(this, false), target.GetPosY_World(this, false));
        }
        dSound.PlaySound("data/sound/right.mp3");
        var image = new dImage();
        image.LoadFromFile("data/right.png");
        image.SetScale(0, 0);
        image.SetPos(pos.x, pos.y);
        image.SetTransparentMouse(true);
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCScaleTo(0.2, 1, 1),
            new CCScaleTo(0.2, 0.8, 0.8),
        ]), image);
        this.AddChild(image);
    };
    GameWorld.prototype.ShowRightSub = function (pos, target) {
        if (target === void 0) { target = null; }
        if (target) {
            pos = new dVector2(target.GetPosX_World(this, false), target.GetPosY_World(this, false));
        }
        dSound.PlaySound("data/sound/right.mp3");
        var image = new dImage();
        image.LoadFromFile("data/right.png");
        image.SetScale(0, 0);
        image.SetPos(pos.x, pos.y);
        image.SetTransparentMouse(true);
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCScaleTo(0.2, 0.7, 0.7),
            new CCScaleTo(0.2, 0.5, 0.5),
        ]), image);
        this.AddChild(image);
        this.m_vecSubRights.push(image);
    };
    GameWorld.prototype.GetRightSubCount = function () {
        return this.m_vecSubRights.length;
    };
    GameWorld.prototype.ClearSubRights = function () {
        for (var i = 0; i < this.m_vecSubRights.length; i++)
            this.m_vecSubRights[i].RemoveParent();
        this.m_vecSubRights.clear();
    };
    GameWorld.prototype.GetSubRights = function () {
        return this.m_vecSubRights;
    };
    GameWorld.prototype.SetBlockMouse = function (bBlock) {
        if (bBlock === void 0) { bBlock = true; }
        this.ClearHandleMouse.visible = bBlock;
    };
    GameWorld.prototype.isBlockMouse = function () {
        return this.ClearHandleMouse.visible;
    };
    GameWorld.Perload = function (onComplete) {
        var callback = new dCompleteCallback(null);
        dBitmapFont.PreLoadBuffer("data/font64.json", callback.CreateCompleteFun_Normal());
        dBitmapFont.PreLoadBuffer("data/font2.json", callback.CreateCompleteFun_Normal());
        dBitmapFont.PreLoadBuffer("data/font200.json", callback.CreateCompleteFun_Normal());
        StageEntry.LoadFromFile("data/configs/StageEntry.json", callback.CreateCompleteFun_Normal());
        callback.SetCompleteFun(onComplete);
    };
    return GameWorld;
}(dSprite));
var StageData = (function () {
    function StageData() {
        this.stage = 0;
        this.stageEntry = null;
    }
    StageData.GetStageEntryFromIndex = function (index) {
        index %= StageData.GetMaxStage();
        return StageEntry.Query("id", StageData.StageIndex[index]);
    };
    StageData.GetMaxStage = function () {
        return StageData.StageIndex.length;
    };
    StageData.StageIndex = [
        1,
        201,
        101,
        501,
        2,
        102,
        301,
        3,
        103,
        401,
        601,
        701,
        302,
        4,
        5,
        202,
        203,
        104,
        502,
        503,
        6,
        7,
        303,
        602,
        702,
        204,
        402,
        403,
        205,
        8,
        504,
        505,
        105,
        703,
        704,
        304,
        404,
        405,
        9,
        10,
        206,
        207,
        705,
        11,
        106,
        506,
        507,
        406,
        407,
        603,
        12,
        13,
        706,
        305,
        208,
        209,
        408,
        409,
        508,
        509,
        14,
        604,
        107,
        108,
        707,
        708,
        210,
        211,
        15,
        16,
        605,
        410,
        411,
        306,
        212,
        213,
        709,
        17,
        18,
        307,
        510,
        511,
        606,
        214,
        215,
        710,
        19,
        216,
        217,
        607,
        308,
        109,
        110,
        711,
        20,
        21,
        608,
        712,
        218,
        219,
        22,
        23,
        220,
        24,
        713,
    ];
    return StageData;
}());
var SceneItemEffect = (function (_super) {
    __extends(SceneItemEffect, _super);
    function SceneItemEffect() {
        var _this = _super.call(this) || this;
        new dTimer(_this).Create(1000, 0, function () {
            new dTimer(_this).Create(200, 3, function () {
                var star = new dImage();
                star.SetTransparentMouse(true);
                star.LoadFromFile("data/star.png");
                _this.AddChild(star);
                star.SetScale(0, 0);
                if (_this.GetParent()) {
                    var w = _this.GetParent().width * 0.5;
                    var h = _this.GetParent().height * 0.5;
                    star.SetPos(dMath.RandomRange(-w, w), dMath.RandomRange(-h, h));
                }
                var scaleTo = 1;
                if (_this.GetParent())
                    scaleTo = 1 / _this.GetParent().scaleX;
                CCActionManager.Instance().AddAction(new CCSequence([
                    new CCScaleTo(0.2, scaleTo, scaleTo),
                    new CCScaleTo(0.2, 0, 0),
                    new CCRemoveSelf()
                ]), star);
            });
        }).Apply();
        return _this;
    }
    return SceneItemEffect;
}(dSprite));
var StageClearEff = (function (_super) {
    __extends(StageClearEff, _super);
    function StageClearEff(onComplete) {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCDelayTime(1.5),
            new CCCallFunc(onComplete),
            new CCRemoveSelf()
        ]), _this);
        return _this;
    }
    StageClearEff.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "ClearText", "classType": "dBitmapFont", "fontEdgeColor": -16777216, "fontSize": 128, "height": 148, "resourceFileName": "data/font64.json", "spriteColor": -40379, "text": "", "width": 256, "x": 540, "y": 693 }], "anchorU": 0, "anchorV": 0, "classType": "dSprite", "height": 1920, "width": 1080, "x": 0, "y": 0 }; };
    return StageClearEff;
}(dSprite));
var StageEntry = (function () {
    function StageEntry() {
        this.id = 0;
        this.type = "";
        this.quest = [""];
        this.answer = [""];
        this.data = [[""]];
    }
    StageEntry.LoadFromFile = function (fileName, onComplete) {
        return JsonExcel._LoadFromFile(StageEntry.s_data, StageEntry, fileName, onComplete);
    };
    StageEntry.Query = function (tab, value) {
        return JsonExcel._Query(tab, value, StageEntry.s_data, StageEntry.s_mapData);
    };
    StageEntry.GetData = function () {
        return StageEntry.s_data;
    };
    StageEntry.s_data = new Array();
    StageEntry.s_mapData = new Map();
    return StageEntry;
}());
var LevelBase = (function (_super) {
    __extends(LevelBase, _super);
    function LevelBase() {
        var _this = _super.call(this) || this;
        _this.m_pGameWorld = null;
        _this.m_lastPlayFrictionSound = 0;
        return _this;
    }
    LevelBase.prototype.Init = function (pGameWorld) {
        var vec = new Array();
        vec.copy(this.GetChildList());
        this.m_pGameWorld = pGameWorld;
    };
    LevelBase.prototype.GetHintText = function () {
        return this.m_pGameWorld.GetStageData().stageEntry.answer.join(",");
    };
    LevelBase.prototype.GetHintImage = function () {
        return null;
    };
    LevelBase.prototype.ClearSceneItemEffect = function (pSprite) {
        var vec = pSprite.GetChildList();
        for (var i = 0; i < vec.length; i++) {
            if (vec[i] instanceof SceneItemEffect) {
                vec[i].RemoveParent();
                i--;
            }
        }
    };
    LevelBase.prototype.GetUpColor = function () {
        return 0xff000000;
    };
    LevelBase.prototype.GetDownColor = function () {
        return 0xff000000;
    };
    LevelBase.prototype.OnUseItem = function (id, x, y) {
        return 0;
    };
    LevelBase.prototype.ShowItemEffect = function (target, isShow) {
        if (isShow) {
            var list = target.GetChildList();
            for (var i = 0; i < list.length; i++)
                if (list[i] instanceof SceneItemEffect)
                    return;
            target.AddChild(new SceneItemEffect());
        }
        else {
            var list = target.GetChildList();
            for (var i = 0; i < list.length; i++) {
                if (list[i] instanceof SceneItemEffect) {
                    list[i].RemoveParent();
                    return;
                }
            }
        }
    };
    LevelBase.prototype.isPointInSprite = function (p1, x, y) {
        var rc1 = new dRect().SetPosSize(p1.GetPosX_World(this.m_pGameWorld, false) - p1.width * p1.scaleX * p1.anchorU, p1.GetPosY_World(this.m_pGameWorld, false) - p1.height * p1.scaleY * p1.anchorV, p1.width * p1.scaleX, p1.height * p1.scaleY);
        return rc1.CollectPoint(x, y);
    };
    LevelBase.prototype.isCollectSprite = function (p1, p2) {
        var rc1 = new dRect().SetPosSize(p1.GetPosX_World(this.m_pGameWorld, false) - p1.width * p1.scaleX * p1.anchorU, p1.GetPosY_World(this.m_pGameWorld, false) - p1.height * p1.scaleY * p1.anchorV, p1.width * p1.scaleX, p1.height * p1.scaleY);
        var rc2 = new dRect().SetPosSize(p2.GetPosX_World(this.m_pGameWorld, false) - p2.width * p2.scaleX * p2.anchorU, p2.GetPosY_World(this.m_pGameWorld, false) - p2.height * p2.scaleY * p2.anchorV, p2.width * p2.scaleX, p2.height * p2.scaleY);
        var ret = rc1.Collect(rc2);
        return ret;
    };
    LevelBase.prototype.isCollectCircle = function (p1, circle, radio) {
        var rc1 = new dRect().SetPosSize(p1.GetPosX_World(this.m_pGameWorld, false) - p1.width * p1.scaleX * p1.anchorU, p1.GetPosY_World(this.m_pGameWorld, false) - p1.height * p1.scaleY * p1.anchorV, p1.width * p1.scaleX, p1.height * p1.scaleY);
        var x = circle.GetPosX_World(this.m_pGameWorld, false);
        var y = circle.GetPosY_World(this.m_pGameWorld, false);
        var ret = rc1.CollectCircle(x, y, radio);
        return ret;
    };
    LevelBase.prototype.isCollectCircleWithRotation = function (p1, circle, radio) {
        var rc1 = new dRect().SetPosSize(-p1.width * p1.anchorU, -p1.height * p1.anchorV, p1.width, p1.height);
        var m = p1.GetMatrixWorld(this.m_pGameWorld, false);
        var a1 = new dVector2(rc1.left, rc1.top);
        var a2 = new dVector2(rc1.right, rc1.bottom);
        var a3 = new dVector2(rc1.left, rc1.bottom);
        var a4 = new dVector2(rc1.right, rc1.top);
        a1.Transform(m);
        a2.Transform(m);
        a3.Transform(m);
        a4.Transform(m);
        var x = circle.GetPosX_World(this.m_pGameWorld, false);
        var y = circle.GetPosY_World(this.m_pGameWorld, false);
        var c = new dVector2(x, y);
        return dMath.TriangleCircleCollect2D(a1, a2, a3, c, radio) || dMath.TriangleCircleCollect2D(a2, a1, a4, c, radio);
    };
    LevelBase.prototype.isCollectCircleCircle = function (p1, p2, radio) {
        if (radio === void 0) { radio = 0; }
        if (radio == 0)
            radio = p1.width * 0.5 + p2.width * 0.5;
        if (p1.GetPosVector2().LengthTo(p2.GetPosVector2()) < radio)
            return true;
        return false;
    };
    LevelBase.prototype.PlayFrictionSound = function () {
        var tick = dTimer.GetTickCount();
        if (tick > this.m_lastPlayFrictionSound + 200) {
            dSound.PlaySound("data/sound/friction.mp3");
            this.m_lastPlayFrictionSound = tick;
        }
    };
    LevelBase.prototype.PlayDrawSound = function () {
        var tick = dTimer.GetTickCount();
        if (tick > this.m_lastPlayFrictionSound + 200) {
            dSound.PlaySound("data/sound/draw.mp3");
            this.m_lastPlayFrictionSound = tick;
        }
    };
    LevelBase.prototype.OnPassWordRight = function (delay, playSound) {
        if (delay === void 0) { delay = 0; }
        if (playSound === void 0) { playSound = true; }
        this.m_pGameWorld.ShowClear(delay, false, playSound);
    };
    LevelBase.prototype.OnShowHint = function () {
    };
    return LevelBase;
}(dImage));
var LevelAniPassword = (function (_super) {
    __extends(LevelAniPassword, _super);
    function LevelAniPassword() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    LevelAniPassword.prototype.Init2 = function (buttons, anis, rightPass) {
        var _this = this;
        for (var i = 0; i < buttons.length; i++) {
            var fun = function (i) {
                buttons[i].SetTouchDownScaleMode(false);
                buttons[i].SetEvent(new dEvent().SetOnButtonDown(function () {
                    dSound.PlaySound("data/sound/button.mp3");
                    var num = anis[i].spriteFrame;
                    num++;
                    num %= anis[i].GetMaxFrame();
                    anis[i].spriteFrame = num;
                    _this.CheckClear2(anis, rightPass);
                }));
            };
            fun(i);
        }
    };
    LevelAniPassword.prototype.CheckClear2 = function (anis, rightPass) {
        var str = "";
        for (var i = 0; i < anis.length; i++)
            str += anis[i].spriteFrame;
        if (str == rightPass) {
            this.OnPassWordRight();
        }
    };
    return LevelAniPassword;
}(LevelBase));
var LevelPinTu = (function (_super) {
    __extends(LevelPinTu, _super);
    function LevelPinTu() {
        var _this = _super.call(this) || this;
        _this.m_cards = null;
        _this.m_blocks = null;
        return _this;
    }
    LevelPinTu.prototype.Init2 = function (cards, rights) {
        var _this = this;
        this.m_cards = cards;
        this.m_blocks = rights;
        for (var i = 0; i < this.m_cards.length; i++) {
            this.m_cards[i].userData = {};
            var canDrag = this.m_cards[i].userData["CanDrag"] = new CanDrag(this.m_cards[i]);
            canDrag.canDragOutsideScreen = true;
            this.m_cards[i].userData["Num"] = i;
            this.m_cards[i].userData["StartPos"] = this.m_cards[i].GetPosVector2();
            var fun = function (i) {
                _this.m_cards[i].userData["CanDrag"].onTouchDown = function () {
                    _this.m_cards[i].GetParent().AddChild(_this.m_cards[i]);
                };
                _this.m_cards[i].userData["CanDrag"].onTouchUp = function (canDrag) {
                    var block = _this.FindNearBlock(_this.m_cards[i]);
                    if (block != null) {
                        var oldCard = _this.FindCardByPos(block.GetPosX_World(_this, false), block.GetPosY_World(_this, false));
                        if (oldCard)
                            oldCard.SetPosVector2(oldCard.userData["StartPos"]);
                        dSound.PlaySound("data/sound/button.mp3");
                        _this.m_cards[i].SetPos(block.GetPosX_World(_this, false) - _this.m_cards[i].GetParent().GetPosX_World(_this, false), block.GetPosY_World(_this, false) - _this.m_cards[i].GetParent().GetPosY_World(_this, false));
                        _this.CheckClear(_this.m_cards[i]);
                    }
                    else {
                        _this.m_cards[i].SetPosVector2(_this.m_cards[i].userData["StartPos"]);
                    }
                };
            };
            fun(i);
        }
    };
    LevelPinTu.prototype.CheckClear = function (p) {
        for (var i = 0; i < this.m_blocks.length; i++) {
            var card = this.FindCardByPos(this.m_blocks[i].GetPosX_World(this, false), this.m_blocks[i].GetPosY_World(this, false));
            if (card) {
                if (card.userData["Num"] == i)
                    continue;
            }
            return;
        }
        this.OnPassWordRight();
    };
    LevelPinTu.prototype.FindNearBlock = function (card) {
        var block = null;
        var len = 0;
        for (var i = 0; i < this.m_blocks.length; i++) {
            var len2 = this.m_blocks[i].GetPos_World(this, false).LengthTo(card.GetPos_World(this, false));
            if (block == null || len2 < len) {
                len = len2;
                block = this.m_blocks[i];
            }
        }
        if (this.isCollectSprite(block, card))
            return block;
        return null;
    };
    LevelPinTu.prototype.FindCardByPos = function (x, y) {
        for (var i = 0; i < this.m_cards.length; i++) {
            if (dMath.FloatEquals(this.m_cards[i].positionX, x - this.m_cards[i].GetParent().GetPosX_World(this, false), 1) &&
                dMath.FloatEquals(this.m_cards[i].positionY, y - this.m_cards[i].GetParent().GetPosY_World(this, false), 1))
                return this.m_cards[i];
        }
        return null;
    };
    return LevelPinTu;
}(LevelBase));
var LevelCaizimi = (function (_super) {
    __extends(LevelCaizimi, _super);
    function LevelCaizimi() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        return _this;
    }
    LevelCaizimi.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Back", "classType": "dImage", "clipChild": 1, "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "alignType": 0, "anchorU": 0.5, "anchorV": 0.5, "className": "LayoutVBox", "classType": "dLayoutVBox", "height": 1000, "space": 10, "width": 1000, "x": 0, "y": 114 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "width": 1080, "x": 0, "y": 0 }; };
    LevelCaizimi.prototype.Init = function (pGameWorld) {
        _super.prototype.Init.call(this, pGameWorld);
        var stageEntry = pGameWorld.GetStageData().stageEntry;
        var answerBox = new LevelCaizimiAnswerBox();
        var destBlock = new Array();
        for (var i = 0; i < stageEntry.data.length; i++) {
            var pQuest = new LevelCaizimiQuest();
            pQuest.SetText(stageEntry.data[i][0]);
            this.LayoutVBox.AddChild(pQuest);
            destBlock.push(pQuest.QuestBlock);
        }
        var blockText = new Array();
        blockText.pushVector(stageEntry.answer);
        blockText.pushVector(stageEntry.quest);
        answerBox.AddTexts(blockText);
        this.LayoutVBox.AddChild(answerBox);
        this.Init2(answerBox.GetBlocks(), destBlock);
    };
    LevelCaizimi.prototype.GetHintImage = function () {
        var label = new dBitmapFont();
        label.LoadFromFile("data/font2.json");
        label.fontSize = 64;
        label.spriteColor = 0xff000000;
        label.text = this.GetHintText();
        return label;
    };
    return LevelCaizimi;
}(LevelPinTu));
var LevelCaizimiAnswerBox = (function (_super) {
    __extends(LevelCaizimiAnswerBox, _super);
    function LevelCaizimiAnswerBox() {
        var _this = _super.call(this) || this;
        _this.m_vecBlocks = new Array();
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    LevelCaizimiAnswerBox.prototype._dscData = function () { return { "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 430, "width": 1000, "x": 0, "y": 0 }; };
    LevelCaizimiAnswerBox.prototype.AddText = function (str) {
        var block = new LevelCaizimiBlock();
        block.Text.text = str;
        this.AddChild(block);
        this.m_vecBlocks.push(block);
        this.UpdatePos();
    };
    LevelCaizimiAnswerBox.prototype.AddTexts = function (str) {
        for (var i = 0; i < str.length; i++) {
            var block = new LevelCaizimiBlock();
            block.Text.text = str[i];
            this.AddChild(block);
            this.m_vecBlocks.push(block);
        }
        this.UpdatePos();
    };
    LevelCaizimiAnswerBox.prototype.GetBlocks = function () {
        return this.m_vecBlocks;
    };
    LevelCaizimiAnswerBox.prototype.UpdatePos = function () {
        var vecBlocks = new Array();
        vecBlocks.copy(this.m_vecBlocks);
        vecBlocks.randomSort();
        var totalWidth = 0;
        var space = 10;
        for (var i = 0; i < vecBlocks.length; i++)
            totalWidth += vecBlocks[i].width + space;
        totalWidth -= space;
        var lineCount = 1;
        while (totalWidth / lineCount > this.width) {
            lineCount++;
        }
        totalWidth /= lineCount;
        var x = 0;
        var y = 0;
        var maxHeight = 0;
        var thisLineWidth = 0;
        var thisLineCount = 0;
        for (var i = 0; i < vecBlocks.length; i++) {
            vecBlocks[i].SetPos(x + vecBlocks[i].width * vecBlocks[i].anchorU, y + vecBlocks[i].height * vecBlocks[i].anchorV);
            x += vecBlocks[i].width + space;
            thisLineWidth += vecBlocks[i].width + space;
            thisLineCount++;
            if (maxHeight < vecBlocks[i].height)
                maxHeight = vecBlocks[i].height;
            if (x > totalWidth) {
                for (var j = 0; j < thisLineCount; j++)
                    vecBlocks[i - j].positionX -= thisLineWidth / 2;
                x = 0;
                if (i < vecBlocks.length - 1) {
                    y += maxHeight + space;
                    maxHeight = 0;
                }
                thisLineWidth = 0;
                thisLineCount = 0;
            }
        }
        y += maxHeight;
        for (var j = 0; j < thisLineCount; j++)
            vecBlocks[i - j - 1].positionX -= thisLineWidth / 2;
        for (var i = 0; i < vecBlocks.length; i++)
            vecBlocks[i].positionY -= y / 2;
        this.height = y;
    };
    return LevelCaizimiAnswerBox;
}(dSprite));
var dScale9 = (function (_super) {
    __extends(dScale9, _super);
    function dScale9() {
        var _this = _super.call(this) || this;
        _this.m_vecImage = new Array(9);
        _this.m_rcBitmapRect = null;
        _this.m_bRepeatType = false;
        _this.m_vertices = null;
        _this.m_indices = null;
        _this.m_nVerticesLength = 0;
        _this.m_nIndicesLength = 0;
        _this.m_bNeedComputeRenderBatch = false;
        _this.m_matBuffer = new dMatrix();
        _this.m_bNeedUpdateSize = false;
        for (var i = 0; i < _this.m_vecImage.length; i++) {
            _this.m_vecImage[i] = new ImageObj();
        }
        _this.m_bForceRender = true;
        _this.SetMeshData(dSpriteDefaultShader.Instance().m_pStreamMeshData);
        return _this;
    }
    Object.defineProperty(dScale9.prototype, "repeatType", {
        get: function () {
            return this.isRepeatType();
        },
        set: function (bRepeatType) {
            this.SetRepeatMode(bRepeatType);
        },
        enumerable: false,
        configurable: true
    });
    dScale9.prototype.LoadFromFile = function (strImage, onLoadComplete, bAutoResize, rc) {
        var _this = this;
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (bAutoResize === void 0) { bAutoResize = true; }
        if (rc === void 0) { rc = null; }
        var a = this;
        if (strImage != null) {
            if (strImage != "") {
                var bmp = new dBitmapData();
                a.SetBitmapData(bmp, rc);
                bmp.LoadFromFile(strImage, function () {
                    if (bAutoResize && a.GetWidth() == 0 && a.GetHeight() == 0)
                        a.SetSize(bmp.GetWidth(), bmp.GetHeight());
                    _this.m_bNeedUpdateSize = true;
                    if (onLoadComplete)
                        onLoadComplete(a);
                });
            }
            else if (a.GetBitmapData() != null) {
                a.SetBitmapData(null);
            }
        }
        return this;
    };
    dScale9.prototype.SetBitmapData = function (bmp, rc, at, sampleType) {
        if (rc === void 0) { rc = null; }
        if (at === void 0) { at = 0; }
        if (sampleType === void 0) { sampleType = 0; }
        if (at == 0) {
            if (this.m_pImageBitmapData != bmp) {
                _super.prototype.SetBitmapData.call(this, bmp);
                this.m_bNeedUpdateSize = true;
            }
        }
        else
            _super.prototype.SetBitmapData.call(this, bmp, rc, at, sampleType);
    };
    dScale9.prototype.GetBitmapData = function (at) {
        if (at === void 0) { at = 0; }
        if (at == 0)
            return this.m_pImageBitmapData;
        return _super.prototype.GetBitmapData.call(this, at);
    };
    dScale9.prototype.isRepeatType = function () {
        return this.m_bRepeatType;
    };
    dScale9.prototype.SetRepeatMode = function (bRepeat) {
        if (this.m_bRepeatType == bRepeat)
            return;
        this.m_bRepeatType = bRepeat;
        if (bRepeat) {
            this.m_vecImage[0].SetRepeat(false, false);
            this.m_vecImage[1].SetRepeat(true, false);
            this.m_vecImage[2].SetRepeat(false, false);
            this.m_vecImage[3].SetRepeat(false, true);
            this.m_vecImage[4].SetRepeat(true, true);
            this.m_vecImage[5].SetRepeat(false, true);
            this.m_vecImage[6].SetRepeat(false, false);
            this.m_vecImage[7].SetRepeat(true, false);
            this.m_vecImage[8].SetRepeat(false, false);
        }
        else {
            for (var i = 0; i < 9; i++)
                this.m_vecImage[i].SetRepeat(false, false);
        }
        this.m_bNeedUpdateSize = true;
    };
    dScale9.prototype.SetSize = function (width, height) {
        if (this.m_fWidth != width || this.m_fHeight != height) {
            _super.prototype.SetSize.call(this, width, height);
            this.m_bNeedUpdateSize = true;
        }
    };
    dScale9.prototype.EndDsc = function () {
        _super.prototype.EndDsc.call(this);
        this.m_bNeedUpdateSize = true;
    };
    dScale9.prototype.UpdateSize = function () {
        var a = this;
        if (a.m_bBeginDsc)
            return;
        if (a.m_pImageBitmapData != null && !a.m_pImageBitmapData.isLoading()) {
            a.m_bNeedUpdateSize = false;
            var rc = a.m_rcBitmapRect;
            if (rc == null)
                rc = new dRect().SetPosSize(0, 0, a.m_pImageBitmapData.GetWidth(), a.m_pImageBitmapData.GetHeight());
            var width = _super.prototype.GetWidth.call(this);
            var height = _super.prototype.GetHeight.call(this);
            var tile_width = this.m_pImageBitmapData.GetWidth() / 3;
            var tile_height = this.m_pImageBitmapData.GetHeight() / 3;
            if (tile_width < 1)
                tile_width = 1;
            if (tile_height < 1)
                tile_height = 1;
            if (tile_width > width / 2)
                tile_width = width / 2;
            if (tile_height > height / 2)
                tile_height = height / 2;
            a.m_vecImage[0].SetPos(0, 0);
            a.m_vecImage[0].SetSize(tile_width, tile_height);
            a.m_vecImage[1].SetPos(tile_width, 0);
            a.m_vecImage[1].SetSize(width - tile_width - tile_width, tile_height);
            a.m_vecImage[2].SetSize(tile_width, tile_height);
            a.m_vecImage[2].SetPos(width - tile_width, 0);
            a.m_vecImage[3].SetPos(0, tile_height);
            a.m_vecImage[3].SetSize(tile_width, height - tile_height - tile_height);
            a.m_vecImage[4].SetPos(tile_width, tile_height);
            a.m_vecImage[4].SetSize(width - tile_width - tile_width, height - tile_height - tile_height);
            a.m_vecImage[5].SetPos(width - tile_width, tile_height);
            a.m_vecImage[5].SetSize(tile_width, height - tile_height - tile_height);
            a.m_vecImage[6].SetSize(tile_width, tile_height);
            a.m_vecImage[6].SetPos(0, height - tile_height);
            a.m_vecImage[7].SetPos(tile_width, height - tile_height);
            a.m_vecImage[7].SetSize(width - tile_width - tile_width, tile_height);
            a.m_vecImage[8].SetSize(tile_width, tile_height);
            a.m_vecImage[8].SetPos(width - tile_width, height - tile_height);
            for (var i = 0; i < 9; i++) {
                a.m_vecImage[i].SetPos(a.m_vecImage[i].GetPosX() - this.GetAnchorU() * width, a.m_vecImage[i].GetPosY() - a.GetAnchorV() * height);
                if (a.m_vecImage[i].GetWidth() < 0)
                    a.m_vecImage[i].SetSize(0, a.m_vecImage[i].GetHeight());
                if (a.m_vecImage[i].GetHeight() < 0)
                    a.m_vecImage[i].SetSize(a.m_vecImage[i].GetWidth(), 0);
            }
            var bmp_width = rc.Width();
            var bmp_height = rc.Height();
            var bmp_width3 = rc.Width() / 3;
            var bmp_height3 = rc.Height() / 3;
            var x1 = 0;
            var x2 = bmp_width3;
            var x3 = bmp_width - bmp_width3;
            var x4 = bmp_width;
            var y1 = 0;
            var y2 = bmp_height3;
            var y3 = bmp_height - bmp_height3;
            var y4 = bmp_height;
            if (x2 > width / 2) {
                x2 = width / 2;
                x3 = bmp_width - width / 2;
            }
            if (y2 > height / 2) {
                y2 = height / 2;
                y3 = bmp_height - height / 2;
            }
            x1 += rc.left;
            x2 += rc.left;
            x3 += rc.left;
            x4 += rc.left;
            y1 += rc.top;
            y2 += rc.top;
            y3 += rc.top;
            y4 += rc.top;
            var rect = new dRect();
            a.m_vecImage[0].SetBitmapData(a.GetBitmapData(), rect.SetValue(x1, y1, x2, y2));
            if (x2 != x3)
                a.m_vecImage[1].SetBitmapData(a.GetBitmapData(), rect.SetValue(x2, y1, x3, y2));
            a.m_vecImage[2].SetBitmapData(a.GetBitmapData(), rect.SetValue(x3, y1, x4, y2));
            if (y2 != y3) {
                a.m_vecImage[3].SetBitmapData(a.GetBitmapData(), rect.SetValue(x1, y2, x2, y3));
                if (x2 != x3)
                    a.m_vecImage[4].SetBitmapData(a.GetBitmapData(), rect.SetValue(x2, y2, x3, y3));
                a.m_vecImage[5].SetBitmapData(a.GetBitmapData(), rect.SetValue(x3, y2, x4, y3));
            }
            a.m_vecImage[6].SetBitmapData(a.GetBitmapData(), rect.SetValue(x1, y3, x2, y4));
            if (x2 != x3)
                a.m_vecImage[7].SetBitmapData(a.GetBitmapData(), rect.SetValue(x2, y3, x3, y4));
            a.m_vecImage[8].SetBitmapData(a.GetBitmapData(), rect.SetValue(x3, y3, x4, y4));
        }
        a.m_bNeedComputeRenderBatch = true;
    };
    dScale9.prototype.SetAnchor = function (u, v) {
        var a = this;
        if (a.m_fAnchorU != u || a.m_fAnchorV != v) {
            _super.prototype.SetAnchor.call(this, u, v);
            a.UpdateSize();
        }
    };
    dScale9.prototype._DrawImage = function (i, image, perWidth, perHeight, offx, offy, uMulty, vMulty) {
        var a = this;
        var bmpWidth = a.m_pImageBitmapData.GetWidth();
        var bmpHeight = a.m_pImageBitmapData.GetHeight();
        var rc = image.GetBitmapSourceRect();
        var width = perWidth;
        var height = perHeight;
        var mat2 = a.m_matBuffer.Copy(a.m_matRenderMatrixSelf);
        mat2.Scaling(width / a.GetWidth(), height / a.GetHeight(), 1);
        mat2.TranslationFast((image.GetPosX() + offx) / a.GetWidth() + a.GetAnchorU(), (image.GetPosY() + offy) / a.GetHeight() + a.GetAnchorV(), 0);
        var t_left = rc.left / bmpWidth;
        var t_top = rc.top / bmpHeight;
        var t_right = rc.Width() / bmpWidth * uMulty + t_left;
        var t_bottom = rc.Height() / bmpHeight * vMulty + t_top;
        t_top = 1 - t_top;
        t_bottom = 1 - t_bottom;
        var t_vertices = a.m_vertices;
        var t_indices = a.m_indices;
        var index = i * 20;
        t_vertices[index] = 0.0;
        t_vertices[index + 1] = 0.0;
        t_vertices[index + 2] = 0.0;
        t_vertices[index + 3] = t_left;
        t_vertices[index + 4] = t_top;
        t_vertices[index + 5] = 1.0;
        t_vertices[index + 6] = 0.0;
        t_vertices[index + 7] = 0.0;
        t_vertices[index + 8] = t_right;
        t_vertices[index + 9] = t_top;
        t_vertices[index + 10] = 0.0;
        t_vertices[index + 11] = 1.0;
        t_vertices[index + 12] = 0.0;
        t_vertices[index + 13] = t_left;
        t_vertices[index + 14] = t_bottom;
        t_vertices[index + 15] = 1.0;
        t_vertices[index + 16] = 1.0;
        t_vertices[index + 17] = 0.0;
        t_vertices[index + 18] = t_right;
        t_vertices[index + 19] = t_bottom;
        mat2.TransformFloatArray3(t_vertices, index);
        mat2.TransformFloatArray3(t_vertices, index + 5);
        mat2.TransformFloatArray3(t_vertices, index + 10);
        mat2.TransformFloatArray3(t_vertices, index + 15);
        index = i * 6;
        var m = i * 4;
        t_indices[index] = 1 + m;
        t_indices[index + 1] = 0 + m;
        t_indices[index + 2] = 2 + m;
        t_indices[index + 3] = 1 + m;
        t_indices[index + 4] = 2 + m;
        t_indices[index + 5] = 3 + m;
    };
    dScale9.prototype.ComputeRenderBatch = function () {
        var a = this;
        var bmp = a.m_pImageBitmapData;
        if (bmp == null)
            return;
        if (a.m_bRepeatType) {
            var perWidth = bmp.GetWidth() / 3;
            var perHeight = bmp.GetHeight() / 3;
            var imageCount = 0;
            for (var i = 0; i < 9; i++) {
                imageCount += a.m_vecImage[i].GetImageCountH(perWidth, perHeight) * a.m_vecImage[i].GetImageCountV(perWidth, perHeight);
            }
            a.m_nVerticesLength = 20 * imageCount;
            a.m_nIndicesLength = 6 * imageCount;
            if (a.m_vertices == null || a.m_vertices.length < a.m_nVerticesLength)
                a.m_vertices = new Array(a.m_nVerticesLength);
            if (a.m_indices == null || a.m_indices.length < a.m_nIndicesLength)
                a.m_indices = new Array(a.m_nIndicesLength);
            var ii = 0;
            for (var i = 0; i < 9; i++) {
                var pImage = a.m_vecImage[i];
                if (pImage.repeatH || pImage.repeatV) {
                    var h = pImage.GetImageCountH(perWidth, perHeight);
                    var v = pImage.GetImageCountV(perWidth, perHeight);
                    for (var n = 0; n < v; n++) {
                        for (var m = 0; m < h; m++) {
                            var perWidth2 = perWidth;
                            var uMulty = 1;
                            if (pImage.repeatH) {
                                if (m == h - 1) {
                                    perWidth2 = pImage.width % perWidth;
                                    if (perWidth2 == 0)
                                        perWidth2 += perWidth;
                                }
                                uMulty = perWidth2 / perWidth;
                            }
                            else
                                perWidth2 = pImage.width;
                            var perHeight2 = perHeight;
                            var vMulty = 1;
                            if (pImage.repeatV) {
                                if (n == v - 1) {
                                    perHeight2 = pImage.height % perHeight;
                                    if (perHeight2 == 0)
                                        perHeight2 += perHeight;
                                }
                                vMulty = perHeight2 / perHeight;
                            }
                            else
                                perHeight2 = pImage.height;
                            a._DrawImage(ii, pImage, perWidth2, perHeight2, m * perWidth, n * perHeight, uMulty, vMulty);
                            ii++;
                        }
                    }
                }
                else {
                    a._DrawImage(ii, pImage, pImage.width, pImage.height, 0, 0, 1, 1);
                    ii++;
                }
            }
        }
        else {
            a.m_nVerticesLength = 180;
            a.m_nIndicesLength = 54;
            if (a.m_vertices == null || a.m_vertices.length != a.m_nVerticesLength)
                a.m_vertices = new Array(a.m_nVerticesLength);
            if (a.m_indices == null || a.m_indices.length != a.m_nIndicesLength)
                a.m_indices = new Array(a.m_nIndicesLength);
            for (var i = 0; i < 9; i++) {
                var pImage = a.m_vecImage[i];
                a._DrawImage(i, pImage, pImage.width, pImage.height, 0, 0, 1, 1);
            }
        }
    };
    dScale9.prototype.SpriteRender = function () {
        var a = this;
        if (a.m_pImageBitmapData == null || a.m_pImageBitmapData.isLoading())
            return;
        if (a.m_bNeedUpdateSize)
            a.UpdateSize();
        if (a.m_bNeedComputeRenderBatch) {
            a.m_bNeedComputeRenderBatch = false;
            a.ComputeRenderBatch();
        }
        if (a.m_indices) {
            dSpriteDefaultShader.Instance().m_pStreamMeshData.SetData(null, a.m_nVerticesLength / 5, a.m_indices, dSpriteDefaultShader.Instance().m_vertexDecl, dMeshData.ACCESS_WRITE_TYPE_STREAM_DRAW, a.m_vertices, a.m_nIndicesLength);
            _super.prototype.SpriteRender.call(this);
        }
    };
    dScale9.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("repeatType"))
            this.repeatType = Boolean(dMath.ParseInt(json.repeatType));
    };
    return dScale9;
}(dImage));
var ImageObj = (function () {
    function ImageObj() {
        this.rc = new dRect();
        this.x = 0;
        this.y = 0;
        this.width = 0;
        this.height = 0;
        this.repeatH = false;
        this.repeatV = false;
    }
    ImageObj.prototype.SetPos = function (x, y) {
        this.x = x;
        this.y = y;
    };
    ImageObj.prototype.GetPosX = function () {
        return this.x;
    };
    ImageObj.prototype.GetPosY = function () {
        return this.y;
    };
    ImageObj.prototype.SetSize = function (width, height) {
        this.width = width;
        this.height = height;
    };
    ImageObj.prototype.GetWidth = function () {
        return this.width;
    };
    ImageObj.prototype.GetHeight = function () {
        return this.height;
    };
    ImageObj.prototype.SetBitmapData = function (bmp, rc) {
        this.rc.Copy(rc);
    };
    ImageObj.prototype.GetBitmapSourceRect = function () {
        return this.rc;
    };
    ImageObj.prototype.SetRepeat = function (repeatH, repeatV) {
        this.repeatH = repeatH;
        this.repeatV = repeatV;
    };
    ImageObj.prototype.GetImageCountH = function (perWidth, perHeight) {
        if (perWidth == 0)
            return 1;
        var hCount = 1;
        if (this.repeatH)
            hCount = dMath.Ceil(this.width / perWidth);
        return hCount;
    };
    ImageObj.prototype.GetImageCountV = function (perWidth, perHeight) {
        if (perHeight == 0)
            return 1;
        var vCount = 1;
        if (this.repeatV)
            vCount = dMath.Ceil(this.height / perHeight);
        return vCount;
    };
    return ImageObj;
}());
var LevelCaizimiBlock = (function (_super) {
    __extends(LevelCaizimiBlock, _super);
    function LevelCaizimiBlock() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    LevelCaizimiBlock.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 80, "height": 90, "resourceFileName": "data/font2.json", "spriteColor": -16777216, "text": "", "width": 80, "x": 0, "y": -4 }], "anchorU": 0.5, "anchorV": 0.5, "className": "QuestBack", "classType": "dScale9", "height": 164, "resourceFileName": "data/zi5.png", "width": 164, "x": 0, "y": 0 }; };
    return LevelCaizimiBlock;
}(dScale9));
var LevelCaizimiQuest = (function (_super) {
    __extends(LevelCaizimiQuest, _super);
    function LevelCaizimiQuest() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    LevelCaizimiQuest.prototype._dscData = function () { return { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 64, "height": 72, "resourceFileName": "data/font2.json", "spriteColor": -16777216, "text": "", "width": 64, "x": 0, "y": -4 }], "anchorU": 0.5, "anchorV": 0.5, "className": "QuestBack", "classType": "dScale9", "height": 184, "resourceFileName": "data/zi3.png", "width": 174, "x": 0, "y": -133 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "QuestBlock", "classType": "dImage", "height": 156, "resourceFileName": "data/zi4.png", "width": 156, "x": 0, "y": 67 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 494, "width": 181, "x": 0, "y": 0 }; };
    LevelCaizimiQuest.prototype.SetText = function (str) {
        this.QuestBack_Text.text = str;
        this.QuestBack.width = this.QuestBack_Text.width + 60;
        this.width = this.QuestBack.width;
    };
    return LevelCaizimiQuest;
}(dSprite));
var LevelCheckBox = (function (_super) {
    __extends(LevelCheckBox, _super);
    function LevelCheckBox() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    LevelCheckBox.prototype.Init2 = function (buttons, rightPass) {
        var _this = this;
        for (var i = 0; i < buttons.length; i++) {
            var fun = function (i) {
                buttons[i].SetEvent(new dEvent().SetOnCheck(function () {
                    dSound.PlaySound("data/sound/button.mp3");
                    _this.CheckClear2(buttons, rightPass);
                }));
            };
            fun(i);
        }
    };
    LevelCheckBox.prototype.CheckClear2 = function (buttons, rightPass) {
        var str = "";
        for (var i = 0; i < buttons.length; i++)
            str += buttons[i].isCheck() ? 1 : 0;
        if (str == rightPass)
            this.OnPassWordRight();
    };
    return LevelCheckBox;
}(LevelBase));
var LevelChengyu = (function (_super) {
    __extends(LevelChengyu, _super);
    function LevelChengyu() {
        var _this = _super.call(this) || this;
        _this.m_answerBox = new LevelChengyuAnswerBox();
        _this.m_questBox = new LevelChengyuQuestBox();
        _this.m_vecSelect = new Array();
        _this.m_right = 0;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        return _this;
    }
    LevelChengyu.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Back", "classType": "dImage", "clipChild": 1, "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "alignType": 0, "anchorU": 0.5, "anchorV": 0.5, "className": "LayoutVBox", "classType": "dLayoutVBox", "height": 1000, "space": 10, "width": 1000, "x": 0, "y": 0 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 64, "height": 75, "resourceFileName": "data/font64.json", "spriteColor": -791858, "text": "", "width": 128, "x": 0, "y": -8 }], "anchorU": 0.5, "anchorV": 0.5, "className": "ClearButton", "classType": "dButtonScale9", "height": 114, "layoutAlignH": 2, "layoutAlignV": 2, "resourceFileName": "data/button2.png", "width": 319, "x": 306.5, "y": 815 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "width": 1080, "x": 0, "y": 0 }; };
    LevelChengyu.prototype.Init = function (pGameWorld) {
        var _this = this;
        _super.prototype.Init.call(this, pGameWorld);
        this.LayoutVBox.AddChild(this.m_answerBox);
        this.LayoutVBox.AddChild(this.m_questBox);
        var stageEntry = pGameWorld.GetStageData().stageEntry;
        this.m_questBox.AddTexts(stageEntry.quest);
        var blocks = this.m_questBox.GetBlocks();
        for (var i = 0; i < blocks.length; i++) {
            var fun = function (i) {
                var pTouchEvent = new dSprite();
                blocks[i].SetTouchEvent(pTouchEvent);
                pTouchEvent.OnTouchDown = function (x, y, delay) {
                    if (!blocks[i].isSelect()) {
                        dSound.PlaySound("data/sound/button.mp3");
                        blocks[i].SetSelect(true);
                        _this.m_answerBox.Text.text += blocks[i].GetText();
                        _this.m_vecSelect.push(blocks[i]);
                        if (_this.m_vecSelect.length >= 4) {
                            _this.CheckAnswer();
                        }
                    }
                };
            };
            fun(i);
        }
        this.ClearButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dSound.PlaySound("data/sound/button.mp3");
            _this.ClearSelect(0);
        }));
    };
    LevelChengyu.prototype.CheckAnswer = function () {
        var stageEntry = this.m_pGameWorld.GetStageData().stageEntry;
        var isAllRight = true;
        for (var i = 0; i < stageEntry.quest.length; i += 4) {
            isAllRight = true;
            for (var j = 0; j < this.m_vecSelect.length; j++) {
                if (this.m_vecSelect[j].GetText() != stageEntry.quest[i + j]) {
                    isAllRight = false;
                    break;
                }
            }
            if (isAllRight) {
                this.m_right += this.m_vecSelect.length;
                for (var j = 0; j < this.m_vecSelect.length; j++) {
                    this.m_vecSelect[j].visible = false;
                }
                if (this.m_right >= stageEntry.quest.length) {
                    this.OnPassWordRight();
                    return;
                }
                dSound.PlaySound("data/sound/rightsub.mp3");
                break;
            }
        }
        this.ClearSelect(300, !isAllRight);
    };
    LevelChengyu.prototype.ClearSelect = function (delay, playSound) {
        var _this = this;
        if (delay === void 0) { delay = 300; }
        if (playSound === void 0) { playSound = false; }
        this.m_pGameWorld.SetBlockMouse(true);
        new dTimer(this).Create(delay, 1, function () {
            if (playSound)
                dSound.PlaySound("data/sound/click.mp3");
            for (var i = 0; i < _this.m_vecSelect.length; i++)
                _this.m_vecSelect[i].SetSelect(false);
            _this.m_answerBox.Text.text = "";
            _this.m_vecSelect.clear();
            _this.m_pGameWorld.SetBlockMouse(false);
        });
    };
    LevelChengyu.prototype.GetHintImage = function () {
        var str = "";
        var stageEntry = this.m_pGameWorld.GetStageData().stageEntry;
        for (var i = 0; i < stageEntry.quest.length; i++) {
            if (i > 0 && i % 4 == 0)
                str += "\n";
            str += stageEntry.quest[i];
        }
        var label = new dBitmapFont();
        label.LoadFromFile("data/font2.json");
        label.fontSize = 64;
        label.spriteColor = 0xff000000;
        label.text = str;
        return label;
    };
    return LevelChengyu;
}(LevelBase));
var LevelChengyuAnswerBox = (function (_super) {
    __extends(LevelChengyuAnswerBox, _super);
    function LevelChengyuAnswerBox() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.Text.text = "";
        return _this;
    }
    LevelChengyuAnswerBox.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Line", "classType": "dImage", "height": 4, "pureColor": 1, "spriteColor": -16777216, "width": 400, "x": 0, "y": 46 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 80, "height": 0, "resourceFileName": "data/font2.json", "spriteColor": -16777216, "width": 0, "x": 0, "y": -10 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 133, "width": 478, "x": 0, "y": 0 }; };
    return LevelChengyuAnswerBox;
}(dSprite));
var LevelChengyuBlock = (function (_super) {
    __extends(LevelChengyuBlock, _super);
    function LevelChengyuBlock() {
        var _this = _super.call(this) || this;
        _this.m_isSelect = false;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        return _this;
    }
    LevelChengyuBlock.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 80, "height": 90, "resourceFileName": "data/font2.json", "spriteColor": -16777216, "text": "", "width": 80, "x": 0, "y": -4 }], "anchorU": 0.5, "anchorV": 0.5, "className": "QuestBack", "classType": "dScale9", "height": 160, "resourceFileName": "data/zi6.png", "width": 160, "x": 0, "y": 0 }; };
    LevelChengyuBlock.prototype.SetSelect = function (isSelect) {
        this.m_isSelect = isSelect;
        this.spriteColor = isSelect ? 0xffef9898 : 0xffffffff;
    };
    LevelChengyuBlock.prototype.isSelect = function () {
        return this.m_isSelect;
    };
    LevelChengyuBlock.prototype.GetText = function () {
        return this.Text.text;
    };
    return LevelChengyuBlock;
}(dScale9));
var LevelChengyuQuestBox = (function (_super) {
    __extends(LevelChengyuQuestBox, _super);
    function LevelChengyuQuestBox() {
        var _this = _super.call(this) || this;
        _this.m_vecBlocks = new Array();
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    LevelChengyuQuestBox.prototype._dscData = function () { return { "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 710, "width": 710, "x": 0, "y": 0 }; };
    LevelChengyuQuestBox.prototype.AddText = function (str) {
        var block = new LevelChengyuBlock();
        block.Text.text = str;
        this.AddChild(block);
        this.m_vecBlocks.push(block);
        this.UpdatePos();
    };
    LevelChengyuQuestBox.prototype.AddTexts = function (str) {
        for (var i = 0; i < str.length; i++) {
            var block = new LevelChengyuBlock();
            block.Text.text = str[i];
            this.AddChild(block);
            this.m_vecBlocks.push(block);
        }
        this.UpdatePos();
    };
    LevelChengyuQuestBox.prototype.GetBlocks = function () {
        return this.m_vecBlocks;
    };
    LevelChengyuQuestBox.prototype.UpdatePos = function () {
        var vecBlocks = new Array();
        vecBlocks.copy(this.m_vecBlocks);
        vecBlocks.randomSort();
        var totalWidth = 0;
        var space = 10;
        for (var i = 0; i < vecBlocks.length; i++)
            totalWidth += vecBlocks[i].width + space;
        totalWidth -= space;
        var lineCount = 1;
        while (totalWidth / lineCount > this.width) {
            lineCount++;
        }
        totalWidth /= lineCount;
        var x = 0;
        var y = 0;
        var maxHeight = 0;
        var thisLineWidth = 0;
        var thisLineCount = 0;
        for (var i = 0; i < vecBlocks.length; i++) {
            vecBlocks[i].SetPos(x + vecBlocks[i].width * vecBlocks[i].anchorU, y + vecBlocks[i].height * vecBlocks[i].anchorV);
            x += vecBlocks[i].width + space;
            thisLineWidth += vecBlocks[i].width + space;
            thisLineCount++;
            if (maxHeight < vecBlocks[i].height)
                maxHeight = vecBlocks[i].height;
            if (x > totalWidth) {
                for (var j = 0; j < thisLineCount; j++)
                    vecBlocks[i - j].positionX -= thisLineWidth / 2;
                x = 0;
                if (i < vecBlocks.length - 1) {
                    y += maxHeight + space;
                    maxHeight = 0;
                }
                thisLineWidth = 0;
                thisLineCount = 0;
            }
        }
        y += maxHeight;
        for (var j = 0; j < thisLineCount; j++)
            vecBlocks[i - j - 1].positionX -= thisLineWidth / 2;
        for (var i = 0; i < vecBlocks.length; i++)
            vecBlocks[i].positionY -= y / 2;
        this.height = y;
    };
    return LevelChengyuQuestBox;
}(dSprite));
var LevelColorSelect = (function (_super) {
    __extends(LevelColorSelect, _super);
    function LevelColorSelect() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.m_selectData = new Array();
        return _this;
    }
    LevelColorSelect.prototype.Init2 = function (buttons, images, colors, rightPass) {
        var _this = this;
        if (!images)
            images = buttons;
        for (var i = 0; i < buttons.length; i++) {
            this.m_selectData.push(0);
            buttons[i].userData = new Array();
            buttons[i].userData.copy(colors);
            var fun = function (i) {
                images[i].spriteColor = colors[0];
                buttons[i].SetTouchDownScaleMode(false);
                buttons[i].SetEvent(new dEvent().SetOnButtonDown(function () {
                    var colors = buttons[i].userData;
                    dSound.PlaySound("data/sound/button.mp3");
                    _this.m_selectData[i]++;
                    _this.m_selectData[i] %= colors.length;
                    images[i].spriteColor = colors[_this.m_selectData[i]];
                    _this.CheckClear2(rightPass, colors);
                }));
            };
            fun(i);
        }
    };
    LevelColorSelect.prototype.CheckClear2 = function (rightPass, colors) {
        var str = "";
        for (var i = 0; i < this.m_selectData.length; i++)
            str += this.m_selectData[i];
        if (str == rightPass)
            this.OnPassWordRight();
    };
    return LevelColorSelect;
}(LevelBase));
var LevelNumCalculator = (function (_super) {
    __extends(LevelNumCalculator, _super);
    function LevelNumCalculator() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.m_inputText = "";
        return _this;
    }
    LevelNumCalculator.prototype.Init2 = function (buttons, backButton, okButton, screenText, rightPass, shakeImage, num, maxLength) {
        var _this = this;
        if (shakeImage === void 0) { shakeImage = null; }
        if (num === void 0) { num = null; }
        if (maxLength === void 0) { maxLength = -1; }
        if (!num)
            num = "";
        if (maxLength == -1)
            maxLength = rightPass.length;
        for (var i = 0; i < buttons.length; i++) {
            if (num.length <= i)
                num += i;
            var fun = function (i) {
                if (buttons[i]) {
                    buttons[i].SetTouchDownScaleMode(false);
                    buttons[i].SetEvent(new dEvent().SetOnButtonDown(function () {
                        dSound.PlaySound("data/sound/button.mp3");
                        _this.m_inputText += num.charAt(i);
                        if (_this.m_inputText.length > maxLength)
                            _this.m_inputText = _this.m_inputText.substring(1, _this.m_inputText.length);
                        screenText.text = _this.m_inputText;
                    }));
                }
            };
            fun(i);
        }
        if (okButton) {
            okButton.SetEvent(new dEvent().SetOnButtonDown(function () {
                dSound.PlaySound("data/sound/button.mp3");
                _this.CheckClear2(_this.m_inputText, rightPass, shakeImage);
            }));
        }
        if (backButton) {
            backButton.SetEvent(new dEvent().SetOnButtonDown(function () {
                dSound.PlaySound("data/sound/button.mp3");
                if (_this.m_inputText.length) {
                    _this.m_inputText = _this.m_inputText.substring(0, _this.m_inputText.length - 1);
                }
                screenText.text = _this.m_inputText;
            }));
        }
    };
    LevelNumCalculator.prototype.CheckClear2 = function (inputText, rightPass, shakeImage) {
        if (inputText == rightPass) {
            this.OnPassWordRight();
        }
        else {
            if (shakeImage)
                CCActionManager.Instance().AddAction(new CCShake(0.2, -10, 10), shakeImage);
        }
    };
    return LevelNumCalculator;
}(LevelBase));
var LevelNumPassword = (function (_super) {
    __extends(LevelNumPassword, _super);
    function LevelNumPassword() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    LevelNumPassword.prototype.Init2 = function (buttons, texts, rightPass, buttonOk, shakeImage) {
        var _this = this;
        if (buttonOk === void 0) { buttonOk = null; }
        if (shakeImage === void 0) { shakeImage = null; }
        for (var i = 0; i < buttons.length; i++) {
            var fun = function (i) {
                buttons[i].SetTouchDownScaleMode(false);
                buttons[i].SetEvent(new dEvent().SetOnButtonDown(function () {
                    dSound.PlaySound("data/sound/button.mp3");
                    var num = Number(texts[i].GetText());
                    num++;
                    num %= 10;
                    texts[i].SetText(String(num));
                    if (buttonOk == null)
                        _this.CheckClear2(texts, rightPass);
                }));
            };
            fun(i);
        }
        if (buttonOk) {
            buttonOk.SetEvent(new dEvent().SetOnButtonDown(function () {
                dSound.PlaySound("data/sound/button.mp3");
                if (!_this.CheckClear2(texts, rightPass)) {
                    if (shakeImage)
                        CCActionManager.Instance().AddAction(new CCShake(0.2, -10, 10), shakeImage);
                }
            }));
        }
    };
    LevelNumPassword.prototype.CheckClear2 = function (texts, rightPass) {
        var str = "";
        for (var i = 0; i < texts.length; i++)
            str += texts[i].GetText();
        if (str == rightPass) {
            this.OnPassWordRight();
            return true;
        }
        return false;
    };
    return LevelNumPassword;
}(LevelBase));
var LevelPinhanzi = (function (_super) {
    __extends(LevelPinhanzi, _super);
    function LevelPinhanzi() {
        var _this = _super.call(this) || this;
        _this.m_vecLabels = new Array();
        _this.m_editMode = false;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        return _this;
    }
    LevelPinhanzi.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Back", "classType": "dImage", "clipChild": 1, "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Zi", "classType": "dBitmapFont", "fontSize": 500, "height": 495, "resourceFileName": "data/font200.json", "spriteColor": -16777216, "text": "", "width": 500, "x": 0, "y": -62 }], "anchorU": 0.5, "anchorV": 0.5, "className": "ZiBack", "classType": "dImage", "height": 779, "resourceFileName": "data/zi1.png", "width": 778, "x": 0, "y": -172 }, { "alignType": 0, "anchorU": 0.5, "anchorV": 0.5, "className": "ZiGroup", "classType": "dLayoutHBox", "height": 319, "space": 10, "width": 882, "x": 0, "y": 513 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "width": 1080, "x": 0, "y": 0 }; };
    LevelPinhanzi.prototype.Init = function (pGameWorld) {
        var _this = this;
        _super.prototype.Init.call(this, pGameWorld);
        var quests = this.m_pGameWorld.GetStageData().stageEntry.quest;
        this.ZiBack_Zi.visible = false;
        var quests2 = new Array();
        quests2.copy(quests);
        if (!this.m_editMode)
            quests2.randomSort();
        for (var i = 0; i < quests2.length; i++) {
            var block = new LevelPinhanziBlock();
            block.Zi.text = quests2[i];
            this.ZiGroup.AddChild(block);
            var label = block.Zi;
            this.m_vecLabels.push(label);
        }
        if (quests2.length >= 4)
            this.ZiGroup.SetScale(0.8, 0.8);
        this.ZiGroup.UpdateLayout();
        for (var i = 0; i < this.m_vecLabels.length; i++) {
            var label2 = this.m_vecLabels[i];
            label2.SetPos(label2.GetPosX_World(this, false), label2.GetPosY_World(this, false));
            label2.SetScale(this.ZiGroup.scaleX, this.ZiGroup.scaleY);
            this.AddChild(label2);
            var canDrag = new CanDrag(label2);
            canDrag.touchDownMakeToTop = false;
            canDrag.touchDownPlaySound = "data/sound/click.mp3";
            canDrag.touchUpPlaySound = "data/sound/button.mp3";
            canDrag.onTouchDown = function (canDrag2) {
                canDrag2.m_target.SetScale(1, 1);
            };
            canDrag.onTouchUp = function (canDrag2) {
                if (_this.m_editMode)
                    _this.OutputLabelsPos();
                else
                    _this.CheckClear();
            };
        }
    };
    LevelPinhanzi.prototype.CheckClear = function () {
        var vecTextLengthData = new Array();
        var answerData = this.m_pGameWorld.GetStageData().stageEntry.data;
        var kkk = 0;
        for (var kk = 0; kk < answerData.length; kk++) {
            var answerPosList = answerData[kk];
            var org_average_pos = new dVector2();
            var org_poses = new Array();
            var org_char = new Array();
            for (var i = 0; i < answerPosList.length; i += 2) {
                org_average_pos.x += Number(answerPosList[i]);
                org_average_pos.y += Number(answerPosList[i + 1]);
            }
            org_average_pos.DivAppendF(answerPosList.length / 2);
            for (var i = 0; i < answerPosList.length; i += 2) {
                org_poses.push(new dVector2(Number(answerPosList[i]) - org_average_pos.x, Number(answerPosList[i + 1]) - org_average_pos.y));
                org_char.push(this.m_pGameWorld.GetStageData().stageEntry.quest[kkk]);
                kkk++;
            }
            var user_average_pos = new dVector2();
            var user_poses = new Array();
            var user_char = new Array();
            var str = "";
            for (var i = 0; i < org_char.length; i++)
                str += org_char[i];
            var vecvecWords = this.FindWordSpriteByString(str);
            var lastLength = 99999;
            var textLengthData = null;
            for (var k = 0; k < vecvecWords.length; k++) {
                var vecWords = vecvecWords[k];
                user_poses.clear();
                user_char.clear();
                user_average_pos.SetValue(0, 0);
                for (var i = 0; i < vecWords.length; i++) {
                    user_average_pos.x += vecWords[i].positionX;
                    user_average_pos.y += vecWords[i].positionY;
                }
                user_average_pos.DivAppendF(vecWords.length);
                for (var i = 0; i < vecWords.length; i++) {
                    user_poses.push(new dVector2(vecWords[i].positionX - user_average_pos.x, vecWords[i].positionY - user_average_pos.y));
                    user_char.push(vecWords[i].text);
                }
                var lengthAdd = 0;
                for (var i = 0; i < org_char.length; i++) {
                    lengthAdd += org_poses[i].LengthTo(user_poses[i]) / vecWords[i].scaleX;
                }
                lengthAdd /= org_char.length;
                if (textLengthData == null || lastLength > lengthAdd) {
                    lastLength = lengthAdd;
                    textLengthData = new TextLengthData();
                    var index = kk;
                    if (index > this.m_pGameWorld.GetStageData().stageEntry.answer.length - 1)
                        index = this.m_pGameWorld.GetStageData().stageEntry.answer.length - 1;
                    textLengthData.text = this.m_pGameWorld.GetStageData().stageEntry.answer[index];
                    textLengthData.length = lengthAdd;
                }
            }
            if (textLengthData)
                vecTextLengthData.push(textLengthData);
        }
        var zuciMode = false;
        if (this.m_pGameWorld.GetStageData().stageEntry.type == "")
            zuciMode = true;
        if (zuciMode) {
            this.ZiBack_Zi.SetScale(0.7, 0.7);
            var str = "";
            for (var i = 0; i < vecTextLengthData.length; i++) {
                if (vecTextLengthData[i].length >= 30)
                    return;
                str += vecTextLengthData[i].text;
            }
            this.OnClear2(str);
        }
        else {
            vecTextLengthData.sort(function (a, b) {
                return a.length - b.length;
            });
            for (var i = 0; i < vecTextLengthData.length; i++) {
                if (vecTextLengthData[i].length < 30) {
                    this.OnClear2(vecTextLengthData[i].text);
                    break;
                }
            }
        }
    };
    LevelPinhanzi.prototype.OnClear2 = function (str) {
        this.ZiBack_Zi.text = str;
        this.ZiBack_Zi.visible = true;
        for (var i = 0; i < this.m_vecLabels.length; i++)
            this.m_vecLabels[i].visible = false;
        this.OnPassWordRight();
    };
    LevelPinhanzi.prototype.FindWordSpriteByString = function (text) {
        var ret = new Array();
        var list = new Array();
        var num = new Array();
        var len = text.length;
        for (var i = 0; i < len; i++) {
            list.push(this.FindWordSpriteByChar(text.charAt(i)));
            num.push(0);
        }
        while (true) {
            var arr = new Array();
            var hasSame = false;
            for (var i = 0; i < len; i++) {
                if (arr.indexOf(list[i][num[i]]) != -1) {
                    hasSame = true;
                    break;
                }
                if (list[i][num[i]])
                    arr.push(list[i][num[i]]);
            }
            if (!hasSame)
                ret.push(arr);
            var at = len - 1;
            num[at]++;
            while (num[at] >= list[at].length) {
                num[at] = 0;
                if (at > 0)
                    num[at - 1]++;
                at--;
                if (at < 0)
                    break;
            }
            if (at < 0)
                break;
        }
        return ret;
    };
    LevelPinhanzi.prototype.FindWordSpriteByChar = function (chr) {
        var ret = new Array();
        for (var i = 0, n = this.m_vecLabels.length; i < n; i++) {
            if (this.m_vecLabels[i].text == chr)
                ret.push(this.m_vecLabels[i]);
        }
        return ret;
    };
    LevelPinhanzi.prototype.OutputLabelsPos = function () {
        var str = "";
        for (var i = 0; i < this.m_vecLabels.length; i++) {
            if (i > 0)
                str += ",";
            str += dMath.ToInt(this.m_vecLabels[i].positionX) + "," + dMath.ToInt(this.m_vecLabels[i].positionY);
        }
        console.log(str);
        dInterface.FrameSetClipboard(str);
    };
    LevelPinhanzi.prototype.GetHintImage = function () {
        var label = new dBitmapFont();
        label.LoadFromFile("data/font200.json");
        label.fontSize = 200;
        label.spriteColor = 0xff000000;
        label.text = this.GetHintText();
        return label;
    };
    return LevelPinhanzi;
}(LevelBase));
var LevelPinhanziBlock = (function (_super) {
    __extends(LevelPinhanziBlock, _super);
    function LevelPinhanziBlock() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    LevelPinhanziBlock.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Zi", "classType": "dBitmapFont", "fontSize": 300, "height": 297, "resourceFileName": "data/font200.json", "spriteColor": -16777216, "text": "", "width": 300, "x": -1, "y": -29 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 319, "resourceFileName": "data/zi2.png", "width": 319, "x": 0, "y": 0 }; };
    return LevelPinhanziBlock;
}(dImage));
var LevelRotation = (function (_super) {
    __extends(LevelRotation, _super);
    function LevelRotation() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.m_rotData = new Array();
        return _this;
    }
    LevelRotation.prototype.Init2 = function (buttons, images, rightPass, dirNum, add) {
        var _this = this;
        if (dirNum === void 0) { dirNum = 4; }
        if (add === void 0) { add = 1; }
        for (var i = 0; i < buttons.length; i++) {
            this.m_rotData.push(0);
            var fun = function (i) {
                buttons[i].SetTouchDownScaleMode(false);
                buttons[i].SetEvent(new dEvent().SetOnButtonDown(function () {
                    dSound.PlaySound("data/sound/button.mp3");
                    _this.m_rotData[i] += add;
                    CCActionManager.Instance().AddAction(new CCRotateTo(0.1, _this.m_rotData[i] * (360 / dirNum)), images[i]);
                    _this.CheckClear2(rightPass, dirNum);
                }));
            };
            fun(i);
        }
    };
    LevelRotation.prototype.CheckClear2 = function (rightPass, dirNum) {
        var str = "";
        for (var i = 0; i < this.m_rotData.length; i++) {
            var n = this.m_rotData[i];
            while (n < 0)
                n += dirNum;
            str += n % dirNum;
        }
        if (str == rightPass)
            this.OnPassWordRight();
    };
    return LevelRotation;
}(LevelBase));
var LevelSequence = (function (_super) {
    __extends(LevelSequence, _super);
    function LevelSequence() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.m_inputData = new Array();
        return _this;
    }
    LevelSequence.prototype.Init2 = function (buttons, rightPass, buttonEnter) {
        var _this = this;
        if (buttonEnter === void 0) { buttonEnter = null; }
        for (var i = 0; i < buttons.length; i++) {
            var fun = function (i) {
                buttons[i].SetEvent(new dEvent().SetOnButtonDown(function () {
                    dSound.PlaySound("data/sound/button.mp3");
                    _this.m_inputData.push(i);
                    if (_this.m_inputData.length > rightPass.length)
                        _this.m_inputData.erase(0);
                    if (!buttonEnter)
                        _this.CheckClear2(rightPass);
                }));
            };
            fun(i);
        }
        if (buttonEnter) {
            buttonEnter.SetEvent(new dEvent().SetOnButtonDown(function () {
                dSound.PlaySound("data/sound/button.mp3");
                _this.CheckClear2(rightPass);
            }));
        }
    };
    LevelSequence.prototype.CheckClear2 = function (rightPass) {
        var str = this.m_inputData.join("");
        if (str == rightPass)
            this.OnPassWordRight();
    };
    return LevelSequence;
}(LevelBase));
var LevelSequenceLight = (function (_super) {
    __extends(LevelSequenceLight, _super);
    function LevelSequenceLight() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.m_inputData = new Array();
        _this.m_buttons = null;
        return _this;
    }
    LevelSequenceLight.prototype.Init2 = function (buttons, rightPass) {
        var _this = this;
        this.m_buttons = buttons;
        for (var i = 0; i < buttons.length; i++) {
            var fun = function (i) {
                buttons[i].SetEvent(new dEvent().SetOnButtonDown(function () {
                    dSound.PlaySound("data/sound/button.mp3");
                    var light = buttons[i].FindChild("Light");
                    if (light) {
                        light.visible = true;
                    }
                    if (buttons[i].toggleMode) {
                        buttons[i].SetButtonDown(true);
                    }
                    if (_this.m_inputData.indexOf(i) != -1)
                        return;
                    _this.m_inputData.push(i);
                    if (_this.m_inputData.length >= rightPass.length) {
                        _this.CheckClear2(rightPass);
                    }
                }));
            };
            fun(i);
        }
        this.ClearInput();
    };
    LevelSequenceLight.prototype.ClearInput = function () {
        this.m_inputData.clear();
        for (var i = 0; i < this.m_buttons.length; i++) {
            if (this.m_buttons[i].FindChild("Light"))
                this.m_buttons[i].FindChild("Light").visible = false;
            if (this.m_buttons[i].toggleMode)
                this.m_buttons[i].SetButtonDown(false);
        }
    };
    LevelSequenceLight.prototype.CheckClear2 = function (rightPass) {
        var str = this.m_inputData.join("");
        if (str == rightPass)
            this.OnPassWordRight();
        else
            this.ClearInput();
    };
    return LevelSequenceLight;
}(LevelBase));
var LevelSlider = (function (_super) {
    __extends(LevelSlider, _super);
    function LevelSlider() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    LevelSlider.prototype.Init2 = function (buttons, posYData, rightPass) {
        var _this = this;
        if (posYData == null)
            posYData = new Array();
        for (var i = 0; i < buttons.length; i++) {
            var fun = function (i) {
                buttons[i].SetHandleMouse(true);
                if (posYData.length <= i)
                    posYData.push(buttons[i].positionY);
                var pTouchEvent = new dSprite();
                buttons[i].SetTouchEvent(pTouchEvent);
                pTouchEvent.OnTouchDown = function (x, y, delta) {
                };
                pTouchEvent.OnTouchMove = function (x, y, offx, offy, delta) {
                    if (_this.m_pGameWorld.isGameClear())
                        return;
                    y += buttons[i].positionY;
                    var y2 = _this.FindNearPos(buttons[i], posYData, y);
                    if (y2 != buttons[i].positionY) {
                        buttons[i].positionY = y2;
                        dSound.PlaySound("data/sound/button.mp3");
                        _this.CheckClear2(buttons, posYData, rightPass);
                    }
                };
            };
            fun(i);
        }
    };
    LevelSlider.prototype.FindNearPos = function (p, poses, y) {
        var len = -1;
        var ret = 0;
        for (var i = 0; i < poses.length; i++) {
            var len2 = dMath.Abs(y - poses[i]);
            if (i == 0 || len > len2) {
                len = len2;
                ret = poses[i];
            }
        }
        return ret;
    };
    LevelSlider.prototype.CheckClear2 = function (buttons, poses, rightPass) {
        for (var i = 0; i < buttons.length; i++) {
            if (buttons[i].positionY != poses[rightPass[i]])
                return;
        }
        this.OnPassWordRight();
    };
    return LevelSlider;
}(LevelBase));
var LevelSliderH = (function (_super) {
    __extends(LevelSliderH, _super);
    function LevelSliderH() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    LevelSliderH.prototype.Init2 = function (buttons, posYData, rightPass) {
        var _this = this;
        if (posYData == null)
            posYData = new Array();
        for (var i = 0; i < buttons.length; i++) {
            var fun = function (i) {
                buttons[i].SetHandleMouse(true);
                if (posYData.length <= i)
                    posYData.push(buttons[i].positionX);
                var pTouchEvent = new dSprite();
                buttons[i].SetTouchEvent(pTouchEvent);
                pTouchEvent.OnTouchDown = function (x, y, delta) {
                };
                pTouchEvent.OnTouchMove = function (x, y, offx, offy, delta) {
                    if (_this.m_pGameWorld.isGameClear())
                        return;
                    x += buttons[i].positionX;
                    var y2 = _this.FindNearPos(buttons[i], posYData, x);
                    if (y2 != buttons[i].positionX) {
                        buttons[i].positionX = y2;
                        dSound.PlaySound("data/sound/button.mp3");
                        _this.CheckClear2(buttons, posYData, rightPass);
                    }
                };
            };
            fun(i);
        }
    };
    LevelSliderH.prototype.FindNearPos = function (p, poses, y) {
        var len = -1;
        var ret = 0;
        for (var i = 0; i < poses.length; i++) {
            var len2 = dMath.Abs(y - poses[i]);
            if (i == 0 || len > len2) {
                len = len2;
                ret = poses[i];
            }
        }
        return ret;
    };
    LevelSliderH.prototype.CheckClear2 = function (buttons, poses, rightPass) {
        for (var i = 0; i < buttons.length; i++) {
            if (buttons[i].positionX != poses[rightPass[i]])
                return;
        }
        this.OnPassWordRight();
    };
    return LevelSliderH;
}(LevelBase));
var LevelTianyibi = (function (_super) {
    __extends(LevelTianyibi, _super);
    function LevelTianyibi() {
        var _this = _super.call(this) || this;
        _this.m_line = new dLine();
        _this.m_hintLine = null;
        _this.m_editMode = false;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        return _this;
    }
    LevelTianyibi.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Back", "classType": "dImage", "clipChild": 1, "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "_child": [{ "anchorU": 0, "anchorV": 0, "className": "LineLayer", "classType": "dSprite", "height": 0, "width": 0, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Zi", "classType": "dBitmapFont", "fontSize": 600, "height": 594, "resourceFileName": "data/font200.json", "spriteColor": -16777216, "text": "", "width": 600, "x": 0, "y": -62 }], "anchorU": 0.5, "anchorV": 0.5, "className": "ZiBack", "classType": "dImage", "height": 779, "resourceFileName": "data/zi1.png", "width": 778, "x": 0, "y": 0 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "width": 1080, "x": 0, "y": 0 }; };
    LevelTianyibi.prototype.Init = function (pGameWorld) {
        _super.prototype.Init.call(this, pGameWorld);
        this.m_line.spriteColor = 0xff000000;
        this.m_line.lineWidth = 20;
        if (this.m_editMode) {
            this.m_line.spriteColor = 0xffff0000;
            this.m_line.lineWidth = 2;
        }
        this.ZiBack_LineLayer.AddChild(this.m_line);
        this.ZiBack_Zi.text = this.m_pGameWorld.GetStageData().stageEntry.quest[0];
    };
    LevelTianyibi.prototype.OnTouchDown = function (x, y, delta) {
        if (this.m_pGameWorld.isGameClear())
            return;
        if (this.m_line.hasMoveTo())
            this.m_line.LineTo(x, y);
        else
            this.m_line.MoveTo(x, y);
        var dot = new dImage();
        dot.LoadFromFile("data/dot.png");
        dot.SetSize(this.m_line.lineWidth, this.m_line.lineWidth);
        dot.spriteColor = this.m_line.spriteColor;
        dot.SetPos(x, y);
        this.m_line.AddChild(dot);
    };
    LevelTianyibi.prototype.OnTouchMove = function (x, y, offx, offy, delta) {
        if (this.m_pGameWorld.isGameClear())
            return;
        if (this.m_editMode)
            return;
        this.m_line.LineTo(x, y);
        var dot = new dImage();
        dot.LoadFromFile("data/dot.png");
        dot.SetSize(this.m_line.lineWidth, this.m_line.lineWidth);
        dot.spriteColor = this.m_line.spriteColor;
        dot.SetPos(x, y);
        this.m_line.AddChild(dot);
    };
    LevelTianyibi.prototype.OnTouchUp = function (x, y) {
        if (this.m_pGameWorld.isGameClear())
            return;
        if (!this.m_editMode) {
            this.CheckClear();
            this.m_line.Clear();
            this.m_line.RemoveAllChild();
        }
        else
            this.OutputLineData();
    };
    LevelTianyibi.prototype.OnShowHint = function () {
        var line = new dLine();
        line.lineWidth = 2;
        line.spriteColor = 0xffff0000;
        var data = this.m_pGameWorld.GetStageData().stageEntry.data[0];
        for (var i = 0; i < data.length; i += 2) {
            if (i == 0)
                line.MoveTo(Number(data[i]), Number(data[i + 1]));
            else
                line.LineTo(Number(data[i]), Number(data[i + 1]));
        }
        this.ZiBack_LineLayer.AddChild(line, 0);
        this.m_hintLine = line;
    };
    LevelTianyibi.prototype.CheckClear = function () {
        var data = this.m_line.GetPointList();
        var data2 = new Array();
        for (var i = 0; i < data.length; i++) {
            data2.push(String(data[i].x), String(data[i].y));
        }
        var rightData2 = this.m_pGameWorld.GetStageData().stageEntry.data;
        for (var kk = 0; kk < rightData2.length; kk++) {
            var rightData = rightData2[kk];
            var rightLenTotal = 0;
            for (var i = 0; i < rightData.length; i += 2) {
                rightLenTotal += new dVector2(Number(rightData[0]), Number(rightData[1])).Length();
            }
            var lenTotal = 0;
            for (var i = 0; i < data.length; i++) {
                var len = this.GetPointLineLength(data[i].x, data[i].y, rightData);
                lenTotal += len;
            }
            lenTotal /= data.length;
            var lenTotalInverse = 0;
            for (var i = 0; i < rightData.length; i += 2) {
                var len = this.GetPointLineLength(Number(rightData[i]), Number(rightData[i + 1]), data2);
                lenTotalInverse += len;
            }
            lenTotalInverse /= rightData.length;
            var pass = 60;
            if (this.m_pGameWorld.GetStageData().stageEntry.quest[0] == "")
                pass = 100;
            if (lenTotal < pass && lenTotalInverse < 50) {
                this.ZiBack_Zi.text = this.m_pGameWorld.GetStageData().stageEntry.answer[kk];
                if (this.m_hintLine)
                    this.m_hintLine.visible = false;
                this.OnPassWordRight();
            }
        }
    };
    LevelTianyibi.prototype.GetPointLineLength = function (px, py, lines) {
        if (lines.length == 2) {
            return new dVector2(px - Number(lines[0]), py - Number(lines[1])).Length();
        }
        var ret = 0;
        for (var i = 0; i < lines.length - 2; i += 2) {
            var len = dMath.PointLineDistance2D(Number(lines[i]), Number(lines[i + 1]), Number(lines[i + 2]), Number(lines[i + 3]), px, py);
            if (i == 0 || ret > len)
                ret = len;
        }
        return ret;
    };
    LevelTianyibi.prototype.OutputLineData = function () {
        var str = "";
        var data = this.m_line.GetPointList();
        for (var i = 0; i < data.length; i++) {
            if (i > 0)
                str += ",";
            str += dMath.ToInt(data[i].x) + "," + dMath.ToInt(data[i].y);
        }
        console.log(str);
        dInterface.FrameSetClipboard(str);
    };
    LevelTianyibi.prototype.GetHintImage = function () {
        var label = new dBitmapFont();
        label.LoadFromFile("data/font200.json");
        label.fontSize = 200;
        label.spriteColor = 0xff000000;
        label.text = this.GetHintText();
        return label;
    };
    return LevelTianyibi;
}(LevelBase));
var LevelYibushou = (function (_super) {
    __extends(LevelYibushou, _super);
    function LevelYibushou() {
        var _this = _super.call(this) || this;
        _this.m_vecLabels = new Array();
        _this.m_editMode = false;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        return _this;
    }
    LevelYibushou.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Back", "classType": "dImage", "clipChild": 1, "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Zi", "classType": "dBitmapFont", "fontSize": 600, "height": 594, "resourceFileName": "data/font200.json", "spriteColor": -16777216, "text": "", "width": 600, "x": 0, "y": -62 }], "anchorU": 0.5, "anchorV": 0.5, "className": "ZiBack", "classType": "dImage", "height": 779, "resourceFileName": "data/zi1.png", "width": 778, "x": 0, "y": 0 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "width": 1080, "x": 0, "y": 0 }; };
    LevelYibushou.prototype.Init = function (pGameWorld) {
        var _this = this;
        _super.prototype.Init.call(this, pGameWorld);
        var quest = this.m_pGameWorld.GetStageData().stageEntry.quest[0];
        this.ZiBack_Zi.visible = false;
        var zi = null;
        switch (quest) {
            case "":
                zi = new Yibushou_wu();
                break;
            case "":
                zi = new Yibushou_jia();
                break;
            case "":
                zi = new Yibushou_xing();
                break;
            case "":
                zi = new Yibushou_he();
                break;
            case "":
                zi = new Yibushou_guo();
                break;
            case "":
                zi = new Yibushou_bei();
                break;
            case "":
                zi = new Yibushou_wang();
                break;
            case "":
                zi = new Yibushou_biao();
                break;
            case "":
                zi = new Yibushou_yin();
                break;
            case "":
                zi = new Yibushou_yun();
                break;
            case "":
                zi = new Yibushou_he2();
                break;
        }
        var vec = new Array();
        vec.copy(zi.GetChildList());
        for (var i = 0; i < vec.length; i++) {
            if (vec[i] instanceof dImage) {
                vec[i].spriteColor = 0xff000000;
                this.m_vecLabels.push(vec[i]);
                var canDrag = new CanDrag(vec[i]);
                canDrag.canDragOutsideScreen = true;
                canDrag.touchDownMakeToTop = false;
                canDrag.touchDownPlaySound = "data/sound/click.mp3";
                canDrag.touchUpPlaySound = "data/sound/button.mp3";
                canDrag.onTouchUp = function (canDrag2) {
                    if (_this.m_editMode)
                        _this.OutputLabelsPos();
                    else
                        _this.CheckClear();
                };
            }
        }
        zi.alpha = 0;
        this.AddChild(zi);
    };
    LevelYibushou.prototype.CheckClear = function () {
        var vecTextLengthData = new Array();
        var answerData = this.m_pGameWorld.GetStageData().stageEntry.data;
        for (var kk = 0; kk < answerData.length; kk++) {
            var answerPosList = answerData[kk];
            var org_average_pos = new dVector2();
            var org_poses = new Array();
            for (var i = 0; i < answerPosList.length; i += 2) {
                org_average_pos.x += Number(answerPosList[i]);
                org_average_pos.y += Number(answerPosList[i + 1]);
            }
            org_average_pos.DivAppendF(answerPosList.length / 2);
            for (var i = 0; i < answerPosList.length; i += 2) {
                org_poses.push(new dVector2(Number(answerPosList[i]) - org_average_pos.x, Number(answerPosList[i + 1]) - org_average_pos.y));
            }
            var user_average_pos = new dVector2();
            var user_poses = new Array();
            var user_char = new Array();
            var vecvecWords = this.FindWordSpriteByString();
            var lastLength = 99999;
            var textLengthData = null;
            for (var k = 0; k < vecvecWords.length; k++) {
                var vecWords = vecvecWords[k];
                user_poses.clear();
                user_char.clear();
                user_average_pos.SetValue(0, 0);
                for (var i = 0; i < vecWords.length; i++) {
                    user_average_pos.x += vecWords[i].positionX;
                    user_average_pos.y += vecWords[i].positionY;
                }
                user_average_pos.DivAppendF(vecWords.length);
                for (var i = 0; i < vecWords.length; i++) {
                    user_poses.push(new dVector2(vecWords[i].positionX - user_average_pos.x, vecWords[i].positionY - user_average_pos.y));
                }
                var lengthAdd = 0;
                for (var i = 0; i < org_poses.length; i++) {
                    lengthAdd += org_poses[i].LengthTo(user_poses[i]) / vecWords[i].scaleX;
                }
                lengthAdd /= org_poses.length;
                if (textLengthData == null || lastLength > lengthAdd) {
                    lastLength = lengthAdd;
                    textLengthData = new TextLengthData();
                    var index = kk;
                    if (index > this.m_pGameWorld.GetStageData().stageEntry.answer.length - 1)
                        index = this.m_pGameWorld.GetStageData().stageEntry.answer.length - 1;
                    textLengthData.text = this.m_pGameWorld.GetStageData().stageEntry.answer[index];
                    textLengthData.length = lengthAdd;
                }
            }
            if (textLengthData)
                vecTextLengthData.push(textLengthData);
        }
        vecTextLengthData.sort(function (a, b) {
            return a.length - b.length;
        });
        for (var i = 0; i < vecTextLengthData.length; i++) {
            if (vecTextLengthData[i].length < 30) {
                this.ZiBack_Zi.text = vecTextLengthData[i].text;
                this.ZiBack_Zi.visible = true;
                for (var i = 0; i < this.m_vecLabels.length; i++)
                    this.m_vecLabels[i].visible = false;
                this.OnPassWordRight();
                break;
            }
        }
    };
    LevelYibushou.prototype.FindWordSpriteByString = function () {
        var list = new Array();
        list.push(this.m_vecLabels);
        return list;
    };
    LevelYibushou.prototype.OutputLabelsPos = function () {
        var str = "";
        for (var i = 0; i < this.m_vecLabels.length; i++) {
            if (i > 0)
                str += ",";
            str += dMath.ToInt(this.m_vecLabels[i].positionX) + "," + dMath.ToInt(this.m_vecLabels[i].positionY);
        }
        console.log(str);
        dInterface.FrameSetClipboard(str);
    };
    LevelYibushou.prototype.GetHintText = function () {
        return this.m_pGameWorld.GetStageData().stageEntry.answer[0];
    };
    LevelYibushou.prototype.GetHintImage = function () {
        var label = new dBitmapFont();
        label.LoadFromFile("data/font200.json");
        label.fontSize = 200;
        label.spriteColor = 0xff000000;
        label.text = this.GetHintText();
        return label;
    };
    return LevelYibushou;
}(LevelBase));
var TextLengthData = (function () {
    function TextLengthData() {
        this.text = "";
        this.length = 0;
    }
    return TextLengthData;
}());
var LevelYiyibi = (function (_super) {
    __extends(LevelYiyibi, _super);
    function LevelYiyibi() {
        var _this = _super.call(this) || this;
        _this.m_vecAnswers = new Array();
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        return _this;
    }
    LevelYiyibi.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Back", "classType": "dImage", "clipChild": 1, "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Zi", "classType": "dBitmapFont", "fontSize": 600, "height": 594, "resourceFileName": "data/font200.json", "spriteColor": -16777216, "text": "", "width": 600, "x": 0, "y": -62 }], "anchorU": 0.5, "anchorV": 0.5, "className": "ZiBack", "classType": "dImage", "height": 779, "resourceFileName": "data/zi1.png", "width": 778, "x": 0, "y": 0 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "width": 1080, "x": 0, "y": 0 }; };
    LevelYiyibi.prototype.Init = function (pGameWorld) {
        var _this = this;
        _super.prototype.Init.call(this, pGameWorld);
        var quest = this.m_pGameWorld.GetStageData().stageEntry.quest[0];
        this.ZiBack_Zi.visible = false;
        var zi = null;
        switch (quest) {
            case "":
                zi = new Yiyibi_Wei();
                break;
            case "":
                zi = new Yiyibi_Zhu();
                break;
            case "":
                zi = new Yiyibi_Gan();
                break;
            case "":
                zi = new Yiyibi_Ping();
                break;
            case "":
                zi = new Yiyibi_Zi();
                break;
            case "":
                zi = new Yiyibi_Mu();
                break;
            case "":
                zi = new Yiyibi_Zuo();
                break;
            case "":
                zi = new Yiyibi_Jiu();
                break;
            case "":
                zi = new Yiyibi_Tong();
                break;
            case "":
                zi = new Yiyibi_Kai();
                break;
        }
        var vec = new Array();
        vec.copy(zi.GetChildList());
        for (var i = 0; i < vec.length; i++) {
            if (vec[i] instanceof dImage) {
                if (vec[i].spriteName.indexOf("Answer") == 0) {
                    this.m_vecAnswers.push(vec[i]);
                    vec[i].visible = false;
                }
                else {
                    var newImage = new dImage();
                    newImage.LoadFromFile(vec[i].resourceFileName);
                    newImage.SetScale(vec[i].scaleX, vec[i].scaleY);
                    newImage.SetPos(vec[i].positionX, vec[i].positionY);
                    newImage.spriteColor = 0xffd0d0d0;
                    zi.AddChild(newImage, i);
                    vec[i].spriteColor = 0xff000000;
                    var canDrag = new CanDrag(vec[i]);
                    canDrag.canDragOutsideScreen = true;
                    canDrag.isTouchUpSetOrgPos = true;
                    canDrag.touchDownMakeToTop = false;
                    canDrag.touchDownPlaySound = "data/sound/click.mp3";
                    canDrag.touchUpPlaySound = "data/sound/button.mp3";
                    canDrag.onTouchUp = function (canDrag2) {
                        if (_this.CheckClear(canDrag2.m_target)) {
                            zi.visible = false;
                            _this.ZiBack_Zi.visible = true;
                        }
                    };
                }
            }
        }
        zi.alpha = 0;
        this.AddChild(zi);
    };
    LevelYiyibi.prototype.CheckClear = function (p) {
        for (var i = 0; i < this.m_vecAnswers.length; i++) {
            if (this.m_vecAnswers[i].resourceFileName == p.resourceFileName) {
                var len = this.m_vecAnswers[i].GetPosVector2().LengthTo(p.GetPosVector2());
                if (len < 100) {
                    var index = i;
                    if (index > this.m_pGameWorld.GetStageData().stageEntry.answer.length - 1)
                        index = this.m_pGameWorld.GetStageData().stageEntry.answer.length - 1;
                    this.ZiBack_Zi.text = this.m_pGameWorld.GetStageData().stageEntry.answer[index];
                    this.OnPassWordRight();
                    return true;
                }
            }
        }
        return false;
    };
    LevelYiyibi.prototype.GetHintImage = function () {
        var label = new dBitmapFont();
        label.LoadFromFile("data/font200.json");
        label.fontSize = 200;
        label.spriteColor = 0xff000000;
        label.text = this.GetHintText();
        return label;
    };
    return LevelYiyibi;
}(LevelBase));
var dButtonScale9 = (function (_super) {
    __extends(dButtonScale9, _super);
    function dButtonScale9() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.m_repeatType = false;
        return _this;
    }
    dButtonScale9.prototype.CreateImage = function () {
        var ret = new dScale9();
        ret.repeatType = this.m_repeatType;
        return ret;
    };
    Object.defineProperty(dButtonScale9.prototype, "repeatType", {
        get: function () {
            return this.m_repeatType;
        },
        set: function (bRepeatType) {
            this.m_repeatType = bRepeatType;
            if (this.m_pNormal instanceof dScale9)
                this.m_pNormal.repeatType = bRepeatType;
            if (this.m_pTouchDown instanceof dScale9)
                this.m_pTouchDown.repeatType = bRepeatType;
        },
        enumerable: false,
        configurable: true
    });
    return dButtonScale9;
}(dButton));
var LevelZhaobutongBlock = (function (_super) {
    __extends(LevelZhaobutongBlock, _super);
    function LevelZhaobutongBlock(pGameWorld) {
        var _this = _super.call(this) || this;
        _this.m_pGameWorld = null;
        _this.m_pBody = null;
        _this.m_pShape = null;
        _this.m_wrongImage = null;
        _this.m_rightImage = null;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.m_pGameWorld = pGameWorld;
        return _this;
    }
    LevelZhaobutongBlock.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 90, "height": 101.25, "resourceFileName": "data/font2.json", "spriteColor": -16777216, "text": "", "width": 90, "x": 0, "y": -6 }], "anchorU": 0.5, "anchorV": 0.5, "className": "QuestBack", "classType": "dButtonScale9", "height": 115, "resourceFileName": "data/zi6.png", "width": 115, "x": 0, "y": 0 }; };
    LevelZhaobutongBlock.prototype.ReleaseBody = function () {
        if (this.m_pBody != null) {
            this.m_pBody.Release();
            this.m_pBody = null;
        }
    };
    LevelZhaobutongBlock.prototype.UpdateBody = function () {
        if (this.m_pGameWorld != null) {
            if (this.m_pBody == null) {
                this.m_pBody = this.m_pGameWorld.GetBox2D().CreateBody(this);
                this.m_pBody.SetType(dBox2D.b2_dynamicBody);
                this.m_pBody.SetFixedRotation(false);
                this.m_pBody.SetPos(this.positionX, this.positionY);
            }
            else {
                this.m_pBody.RemoveAllShape();
            }
            var shape = new dBox2DBoxShape(-this.width / 2, -this.height / 2, this.width / 2, this.height / 2, 1, 1, 0);
            this.m_pBody.AddShape(shape);
            this.m_pShape = shape;
            this.m_pBody.SetLinearVelocity(0, 100);
        }
    };
    LevelZhaobutongBlock.prototype.GetVelocityY = function () {
        return this.m_pBody.GetLinearVelocityY();
    };
    LevelZhaobutongBlock.prototype.SetShowHint = function () {
        var color = dMath.ColorToValue(0xffef9898);
        CCActionManager.Instance().AddAction(new CCRepeatForever(new CCSequence([
            new CCTintTo(0.5, color.x, color.y, color.z, 1, false, true),
            new CCTintTo(0.5, 1, 1, 1, 1, false, true),
        ])), this);
    };
    LevelZhaobutongBlock.prototype.SetRotation = function (angle) {
        _super.prototype.SetRotation.call(this, angle);
        if (this.m_wrongImage)
            this.m_wrongImage.rotation = -angle;
        if (this.m_rightImage)
            this.m_rightImage.rotation = -angle;
    };
    LevelZhaobutongBlock.prototype.ShowWrong = function () {
        var wrong = new dImage();
        wrong.LoadFromFile("data/wrong.png");
        this.AddChild(wrong);
        wrong.SetScale(0, 0);
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCScaleTo(0.1, 1, 1),
            new CCRotateTo(0.1, -20),
            new CCRotateTo(0.1, 20),
            new CCRotateTo(0.1, -20),
            new CCRotateTo(0.1, 20),
            new CCRotateTo(0.1, 0),
            new CCRemoveSelf()
        ]), wrong);
        dSound.PlaySound("data/sound/wrong.mp3");
        this.m_wrongImage = wrong;
        this.m_wrongImage.rotation = -this.rotation;
    };
    LevelZhaobutongBlock.prototype.ShowRight = function () {
        var right = new dImage();
        right.LoadFromFile("data/right.png");
        right.spriteColor = 0xff32fb3b;
        this.AddChild(right);
        right.SetScale(0, 0);
        right.SetPos(0, 0);
        CCActionManager.Instance().AddAction(new CCSequence([
            new CCScaleTo(0.1, 1, 1)
        ]), right);
        this.Text.edgeColor = this.Text.spriteColor;
        this.spriteColor = 0xffffffff;
        CCActionManager.Instance().RemoveAllActionsFromTarget(this);
        dSound.PlaySound("data/sound/right.mp3");
        this.m_rightImage = right;
        this.m_rightImage.rotation = -this.rotation;
    };
    return LevelZhaobutongBlock;
}(dButtonScale9));
var LevelZhaobutong = (function (_super) {
    __extends(LevelZhaobutong, _super);
    function LevelZhaobutong() {
        var _this = _super.call(this) || this;
        _this.m_pBox2D = null;
        _this.m_pShape = null;
        _this.m_vecBlocks = new Array();
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        return _this;
    }
    LevelZhaobutong.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Back", "classType": "dImage", "clipChild": 1, "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -723725, "width": 1080, "x": 0, "y": 0 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage6", "classType": "dImage", "height": 100, "pureColor": 1, "width": 1000, "x": 0, "y": 885 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "ShapeLeft", "classType": "dImage", "height": 2500, "pureColor": 1, "width": 200, "x": -535, "y": -394 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "ShapeRight", "classType": "dImage", "height": 2500, "pureColor": 1, "width": 200, "x": 535, "y": -394 }], "anchorU": 0, "anchorV": 0, "className": "ShapeList", "classType": "dSprite", "height": 0, "width": 0, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 1500, "pureColor": 1, "spriteColor": -16777216, "width": 40, "x": -455, "y": 124 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 1500, "pureColor": 1, "spriteColor": -16777216, "width": 40, "x": 455, "y": 124 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 40, "pureColor": 1, "spriteColor": -16777216, "width": 900, "x": 0, "y": 854 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "width": 1080, "x": 0, "y": 0 }; };
    LevelZhaobutong.prototype.Destroy = function () {
        _super.prototype.Destroy.call(this);
        this.m_pBox2D.Release();
    };
    LevelZhaobutong.prototype.Init = function (pGameWorld) {
        var _this = this;
        _super.prototype.Init.call(this, pGameWorld);
        this.m_pBox2D = new dBox2D(0, 100, true);
        var vecShapeList = this.ShapeList.GetChildList();
        for (var i = 0; i < vecShapeList.length; i++) {
            var box = vecShapeList[i];
            var body = this.m_pBox2D.CreateBody(null);
            body.SetType(dBox2D.b2_staticBody);
            body.SetRotation(box.rotation);
            body.SetPos(box.positionX, box.positionY);
            body.AddShape(new dBox2DBoxShape(-box.width / 2, -box.height / 2, box.width / 2, box.height / 2, 0, 1, 0));
        }
        this.ShapeList.visible = false;
        var stageEntry = this.m_pGameWorld.GetStageData().stageEntry;
        var answerIndex = dMath.RandomI() % 64;
        new dTimer(this).Create(0, 0, function (sender, iTimer, fTimer) {
            _this.OnFrameMove(fTimer);
        });
        new dTimer(this).Create(50, 64, function (sender, iTimer, fTimer) {
            if (iTimer == answerIndex)
                _this.AddBlock(stageEntry.answer[0]);
            else
                _this.AddBlock(stageEntry.quest[0]);
        });
    };
    LevelZhaobutong.prototype.AddBlock = function (str) {
        var _this = this;
        var p = new LevelZhaobutongBlock(this);
        this.AddChild(p);
        p.SetPos(dMath.RandomRange(-350, 350), -600);
        p.rotation = dMath.RandomI() % 360;
        p.UpdateBody();
        p.Text.text = str;
        this.m_vecBlocks.push(p);
        p.SetEvent(new dEvent().SetOnButtonDown(function () {
            if (p.Text.text == _this.m_pGameWorld.GetStageData().stageEntry.answer[0]) {
                _this.OnPassWordRight();
                p.ShowRight();
            }
            else
                p.ShowWrong();
            dSound.PlaySound("data/sound/button.mp3");
        }));
    };
    LevelZhaobutong.prototype.OnShowHint = function () {
        for (var i = 0; i < this.m_vecBlocks.length; i++) {
            if (this.m_vecBlocks[i].Text.text == this.m_pGameWorld.GetStageData().stageEntry.answer[0])
                this.m_vecBlocks[i].SetShowHint();
        }
    };
    LevelZhaobutong.prototype.GetBox2D = function () {
        return this.m_pBox2D;
    };
    LevelZhaobutong.prototype.OnFrameMove = function (fTimer) {
        this.m_pBox2D.FrameMove(dMath.Min(fTimer, 0.05), 8, 8);
    };
    LevelZhaobutong.prototype.GetHintImage = function () {
        var label = new dBitmapFont();
        label.LoadFromFile("data/font200.json");
        label.fontSize = 200;
        label.spriteColor = 0xff000000;
        label.text = this.GetHintText();
        return label;
    };
    return LevelZhaobutong;
}(LevelBase));
var Yibushou_bei = (function (_super) {
    __extends(Yibushou_bei, _super);
    function Yibushou_bei() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_bei.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 360, "resourceFileName": "data/level/yibushou/543.png", "width": 329, "x": 57, "y": 61 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 325, "resourceFileName": "data/level/yibushou/542.png", "width": 247, "x": 79, "y": -58 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 206, "resourceFileName": "data/level/yibushou/541.png", "width": 191, "x": -141, "y": -4 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_bei;
}(dImage));
var Yibushou_biao = (function (_super) {
    __extends(Yibushou_biao, _super);
    function Yibushou_biao() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_biao.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 169, "resourceFileName": "data/level/yibushou/561.png", "width": 330, "x": 92, "y": -122 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 308, "resourceFileName": "data/level/yibushou/562.png", "width": 336, "x": 104, "y": 77 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 498, "resourceFileName": "data/level/yibushou/563.png", "width": 213, "x": -162, "y": -16 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_biao;
}(dImage));
var Yibushou_guo = (function (_super) {
    __extends(Yibushou_guo, _super);
    function Yibushou_guo() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_guo.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 475, "resourceFileName": "data/level/yibushou/532.png", "width": 409, "x": 4, "y": 18, "z": -1.073025 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 223, "resourceFileName": "data/level/yibushou/533.png", "width": 514, "x": 30, "y": 101, "z": -1.073025 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 205, "resourceFileName": "data/level/yibushou/531.png", "width": 339, "x": 6, "y": -142, "z": -1.073025 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_guo;
}(dImage));
var Yibushou_he = (function (_super) {
    __extends(Yibushou_he, _super);
    function Yibushou_he() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_he.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 267, "resourceFileName": "data/level/yibushou/521.png", "width": 274, "x": -107, "y": -146 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 151, "resourceFileName": "data/level/yibushou/522.png", "width": 204, "x": 136, "y": -166 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 337, "resourceFileName": "data/level/yibushou/523.png", "width": 325, "x": -7, "y": 100 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_he;
}(dImage));
var Yibushou_he2 = (function (_super) {
    __extends(Yibushou_he2, _super);
    function Yibushou_he2() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_he2.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 272, "resourceFileName": "data/level/yibushou/591.png", "width": 458, "x": 18, "y": -125 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 256, "resourceFileName": "data/level/yibushou/593.png", "width": 377, "x": 19, "y": 122 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 48, "resourceFileName": "data/level/yibushou/592.png", "width": 166, "x": -4, "y": -39 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_he2;
}(dImage));
var Yibushou_jia = (function (_super) {
    __extends(Yibushou_jia, _super);
    function Yibushou_jia() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_jia.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 419, "resourceFileName": "data/level/yibushou/601.png", "width": 297, "x": -115, "y": -11 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 212, "resourceFileName": "data/level/yibushou/602.png", "width": 238, "x": 155, "y": 27 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_jia;
}(dImage));
var Yibushou_wang = (function (_super) {
    __extends(Yibushou_wang, _super);
    function Yibushou_wang() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_wang.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 66, "resourceFileName": "data/level/yibushou/551.png", "width": 210, "x": 61, "y": -147 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 342, "resourceFileName": "data/level/yibushou/552.png", "width": 346, "x": 82, "y": 24 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 340, "resourceFileName": "data/level/yibushou/553.png", "width": 154, "x": -139, "y": 10 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_wang;
}(dImage));
var Yibushou_wu = (function (_super) {
    __extends(Yibushou_wu, _super);
    function Yibushou_wu() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_wu.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 167, "resourceFileName": "data/level/yibushou/501.png", "width": 271, "x": -9, "y": -157 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 312, "resourceFileName": "data/level/yibushou/502.png", "width": 490, "x": 17, "y": 71 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_wu;
}(dImage));
var Yibushou_xing = (function (_super) {
    __extends(Yibushou_xing, _super);
    function Yibushou_xing() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_xing.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 355, "resourceFileName": "data/level/yibushou/511.png", "width": 519, "x": 17, "y": -88 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 198, "resourceFileName": "data/level/yibushou/512.png", "width": 288, "x": 10, "y": 152 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_xing;
}(dImage));
var Yibushou_yin = (function (_super) {
    __extends(Yibushou_yin, _super);
    function Yibushou_yin() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_yin.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 228, "resourceFileName": "data/level/yibushou/571.png", "width": 276, "x": 12, "y": -144 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 246, "resourceFileName": "data/level/yibushou/572.png", "width": 247, "x": 15, "y": 130 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 84, "resourceFileName": "data/level/yibushou/573.png", "width": 524, "x": 12, "y": -16 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_yin;
}(dImage));
var Yibushou_yun = (function (_super) {
    __extends(Yibushou_yun, _super);
    function Yibushou_yun() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yibushou_yun.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 148, "resourceFileName": "data/level/yibushou/581.png", "width": 255, "x": -2, "y": -195 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 140, "resourceFileName": "data/level/yibushou/582.png", "width": 464, "x": 11, "y": -66 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 362, "resourceFileName": "data/level/yibushou/583.png", "width": 455, "x": 6, "y": 83 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yibushou_yun;
}(dImage));
var Yiyibi_Gan = (function (_super) {
    __extends(Yiyibi_Gan, _super);
    function Yiyibi_Gan() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Gan.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 229, "resourceFileName": "data/level/yiyibi/gan2.png", "width": 170, "x": -190, "y": 37 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 55, "resourceFileName": "data/level/yiyibi/gan3.png", "width": 61, "x": -52, "y": 18 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage4", "classType": "dImage", "height": 498, "resourceFileName": "data/level/yiyibi/gan4.png", "width": 58, "x": -97, "y": -18 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 62, "resourceFileName": "data/level/yiyibi/gan1.png", "width": 217, "x": -111, "y": -85 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage5", "classType": "dImage", "height": 56, "resourceFileName": "data/level/yiyibi/gan5.png", "width": 218, "x": 122, "y": -174 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage6", "classType": "dImage", "height": 62, "resourceFileName": "data/level/yiyibi/gan6.png", "width": 310, "x": 129, "y": -49 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage7", "classType": "dImage", "height": 428, "resourceFileName": "data/level/yiyibi/gan7.png", "width": 44, "x": 127, "y": 41 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer1", "classType": "dImage", "height": 62, "resourceFileName": "data/level/yiyibi/gan6.png", "visible": 0, "width": 310, "x": 129, "y": 238 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer2", "classType": "dImage", "height": 56, "resourceFileName": "data/level/yiyibi/gan5.png", "visible": 0, "width": 218, "x": 122, "y": 241 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer3", "classType": "dImage", "height": 428, "resourceFileName": "data/level/yiyibi/gan7.png", "visible": 0, "width": 44, "x": 127, "y": -258 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Gan;
}(dImage));
var Yiyibi_Jiu = (function (_super) {
    __extends(Yiyibi_Jiu, _super);
    function Yiyibi_Jiu() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Jiu.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 436, "resourceFileName": "data/level/yiyibi/jiu1.png", "width": 242, "x": -119, "y": -2 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 106, "resourceFileName": "data/level/yiyibi/jiu2.png", "width": 292, "x": -72, "y": -80 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 342, "resourceFileName": "data/level/yiyibi/jiu3.png", "width": 241, "x": 150, "y": 40 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer1", "classType": "dImage", "height": 436, "resourceFileName": "data/level/yiyibi/jiu1.png", "visible": 0, "width": 242, "x": -282, "y": 153 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Jiu;
}(dImage));
var Yiyibi_Kai = (function (_super) {
    __extends(Yiyibi_Kai, _super);
    function Yiyibi_Kai() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Kai.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 67, "resourceFileName": "data/level/yiyibi/kai1.png", "width": 328, "x": -1, "y": -188 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 75, "resourceFileName": "data/level/yiyibi/kai2.png", "width": 519, "x": 6, "y": -44 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 372, "resourceFileName": "data/level/yiyibi/kai3.png", "width": 148, "x": -99, "y": 11 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage4", "classType": "dImage", "height": 444, "resourceFileName": "data/level/yiyibi/kai4.png", "width": 63, "x": 64, "y": 15 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer1", "classType": "dImage", "height": 67, "resourceFileName": "data/level/yiyibi/kai1.png", "visible": 0, "width": 328, "x": -1, "y": -110 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer2", "classType": "dImage", "height": 67, "resourceFileName": "data/level/yiyibi/kai1.png", "visible": 0, "width": 328, "x": -5, "y": 71 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Kai;
}(dImage));
var Yiyibi_Mu = (function (_super) {
    __extends(Yiyibi_Mu, _super);
    function Yiyibi_Mu() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Mu.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 439, "resourceFileName": "data/level/yiyibi/mu2.png", "width": 265, "x": 15, "y": -13 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 386, "resourceFileName": "data/level/yiyibi/mu1.png", "width": 49, "x": -115, "y": -19 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 42, "resourceFileName": "data/level/yiyibi/mu3.png", "width": 144, "x": -26, "y": -92 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage4", "classType": "dImage", "height": 41, "resourceFileName": "data/level/yiyibi/mu4.png", "width": 178, "x": -11, "y": 129 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage5", "classType": "dImage", "height": 42, "resourceFileName": "data/level/yiyibi/mu3.png", "width": 144, "x": -26, "y": 19 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer", "classType": "dImage", "height": 42, "resourceFileName": "data/level/yiyibi/mu3.png", "visible": 0, "width": 144, "x": -8, "y": 225 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Mu;
}(dImage));
var Yiyibi_Ping = (function (_super) {
    __extends(Yiyibi_Ping, _super);
    function Yiyibi_Ping() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Ping.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 70, "resourceFileName": "data/level/yiyibi/ping2.png", "width": 516, "x": -1, "y": -34 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 81, "resourceFileName": "data/level/yiyibi/ping3.png", "width": 58, "x": -98, "y": -119 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage5", "classType": "dImage", "height": 475, "resourceFileName": "data/level/yiyibi/ping5.png", "width": 52, "x": -1, "y": 8 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 54, "resourceFileName": "data/level/yiyibi/ping1.png", "width": 217, "x": -3, "y": -229 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage4", "classType": "dImage", "height": 116, "resourceFileName": "data/level/yiyibi/ping4.png", "width": 116, "x": 108, "y": -143 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer1", "classType": "dImage", "height": 54, "resourceFileName": "data/level/yiyibi/ping1.png", "visible": 0, "width": 217, "x": -3, "y": -95 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer2", "classType": "dImage", "height": 54, "resourceFileName": "data/level/yiyibi/ping1.png", "visible": 0, "width": 217, "x": -3, "y": 76 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Ping;
}(dImage));
var Yiyibi_Tong = (function (_super) {
    __extends(Yiyibi_Tong, _super);
    function Yiyibi_Tong() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Tong.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 505, "resourceFileName": "data/level/yiyibi/tong2.png", "width": 403, "x": -1, "y": 3 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage5", "classType": "dImage", "height": 127, "resourceFileName": "data/level/yiyibi/tong5.png", "width": 205, "x": 2, "y": 6 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 435, "resourceFileName": "data/level/yiyibi/tong1.png", "width": 53, "x": -177, "y": 6 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage4", "classType": "dImage", "height": 146, "resourceFileName": "data/level/yiyibi/tong4.png", "width": 63, "x": -83, "y": 45 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage6", "classType": "dImage", "height": 40, "resourceFileName": "data/level/yiyibi/tong6.png", "width": 145, "x": 7, "y": 75 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 46, "resourceFileName": "data/level/yiyibi/tong3.png", "width": 192, "x": -13, "y": -113 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer1", "classType": "dImage", "height": 46, "resourceFileName": "data/level/yiyibi/tong3.png", "visible": 0, "width": 192, "x": -37, "y": 184 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Tong;
}(dImage));
var Yiyibi_Wei = (function (_super) {
    __extends(Yiyibi_Wei, _super);
    function Yiyibi_Wei() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Wei.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage4", "classType": "dImage", "height": 230, "resourceFileName": "data/level/yiyibi/wei4.png", "width": 218, "x": -105.992065, "y": 80 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage5", "classType": "dImage", "height": 210, "resourceFileName": "data/level/yiyibi/wei5.png", "width": 297, "x": 149, "y": 68 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 540, "resourceFileName": "data/level/yiyibi/wei3.png", "width": 69, "x": 11, "y": 3 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 61, "resourceFileName": "data/level/yiyibi/wei1.png", "width": 187, "x": 2, "y": -122 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 99, "resourceFileName": "data/level/yiyibi/wei2.png", "width": 362, "x": 0, "y": -30 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer1", "classType": "dImage", "height": 61, "resourceFileName": "data/level/yiyibi/wei1.png", "visible": 0, "width": 187, "x": 0, "y": 113 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer2", "classType": "dImage", "height": 99, "resourceFileName": "data/level/yiyibi/wei2.png", "visible": 0, "width": 362, "x": 0, "y": -202 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer3", "classType": "dImage", "height": 540, "resourceFileName": "data/level/yiyibi/wei3.png", "visible": 0, "width": 69, "x": 11, "y": 158 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer4", "classType": "dImage", "height": 61, "resourceFileName": "data/level/yiyibi/wei1.png", "visible": 0, "width": 187, "x": 2, "y": -264 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Wei;
}(dImage));
var Yiyibi_Zhu = (function (_super) {
    __extends(Yiyibi_Zhu, _super);
    function Yiyibi_Zhu() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Zhu.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 77, "resourceFileName": "data/level/yiyibi/zhu1.png", "width": 97, "x": -14, "y": -202 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 67, "resourceFileName": "data/level/yiyibi/zhu2.png", "width": 287, "x": -1, "y": -113 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 63, "resourceFileName": "data/level/yiyibi/zhu3.png", "width": 256, "x": 1, "y": 13 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage4", "classType": "dImage", "height": 81, "resourceFileName": "data/level/yiyibi/zhu4.png", "width": 520, "x": 13, "y": 169 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage5", "classType": "dImage", "height": 268, "resourceFileName": "data/level/yiyibi/zhu5.png", "width": 52, "x": 0, "y": 27 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer1", "classType": "dImage", "height": 77, "resourceFileName": "data/level/yiyibi/zhu1.png", "visible": 0, "width": 97, "x": 123, "y": 78 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Zhu;
}(dImage));
var Yiyibi_Zi = (function (_super) {
    __extends(Yiyibi_Zi, _super);
    function Yiyibi_Zi() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Zi.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage4", "classType": "dImage", "height": 408, "resourceFileName": "data/level/yiyibi/zia4.png", "width": 289, "x": 15, "y": 66 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 152, "resourceFileName": "data/level/yiyibi/zia1.png", "width": 103, "x": -34, "y": -179 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 43, "resourceFileName": "data/level/yiyibi/zia2.png", "width": 153, "x": -32, "y": -2 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 344, "resourceFileName": "data/level/yiyibi/zia3.png", "width": 45, "x": -120, "y": 61 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage5", "classType": "dImage", "height": 33, "resourceFileName": "data/level/yiyibi/zia5.png", "width": 198, "x": -6, "y": 181 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage6", "classType": "dImage", "height": 43, "resourceFileName": "data/level/yiyibi/zia2.png", "width": 153, "x": -32, "y": 93 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer1", "classType": "dImage", "height": 43, "resourceFileName": "data/level/yiyibi/zia2.png", "visible": 0, "width": 153, "x": -26, "y": -256 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Zi;
}(dImage));
var Yiyibi_Zuo = (function (_super) {
    __extends(Yiyibi_Zuo, _super);
    function Yiyibi_Zuo() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    Yiyibi_Zuo.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 200, "resourceFileName": "data/level/yiyibi/zuo1.png", "width": 151, "x": -128, "y": -87 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 83, "resourceFileName": "data/level/yiyibi/zuo2.png", "width": 75, "x": -75, "y": -41 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage3", "classType": "dImage", "height": 437, "resourceFileName": "data/level/yiyibi/zuo3.png", "width": 62, "x": 14, "y": -25 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage4", "classType": "dImage", "height": 58, "resourceFileName": "data/level/yiyibi/zuo4.png", "width": 259, "x": 13.797516, "y": 54.276215, "z": 5.093895 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage5", "classType": "dImage", "height": 65, "resourceFileName": "data/level/yiyibi/zuo5.png", "width": 480, "x": 14, "y": 194 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage6", "classType": "dImage", "height": 200, "resourceFileName": "data/level/yiyibi/zuo1.png", "width": 151, "x": 115, "y": -94 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage7", "classType": "dImage", "height": 83, "resourceFileName": "data/level/yiyibi/zuo2.png", "width": 75, "x": 168, "y": -48 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Answer1", "classType": "dImage", "height": 58, "resourceFileName": "data/level/yiyibi/zuo4.png", "visible": 0, "width": 259, "x": 13.797516, "y": -248.723785, "z": 5.093895 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dImage", "height": 600, "pureColor": 1, "spriteColor": -16777216, "width": 600, "x": 0, "y": 0 }; };
    return Yiyibi_Zuo;
}(dImage));
var AddEnergyPanel = (function (_super) {
    __extends(AddEnergyPanel, _super);
    function AddEnergyPanel(onAddEnergyClose) {
        if (onAddEnergyClose === void 0) { onAddEnergyClose = null; }
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        _this.Window_CloseButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            PageManager.Instance().ClosePanel(null, _this);
            if (onAddEnergyClose)
                onAddEnergyClose(_this);
        }));
        _this.Window_CloseButton2.SetEvent(_this.Window_CloseButton.GetEvent());
        _this.Window_AddButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            MyAd.ShowAdRewardedVideoTrace("AddEnergy", function () {
                PageManager.Instance().ClosePanel(null, _this, null, false);
                SaveData.Instance().energy += 5;
                SaveData.Instance().WriteToDisk();
                PageManager.Instance().UpdateCurPage();
            });
        }));
        return _this;
    }
    AddEnergyPanel.prototype._dscData = function () { return { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 120, "resourceFileName": "data/energyicon.png", "scaleX": 1.5, "scaleY": 1.5, "width": 72, "x": 0, "y": -90 }, { "align": 0, "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 48, "height": 56.25, "resourceFileName": "data/font64.json", "spriteColor": -12632257, "text": "+5", "width": 386.25, "x": 0, "y": 94 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 46.875, "resourceFileName": "data/font64.json", "spriteColor": -12632257, "text": "", "width": 160, "x": 32, "y": -9 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "AdIcon", "classType": "dImage", "height": 46, "resourceFileName": "data/adicon.png", "spriteColor": -12632257, "width": 66, "x": -88, "y": -4 }], "anchorU": 0.5, "anchorV": 0.5, "className": "AddButton", "classType": "dButtonScale9", "height": 116, "resourceFileName": "data/button1.png", "width": 300, "x": -200, "y": 236.5 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton", "classType": "dButton", "height": 109, "resourceFileName": "data/closebutton.png", "width": 109, "x": 425, "y": -367 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 45.625, "resourceFileName": "data/font64.json", "spriteColor": -12632257, "text": "", "width": 80, "x": 0, "y": -9 }], "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton2", "classType": "dButtonScale9", "height": 116, "resourceFileName": "data/button1.png", "width": 300, "x": 200, "y": 236.5 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "TitleText", "classType": "dBitmapFont", "fontSize": 64, "height": 72, "resourceFileName": "data/font64.json", "spriteColor": -1476488, "text": "", "width": 192, "x": 0, "y": 50 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Title", "classType": "dImage", "height": 144, "resourceFileName": "", "width": 590, "x": 0, "y": -367.5 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Window", "classType": "dScale9", "height": 800, "resourceFileName": "data/window.png", "width": 900, "x": 550, "y": 936.5 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "MyAdBanner", "classType": "MyAdBanner", "height": 200, "layoutAlignV": 2, "width": 1080, "x": 540, "y": 1820 }], "anchorU": 0, "anchorV": 0, "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -2147483648, "width": 1080, "x": 0, "y": 0 }; };
    return AddEnergyPanel;
}(dImage));
var AddKeyPanel = (function (_super) {
    __extends(AddKeyPanel, _super);
    function AddKeyPanel() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        _this.Window_CloseButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            PageManager.Instance().ClosePanel(null, _this);
        }));
        _this.Window_CloseButton2.SetEvent(_this.Window_CloseButton.GetEvent());
        _this.Window_AddButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            MyAd.ShowAdRewardedVideoTrace("AddKey", function () {
                PageManager.Instance().ClosePanel(null, _this, null, false);
                SaveData.Instance().WriteToDisk();
                PageManager.Instance().UpdateCurPage();
            });
        }));
        return _this;
    }
    AddKeyPanel.prototype._dscData = function () { return { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 96, "resourceFileName": "", "scaleX": 1.5, "scaleY": 1.5, "width": 72, "x": 0, "y": -90 }, { "align": 0, "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 48, "height": 56.25, "resourceFileName": "data/font64.json", "spriteColor": -12632257, "text": "+1", "width": 385.5, "x": 0, "y": 94 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 46.875, "resourceFileName": "data/font64.json", "spriteColor": -12632257, "text": "", "width": 160, "x": 32, "y": -5 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "AdIcon", "classType": "dImage", "height": 46, "resourceFileName": "data/adicon.png", "spriteColor": -12632257, "width": 66, "x": -88, "y": -4 }], "anchorU": 0.5, "anchorV": 0.5, "className": "AddButton", "classType": "dButtonScale9", "height": 116, "resourceFileName": "data/button1.png", "width": 300, "x": -200, "y": 236.5 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton", "classType": "dButton", "height": 109, "resourceFileName": "data/closebutton.png", "width": 109, "x": 425, "y": -367 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 45.625, "resourceFileName": "data/font64.json", "spriteColor": -12632257, "text": "", "width": 80, "x": 0, "y": -5 }], "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton2", "classType": "dButtonScale9", "height": 116, "resourceFileName": "data/button1.png", "width": 300, "x": 200, "y": 236.5 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "TitleText", "classType": "dBitmapFont", "fontSize": 64, "height": 73, "resourceFileName": "data/font64.json", "spriteColor": -1476488, "text": "", "width": 192, "x": 0, "y": 41 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Title", "classType": "dImage", "height": 144, "resourceFileName": "", "width": 590, "x": 0, "y": -367.5 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Window", "classType": "dScale9", "height": 800, "resourceFileName": "data/window.png", "width": 900, "x": 550, "y": 936.5 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "MyAdBanner", "classType": "MyAdBanner", "height": 200, "layoutAlignV": 2, "width": 1080, "x": 540, "y": 1820 }], "anchorU": 0, "anchorV": 0, "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -2147483648, "width": 1080, "x": 0, "y": 0 }; };
    return AddKeyPanel;
}(dImage));
var HintPanel = (function (_super) {
    __extends(HintPanel, _super);
    function HintPanel(hintId, gameWorld) {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        if (gameWorld.m_bHinted) {
            if (hintId) {
                _this.OnShowHint(gameWorld, false);
            }
            _this.Window_Panel_SkipButton.visible = true;
            _this.Window_Panel_ShowButton.visible = false;
        }
        else {
            _this.Window_Panel_SkipButton.visible = false;
            _this.Window_Panel_ShowButton.visible = true;
        }
        _this.Window_Panel_CloseButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dSound.PlaySound("data/sound/button.mp3");
            PageManager.Instance().ClosePanel(null, _this);
        }));
        _this.Window_Panel_CloseButton2.SetEvent(_this.Window_Panel_CloseButton.GetEvent());
        _this.Window_Panel_ShowButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            MyAd.ShowAdRewardedVideoTrace("Hint" + gameWorld.GetStageData().stageEntry.id + "_" + gameWorld.GetStageData().stage, function () {
                gameWorld.m_bHinted = true;
                _this.Window_Panel_SkipButton.visible = true;
                if (hintId) {
                    _this.OnShowHint(gameWorld, true);
                }
            });
        }));
        _this.Window_Panel_SkipButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            MyAd.ShowAdRewardedVideoTrace("Skip" + gameWorld.GetStageData().stageEntry.id + "_" + gameWorld.GetStageData().stage, function () {
                var stageData = gameWorld.GetStageData();
                if (SaveData.Instance().passStage < stageData.stage) {
                    SaveData.Instance().passStage = stageData.stage;
                    SaveData.Instance().WriteToDisk();
                }
                stageData.stage++;
                PageManager.Instance().ClosePanel(null, _this, null, false);
                PageManager.Instance().ChangePage(GamePage, stageData);
            });
        }));
        return _this;
    }
    HintPanel.prototype._dscData = function () { return { "_child": [{ "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Title", "classType": "dImage", "height": 151, "resourceFileName": "data/title.png", "width": 744, "x": 0, "y": -566 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 0, "resourceFileName": "", "width": 0, "x": 0, "y": 0 }], "anchorU": 0.5, "anchorV": 0.5, "className": "HintBack", "classType": "dScale9", "height": 833, "resourceFileName": "data/group.png", "width": 842, "x": 0, "y": -46.5, "z": -1.253876 }, { "align": 0, "anchorU": 0.5, "anchorV": 0.5, "autoWrap": 1, "className": "Text", "classType": "dBitmapFont", "fontSize": 52, "height": 61.75, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "", "width": 762, "x": 0.002197, "y": -80.386963, "z": -2.10994 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton", "classType": "dButton", "height": 92, "resourceFileName": "data/closebutton.png", "width": 93, "x": 449, "y": -561 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 46.25, "resourceFileName": "data/font64.json", "spriteColor": -791858, "text": "", "width": 80, "x": 0, "y": -5 }], "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton2", "classType": "dButtonScale9", "height": 116, "resourceFileName": "data/button2.png", "width": 300, "x": 200, "y": 471.5, "z": -1.253876 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "TitleText", "classType": "dBitmapFont", "fontSize": 64, "height": 71, "resourceFileName": "data/font64.json", "spriteColor": -791858, "text": "", "width": 128, "x": 0, "y": -575 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 47.5, "resourceFileName": "data/font64.json", "spriteColor": -791858, "text": "", "width": 160, "x": 25, "y": -4 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "AdIcon", "classType": "dImage", "height": 46, "resourceFileName": "data/adicon.png", "scaleX": 0.782609, "scaleY": 0.782609, "spriteColor": -791858, "width": 66, "x": -86.17392, "y": -1 }], "anchorU": 0.5, "anchorV": 0.5, "className": "ShowButton", "classType": "dButtonScale9", "height": 116, "resourceFileName": "data/button1.png", "width": 300, "x": -200, "y": 471.5, "z": -1.253876 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 46.25, "resourceFileName": "data/font64.json", "spriteColor": -791858, "text": "", "width": 160, "x": 25, "y": -4 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "AdIcon", "classType": "dImage", "height": 46, "resourceFileName": "data/adicon.png", "scaleX": 0.782609, "scaleY": 0.782609, "spriteColor": -791858, "width": 66, "x": -86.17392, "y": -1 }], "anchorU": 0.5, "anchorV": 0.5, "className": "SkipButton", "classType": "dButtonScale9", "height": 116, "resourceFileName": "data/button1.png", "width": 300, "x": -200, "y": 471.5, "z": -1.253876 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Panel", "classType": "dScale9", "height": 1148, "repeatType": 1, "resourceFileName": "data/window.png", "width": 944, "x": 0, "y": 170 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Window", "classType": "dScale9", "height": 868, "resourceFileName": "", "width": 991, "x": 540, "y": 791.5 }], "anchorU": 0, "anchorV": 0, "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -2147483648, "width": 1080, "x": 0, "y": 0 }; };
    HintPanel.prototype.OnShowHint = function (gameWorld, isFirst) {
        var p = gameWorld.GetLevelBase().GetHintImage();
        if (p) {
            this.Window_Panel_Text.text = "";
            this.Window_Panel_Text.RemoveAllChild();
            this.Window_Panel_Text.AddChild(p);
        }
        else
            this.Window_Panel_Text.text = gameWorld.GetLevelBase().GetHintText();
        if (isFirst)
            gameWorld.GetLevelBase().OnShowHint();
    };
    return HintPanel;
}(dImage));
var LightEff = (function (_super) {
    __extends(LightEff, _super);
    function LightEff() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        CCActionManager.Instance().AddAction(new CCRepeatForever(new CCRotateBy(6, 360)), _this.Light);
        new dTimer(_this).Create(500, 0, function () {
            var dot = new dImage();
            dot.LoadFromFile("data/light2.png");
            _this.AddChild(dot);
            var dir = new dVector2(dMath.RandomRange(-1, 1), dMath.RandomRange(-1, 1));
            dir.Normalize();
            var time = dMath.RandomRange(2, 3);
            dot.SetPos(dir.x * 100, dir.y * 100);
            dir.MulAppendF(dMath.RandomRange(300, 400));
            CCActionManager.Instance().AddAction(new CCSequence([
                new CCSpawn([
                    new CCMoveBy(time, dir.x, dir.y),
                    new CCFadeOut(time)
                ]),
                new CCRemoveSelf()
            ]), dot);
        });
        return _this;
    }
    LightEff.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Light", "classType": "dImage", "height": 868, "resourceFileName": "data/light.png", "width": 869, "x": 0, "y": 0 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dSprite", "height": 868, "width": 869, "x": 0, "y": 0 }; };
    return LightEff;
}(dSprite));
var SelectLevelPanel = (function (_super) {
    __extends(SelectLevelPanel, _super);
    function SelectLevelPanel() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        _this.Window_CloseButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            PageManager.Instance().ClosePanel(null, _this);
        }));
        _this.Window_ListBox.blankCount = 5;
        _this.Window_ListBox.blankSpace = 3;
        _this.Window_ListBox.lineSpace = 5;
        for (var i = 0; i < 40; i++) {
            var fun = function (i) {
                var stageBar = new StageBar();
                _this.Window_ListBox.AddChild(stageBar);
                stageBar.SetEvent(new dEvent().SetOnButtonDown(function () {
                    GDefine.PlayButtonSound();
                    if (!stageBar.isLock()) {
                        PageManager.Instance().SubEnergy(function () {
                            PageManager.Instance().ClosePanel(null, _this, null, false);
                            var stageData = new StageData();
                            stageData.stage = stageBar.GetStage();
                            PageManager.Instance().ChangePage(GamePage, stageData, null, true, null, false);
                        });
                    }
                }));
            };
            fun(i);
        }
        _this.Window_ListBox.SetEvent(new dEvent().SetOnListShowVirtualChild(function (sender, childIndex, virtualIndex) {
            var stageBar = _this.Window_ListBox.GetChildListAt(childIndex);
            var stage = virtualIndex + 1;
            stageBar.SetStage(stage);
            stageBar.SetLock(stage > SaveData.Instance().passStage + 1);
        }));
        _this.Window_ListBox.SetVirtualChildCount(StageData.GetMaxStage());
        return _this;
    }
    SelectLevelPanel.prototype._dscData = function () { return { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Title", "classType": "dImage", "height": 151, "resourceFileName": "data/title.png", "width": 744, "x": 0, "y": -638 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Group", "classType": "dScale9", "height": 1149, "resourceFileName": "data/group.png", "width": 925, "x": 0, "y": 32, "z": -1.253876 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton", "classType": "dButton", "height": 92, "resourceFileName": "data/closebutton.png", "width": 93, "x": 471, "y": -636 }, { "anchorU": 0.5, "anchorV": 0.5, "canDragH": 0, "canDragV": 1, "className": "ListBox", "classType": "dListBox", "clipChild": 1, "height": 1130, "vertical": 1, "viewPosX": 0, "viewPosY": 0, "width": 880, "x": 0, "y": 28 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "TitleText", "classType": "dBitmapFont", "fontSize": 64, "height": 73, "resourceFileName": "data/font64.json", "spriteColor": -791858, "text": "", "width": 128, "x": 0, "y": -646 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Window", "classType": "dScale9", "height": 1290, "repeatType": 1, "resourceFileName": "data/window.png", "width": 1000, "x": 550, "y": 991.5 }], "anchorU": 0, "anchorV": 0, "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -2147483648, "width": 1080, "x": 0, "y": 0 }; };
    return SelectLevelPanel;
}(dImage));
var SettingPanel = (function (_super) {
    __extends(SettingPanel, _super);
    function SettingPanel(showGotoHome) {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.Update();
        _this.SetHandleMouse(true);
        _this.Panel_MusicButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            SaveData.Instance().enableMusic = !SaveData.Instance().enableMusic;
            SaveData.Instance().WriteToDisk();
            _this.Update();
        }));
        _this.Panel_SoundButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            SaveData.Instance().enableSound = !SaveData.Instance().enableSound;
            SaveData.Instance().WriteToDisk();
            _this.Update();
        }));
        _this.Panel_CloseButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            PageManager.Instance().ClosePanel(null, _this);
        }));
        _this.Panel_YinSiButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            if (dThread.GetSdkName() == "web")
                dThread.ShowHtmlDialog(MyAd.yinSiUrl);
            else {
                _this.Panel_MyAdPanel.RemoveParent();
                PageManager.Instance().OpenPanel(null, new PrivacyDialog(true, false), null, false);
            }
        }));
        _this.Panel_YongHuButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            if (dThread.GetSdkName() == "web")
                dThread.ShowHtmlDialog(MyAd.yongHuUrl);
            else {
                _this.Panel_MyAdPanel.RemoveParent();
                PageManager.Instance().OpenPanel(null, new PrivacyDialog(false, true), null, false);
            }
        }));
        if (!MyAd.isNeedShowPrivacyLink()) {
            _this.Panel_YinSiButton.visible = false;
            _this.Panel_YongHuButton.visible = false;
        }
        return _this;
    }
    SettingPanel.prototype._dscData = function () { return { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Title", "classType": "dImage", "height": 151, "resourceFileName": "data/title.png", "width": 744, "x": 0, "y": -396 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Group", "classType": "dScale9", "height": 470, "resourceFileName": "data/group.png", "width": 842, "x": 0, "y": -55, "z": -1.253876 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontEdgeColor": -16741189, "fontEdgeSize": 3, "fontSize": 48, "height": 54, "resourceFileName": "data/font64.json", "text": "Music on", "width": 183, "x": 0, "y": -4 }], "anchorU": 0.5, "anchorV": 0.5, "className": "MusicButton", "classType": "dButtonScale9", "height": 116, "resourceFileName": "data/button1.png", "visible": 0, "width": 300, "x": 0, "y": -93 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontEdgeColor": -16741189, "fontEdgeSize": 3, "fontSize": 48, "height": 54, "resourceFileName": "data/font64.json", "spriteColor": -791858, "text": "Sound on", "width": 189, "x": 0, "y": -9 }], "anchorU": 0.5, "anchorV": 0.5, "className": "SoundButton", "classType": "dButtonScale9", "height": 116, "resourceFileName": "data/button1.png", "width": 300, "x": 0, "y": -74 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "MyAdPanel", "classType": "MyAdBanner", "height": 300, "width": 886, "x": 0, "y": 785 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 46.25, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "", "width": 160, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Line", "classType": "dImage", "height": 4, "pureColor": 1, "spriteColor": -11331053, "width": 150, "x": 0, "y": 28 }], "anchorU": 0.5, "anchorV": 0.5, "className": "YongHuButton", "classType": "dButton", "height": 80, "resourceFileName": "", "spriteColor": -11331053, "width": 240, "x": 175, "y": 272 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 47.5, "resourceFileName": "data/font64.json", "spriteColor": -11331053, "text": "", "width": 160, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Line", "classType": "dImage", "height": 4, "pureColor": 1, "spriteColor": -11331053, "width": 150, "x": 0, "y": 28 }], "anchorU": 0.5, "anchorV": 0.5, "className": "YinSiButton", "classType": "dButton", "height": 80, "resourceFileName": "", "spriteColor": -11331053, "width": 240, "x": -175.5, "y": 272 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton", "classType": "dButton", "height": 92, "resourceFileName": "data/closebutton.png", "width": 93, "x": 451, "y": -392 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "TitleText", "classType": "dBitmapFont", "fontSize": 64, "height": 73, "resourceFileName": "data/font64.json", "spriteColor": -791858, "text": "", "width": 128, "x": 0, "y": -406 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Panel", "classType": "dScale9", "height": 807, "repeatType": 1, "resourceFileName": "data/window.png", "width": 956, "x": 550, "y": 911 }], "anchorU": 0, "anchorV": 0, "classType": "dImage", "height": 1920, "pureColor": 1, "spriteColor": 1677721600, "width": 1080, "x": 0, "y": 0 }; };
    SettingPanel.prototype.Update = function () {
        if (SaveData.Instance().enableMusic)
            this.Panel_MusicButton_Text.text = "";
        else
            this.Panel_MusicButton_Text.text = "";
        if (SaveData.Instance().enableSound)
            this.Panel_SoundButton_Text.text = "";
        else
            this.Panel_SoundButton_Text.text = "";
        SaveData.Instance().UpdateSound();
    };
    SettingPanel.prototype.OnExit = function () {
    };
    return SettingPanel;
}(dImage));
var SharePanel = (function (_super) {
    __extends(SharePanel, _super);
    function SharePanel(onComplete) {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        MyShareRecording.Instance().EndRecord(_this.Window_ShareButton);
        _this.Window_CloseButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            dSound.PlaySound("data/sound/button.mp3");
            PageManager.Instance().ClosePanel(null, _this);
            if (onComplete)
                onComplete();
        }));
        return _this;
    }
    SharePanel.prototype._dscData = function () { return { "_child": [{ "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 44.375, "resourceFileName": "data/font64.json", "spriteColor": -16777216, "text": "", "width": 240, "x": 35, "y": -6 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "AdIcon", "classType": "dImage", "height": 84, "resourceFileName": "data/shareicon.png", "scaleX": 0.687192, "scaleY": 0.687192, "spriteColor": -16777216, "width": 87, "x": -119.607147, "y": -3.137929 }], "anchorU": 0.5, "anchorV": 0.5, "className": "ShareButton", "classType": "dButtonScale9", "height": 123, "resourceFileName": "data/button1.png", "width": 338, "x": -224.5, "y": 200, "z": 0.993023 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 80, "height": 88.75, "resourceFileName": "data/font64.json", "spriteColor": -16777216, "text": "", "width": 320, "x": 0, "y": -271 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 40, "height": 43.75, "resourceFileName": "data/font64.json", "spriteColor": -16777216, "text": "", "width": 120, "x": 0, "y": -6 }], "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton", "classType": "dButtonScale9", "height": 123, "resourceFileName": "data/button1.png", "width": 338, "x": 189.5, "y": 200, "z": 0.993023 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Window", "classType": "dScale9", "height": 800, "resourceFileName": "data/window.png", "width": 900, "x": 550, "y": 936.5 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "MyAdBanner", "classType": "MyAdBanner", "height": 200, "layoutAlignV": 2, "width": 1080, "x": 540, "y": 1820 }], "anchorU": 0, "anchorV": 0, "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -2147483648, "width": 1080, "x": 0, "y": 0 }; };
    return SharePanel;
}(dImage));
var StageBar = (function (_super) {
    __extends(StageBar, _super);
    function StageBar() {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        return _this;
    }
    StageBar.prototype._dscData = function () { return { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Lock", "classType": "dImage", "height": 68, "resourceFileName": "data/lock.png", "spriteColor": -13848426, "width": 54, "x": 0, "y": 0 }, { "align": 0, "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 64, "height": 71, "resourceFileName": "data/font64.json", "spriteColor": -11779278, "text": "1", "width": 33, "x": 0, "y": -10 }], "anchorU": 0.5, "anchorV": 0.5, "classType": "dButton", "height": 169, "resourceFileName": "data/rbutton.png", "spriteColor": -791858, "width": 169, "x": 0, "y": 0 }; };
    StageBar.prototype.SetStage = function (stage) {
        this.Text.text = String(stage);
    };
    StageBar.prototype.GetStage = function () {
        return Number(this.Text.text);
    };
    StageBar.prototype.SetLock = function (isLock) {
        this.Lock.visible = isLock;
        this.Text.visible = !isLock;
    };
    StageBar.prototype.isLock = function () {
        return this.Lock.visible;
    };
    return StageBar;
}(dButton));
var StageClearPanel = (function (_super) {
    __extends(StageClearPanel, _super);
    function StageClearPanel(stageData) {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        _this.SetHandleMouse(true);
        MyShareRecording.Instance().EndRecord(_this.Window_ShareButton);
        MyAd.SendPassStage(stageData.stage);
        if (SaveData.Instance().passStage < stageData.stage) {
            SaveData.Instance().passStage = stageData.stage;
            SaveData.Instance().WriteToDisk();
        }
        _this.Window_NextButton.repeatType = true;
        _this.Window_ShareButton.repeatType = true;
        if (GDefine.EnableEnergy && SaveData.Instance().energy > 0) {
            SaveData.Instance().energy--;
            SaveData.Instance().WriteToDisk();
            PageManager.Instance().UpdateCurPage();
        }
        _this.Window_NextButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            GDefine.PlayButtonSound();
            PageManager.Instance().SubEnergy(function () {
                stageData.stage++;
                stageData.stage = ((stageData.stage - 1) % StageData.GetMaxStage()) + 1;
                PageManager.Instance().ClosePanel(null, _this, function () {
                    PageManager.Instance().ChangePage(GamePage, stageData);
                }, false);
            }, true);
        }));
        MyAd.ShowAdInterstitialImageTrace("StageClear");
        return _this;
    }
    StageClearPanel.prototype._dscData = function () { return { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Light", "classType": "LightEff", "x": 0, "y": -326 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 543, "resourceFileName": "data/gongxi.png", "width": 701, "x": 0, "y": -327 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 60, "height": 68.4375, "resourceFileName": "data/font64.json", "text": "", "width": 180, "x": 0, "y": -7 }], "anchorU": 0.5, "anchorV": 0.5, "className": "NextButton", "classType": "dButtonScale9", "height": 144, "resourceFileName": "data/button1.png", "width": 417, "x": -15.5, "y": 374.500244, "z": 0.596382 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dBitmapFont", "fontSize": 48, "height": 56.25, "resourceFileName": "data/font64.json", "text": "", "text_LANG_CHINESE_SIMPLIFIED": "", "width": 288, "x": 34, "y": -3 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Icon", "classType": "dImage", "height": 84, "resourceFileName": "data/shareicon.png", "scaleX": 0.655172, "scaleY": 0.655172, "width": 87, "x": -147, "y": 1.517241 }], "anchorU": 0.5, "anchorV": 0.5, "className": "ShareButton", "classType": "dButtonScale9", "height": 144, "resourceFileName": "data/button1.png", "width": 417, "x": -10, "y": 596, "z": 0.596382 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Window", "classType": "dScale9", "height": 868, "resourceFileName": "", "width": 991, "x": 540, "y": 936.5 }, { "anchorU": 0, "anchorV": 0, "className": "MyBanner", "classType": "MyAdBanner", "x": 0, "y": 1641 }], "anchorU": 0, "anchorV": 0, "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": -2147483648, "width": 1080, "x": 0, "y": 0 }; };
    return StageClearPanel;
}(dImage));
var dBitmapData = (function (_super) {
    __extends(dBitmapData, _super);
    function dBitmapData() {
        var _this = _super.call(this) || this;
        _this.m_pBufferData = null;
        return _this;
    }
    Object.defineProperty(dBitmapData, "WHITE_BITMAPDATA", {
        get: function () {
            if (dBitmapData._WHITE_BITMAPDATA == null)
                dBitmapData._WHITE_BITMAPDATA = new dBitmapData().Create(2, 2, 0xffffffff);
            return dBitmapData._WHITE_BITMAPDATA;
        },
        enumerable: false,
        configurable: true
    });
    dBitmapData.SetGlobalImageLoadComplete = function (callback) {
        if (dBitmapData.s_nGlobalLoadingCountAddRef == 0)
            callback();
        else
            dBitmapData.s_globalLoadCompleteCallback.push(callback);
    };
    dBitmapData.prototype.Release = function () {
        if (this.m_pBufferData) {
            this.m_pBufferData.Release();
            this.m_pBufferData = null;
        }
    };
    dBitmapData.prototype.Create = function (w, h, color, isRenderToTexture) {
        if (isRenderToTexture === void 0) { isRenderToTexture = 0; }
        this.Release();
        this.m_pBufferData = new __dBitmapDataBufferData();
        var canvas = this.m_pBufferData.m_pCanvas = dInterface.ptr.CreateCanvas();
        this.m_pBufferData.m_pCanvasContext = this.m_pBufferData.m_pCanvas.getContext("2d");
        this.m_pBufferData.m_bRenderToTexture = isRenderToTexture;
        canvas.width = w;
        canvas.height = h;
        this.FillColor(color);
        return this;
    };
    dBitmapData.prototype.FillColor = function (color) {
        var _this = this;
        if (color == 0xffffffff) {
            this.m_pBufferData.m_pImageData = dInterface.ptr.CreateImage();
            this.m_pBufferData.m_bLoading++;
            this.m_pBufferData.m_pImageData.onload = function () {
                _this.m_pBufferData.m_bLoading--;
            };
            this.m_pBufferData.m_pImageData.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAABRJREFUGFdj/P///38GBgYGRhgDAFfVB/vDfnUlAAAAAElFTkSuQmCC';
        }
        else {
            var ctx = this.m_pBufferData.m_pCanvasContext;
            var r = (color & 0x00ff0000) >> 16;
            var g = (color & 0x0000ff00) >> 8;
            var b = (color & 0x000000ff);
            var a = (color & 0xff000000) >>> 24;
            ctx.globalCompositeOperation = "copy";
            ctx.globalAlpha = a / 255.0;
            ctx.fillStyle = "rgb(" + r + "," + g + "," + b + ")";
            ctx.fillRect(0, 0, this.GetWidth(), this.GetHeight());
            ctx.globalAlpha = 1.0;
            ctx.globalCompositeOperation = "source-over";
        }
    };
    dBitmapData.prototype.FillText = function (text, nFontSize, nFontColor, bBold, bItalic, fLimitWidth, nAlign, flag, fWordSpace, fLineSpace, edgeSize, edgeColor, xOffset, yOffset) {
        if (bBold === void 0) { bBold = false; }
        if (bItalic === void 0) { bItalic = false; }
        if (fLimitWidth === void 0) { fLimitWidth = -1; }
        if (nAlign === void 0) { nAlign = -1; }
        if (flag === void 0) { flag = 0; }
        if (fWordSpace === void 0) { fWordSpace = 0; }
        if (fLineSpace === void 0) { fLineSpace = 0; }
        if (edgeSize === void 0) { edgeSize = 0; }
        if (edgeColor === void 0) { edgeColor = 0; }
        if (xOffset === void 0) { xOffset = 0; }
        if (yOffset === void 0) { yOffset = 0; }
        if (this.m_pBufferData) {
            this.m_pBufferData.Release();
            this.m_pBufferData = null;
        }
        if (this.m_pBufferData == null) {
            this.m_pBufferData = new __dBitmapDataBufferData();
            this.m_pBufferData.m_pCanvas = dInterface.ptr.CreateCanvas();
            this.m_pBufferData.m_pCanvasContext = this.m_pBufferData.m_pCanvas.getContext("2d");
        }
        var canvas = this.m_pBufferData.m_pCanvas;
        var ctx = this.m_pBufferData.m_pCanvasContext;
        var strFont = (bBold ? "bold " : "") + (bItalic ? "italic " : "") + nFontSize + "px Arial";
        ctx.font = strFont;
        if (canvas.style)
            canvas.style.letterSpacing = fWordSpace + "px";
        var lineTexts = new Array();
        var measureTexts = new Array();
        if (fLimitWidth != -1 || text.indexOf("\n") != -1) {
            var str = "";
            var last;
            for (var i = 0; i < text.length; i++) {
                last = str;
                var s = text.charAt(i);
                str += s;
                if (fLimitWidth != -1 && ctx.measureText(str).width > fLimitWidth || s == "\n") {
                    lineTexts.push(last);
                    measureTexts.push({ width: ctx.measureText(last).width });
                    if (s != "\n")
                        str = s;
                    else
                        str = "";
                }
            }
            lineTexts.push(str);
            measureTexts.push({ width: ctx.measureText(str).width });
        }
        else {
            lineTexts.push(text);
            measureTexts.push({ width: ctx.measureText(text).width });
        }
        var maxWidth = 0, maxHeight = 0;
        for (var i = 0; i < measureTexts.length; i++) {
            var w = measureTexts[i].width;
            measureTexts[i].fontBoundingBoxAscent = nFontSize;
            measureTexts[i].fontBoundingBoxDescent = nFontSize * 0.2;
            var h = measureTexts[i].fontBoundingBoxAscent + measureTexts[i].fontBoundingBoxDescent;
            if (maxWidth < w)
                maxWidth = w;
            maxHeight += h;
        }
        maxWidth += edgeSize * 2 + xOffset;
        maxHeight += (lineTexts.length - 1) * fLineSpace + edgeSize * 2 + yOffset;
        {
            canvas.width = maxWidth;
            canvas.height = maxHeight;
        }
        ctx.font = strFont;
        if (canvas.style)
            canvas.style.letterSpacing = fWordSpace + "px";
        var r = (nFontColor & 0x00ff0000) >> 16;
        var g = (nFontColor & 0x0000ff00) >> 8;
        var b = (nFontColor & 0x000000ff);
        var a = (nFontColor & 0xff000000) >>> 24;
        ctx.globalAlpha = a / 255.0;
        ctx.fillStyle = "rgb(" + r + "," + g + "," + b + ")";
        if (edgeSize > 0 && edgeColor != 0) {
            var r2 = (edgeColor & 0x00ff0000) >> 16;
            var g2 = (edgeColor & 0x0000ff00) >> 8;
            var b2 = (edgeColor & 0x000000ff);
            var a2 = (edgeColor & 0xff000000) >>> 24;
            ctx.strokeStyle = "rgba(" + r2 + "," + g2 + "," + b2 + "," + a2 + ")";
            ctx.lineWidth = edgeSize + 1;
        }
        var y = 0;
        if (dInterface.sdkName == "oppo" || dInterface.sdkName == "vivo")
            y += nFontSize * 0.22;
        for (var i = 0; i < lineTexts.length; i++) {
            ctx.globalCompositeOperation = i == 0 ? "copy" : "source-over";
            var left = (maxWidth - xOffset - measureTexts[i].width) * ((nAlign + 1) / 2);
            if (edgeSize > 0 && edgeColor != 0) {
                ctx.strokeText(lineTexts[i], left + xOffset, y + measureTexts[i].fontBoundingBoxAscent + yOffset);
                ctx.globalCompositeOperation = "source-over";
            }
            ctx.fillText(lineTexts[i], left + xOffset, y + measureTexts[i].fontBoundingBoxAscent + yOffset);
            y += measureTexts[i].fontBoundingBoxAscent + measureTexts[i].fontBoundingBoxDescent + fLineSpace;
        }
        ctx.globalAlpha = 1.0;
        ctx.globalCompositeOperation = "source-over";
    };
    dBitmapData.prototype.LoadFromFile = function (fileName, onComplete, onProgress, onFailed) {
        var _this = this;
        if (onComplete === void 0) { onComplete = null; }
        if (onProgress === void 0) { onProgress = null; }
        if (onFailed === void 0) { onFailed = null; }
        this.Release();
        if (dInterface.ptr.m_arrBitmapBuffer.has(fileName)) {
            this.m_pBufferData = dInterface.ptr.m_arrBitmapBuffer.get(fileName);
            if (this.m_pBufferData.m_bLoading) {
                this.m_pBufferData.AddComplete(onComplete, onFailed);
            }
            else {
                if (this.m_pBufferData.m_pImageData) {
                    if (onComplete)
                        onComplete(this);
                }
                else {
                    if (onFailed)
                        onFailed(this);
                }
            }
        }
        else {
            this.m_pBufferData = new __dBitmapDataBufferData();
            this.m_pBufferData.m_strResourceFileName = fileName;
            this.m_pBufferData.AddComplete(onComplete, onFailed);
            this.m_pBufferData.m_bLoading++;
            dBitmapData.s_nGlobalLoadingCountAddRef++;
            dInterface.ptr.m_arrBitmapBuffer.set(fileName, this.m_pBufferData);
            dInterface.ptr.LoadImage(fileName, function (response) {
                _this.m_pBufferData.m_bLoading--;
                dBitmapData.s_nGlobalLoadingCountAddRef--;
                if (response) {
                    _this.m_pBufferData.m_pImageData = response;
                    _this.m_pBufferData.CallComplete(true, _this);
                }
                else
                    _this.m_pBufferData.CallComplete(false, _this);
                if (dBitmapData.s_globalLoadCompleteCallback.length > 0) {
                    for (var i = 0; i < dBitmapData.s_globalLoadCompleteCallback.length; i++)
                        dBitmapData.s_globalLoadCompleteCallback[i]();
                    dBitmapData.s_globalLoadCompleteCallback.clear();
                }
            });
        }
    };
    dBitmapData.prototype.GetResourceFileName = function () {
        if (this.m_pBufferData)
            return this.m_pBufferData.m_strResourceFileName;
        return "";
    };
    dBitmapData.prototype.GetBitmapSourceRect = function () {
        return new dRect(0, 0, this.GetWidth(), this.GetHeight());
    };
    dBitmapData.prototype.GetWidth = function () {
        if (this.m_pBufferData)
            return this.m_pBufferData.GetWidth();
        return 0;
    };
    dBitmapData.prototype.GetHeight = function () {
        if (this.m_pBufferData)
            return this.m_pBufferData.GetHeight();
        return 0;
    };
    dBitmapData.prototype.isLoading = function () {
        if (this.m_pBufferData)
            return this.m_pBufferData.m_bLoading != 0;
        return false;
    };
    dBitmapData.prototype.SetLoadCompleteCallback = function (callback) {
        var _this = this;
        if (!this.isLoading) {
            if (callback)
                callback(this);
        }
        else {
            new dTimer().Create(100, 0, function (sender) {
                if (!_this.isLoading) {
                    sender.Stop();
                    if (callback)
                        callback(_this);
                }
            });
        }
    };
    dBitmapData.prototype._CanvasToImage = function () {
        var _this = this;
        if (this.m_pBufferData != null && this.m_pBufferData.m_pCanvas && this.m_pBufferData.m_pImageData == null) {
            var image = new Image();
            this.m_pBufferData.m_pImageData = image;
            this.m_pBufferData.m_bLoading++;
            image.onload = function () {
                _this.m_pBufferData.m_bLoading--;
            };
            image.src = this.m_pBufferData.m_pCanvas.toDataURL("image/png");
        }
    };
    dBitmapData.prototype._SetTexture = function (nSampleID) {
        var webgl = dInterface.ptr.webgl;
        var p = this;
        if (!p.m_pBufferData || p.m_pBufferData.GetCanvas() == null && p.m_pBufferData.m_pImageData == null) {
            return false;
        }
        if (p.m_pBufferData.m_bLoading) {
            return false;
        }
        if (p.m_pBufferData.m_pTexture == null) {
            if (p.m_pBufferData.m_bRenderToTexture) {
                return false;
            }
            if (p.m_pBufferData.m_pImageData == null && p.m_pBufferData.GetCanvas() && dThread.GetSdkName() == "tt") {
                this._CanvasToImage();
                return false;
            }
            p.m_pBufferData.m_pTexture = webgl.createTexture();
            webgl.activeTexture(webgl.TEXTURE0 + nSampleID);
            webgl.bindTexture(webgl.TEXTURE_2D, p.m_pBufferData.m_pTexture);
            webgl.pixelStorei(webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, true);
            if (p.m_pBufferData.m_pImageData != null)
                webgl.texImage2D(webgl.TEXTURE_2D, 0, webgl.RGBA, webgl.RGBA, webgl.UNSIGNED_BYTE, p.m_pBufferData.m_pImageData);
            else if (p.m_pBufferData.GetCanvas() != null)
                webgl.texImage2D(webgl.TEXTURE_2D, 0, webgl.RGBA, webgl.RGBA, webgl.UNSIGNED_BYTE, p.m_pBufferData.GetCanvas());
            dInterface.ptr.m_arrTextureBuffer.set(p.m_pBufferData.objectId, p.m_pBufferData);
        }
        else {
            webgl.activeTexture(webgl.TEXTURE0 + nSampleID);
            webgl.bindTexture(webgl.TEXTURE_2D, p.m_pBufferData.m_pTexture);
        }
        webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_MIN_FILTER, webgl.NEAREST);
        webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_MAG_FILTER, webgl.NEAREST);
        webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_WRAP_S, webgl.CLAMP_TO_EDGE);
        webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_WRAP_T, webgl.CLAMP_TO_EDGE);
        p.m_pBufferData.m_lLastUsingTextureTime = dInterface.ptr.GetRenderTick();
        return true;
    };
    dBitmapData.prototype._UnSetTexture = function (nSampleID) {
        var webgl = dInterface.ptr.webgl;
        webgl.activeTexture(webgl.TEXTURE0 + nSampleID);
        webgl.bindTexture(webgl.TEXTURE_2D, null);
    };
    dBitmapData.CHANNEL_R = 1;
    dBitmapData.CHANNEL_G = 2;
    dBitmapData.CHANNEL_B = 4;
    dBitmapData.CHANNEL_A = 8;
    dBitmapData.DRAW_FILTER_DEFAULT = 0;
    dBitmapData.DRAW_FILTER_POINT = 4;
    dBitmapData.DRAW_FILTER_LINEAR = 8;
    dBitmapData.BLEND_MODE_NORMAL = 0;
    dBitmapData.BLEND_MODE_COPY = 1;
    dBitmapData.BLEND_MODE_INVERSE = 2;
    dBitmapData.BLEND_MODE_ADD = 3;
    dBitmapData.BLEND_MODE_SUB = 4;
    dBitmapData.BLEND_MODE_MUL = 5;
    dBitmapData.CHANNEL_TYPE_ARGB = 0;
    dBitmapData.CHANNEL_TYPE_RGBA = 1;
    dBitmapData.CHANNEL_TYPE_BGRA = 2;
    dBitmapData.FORMAT_UNKONWN = 0;
    dBitmapData.FORMAT_A8R8G8B8 = 1;
    dBitmapData.FORMAT_A4R4G4B4 = 2;
    dBitmapData.FORMAT_R5G6B5 = 3;
    dBitmapData.FORMAT_A1R5G5B5 = 4;
    dBitmapData.FORMAT_A8 = 5;
    dBitmapData.FORMAT_COMPRESS_PVR = 6;
    dBitmapData.FORMAT_A32 = 7;
    dBitmapData.FLAG_RENDER_TO_TEXTURE = 1;
    dBitmapData.FLAG_SHARED_CANVAS = 2;
    dBitmapData._WHITE_BITMAPDATA = null;
    dBitmapData.s_globalLoadCompleteCallback = new Array();
    dBitmapData.s_nGlobalLoadingCountAddRef = 0;
    return dBitmapData;
}(dObject));
var __dBitmapDataBufferData = (function (_super) {
    __extends(__dBitmapDataBufferData, _super);
    function __dBitmapDataBufferData() {
        var _this = _super.call(this) || this;
        _this.m_pTexture = null;
        _this.m_bLoading = 0;
        _this.m_pImageData = null;
        _this.m_pCanvas = null;
        _this.m_lLastUsingTextureTime = 0;
        _this.m_strResourceFileName = "";
        _this.m_vecOnComplete = null;
        _this.m_vecOnFailed = null;
        _this.m_bRenderToTexture = 0;
        _this.m_markFlag = -1;
        _this.m_pRenderToTextureRboDepth = null;
        _this.m_pRenderToTextureFbo = null;
        return _this;
    }
    __dBitmapDataBufferData.prototype.AddComplete = function (onComplete, onFailed) {
        if (!this.m_vecOnComplete)
            this.m_vecOnComplete = new Array();
        if (!this.m_vecOnFailed)
            this.m_vecOnFailed = new Array();
        if (onComplete)
            this.m_vecOnComplete.push(onComplete);
        if (onFailed)
            this.m_vecOnFailed.push(onFailed);
    };
    __dBitmapDataBufferData.prototype.CallComplete = function (bSuccess, sender) {
        if (bSuccess) {
            if (this.m_vecOnComplete) {
                for (var i = 0; i < this.m_vecOnComplete.length; i++)
                    this.m_vecOnComplete[i](sender);
            }
        }
        else {
            if (this.m_vecOnFailed) {
                for (var i = 0; i < this.m_vecOnFailed.length; i++)
                    this.m_vecOnFailed[i](sender);
            }
        }
        this.m_vecOnComplete = null;
        this.m_vecOnFailed = null;
    };
    __dBitmapDataBufferData.prototype.Release = function () {
        if (this.m_pTexture) {
            dInterface.ptr.webgl.deleteTexture(this.m_pTexture);
            this.m_pTexture = null;
        }
        if (this.m_pRenderToTextureRboDepth) {
            dInterface.ptr.webgl.deleteRenderbuffer(this.m_pRenderToTextureRboDepth);
            this.m_pRenderToTextureRboDepth = null;
        }
        if (this.m_pRenderToTextureFbo) {
            dInterface.ptr.webgl.deleteFramebuffer(this.m_pRenderToTextureFbo);
            this.m_pRenderToTextureFbo = null;
        }
    };
    __dBitmapDataBufferData.prototype.GetCanvas = function () {
        return this.m_pCanvas;
    };
    __dBitmapDataBufferData.prototype.GetWidth = function () {
        if (this.m_pImageData)
            return this.m_pImageData.width;
        if (this.m_pCanvas)
            return this.m_pCanvas.width;
        return 0;
    };
    __dBitmapDataBufferData.prototype.GetHeight = function () {
        if (this.m_pImageData)
            return this.m_pImageData.height;
        if (this.m_pCanvas)
            return this.m_pCanvas.height;
        return 0;
    };
    return __dBitmapDataBufferData;
}(dObject));
var dBoundingBox = (function () {
    function dBoundingBox(_x1, _y1, _z1, _x2, _y2, _z2) {
        if (_x1 === void 0) { _x1 = 0.0; }
        if (_y1 === void 0) { _y1 = 0.0; }
        if (_z1 === void 0) { _z1 = 0.0; }
        if (_x2 === void 0) { _x2 = 0.0; }
        if (_y2 === void 0) { _y2 = 0.0; }
        if (_z2 === void 0) { _z2 = 0.0; }
        this.m_vCenter = null;
        var a = this;
        a.x1 = _x1;
        a.y1 = _y1;
        a.z1 = _z1;
        a.x2 = _x2;
        a.y2 = _y2;
        a.z2 = _z2;
        if (dBoundingBox.s_vecCollectCameraTemp == null) {
            dBoundingBox.s_vecCollectCameraTemp = new Array(8);
            for (var i = 0; i < 8; i++)
                dBoundingBox.s_vecCollectCameraTemp[i] = new dVector4();
        }
    }
    dBoundingBox.prototype.SetValue = function (_x1, _y1, _z1, _x2, _y2, _z2) {
        var a = this;
        a.x1 = _x1;
        a.y1 = _y1;
        a.z1 = _z1;
        a.x2 = _x2;
        a.y2 = _y2;
        a.z2 = _z2;
        return a;
    };
    dBoundingBox.prototype.Copy = function (v) {
        var a = this;
        a.x1 = v.x1;
        a.y1 = v.y1;
        a.z1 = v.z1;
        a.x2 = v.x2;
        a.y2 = v.y2;
        a.z2 = v.z2;
        return a;
    };
    dBoundingBox.prototype.Merge = function (p) {
        var a = this;
        if (a.x1 > p.x1)
            a.x1 = p.x1;
        if (a.y1 > p.y1)
            a.y1 = p.y1;
        if (a.z1 > p.z1)
            a.z1 = p.z1;
        if (a.x2 < p.x2)
            a.x2 = p.x2;
        if (a.y2 < p.y2)
            a.y2 = p.y2;
        if (a.z2 < p.z2)
            a.z2 = p.z2;
        return this;
    };
    dBoundingBox.prototype.MergePoint = function (v) {
        var a = this;
        if (a.x1 > v.x)
            a.x1 = v.x;
        if (a.y1 > v.y)
            a.y1 = v.y;
        if (a.z1 > v.z)
            a.z1 = v.z;
        if (a.x2 < v.x)
            a.x2 = v.x;
        if (a.y2 < v.y)
            a.y2 = v.y;
        if (a.z2 < v.z)
            a.z2 = v.z;
        return this;
    };
    dBoundingBox.prototype.GetCenter = function () {
        if (this.m_vCenter == null)
            this.m_vCenter = new dVector3();
        this.m_vCenter.x = (this.x1 + this.x2) / 2.0;
        this.m_vCenter.y = (this.y1 + this.y2) / 2.0;
        this.m_vCenter.z = (this.z1 + this.z2) / 2.0;
        return this.m_vCenter;
    };
    dBoundingBox.prototype.GetExtents = function () {
        var vCenter = this.GetCenter();
        return new dVector3(this.x2 - vCenter.x, this.y2 - vCenter.y, this.z2 - vCenter.z);
    };
    dBoundingBox.prototype.isCollectionRay = function (vPos, vDir) {
        var vCenter = this.GetCenter();
        var vExtends = new dVector3(this.x2 - vCenter.x, this.y2 - vCenter.y, this.z2 - vCenter.z);
        var mFDir = new dVector3(dMath.Abs(vDir.x), dMath.Abs(vDir.y), dMath.Abs(vDir.z));
        var Dx = vPos.x - vCenter.x;
        if (dMath.Abs(Dx) > vExtends.x && Dx * vDir.x >= 0.0)
            return false;
        var Dy = vPos.y - vCenter.y;
        if (dMath.Abs(Dy) > vExtends.y && Dy * vDir.y >= 0.0)
            return false;
        var Dz = vPos.z - vCenter.z;
        if (dMath.Abs(Dz) > vExtends.z && Dz * vDir.z >= 0.0)
            return false;
        var f;
        f = vDir.y * Dz - vDir.z * Dy;
        if (dMath.Abs(f) > vExtends.y * mFDir.z + vExtends.z * mFDir.y)
            return false;
        f = vDir.z * Dx - vDir.x * Dz;
        if (dMath.Abs(f) > vExtends.x * mFDir.z + vExtends.z * mFDir.x)
            return false;
        f = vDir.x * Dy - vDir.y * Dx;
        if (dMath.Abs(f) > vExtends.x * mFDir.y + vExtends.y * mFDir.x)
            return false;
        return true;
    };
    dBoundingBox.prototype.ToPoint8 = function () {
        var ret = new Array(8);
        ret[0] = new dVector3(this.x1, this.y2, this.z2);
        ret[1] = new dVector3(this.x2, this.y2, this.z2);
        ret[2] = new dVector3(this.x2, this.y2, this.z1);
        ret[3] = new dVector3(this.x1, this.y2, this.z1);
        ret[4] = new dVector3(this.x1, this.y1, this.z2);
        ret[5] = new dVector3(this.x2, this.y1, this.z2);
        ret[6] = new dVector3(this.x2, this.y1, this.z1);
        ret[7] = new dVector3(this.x1, this.y1, this.z1);
        return ret;
    };
    dBoundingBox.prototype.isCollectionFrustumPlane = function (vecFustumPlane) {
        var t = dBoundingBox.s_vecCollectCameraTemp;
        t[0].SetValue(this.x1, this.y2, this.z2, 1.0);
        t[1].SetValue(this.x2, this.y2, this.z2, 1.0);
        t[2].SetValue(this.x2, this.y2, this.z1, 1.0);
        t[3].SetValue(this.x1, this.y2, this.z1, 1.0);
        t[4].SetValue(this.x1, this.y1, this.z2, 1.0);
        t[5].SetValue(this.x2, this.y1, this.z2, 1.0);
        t[6].SetValue(this.x2, this.y1, this.z1, 1.0);
        t[7].SetValue(this.x1, this.y1, this.z1, 1.0);
        for (var i = 0; i < 6; ++i) {
            var iInCount = 8;
            for (var j = 0; j < 8; ++j) {
                if (vecFustumPlane[i].Dot(t[j]) < 0) {
                    --iInCount;
                }
            }
            if (iInCount == 0)
                return false;
        }
        return true;
    };
    dBoundingBox.prototype.isPointIn = function (x, y, z, radio) {
        if (radio === void 0) { radio = 0; }
        if (x + radio >= this.x1 && x - radio <= this.x2 &&
            y + radio >= this.y1 && y - radio <= this.y2 &&
            z + radio >= this.z1 && z - radio <= this.z2)
            return true;
        return false;
    };
    dBoundingBox.prototype.isCollectionAABB = function (p) {
        var vCenter1 = this.GetCenter();
        var vCenter2 = p.GetCenter();
        var vExtents1 = this.GetExtents();
        var vExtents2 = p.GetExtents();
        var tx = vCenter1.x - vCenter2.x;
        var ex = vExtents2.x + vExtents1.x;
        if (tx > ex)
            return false;
        var ty = vCenter1.y - vCenter2.y;
        var ey = vExtents2.y + vExtents1.y;
        if (ty > ey)
            return false;
        var tz = vCenter1.z - vCenter2.z;
        var ez = vExtents2.z + vExtents1.z;
        if (tz > ez)
            return false;
        return true;
    };
    dBoundingBox.prototype.isCollectPoint = function (x, y, z) {
        return this.x1 <= x && x <= this.x2 && this.y1 <= y && y <= this.y2 && this.z1 <= z && z <= this.z2;
    };
    dBoundingBox.prototype.TransformToAABB = function (mat) {
        var ret = new dBoundingBox();
        var v8 = this.ToPoint8();
        for (var i = 0; i < v8.length; i++) {
            v8[i].Transform(mat);
        }
        ret.x2 = ret.x1 = v8[0].x;
        ret.y2 = ret.y1 = v8[0].y;
        ret.z2 = ret.z1 = v8[0].z;
        for (var i = 1; i < v8.length; i++) {
            if (ret.x1 > v8[i].x)
                ret.x1 = v8[i].x;
            if (ret.y1 > v8[i].y)
                ret.y1 = v8[i].y;
            if (ret.z1 > v8[i].z)
                ret.z1 = v8[i].z;
            if (ret.x2 < v8[i].x)
                ret.x2 = v8[i].x;
            if (ret.y2 < v8[i].y)
                ret.y2 = v8[i].y;
            if (ret.z2 < v8[i].z)
                ret.z2 = v8[i].z;
        }
        return ret;
    };
    dBoundingBox.prototype.getSeparatingPlaneMulDot = function (p, mul, plane) {
        return p.x * plane.x * mul + p.y * plane.y * mul + p.z * plane.z * mul;
    };
    dBoundingBox.prototype.getSeparatingPlane = function (RPos, Plane, box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1Half_size, box2Half_size) {
        return (dMath.Abs(RPos.Dot(Plane)) >
            (dMath.Abs(this.getSeparatingPlaneMulDot(box1AxisX, box1Half_size.x, Plane)) +
                dMath.Abs(this.getSeparatingPlaneMulDot(box1AxisY, box1Half_size.y, Plane)) +
                dMath.Abs(this.getSeparatingPlaneMulDot(box1AxisZ, box1Half_size.z, Plane)) +
                dMath.Abs(this.getSeparatingPlaneMulDot(box2AxisX, box2Half_size.x, Plane)) +
                dMath.Abs(this.getSeparatingPlaneMulDot(box2AxisY, box2Half_size.y, Plane)) +
                dMath.Abs(this.getSeparatingPlaneMulDot(box2AxisZ, box2Half_size.z, Plane))));
    };
    dBoundingBox.prototype.isCollectionOBB = function (box2, mat1, mat2) {
        var box1Pos = this.GetCenter();
        var box2Pos = box2.GetCenter();
        box1Pos.Transform(mat1);
        box2Pos.Transform(mat2);
        var box1AxisX = new dVector3(1, 0, 0).TransformNormal(mat1);
        var box1AxisY = new dVector3(0, 1, 0).TransformNormal(mat1);
        var box1AxisZ = new dVector3(0, 0, 1).TransformNormal(mat1);
        var box2AxisX = new dVector3(1, 0, 0).TransformNormal(mat2);
        var box2AxisY = new dVector3(0, 1, 0).TransformNormal(mat2);
        var box2AxisZ = new dVector3(0, 0, 1).TransformNormal(mat2);
        var box1HalfSize = new dVector3(this.Width() * 0.5, this.Height() * 0.5, this.Depth() * 0.5);
        var box2HalfSize = new dVector3(box2.Width() * 0.5, box2.Height() * 0.5, box2.Depth() * 0.5);
        var RPos = box2Pos.Sub(box1Pos);
        var cross = new dVector3();
        return !(this.getSeparatingPlane(RPos, box1AxisX, box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, box1AxisY, box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, box1AxisZ, box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, box2AxisX, box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, box2AxisY, box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, box2AxisZ, box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, dVector3.Vec3Cross(cross, box1AxisX, box2AxisX), box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, dVector3.Vec3Cross(cross, box1AxisX, box2AxisY), box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, dVector3.Vec3Cross(cross, box1AxisX, box2AxisZ), box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, dVector3.Vec3Cross(cross, box1AxisY, box2AxisX), box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, dVector3.Vec3Cross(cross, box1AxisY, box2AxisY), box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, dVector3.Vec3Cross(cross, box1AxisY, box2AxisZ), box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, dVector3.Vec3Cross(cross, box1AxisZ, box2AxisX), box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, dVector3.Vec3Cross(cross, box1AxisZ, box2AxisY), box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize) ||
            this.getSeparatingPlane(RPos, dVector3.Vec3Cross(cross, box1AxisZ, box2AxisZ), box1AxisX, box1AxisY, box1AxisZ, box2AxisX, box2AxisY, box2AxisZ, box1HalfSize, box2HalfSize));
    };
    dBoundingBox.prototype.WriteToBin = function (to) {
        to.WriteFloat(this.x1);
        to.WriteFloat(this.y1);
        to.WriteFloat(this.z1);
        to.WriteFloat(this.x2);
        to.WriteFloat(this.y2);
        to.WriteFloat(this.z2);
    };
    dBoundingBox.prototype.ReadFromBin = function (data) {
        this.x1 = data.ReadFloat();
        this.y1 = data.ReadFloat();
        this.z1 = data.ReadFloat();
        this.x2 = data.ReadFloat();
        this.y2 = data.ReadFloat();
        this.z2 = data.ReadFloat();
        return this;
    };
    dBoundingBox.prototype.Width = function () {
        return this.x2 - this.x1;
    };
    dBoundingBox.prototype.Height = function () {
        return this.y2 - this.y1;
    };
    dBoundingBox.prototype.Depth = function () {
        return this.z2 - this.z1;
    };
    dBoundingBox.prototype.ToStringBuffer = function (split) {
        if (split === void 0) { split = " "; }
        return this.x1 + split + this.y1 + split + this.z1 + split + this.x2 + split + this.y2 + split + this.z2;
    };
    dBoundingBox.s_vecCollectCameraTemp = null;
    return dBoundingBox;
}());
var dByteArray = (function (_super) {
    __extends(dByteArray, _super);
    function dByteArray() {
        var _this = _super.call(this) || this;
        _this.m_pArraybuffer = null;
        _this.m_pDataView = null;
        _this.m_bLoadOK = false;
        _this.m_nSize = 0;
        _this.m_nSysSize = 0;
        _this.m_nPosition = 0;
        _this.m_nEndian = dByteArray.BIG_ENDIAN;
        return _this;
    }
    dByteArray.prototype.isLittleEndian = function () {
        return this.m_nEndian == dByteArray.LITTLE_ENDIAN;
    };
    dByteArray.prototype.requreSize = function (size) {
        size -= this.m_nSize - this.m_nPosition;
        if (size <= 0)
            return;
        var curSysSize = this.m_nSysSize;
        while (this.m_nSize + size >= this.m_nSysSize) {
            if (this.m_nSysSize < 64)
                this.m_nSysSize = 64;
            else
                this.m_nSysSize *= 2;
        }
        this.m_nSize += size;
        if (this.m_nSysSize > curSysSize) {
            var newArrayBuffer = new ArrayBuffer(this.m_nSysSize);
            if (this.m_pArraybuffer == null)
                this.m_pArraybuffer = newArrayBuffer;
            else {
                var p1 = new Uint8Array(this.m_pArraybuffer);
                var p2 = new Uint8Array(newArrayBuffer);
                for (var i = 0; i < this.m_nSize; i++)
                    p2[i] = p1[i];
            }
            this.m_pArraybuffer = newArrayBuffer;
            this.m_pDataView = new DataView(newArrayBuffer);
        }
    };
    dByteArray.prototype.requireSizeDirect = function (size) {
        if (this.m_nSize != size) {
            this.m_nSize = size;
            this.m_nSysSize = size;
            var newArrayBuffer = new ArrayBuffer(this.m_nSysSize);
            if (this.m_pArraybuffer == null)
                this.m_pArraybuffer = newArrayBuffer;
            else {
                var p1 = new Uint8Array(this.m_pArraybuffer);
                var p2 = new Uint8Array(newArrayBuffer);
                for (var i = 0; i < this.m_nSize; i++)
                    p2[i] = p1[i];
            }
            this.m_pArraybuffer = newArrayBuffer;
            this.m_pDataView = new DataView(newArrayBuffer);
        }
    };
    dByteArray.prototype.addpos = function (offset) {
        var curPos = this.m_nPosition;
        this.m_nPosition += offset;
        if (this.m_nPosition > this.m_nSize)
            this.m_nPosition = this.m_nSize;
        return curPos;
    };
    dByteArray.prototype.Release = function () {
    };
    dByteArray.prototype.ReadChar = function () {
        if (this.m_nPosition + 1 > this.m_nSize) {
            this.m_nPosition = this.m_nSize;
            return 0;
        }
        return this.m_pDataView ? this.m_pDataView.getInt8(this.addpos(1)) : 0;
    };
    dByteArray.prototype.GetChar = function (pos) {
        if (pos === void 0) { pos = -1; }
        if (pos == -1) {
            var old_pos = this.GetPosition();
            var ret = this.ReadChar();
            this.SetPosition(old_pos);
            return ret;
        }
        else {
            var old_pos = this.GetPosition();
            this.SetPosition(pos);
            var ret = this.ReadChar();
            this.SetPosition(old_pos);
            return ret;
        }
        return 0;
    };
    dByteArray.prototype.ReadByte = function () {
        if (this.m_nPosition + 1 > this.m_nSize) {
            this.m_nPosition = this.m_nSize;
            return 0;
        }
        return this.m_pDataView ? this.m_pDataView.getUint8(this.addpos(1)) : 0;
    };
    dByteArray.prototype.GetByte = function (pos) {
        if (pos === void 0) { pos = -1; }
        if (pos == -1) {
            var old_pos = this.GetPosition();
            var ret = this.ReadByte();
            this.SetPosition(old_pos);
            return ret;
        }
        else {
            var old_pos = this.GetPosition();
            this.SetPosition(pos);
            var ret = this.ReadByte();
            this.SetPosition(old_pos);
            return ret;
        }
        return 0;
    };
    dByteArray.prototype.ReadBoolean = function () {
        return this.ReadByte();
    };
    dByteArray.prototype.ReadShort = function () {
        if (this.m_nPosition + 2 > this.m_nSize) {
            this.m_nPosition = this.m_nSize;
            return 0;
        }
        return this.m_pDataView ? this.m_pDataView.getInt16(this.addpos(2), this.isLittleEndian()) : 0;
    };
    dByteArray.prototype.GetShort = function (pos) {
        if (pos === void 0) { pos = -1; }
        var old_pos = this.GetPosition();
        if (pos != -1)
            this.SetPosition(pos);
        var ret = this.ReadShort();
        this.SetPosition(old_pos);
        return ret;
    };
    dByteArray.prototype.ReadUnsignedShort = function () {
        if (this.m_nPosition + 2 > this.m_nSize) {
            this.m_nPosition = this.m_nSize;
            return 0;
        }
        return this.m_pDataView ? this.m_pDataView.getUint16(this.addpos(2), this.isLittleEndian()) : 0;
    };
    dByteArray.prototype.GetUnsignedShort = function (pos) {
        if (pos === void 0) { pos = -1; }
        var old_pos = this.GetPosition();
        if (pos != -1)
            this.SetPosition(pos);
        var ret = this.ReadUnsignedShort();
        this.SetPosition(old_pos);
        return ret;
    };
    dByteArray.prototype.ReadInt = function () {
        if (this.m_nPosition + 4 > this.m_nSize) {
            this.m_nPosition = this.m_nSize;
            return 0;
        }
        return this.m_pDataView ? this.m_pDataView.getInt32(this.addpos(4), this.isLittleEndian()) : 0;
    };
    dByteArray.prototype.ReadUnsignedInt = function () {
        if (this.m_nPosition + 4 > this.m_nSize) {
            this.m_nPosition = this.m_nSize;
            return 0;
        }
        return this.m_pDataView ? this.m_pDataView.getUint32(this.addpos(4), this.isLittleEndian()) : 0;
    };
    dByteArray.prototype.ReadInts = function (length) {
        if (length === void 0) { length = -1; }
        if (length == -1)
            length = this.ReadInt();
        if (length == -1)
            return null;
        var ret = new Array(length);
        for (var i = 0; i < length; i++)
            ret[i] = this.ReadInt();
        return ret;
    };
    dByteArray.prototype.ReadIntsVector = function (length) {
        var ret = new Array(length);
        for (var i = 0; i < length; i++)
            ret[i] = this.ReadInt();
        return ret;
    };
    dByteArray.prototype.GetInt = function (pos) {
        if (pos === void 0) { pos = -1; }
        var old_pos = this.GetPosition();
        if (pos != -1)
            this.SetPosition(pos);
        var ret = this.ReadInt();
        this.SetPosition(old_pos);
        return ret;
    };
    dByteArray.prototype.GetUnsignedInt = function (pos) {
        if (pos === void 0) { pos = -1; }
        var old_pos = this.GetPosition();
        if (pos != -1)
            this.SetPosition(pos);
        var ret = this.ReadUnsignedInt();
        this.SetPosition(old_pos);
        return ret;
    };
    dByteArray.prototype.ReadFloat = function () {
        if (this.m_nPosition + 4 > this.m_nSize) {
            this.m_nPosition = this.m_nSize;
            return 0;
        }
        return this.m_pDataView ? this.m_pDataView.getFloat32(this.addpos(4), this.isLittleEndian()) : 0;
    };
    dByteArray.prototype.ReadFloats = function (length) {
        var ret = new Array(length);
        for (var i = 0; i < length; i++)
            ret[i] = this.ReadFloat();
        return ret;
    };
    dByteArray.prototype.ReadDouble = function () {
        if (this.m_nPosition + 8 > this.m_nSize) {
            this.m_nPosition = this.m_nSize;
            return 0;
        }
        return this.m_pDataView ? this.m_pDataView.getFloat64(this.addpos(8), this.isLittleEndian()) : 0;
    };
    dByteArray.prototype.ReadDoubles = function (length) {
        var ret = new Array(length);
        for (var i = 0; i < length; i++)
            ret[i] = this.ReadDouble();
        return ret;
    };
    dByteArray.prototype.ReadLong = function () {
        var ret = 0;
        if (this.isLittleEndian()) {
            var low = this.ReadInt();
            ret = (this.ReadInt() & 0x1FFFFF) * 0x100000000;
            if (low < 0) {
                ret += 0x80000000;
                ret += low & 0x7FFFFFFF;
            }
            else
                ret += low;
            return ret;
        }
        else {
            ret = (this.ReadInt() & 0x1FFFFF) * 0x100000000;
            var low = this.ReadInt();
            if (low < 0) {
                ret += 0x80000000;
                ret += low & 0x7FFFFFFF;
            }
            else
                ret += low;
            return ret;
        }
    };
    dByteArray.prototype.ReadLongs = function (length) {
        var ret = new Array(length);
        for (var i = 0; i < length; i++)
            ret[i] = this.ReadLong();
        return ret;
    };
    dByteArray.prototype.ReadStringZeroEnd = function (nCodePage) {
        if (nCodePage === void 0) { nCodePage = dStringUtils.CODE_PAGE_UTF8; }
        var data = new dByteArray();
        var i;
        while ((i = this.ReadByte()) != 0 && this.AvailableSize())
            data.WriteByte(i);
        return data.ToStringBuffer(nCodePage);
    };
    dByteArray.prototype.ReadStringLine = function (nCodePage) {
        if (nCodePage === void 0) { nCodePage = dStringUtils.CODE_PAGE_UTF8; }
        var data = new dByteArray();
        var i;
        while (this.AvailableSize()) {
            i = this.ReadByte();
            if (i == '\n'.charCodeAt(0) || i == '\r'.charCodeAt(0)) {
                if (i == '\r'.charCodeAt(0) && this.GetByte() == '\n'.charCodeAt(0))
                    this.Skip(1);
                break;
            }
            data.WriteByte(i);
        }
        return data.ToStringBuffer(nCodePage);
    };
    dByteArray.prototype.ReadStringWord = function (strSplit, nCodePage) {
        if (strSplit === void 0) { strSplit = ""; }
        if (nCodePage === void 0) { nCodePage = dStringUtils.CODE_PAGE_UTF8; }
        var data = new dByteArray();
        var i;
        while (this.AvailableSize()) {
            i = this.ReadByte();
            if (i <= 32 || strSplit.length && strSplit.indexOf(String.fromCharCode(i)) != -1) {
                if (data.Size() == 0)
                    continue;
                else {
                    if (i > 32)
                        this.SetPosition(this.GetPosition() - 1);
                    break;
                }
            }
            data.WriteByte(i);
        }
        return data.ToStringBuffer(nCodePage);
    };
    dByteArray.prototype.ReadString = function () {
        return this.ReadStringEx(0, dStringUtils.CODE_PAGE_UTF8);
    };
    dByteArray.prototype.ReadStringEx = function (nSizeInBits, nCodePage) {
        if (this.GetUnsignedInt() == 0xFFFFFFFF) {
            this.ReadInt();
            return null;
        }
        if (nSizeInBits <= 0)
            nSizeInBits = this.ReadStringLength();
        if (nSizeInBits == 0x7fffffff)
            return null;
        if (nSizeInBits <= 0)
            return "";
        if (this.m_nPosition + nSizeInBits > this.m_nSize) {
            this.m_nPosition = this.m_nSize;
            return "";
        }
        if (nCodePage == dStringUtils.CODE_PAGE_UTF8)
            return this.Utf8ArrayToStr(new Uint8Array(this.m_pArraybuffer, this.addpos(nSizeInBits), nSizeInBits));
        else if (nCodePage == dStringUtils.CODE_PAGE_UNICODE)
            return String.fromCharCode.apply(null, new Uint16Array(this.m_pArraybuffer, this.addpos(nSizeInBits), nSizeInBits));
        return "";
    };
    dByteArray.prototype.ToStringBuffer = function (codePage) {
        if (codePage === void 0) { codePage = dStringUtils.CODE_PAGE_UTF8; }
        var pos = this.GetPosition();
        this.SetPosition(0);
        var magic1 = this.ReadByte();
        var magic2 = this.ReadByte();
        var magic3 = this.ReadByte();
        this.SetPosition(0);
        var ret;
        if (magic1 == 0xFF && magic2 == 0xFE) {
            this.SetPosition(2);
            var oldEndian = this.GetEndian();
            this.SetEndian(dByteArray.LITTLE_ENDIAN);
            ret = this.ReadStringEx(this.AvailableSize(), dStringUtils.CODE_PAGE_UNICODE);
            this.SetEndian(oldEndian);
        }
        else if (magic1 == 0xFE && magic2 == 0xFF) {
            this.SetPosition(2);
            var oldEndian = this.GetEndian();
            this.SetEndian(dByteArray.BIG_ENDIAN);
            ret = this.ReadStringEx(this.AvailableSize(), dStringUtils.CODE_PAGE_UNICODE);
            this.SetEndian(oldEndian);
        }
        else if (magic1 == 0xEF && magic2 == 0xBB && magic3 == 0xBF) {
            this.SetPosition(3);
            ret = this.ReadStringEx(this.AvailableSize(), dStringUtils.CODE_PAGE_UTF8);
        }
        else {
            this.SetPosition(0);
            ret = this.ReadStringEx(this.AvailableSize(), codePage);
        }
        this.SetPosition(pos);
        return ret;
    };
    dByteArray.prototype.ToBinString = function () {
        var pos = this.GetPosition();
        this.SetPosition(0);
        if (this.AvailableSize() == 0)
            return "";
        var ret = "";
        for (var i = 0, n = this.AvailableSize() * 2; i < n; i += 2) {
            var tbyte = this.ReadByte();
            var a = (tbyte & 0xF0) >> 4;
            if (a < 10)
                ret += String.fromCharCode(a + 48);
            else
                ret += String.fromCharCode(a - 10 + 65);
            a = tbyte & 0xF;
            if (a < 10)
                ret += String.fromCharCode(a + 48);
            else
                ret += String.fromCharCode(a - 10 + 65);
        }
        return ret;
    };
    dByteArray.prototype.WriteFromBinString = function (str) {
        var s = "";
        for (var i = 0; i < str.length; i += 2) {
            s = "0x" + str.charAt(i) + str.charAt(i + 1);
            var data = dMath.ParseInt(s, 16);
            this.WriteByte(data);
        }
    };
    dByteArray.prototype.ReadBinTo = function (to, size) {
        if (size === void 0) { size = -1; }
        var thisPos = this.GetPosition();
        var pos = to.GetPosition();
        if (size == -1)
            size = this.AvailableSize();
        else if (size > this.AvailableSize())
            size = this.AvailableSize();
        to.requreSize(size);
        for (var i = 0; i < size; i++)
            to.m_pDataView.setInt8(to.addpos(1), this.m_pDataView.getInt8(this.m_nPosition + i));
        this.SetPosition(thisPos + size);
        to.SetPosition(pos);
    };
    dByteArray.prototype.ReadBin = function () {
        return this.ReadBinEx(this.AvailableSize());
    };
    dByteArray.prototype.ReadBinEx = function (size) {
        var pos = this.GetPosition();
        var ret = new dByteArray();
        if (size > this.AvailableSize())
            size = this.AvailableSize();
        var ret = new dByteArray();
        ret.requireSizeDirect(size);
        ret.WriteBin(this, this.GetPosition(), size);
        ret.SetPosition(0);
        this.SetPosition(this.GetPosition() + size);
        ret.SetEndian(this.GetEndian());
        this.SetPosition(pos + size);
        return ret;
    };
    dByteArray.prototype.ReadBytes = function (size) {
        var ret = new Array(size);
        for (var i = 0; i < size; i++)
            ret[i] = this.ReadByte();
        return ret;
    };
    dByteArray.prototype.ReadBytesTo = function (to, toOffset, size) {
        if (size > this.AvailableSize())
            size = this.AvailableSize();
        if (this.m_pDataView == null)
            return;
        for (var i = 0; i < size; i++) {
            if (this.m_nPosition + 1 > this.m_nSize) {
                this.m_nPosition = this.m_nSize;
                return;
            }
            to[i + toOffset] = this.m_pDataView.getUint8(this.addpos(1));
        }
        return size;
    };
    dByteArray.prototype.WriteByte = function (data, pos) {
        if (pos === void 0) { pos = -1; }
        if (pos == -1) {
            this.requreSize(1);
            this.m_pDataView.setInt8(this.addpos(1), data);
        }
        else {
            var pos2 = this.GetPosition();
            this.SetPosition(pos);
            this.WriteByte(data);
            this.SetPosition(pos2);
        }
    };
    dByteArray.prototype.WriteBoolean = function (data) {
        return this.WriteByte(Number(data));
    };
    dByteArray.prototype.WriteBytes = function (arr, offset, size) {
        if (offset === void 0) { offset = 0; }
        if (size === void 0) { size = -1; }
        if (size == -1)
            size = arr.length;
        this.requreSize(size);
        for (var i = 0; i < size; i++)
            this.m_pDataView.setInt8(this.addpos(1), arr[i + offset]);
    };
    dByteArray.prototype.WriteBytesEx = function (arr, offset, count) {
        for (var i = offset, n = count; i < n; i++)
            this.WriteByte(arr[i]);
        return count;
    };
    dByteArray.prototype.WriteShort = function (data, pos) {
        if (pos === void 0) { pos = -1; }
        if (pos == -1) {
            this.requreSize(2);
            this.m_pDataView.setInt16(this.addpos(2), data, this.isLittleEndian());
        }
        else {
            var oldPos = this.GetPosition();
            this.SetPosition(pos);
            this.WriteShort(data);
            this.SetPosition(oldPos);
        }
    };
    dByteArray.prototype.WriteInt = function (data, pos) {
        if (pos === void 0) { pos = -1; }
        if (pos == -1) {
            this.requreSize(4);
            this.m_pDataView.setInt32(this.addpos(4), data, this.isLittleEndian());
        }
        else {
            var oldPos = this.GetPosition();
            this.SetPosition(pos);
            this.WriteInt(data);
            this.SetPosition(oldPos);
        }
    };
    dByteArray.prototype.WriteInts = function (arr, length, bWriteLength) {
        if (length === void 0) { length = -1; }
        if (bWriteLength === void 0) { bWriteLength = false; }
        if (arr == null && bWriteLength)
            this.WriteInt(-1);
        else {
            if (length == -1)
                length = arr.length;
            if (bWriteLength)
                this.WriteInt(length);
            for (var i = 0; i < length; i++)
                this.WriteInt(arr[i]);
        }
    };
    dByteArray.prototype.WriteFloat = function (data) {
        this.requreSize(4);
        this.m_pDataView.setFloat32(this.addpos(4), data, this.isLittleEndian());
    };
    dByteArray.prototype.WriteFloats = function (arr, length) {
        if (length === void 0) { length = -1; }
        if (length == -1)
            length = arr.length;
        for (var i = 0; i < length; i++)
            this.WriteFloat(arr[i]);
    };
    dByteArray.prototype.WriteDouble = function (data) {
        this.requreSize(8);
        this.m_pDataView.setFloat64(this.addpos(8), data, this.isLittleEndian());
    };
    dByteArray.prototype.WriteDoubles = function (arr) {
        for (var i = 0, n = arr.length; i < n; i++)
            this.WriteDouble(arr[i]);
    };
    dByteArray.prototype.WriteLong = function (data) {
        if (this.isLittleEndian()) {
            this.WriteInt(data & 0xffffffff);
            this.WriteInt((data / 0x100000000) & 0xffffffff);
        }
        else {
            this.WriteInt((data / 0x100000000) & 0xffffffff);
            this.WriteInt(data & 0xffffffff);
        }
    };
    dByteArray.prototype.WriteLongs = function (arr) {
        for (var i = 0, n = arr.length; i < n; i++)
            this.WriteLong(arr[i]);
    };
    dByteArray.prototype.WriteString = function (data) {
        this.WriteStringEx(data, true, dStringUtils.CODE_PAGE_UTF8);
    };
    dByteArray.prototype.WriteStringEx = function (str, bWriteLength, charset) {
        if (bWriteLength === void 0) { bWriteLength = true; }
        if (charset === void 0) { charset = dStringUtils.CODE_PAGE_UTF8; }
        if (str == null && bWriteLength) {
            this.WriteInt(0xFFFFFFFF);
        }
        else {
            if (charset == dStringUtils.CODE_PAGE_UNICODE) {
                if (bWriteLength)
                    this.WriteStringLength(str.length * 2);
                for (var i = 0, strLen = str.length; i < strLen; i++)
                    this.WriteShort(str.charCodeAt(i));
            }
            else if (charset == dStringUtils.CODE_PAGE_UTF8) {
                var ab = this.str2ab(str);
                var len = ab.byteLength;
                if (bWriteLength)
                    this.WriteStringLength(len);
                for (var i = 0; i < len; i++)
                    this.WriteByte(ab[i]);
            }
        }
        return this;
    };
    dByteArray.prototype.WriteStringLength = function (len) {
        if (len <= 0x7fff)
            this.WriteShort(len);
        else {
            var a = (len & 0xFFFF8000) >> 15;
            var b = len & 0x7FFF;
            this.WriteShort(b | 0x8000);
            this.WriteShort(a);
        }
    };
    dByteArray.prototype.ReadStringLength = function () {
        var b = this.ReadUnsignedShort();
        if ((b & 0x8000) == 0)
            return b;
        b &= 0x7FFF;
        var a = this.ReadUnsignedShort();
        return (a << 15) | b;
    };
    dByteArray.prototype.WriteStringLengthed = function (data, length, charset) {
        if (charset === void 0) { charset = dStringUtils.CODE_PAGE_UTF8; }
        var arr = new dByteArray();
        arr.WriteStringEx(data, false, charset);
        arr.SetPosition(0);
        for (var i = 0; i < length; i++)
            this.WriteByte(arr.ReadByte());
    };
    dByteArray.prototype.WriteBin = function (data, startPos, length) {
        if (startPos === void 0) { startPos = -1; }
        if (length === void 0) { length = -1; }
        if (startPos == -1)
            startPos = data.GetPosition();
        var pos = data.GetPosition();
        data.SetPosition(startPos);
        if (length == -1)
            length = data.AvailableSize();
        this.WriteBinEx(data, length);
        data.SetPosition(pos);
    };
    dByteArray.prototype.WriteBinEx = function (pFrom, size) {
        var pos = this.GetPosition();
        if (size > pFrom.AvailableSize())
            size = pFrom.AvailableSize();
        this.requreSize(size);
        for (var i = 0; i < size; i++)
            this.m_pDataView.setInt8(this.addpos(1), pFrom.m_pDataView.getInt8(pFrom.m_nPosition + i));
        this.SetPosition(pos);
    };
    dByteArray.prototype.Size = function () {
        return this.m_nSize;
    };
    dByteArray.prototype.Resize = function (size) {
        if (this.Size() < size) {
            for (var i = this.Size(); i < size; i++)
                this.WriteByte(0);
        }
        else {
            this.SetPosition(0);
            this.m_nSize = size;
        }
    };
    dByteArray.prototype.AvailableSize = function () {
        return this.m_nSize - this.m_nPosition;
    };
    dByteArray.prototype.GetPosition = function () {
        return this.m_nPosition;
    };
    dByteArray.prototype.SetPosition = function (pos) {
        if (pos < 0)
            pos = 0;
        if (pos > this.Size())
            pos = this.Size();
        this.m_nPosition = pos;
    };
    dByteArray.prototype.Seek = function (pos) {
        this.SetPosition(pos);
        while (this.GetPosition() < pos) {
            this.WriteByte(0);
        }
    };
    dByteArray.prototype.Skip = function (size) {
        this.SetPosition(this.GetPosition() + size);
    };
    dByteArray.prototype.GetEndian = function () {
        return this.m_nEndian;
    };
    dByteArray.prototype.SetEndian = function (endian) {
        this.m_nEndian = endian;
    };
    dByteArray.prototype.LoadFromFile = function (url, onLoadComplete, onProgress, onFailed, startOffset, length) {
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (onProgress === void 0) { onProgress = null; }
        if (onFailed === void 0) { onFailed = null; }
        if (startOffset === void 0) { startOffset = 0; }
        if (length === void 0) { length = -1; }
        var p = this;
        dInterface.ptr.LoadArrayBuffer(url, function (response) {
            if (response) {
                p.m_pArraybuffer = response;
                p.m_pDataView = new DataView(p.m_pArraybuffer);
                p.m_nSize = p.m_nSysSize = p.m_pDataView.byteLength;
                p.m_nPosition = 0;
                if (onLoadComplete)
                    onLoadComplete(p);
            }
            else {
                if (onFailed)
                    onFailed(p);
            }
        });
    };
    dByteArray.prototype.SaveToFile = function (url, onLoadComplete, onProgress, onFailed, bShowDialog, additional) {
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (onProgress === void 0) { onProgress = null; }
        if (onFailed === void 0) { onFailed = null; }
        if (bShowDialog === void 0) { bShowDialog = false; }
        if (additional === void 0) { additional = false; }
        return false;
    };
    dByteArray.OpenFile = function (strNotify, strFileType, bMultiFile, onLoadComplete, onFailed) {
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (onFailed === void 0) { onFailed = null; }
    };
    dByteArray.prototype.EraseValid = function () {
        var ret = new dByteArray();
        ret.SetEndian(this.GetEndian());
        ret.WriteBin(this);
        ret.SetPosition(0);
        return ret;
    };
    dByteArray.prototype.Compress = function (method) {
        if (method === void 0) { method = "zlib"; }
    };
    dByteArray.prototype.Uncompress = function (method, uncompressSize) {
        if (method === void 0) { method = "zlib"; }
        if (uncompressSize === void 0) { uncompressSize = 0; }
        var out = __dByteArrayZip.zip_inflate(this.m_pDataView);
        this.m_pDataView = out.m_pDataView;
        this.m_pArraybuffer = out.m_pArraybuffer;
        this.m_nSize = out.m_nSize;
        this.m_nSysSize = out.m_nSysSize;
        this.m_nPosition = 0;
    };
    dByteArray.prototype.ToBytes = function () {
        var ret = new Array(this.Size());
        for (var i = 0, n = this.Size(); i < n; i++)
            ret[i] = this.GetByte(i);
        return ret;
    };
    dByteArray.prototype.GetBytes = function () {
        var ret = new Array(this.AvailableSize());
        for (var i = 0; this.AvailableSize() > 0; i++)
            ret[i] = this.ReadByte();
        return ret;
    };
    dByteArray.EnumFileList = function (strFilePath, bWithFolder, strExtNames) {
        if (strExtNames === void 0) { strExtNames = null; }
        return null;
    };
    dByteArray.prototype.WriteMatrix = function (mat) {
        mat.WriteToBin(this);
    };
    dByteArray.prototype.ReadMatrix = function () {
        return new dMatrix().ReadFromBin(this);
    };
    dByteArray.prototype.ReadVector2 = function () {
        return new dVector2().ReadFromBin(this);
    };
    dByteArray.prototype.ReadVector3 = function () {
        return new dVector3().ReadFromBin(this);
    };
    dByteArray.prototype.ReadVector4 = function () {
        return new dVector4().ReadFromBin(this);
    };
    dByteArray.prototype.WriteByteArray = function (data) {
        if (data == null)
            this.WriteInt(-1);
        else {
            data.SetPosition(0);
            this.WriteInt(data.Size());
            if (data.Size() > 0)
                this.WriteBin(data);
        }
    };
    dByteArray.prototype.ReadByteArray = function () {
        var size = this.ReadInt();
        if (size == -1)
            return null;
        if (size == 0)
            return new dByteArray();
        return this.ReadBinEx(size);
    };
    dByteArray.prototype.WriteArrayStringString = function (arr) {
        var e_3, _a;
        if (arr == null)
            this.WriteInt(-1);
        else {
            this.WriteInt(arr.size);
            try {
                for (var _b = __values(arr.keys()), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var key = _c.value;
                    this.WriteString(key);
                    this.WriteString(arr.get(key));
                }
            }
            catch (e_3_1) { e_3 = { error: e_3_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_3) throw e_3.error; }
            }
        }
    };
    dByteArray.prototype.ReadArrayStringString = function () {
        var size = this.ReadInt();
        if (size < 0)
            return null;
        var ret = new Map();
        for (var i = 0; i < size; i++) {
            ret.set(this.ReadString(), this.ReadString());
        }
        return ret;
    };
    dByteArray.prototype.SetClipboard = function (type) {
        if (type === void 0) { type = "DataObject"; }
    };
    dByteArray.prototype.FromClipboard = function (type) {
        if (type === void 0) { type = "DataObject"; }
        return false;
    };
    dByteArray.ReadStorage = function (key, onComplete, defaultRet) {
        if (defaultRet === void 0) { defaultRet = null; }
        dInterface.ptr.ReadStorage(key, onComplete, defaultRet);
    };
    dByteArray.WriteStorage = function (key, value) {
        dInterface.ptr.WriteStorage(key, value);
    };
    dByteArray.prototype.Utf8ArrayToStr = function (array) {
        var out, i, len, c;
        var char2, char3;
        out = "";
        len = array.length;
        i = 0;
        while (i < len) {
            c = array[i++];
            switch (c >> 4) {
                case 0:
                case 1:
                case 2:
                case 3:
                case 4:
                case 5:
                case 6:
                case 7:
                    out += String.fromCharCode(c);
                    break;
                case 12:
                case 13:
                    char2 = array[i++];
                    out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));
                    break;
                case 14:
                    char2 = array[i++];
                    char3 = array[i++];
                    out += String.fromCharCode(((c & 0x0F) << 12) |
                        ((char2 & 0x3F) << 6) |
                        ((char3 & 0x3F) << 0));
                    break;
            }
        }
        return out;
    };
    dByteArray.prototype.str2ab = function (str) {
        var s = unescape(encodeURIComponent(str));
        var buf = new ArrayBuffer(s.length);
        var bufView = new Uint8Array(buf);
        for (var i = 0, strLen = s.length; i < strLen; i++) {
            bufView[i] = s.charCodeAt(i);
        }
        return bufView;
    };
    dByteArray.BIG_ENDIAN = 0;
    dByteArray.LITTLE_ENDIAN = 1;
    return dByteArray;
}(dObject));
var __dByteArrayZip;
(function (__dByteArrayZip) {
    var zip_WSIZE = 32768;
    var zip_STORED_BLOCK = 0;
    var zip_STATIC_TREES = 1;
    var zip_DYN_TREES = 2;
    var zip_lbits = 9;
    var zip_dbits = 6;
    var zip_INBUFSIZ = 32768;
    var zip_INBUF_EXTRA = 64;
    var zip_slide;
    var zip_wp;
    var zip_fixed_tl = null;
    var zip_fixed_td;
    var zip_fixed_bl, zip_fixed_bd;
    var zip_bit_buf;
    var zip_bit_len;
    var zip_method;
    var zip_eof;
    var zip_copy_leng;
    var zip_copy_dist;
    var zip_tl, zip_td;
    var zip_bl, zip_bd;
    var zip_inflate_data;
    var zip_inflate_pos;
    var zip_MASK_BITS = new Array(0x0000, 0x0001, 0x0003, 0x0007, 0x000f, 0x001f, 0x003f, 0x007f, 0x00ff, 0x01ff, 0x03ff, 0x07ff, 0x0fff, 0x1fff, 0x3fff, 0x7fff, 0xffff);
    var zip_cplens = new Array(3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 15, 17, 19, 23, 27, 31, 35, 43, 51, 59, 67, 83, 99, 115, 131, 163, 195, 227, 258, 0, 0);
    var zip_cplext = new Array(0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 0, 99, 99);
    var zip_cpdist = new Array(1, 2, 3, 4, 5, 7, 9, 13, 17, 25, 33, 49, 65, 97, 129, 193, 257, 385, 513, 769, 1025, 1537, 2049, 3073, 4097, 6145, 8193, 12289, 16385, 24577);
    var zip_cpdext = new Array(0, 0, 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13);
    var zip_border = new Array(16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15);
    function zip_HuftList() {
        this.next = null;
        this.list = null;
    }
    function zip_HuftNode() {
        this.e = 0;
        this.b = 0;
        this.n = 0;
        this.t = null;
    }
    function zip_HuftBuild(b, n, s, d, e, mm) {
        this.BMAX = 16;
        this.N_MAX = 288;
        this.status = 0;
        this.root = null;
        this.m = 0;
        {
            var a;
            var c = new Array(this.BMAX + 1);
            var el;
            var f;
            var g;
            var h;
            var i;
            var j;
            var k;
            var lx = new Array(this.BMAX + 1);
            var p;
            var pidx;
            var q;
            var r = new zip_HuftNode();
            var u = new Array(this.BMAX);
            var v = new Array(this.N_MAX);
            var w;
            var x = new Array(this.BMAX + 1);
            var xp;
            var y;
            var z;
            var o;
            var tail;
            tail = this.root = null;
            for (i = 0; i < c.length; i++)
                c[i] = 0;
            for (i = 0; i < lx.length; i++)
                lx[i] = 0;
            for (i = 0; i < u.length; i++)
                u[i] = null;
            for (i = 0; i < v.length; i++)
                v[i] = 0;
            for (i = 0; i < x.length; i++)
                x[i] = 0;
            el = n > 256 ? b[256] : this.BMAX;
            p = b;
            pidx = 0;
            i = n;
            do {
                c[p[pidx]]++;
                pidx++;
            } while (--i > 0);
            if (c[0] == n) {
                this.root = null;
                this.m = 0;
                this.status = 0;
                return;
            }
            for (j = 1; j <= this.BMAX; j++)
                if (c[j] != 0)
                    break;
            k = j;
            if (mm < j)
                mm = j;
            for (i = this.BMAX; i != 0; i--)
                if (c[i] != 0)
                    break;
            g = i;
            if (mm > i)
                mm = i;
            for (y = 1 << j; j < i; j++, y <<= 1)
                if ((y -= c[j]) < 0) {
                    this.status = 2;
                    this.m = mm;
                    return;
                }
            if ((y -= c[i]) < 0) {
                this.status = 2;
                this.m = mm;
                return;
            }
            c[i] += y;
            x[1] = j = 0;
            p = c;
            pidx = 1;
            xp = 2;
            while (--i > 0)
                x[xp++] = (j += p[pidx++]);
            p = b;
            pidx = 0;
            i = 0;
            do {
                if ((j = p[pidx++]) != 0)
                    v[x[j]++] = i;
            } while (++i < n);
            n = x[g];
            x[0] = i = 0;
            p = v;
            pidx = 0;
            h = -1;
            w = lx[0] = 0;
            q = null;
            z = 0;
            for (; k <= g; k++) {
                a = c[k];
                while (a-- > 0) {
                    while (k > w + lx[1 + h]) {
                        w += lx[1 + h];
                        h++;
                        z = (z = g - w) > mm ? mm : z;
                        if ((f = 1 << (j = k - w)) > a + 1) {
                            f -= a + 1;
                            xp = k;
                            while (++j < z) {
                                if ((f <<= 1) <= c[++xp])
                                    break;
                                f -= c[xp];
                            }
                        }
                        if (w + j > el && w < el)
                            j = el - w;
                        z = 1 << j;
                        lx[1 + h] = j;
                        q = new Array(z);
                        for (o = 0; o < z; o++) {
                            q[o] = new zip_HuftNode();
                        }
                        if (tail == null)
                            tail = this.root = new zip_HuftList();
                        else
                            tail = tail.next = new zip_HuftList();
                        tail.next = null;
                        tail.list = q;
                        u[h] = q;
                        if (h > 0) {
                            x[h] = i;
                            r.b = lx[h];
                            r.e = 16 + j;
                            r.t = q;
                            j = (i & ((1 << w) - 1)) >> (w - lx[h]);
                            u[h - 1][j].e = r.e;
                            u[h - 1][j].b = r.b;
                            u[h - 1][j].n = r.n;
                            u[h - 1][j].t = r.t;
                        }
                    }
                    r.b = k - w;
                    if (pidx >= n)
                        r.e = 99;
                    else if (p[pidx] < s) {
                        r.e = (p[pidx] < 256 ? 16 : 15);
                        r.n = p[pidx++];
                    }
                    else {
                        r.e = e[p[pidx] - s];
                        r.n = d[p[pidx++] - s];
                    }
                    f = 1 << (k - w);
                    for (j = i >> w; j < z; j += f) {
                        q[j].e = r.e;
                        q[j].b = r.b;
                        q[j].n = r.n;
                        q[j].t = r.t;
                    }
                    for (j = 1 << (k - 1); (i & j) != 0; j >>= 1)
                        i ^= j;
                    i ^= j;
                    while ((i & ((1 << w) - 1)) != x[h]) {
                        w -= lx[h];
                        h--;
                    }
                }
            }
            this.m = lx[1];
            this.status = ((y != 0 && g != 1) ? 1 : 0);
        }
    }
    function zip_GET_BYTE() {
        if (zip_inflate_data.length == zip_inflate_pos)
            return -1;
        var ret = zip_inflate_data.getUint8(zip_inflate_pos++);
        return ret;
    }
    function zip_NEEDBITS(n) {
        while (zip_bit_len < n) {
            zip_bit_buf |= zip_GET_BYTE() << zip_bit_len;
            zip_bit_len += 8;
        }
    }
    function zip_GETBITS(n) {
        return zip_bit_buf & zip_MASK_BITS[n];
    }
    function zip_DUMPBITS(n) {
        zip_bit_buf >>= n;
        zip_bit_len -= n;
    }
    function zip_inflate_codes(buff, off, size) {
        var e;
        var t;
        var n;
        if (size == 0)
            return 0;
        n = 0;
        for (;;) {
            zip_NEEDBITS(zip_bl);
            t = zip_tl.list[zip_GETBITS(zip_bl)];
            e = t.e;
            while (e > 16) {
                if (e == 99)
                    return -1;
                zip_DUMPBITS(t.b);
                e -= 16;
                zip_NEEDBITS(e);
                t = t.t[zip_GETBITS(e)];
                e = t.e;
            }
            zip_DUMPBITS(t.b);
            if (e == 16) {
                zip_wp &= zip_WSIZE - 1;
                buff.setInt8(off + n++, zip_slide[zip_wp++] = t.n);
                if (n == size)
                    return size;
                continue;
            }
            if (e == 15)
                break;
            zip_NEEDBITS(e);
            zip_copy_leng = t.n + zip_GETBITS(e);
            zip_DUMPBITS(e);
            zip_NEEDBITS(zip_bd);
            t = zip_td.list[zip_GETBITS(zip_bd)];
            e = t.e;
            while (e > 16) {
                if (e == 99)
                    return -1;
                zip_DUMPBITS(t.b);
                e -= 16;
                zip_NEEDBITS(e);
                t = t.t[zip_GETBITS(e)];
                e = t.e;
            }
            zip_DUMPBITS(t.b);
            zip_NEEDBITS(e);
            zip_copy_dist = zip_wp - t.n - zip_GETBITS(e);
            zip_DUMPBITS(e);
            while (zip_copy_leng > 0 && n < size) {
                zip_copy_leng--;
                zip_copy_dist &= zip_WSIZE - 1;
                zip_wp &= zip_WSIZE - 1;
                buff.setInt8(off + n++, zip_slide[zip_wp++] = zip_slide[zip_copy_dist++]);
            }
            if (n == size)
                return size;
        }
        zip_method = -1;
        return n;
    }
    function zip_inflate_stored(buff, off, size) {
        var n;
        n = zip_bit_len & 7;
        zip_DUMPBITS(n);
        zip_NEEDBITS(16);
        n = zip_GETBITS(16);
        zip_DUMPBITS(16);
        zip_NEEDBITS(16);
        if (n != ((~zip_bit_buf) & 0xffff))
            return -1;
        zip_DUMPBITS(16);
        zip_copy_leng = n;
        n = 0;
        while (zip_copy_leng > 0 && n < size) {
            zip_copy_leng--;
            zip_wp &= zip_WSIZE - 1;
            zip_NEEDBITS(8);
            buff.setInt8(off + n++, zip_slide[zip_wp++] = zip_GETBITS(8));
            zip_DUMPBITS(8);
        }
        if (zip_copy_leng == 0)
            zip_method = -1;
        return n;
    }
    function zip_inflate_fixed(buff, off, size) {
        if (zip_fixed_tl == null) {
            var i;
            var l = new Array(288);
            var h;
            for (i = 0; i < 144; i++)
                l[i] = 8;
            for (; i < 256; i++)
                l[i] = 9;
            for (; i < 280; i++)
                l[i] = 7;
            for (; i < 288; i++)
                l[i] = 8;
            zip_fixed_bl = 7;
            h = new zip_HuftBuild(l, 288, 257, zip_cplens, zip_cplext, zip_fixed_bl);
            if (h.status != 0) {
                alert("HufBuild error: " + h.status);
                return -1;
            }
            zip_fixed_tl = h.root;
            zip_fixed_bl = h.m;
            for (i = 0; i < 30; i++)
                l[i] = 5;
            zip_fixed_bd = 5;
            h = new zip_HuftBuild(l, 30, 0, zip_cpdist, zip_cpdext, zip_fixed_bd);
            if (h.status > 1) {
                zip_fixed_tl = null;
                alert("HufBuild error: " + h.status);
                return -1;
            }
            zip_fixed_td = h.root;
            zip_fixed_bd = h.m;
        }
        zip_tl = zip_fixed_tl;
        zip_td = zip_fixed_td;
        zip_bl = zip_fixed_bl;
        zip_bd = zip_fixed_bd;
        return zip_inflate_codes(buff, off, size);
    }
    function zip_inflate_dynamic(buff, off, size) {
        var i;
        var j;
        var l;
        var n;
        var t;
        var nb;
        var nl;
        var nd;
        var ll = new Array(286 + 30);
        var h;
        for (i = 0; i < ll.length; i++)
            ll[i] = 0;
        zip_NEEDBITS(5);
        nl = 257 + zip_GETBITS(5);
        zip_DUMPBITS(5);
        zip_NEEDBITS(5);
        nd = 1 + zip_GETBITS(5);
        zip_DUMPBITS(5);
        zip_NEEDBITS(4);
        nb = 4 + zip_GETBITS(4);
        zip_DUMPBITS(4);
        if (nl > 286 || nd > 30)
            return -1;
        for (j = 0; j < nb; j++) {
            zip_NEEDBITS(3);
            ll[zip_border[j]] = zip_GETBITS(3);
            zip_DUMPBITS(3);
        }
        for (; j < 19; j++)
            ll[zip_border[j]] = 0;
        zip_bl = 7;
        h = new zip_HuftBuild(ll, 19, 19, null, null, zip_bl);
        if (h.status != 0)
            return -1;
        zip_tl = h.root;
        zip_bl = h.m;
        n = nl + nd;
        i = l = 0;
        while (i < n) {
            zip_NEEDBITS(zip_bl);
            t = zip_tl.list[zip_GETBITS(zip_bl)];
            j = t.b;
            zip_DUMPBITS(j);
            j = t.n;
            if (j < 16)
                ll[i++] = l = j;
            else if (j == 16) {
                zip_NEEDBITS(2);
                j = 3 + zip_GETBITS(2);
                zip_DUMPBITS(2);
                if (i + j > n)
                    return -1;
                while (j-- > 0)
                    ll[i++] = l;
            }
            else if (j == 17) {
                zip_NEEDBITS(3);
                j = 3 + zip_GETBITS(3);
                zip_DUMPBITS(3);
                if (i + j > n)
                    return -1;
                while (j-- > 0)
                    ll[i++] = 0;
                l = 0;
            }
            else {
                zip_NEEDBITS(7);
                j = 11 + zip_GETBITS(7);
                zip_DUMPBITS(7);
                if (i + j > n)
                    return -1;
                while (j-- > 0)
                    ll[i++] = 0;
                l = 0;
            }
        }
        zip_bl = zip_lbits;
        h = new zip_HuftBuild(ll, nl, 257, zip_cplens, zip_cplext, zip_bl);
        if (zip_bl == 0)
            h.status = 1;
        if (h.status != 0) {
            if (h.status == 1) {
            }
            return -1;
        }
        zip_tl = h.root;
        zip_bl = h.m;
        for (i = 0; i < nd; i++)
            ll[i] = ll[i + nl];
        zip_bd = zip_dbits;
        h = new zip_HuftBuild(ll, nd, 0, zip_cpdist, zip_cpdext, zip_bd);
        zip_td = h.root;
        zip_bd = h.m;
        if (zip_bd == 0 && nl > 257) {
            return -1;
        }
        if (h.status == 1) {
            ;
        }
        if (h.status != 0)
            return -1;
        return zip_inflate_codes(buff, off, size);
    }
    function zip_inflate_start() {
        var i;
        if (zip_slide == null)
            zip_slide = new Array(2 * zip_WSIZE);
        zip_wp = 0;
        zip_bit_buf = 0;
        zip_bit_len = 0;
        zip_method = -1;
        zip_eof = false;
        zip_copy_leng = zip_copy_dist = 0;
        zip_tl = null;
    }
    function zip_inflate_internal(buff, off, size) {
        var n, i;
        n = 0;
        while (n < size) {
            if (zip_eof && zip_method == -1)
                return n;
            if (zip_copy_leng > 0) {
                if (zip_method != zip_STORED_BLOCK) {
                    while (zip_copy_leng > 0 && n < size) {
                        zip_copy_leng--;
                        zip_copy_dist &= zip_WSIZE - 1;
                        zip_wp &= zip_WSIZE - 1;
                        buff.setInt8(off + n++, zip_slide[zip_wp++] = zip_slide[zip_copy_dist++]);
                    }
                }
                else {
                    while (zip_copy_leng > 0 && n < size) {
                        zip_copy_leng--;
                        zip_wp &= zip_WSIZE - 1;
                        zip_NEEDBITS(8);
                        buff.setInt8(off + n++, zip_slide[zip_wp++] = zip_GETBITS(8));
                        zip_DUMPBITS(8);
                    }
                    if (zip_copy_leng == 0)
                        zip_method = -1;
                }
                if (n == size)
                    return n;
            }
            if (zip_method == -1) {
                if (zip_eof)
                    break;
                zip_NEEDBITS(1);
                if (zip_GETBITS(1) != 0)
                    zip_eof = true;
                zip_DUMPBITS(1);
                zip_NEEDBITS(2);
                zip_method = zip_GETBITS(2);
                zip_DUMPBITS(2);
                zip_tl = null;
                zip_copy_leng = 0;
            }
            switch (zip_method) {
                case 0:
                    i = zip_inflate_stored(buff, off + n, size - n);
                    break;
                case 1:
                    if (zip_tl != null)
                        i = zip_inflate_codes(buff, off + n, size - n);
                    else
                        i = zip_inflate_fixed(buff, off + n, size - n);
                    break;
                case 2:
                    if (zip_tl != null)
                        i = zip_inflate_codes(buff, off + n, size - n);
                    else
                        i = zip_inflate_dynamic(buff, off + n, size - n);
                    break;
                default:
                    i = -1;
                    break;
            }
            if (i == -1) {
                if (zip_eof)
                    return 0;
                return -1;
            }
            n += i;
        }
        return n;
    }
    function zip_inflate(str) {
        var out, buff;
        var i, j;
        zip_inflate_start();
        zip_inflate_data = str;
        zip_inflate_pos = 0;
        var arrayBuffer = new ArrayBuffer(10240);
        var outData = new DataView(arrayBuffer);
        out = new dByteArray();
        while (true) {
            if ((i = zip_inflate_internal(outData, 0, outData.byteLength)) > 0) {
                var size = i;
                for (var j = 0; j < size; j++)
                    out.WriteByte(outData.getInt8(j));
            }
            else {
                zip_inflate_data = null;
                break;
            }
        }
        return out;
    }
    __dByteArrayZip.zip_inflate = zip_inflate;
    function zip_inflate2(str, progressCallback, completeCallback) {
        var out, buff;
        var i, j;
        zip_inflate_start();
        zip_inflate_data = str;
        zip_inflate_pos = 0;
        var arrayBuffer = new ArrayBuffer(10240);
        var outData = new DataView(arrayBuffer);
        out = "";
        var id = setInterval(function () {
            for (var j = 0; j < 10; j++) {
                if ((i = zip_inflate_internal(outData, 0, outData.byteLength)) > 0) {
                    progressCallback(zip_inflate_pos / str.byteLength);
                    out += String.fromCharCode.apply(null, new Uint8Array(arrayBuffer, 0, i));
                }
                else {
                    clearInterval(id);
                    out = decodeURIComponent(escape(out));
                    zip_inflate_data = null;
                    completeCallback(out);
                    break;
                }
            }
        }, 1);
    }
})(__dByteArrayZip || (__dByteArrayZip = {}));
;
var dCompleteCallback = (function (_super) {
    __extends(dCompleteCallback, _super);
    function dCompleteCallback(target) {
        if (target === void 0) { target = null; }
        var _this = _super.call(this) || this;
        _this.m_nCompleteRef = 0;
        _this.m_nCompleteRefTotal = 0;
        _this.m_onComplete = null;
        _this.m_onProgress = null;
        _this.m_pTarget = null;
        _this.m_pTarget = target;
        return _this;
    }
    dCompleteCallback.prototype.SetProgress = function (onProgress) {
        this.m_onProgress = onProgress;
    };
    dCompleteCallback.prototype.SetCompleteFun = function (onComplete) {
        this.m_onComplete = onComplete;
        if (this.m_nCompleteRef == this.m_nCompleteRefTotal && this.m_onComplete != null)
            this.m_onComplete(this.m_pTarget);
    };
    dCompleteCallback.prototype.CreateCompleteFun_Normal = function () {
        var _this = this;
        this.m_nCompleteRefTotal++;
        return function (target) {
            _this.DoComplete();
        };
    };
    dCompleteCallback.prototype.CreateFailedFun_Normal = function () {
        var _this = this;
        return function (target) {
            _this.DoComplete();
        };
    };
    dCompleteCallback.prototype.Add = function (count) {
        if (count === void 0) { count = 1; }
        this.m_nCompleteRefTotal += count;
    };
    dCompleteCallback.prototype.GetCompleteRefTotal = function () {
        return this.m_nCompleteRefTotal;
    };
    dCompleteCallback.prototype.GetCompleteRef = function () {
        return this.m_nCompleteRef;
    };
    dCompleteCallback.prototype.DoComplete = function () {
        this.m_nCompleteRef++;
        if (this.m_onProgress)
            this.m_onProgress(this, this.m_nCompleteRef * 100 / this.m_nCompleteRefTotal);
        if (this.m_nCompleteRef == this.m_nCompleteRefTotal && this.m_onComplete)
            this.m_onComplete(this.m_pTarget);
    };
    return dCompleteCallback;
}(dObject));
var dDateTime = (function (_super) {
    __extends(dDateTime, _super);
    function dDateTime() {
        var _this = _super.call(this) || this;
        _this.year = 0;
        _this.month = 0;
        _this.day = 0;
        _this.hour = 0;
        _this.minute = 0;
        _this.second = 0;
        _this.milliseconds = 0;
        return _this;
    }
    dDateTime.NowTime = function () {
        var date = new Date();
        var ret = new dDateTime();
        ret.year = date.getFullYear();
        ret.month = date.getMonth() + 1;
        ret.day = date.getDate();
        ret.hour = date.getHours();
        ret.minute = date.getMinutes();
        ret.second = date.getSeconds();
        ret.milliseconds = date.getMilliseconds();
        return ret;
    };
    dDateTime.GetTimeZone = function () {
        return 0;
    };
    dDateTime.prototype.Copy = function (from) {
        this.year = from.year;
        this.month = from.month;
        this.day = from.day;
        this.hour = from.hour;
        this.minute = from.minute;
        this.second = from.second;
        this.milliseconds = from.milliseconds;
        return this;
    };
    dDateTime.prototype.ToYearMonthDay = function (split) {
        if (split === void 0) { split = "-"; }
        var str = dStringUtils.FormatInt(this.year, 4) + split +
            dStringUtils.FormatInt(this.month, 2) + split +
            dStringUtils.FormatInt(this.day, 2);
        return str;
    };
    dDateTime.prototype.ToDosTime = function () {
        var ret = ((this.year - 1980) & 0x7f) << 25
            | (this.month + 1) << 21
            | this.day << 16
            | this.hour << 11
            | this.minute << 5
            | this.second >> 1;
        return ret;
    };
    dDateTime.prototype.ToUnixTime = function () {
        var zero = new dDateTime();
        zero.Copy(this);
        zero.AddHour(-dDateTime.GetTimeZone());
        return dMath.ToInt((zero.ToLongTime() - 62135596800000) / 1000);
    };
    dDateTime.prototype.FromUnixTime = function (value) {
        this.FromLongTime(value * 1000 + 62135596800000);
        this.AddHour(dDateTime.GetTimeZone());
        return this;
    };
    dDateTime.prototype.FromDosTime = function (value) {
        this.year = ((value >> 25) & 0x7f) + 1980;
        this.month = (value >> 21 & 0xF) - 1;
        this.day = (value >> 16) & 0x1F;
        this.hour = (value >> 11) & 0x1F;
        this.minute = (value >> 5) & 0x3F;
        this.second = (value << 1) & 0x3F;
        return this;
    };
    dDateTime.prototype.FromString = function (str, split) {
        if (split === void 0) { split = "- :"; }
        for (var i = 1; i < split.length; i++)
            str = dStringUtils.ReplaceAll(str, split.charAt(i), split.charAt(0));
        var arr = str.split(split.charAt(0));
        while (arr.length < 7)
            arr.push("");
        switch (arr[1].toLowerCase()) {
            case "jan":
                arr[1] = "1";
                break;
            case "feb":
                arr[1] = "2";
                break;
            case "mar":
                arr[1] = "3";
                break;
            case "apr":
                arr[1] = "4";
                break;
            case "may":
                arr[1] = "5";
                break;
            case "jun":
                arr[1] = "6";
                break;
            case "jul":
                arr[1] = "7";
                break;
            case "aug":
                arr[1] = "8";
                break;
            case "sep":
                arr[1] = "9";
                break;
            case "oct":
                arr[1] = "10";
                break;
            case "nov":
                arr[1] = "11";
                break;
            case "dec":
                arr[1] = "12";
                break;
        }
        this.year = dMath.ParseInt(arr[0]);
        this.month = dMath.ParseInt(arr[1]);
        this.day = dMath.ParseInt(arr[2]);
        if (this.day >= 32 && this.year < 32) {
            var tmp = this.day;
            this.day = this.year;
            this.year = tmp;
        }
        this.hour = dMath.ParseInt(arr[3]);
        this.minute = dMath.ParseInt(arr[4]);
        this.second = dMath.ParseInt(arr[5]);
        this.milliseconds = dMath.ParseInt(arr[6]);
        return this;
    };
    dDateTime.IsLeapYear = function (_year) {
        if ((_year % 4) != 0)
            return false;
        if ((_year % 100) == 0)
            return ((_year % 400) == 0);
        return true;
    };
    dDateTime.DaysInYear = function (_year) {
        return dDateTime.IsLeapYear(_year) ? 366 : 365;
    };
    dDateTime.DaysInMonth = function (_month, _year) {
        if (_month < 1)
            _month = 1;
        else if (_month > 12)
            _month = 12;
        var days = dDateTime.DaysInYear(_year);
        if (days == 366)
            return dDateTime.m2[_month - 1];
        return dDateTime.m1[_month - 1];
    };
    dDateTime.DateToSeconds = function (year, month, day) {
        if (year < 1)
            year = 1;
        if (month < 1)
            month = 1;
        else if (month > 12)
            month = 12;
        var daysToMonth = dDateTime.IsLeapYear(year) ? dDateTime.DaysToMonth366 : dDateTime.DaysToMonth365;
        if (day < 1)
            day = 1;
        else if (day > daysToMonth[month] - daysToMonth[month - 1])
            day = daysToMonth[month] - daysToMonth[month - 1];
        var previousYear = year - 1;
        var daysInPreviousYears = ((((previousYear * 365) + dMath.ToInt(previousYear / 4)) - dMath.ToInt(previousYear / 100)) + dMath.ToInt(previousYear / 400));
        var totalDays = ((daysInPreviousYears + daysToMonth[month - 1]) + day) - 1;
        return totalDays * 86400;
    };
    dDateTime.TimeToSeconds = function (_hour, _minute, _second) {
        if (_hour < 0)
            _hour = 0;
        else if (_hour > 24)
            _hour = 24;
        if (_minute < 0)
            _minute = 0;
        else if (_minute > 60)
            _minute = 60;
        if (_second < 0)
            _second = 0;
        else if (_second > 60)
            _second = 60;
        var totalSeconds = ((_hour * 3600) + (_minute * 60)) + _second;
        return totalSeconds;
    };
    dDateTime.prototype.FromLongTime = function (value) {
        this.milliseconds = value % 1000;
        value = dMath.ToInt(value / 1000);
        this.second = value % 60;
        value = dMath.ToInt(value / 60);
        this.minute = value % 60;
        value = dMath.ToInt(value / 60);
        this.hour = value % 24;
        value = dMath.ToInt(value / 24);
        var year, month, day;
        year = dMath.ToInt(value / 366) + 1;
        value -= dMath.ToInt(dDateTime.DateToSeconds(year, 1, 1) / 86400);
        if (value < 0)
            value = 0;
        for (; value >= dDateTime.DaysInYear(year); year++)
            value -= dDateTime.DaysInYear(year);
        for (month = 1; value >= dDateTime.DaysInMonth(month, year); month++)
            value -= dDateTime.DaysInMonth(month, year);
        day = value + 1;
        if (day < 1)
            day = 1;
        this.year = year;
        this.month = month;
        this.day = day;
        return this;
    };
    dDateTime.prototype.ToLongTime = function () {
        var timestamp = dDateTime.DateToSeconds(this.year, this.month, this.day)
            + dDateTime.TimeToSeconds(this.hour, this.minute, this.second);
        return timestamp * 1000 + this.milliseconds;
    };
    dDateTime.prototype.ToMinuteSecond = function () {
        return dStringUtils.FormatInt(this.minute, 2) + ":" +
            dStringUtils.FormatInt(this.second, 2);
    };
    dDateTime.prototype.ToHourMinute = function () {
        var h = (dMath.Min(1, this.day) - 1) * 24 + this.hour;
        return dStringUtils.FormatInt(h, 2) + ":" +
            dStringUtils.FormatInt(this.minute, 2);
    };
    dDateTime.prototype.ToHourMinuteSecond = function () {
        var h = (dMath.Min(1, this.day) - 1) * 24 + this.hour;
        return dStringUtils.FormatInt(h, 2) + ":" +
            dStringUtils.FormatInt(this.minute, 2) + ":" +
            dStringUtils.FormatInt(this.second, 2);
    };
    dDateTime.prototype.ToStringBuffer = function (split, bWithMilliseconds) {
        if (split === void 0) { split = "- :"; }
        if (bWithMilliseconds === void 0) { bWithMilliseconds = false; }
        var split0 = split.charAt(0);
        var split1 = split.charAt(1);
        var split2 = split.charAt(2);
        if (split0 == null)
            split0 = "";
        if (split1 == null)
            split1 = "";
        if (split2 == null)
            split2 = "";
        var str = dStringUtils.FormatInt(this.year, 4) + split0 +
            dStringUtils.FormatInt(this.month, 2) + split0 +
            dStringUtils.FormatInt(this.day, 2) + split1 +
            dStringUtils.FormatInt(this.hour, 2) + split2 +
            dStringUtils.FormatInt(this.minute, 2) + split2 +
            dStringUtils.FormatInt(this.second, 2);
        if (bWithMilliseconds)
            str += split2 + dStringUtils.FormatInt(this.milliseconds, 3);
        return str;
    };
    dDateTime.prototype.GetDays = function () {
        return dMath.ToInt(dDateTime.DateToSeconds(this.year, this.month, this.day) / 86400);
    };
    dDateTime.prototype.GetWeek = function () {
        var C = dMath.ToInt(this.year / 100);
        var Y = this.year % 100;
        var M = this.month;
        if (M == 1 || M == 2) {
            M += 12;
            Y--;
        }
        var D = this.day;
        var W = (Y + dMath.ToInt(Y / 4) + dMath.ToInt(C / 4) - 2 * C + (26 * dMath.ToInt((M + 1) / 10)) + D - 1) % 7;
        if (W < 0)
            W = (W + 7) % 7;
        if (W == 0)
            W = 7;
        return W;
    };
    dDateTime.prototype.GetWeeks = function (offsetStartAtSunday) {
        if (offsetStartAtSunday === void 0) { offsetStartAtSunday = 0; }
        var days = this.GetDays() + 4 + 8 - offsetStartAtSunday;
        var ret = dMath.ToInt(days / 7);
        return ret;
    };
    dDateTime.prototype.AddMilliseconds = function (add) {
        var now = this.ToLongTime();
        now += add;
        this.FromLongTime(now);
        return this;
    };
    dDateTime.prototype.AddSecond = function (add) {
        this.second += add;
        if (this.second >= 60) {
            this.AddMinute(dMath.ToInt(this.second / 60));
            this.second %= 60;
        }
        else if (this.second < 0) {
            this.AddMinute(dMath.ToInt(this.second / 60) - 1);
            this.second %= 60;
            this.second += 60;
        }
        return this;
    };
    dDateTime.prototype.AddMinute = function (add) {
        this.minute += add;
        if (this.minute >= 60) {
            this.AddHour(dMath.ToInt(this.minute / 60));
            this.minute %= 60;
        }
        else if (this.minute < 0) {
            this.AddHour(dMath.ToInt(this.minute / 60) - 1);
            this.minute %= 60;
            this.minute += 60;
        }
        return this;
    };
    dDateTime.prototype.AddHour = function (add) {
        this.hour += add;
        if (this.hour >= 24) {
            this.AddDay(dMath.ToInt(this.hour / 24));
            this.hour %= 24;
        }
        else if (this.hour < 0) {
            this.AddDay(dMath.ToInt(this.hour / 24) - 1);
            this.hour %= 24;
            this.hour += 24;
        }
        return this;
    };
    dDateTime.prototype.AddDay = function (add) {
        this.day += add;
        var maxDays = dDateTime.DaysInMonth(this.month, this.year);
        while (this.day > maxDays) {
            this.day -= maxDays;
            this.AddMonth(1);
            maxDays = dDateTime.DaysInMonth(this.month, this.year);
        }
        while (this.day <= 0) {
            this.AddMonth(-1);
            maxDays = dDateTime.DaysInMonth(this.month, this.year);
            this.day += maxDays;
        }
        return this;
    };
    dDateTime.prototype.AddMonth = function (add) {
        this.month += add;
        while (this.month > 12) {
            this.AddYear(1);
            this.month -= 12;
        }
        while (this.month <= 0) {
            this.AddYear(-1);
            this.month += 12;
        }
        return this;
    };
    dDateTime.prototype.AddYear = function (add) {
        this.year += add;
        return this;
    };
    dDateTime.prototype.Compare = function (time) {
        var a1 = this.ToLongTime();
        var a2 = time.ToLongTime();
        if (a1 < a2)
            return -1;
        if (a1 == a2)
            return 0;
        return 1;
    };
    dDateTime.prototype.CompareYearMonthDay = function (time) {
        if (time == null)
            return 1;
        if (this.year < time.year)
            return -1;
        if (this.year > time.year)
            return 1;
        if (this.month < time.month)
            return -1;
        if (this.month > time.month)
            return 1;
        if (this.day < time.day)
            return -1;
        if (this.day > time.day)
            return 1;
        return 0;
    };
    dDateTime.prototype.Sub = function (other) {
        var sub = this.ToLongTime() - other.ToLongTime();
        return new dDateTime().FromLongTime(sub);
    };
    dDateTime.prototype.Add = function (other) {
        var add = this.ToLongTime() + other.ToLongTime();
        return new dDateTime().FromLongTime(add);
    };
    dDateTime.DaysToMonth365 = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365];
    dDateTime.DaysToMonth366 = [0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366];
    dDateTime.m1 = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    dDateTime.m2 = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    return dDateTime;
}(dObject));
var dFilePacker = (function () {
    function dFilePacker() {
        this.m_strFromFileName = "";
        this.m_pFromBin = null;
        this.m_nHeaderSize = 0;
        this.m_mapFile = new Map();
        this.m_pPasswordKey = null;
    }
    dFilePacker.prototype.LoadFromFile = function (fileName, onComplete) {
        var _this = this;
        var arr = new dByteArray();
        arr.LoadFromFile(fileName, function () {
            _this.LoadFromBin(arr);
            _this.m_pFromBin = null;
            _this.m_strFromFileName = fileName;
            if (onComplete)
                onComplete(_this);
        });
    };
    dFilePacker.prototype.SetPassword = function (password) {
        if (password == null)
            this.m_pPasswordKey = null;
        else {
            var arr = new dByteArray();
            arr.WriteStringEx(password, false);
            this.m_pPasswordKey = new Array(arr.Size());
            for (var i = 0; i < arr.Size(); i++)
                this.m_pPasswordKey[i] = arr.GetByte(i) & 0xff;
        }
    };
    dFilePacker.prototype.LoadFromBin = function (bin) {
        this.m_strFromFileName = null;
        this.m_pFromBin = bin;
        var pos = 0;
        var magic = this.m_pFromBin.ReadInt();
        if (magic == dStringUtils.FourCC("D", "G", "F", "P")) {
            var version = this.m_pFromBin.ReadInt();
            this.m_nHeaderSize = this.m_pFromBin.ReadInt();
            var fileCount = this.m_pFromBin.ReadInt();
            for (var i = 0; i < fileCount; ++i) {
                var obj = new dFilePacker_FILE_OBJ();
                obj.fileName = this.m_pFromBin.ReadString();
                obj.size = this.m_pFromBin.ReadInt();
                obj.startOffset = this.m_pFromBin.ReadInt();
                obj.fileCrc = this.m_pFromBin.ReadInt();
                obj.fileDate = this.m_pFromBin.ReadInt();
                obj.fileExt = this.m_pFromBin.ReadInt();
                obj.fileFlag = this.m_pFromBin.ReadInt();
                obj.buffer = this.GetBuffer(this.m_pFromBin, obj.startOffset + this.m_nHeaderSize, obj.size);
                obj.fromType = dFilePacker.FROM_PACKAGE;
                this.m_mapFile.set(obj.fileName, obj);
            }
            return true;
        }
        return false;
    };
    dFilePacker.prototype.GetBuffer = function (arr, startOffset, maxLength) {
        var oldPos = arr.GetPosition();
        arr.SetPosition(startOffset);
        var arr2 = arr.ReadBinEx(maxLength);
        arr.SetPosition(oldPos);
        return arr2;
    };
    dFilePacker.prototype.GetFile = function (fileName, startOffset, maxLength) {
        if (startOffset === void 0) { startOffset = 0; }
        if (maxLength === void 0) { maxLength = -1; }
        if (!this.m_mapFile.has(fileName))
            fileName = fileName.toLowerCase();
        if (!this.m_mapFile.has(fileName))
            return null;
        var pObj = this.m_mapFile.get(fileName);
        if (pObj.buffer != null)
            return pObj.buffer;
        if (maxLength == -1)
            maxLength = pObj.size;
        else if (maxLength > pObj.size)
            maxLength = pObj.size;
        if (pObj.fromType == dFilePacker.FROM_PACKAGE) {
            if (pObj.buffer != null)
                return pObj.buffer;
            if (this.m_pFromBin != null) {
                this.m_pFromBin.SetPosition(pObj.startOffset + this.m_nHeaderSize + startOffset);
                return this.m_pFromBin.ReadBinEx(maxLength);
            }
            if (this.m_strFromFileName != null) {
                var arr = new dByteArray();
                arr.LoadFromFile(this.m_strFromFileName, null, null, null, pObj.startOffset + this.m_nHeaderSize + startOffset, maxLength);
                return arr;
            }
        }
        else if (pObj.fromType == dFilePacker.FROM_FILE) {
            var arr = new dByteArray();
            var pathFile = "";
            if (pObj.path != null)
                pathFile = pObj.path + "/";
            pathFile += pObj.fileName;
            arr.LoadFromFile(pathFile, null, null, null, startOffset, maxLength);
            return arr;
        }
        else if (pObj.fromType == dFilePacker.FROM_MEMORY) {
            if (startOffset == 0)
                return pObj.buffer;
            if (pObj.buffer == null)
                return null;
            pObj.buffer.SetPosition(startOffset);
            var arr = pObj.buffer.ReadBinEx(maxLength);
            return arr;
        }
        return null;
    };
    dFilePacker.prototype.GetFileS = function (fileName, code_page) {
        if (code_page === void 0) { code_page = dStringUtils.CODE_PAGE_UTF8; }
        var arr = this.GetFile(fileName);
        if (arr != null)
            return arr.ToStringBuffer(code_page);
        return null;
    };
    dFilePacker.prototype.AddFileFromMemory = function (fileName, data) {
        var obj = new dFilePacker_FILE_OBJ();
        obj.fileName = fileName;
        obj.buffer = data;
        obj.fromType = dFilePacker.FROM_MEMORY;
        obj.size = data.Size();
        this.m_mapFile.set(fileName, obj);
    };
    dFilePacker.prototype.GetFileCount = function () {
        return this.m_mapFile.size;
    };
    dFilePacker.prototype.SaveToBin = function (outData) {
        var e_4, _a, e_5, _b;
        outData.WriteInt(dStringUtils.FourCC("D", "G", "F", "P"));
        outData.WriteInt(1);
        outData.WriteInt(0);
        outData.WriteInt(this.m_mapFile.size);
        var startOffset = 0;
        try {
            for (var _c = __values(this.m_mapFile.keys()), _d = _c.next(); !_d.done; _d = _c.next()) {
                var key = _d.value;
                var pObj = this.m_mapFile.get(key);
                outData.WriteString(pObj.fileName.toLowerCase());
                outData.WriteInt(pObj.size);
                pObj.startOffset = startOffset;
                startOffset += pObj.size;
                outData.WriteInt(pObj.startOffset);
                outData.WriteInt(pObj.fileCrc);
                outData.WriteInt(pObj.fileDate);
                outData.WriteInt(pObj.fileExt);
                outData.WriteInt(pObj.fileFlag);
            }
        }
        catch (e_4_1) { e_4 = { error: e_4_1 }; }
        finally {
            try {
                if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
            }
            finally { if (e_4) throw e_4.error; }
        }
        this.m_nHeaderSize = outData.GetPosition();
        outData.SetPosition(8);
        outData.WriteInt(this.m_nHeaderSize);
        outData.SetPosition(this.m_nHeaderSize);
        var crc = 0;
        try {
            for (var _e = __values(this.m_mapFile.keys()), _f = _e.next(); !_f.done; _f = _e.next()) {
                var key = _f.value;
                var pObj = this.m_mapFile.get(key);
                var arr = this.GetFile(pObj.fileName);
                if (this.m_pPasswordKey != null) {
                    arr.SetPosition(0);
                    var arr2 = new dByteArray();
                    for (var i = 0, n = arr.AvailableSize(); i < n; i++)
                        arr2.WriteByte((arr.ReadByte() ^ this.m_pPasswordKey[i % this.m_pPasswordKey.length]) & 0xff);
                    arr2.SetPosition(0);
                    arr = arr2;
                }
                outData.WriteBin(arr, 0, arr.Size());
            }
        }
        catch (e_5_1) { e_5 = { error: e_5_1 }; }
        finally {
            try {
                if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
            }
            finally { if (e_5) throw e_5.error; }
        }
        outData.WriteInt(crc);
    };
    dFilePacker.FROM_PACKAGE = 0;
    dFilePacker.FROM_FILE = 1;
    dFilePacker.FROM_MEMORY = 2;
    return dFilePacker;
}());
var dFilePacker_FILE_OBJ = (function () {
    function dFilePacker_FILE_OBJ() {
        this.fileName = "";
        this.path = "";
        this.buffer = null;
        this.size = 0;
        this.startOffset = 0;
        this.fileCrc = 0;
        this.fileDate = 0;
        this.fileExt = 0;
        this.fileFlag = 0;
        this.fromType = 0;
    }
    return dFilePacker_FILE_OBJ;
}());
var dInterface = (function () {
    function dInterface() {
        var _this = this;
        this.m_mainCanvas = null;
        this.m_pMainThread = null;
        this.m_vecTimer = new Array();
        this.m_vecTimerWillDelete = new Array();
        this.m_vecShaders = new Array();
        this.m_nLastTick = 0;
        this.webgl = null;
        this.m_nLastWidth = 0;
        this.m_nLastHeight = 0;
        this.m_nMaxMultiTouchPointCount = 1;
        this.m_nGlobalMouseX = 0;
        this.m_nGlobalMouseY = 0;
        this.m_mapSpriteMouseEvent = new Map();
        this.m_nGCTimeAdd = 0;
        this.m_nRenderTick = 0;
        this.m_arrBitmapBuffer = new Map();
        this.m_arrTextureBuffer = new Map();
        this.m_pLastUseShader = null;
        this.m_nLastInnerWidth = 0;
        this.m_nLastInnerHeight = 0;
        this.m_pInputBox = null;
        this.m_pInputBoxOnCanel = null;
        this.m_pInputBoxOnConfirm = null;
        this.m_bWindowActive = true;
        this.m_pixelRatio = 1;
        this.m_onRewardedCallback = null;
        this.m_bRewardedVideoShowing = false;
        this.m_bRewardedVideoVerifyed = false;
        this.m_arrAudios = new Array();
        this.m_bannerAd = null;
        this.m_banderAdShowing = false;
        this.m_boxPortalAd = null;
        this.m_rewardedAd = null;
        this.m_rewardedCompleteCallback = null;
        this.api = null;
        this.m_globalAudioVolume = 1;
        this.m_vecSubPackageData = null;
        this.m_onErrCallback = null;
        this.m_bHideRender = false;
        this.m_audioContext = null;
        this.m_arrAudioDataBuffer = null;
        this.m_recordVideoPath = "";
        this.m_bRecording = false;
        this.m_startRecordTime = 0;
        this.m_stopRecordTime = 0;
        this.m_arrCurMouseDownList = new Map();
        this.m_userdeviceId = "";
        if (window && window.sdkName)
            dInterface.sdkName = window.sdkName;
        if (window && window.wx)
            this.api = window.wx;
        if (window && window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.InitSdk)
            window.webkit.messageHandlers.InitSdk.postMessage("");
        console.log("sdkName: " + dInterface.sdkName + " channel: " + this.GetChannelName());
        if (dInterface.sdkName == "node") {
        }
        else {
            if (dInterface.sdkName == "web" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg" || dInterface.sdkName == "hw") {
                this.m_pixelRatio = window.devicePixelRatio;
                this.m_mainCanvas = window.canvas || document.createElement("canvas");
                document.body.appendChild(this.m_mainCanvas);
                this.m_mainCanvas.style.width = String(window.innerWidth);
                this.m_mainCanvas.style.height = String(window.innerHeight);
                this.m_mainCanvas.style.position = "absolute";
                this.m_mainCanvas.width = window.innerWidth * window.devicePixelRatio;
                this.m_mainCanvas.height = window.innerHeight * window.devicePixelRatio;
            }
            else {
                if (dInterface.sdkName == "vivo")
                    this.m_pixelRatio = 1;
                else
                    this.m_pixelRatio = this.api.getSystemInfoSync().pixelRatio;
                if (dInterface.sdkName == "oppo")
                    this.m_mainCanvas = document.getElementById('canvas');
                else
                    this.m_mainCanvas = window.canvas || this.CreateCanvas();
                window.innerWidth = this.api.getSystemInfoSync().screenWidth;
                window.innerHeight = this.api.getSystemInfoSync().screenHeight;
                this.m_mainCanvas.width = window.innerWidth * this.m_pixelRatio;
                this.m_mainCanvas.height = window.innerHeight * this.m_pixelRatio;
                if (dInterface.sdkName == "vivo" || dInterface.sdkName == "oppo" || dInterface.sdkName == "mi" || dInterface.sdkName == "hw") {
                    window.resize = function () {
                        window.innerWidth = _this.api.getSystemInfoSync().screenWidth;
                        window.innerHeight = _this.api.getSystemInfoSync().screenHeight;
                        _this.m_mainCanvas.width = window.innerWidth * _this.m_pixelRatio;
                        _this.m_mainCanvas.height = window.innerHeight * _this.m_pixelRatio;
                    };
                }
            }
            this.m_nLastInnerWidth = window.innerWidth;
            this.m_nLastInnerHeight = window.innerHeight;
            this.webgl = this.m_mainCanvas.getContext("experimental-webgl", { preserveDrawingBuffer: false }) || this.m_mainCanvas.getContext("webgl", { preserveDrawingBuffer: false });
            if (!this.webgl)
                alert("webgl not support!");
            if (dInterface.sdkName == "web" || dInterface.sdkName == "oppo" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg" || dInterface.sdkName == "hw") {
                this.m_mainCanvas.addEventListener('touchstart', function (e) {
                    e.preventDefault();
                    if (dInterface.sdkName == "hw") {
                        if (window && window.onTouchFun)
                            window.onTouchFun();
                    }
                });
                this.m_mainCanvas.addEventListener('touchend', function (e) {
                    e.preventDefault();
                });
                this.m_mainCanvas.addEventListener('touchmove', function (e) {
                    e.preventDefault();
                });
                var touch = function (event) {
                    if ((!_this.m_pInputBox || _this.m_pInputBox.style.visibility == "hidden")) {
                        var multiTouch = _this.GetMultiTouchPointCount() != 1;
                        var event = event || window.event;
                        switch (event.type) {
                            case "touchstart":
                                for (var i = 0; i < event.touches.length; i++)
                                    _this.FrameMouseEvent(dSprite.MOUSE_LBUTTONDOWN, multiTouch ? event.touches[i].identifier : 0, event.touches[i].clientX * _this.m_pixelRatio, event.touches[i].clientY * _this.m_pixelRatio, 1.0);
                                break;
                            case "touchend":
                            case "touchcancel":
                                for (var i = 0; i < event.changedTouches.length; i++)
                                    _this.FrameMouseEvent(dSprite.MOUSE_LBUTTONUP, multiTouch ? event.changedTouches[i].identifier : 0, event.changedTouches[i].clientX * _this.m_pixelRatio, event.changedTouches[i].clientY * _this.m_pixelRatio, 1.0);
                                break;
                            case "touchmove":
                                for (var i = 0; i < event.touches.length; i++)
                                    _this.FrameMouseEvent(dSprite.MOUSE_MOVE, multiTouch ? event.touches[i].identifier : 0, event.touches[i].clientX * _this.m_pixelRatio, event.touches[i].clientY * _this.m_pixelRatio, 1.0);
                                break;
                        }
                    }
                    else if (_this.m_pInputBox && event.type == "touchstart")
                        _this.HideInputBox(true);
                };
                document.addEventListener("touchstart", touch, false);
                document.addEventListener("touchmove", touch, false);
                document.addEventListener("touchend", touch, false);
                document.addEventListener("touchcancel", touch, false);
                this.m_mainCanvas.onmousedown = function (e) {
                    if (!_this.m_pInputBox || _this.m_pInputBox.style.visibility == "hidden") {
                        _this.FrameMouseEvent(dSprite.MOUSE_LBUTTONDOWN, 0, e.clientX * _this.m_pixelRatio, e.clientY * _this.m_pixelRatio, 1.0);
                        e.preventDefault();
                    }
                    else if (_this.m_pInputBox)
                        _this.HideInputBox(true);
                };
                this.m_mainCanvas.onmouseup = function (e) {
                    if (!_this.m_pInputBox || _this.m_pInputBox.style.visibility == "hidden") {
                        _this.FrameMouseEvent(dSprite.MOUSE_LBUTTONUP, 0, e.clientX * _this.m_pixelRatio, e.clientY * _this.m_pixelRatio, 1.0);
                        e.preventDefault();
                    }
                };
                this.m_mainCanvas.onmousemove = function (e) {
                    if (!_this.m_pInputBox || _this.m_pInputBox.style.visibility == "hidden") {
                        _this.FrameMouseEvent(dSprite.MOUSE_MOVE, 0, e.clientX * _this.m_pixelRatio, e.clientY * _this.m_pixelRatio, 1.0);
                        e.preventDefault();
                    }
                };
                if (dInterface.sdkName == "mg" && this.api.volumeEventListener) {
                    this.api.volumeEventListener(function (res) {
                        var volume = 0;
                        if (res.type = 0) {
                            volume = 1;
                        }
                        else {
                            volume = Number(res.ratio);
                        }
                        _this.m_globalAudioVolume = volume;
                        for (var i = 0; i < _this.m_arrAudios.length; i++) {
                            var audio = _this.m_arrAudios[i];
                            audio.volume = (audio.srcVolume != undefined ? audio.srcVolume : 1) * _this.m_globalAudioVolume;
                        }
                    });
                }
                var hidden = "hidden";
                var pThis = this;
                var onchange = function (evt) {
                    var v = 'visible', h = 'hidden', evtMap = {
                        focus: v, focusin: v, pageshow: v, blur: h, focusout: h, pagehide: h
                    };
                    evt = evt || window.event;
                    var active;
                    if (evt.type in evtMap)
                        active = evtMap[evt.type];
                    else if (Object(this).visibilityState)
                        active = Object(this).visibilityState == "hidden" ? "hidden" : "visible";
                    else
                        active = Object(this)[hidden] ? "hidden" : "visible";
                    if (active == "hidden") {
                        dInterface.ptr.m_bWindowActive = false;
                        pThis.OnFrameActive(false);
                    }
                    else {
                        dInterface.ptr.m_bWindowActive = true;
                        pThis.OnFrameActive(true);
                    }
                };
                if (hidden in document)
                    document.addEventListener("visibilitychange", onchange);
                else if ((hidden = "mozHidden") in document)
                    document.addEventListener("mozvisibilitychange", onchange);
                else if ((hidden = "webkitHidden") in document)
                    document.addEventListener("webkitvisibilitychange", onchange);
                else if ((hidden = "msHidden") in document)
                    document.addEventListener("msvisibilitychange", onchange);
                else
                    window.onpageshow = window.onpagehide = window.onfocus = window.onblur = onchange;
            }
            else {
                if (dInterface.sdkName == "mi") {
                    this.m_mainCanvas.addEventListener('touchstart', function (e) {
                        e.preventDefault();
                    });
                    this.m_mainCanvas.addEventListener('touchend', function (e) {
                        e.preventDefault();
                    });
                    this.m_mainCanvas.addEventListener('touchmove', function (e) {
                        e.preventDefault();
                    });
                }
                this.api.onTouchStart(function (event) {
                    if (!_this.m_pInputBox || _this.m_pInputBox.style.visibility == "hidden") {
                        var multiTouch = _this.GetMultiTouchPointCount() != 1;
                        for (var i = 0; i < event.touches.length; i++)
                            _this.FrameMouseEvent(dSprite.MOUSE_LBUTTONDOWN, multiTouch ? event.touches[i].identifier : 0, event.touches[i].clientX * _this.m_pixelRatio, event.touches[i].clientY * _this.m_pixelRatio, 1.0);
                    }
                    else if (_this.m_pInputBox)
                        _this.HideInputBox(true);
                });
                this.api.onTouchMove(function (event) {
                    if (!_this.m_pInputBox || _this.m_pInputBox.style.visibility == "hidden") {
                        var multiTouch = _this.GetMultiTouchPointCount() != 1;
                        for (var i = 0; i < event.touches.length; i++)
                            _this.FrameMouseEvent(dSprite.MOUSE_MOVE, multiTouch ? event.touches[i].identifier : 0, event.touches[i].clientX * _this.m_pixelRatio, event.touches[i].clientY * _this.m_pixelRatio, 1.0);
                    }
                });
                this.api.onTouchEnd(function (event) {
                    if (!_this.m_pInputBox || _this.m_pInputBox.style.visibility == "hidden") {
                        var multiTouch = _this.GetMultiTouchPointCount() != 1;
                        for (var i = 0; i < event.changedTouches.length; i++)
                            _this.FrameMouseEvent(dSprite.MOUSE_LBUTTONUP, multiTouch ? event.changedTouches[i].identifier : 0, event.changedTouches[i].clientX * _this.m_pixelRatio, event.changedTouches[i].clientY * _this.m_pixelRatio, 1.0);
                    }
                });
                this.api.onTouchCancel(function (event) {
                    if (!_this.m_pInputBox || _this.m_pInputBox.style.visibility == "hidden") {
                        var multiTouch = _this.GetMultiTouchPointCount() != 1;
                        for (var i = 0; i < event.changedTouches.length; i++)
                            _this.FrameMouseEvent(dSprite.MOUSE_LBUTTONUP, multiTouch ? event.changedTouches[i].identifier : 0, event.changedTouches[i].clientX * _this.m_pixelRatio, event.changedTouches[i].clientY * _this.m_pixelRatio, 1.0);
                    }
                });
                this.api.onShow(function (options) {
                    if (options && options.scene) {
                    }
                    dInterface.ptr.m_bWindowActive = true;
                    _this.OnFrameActive(true);
                });
                this.api.onHide(function () {
                    dInterface.ptr.m_bWindowActive = false;
                    _this.OnFrameActive(false);
                });
            }
        }
        if (this.GetSdkName() == "node") {
            setInterval(function () {
                _this.MainFrameMove();
            }, 16);
        }
        else {
            setTimeout(function () {
                var animloop = function () {
                    if (dInterface.ptr.m_pMainThread) {
                        if (!_this.m_onErrCallback)
                            _this.MainFrameMove();
                        else {
                            try {
                                _this.MainFrameMove();
                            }
                            catch (err) {
                                if (_this.m_onErrCallback)
                                    _this.m_onErrCallback(err);
                            }
                        }
                    }
                    requestAnimationFrame(animloop);
                };
                requestAnimationFrame(animloop);
            });
        }
    }
    Object.defineProperty(dInterface, "ptr", {
        get: function () {
            if (!dInterface.s_ptr)
                dInterface.s_ptr = new dInterface();
            return dInterface.s_ptr;
        },
        enumerable: false,
        configurable: true
    });
    dInterface.prototype.OnFrameActive = function (bActive) {
        if (dInterface.sdkName == "web" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg" ||
            dInterface.sdkName == "bd" || dInterface.sdkName == "mi") {
            if (bActive)
                this.ResumeAllSound();
            else
                this.PauseAllSound();
        }
        if (this.m_pMainThread)
            this.m_pMainThread.OnFrameActive(bActive);
    };
    dInterface.prototype.PauseAllSound = function () {
        if (this.m_audioContext && this.m_audioContext.suspend && this.m_audioContext.resume)
            this.m_audioContext.suspend();
        else {
            for (var i = 0; i < this.m_arrAudios.length; i++) {
                var audio = this.m_arrAudios[i];
                audio.volume = 0;
                audio.pause();
            }
        }
    };
    dInterface.prototype.ResumeAllSound = function () {
        if (!this.m_bWindowActive)
            return;
        if (this.m_audioContext && this.m_audioContext.suspend && this.m_audioContext.resume)
            this.m_audioContext.resume();
        else {
            for (var i = 0; i < this.m_arrAudios.length; i++) {
                var audio = this.m_arrAudios[i];
                audio.volume = audio.srcVolume * this.m_globalAudioVolume;
                audio.play();
            }
        }
    };
    dInterface.prototype.SetMultiTouchPointCount = function (count) {
        this.m_nMaxMultiTouchPointCount = count;
    };
    dInterface.prototype.GetMultiTouchPointCount = function () {
        return this.m_nMaxMultiTouchPointCount;
    };
    dInterface.FrameSetClipboard = function (str) {
        navigator.clipboard.writeText(str);
    };
    dInterface.prototype.GetRenderTick = function () {
        return this.m_nRenderTick;
    };
    dInterface.prototype.MainFrameMove = function () {
        var e_6, _a, e_7, _b;
        if (this.m_bHideRender)
            return;
        if (this.m_mainCanvas) {
            if (this.m_nLastInnerWidth != window.innerWidth || this.m_nLastInnerHeight != window.innerHeight) {
                this.m_nLastInnerWidth = window.innerWidth;
                this.m_nLastInnerHeight = window.innerHeight;
                this.m_mainCanvas.style.width = String(window.innerWidth);
                this.m_mainCanvas.style.height = String(window.innerHeight);
                this.m_mainCanvas.width = window.innerWidth * this.m_pixelRatio;
                this.m_mainCanvas.height = window.innerHeight * this.m_pixelRatio;
            }
            var windowWidth = this.GetWindowWidth();
            var windowHeight = this.GetWindowHeight();
            if (this.m_nLastWidth != windowWidth || this.m_nLastHeight != windowHeight) {
                this.m_nLastWidth = windowWidth;
                this.m_nLastHeight = windowHeight;
                this.OnResize(windowWidth, windowHeight);
            }
        }
        if (this.webgl) {
            this.webgl.viewport(0, 0, windowWidth, windowHeight);
            this.webgl.clearDepth(1.0);
            this.webgl.clearStencil(0);
            this.webgl.clearColor(0, 0, 0, 1);
            this.webgl.clear(this.webgl.COLOR_BUFFER_BIT | this.webgl.DEPTH_BUFFER_BIT | this.webgl.STENCIL_BUFFER_BIT);
        }
        var curTick = dTimer.GetTickCount();
        this.m_nRenderTick = curTick;
        var elapse = curTick - this.m_nLastTick;
        for (var i = 0; i < this.m_vecTimer.length; i++) {
            this.m_vecTimer[i](elapse, curTick);
        }
        if (this.m_vecTimerWillDelete.length > 0) {
            for (var i = 0; i < this.m_vecTimerWillDelete.length; i++) {
                this.m_vecTimer.remove(this.m_vecTimerWillDelete[i]);
            }
            this.m_vecTimerWillDelete.clear();
        }
        if (dInterface.s_onFrameEnd.length > 0) {
            for (var i = 0, n = dInterface.s_onFrameEnd.length; i < n; i++)
                dInterface.s_onFrameEnd[i](this);
        }
        this.m_pLastUseShader = null;
        var rootSprite = dThread.GetRootBackgroudSprite();
        if (rootSprite && this.webgl) {
            dSprite.EnableScissorTest(true, 0, 0, windowWidth, windowHeight, windowWidth, windowHeight, null, false);
            rootSprite.Render(windowWidth, windowHeight);
            this.m_nGCTimeAdd += elapse;
            if (this.m_nGCTimeAdd > 1000) {
                this.m_nGCTimeAdd = 0;
                var markFlag = this.m_nRenderTick;
                this._MarkUsingBitmapData(rootSprite, markFlag);
                try {
                    for (var _c = __values(this.m_arrBitmapBuffer.keys()), _d = _c.next(); !_d.done; _d = _c.next()) {
                        var key = _d.value;
                        var pBitmapDataBuffer = this.m_arrBitmapBuffer.get(key);
                        if (pBitmapDataBuffer.m_markFlag != markFlag) {
                            this.m_arrBitmapBuffer.delete(key);
                        }
                        else
                            pBitmapDataBuffer.m_lLastUsingTextureTime = this.m_nRenderTick;
                    }
                }
                catch (e_6_1) { e_6 = { error: e_6_1 }; }
                finally {
                    try {
                        if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
                    }
                    finally { if (e_6) throw e_6.error; }
                }
                try {
                    for (var _e = __values(this.m_arrTextureBuffer.keys()), _f = _e.next(); !_f.done; _f = _e.next()) {
                        var key2 = _f.value;
                        var pBufferData = this.m_arrTextureBuffer.get(key2);
                        if (!pBufferData.m_bLoading && this.m_nRenderTick > pBufferData.m_lLastUsingTextureTime + 1000) {
                            pBufferData.Release();
                            this.m_arrTextureBuffer.delete(key2);
                        }
                    }
                }
                catch (e_7_1) { e_7 = { error: e_7_1 }; }
                finally {
                    try {
                        if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
                    }
                    finally { if (e_7) throw e_7.error; }
                }
            }
        }
        this.m_nLastTick = curTick;
        dInterface.s_renderCount++;
    };
    dInterface.prototype._MarkUsingBitmapData = function (pSprite, markFlag) {
        for (var i = 0, n = pSprite.m_pSetBitmapData.length; i < n; i++) {
            if (pSprite.m_pSetBitmapData[i] && pSprite.m_pSetBitmapData[i].m_pBufferData) {
                pSprite.m_pSetBitmapData[i].m_pBufferData.m_markFlag = markFlag;
            }
        }
        for (var i = 0, n = pSprite.m_vecChildSprite.length; i < n; i++)
            this._MarkUsingBitmapData(pSprite.m_vecChildSprite[i], markFlag);
    };
    dInterface.prototype.OnResize = function (width, height) {
        for (var i = 0; i < this.m_vecShaders.length; i++)
            this.m_vecShaders[i].SetWindowSize(width, height);
        if (this.m_pMainThread)
            this.m_pMainThread.FrameWindowResize(width, height);
    };
    dInterface.prototype.GetWindowWidth = function () {
        if (!this.m_mainCanvas)
            return 0;
        return this.m_mainCanvas.width;
    };
    dInterface.prototype.GetWindowHeight = function () {
        if (!this.m_mainCanvas)
            return 0;
        return this.m_mainCanvas.height;
    };
    dInterface.prototype.CreateCanvas = function () {
        if (dInterface.sdkName == "web" || dInterface.sdkName == "oppo" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg" || dInterface.sdkName == "mi" || dInterface.sdkName == "hw")
            return document.createElement('canvas');
        else
            return this.api.createCanvas();
    };
    dInterface.prototype.ShowInputBox = function (strText, x, y, width, height, spriteColor, fontSize, maxLength, multyLine, onInput, onInputCancel) {
        var _this = this;
        if (this.m_pInputBox != null)
            return;
        this.m_mapSpriteMouseEvent.clear();
        if (dInterface.sdkName == "web" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg" || dInterface.sdkName == "hw") {
            this.m_pInputBox = document.createElement("input");
            this.m_pInputBox.type = strText;
            this.m_pInputBox.style.position = "absolute";
            this.m_pInputBox.style.left = String(x / this.m_pixelRatio);
            this.m_pInputBox.style.top = String(y / this.m_pixelRatio);
            this.m_pInputBox.style.width = String(width / this.m_pixelRatio);
            this.m_pInputBox.style.height = String(height / this.m_pixelRatio);
            var r = (spriteColor & 0x00ff0000) >> 16;
            var g = (spriteColor & 0x0000ff00) >> 8;
            var b = (spriteColor & 0x000000ff);
            var a = (spriteColor & 0xff000000) >>> 24;
            this.m_pInputBox.style.color = "rgb(" + r + "," + g + "," + b + ")";
            this.m_pInputBox.style.background = "rgba(255,255,255,0)";
            this.m_pInputBox.style.fontSize = String(fontSize / this.m_pixelRatio);
            this.m_pInputBox.value = strText;
            this.m_pInputBox.style.visibility = "visible";
            this.m_pInputBox.style.border = "0";
            this.m_pInputBoxOnConfirm = onInput;
            this.m_pInputBoxOnCanel = onInputCancel;
            this.m_pInputBox.onblur = function (e) {
                if (_this.m_pInputBox != null) {
                    var text = _this.m_pInputBox.value;
                    _this.HideInputBox(true);
                }
            };
            this.m_pInputBox.onkeyup = function (e) {
                if (!e)
                    e = window.event;
                var keyCode = e.keyCode || e.which;
                if (!multyLine && keyCode == '13') {
                    if (_this.m_pInputBox != null) {
                        var text = _this.m_pInputBox.value;
                        _this.HideInputBox(true);
                        return false;
                    }
                }
                return true;
            };
            document.body.appendChild(this.m_pInputBox);
            this.m_pInputBox.focus();
        }
        else {
            if (maxLength <= 0)
                maxLength = 10000;
            this.api.showKeyboard({
                defaultValue: strText,
                maxLength: maxLength,
                multiple: multyLine,
                confirmHold: true,
                confirmType: "done"
            });
            var onKeyboardConfirm = function (data) {
                onInput(data.value);
                _this.api.hideKeyboard();
                _this.api.offKeyboardConfirm(onKeyboardConfirm);
            };
            this.api.onKeyboardConfirm(onKeyboardConfirm);
            var onKeyboardComplete = function (data) {
                onInput(data.value);
                _this.api.hideKeyboard();
                _this.api.offKeyboardComplete(onKeyboardComplete);
            };
            this.api.onKeyboardComplete(onKeyboardComplete);
        }
    };
    dInterface.prototype.HideInputBox = function (sendConfirm) {
        if (dInterface.sdkName == "web" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg" || dInterface.sdkName == "hw") {
            if (this.m_pInputBox) {
                if (sendConfirm) {
                    var text = this.m_pInputBox.value;
                    if (this.m_pInputBoxOnConfirm)
                        this.m_pInputBoxOnConfirm(text);
                }
                this.m_pInputBoxOnConfirm = null;
                this.m_pInputBoxOnCanel = null;
                this.m_pInputBox.style.visibility = "hidden";
                var p = this.m_pInputBox;
                setTimeout(function () { document.body.removeChild(p); }, 100);
                this.m_pInputBox = null;
                this.m_arrCurMouseDownList.clear();
            }
        }
    };
    dInterface.prototype.RequestHttp = function (url, pResponse, method, postData) {
        var _this = this;
        if (pResponse === void 0) { pResponse = null; }
        if (method === void 0) { method = "get"; }
        if (postData === void 0) { postData = null; }
        if (dInterface.sdkName == "web" || dInterface.sdkName == "oppo" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg" || dInterface.sdkName == "hw") {
            var xhr = new XMLHttpRequest();
            xhr.open(method.toLowerCase(), url, true);
            xhr.responseType = "arraybuffer";
            xhr.onload = function () {
                if (xhr.status == 200) {
                    if (pResponse) {
                        var p = new dByteArray();
                        p.m_pArraybuffer = xhr.response;
                        p.m_pDataView = new DataView(p.m_pArraybuffer);
                        p.m_bLoadOK = true;
                        p.m_nSize = p.m_nSysSize = p.m_pDataView.byteLength;
                        p.m_nPosition = 0;
                        if (!_this.m_onErrCallback)
                            pResponse(p, xhr.status);
                        else {
                            try {
                                pResponse(p, xhr.status);
                            }
                            catch (err) {
                                if (_this.m_onErrCallback)
                                    _this.m_onErrCallback(err);
                            }
                        }
                    }
                }
                else {
                    if (pResponse) {
                        if (!_this.m_onErrCallback)
                            pResponse(null, xhr.status);
                        else {
                            try {
                                pResponse(null, xhr.status);
                            }
                            catch (err) {
                                if (_this.m_onErrCallback)
                                    _this.m_onErrCallback(err);
                            }
                        }
                    }
                }
            };
            xhr.onerror = function () {
                if (pResponse) {
                    if (!_this.m_onErrCallback)
                        pResponse(null, 0);
                    else {
                        try {
                            pResponse(null, 0);
                        }
                        catch (err) {
                            if (_this.m_onErrCallback)
                                _this.m_onErrCallback(err);
                        }
                    }
                }
            };
            if (postData != null) {
                xhr.send(postData.m_pArraybuffer);
            }
            else
                xhr.send();
        }
        else {
            var requestObj = {
                url: url,
                method: method,
                dataType: 'arraybuffer',
                responseType: 'arraybuffer',
                success: function (ret) {
                    if (pResponse) {
                        var p = new dByteArray();
                        p.m_pArraybuffer = ret.data;
                        p.m_pDataView = new DataView(p.m_pArraybuffer);
                        p.m_bLoadOK = true;
                        p.m_nSize = p.m_nSysSize = p.m_pDataView.byteLength;
                        p.m_nPosition = 0;
                        if (!_this.m_onErrCallback)
                            pResponse(p, ret.statusCode);
                        else {
                            try {
                                pResponse(p, ret.statusCode);
                            }
                            catch (err) {
                                if (_this.m_onErrCallback)
                                    _this.m_onErrCallback(err);
                            }
                        }
                    }
                },
                fail: function (error, code) {
                    if (pResponse) {
                        if (!_this.m_onErrCallback)
                            pResponse(null, code);
                        else {
                            try {
                                pResponse(null, code);
                            }
                            catch (err) {
                                if (_this.m_onErrCallback)
                                    _this.m_onErrCallback(err);
                            }
                        }
                    }
                }
            };
            if (postData)
                requestObj.data = postData.ToStringBuffer();
            this.api.request(requestObj);
        }
        return true;
    };
    dInterface.prototype.LoadSubPackage = function (subName, onComplete) {
        var _this = this;
        if (subName.length == 1)
            return this._LoadSubPackage(subName[0], onComplete);
        else {
            if (dInterface.sdkName == "tt") {
                this._LoadSubPackage(subName[0], function () {
                    subName.erase(0);
                    if (subName.length == 0)
                        onComplete();
                    else
                        _this.LoadSubPackage(subName, onComplete);
                });
            }
            else {
                var callback = new dCompleteCallback(this);
                for (var i = 0; i < subName.length; i++)
                    this._LoadSubPackage(subName[i], callback.CreateCompleteFun_Normal());
                callback.SetCompleteFun(onComplete);
            }
        }
    };
    dInterface.prototype._LoadSubPackage = function (subName, onComplete) {
        var _this = this;
        if (dInterface.sdkName == "web" && this.GetChannelName() != "7k7kh5" || dInterface.sdkName == "hw") {
            onComplete(100);
        }
        else if (dInterface.sdkName == "mg" || dInterface.sdkName == "uc" || dInterface.sdkName == "web" && this.GetChannelName() == "7k7kh5") {
            if (dInterface.sdkName == "mg") {
                if (this.api.loadResouceStart)
                    this.api.loadResouceStart();
            }
            var arr = new dByteArray();
            arr.LoadFromFile(subName + ".bin", function () {
                var filePacker = new dFilePacker();
                filePacker.LoadFromBin(arr);
                if (!_this.m_vecSubPackageData)
                    _this.m_vecSubPackageData = new Array();
                _this.m_vecSubPackageData.push(filePacker);
                onComplete(100);
                if (dInterface.sdkName == "mg") {
                    _this.api.loadResouceComplete();
                    if (window.onEnterGame)
                        window.onEnterGame();
                }
            });
        }
        else {
            var list = this.GetSubFileList(subName);
            var callback = new dCompleteCallback(this);
            for (var i = 0; i < list.length; i++) {
                callback.Add();
                if (dInterface.sdkName == "hw") {
                    this.api.loadSubpackage({
                        subpackage: list[i],
                        success: function (info) {
                            if (!_this.m_onErrCallback)
                                callback.DoComplete();
                            else {
                                try {
                                    callback.DoComplete();
                                }
                                catch (err) {
                                    new dTimer().Create(500, 1, function () {
                                        _this._LoadSubPackage(subName, onComplete);
                                    });
                                }
                            }
                        },
                        fail: function (info) {
                            console.log(info && info.errMsg ? info.errMsg : "LoadSubpackage Failed " + list[i]);
                            new dTimer().Create(500, 1, function () {
                                _this._LoadSubPackage(subName, onComplete);
                            });
                        },
                        complete: function () {
                        }
                    });
                }
                else {
                    this.api.loadSubpackage({
                        name: list[i],
                        success: function (info) {
                            if (!_this.m_onErrCallback)
                                callback.DoComplete();
                            else {
                                try {
                                    callback.DoComplete();
                                }
                                catch (err) {
                                    new dTimer().Create(500, 1, function () {
                                        _this._LoadSubPackage(subName, onComplete);
                                    });
                                }
                            }
                        },
                        fail: function (info) {
                            if (dInterface.sdkName == "ks") {
                                if (info.data == list[i]) {
                                    if (!_this.m_onErrCallback)
                                        callback.DoComplete();
                                    else {
                                        try {
                                            callback.DoComplete();
                                        }
                                        catch (err) {
                                            new dTimer().Create(500, 1, function () {
                                                _this._LoadSubPackage(subName, onComplete);
                                            });
                                        }
                                    }
                                }
                                else
                                    console.log(info);
                            }
                            else {
                                console.log(info && info.errMsg ? info.errMsg : "LoadSubpackage Failed " + list[i]);
                                new dTimer().Create(500, 1, function () {
                                    _this._LoadSubPackage(subName, onComplete);
                                });
                            }
                        },
                        complete: function () {
                        }
                    });
                }
            }
            callback.SetCompleteFun(function () {
                onComplete(100);
            });
        }
    };
    dInterface.prototype.LoadArrayBuffer = function (url, callback) {
        var _this = this;
        if (dInterface.sdkName == "web" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg") {
            if (this.m_vecSubPackageData) {
                var data = this.GetSubPackageData(url);
                if (data) {
                    callback(data.m_pArraybuffer);
                    return;
                }
            }
            if (this.GetChannelName() == "7k7kh5") {
                if (url.indexOf(".bin") == url.length - 4) {
                    var split = dStringUtils.SplitFileName(url);
                    url = 'img/hanzi-bh/'+split[0] + split[1] + split[2] + ".dat";
                }
            }
            var xhr = new XMLHttpRequest();
            xhr.open("get", this.MakeFileUrl(url), true);
            xhr.responseType = "arraybuffer";
            xhr.onload = function () {
                var ret = null;
                if (xhr.status == 200 || xhr.status == 0) {
                    ret = xhr.response;
                }
                else {
                    console.log("failed loading " + url);
                }
                if (!_this.m_onErrCallback)
                    callback(ret);
                else {
                    try {
                        callback(ret);
                    }
                    catch (err) {
                        if (_this.m_onErrCallback)
                            _this.m_onErrCallback(err);
                    }
                }
            };
            xhr.onerror = function () {
                console.log("failed loading " + url);
                if (!_this.m_onErrCallback)
                    callback(null);
                else {
                    try {
                        callback(null);
                    }
                    catch (err) {
                        if (_this.m_onErrCallback)
                            _this.m_onErrCallback(err);
                    }
                }
            };
            xhr.send();
        }
        else {
            this.api.getFileSystemManager().readFile({
                filePath: this.MakeFileUrl(url),
                success: function (res) {
                    if (res.data instanceof ArrayBuffer)
                        callback(res.data);
                    else {
                        var uint8 = res.data;
                        var data2 = uint8.buffer.slice(uint8.byteOffset, uint8.byteOffset + uint8.byteLength);
                        callback(data2);
                    }
                },
                fail: function () {
                    callback(null);
                }
            });
        }
    };
    dInterface.prototype.MakeFileUrl = function (url) {
        if (window.MakeFileUrl)
            return window.MakeFileUrl(url);
        return url;
    };
    dInterface.prototype.GetSubFileList = function (name) {
        if (window.GetSubFileList)
            return window.GetSubFileList(name);
        return [name];
    };
    dInterface.prototype.CreateImage = function () {
        var img = null;
        if (dInterface.sdkName == "web" || dInterface.sdkName == "oppo" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg")
            img = new Image();
        else
            img = this.api.createImage();
        return img;
    };
    dInterface.prototype.LoadImage = function (url, callback) {
        var _this = this;
        var img = this.CreateImage();
        img.onload = function () {
            if (!_this.m_onErrCallback)
                callback(img);
            else {
                try {
                    callback(img);
                }
                catch (err) {
                    if (_this.m_onErrCallback)
                        _this.m_onErrCallback(err);
                }
            }
        };
        img.onerror = function () {
            console.log("failed loading " + url);
            if (!_this.m_onErrCallback)
                callback(null);
            else {
                try {
                    callback(null);
                }
                catch (err) {
                    if (_this.m_onErrCallback)
                        _this.m_onErrCallback(err);
                }
            }
        };
        try {
            img.setAttribute('crossorigin', 'anonymous');
        }
        catch (err) {
        }
        if (this.m_vecSubPackageData) {
            var data = this.GetSubPackageData(url);
            if (!data) {
                img.src = this.MakeFileUrl(url);
            }
            else {
                var ext = dStringUtils.GetFileNameExt(url, false).toLocaleLowerCase();
                var arrayBufferView = new Uint8Array(data.m_pArraybuffer);
                var blob = new Blob([arrayBufferView], { type: "image/" + ext });
                var urlCreator = window.URL || window.webkitURL;
                var imageUrl = urlCreator.createObjectURL(blob);
                img.src = imageUrl;
            }
        }
        else
            img.src = this.MakeFileUrl(url);
    };
    dInterface.prototype.GetSubPackageData = function (fileName) {
        if (!this.m_vecSubPackageData)
            return null;
        for (var i = 0; i < this.m_vecSubPackageData.length; i++) {
            var ret = this.m_vecSubPackageData[i].GetFile(fileName);
            if (ret)
                return ret;
        }
        return null;
    };
    dInterface.prototype.PlayAudio = function (fileName, position, loop, volume, isBackMusic) {
        var _this = this;
        if (dInterface.sdkName == "web" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg") {
            var audioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioContext) {
                console.log('not support web audio api');
                var audio = document.createElement("audio");
                this.m_arrAudios.push(audio);
                audio.stop = function () {
                    audio.pause();
                    audio.currentTime = 0;
                    _this.m_arrAudios.remove(audio);
                };
                audio.onerror = function () {
                    console.log("failed loading " + fileName);
                };
                audio.addEventListener('ended', function () {
                    _this.m_arrAudios.remove(audio);
                });
                if (this.m_vecSubPackageData) {
                    var data = this.GetSubPackageData(fileName);
                    if (!data) {
                        audio.src = this.MakeFileUrl(fileName);
                    }
                    else {
                        var ext = dStringUtils.GetFileNameExt(fileName, false).toLocaleLowerCase();
                        var arrayBufferView = new Uint8Array(data.m_pArraybuffer);
                        var blob = new Blob([arrayBufferView], { type: "audio/" + ext });
                        var urlCreator = window.URL || window.webkitURL;
                        var imageUrl = urlCreator.createObjectURL(blob);
                        audio.src = imageUrl;
                    }
                }
                else
                    audio.src = this.MakeFileUrl(fileName);
                audio.volume = volume * this.m_globalAudioVolume;
                audio.loop = loop;
                audio.autoplay = true;
                console.log("play " + fileName + " " + audio.volume);
                audio.play();
                audio.srcVolume = volume;
                return audio;
            }
            else {
                if (!this.m_audioContext)
                    this.m_audioContext = new audioContext();
                var audio = {};
                audio.isPlaying = false;
                audio.isPausing = false;
                audio.loop = loop;
                audio.fileName = fileName;
                audio.startedAt = Date.now();
                audio.pausedAt = 0;
                audio.srcVolume = volume;
                audio.play = function () {
                    if (audio.isPlaying)
                        return;
                    if (audio.destination) {
                        audio.isPlaying = true;
                        audio.source = _this.m_audioContext.createBufferSource();
                        audio.source.buffer = audio.buffer;
                        audio.source.loop = audio.loop;
                        audio.isPlaying = true;
                        audio.gainNode = _this.m_audioContext.createGain();
                        audio.source.connect(audio.gainNode);
                        audio.gainNode.connect(audio.destination);
                        audio.gainNode.gain.value = volume * _this.m_globalAudioVolume;
                        audio.source.onended = function () {
                            audio.isPlaying = false;
                            if (!audio.isPausing)
                                _this.m_arrAudios.remove(audio);
                            audio.source = null;
                            audio.gainNode = null;
                        };
                        if (audio.isPausing) {
                            audio.startedAt = Date.now() - audio.pausedAt;
                            audio.source.start(0, audio.pausedAt / 1000);
                        }
                        else {
                            audio.startedAt = Date.now();
                            audio.source.start(0);
                        }
                        audio.isPausing = false;
                    }
                };
                audio.pause = function () {
                    audio.isPausing = true;
                    audio.pausedAt = Date.now() - audio.startedAt;
                    audio.stop();
                };
                audio.stop = function () {
                    if (!audio.isPlaying)
                        return;
                    if (audio.source) {
                        audio.isPlaying = false;
                        try {
                            audio.source.stop();
                        }
                        catch (err) { }
                        audio.source = null;
                        audio.gainNode = null;
                    }
                };
                Object.defineProperty(audio, "volume", {
                    get: function () {
                        if (audio.gainNode.gain)
                            return audio.gainNode.gain.value;
                        return 1;
                    },
                    set: function (v) {
                        if (audio.gainNode && audio.gainNode.gain)
                            audio.gainNode.gain.value = v;
                    }
                });
                this.m_arrAudios.push(audio);
                if (this.m_arrAudioDataBuffer == null)
                    this.m_arrAudioDataBuffer = new Map();
                if (this.m_arrAudioDataBuffer.has(fileName)) {
                    var audioBuffer = this.m_arrAudioDataBuffer.get(fileName);
                    if (audioBuffer.isDecodeFinish) {
                        audio.buffer = audioBuffer.buffer;
                        audio.destination = audioBuffer.destination;
                        audio.play();
                    }
                    else {
                        if (!audioBuffer.onComplete)
                            audioBuffer.onComplete = [];
                        audioBuffer.onComplete.push(function () {
                            audio.buffer = audioBuffer.buffer;
                            audio.destination = audioBuffer.destination;
                            audio.play();
                        });
                    }
                }
                else {
                    var audioBuffer = {};
                    this.m_arrAudioDataBuffer.set(fileName, audioBuffer);
                    audioBuffer.onComplete = [];
                    audioBuffer.onComplete.push(function () {
                        audio.buffer = audioBuffer.buffer;
                        audio.destination = audioBuffer.destination;
                        audio.play();
                    });
                    this.LoadArrayBuffer(fileName, function (res) {
                        if (res) {
                            _this.m_audioContext.decodeAudioData(res, function (buffer) {
                                audioBuffer.buffer = buffer;
                                audioBuffer.destination = _this.m_audioContext.destination;
                                audioBuffer.isDecodeFinish = true;
                                if (audioBuffer.onComplete) {
                                    for (var i = 0; i < audioBuffer.onComplete.length; i++)
                                        audioBuffer.onComplete[i]();
                                    audioBuffer.onComplete = null;
                                }
                            });
                        }
                    });
                }
                return audio;
            }
        }
        else {
            var audio = this.api.createInnerAudioContext({ useWebAudioImplement: !isBackMusic });
            audio.autoplay = true;
            audio.loop = loop;
            audio.volume = volume * this.m_globalAudioVolume;
            audio.srcVolume = volume;
            audio.src = this.MakeFileUrl(fileName);
            audio._stop = audio.stop;
            audio.stop = function () {
                audio._stop();
                if (dInterface.sdkName == "mi")
                    audio.destroy();
                if (_this.m_arrAudios.indexOf(audio) != -1)
                    _this.m_arrAudios.remove(audio);
            };
            if (dInterface.sdkName == "wx" || dInterface.sdkName == "qq" || dInterface.sdkName == "tt" || dInterface.sdkName == "bd" || dInterface.sdkName == "mi" || dInterface.sdkName == "ks") {
                this.m_arrAudios.push(audio);
                var onEnd = function () {
                    audio.offEnded(onEnd);
                    _this.m_arrAudios.remove(audio);
                };
                audio.onEnded(onEnd);
            }
            if (dInterface.sdkName == "bd") {
                audio.autoplay = false;
                audio.play();
            }
            return audio;
        }
    };
    dInterface.prototype.OpenWebPage = function (url) {
        if (dInterface.sdkName == "web" || dInterface.sdkName == "oppo" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg") {
            if (window && window.androidJSApis && window.androidJSApis.OpenWebPage) {
                return window.androidJSApis.OpenWebPage(url);
            }
            window.open(url);
        }
    };
    dInterface.prototype.ShowHtmlDialog = function (fileName) {
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis && window.androidJSApis.ShowHtmlDialog)
                window.androidJSApis.ShowHtmlDialog(fileName);
        }
    };
    dInterface.prototype.OpenMiniProgram = function (appId) {
        if (dInterface.sdkName == "wx" || dInterface.sdkName == "qq" || dInterface.sdkName == "tt" || dInterface.sdkName == "ks") {
            this.api.navigateToMiniProgram({
                appId: appId,
                path: "",
                extraData: {
                    foo: ''
                },
                envVersion: 'release',
                success: function (res) {
                    console.log("navigate to " + appId);
                }
            });
        }
        else if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis && window.androidJSApis.OpenApp)
                window.androidJSApis.OpenApp(appId);
            else if (window && window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.OpenApp)
                window.webkit.messageHandlers.OpenApp.postMessage(appId);
        }
    };
    dInterface.prototype.GetSafeAreaTop = function () {
        if (dInterface.sdkName == "web") {
            if (window && window.SafeAreaTop)
                return window.SafeAreaTop;
            if (window && window.androidJSApis) {
                return window.androidJSApis.GetSafeAreaTop();
            }
            return 0;
        }
        else if (dInterface.sdkName == "oppo") {
            return 100 * this.m_pixelRatio;
        }
        else if (dInterface.sdkName == "m7k7k") {
            return 60 * this.m_pixelRatio;
        }
        else if (dInterface.sdkName == "vivo") {
            var res = this.api.getSystemInfoSync();
            var statusBarHeight = res.safeArea.top;
            var data_1 = this.api.getMenuButtonBoundingClientRect();
            return Math.max((data_1.bottom || 0) * this.m_pixelRatio, statusBarHeight * this.m_pixelRatio);
        }
        else if (dInterface.sdkName == "qq") {
            var res = this.api.getSystemInfoSync();
            var statusBarHeight = res.statusBarHeight;
            var data_2 = this.api.getMenuButtonBoundingClientRect();
            return Math.max((data_2.bottom || 0) * this.m_pixelRatio, statusBarHeight * this.m_pixelRatio);
        }
        else if (dInterface.sdkName == "wx" || dInterface.sdkName == "tt" || dInterface.sdkName == "mi") {
            var res = this.api.getSystemInfoSync();
            var statusBarHeight = dMath.ParseInt(res.safeArea.top);
            var data;
            if (dInterface.sdkName == "mi")
                data = qg.getMenuButtonBoundingClientRect();
            else
                data = this.api.getMenuButtonBoundingClientRect();
            var ret = Math.max(data.bottom ? data.bottom * this.m_pixelRatio : 0, statusBarHeight * this.m_pixelRatio);
            return ret;
        }
        else if (dInterface.sdkName == "bd" || dInterface.sdkName == "hw") {
            var res = this.api.getSystemInfoSync();
            var statusBarHeight = res.statusBarHeight;
            return Math.max(res.navigationBarHeight * this.m_pixelRatio, statusBarHeight * this.m_pixelRatio);
        }
        else if (dInterface.sdkName == "uc") {
            var systemInfo = this.api.getSystemInfoSync();
            if (typeof systemInfo === 'string') {
                try {
                    systemInfo = JSON.parse(systemInfo);
                    return Math.max(dMath.ParseInt(systemInfo.safeArea.top), dMath.ParseInt(systemInfo.statusBarHeight));
                }
                catch (e) { }
            }
        }
        else if (dInterface.sdkName == "mg") {
            return 60 * this.m_pixelRatio;
        }
        else if (dInterface.sdkName == "ks") {
            var res = this.api.getSystemInfoSync();
            var statusBarHeight = res.statusBarHeight + 32;
            return statusBarHeight * this.m_pixelRatio;
        }
        return 0;
    };
    dInterface.prototype.GetSafeAreaBottom = function () {
        if (dInterface.sdkName == "web" || dInterface.sdkName == "oppo" || dInterface.sdkName == "m7k7k") {
            if (window && window.SafeAreaBottom)
                return window.SafeAreaBottom;
            if (window && window.androidJSApis) {
                return window.androidJSApis.GetSafeAreaBottom();
            }
            return 0;
        }
        else if (dInterface.sdkName == "vivo") {
            var res = this.api.getSystemInfoSync();
            return (res.screenHeight - res.safeArea.bottom * this.m_pixelRatio);
        }
        else if (dInterface.sdkName == "qq") {
            return 0;
        }
        else if (dInterface.sdkName == "wx" || dInterface.sdkName == "tt" || dInterface.sdkName == "mi" || dInterface.sdkName == "hw" || dInterface.sdkName == "ks") {
            var res = this.api.getSystemInfoSync();
            return (res.screenHeight - res.safeArea.bottom);
        }
        else if (dInterface.sdkName == "uc") {
            var systemInfo = this.api.getSystemInfoSync();
            if (typeof systemInfo === 'string') {
                try {
                    systemInfo = JSON.parse(systemInfo);
                    return dMath.ParseInt(systemInfo.screenHeight) - dMath.ParseInt(systemInfo.safeArea.bottom);
                }
                catch (e) { }
            }
        }
        return 0;
    };
    dInterface.prototype.GetAppList = function () {
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis) {
                return window.androidJSApis.GetAppList();
            }
        }
        return "";
    };
    dInterface.prototype.GetPackageVersionCode = function () {
        if (dInterface.sdkName == "web") {
            if (window && window.AppVersionCode)
                return window.AppVersionCode;
            if (window && window.androidJSApis)
                return window.androidJSApis.GetPackageVersionCode();
        }
        else if (dInterface.sdkName == "vivo") {
            var res = this.api.getSystemInfoSync();
            if (res && res.miniGame && res.miniGame.version)
                return Number(res.miniGame.version);
        }
        else if (dInterface.sdkName == "oppo") {
            var res = this.api.getSystemInfoSync();
            if (res && res.COREVersion)
                return dMath.ParseFloat(res.COREVersion);
        }
        return 0;
    };
    dInterface.prototype.GetPackageAppId = function () {
        if (window && window.PackageAppId)
            return window.PackageAppId;
        return "";
    };
    dInterface.prototype.GetPackageName = function () {
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis)
                return window.androidJSApis.GetPackageName();
        }
        else if (dInterface.sdkName == "vivo") {
            var res = this.api.getSystemInfoSync();
            if (res && res.miniGame && res.miniGame.package)
                return String(res.miniGame.package);
        }
        return "";
    };
    dInterface.prototype.GetPackageSha1 = function () {
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis && window.androidJSApis.GetPackageSha1)
                return window.androidJSApis.GetPackageSha1();
        }
        return "";
    };
    dInterface.prototype.GetLocalLanguage = function () {
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis && window.androidJSApis.GetLocalLanguage)
                return window.androidJSApis.GetLocalLanguage();
        }
        return dStringUtils.dLANG_CHINESE_SIMPLIFIED;
    };
    dInterface.prototype.ReadStorage = function (key, onComplete, defaultRet) {
        if (dInterface.sdkName == "web" || dInterface.sdkName == "oppo" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg" || dInterface.sdkName == "hw") {
            var data = localStorage.getItem(key);
            if (!data)
                onComplete(defaultRet);
            else
                onComplete(data);
        }
        else if (dInterface.sdkName == "vivo" || dInterface.sdkName == "mi" || dInterface.sdkName == "hw" || dInterface.sdkName == "ks") {
            this.api.getStorage({
                key: key,
                success: function (res) {
                    onComplete(res);
                },
                fail: function () {
                    onComplete(defaultRet);
                }
            });
        }
        else {
            this.api.getStorage({
                key: key,
                success: function (res) {
                    onComplete(res.data);
                },
                fail: function () {
                    onComplete(defaultRet);
                }
            });
        }
    };
    dInterface.prototype.WriteStorage = function (key, value) {
        if (dInterface.sdkName == "web" || dInterface.sdkName == "oppo" || dInterface.sdkName == "uc" || dInterface.sdkName == "mg" || dInterface.sdkName == "hw") {
            localStorage.setItem(key, value);
        }
        else if (dInterface.sdkName == "vivo") {
            this.api.setStorage({ key: key, value: value });
        }
        else {
            this.api.setStorage({ key: key, data: value });
        }
    };
    dInterface.prototype.ShowAdRewardedVideo = function (onComplete) {
        var _this = this;
        var showTime = dTimer.GetTickCount();
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis) {
                if (window.androidJSApis.isRewardedVideoReady()) {
                    this.PauseAllSound();
                    this.m_bRewardedVideoShowing = true;
                    window.rewardedVideoVerifyed = function (bVerify) {
                        try {
                            _this.m_bRewardedVideoShowing = false;
                            _this.ResumeAllSound();
                            window.rewardedVideoVerifyed = null;
                            if (bVerify) {
                                onComplete(_this);
                            }
                        }
                        catch (err) {
                            if (_this.m_onErrCallback)
                                _this.m_onErrCallback(err);
                        }
                    };
                    window.androidJSApis.ShowAdRewardedVideo();
                }
                else
                    window.androidJSApis.showToast("");
            }
            else if (this.GetChannelName() == "ios" && window && window.webkit && window.webkit.messageHandlers) {
                window.isRewardedVideoReadyResult = function (isReady) {
                    if (isReady) {
                        _this.PauseAllSound();
                        _this.m_bRewardedVideoShowing = true;
                        window.rewardedVideoVerifyed = function (bVerify) {
                            try {
                                _this.m_bRewardedVideoShowing = false;
                                _this.ResumeAllSound();
                                window.rewardedVideoVerifyed = null;
                                if (bVerify) {
                                    onComplete(_this);
                                }
                            }
                            catch (err) {
                                if (_this.m_onErrCallback)
                                    _this.m_onErrCallback(err);
                            }
                        };
                        window.webkit.messageHandlers.ShowAdRewardedVideo.postMessage("");
                    }
                    else
                        _this.ShowToast("");
                };
                window.webkit.messageHandlers.isRewardedVideoReady.postMessage("");
            }
            else if (this.GetChannelName() == "7k7kh5" && window && window.h5api && window.h5api.canPlayAd) {
                window.h5api.canPlayAd(function (data) {
                    {
                        window.h5api.playAd(function (obj) {
                            console.log(":" + obj.code + ",:" + obj.message);
                            if (obj.code === 10000) {
                                console.log("");
                            }
                            else if (obj.code === 10001) {
                                console.log("");
                                _this.ClearMouseHook();
                                if (dTimer.GetTickCount() > showTime + 500)
                                    onComplete(_this);
                            }
                            else {
                                _this.ClearMouseHook();
                                console.log("");
                            }
                        });
                    }
                });
            }
            else {
                this.PauseAllSound();
                new dTimer().Create(100, 1, function () {
                    _this.ResumeAllSound();
                    onComplete(_this);
                });
            }
        }
        else if ((dInterface.sdkName == "vivo" || dInterface.sdkName == "oppo" || dInterface.sdkName == "m7k7k") && window.adid_rewarded) {
            var rewardedAd_1 = this.api.createRewardedVideoAd({ posId: window.adid_rewarded });
            this.m_bRewardedVideoShowing = true;
            rewardedAd_1.onError(function (err) {
                console.log("", err);
                _this.m_bRewardedVideoShowing = false;
                _this.api.showToast({
                    title: '',
                    message: '',
                    duration: 1500
                });
                rewardedAd_1.destroy();
            });
            rewardedAd_1.onLoad(function (res) {
                console.log('-onload', JSON.stringify(res));
                rewardedAd_1.show().then(function () {
                    console.log('');
                }).catch(function (err) {
                    console.log('', JSON.stringify(err));
                });
            });
            rewardedAd_1.onClose(function (res) {
                _this.m_bRewardedVideoShowing = false;
                console.log('');
                rewardedAd_1.destroy();
                if (res && res.isEnded) {
                    console.log("");
                    onComplete(_this);
                }
                else {
                    console.log("");
                }
            });
            if (dInterface.sdkName == "oppo")
                rewardedAd_1.load();
        }
        else if ((dInterface.sdkName == "wx" || dInterface.sdkName == "qq" || dInterface.sdkName == "tt" || dInterface.sdkName == "uc" || dInterface.sdkName == "mi" || dInterface.sdkName == "ks") && window.adid_rewarded) {
            this.m_rewardedCompleteCallback = onComplete;
            this.m_bRewardedVideoShowing = true;
            if (!this.m_rewardedAd) {
                if (dInterface.sdkName == "uc")
                    this.m_rewardedAd = this.api.createRewardVideoAd();
                else
                    this.m_rewardedAd = this.api.createRewardedVideoAd({ adUnitId: window.adid_rewarded });
                this.m_rewardedAd.onClose(function (res) {
                    _this.ResumeAllSound();
                    _this.m_bRewardedVideoShowing = false;
                    if (res && res.isEnded || res === undefined) {
                        console.log("");
                        if (_this.m_rewardedCompleteCallback)
                            _this.m_rewardedCompleteCallback(_this);
                    }
                    else {
                        console.log("");
                    }
                    _this.m_rewardedCompleteCallback = null;
                });
                this.m_rewardedAd.onError(function (err) {
                    if (_this.m_bRewardedVideoShowing) {
                        _this.ResumeAllSound();
                        _this.m_bRewardedVideoShowing = false;
                        console.log('onError ' + err.errCode + " " + err.errMsg);
                        _this.m_rewardedCompleteCallback = null;
                        _this.api.showToast({
                            title: '',
                            message: '',
                            duration: 1500
                        });
                    }
                });
            }
            this.m_rewardedAd.load().then(function () {
                _this.PauseAllSound();
                console.log(' ');
                _this.m_rewardedAd.show();
            });
        }
        else if (dInterface.sdkName == "bd" && window.adid_rewarded) {
            this.m_rewardedCompleteCallback = onComplete;
            if (!this.m_rewardedAd) {
                this.m_rewardedAd = this.api.createRewardedVideoAd({ adUnitId: window.adid_rewarded,
                    appSid: window.appSid });
                this.m_rewardedAd.onClose(function (res) {
                    _this.ResumeAllSound();
                    _this.m_bRewardedVideoShowing = false;
                    if (res && res.isEnded || res === undefined) {
                        console.log("");
                        if (_this.m_rewardedCompleteCallback)
                            _this.m_rewardedCompleteCallback(_this);
                    }
                    else {
                        console.log("");
                    }
                    _this.m_rewardedCompleteCallback = null;
                });
                this.m_rewardedAd.onError(function (err) {
                    _this.ResumeAllSound();
                    _this.m_bRewardedVideoShowing = false;
                    console.log('onError ' + err.errCode + " " + err.errMsg);
                    _this.m_rewardedCompleteCallback = null;
                    _this.api.showToast({
                        title: '',
                        message: '',
                        duration: 1500
                    });
                });
            }
            this.m_rewardedAd.load().then(function () {
                _this.PauseAllSound();
                console.log(' ');
                _this.m_rewardedAd.show();
            });
        }
        else if (dInterface.sdkName == "mg") {
            if (window.adid_rewarded) {
                console.log("onADShow " + window.adid_rewarded + " " + this.api.mgAd);
                this.api.mgAd.getReward(window.adid_rewarded, {
                    onADExposure: function (data) {
                        console.log('onADExposure ', data);
                    },
                    onADClick: function (data) {
                        console.log('onADClick ', data);
                    },
                    onADClose: function (data) {
                        console.log('onADClose ', data);
                        _this.m_bRewardedVideoShowing = false;
                        if (_this.m_bRewardedVideoVerifyed)
                            onComplete(_this);
                        _this.m_bRewardedVideoVerifyed = false;
                        _this.ResumeAllSound();
                    },
                    onError: function (data) {
                        console.log('onError ', data);
                    },
                    onADStart: function (data) {
                        console.log('onADStart ', data);
                        _this.m_bRewardedVideoShowing = true;
                        _this.m_bRewardedVideoVerifyed = false;
                        _this.PauseAllSound();
                    },
                    onADComplete: function (data) {
                        console.log('onADComplete ', data);
                        _this.m_bRewardedVideoVerifyed = true;
                    },
                    onADUpdateTime: function (data) {
                        console.log('onADUpdateTime ', data);
                    }
                }, {
                    rewardTxt: "",
                    completeTxt: ""
                }).then(function (hasAD) {
                    console.log("hasAD:", hasAD);
                });
            }
        }
        else if (dInterface.sdkName == "hw" && window.adid_rewarded) {
            this.m_rewardedCompleteCallback = onComplete;
            this.m_bRewardedVideoShowing = true;
            if (!this.m_rewardedAd) {
                this.m_rewardedAd = this.api.createRewardedVideoAd({
                    adUnitId: window.adid_rewarded,
                    success: function (code) {
                        console.log("ad demo : loadAndShowVideoAd createRewardedVideoAd: success");
                    },
                    fail: function (data, code) {
                        console.log("ad demo : loadAndShowVideoAd createRewardedVideoAd fail: " + data + "," + code);
                    },
                    complete: function () {
                        console.log("ad demo : loadAndShowVideoAd createRewardedVideoAd complete");
                    }
                });
                this.m_rewardedAd.onClose(function (res) {
                    _this.ResumeAllSound();
                    _this.m_bRewardedVideoShowing = false;
                    if (res && res.isEnded || res === undefined) {
                        console.log("");
                        if (_this.m_rewardedCompleteCallback)
                            _this.m_rewardedCompleteCallback(_this);
                    }
                    else {
                        console.log("");
                    }
                    _this.m_rewardedCompleteCallback = null;
                });
                this.m_rewardedAd.onError(function (err) {
                    if (_this.m_bRewardedVideoShowing) {
                        _this.ResumeAllSound();
                        _this.m_bRewardedVideoShowing = false;
                        console.log('onError ' + err.errCode + " " + err.errMsg);
                        _this.m_rewardedCompleteCallback = null;
                        _this.api.showToast({
                            title: '',
                            message: '',
                            duration: 1500
                        });
                    }
                });
                this.m_rewardedAd.onLoad(function (res) {
                    console.log('-onload', JSON.stringify(res));
                    _this.m_rewardedAd.show();
                });
            }
            this.m_rewardedAd.load();
        }
        else {
            this.api.showToast({
                title: '',
                message: '',
                duration: 1500
            });
        }
    };
    dInterface.prototype.ClearMouseHook = function () {
        var e_8, _a;
        try {
            for (var _b = __values(this.m_mapSpriteMouseEvent.keys()), _c = _b.next(); !_c.done; _c = _b.next()) {
                var key = _c.value;
                if (this.m_mapSpriteMouseEvent.get(key).pSprite) {
                    this.m_mapSpriteMouseEvent.get(key).pSprite.OnTouchUp(0, 0);
                }
            }
        }
        catch (e_8_1) { e_8 = { error: e_8_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_8) throw e_8.error; }
        }
        this.m_mapSpriteMouseEvent.clear();
        this.m_arrCurMouseDownList.clear();
    };
    dInterface.prototype.ShowToast = function (text) {
        var bmp = new dBitmapData();
        bmp.FillText(text, 48, 0xffffffff);
        var p = new dSprite();
        p.SetBitmapData(bmp);
        p.SetSize(bmp.GetWidth(), bmp.GetHeight());
        var back = new dSprite();
        back.spriteColor = 0xff000000;
        back.SetSize(p.width + 20, p.height + 20);
        p.SetPos(10, 10);
        back.AddChild(p);
        back.SetBitmapData(dBitmapData.WHITE_BITMAPDATA);
        back.SetPos((dThread.GetWindowWidth() - back.width) / 2, dThread.GetWindowHeight() - 200);
        dThread.GetRootSprite().AddChild(back);
        new dTimer().Create(2000, 1, function () {
            back.RemoveParent();
        });
    };
    dInterface.prototype.isAdRewardedShowing = function () {
        return this.m_bRewardedVideoShowing;
    };
    dInterface.prototype.isAdRewardedReady = function () {
        if (window && window.androidJSApis) {
            if (window.androidJSApis.isRewardedVideoReady())
                return true;
        }
        return true;
    };
    dInterface.prototype.isAdInterstitialVideoReady = function () {
        if (window && window.androidJSApis) {
            if (window.androidJSApis.isInterstitialVideoReady())
                return true;
        }
        return true;
    };
    dInterface.prototype.ShowAdInterstitialImage = function (onComplete) {
        var _this = this;
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis) {
                if (window.androidJSApis.isInterstitialImageReady()) {
                    window.interstitialImageClosed = function () {
                        window.interstitialImageClosed = null;
                        if (onComplete)
                            onComplete(_this);
                    };
                    window.androidJSApis.ShowAdInterstitialImage();
                }
            }
        }
        else if (dInterface.sdkName == "vivo") {
            if (window.adid_interstitial) {
                var interstitialAd = this.api.createInterstitialAd({ posId: window.adid_interstitial });
                interstitialAd.onError(function (err) {
                    console.log("", err);
                });
                interstitialAd.show().then(function () {
                    console.log('');
                }).catch(function (err) {
                    console.log('', JSON.stringify(err));
                });
                interstitialAd.onClose(function () {
                    interstitialAd.destroy();
                    if (onComplete)
                        onComplete(_this);
                });
            }
        }
    };
    dInterface.prototype.ShowAdInterstitialVideo = function (onComplete) {
        var _this = this;
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis) {
                if (window.androidJSApis.isInterstitialVideoReady()) {
                    this.PauseAllSound();
                    this.m_bRewardedVideoShowing = true;
                    window.interstitialVideoClosed = function () {
                        _this.m_bRewardedVideoShowing = false;
                        _this.ResumeAllSound();
                        window.interstitialVideoClosed = null;
                        if (onComplete)
                            onComplete(_this);
                    };
                    window.androidJSApis.ShowAdInterstitialVideo();
                }
            }
        }
    };
    dInterface.prototype.ShowAdBanner = function (bShow, flag) {
        var _this = this;
        this.m_banderAdShowing = bShow;
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis) {
                window.androidJSApis.ShowAdBanner(bShow, flag);
            }
        }
        else if (dInterface.sdkName == "vivo") {
            if (window.adid_banner) {
                if (bShow) {
                    if (!this.m_bannerAd) {
                        var bannerAd = this.m_bannerAd = this.api.createBannerAd({ posId: window.adid_banner });
                        this.m_bannerAd.show().then(function () {
                            console.log('banner');
                            if (_this.m_bannerAd != bannerAd)
                                bannerAd.hide();
                        }).catch(function (err) {
                            console.log('banner', JSON.stringify(err));
                        });
                    }
                }
                else {
                    if (this.m_bannerAd) {
                        this.m_bannerAd.hide();
                        this.m_bannerAd = null;
                    }
                }
            }
        }
        else if (dInterface.sdkName == "m7k7k") {
            if (window.adid_banner) {
                if (bShow) {
                    if (!this.m_bannerAd) {
                        var screenHeight = this.api.getSystemInfoSync().screenHeight * this.m_pixelRatio;
                        var screenWidth = this.api.getSystemInfoSync().screenWidth * this.m_pixelRatio;
                        var bottomOff = 0;
                        var bannerWidth = 0;
                        var bannerHeight = 0;
                        var res = this.api.getSystemInfoSync();
                        bannerWidth = res.screenWidth * this.m_pixelRatio;
                        bannerHeight = 80 * this.m_pixelRatio;
                        bottomOff = 0;
                        var bannerAd = this.m_bannerAd = this.api.createBannerAd({
                            style: {
                                left: (screenWidth - bannerWidth) / 2,
                                top: (screenHeight - bannerHeight - bottomOff),
                                width: bannerWidth,
                                height: bannerHeight
                            }
                        });
                        this.m_bannerAd.show().then(function () {
                            console.log('banner');
                            if (_this.m_bannerAd != bannerAd)
                                bannerAd.hide();
                        }).catch(function (err) {
                            console.log('banner', JSON.stringify(err));
                        });
                    }
                }
                else {
                    if (this.m_bannerAd) {
                        this.m_bannerAd.hide();
                        this.m_bannerAd = null;
                    }
                }
            }
        }
        else if (dInterface.sdkName == "wx" || dInterface.sdkName == "qq") {
            if (window.adid_banner) {
                if (!this.m_bannerAd) {
                    var screenHeight = this.api.getSystemInfoSync().screenHeight;
                    var screenWidth = this.api.getSystemInfoSync().screenWidth;
                    var bottomOff = 0;
                    var bannerWidth = 0;
                    var bannerHeight = 0;
                    var res = this.api.getSystemInfoSync();
                    bannerWidth = res.screenWidth;
                    bannerHeight = 80;
                    bottomOff = 0;
                    if (dInterface.sdkName == "wx")
                        bottomOff = res.screenHeight - res.safeArea.bottom;
                    this.m_bannerAd = this.api.createBannerAd({
                        adUnitId: window.adid_banner,
                        style: {
                            left: (screenWidth - bannerWidth) / 2,
                            top: screenHeight - bannerHeight - bottomOff,
                            width: bannerWidth,
                        }
                    });
                    this.m_bannerAd.onResize(function (res) {
                        if (_this.m_bannerAd.style.realHeight)
                            _this.m_bannerAd.style.top = screenHeight - _this.m_bannerAd.style.realHeight - bottomOff;
                    });
                    this.m_bannerAd.onLoad(function () {
                        if (_this.m_banderAdShowing)
                            _this.m_bannerAd.show();
                        else
                            _this.m_bannerAd.hide();
                    });
                    this.m_bannerAd.onError(function (err) {
                        console.log(err);
                    });
                }
                if (bShow) {
                    this.m_bannerAd.show();
                }
                else {
                    this.m_bannerAd.hide();
                }
            }
        }
        else if (dInterface.sdkName == "tt") {
            if (window.adid_banner) {
                if (!this.m_bannerAd) {
                    var _a = this.api.getSystemInfoSync(), windowWidth_1 = _a.windowWidth, windowHeight_1 = _a.windowHeight;
                    var targetBannerAdWidth = 200;
                    var bannerAd_1 = this.api.createBannerAd({
                        adUnitId: window.adid_banner,
                        style: {
                            width: targetBannerAdWidth,
                            top: windowHeight_1 - (targetBannerAdWidth / 16) * 9,
                        },
                    });
                    bannerAd_1.style.left = (windowWidth_1 - targetBannerAdWidth) / 2;
                    bannerAd_1.onResize(function (size) {
                        console.log(size.width, size.height);
                        bannerAd_1.style.top = windowHeight_1 - size.height;
                        bannerAd_1.style.left = (windowWidth_1 - size.width) / 2;
                    });
                    this.m_bannerAd = bannerAd_1;
                    this.m_bannerAd.onLoad(function () {
                        if (_this.m_banderAdShowing)
                            _this.m_bannerAd.show();
                        else
                            _this.m_bannerAd.hide();
                    });
                }
                if (this.m_bannerAd) {
                    if (bShow)
                        this.m_bannerAd.show();
                    else
                        this.m_bannerAd.hide();
                }
            }
        }
        else if (dInterface.sdkName == "uc" && window.adid_banner) {
            if (!this.m_bannerAd) {
                var screenWidth = 0;
                var screenHeight = 0;
                var systemInfo = this.api.getSystemInfoSync();
                if (typeof systemInfo === 'string') {
                    try {
                        systemInfo = JSON.parse(systemInfo);
                        screenWidth = dMath.ParseInt(systemInfo.screenWidth);
                        screenHeight = dMath.ParseInt(systemInfo.screenHeight);
                    }
                    catch (e) { }
                }
                var opts = {};
                opts.style = {};
                opts.style.width = screenWidth;
                opts.style.height = screenWidth * 150 / 600;
                opts.style.gravity = 7;
                this.m_bannerAd = this.api.createBannerAd(opts);
                this.m_bannerAd.onLoad(function () {
                    console.log('Banner');
                });
                this.m_bannerAd.onError(function (err) {
                    console.log('Banner err ' + err);
                });
            }
            if (bShow)
                this.m_bannerAd.show();
            else
                this.m_bannerAd.hide();
            return;
        }
    };
    dInterface.prototype.ShowAdBox = function (onShow) {
        var _this = this;
        console.log("ShowAdBox");
        if (dInterface.sdkName == "web") {
            if (dInterface.ptr.GetChannelName() == "7k7kh5" && window && window.h5api) {
                window.h5api.showRecommend();
                this.ClearMouseHook();
            }
            else if (window && window.androidJSApis && window.androidJSApis.ShowAdBox) {
                window.androidJSApis.ShowAdBox();
            }
        }
        else if (dInterface.sdkName == "vivo") {
            if (this.api.createBoxPortalAd && window.adid_box) {
                this.m_boxPortalAd = this.api.createBoxPortalAd({ posId: window.adid_box });
                this.m_boxPortalAd.onError(function (err) { console.log("", err); });
                this.m_boxPortalAd.onClose(function () {
                    console.log('boxPortalAd close');
                    if (_this.m_boxPortalAd.isDestroyed) {
                        return;
                    }
                    _this.HideAdMoreGameIcon();
                });
                this.m_boxPortalAd.show().then(function () { console.log('show success'); });
                this.m_boxPortalAd.onShow(function () {
                    if (onShow)
                        onShow();
                });
            }
            else if (this.api.createBoxBannerAd && window.adid_boxbanner) {
                this.m_bannerAd = this.api.createBoxBannerAd({ posId: window.adid_boxbanner });
                this.m_bannerAd.onError(function (err) { console.log("", err); });
                this.m_bannerAd.show().then(function () {
                    console.log('show success');
                    if (onShow)
                        onShow();
                });
            }
            else {
                console.log(' API');
            }
        }
        else if (dInterface.sdkName == "oppo" && window.adid_box) {
            if (this.api.getSystemInfoSync().platformVersionCode >= 1076) {
                var gamePortalAd = this.api.createGamePortalAd({
                    adUnitId: window.adid_box
                });
                gamePortalAd.load().then(function () {
                    console.log('load success');
                    gamePortalAd.show();
                    if (onShow)
                        onShow();
                }).catch(function (error) {
                    console.log('load fail with:' + error.errCode + ',' + error.errMsg);
                    _this.api.showToast({
                        title: '',
                        message: '',
                        duration: 1500
                    });
                });
            }
            else {
                console.log('1076 API');
            }
        }
        else if (dInterface.sdkName == "qq" && window.adid_box) {
            if (!this.m_boxPortalAd) {
                this.m_boxPortalAd = this.api.createAppBox({ adUnitId: window.adid_box });
            }
            this.m_boxPortalAd.load().then(function () {
                _this.m_boxPortalAd.show();
                if (onShow)
                    onShow();
            });
        }
        else if (dInterface.sdkName == "wx" && window.adid_box) {
            var customAd = this.api.createCustomAd({
                adUnitId: window.adid_box,
                adIntervals: 30,
                style: {
                    left: 0,
                    top: 100,
                    fixed: 0
                }
            });
            customAd.onLoad(function () {
                console.log(' ');
                customAd.show().then(function () {
                    if (onShow)
                        onShow();
                });
            });
        }
        else if (dInterface.sdkName == "tt") {
            try {
                var nineGridGamePanel = this.api.createGridGamePanel({
                    gridCount: "nine"
                });
                nineGridGamePanel.show();
                if (onShow)
                    onShow();
            }
            catch (error) {
                console.error("", error);
            }
        }
        else if (dInterface.sdkName == "mi" && window.adid_box) {
            qg.displayAd({
                type: 100,
                upid: window.adid_box,
                success: function (res) {
                    if (onShow)
                        onShow();
                },
                fail: function (res) {
                    console.log(res);
                    _this.api.showToast({
                        title: '',
                        message: '',
                        duration: 1500
                    });
                }
            });
        }
    };
    dInterface.prototype.hasMoreGame = function () {
        if (this.GetMoreGameList() != null)
            return true;
        if (dInterface.sdkName == "web") {
            if (this.GetChannelName() == "windows" || this.GetChannelName() == "oppo")
                return true;
        }
        else if (dInterface.sdkName == "oppo" && window.adid_box) {
            if (this.api.getSystemInfoSync().platformVersionCode >= 1076)
                return true;
        }
        else if (dInterface.sdkName == "vivo" && window.adid_box) {
            return true;
        }
        else if ((dInterface.sdkName == "wx" || dInterface.sdkName == "qq" || dInterface.sdkName == "tt" || dInterface.sdkName == "mi") && window.adid_box) {
            return true;
        }
        else if (dInterface.sdkName == "tt") {
            if (this.api.createGridGamePanel)
                return true;
        }
        return false;
    };
    dInterface.prototype.GetMoreGameList = function () {
        if (window && window.moreGameList)
            return window.moreGameList;
        return null;
    };
    dInterface.prototype.ShowAdMoreGameIcon = function (icon, y, flag, onShowAd) {
        if (dInterface.sdkName == "vivo") {
            if (this.api.createBoxPortalAd && window.adid_box) {
                this.m_boxPortalAd = this.api.createBoxPortalAd({ posId: window.adid_box, image: icon, marginTop: y });
                this.m_boxPortalAd.onError(function (err) { console.log("", err); });
                this.m_boxPortalAd.onClose(function () {
                    console.log('boxPortalAd close');
                    if (this.m_boxPortalAd.isDestroyed) {
                        return;
                    }
                    this.m_boxPortalAd.show();
                });
                this.m_boxPortalAd.show().then(function () { console.log('show success'); });
                this.m_boxPortalAd.onShow(function () {
                    if (onShowAd)
                        onShowAd();
                });
            }
            else {
                console.log(' API');
            }
        }
    };
    dInterface.prototype.HideAdMoreGameIcon = function () {
        if (dInterface.sdkName == "vivo") {
            if (this.api.createBoxPortalAd && window.adid_box) {
                if (this.m_boxPortalAd != null) {
                    this.m_boxPortalAd.isDestroyed = true;
                    this.m_boxPortalAd.destroy();
                    this.m_boxPortalAd = null;
                }
            }
        }
    };
    dInterface.prototype.StartShareRecord = function () {
        var _this = this;
        if (dInterface.sdkName == "tt") {
            this.m_startRecordTime = dTimer.GetTickCount();
            try {
                var recorder = this.api.getGameRecorderManager();
                recorder.onStart(function (res) {
                    console.log("");
                    _this.m_bRecording = true;
                });
                recorder.onStop(function (res) {
                    _this.m_bRecording = false;
                    console.log(res.videoPath);
                    _this.m_recordVideoPath = res.videoPath;
                    console.log("");
                });
                recorder.onError(function (res) {
                    console.log(res);
                });
                recorder.start({
                    duration: 120
                });
                return true;
            }
            catch (err) {
            }
        }
        else if (dInterface.sdkName == "ks") {
            this.m_startRecordTime = dTimer.GetTickCount();
            var recorder = this.api.getGameRecorder();
            recorder.on('start', function () {
                _this.m_bRecording = true;
            });
            recorder.on('stop', function (res) {
                _this.m_bRecording = false;
            });
            recorder.start();
            return true;
        }
        return false;
    };
    dInterface.prototype.StopShareRecord = function (onComplete) {
        if (onComplete === void 0) { onComplete = null; }
        if (dInterface.sdkName == "tt") {
            this.m_stopRecordTime = dTimer.GetTickCount();
            try {
                this.api.getGameRecorderManager().stop();
                if (onComplete)
                    onComplete();
            }
            catch (err) {
                console.log(err);
            }
        }
        else if (dInterface.sdkName == "ks") {
            this.m_stopRecordTime = dTimer.GetTickCount();
            var recorder = this.api.getGameRecorder();
            recorder.stop();
        }
    };
    dInterface.prototype.ShareRecord = function () {
        var _this = this;
        if (dInterface.sdkName == "tt") {
            console.log("Share " + this.m_recordVideoPath);
            this.api.shareVideo({
                videoPath: this.m_recordVideoPath,
                success: function () {
                    console.log("");
                },
                fail: function (e) {
                    console.log("" + e.errMsg);
                    var msg = e.errMsg;
                    if (msg && msg.indexOf("too short") != -1)
                        msg = "3";
                    else if (msg && msg.indexOf("fail cancel") != -1)
                        msg = "";
                    if (msg && msg.length > 0) {
                        _this.api.showModal({
                            title: '',
                            content: msg
                        });
                    }
                }
            });
        }
        else if (dInterface.sdkName == "ks") {
            if (this.m_stopRecordTime - this.m_startRecordTime < 3000) {
                console.log(this.m_stopRecordTime);
                console.log(this.m_startRecordTime);
                this.ShowToast("");
            }
            else {
                var recorder = this.api.getGameRecorder();
                recorder.publishVideo({
                    callback: function (error) {
                        if (error != null && error != undefined) {
                            console.log(": " + JSON.stringify(error));
                            return;
                        }
                        console.log("");
                    }
                });
            }
        }
    };
    dInterface.prototype.isPrivacyAgree = function () {
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis) {
                if (window.androidJSApis.isPrivacyAgree())
                    return true;
                return false;
            }
            return true;
        }
        else if (dInterface.sdkName == "hw") {
            if (window && window.userLogined)
                return true;
            return false;
        }
        return true;
    };
    dInterface.prototype.ExitApp = function (isForce) {
        if (isForce === void 0) { isForce = false; }
        if (isForce)
            this.m_bHideRender = true;
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis && window.androidJSApis.ExitApp) {
                window.androidJSApis.ExitApp();
            }
        }
        else if (dInterface.sdkName == "oppo" || dInterface.sdkName == "vivo" || dInterface.sdkName == "hw") {
            this.api.exitApplication({});
        }
        else if (dInterface.sdkName == "wx" || dInterface.sdkName == "qq" || dInterface.sdkName == "tt" || dInterface.sdkName == "mi" || dInterface.sdkName == "ks") {
            this.api.exitMiniProgram({});
        }
        else if (dInterface.sdkName == "mg") {
            if (window.exitMiniProgram)
                window.exitMiniProgram();
        }
    };
    dInterface.prototype.isBlockLButtonDown = function () {
        if (dInterface.sdkName == "mg" && this.m_bRewardedVideoShowing)
            return true;
        return false;
    };
    dInterface.prototype.FrameMouseEvent = function (type, id, x, y, delta) {
        if (type == dSprite.MOUSE_LBUTTONDOWN) {
            if (this.m_arrCurMouseDownList.has(id))
                return;
            this.m_arrCurMouseDownList.set(id, 1);
        }
        else if (type == dSprite.MOUSE_LBUTTONUP) {
            this.m_arrCurMouseDownList.remove(id);
        }
        if (!this.m_onErrCallback)
            this._FrameMouseEvent(type, id, x, y, delta);
        else {
            try {
                this._FrameMouseEvent(type, id, x, y, delta);
            }
            catch (err) {
                if (this.m_onErrCallback)
                    this.m_onErrCallback(err);
            }
        }
    };
    dInterface.prototype._FrameMouseEvent = function (type, id, x, y, delta) {
        var e_9, _a;
        var pMainThread = this.m_pMainThread;
        switch (type) {
            case dSprite.MOUSE_MOVE:
            case dSprite.MOUSE_LBUTTONDOWN:
            case dSprite.MOUSE_LBUTTONUP:
            case dSprite.MOUSE_MBUTTONDOWN:
            case dSprite.MOUSE_MBUTTONUP:
            case dSprite.MOUSE_RBUTTONDOWN:
            case dSprite.MOUSE_RBUTTONUP:
            case dSprite.MOUSE_WHEEL:
                this.m_nGlobalMouseX = x;
                this.m_nGlobalMouseY = y;
                if (this.m_pMainThread != null && dThread.GetRootSprite() != null) {
                    var pRootSprite = dThread.GetRootSprite();
                    this.m_pMainThread.OnFrameTouchEvent(type, id, x - pRootSprite.positionX, y - pRootSprite.positionY, delta);
                    if ((type == dSprite.MOUSE_LBUTTONDOWN || type == dSprite.MOUSE_MBUTTONDOWN || type == dSprite.MOUSE_RBUTTONDOWN) && !this.isBlockLButtonDown()) {
                        if (!dSprite.s_pCurrentInputingBox) {
                            var pCol = pRootSprite.CollectionChild(x, y, true);
                            if (pCol != null) {
                                var eve = null;
                                try {
                                    for (var _b = __values(this.m_mapSpriteMouseEvent.keys()), _c = _b.next(); !_c.done; _c = _b.next()) {
                                        var key = _c.value;
                                        if (this.m_mapSpriteMouseEvent.get(key).pSprite == pCol) {
                                            eve = this.m_mapSpriteMouseEvent.get(key);
                                            break;
                                        }
                                    }
                                }
                                catch (e_9_1) { e_9 = { error: e_9_1 }; }
                                finally {
                                    try {
                                        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                                    }
                                    finally { if (e_9) throw e_9.error; }
                                }
                                var mat = pCol.GetMatrixWorld();
                                var x2 = x - mat._41;
                                var y2 = y - mat._42;
                                var scaleWorld = new dVector2(1, 1);
                                this._GetScale_World(pCol, scaleWorld);
                                x2 /= dMath.Abs(scaleWorld.x);
                                y2 /= dMath.Abs(scaleWorld.y);
                                if (eve == null) {
                                    this.m_mapSpriteMouseEvent.set(id, new SpriteMouseEvent(pCol, x2, y2, type, false));
                                    if (type == dSprite.MOUSE_LBUTTONDOWN)
                                        pCol.OnTouchDown(x2, y2, delta);
                                    else if (type == dSprite.MOUSE_MBUTTONDOWN)
                                        pCol.OnMButtonTouchDown(x2, y2, delta);
                                    else if (type == dSprite.MOUSE_RBUTTONDOWN)
                                        pCol.OnRButtonTouchDown(x2, y2, delta);
                                }
                                else {
                                    this.m_mapSpriteMouseEvent.set(id, new SpriteMouseEvent(pCol, x2, y2, type, true));
                                    if (type == dSprite.MOUSE_LBUTTONDOWN)
                                        pCol.OnMultyTouchDown(id, x2, y2, delta);
                                }
                            }
                        }
                    }
                    else if (type == dSprite.MOUSE_MOVE) {
                        var pCol2 = this.m_mapSpriteMouseEvent.get(id);
                        if (pCol2) {
                            var mat = pCol2.pSprite.GetMatrixWorld();
                            var x2 = x - mat._41;
                            var y2 = y - mat._42;
                            var scaleWorld = new dVector2(1, 1);
                            this._GetScale_World(pCol2.pSprite, scaleWorld);
                            x2 /= dMath.Abs(scaleWorld.x);
                            y2 /= dMath.Abs(scaleWorld.y);
                            if (pCol2.pSprite.isHandleMouse() && (x2 != pCol2.x || y2 != pCol2.y)) {
                                var offx = x2 - pCol2.x;
                                var offy = y2 - pCol2.y;
                                if (pCol2.type == dSprite.MOUSE_LBUTTONDOWN) {
                                    if (pCol2.bMulty)
                                        pCol2.pSprite.OnMultyTouchMove(id, x2, y2, offx, offy, delta);
                                    else
                                        pCol2.pSprite.OnTouchMove(x2, y2, offx, offy, delta);
                                }
                                else if (pCol2.type == dSprite.MOUSE_MBUTTONDOWN)
                                    pCol2.pSprite.OnMButtonTouchMove(x2, y2, offx, offy, delta);
                                else if (pCol2.type == dSprite.MOUSE_RBUTTONDOWN)
                                    pCol2.pSprite.OnRButtonTouchMove(x2, y2, offx, offy, delta);
                            }
                            mat = pCol2.pSprite.GetMatrixWorld();
                            x2 = x - mat._41;
                            y2 = y - mat._42;
                            scaleWorld = new dVector2(1, 1);
                            this._GetScale_World(pCol2.pSprite, scaleWorld);
                            x2 /= dMath.Abs(scaleWorld.x);
                            y2 /= dMath.Abs(scaleWorld.y);
                            pCol2.x = x2;
                            pCol2.y = y2;
                        }
                    }
                    else if (type == dSprite.MOUSE_LBUTTONUP || type == dSprite.MOUSE_MBUTTONUP || type == dSprite.MOUSE_RBUTTONUP) {
                        var pCol2 = this.m_mapSpriteMouseEvent.get(id);
                        if (pCol2) {
                            this.m_mapSpriteMouseEvent.remove(id);
                            if (pCol2.pSprite.isHandleMouse()) {
                                var x2 = x - pCol2.pSprite.GetPosX_World();
                                var y2 = y - pCol2.pSprite.GetPosY_World();
                                var scaleWorld = new dVector2(1, 1);
                                this._GetScale_World(pCol2.pSprite, scaleWorld);
                                x2 /= dMath.Abs(scaleWorld.x);
                                y2 /= dMath.Abs(scaleWorld.y);
                                if (pCol2.type == dSprite.MOUSE_LBUTTONDOWN) {
                                    if (pCol2.bMulty)
                                        pCol2.pSprite.OnMultyTouchUp(id, x2, y2);
                                    else
                                        pCol2.pSprite.OnTouchUp(x2, y2);
                                }
                                else if (pCol2.type == dSprite.MOUSE_MBUTTONDOWN)
                                    pCol2.pSprite.OnMButtonTouchUp(x2, y2);
                                else if (pCol2.type == dSprite.MOUSE_RBUTTONDOWN)
                                    pCol2.pSprite.OnRButtonTouchUp(x2, y2);
                            }
                        }
                    }
                    else if (type == dSprite.MOUSE_WHEEL) {
                        var pCol = pRootSprite.CollectionChild(x, y, true);
                        if (pCol != null) {
                            if (pCol.isHandleMouse()) {
                                var x2 = x - pCol.GetPosX_World();
                                var y2 = y - pCol.GetPosY_World();
                                var scaleWorld = new dVector2(1, 1);
                                this._GetScale_World(pCol, scaleWorld);
                                x2 /= dMath.Abs(scaleWorld.x);
                                y2 /= dMath.Abs(scaleWorld.y);
                                x2 += pCol.anchorU * pCol.width;
                                y2 += pCol.anchorV * pCol.height;
                                pCol.OnMouseWheel(x2, y2, delta);
                            }
                        }
                    }
                }
                break;
            case dSprite.KEY_DOWN:
            case dSprite.KEY_UP:
                break;
            default:
                throw "MainEvent type error";
        }
    };
    dInterface.prototype._GetScale_World = function (p, outData) {
        outData.x *= p.scaleX;
        outData.y *= p.scaleY;
        if (p.GetParent() != null)
            this._GetScale_World(p.GetParent(), outData);
    };
    dInterface.prototype.GetSdkName = function () {
        if (!dInterface.sdkName)
            return "";
        return dInterface.sdkName;
    };
    dInterface.prototype.GetChannelName = function () {
        if (window && window.channelName)
            return window.channelName;
        if (dInterface.sdkName == "web") {
            if (window && window.androidJSApis) {
                return window.androidJSApis.GetChannelName();
            }
            return "windows";
        }
        return "";
    };
    dInterface.prototype.InitUserDeviceId = function (callback) {
        var _this = this;
        this.ReadStorage("__userdeviceid__", function (res) {
            if (res)
                _this.m_userdeviceId = res;
            else {
                var s = [];
                var hexDigits = "0123456789abcdef";
                for (var i = 0; i < 36; i++) {
                    s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
                }
                s[14] = "4";
                s[19] = hexDigits.substr((dMath.ParseInt(s[19]) & 0x3) | 0x8, 1);
                s[8] = s[13] = s[18] = s[23] = "-";
                _this.m_userdeviceId = s.join("").replace("-", "");
                _this.WriteStorage("__userdeviceid__", _this.m_userdeviceId);
            }
            if (callback)
                callback(_this.m_userdeviceId);
        }, null);
    };
    dInterface.prototype.GetUserDeviceId = function () {
        return this.m_userdeviceId;
    };
    dInterface.s_ptr = null;
    dInterface.sdkName = "";
    dInterface.s_onFrameEnd = new Array();
    dInterface.s_renderCount = 0;
    return dInterface;
}());
Array.prototype.remove = function (val) {
    var index = this.indexOf(val);
    if (index > -1) {
        this.splice(index, 1);
    }
};
Array.prototype.erase = function (at) {
    return this.splice(at, 1)[0];
};
Array.prototype.clear = function () {
    this.length = 0;
};
Array.prototype.insert = function (at, p) {
    this.splice(at, 0, p);
};
Array.prototype.copy = function (src) {
    this.clear();
    for (var i = 0; i < src.length; i++)
        this.push(src[i]);
};
Array.prototype.last = function () {
    return this[this.length - 1];
};
Array.prototype.resize = function (count) {
    this.length = count;
    for (var i = 0; i < count; i++)
        if (!this[i])
            this[i] = null;
};
Array.prototype.pushVector = function (arr) {
    for (var i = 0; i < arr.length; i++)
        this.push(arr[i]);
    return this;
};
Array.prototype.randomSort = function () {
    for (var i = 0; i < this.length; i++) {
        this.swap(dMath.RandomI() % this.length, dMath.RandomI() % this.length);
    }
};
Array.prototype.swap = function (at1, at2) {
    if (at1 == at2 || at1 < 0 || at2 < 0 || at1 >= this.length || at2 >= this.length)
        return;
    var tmp = this[at1];
    this[at1] = this[at2];
    this[at2] = tmp;
};
Map.prototype.remove = function (key) {
    this.delete(key);
};
var SpriteMouseEvent = (function () {
    function SpriteMouseEvent(pSprite, x, y, type, bMulty) {
        if (pSprite === void 0) { pSprite = null; }
        if (x === void 0) { x = 0; }
        if (y === void 0) { y = 0; }
        if (type === void 0) { type = 0; }
        if (bMulty === void 0) { bMulty = false; }
        this.pSprite = pSprite;
        this.x = x;
        this.y = y;
        this.type = type;
        this.bMulty = bMulty;
    }
    return SpriteMouseEvent;
}());
var dMath = (function (_super) {
    __extends(dMath, _super);
    function dMath() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    dMath.Random = function () {
        return Math.random();
    };
    dMath.RandomI = function () {
        return dMath.ToInt(dMath.Random() * 32767.0);
    };
    dMath.RandomRange = function (min, max) {
        return dMath.Random() * (max - min) + min;
    };
    dMath.RandomRangeI = function (min, max) {
        min = dMath.ToInt(min);
        max = dMath.ToInt(max);
        if (max <= min)
            return min;
        return (dMath.RandomI() % (max - min)) + min;
    };
    dMath.RandomM = function () {
        return dMath.Random() * 2.0 - 1.0;
    };
    dMath.RandomWeight = function (vecWeight) {
        if (vecWeight.length == 0)
            return -1;
        var total = 0;
        for (var i = 0; i < vecWeight.length; i++)
            total += vecWeight[i];
        var r = dMath.Random() * total;
        for (var i = 0; i < vecWeight.length; i++) {
            if (vecWeight[i] != 0 && r < vecWeight[i])
                return i;
            r -= vecWeight[i];
        }
        return 0;
    };
    dMath.RandomToWeight = function (count, min, max) {
        var ret = new Array(count);
        for (var i = 0; i < count; i++) {
            ret[i] = min;
            max -= min;
        }
        while (max > 2000) {
            ret[dMath.RandomI() % count] += 1000;
            max -= 1000;
        }
        while (max > 200) {
            ret[dMath.RandomI() % count] += 100;
            max -= 100;
        }
        while (max > 20) {
            ret[dMath.RandomI() % count] += 10;
            max -= 10;
        }
        while (max > 0) {
            ret[dMath.RandomI() % count]++;
            max--;
        }
        return ret;
    };
    dMath.FloatEquals = function (a, b, fIgnore) {
        if (fIgnore === void 0) { fIgnore = 0.0001; }
        return dMath.Abs(a - b) < fIgnore;
    };
    dMath.Log = function (x) {
        return Math.log(x);
    };
    dMath.Sin = function (r) {
        return Math.sin(r);
    };
    dMath.Cos = function (r) {
        return Math.cos(r);
    };
    dMath.Tan = function (r) {
        return Math.tan(r);
    };
    dMath.Asin = function (r) {
        return Math.asin(r);
    };
    dMath.Acos = function (r) {
        return Math.acos(r);
    };
    dMath.Atan = function (r) {
        return Math.atan(r);
    };
    dMath.Atan2 = function (y, x) {
        return Math.atan2(y, x);
    };
    dMath.Sqrt = function (r) {
        return Math.sqrt(r);
    };
    dMath.Pow = function (r, x) {
        if (x == 1)
            return r;
        if (x == 2)
            return r * r;
        if (x == 3)
            return r * r * r;
        return Math.pow(r, x);
    };
    dMath.Abs = function (a) {
        if (a < 0)
            return -a;
        return a;
    };
    dMath.Signum = function (a) {
        if (a < 0)
            return -1;
        if (a > 0)
            return 1;
        return 0;
    };
    dMath.EqualsZero = function (f, ignore) {
        if (ignore === void 0) { ignore = 0.00001; }
        return dMath.Abs(f) < ignore;
    };
    dMath.Exp = function (x) {
        return Math.exp(x);
    };
    dMath.ToInt = function (f) {
        return Math.trunc(f);
    };
    dMath.ParseInt = function (str, radix) {
        if (radix === void 0) { radix = 10; }
        var ret = parseInt(str, radix);
        if (Number.isNaN(ret))
            ret = 0;
        return ret;
    };
    dMath.ParseFloat = function (str) {
        var ret = parseFloat(str);
        if (Number.isNaN(ret))
            ret = 0;
        return ret;
    };
    dMath.Floor = function (f) {
        return Math.floor(f);
    };
    dMath.Ceil = function (f) {
        return Math.ceil(f);
    };
    dMath.Round = function (r) {
        return Math.round(r);
    };
    dMath.Max = function (a, b) {
        return a > b ? a : b;
    };
    dMath.Max3 = function (a, b, c) {
        a = dMath.Max(a, b);
        return dMath.Max(a, c);
    };
    dMath.Min = function (a, b) {
        return a < b ? a : b;
    };
    dMath.Min3 = function (a, b, c) {
        a = dMath.Min(a, b);
        return dMath.Min(a, c);
    };
    dMath.MaxArray = function (vec) {
        var ret;
        for (var i = 0; i < vec.length; i++)
            if (i == 0 || ret < vec[i])
                ret = vec[i];
        return ret;
    };
    dMath.MinArray = function (vec) {
        var ret;
        for (var i = 0; i < vec.length; i++)
            if (i == 0 || ret > vec[i])
                ret = vec[i];
        return ret;
    };
    dMath.MaxArrayIndex = function (vec) {
        var ret = 0;
        for (var i = 0; i < vec.length; i++)
            if (i == 0 || vec[ret] < vec[i])
                ret = i;
        return ret;
    };
    dMath.MinArrayIndex = function (vec) {
        var ret = 0;
        for (var i = 0; i < vec.length; i++)
            if (i == 0 || vec[ret] > vec[i])
                ret = i;
        return ret;
    };
    dMath.Clamp = function (value, min, max) {
        if (value < min)
            return min;
        if (value > max)
            return max;
        return value;
    };
    dMath.Distance = function (sx, sy, ex, ey) {
        var d = dMath.Sqrt((ex - sx) * (ex - sx) + (ey - sy) * (ey - sy));
        return d;
    };
    dMath.Mod = function (v, mod) {
        if (mod == 0)
            return v;
        var mod2 = dMath.Abs(mod);
        var r = v % mod2;
        if (r < 0)
            r = r + mod2;
        if (mod < 0)
            return -r;
        return r;
    };
    dMath.LerpAngle = function (from, to, frac, bLimitTo360) {
        if (bLimitTo360 === void 0) { bLimitTo360 = false; }
        var from2 = dMath.AngleToRadian(from);
        var to2 = dMath.AngleToRadian(to);
        var ret = dMath.RadianToAngle(dMath.LerpRadian(from2, to2, frac, bLimitTo360));
        return ret;
    };
    dMath.LerpRadian = function (from, to, frac, bLimitAngle) {
        if (bLimitAngle === void 0) { bLimitAngle = false; }
        if (bLimitAngle) {
            while (from < 0 || to < 0) {
                from += dMath.dPI * 2;
                to += dMath.dPI * 2;
            }
        }
        var a;
        if (to - from > dMath.dPI) {
            to -= dMath.dPI * 2;
        }
        if (to - from < -dMath.dPI) {
            to += dMath.dPI * 2;
        }
        a = from + frac * (to - from);
        if (bLimitAngle)
            a %= (dMath.dPI * 2);
        return a;
    };
    dMath.Lerp = function (a1, a2, lerp) {
        return a1 * (1.0 - lerp) + a2 * lerp;
    };
    dMath.LerpArray = function (data, lerp) {
        if (data.length == 0)
            return 0;
        if (data.length == 1)
            return data[0];
        var index = lerp * (data.length - 1);
        if (index == data.length - 1)
            return data[data.length - 1];
        return dMath.Lerp(data[index], data[index + 1], lerp * (data.length - 1) - index);
    };
    dMath.LerpColor = function (a1, a2, lerp) {
        var c1 = dMath.ColorToValue(a1);
        var c2 = dMath.ColorToValue(a2);
        var r = dMath.Lerp(c1.x, c2.x, lerp);
        var g = dMath.Lerp(c1.y, c2.y, lerp);
        var b = dMath.Lerp(c1.z, c2.z, lerp);
        var a = dMath.Lerp(c1.w, c2.w, lerp);
        return dMath.ColorFromValue(a, r, g, b);
    };
    dMath.ColorFromVector4 = function (v) {
        return dMath.ColorFromValue(v.w, v.x, v.y, v.z);
    };
    dMath.ColorFromValue = function (a, r, g, b) {
        return ((dMath.ToInt(a * 255)) << 24) | ((dMath.ToInt(r * 255)) << 16) | ((dMath.ToInt(g * 255)) << 8) | (dMath.ToInt(b * 255));
    };
    dMath.ColorMulty = function (a, b) {
        var c1 = dMath.ColorToValue(a);
        var c2 = dMath.ColorToValue(b);
        c1.MulAppend(c2);
        return dMath.ColorFromVector4(c1);
    };
    dMath.ColorToValue = function (color) {
        var v = new dVector4();
        v.w = ((color & 0xFF000000) >>> 24) / 255.0;
        v.x = ((color & 0x00FF0000) >> 16) / 255.0;
        v.y = ((color & 0x0000FF00) >> 8) / 255.0;
        v.z = ((color & 0x000000FF)) / 255.0;
        return v;
    };
    dMath.ColorToValue3 = function (color) {
        var v = new dVector3();
        v.x = ((color & 0x00FF0000) >> 16) / 255.0;
        v.y = ((color & 0x0000FF00) >> 8) / 255.0;
        v.z = ((color & 0x000000FF)) / 255.0;
        return v;
    };
    dMath.ColorBlend = function (dest, src) {
        if (dest == 0)
            return src;
        var a1 = (dest & 0xFF000000) >>> 24;
        var a2 = (src & 0xFF000000) >>> 24;
        if (a1 == 255 && a2 == 255)
            return src;
        else {
            var r1 = (dest & 0x00FF0000) >>> 16;
            var g1 = (dest & 0x0000FF00) >>> 8;
            var b1 = (dest & 0x000000FF);
            var r2 = (src & 0x00FF0000) >>> 16;
            var g2 = (src & 0x0000FF00) >>> 8;
            var b2 = (src & 0x000000FF);
            var a3 = a1 + a2;
            if (a3 > 255)
                a3 = 255;
            var r3 = (r1 * (255 - a2) + r2 * a2) / 255;
            var g3 = (g1 * (255 - a2) + g2 * a2) / 255;
            var b3 = (b1 * (255 - a2) + b2 * a2) / 255;
            return a3 << 24 | r3 << 16 | g3 << 8 | b3;
        }
        return 0;
    };
    dMath.AngleToRadian = function (x) {
        return (x / 360.0 * dMath.dPI * 2);
    };
    dMath.RadianToAngle = function (x) {
        return (x * 360.0 / (dMath.dPI * 2));
    };
    dMath.SubAngle = function (a1, a2) {
        a1 %= 360;
        a2 %= 360;
        if (a1 < 0)
            a1 = 360 + (a1 % 360);
        if (a2 < 0)
            a2 = 360 + (a2 % 360);
        var d1, d2;
        d1 = a1 - a2;
        d2 = 360 - dMath.Abs(d1);
        if (d1 > 0)
            d2 *= -1.0;
        if (dMath.Abs(d1) < dMath.Abs(d2))
            return (d1);
        else
            return (d2);
    };
    dMath.isCircleIntersectLineSeg = function (x, y, r, x1, y1, x2, y2) {
        var vx1 = x - x1;
        var vy1 = y - y1;
        var vx2 = x2 - x1;
        var vy2 = y2 - y1;
        if (dMath.Abs(vx2) < 0.00001 && dMath.Abs(vy2) < 0.00001)
            return false;
        var len = dMath.Sqrt(vx2 * vx2 + vy2 * vy2);
        vx2 /= len;
        vy2 /= len;
        var u = vx1 * vx2 + vy1 * vy2;
        var x0 = 0.0;
        var y0 = 0.0;
        if (u <= 0) {
            x0 = x1;
            y0 = y1;
        }
        else if (u >= len) {
            x0 = x2;
            y0 = y2;
        }
        else {
            x0 = x1 + vx2 * u;
            y0 = y1 + vy2 * u;
        }
        return (x - x0) * (x - x0) + (y - y0) * (y - y0) <= r * r;
    };
    dMath.PointInTriangle2D = function (A, B, C, P) {
        return dMath.PointInTriangle(A.ToVector3(), B.ToVector3(), C.ToVector3(), P.ToVector3());
    };
    dMath.PointInTriangle = function (A, B, C, P) {
        if (A.EqualsIgnore(B) || A.EqualsIgnore(C) || B.EqualsIgnore(C))
            return false;
        var v0 = dMath.v0;
        var v1 = dMath.v1;
        var v2 = dMath.v2;
        dVector3.Vec3Sub(v0, C, A);
        dVector3.Vec3Sub(v1, B, A);
        dVector3.Vec3Sub(v2, P, A);
        var dot00 = dVector3.Vec3Dot(v0, v0);
        var dot01 = dVector3.Vec3Dot(v0, v1);
        var dot02 = dVector3.Vec3Dot(v0, v2);
        var dot11 = dVector3.Vec3Dot(v1, v1);
        var dot12 = dVector3.Vec3Dot(v1, v2);
        var inverDeno = 1 / (dot00 * dot11 - dot01 * dot01);
        var u = (dot11 * dot02 - dot01 * dot12) * inverDeno;
        if (u < 0 || u > 1) {
            return false;
        }
        var v = (dot00 * dot12 - dot01 * dot02) * inverDeno;
        if (v < 0 || v > 1) {
            return false;
        }
        return u + v <= 1;
    };
    dMath.isPower2N = function (x) {
        return (x & (x - 1)) == 0;
    };
    dMath.CircleCircleIntersection2D = function (x1, y1, radio1, x2, y2, radio2) {
        return (x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2) < (radio1 + radio2) * (radio1 + radio2);
    };
    dMath.CirclePointCollection2D = function (px, py, x, y, radio) {
        var length = dMath.Sqrt((px - x) * (px - x) + (py - y) * (py - y));
        return length < radio;
    };
    dMath.SpriteSpriteCollection = function (p1, p2, root) {
        if (p1.rotation == 0 && p2.rotation == 0) {
            var parentSame = p1.GetParent() == p2.GetParent();
            var rc1 = new dRect().SetPosSize(parentSame ? p1.positionX : p1.GetPosX_World(root, false) - p1.width * p1.scaleX * p1.anchorU, parentSame ? p1.positionY : p1.GetPosY_World(root, false) - p1.height * p1.scaleY * p1.anchorV, p1.width * p1.scaleX, p1.height * p1.scaleY);
            var rc2 = new dRect().SetPosSize(parentSame ? p2.positionX : p2.GetPosX_World(root, false) - p2.width * p2.scaleX * p2.anchorU, parentSame ? p2.positionY : p2.GetPosY_World(root, false) - p2.height * p2.scaleY * p2.anchorV, p2.width * p2.scaleX, p2.height * p2.scaleY);
            return rc1.Collect(rc2);
        }
        var rc1 = new dRect().SetPosSize(-p1.width * p1.anchorU, -p1.height * p1.anchorV, p1.width, p1.height);
        var rc2 = new dRect().SetPosSize(-p2.width * p2.anchorU, -p2.height * p2.anchorV, p2.width, p2.height);
        var a1 = new dVector2(rc1.left, rc1.top);
        var a2 = new dVector2(rc1.right, rc1.bottom);
        var a3 = new dVector2(rc1.left, rc1.bottom);
        var a4 = new dVector2(rc1.right, rc1.top);
        var b1 = new dVector2(rc2.left, rc2.top);
        var b2 = new dVector2(rc2.right, rc2.bottom);
        var b3 = new dVector2(rc2.left, rc2.bottom);
        var b4 = new dVector2(rc2.right, rc2.top);
        var m1 = p1.GetMatrixWorld(root, false);
        var m2 = p2.GetMatrixWorld(root, false);
        a1.Transform(m1);
        a2.Transform(m1);
        a3.Transform(m1);
        a4.Transform(m1);
        b1.Transform(m2);
        b2.Transform(m2);
        b3.Transform(m2);
        b4.Transform(m2);
        if (dMath.TriTriCollection2D(a1, a2, a3, b1, b2, b3) ||
            dMath.TriTriCollection2D(a1, a2, a3, b2, b1, b4) ||
            dMath.TriTriCollection2D(a2, a1, a4, b1, b2, b3) ||
            dMath.TriTriCollection2D(a2, a1, a4, b2, b1, b4))
            return true;
        return false;
    };
    dMath.TriTriCollection2D = function (a1, a2, a3, b1, b2, b3) {
        if (dMath.PointInTriangle2D(a1, a2, a3, b1) ||
            dMath.PointInTriangle2D(a1, a2, a3, b2) ||
            dMath.PointInTriangle2D(a1, a2, a3, b3) ||
            dMath.PointInTriangle2D(b1, b2, b3, a1) ||
            dMath.PointInTriangle2D(b1, b2, b3, a2) ||
            dMath.PointInTriangle2D(b1, b2, b3, a3))
            return true;
        if (dMath.LineLineIntersection2D(a1.x, a1.y, a2.x, a2.y, b1.x, b1.y, b2.x, b2.y) ||
            dMath.LineLineIntersection2D(a1.x, a1.y, a2.x, a2.y, b2.x, b2.y, b3.x, b3.y) ||
            dMath.LineLineIntersection2D(a1.x, a1.y, a2.x, a2.y, b3.x, b3.y, b1.x, b1.y) ||
            dMath.LineLineIntersection2D(a2.x, a2.y, a3.x, a3.y, b1.x, b1.y, b2.x, b2.y) ||
            dMath.LineLineIntersection2D(a2.x, a2.y, a3.x, a3.y, b2.x, b2.y, b3.x, b3.y) ||
            dMath.LineLineIntersection2D(a2.x, a2.y, a3.x, a3.y, b3.x, b3.y, b1.x, b1.y) ||
            dMath.LineLineIntersection2D(a3.x, a3.y, a1.x, a1.y, b1.x, b1.y, b2.x, b2.y) ||
            dMath.LineLineIntersection2D(a3.x, a3.y, a1.x, a1.y, b2.x, b2.y, b3.x, b3.y) ||
            dMath.LineLineIntersection2D(a3.x, a3.y, a1.x, a1.y, b3.x, b3.y, b1.x, b1.y))
            return true;
        return false;
    };
    dMath.TriangleCircleCollect2D = function (p1, p2, p3, c, radio) {
        return dMath.LineCircleCollect2D(p1, p2, c, radio) ||
            dMath.LineCircleCollect2D(p2, p3, c, radio) ||
            dMath.LineCircleCollect2D(p3, p1, c, radio);
    };
    dMath.LineCircleCollect2D = function (p1, p2, c, radio) {
        var flag1 = (p1.x - c.x) * (p1.x - c.x) + (p1.y - c.y) * (p1.y - c.y) <= radio * radio;
        var flag2 = (p2.x - c.x) * (p2.x - c.x) + (p2.y - c.y) * (p2.y - c.y) <= radio * radio;
        if (flag1 || flag2)
            return true;
        return dMath.LineCircleIntersect2D(c.x, c.y, radio, p1.x, p1.y, p2.x, p2.y);
    };
    dMath.DistanceBetweenTwoPoints = function (x1, y1, x2, y2) {
        return dMath.Sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
    };
    dMath.DistanceFromPointToLine = function (x, y, x1, y1, x2, y2) {
        var a = y2 - y1;
        var b = x1 - x2;
        var c = x2 * y1 - x1 * y2;
        return dMath.Abs(a * x + b * y + c) / dMath.Sqrt(a * a + b * b);
    };
    dMath.CircleRectangleIntersection = function (rx, ry, radio, left, top, right, bottom) {
        return dMath._CircleRectangleIntersection(rx, ry, radio, (right - left) * 0.5 + left, (bottom - top) * 0.5 + top, (right - left) * 0.5 + left, top, right, (bottom - top) * 0.5 + top);
    };
    dMath._CircleRectangleIntersection = function (x, y, r, x0, y0, x1, y1, x2, y2) {
        var w1 = dMath.DistanceBetweenTwoPoints(x0, y0, x2, y2);
        var h1 = dMath.DistanceBetweenTwoPoints(x0, y0, x1, y1);
        var w2 = dMath.DistanceFromPointToLine(x, y, x0, y0, x1, y1);
        var h2 = dMath.DistanceFromPointToLine(x, y, x0, y0, x2, y2);
        if (w2 > w1 + r)
            return false;
        if (h2 > h1 + r)
            return false;
        if (w2 <= w1)
            return true;
        if (h2 <= h1)
            return true;
        return (w2 - w1) * (w2 - w1) + (h2 - h1) * (h2 - h1) <= r * r;
    };
    dMath.TriangleAABBIntersection2D = function (left, top, right, bottom, x0, y0, x1, y1, x2, y2) {
        return dMath.LineAABBIntersect2D(left, top, right, bottom, x0, y0, x1, y1)
            || dMath.LineAABBIntersect2D(left, top, right, bottom, x1, y1, x2, y2)
            || dMath.LineAABBIntersect2D(left, top, right, bottom, x2, y2, x0, y0);
    };
    dMath.RectangleAABBIntersection2D = function (left, top, right, bottom, x0, y0, x1, y1, x2, y2, x3, y3) {
        return dMath.LineAABBIntersect2D(left, top, right, bottom, x0, y0, x1, y1)
            || dMath.LineAABBIntersect2D(left, top, right, bottom, x1, y1, x2, y2)
            || dMath.LineAABBIntersect2D(left, top, right, bottom, x2, y2, x3, y3)
            || dMath.LineAABBIntersect2D(left, top, right, bottom, x3, y3, x0, y0);
    };
    dMath.LineAABBIntersect2D = function (left, top, right, bottom, linePointX1, linePointY1, linePointX2, linePointY2) {
        var lineHeight = linePointY1 - linePointY2;
        var lineWidth = linePointX2 - linePointX1;
        var c = linePointX1 * linePointY2 - linePointX2 * linePointY1;
        if ((lineHeight * left + lineWidth * top + c >= 0 && lineHeight * right + lineWidth * bottom + c <= 0)
            || (lineHeight * left + lineWidth * top + c <= 0 && lineHeight * right + lineWidth * bottom + c >= 0)
            || (lineHeight * left + lineWidth * bottom + c >= 0 && lineHeight * right + lineWidth * top + c <= 0)
            || (lineHeight * left + lineWidth * bottom + c <= 0 && lineHeight * right + lineWidth * top + c >= 0)) {
            if (left > right) {
                var temp = left;
                left = right;
                right = temp;
            }
            if (top < bottom) {
                var temp1 = top;
                top = bottom;
                bottom = temp1;
            }
            if ((linePointX1 < left && linePointX2 < left)
                || (linePointX1 > right && linePointX2 > right)
                || (linePointY1 > top && linePointY2 > top)
                || (linePointY1 < bottom && linePointY2 < bottom)) {
                return false;
            }
            else {
                return true;
            }
        }
        else {
            return false;
        }
    };
    dMath.LineCircleIntersect2D = function (x, y, r, x1, y1, x2, y2) {
        var vx1 = x - x1;
        var vy1 = y - y1;
        var vx2 = x2 - x1;
        var vy2 = y2 - y1;
        var len = dMath.Sqrt(vx2 * vx2 + vy2 * vy2);
        vx2 /= len;
        vy2 /= len;
        var u = vx1 * vx2 + vy1 * vy2;
        var x0 = 0.0;
        var y0 = 0.0;
        if (u <= 0) {
            x0 = x1;
            y0 = y1;
        }
        else if (u >= len) {
            x0 = x2;
            y0 = y2;
        }
        else {
            x0 = x1 + vx2 * u;
            y0 = y1 + vy2 * u;
        }
        return (x - x0) * (x - x0) + (y - y0) * (y - y0) <= r * r;
    };
    dMath.LineLineIntersection2D = function (l1x1, l1y1, l1x2, l1y2, l2x1, l2y1, l2x2, l2y2) {
        if ((l1x1 > l1x2 ? l1x1 : l1x2) < (l2x1 < l2x2 ? l2x1 : l2x2) ||
            (l1y1 > l1y2 ? l1y1 : l1y2) < (l2y1 < l2y2 ? l2y1 : l2y2) ||
            (l2x1 > l2x2 ? l2x1 : l2x2) < (l1x1 < l1x2 ? l1x1 : l1x2) ||
            (l2y1 > l2y2 ? l2y1 : l2y2) < (l1y1 < l1y2 ? l1y1 : l1y2)) {
            return false;
        }
        if ((((l1x1 - l2x1) * (l2y2 - l2y1) - (l1y1 - l2y1) * (l2x2 - l2x1)) *
            ((l1x2 - l2x1) * (l2y2 - l2y1) - (l1y2 - l2y1) * (l2x2 - l2x1))) > 0 ||
            (((l2x1 - l1x1) * (l1y2 - l1y1) - (l2y1 - l1y1) * (l1x2 - l1x1)) *
                ((l2x2 - l1x1) * (l1y2 - l1y1) - (l2y2 - l1y1) * (l1x2 - l1x1))) > 0) {
            return false;
        }
        return true;
    };
    dMath.PointLineDistance2D = function (lineStartX, lineStartY, lineEndX, lineEndY, pointX, pointY) {
        if (lineStartX == lineEndX && lineStartY == lineEndY) {
            return new dVector2(lineStartX, lineStartY).LengthTo(new dVector2(pointX, pointY));
        }
        var a = new dVector2(lineStartX, lineStartY);
        var b = new dVector2(lineEndX, lineEndY);
        var c = new dVector2(pointX, pointY);
        var ab = b.Sub(a);
        var ac = c.Sub(a);
        var f = ab.Dot(ac);
        if (f < 0)
            return a.LengthTo(c);
        var ab2 = a.Sub(b);
        var ac2 = c.Sub(b);
        f = ab2.Dot(ac2);
        if (f < 0)
            return b.LengthTo(c);
        if (lineStartX == lineEndX)
            return dMath.Abs(lineStartX - pointX);
        else if (lineStartY == lineEndY)
            return dMath.Abs(lineStartY - pointY);
        else {
            var k = (lineEndY - lineStartY) / (lineEndX - lineStartX);
            var ka = -1 / k;
            var intersectX = (lineStartY - k * lineStartX - pointY + ka * pointX) / (ka - k);
            var intersectY = k * intersectX + lineStartY - k * lineStartX;
            return dMath.Sqrt(dMath.Pow(pointX - intersectX, 2) + dMath.Pow(pointY - intersectY, 2));
        }
    };
    dMath.PointVectorDistance = function (point, v) {
        var dot = v.Dot(point);
        var distance = new dVector3();
        distance.x = point.x - dot * v.x;
        distance.y = point.y - dot * v.y;
        distance.z = point.z - dot * v.z;
        return distance.Length();
    };
    dMath.RayTriangleIntersection = function (orig, dir, v0, v1, v2, tuvOut) {
        if (tuvOut === void 0) { tuvOut = null; }
        dVector3.Vec3Sub(dMath.v0, v1, v0);
        var E1 = dMath.v0;
        dVector3.Vec3Sub(dMath.v1, v2, v0);
        var E2 = dMath.v1;
        dVector3.Vec3Cross(dMath.v2, dir, E2);
        var P = dMath.v2;
        var det = E1.Dot(P);
        var T = dMath.AB;
        if (det > 0) {
            dVector3.Vec3Sub(T, orig, v0);
        }
        else {
            dVector3.Vec3Sub(T, v0, orig);
            det = -det;
        }
        if (det < 0.0001)
            return false;
        var u = T.Dot(P);
        if (u < 0.0 || u > det)
            return false;
        var Q = dMath.AC;
        dVector3.Vec3Cross(Q, T, E1);
        var v = dir.Dot(Q);
        if (v < 0.0 || u + v > det)
            return false;
        var t = E2.Dot(Q);
        var fInvDet = 1.0 / det;
        if (tuvOut != null) {
            t *= fInvDet;
            u *= fInvDet;
            v *= fInvDet;
            tuvOut.x = u;
            tuvOut.y = v;
            tuvOut.z = t;
        }
        return true;
    };
    dMath.RayPlaneIntersection = function (vRayOrig, vRayDir, planeNormal, planeOffset) {
        var t = -(planeNormal.Dot(vRayOrig) + planeOffset) / (planeNormal.Dot(vRayDir));
        if (t < 0)
            return null;
        return vRayOrig.Add(vRayDir.MulF(t));
    };
    dMath.SphereAABBOverlap = function (pSphereCenter, radius2, center, extents) {
        var d = 0.0;
        var tmp, s;
        tmp = pSphereCenter.x - center.x;
        s = tmp + extents.x;
        if (s < 0.0) {
            d += s * s;
            if (d > radius2)
                return false;
        }
        else {
            s = tmp - extents.x;
            if (s > 0.0) {
                d += s * s;
                if (d > radius2)
                    return false;
            }
        }
        tmp = pSphereCenter.y - center.y;
        s = tmp + extents.y;
        if (s < 0.0) {
            d += s * s;
            if (d > radius2)
                return false;
        }
        else {
            s = tmp - extents.y;
            if (s > 0.0) {
                d += s * s;
                if (d > radius2)
                    return false;
            }
        }
        tmp = pSphereCenter.z - center.z;
        s = tmp + extents.z;
        if (s < 0.0) {
            d += s * s;
            if (d > radius2)
                return false;
        }
        else {
            s = tmp - extents.z;
            if (s > 0.0) {
                d += s * s;
                if (d > radius2)
                    return false;
            }
        }
        return d <= radius2;
    };
    dMath.EnumSequnce = function (inData, maxNum, onCallback) {
        for (var i = 0; i < inData.length; i++)
            inData[i] = i;
        while (true) {
            var last = inData.length - 1;
            onCallback(inData);
            inData[last]++;
            var find = 0;
            while (inData[last] >= maxNum) {
                find = -1;
                for (var i = last - 1; i >= 0; i--) {
                    if (inData[i] < inData[i + 1] - 1) {
                        find = i;
                        break;
                    }
                }
                if (find == -1)
                    break;
                inData[find]++;
                for (var i = 1; i <= last - find; i++)
                    inData[i + find] = inData[i + find - 1] + 1;
            }
            if (find == -1)
                break;
        }
    };
    dMath.dPI = 3.141592653589793;
    dMath.dFLOAT_MAX = 3.402823466e+38;
    dMath.dFLOAT_MIN = 1.175494351e-38;
    dMath.dFLOAT_EPSILON = 0.000001;
    dMath.dINT_MAX = 2147483647;
    dMath.dINT_MIN = -2147483648;
    dMath.dLONG_MAX = 9223372036854775807;
    dMath.dLONG_MIN = -9223372036854775808;
    dMath.dDOUBLE_EPSILON = 0.000001;
    dMath.dDOUBLE_MAX = 1.7976931348623e+308;
    dMath.dDOUBLE_MIN = -1.7976931348623e+308;
    dMath.dE = 2.7182818284590452354;
    dMath.dLN10 = 2.302585092994046;
    dMath.dLN2 = 0.6931471805599453;
    dMath.dLOG10E = 0.4342944819032518;
    dMath.dLOG2E = 1.442695040888963387;
    dMath.dSQRT1_2 = 0.7071067811865476;
    dMath.dSQRT2 = 1.4142135623730951;
    return dMath;
}(dObject));
dObject.InitStatic(function () {
    dMath.AB = new dVector3();
    dMath.AC = new dVector3();
    dMath.AP = new dVector3();
    dMath.v0 = new dVector3();
    dMath.v1 = new dVector3();
    dMath.v2 = new dVector3();
});
var dMatrix = (function (_super) {
    __extends(dMatrix, _super);
    function dMatrix() {
        var _this = _super.call(this) || this;
        _this._11 = 1;
        _this._12 = 0;
        _this._13 = 0;
        _this._14 = 0;
        _this._21 = 0;
        _this._22 = 1;
        _this._23 = 0;
        _this._24 = 0;
        _this._31 = 0;
        _this._32 = 0;
        _this._33 = 1;
        _this._34 = 0;
        _this._41 = 0;
        _this._42 = 0;
        _this._43 = 0;
        _this._44 = 1;
        return _this;
    }
    dMatrix.prototype.Clear = function () {
        var p = this;
        p._11 = 0;
        p._12 = 0;
        p._13 = 0;
        p._14 = 0;
        p._21 = 0;
        p._22 = 0;
        p._23 = 0;
        p._24 = 0;
        p._31 = 0;
        p._32 = 0;
        p._33 = 0;
        p._34 = 0;
        p._41 = 0;
        p._42 = 0;
        p._43 = 0;
        p._44 = 0;
    };
    dMatrix.prototype.Equals = function (p) {
        if (p == null)
            return false;
        var a = this;
        return a._11 == p._11 && a._12 == p._12 && a._13 == p._13 && a._14 == p._14 &&
            a._21 == p._21 && a._22 == p._22 && a._23 == p._23 && a._24 == p._24 &&
            a._31 == p._31 && a._32 == p._32 && a._33 == p._33 && a._34 == p._34 &&
            a._41 == p._41 && a._42 == p._42 && a._43 == p._43 && a._44 == p._44;
    };
    dMatrix.prototype.EqualsIgnore = function (p, ignore) {
        if (ignore === void 0) { ignore = 0.0001; }
        if (p == null)
            return false;
        var a = this;
        return dMath.FloatEquals(a._11, p._11, ignore) &&
            dMath.FloatEquals(a._12, p._12, ignore) &&
            dMath.FloatEquals(a._13, p._13, ignore) &&
            dMath.FloatEquals(a._14, p._14, ignore) &&
            dMath.FloatEquals(a._21, p._21, ignore) &&
            dMath.FloatEquals(a._22, p._22, ignore) &&
            dMath.FloatEquals(a._23, p._23, ignore) &&
            dMath.FloatEquals(a._24, p._24, ignore) &&
            dMath.FloatEquals(a._31, p._31, ignore) &&
            dMath.FloatEquals(a._32, p._32, ignore) &&
            dMath.FloatEquals(a._33, p._33, ignore) &&
            dMath.FloatEquals(a._34, p._34, ignore) &&
            dMath.FloatEquals(a._41, p._41, ignore) &&
            dMath.FloatEquals(a._42, p._42, ignore) &&
            dMath.FloatEquals(a._43, p._43, ignore) &&
            dMath.FloatEquals(a._44, p._44, ignore);
    };
    dMatrix.prototype.Copy = function (m) {
        if (m == this)
            return this;
        var a = this;
        a._11 = m._11;
        a._12 = m._12;
        a._13 = m._13;
        a._14 = m._14;
        a._21 = m._21;
        a._22 = m._22;
        a._23 = m._23;
        a._24 = m._24;
        a._31 = m._31;
        a._32 = m._32;
        a._33 = m._33;
        a._34 = m._34;
        a._41 = m._41;
        a._42 = m._42;
        a._43 = m._43;
        a._44 = m._44;
        return this;
    };
    dMatrix.prototype.Identity = function () {
        var a = this;
        a._11 = 1.0;
        a._12 = 0.0;
        a._13 = 0.0;
        a._14 = 0.0;
        a._21 = 0.0;
        a._22 = 1.0;
        a._23 = 0.0;
        a._24 = 0.0;
        a._31 = 0.0;
        a._32 = 0.0;
        a._33 = 1.0;
        a._34 = 0.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = 0.0;
        a._44 = 1.0;
        return this;
    };
    dMatrix.prototype.TranslationVector3 = function (v) {
        return this.Translation(v.x, v.y, v.z);
    };
    dMatrix.prototype.Translation = function (x, y, z) {
        var a = this;
        a._11 = 1.0;
        a._12 = 0.0;
        a._13 = 0.0;
        a._14 = 0.0;
        a._21 = 0.0;
        a._22 = 1.0;
        a._23 = 0.0;
        a._24 = 0.0;
        a._31 = 0.0;
        a._32 = 0.0;
        a._33 = 1.0;
        a._34 = 0.0;
        a._41 = x;
        a._42 = y;
        a._43 = z;
        a._44 = 1.0;
        return this;
    };
    dMatrix.prototype.TranslationFast = function (x, y, z) {
        this._41 = x;
        this._42 = y;
        this._43 = z;
        return this;
    };
    dMatrix.prototype.TranslationAppend = function (x, y, z) {
        dMatrix.s_pMatrixForAppend.Translation(x, y, z);
        this.MulAppend(dMatrix.s_pMatrixForAppend);
        return this;
    };
    dMatrix.prototype.TranslationAppendFast = function (x, y, z) {
        this._41 += x;
        this._42 += y;
        this._43 += z;
        return this;
    };
    dMatrix.prototype.SetTranslationToZero = function () {
        this._41 = this._42 = this._43 = 0;
        return this;
    };
    dMatrix.prototype.ToTranslation = function () {
        return new dVector3(this._41, this._42, this._43);
    };
    dMatrix.prototype.Scaling = function (x, y, z) {
        var a = this;
        a._11 = x;
        a._12 = 0.0;
        a._13 = 0.0;
        a._14 = 0.0;
        a._21 = 0.0;
        a._22 = y;
        a._23 = 0.0;
        a._24 = 0.0;
        a._31 = 0.0;
        a._32 = 0.0;
        a._33 = z;
        a._34 = 0.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = 0.0;
        a._44 = 1.0;
        return this;
    };
    dMatrix.prototype.ScalingFast = function (x, y, z) {
        this._11 = x;
        this._22 = y;
        this._33 = z;
        return this;
    };
    dMatrix.prototype.ScalingAppend = function (x, y, z) {
        dMatrix.s_pMatrixForAppend.Scaling(x, y, z);
        this.MulAppend(dMatrix.s_pMatrixForAppend);
        return this;
    };
    dMatrix.prototype.RotationX = function (r) {
        var a = this;
        a._11 = 1.0;
        a._12 = 0.0;
        a._13 = 0.0;
        a._14 = 0.0;
        a._21 = 0.0;
        a._22 = dMath.Cos(r);
        a._23 = dMath.Sin(r);
        a._24 = 0.0;
        a._31 = 0.0;
        a._32 = -dMath.Sin(r);
        a._33 = dMath.Cos(r);
        a._34 = 0.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = 0.0;
        a._44 = 1.0;
        return this;
    };
    dMatrix.prototype.RotationXAppend = function (r) {
        dMatrix.s_pMatrixForAppend.RotationX(r);
        this.MulAppend(dMatrix.s_pMatrixForAppend);
        return this;
    };
    dMatrix.prototype.RotationY = function (r) {
        var a = this;
        a._11 = dMath.Cos(r);
        a._12 = 0.0;
        a._13 = -dMath.Sin(r);
        a._14 = 0.0;
        a._21 = 0.0;
        a._22 = 1.0;
        a._23 = 0.0;
        a._24 = 0.0;
        a._31 = dMath.Sin(r);
        a._32 = 0.0;
        a._33 = dMath.Cos(r);
        a._34 = 0.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = 0.0;
        a._44 = 1.0;
        return this;
    };
    dMatrix.prototype.RotationYAppend = function (r) {
        dMatrix.s_pMatrixForAppend.RotationY(r);
        this.MulAppend(dMatrix.s_pMatrixForAppend);
        return this;
    };
    dMatrix.prototype.RotationZ = function (r) {
        var a = this;
        a._11 = dMath.Cos(r);
        a._12 = dMath.Sin(r);
        a._13 = 0.0;
        a._14 = 0.0;
        a._21 = -dMath.Sin(r);
        a._22 = dMath.Cos(r);
        a._23 = 0.0;
        a._24 = 0.0;
        a._31 = 0.0;
        a._32 = 0.0;
        a._33 = 1.0;
        a._34 = 0.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = 0.0;
        a._44 = 1.0;
        return this;
    };
    dMatrix.prototype.RotationZAppend = function (r) {
        dMatrix.s_pMatrixForAppend.RotationZ(r);
        this.MulAppend(dMatrix.s_pMatrixForAppend);
        return this;
    };
    dMatrix.prototype.RotationAxis = function (r, _axis) {
        var a = this;
        var a1 = new dVector3(_axis.x, _axis.y, _axis.z);
        a1.Normalize();
        var c = dMath.Cos(r);
        var s = dMath.Sin(r);
        var t = 1.0 - c;
        a._11 = c + a1.x * a1.x * t;
        a._22 = c + a1.y * a1.y * t;
        a._33 = c + a1.z * a1.z * t;
        var tmp1 = a1.x * a1.y * t;
        var tmp2 = a1.z * s;
        a._21 = tmp1 + tmp2;
        a._12 = tmp1 - tmp2;
        tmp1 = a1.x * a1.z * t;
        tmp2 = a1.y * s;
        a._31 = tmp1 - tmp2;
        a._13 = tmp1 + tmp2;
        tmp1 = a1.y * a1.z * t;
        tmp2 = a1.x * s;
        a._32 = tmp1 + tmp2;
        a._23 = tmp1 - tmp2;
        a._14 = 0.0;
        a._24 = 0.0;
        a._34 = 0.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = 0.0;
        a._44 = 1.0;
        return this;
    };
    dMatrix.prototype.RotationAxisAppend = function (r, _axis) {
        dMatrix.s_pMatrixForAppend.RotationAxis(r, _axis);
        this.MulAppend(dMatrix.s_pMatrixForAppend);
        return this;
    };
    dMatrix.Multiply = function (ret, a, b) {
        var _11 = a._11 * b._11 + a._12 * b._21 + a._13 * b._31 + a._14 * b._41;
        var _12 = a._11 * b._12 + a._12 * b._22 + a._13 * b._32 + a._14 * b._42;
        var _13 = a._11 * b._13 + a._12 * b._23 + a._13 * b._33 + a._14 * b._43;
        var _14 = a._11 * b._14 + a._12 * b._24 + a._13 * b._34 + a._14 * b._44;
        var _21 = a._21 * b._11 + a._22 * b._21 + a._23 * b._31 + a._24 * b._41;
        var _22 = a._21 * b._12 + a._22 * b._22 + a._23 * b._32 + a._24 * b._42;
        var _23 = a._21 * b._13 + a._22 * b._23 + a._23 * b._33 + a._24 * b._43;
        var _24 = a._21 * b._14 + a._22 * b._24 + a._23 * b._34 + a._24 * b._44;
        var _31 = a._31 * b._11 + a._32 * b._21 + a._33 * b._31 + a._34 * b._41;
        var _32 = a._31 * b._12 + a._32 * b._22 + a._33 * b._32 + a._34 * b._42;
        var _33 = a._31 * b._13 + a._32 * b._23 + a._33 * b._33 + a._34 * b._43;
        var _34 = a._31 * b._14 + a._32 * b._24 + a._33 * b._34 + a._34 * b._44;
        var _41 = a._41 * b._11 + a._42 * b._21 + a._43 * b._31 + a._44 * b._41;
        var _42 = a._41 * b._12 + a._42 * b._22 + a._43 * b._32 + a._44 * b._42;
        var _43 = a._41 * b._13 + a._42 * b._23 + a._43 * b._33 + a._44 * b._43;
        var _44 = a._41 * b._14 + a._42 * b._24 + a._43 * b._34 + a._44 * b._44;
        ret._11 = _11;
        ret._12 = _12;
        ret._13 = _13;
        ret._14 = _14;
        ret._21 = _21;
        ret._22 = _22;
        ret._23 = _23;
        ret._24 = _24;
        ret._31 = _31;
        ret._32 = _32;
        ret._33 = _33;
        ret._34 = _34;
        ret._41 = _41;
        ret._42 = _42;
        ret._43 = _43;
        ret._44 = _44;
        return ret;
    };
    dMatrix.prototype.Mul = function (b) {
        if (b == null)
            return this;
        var a = this;
        var ret = new dMatrix();
        ret._11 = a._11 * b._11 + a._12 * b._21 + a._13 * b._31 + a._14 * b._41;
        ret._12 = a._11 * b._12 + a._12 * b._22 + a._13 * b._32 + a._14 * b._42;
        ret._13 = a._11 * b._13 + a._12 * b._23 + a._13 * b._33 + a._14 * b._43;
        ret._14 = a._11 * b._14 + a._12 * b._24 + a._13 * b._34 + a._14 * b._44;
        ret._21 = a._21 * b._11 + a._22 * b._21 + a._23 * b._31 + a._24 * b._41;
        ret._22 = a._21 * b._12 + a._22 * b._22 + a._23 * b._32 + a._24 * b._42;
        ret._23 = a._21 * b._13 + a._22 * b._23 + a._23 * b._33 + a._24 * b._43;
        ret._24 = a._21 * b._14 + a._22 * b._24 + a._23 * b._34 + a._24 * b._44;
        ret._31 = a._31 * b._11 + a._32 * b._21 + a._33 * b._31 + a._34 * b._41;
        ret._32 = a._31 * b._12 + a._32 * b._22 + a._33 * b._32 + a._34 * b._42;
        ret._33 = a._31 * b._13 + a._32 * b._23 + a._33 * b._33 + a._34 * b._43;
        ret._34 = a._31 * b._14 + a._32 * b._24 + a._33 * b._34 + a._34 * b._44;
        ret._41 = a._41 * b._11 + a._42 * b._21 + a._43 * b._31 + a._44 * b._41;
        ret._42 = a._41 * b._12 + a._42 * b._22 + a._43 * b._32 + a._44 * b._42;
        ret._43 = a._41 * b._13 + a._42 * b._23 + a._43 * b._33 + a._44 * b._43;
        ret._44 = a._41 * b._14 + a._42 * b._24 + a._43 * b._34 + a._44 * b._44;
        return ret;
    };
    dMatrix.prototype.MulAppend = function (b) {
        if (b == null)
            return this;
        var a = this;
        var ret = dMatrix.s_mulAppendTemp;
        ret._11 = a._11 * b._11 + a._12 * b._21 + a._13 * b._31 + a._14 * b._41;
        ret._12 = a._11 * b._12 + a._12 * b._22 + a._13 * b._32 + a._14 * b._42;
        ret._13 = a._11 * b._13 + a._12 * b._23 + a._13 * b._33 + a._14 * b._43;
        ret._14 = a._11 * b._14 + a._12 * b._24 + a._13 * b._34 + a._14 * b._44;
        ret._21 = a._21 * b._11 + a._22 * b._21 + a._23 * b._31 + a._24 * b._41;
        ret._22 = a._21 * b._12 + a._22 * b._22 + a._23 * b._32 + a._24 * b._42;
        ret._23 = a._21 * b._13 + a._22 * b._23 + a._23 * b._33 + a._24 * b._43;
        ret._24 = a._21 * b._14 + a._22 * b._24 + a._23 * b._34 + a._24 * b._44;
        ret._31 = a._31 * b._11 + a._32 * b._21 + a._33 * b._31 + a._34 * b._41;
        ret._32 = a._31 * b._12 + a._32 * b._22 + a._33 * b._32 + a._34 * b._42;
        ret._33 = a._31 * b._13 + a._32 * b._23 + a._33 * b._33 + a._34 * b._43;
        ret._34 = a._31 * b._14 + a._32 * b._24 + a._33 * b._34 + a._34 * b._44;
        ret._41 = a._41 * b._11 + a._42 * b._21 + a._43 * b._31 + a._44 * b._41;
        ret._42 = a._41 * b._12 + a._42 * b._22 + a._43 * b._32 + a._44 * b._42;
        ret._43 = a._41 * b._13 + a._42 * b._23 + a._43 * b._33 + a._44 * b._43;
        ret._44 = a._41 * b._14 + a._42 * b._24 + a._43 * b._34 + a._44 * b._44;
        this.Copy(ret);
        return this;
    };
    dMatrix.prototype.AppendMul = function (a) {
        if (a == null)
            return this;
        var b = this;
        var ret = dMatrix.s_mulAppendTemp;
        ret._11 = a._11 * b._11 + a._12 * b._21 + a._13 * b._31 + a._14 * b._41;
        ret._12 = a._11 * b._12 + a._12 * b._22 + a._13 * b._32 + a._14 * b._42;
        ret._13 = a._11 * b._13 + a._12 * b._23 + a._13 * b._33 + a._14 * b._43;
        ret._14 = a._11 * b._14 + a._12 * b._24 + a._13 * b._34 + a._14 * b._44;
        ret._21 = a._21 * b._11 + a._22 * b._21 + a._23 * b._31 + a._24 * b._41;
        ret._22 = a._21 * b._12 + a._22 * b._22 + a._23 * b._32 + a._24 * b._42;
        ret._23 = a._21 * b._13 + a._22 * b._23 + a._23 * b._33 + a._24 * b._43;
        ret._24 = a._21 * b._14 + a._22 * b._24 + a._23 * b._34 + a._24 * b._44;
        ret._31 = a._31 * b._11 + a._32 * b._21 + a._33 * b._31 + a._34 * b._41;
        ret._32 = a._31 * b._12 + a._32 * b._22 + a._33 * b._32 + a._34 * b._42;
        ret._33 = a._31 * b._13 + a._32 * b._23 + a._33 * b._33 + a._34 * b._43;
        ret._34 = a._31 * b._14 + a._32 * b._24 + a._33 * b._34 + a._34 * b._44;
        ret._41 = a._41 * b._11 + a._42 * b._21 + a._43 * b._31 + a._44 * b._41;
        ret._42 = a._41 * b._12 + a._42 * b._22 + a._43 * b._32 + a._44 * b._42;
        ret._43 = a._41 * b._13 + a._42 * b._23 + a._43 * b._33 + a._44 * b._43;
        ret._44 = a._41 * b._14 + a._42 * b._24 + a._43 * b._34 + a._44 * b._44;
        this.Copy(ret);
        return this;
    };
    dMatrix.prototype.DecomposeQuaternion = function (pTransOut, pScaOut, pRotOut) {
        var rot = new dMatrix();
        this.Decompose(pTransOut, pScaOut, rot);
        if (pRotOut != null)
            pRotOut.Copy(rot.ToQuaternion());
    };
    dMatrix.prototype.DecomposeRotation = function () {
        var ret = new dMatrix();
        this.Decompose(null, null, ret);
        return ret;
    };
    dMatrix.prototype.Decompose = function (pTransOut, pScaOut, pRotOut) {
        var a = this;
        if (pTransOut) {
            pTransOut.x = a._41;
            pTransOut.y = a._42;
            pTransOut.z = a._43;
        }
        if (!pScaOut && !pRotOut)
            return;
        if (!pScaOut && pRotOut)
            pScaOut = new dVector3();
        if (pScaOut) {
            pScaOut.x = dMath.Sqrt(a._11 * a._11 + a._12 * a._12 + a._13 * a._13);
            pScaOut.y = dMath.Sqrt(a._21 * a._21 + a._22 * a._22 + a._23 * a._23);
            pScaOut.z = dMath.Sqrt(a._31 * a._31 + a._32 * a._32 + a._33 * a._33);
        }
        var mat3x3 = new dMatrix();
        mat3x3._11 = a._11;
        mat3x3._12 = a._12;
        mat3x3._13 = a._13;
        mat3x3._14 = 0.0;
        mat3x3._21 = a._21;
        mat3x3._22 = a._22;
        mat3x3._23 = a._23;
        mat3x3._24 = 0.0;
        mat3x3._31 = a._31;
        mat3x3._32 = a._32;
        mat3x3._33 = a._33;
        mat3x3._34 = 0.0;
        mat3x3._41 = 0.0;
        mat3x3._42 = 0.0;
        mat3x3._43 = 0.0;
        mat3x3._44 = 1.0;
        if (mat3x3.Determinant() < 0)
            pScaOut.x = -pScaOut.x;
        if (pScaOut != null) {
            if (pScaOut.x != 0.0) {
                mat3x3._11 /= pScaOut.x;
                mat3x3._12 /= pScaOut.x;
                mat3x3._13 /= pScaOut.x;
            }
            if (pScaOut.y != 0.0) {
                mat3x3._21 /= pScaOut.y;
                mat3x3._22 /= pScaOut.y;
                mat3x3._23 /= pScaOut.y;
            }
            if (pScaOut.z != 0.0) {
                mat3x3._31 /= pScaOut.z;
                mat3x3._32 /= pScaOut.z;
                mat3x3._33 /= pScaOut.z;
            }
        }
        if (pRotOut != null)
            pRotOut.Copy(mat3x3);
    };
    dMatrix.prototype.ToRotationEuler = function () {
        var a = this;
        var sy = dMath.Sqrt(a._11 * a._11 + a._12 * a._12);
        var singular = sy < 0.00001;
        var v = new dVector3();
        if (!singular) {
            v.x = dMath.Atan2(a._23, a._33);
            v.y = dMath.Atan2(-a._13, sy);
            v.z = dMath.Atan2(a._12, a._11);
        }
        else {
            v.x = dMath.Atan2(-a._32, a._22);
            v.y = dMath.Atan2(-a._13, sy);
            v.z = 0;
        }
        v.SetValue(dMath.RadianToAngle(v.x), dMath.RadianToAngle(v.y), dMath.RadianToAngle(v.z));
        return v;
    };
    dMatrix.prototype.ToAxisAngle = function (vAxisOut) {
        var a = this;
        var ret = 0;
        var epsilon = 0.0001;
        var epsilon2 = 0.001;
        if ((dMath.Abs(a._12 - a._21) < epsilon)
            && (dMath.Abs(a._13 - a._31) < epsilon)
            && (dMath.Abs(a._23 - a._32) < epsilon)) {
            if ((dMath.Abs(a._12 + a._21) < epsilon2)
                && (dMath.Abs(a._13 + a._31) < epsilon2)
                && (dMath.Abs(a._23 + a._32) < epsilon2)
                && (dMath.Abs(a._11 + a._22 + a._33 - 3) < epsilon2)) {
                vAxisOut.SetValue(0, 0, 0);
                return 0;
            }
            ret = dMath.dPI;
            var xx = (a._11 + 1.0) / 2.0;
            var yy = (a._22 + 1.0) / 2.0;
            var zz = (a._33 + 1.0) / 2.0;
            var xy = (a._12 + a._21) / 4.0;
            var xz = (a._13 + a._31) / 4.0;
            var yz = (a._23 + a._32) / 4.0;
            if ((xx >= yy) && (xx >= zz)) {
                if (xx < epsilon) {
                    vAxisOut.x = 0;
                    vAxisOut.y = 0.7071;
                    vAxisOut.z = 0.7071;
                }
                else {
                    vAxisOut.x = dMath.Sqrt(xx);
                    vAxisOut.y = xy / vAxisOut.x;
                    vAxisOut.z = xz / vAxisOut.x;
                }
            }
            else if (yy >= zz) {
                if (yy < epsilon) {
                    vAxisOut.x = 0.7071;
                    vAxisOut.y = 0;
                    vAxisOut.z = 0.7071;
                }
                else {
                    vAxisOut.y = dMath.Sqrt(yy);
                    vAxisOut.x = xy / vAxisOut.y;
                    vAxisOut.z = yz / vAxisOut.y;
                }
            }
            else {
                if (zz < epsilon) {
                    vAxisOut.x = 0.7071;
                    vAxisOut.y = 0.7071;
                    vAxisOut.z = 0;
                }
                else {
                    vAxisOut.z = dMath.Sqrt(zz);
                    vAxisOut.x = xz / vAxisOut.z;
                    vAxisOut.y = yz / vAxisOut.z;
                }
            }
            return ret;
        }
        var s = dMath.Sqrt((a._32 - a._23) * (a._32 - a._23)
            + (a._13 - a._31) * (a._13 - a._31)
            + (a._21 - a._12) * (a._21 - a._12));
        if (dMath.Abs(s) < 0.001)
            s = 1;
        ret = dMath.Acos((a._11 + a._22 + a._33 - 1.0) / 2.0);
        vAxisOut.x = (a._32 - a._23) / s;
        vAxisOut.y = (a._13 - a._31) / s;
        vAxisOut.z = (a._21 - a._12) / s;
        return ret;
    };
    dMatrix.prototype.RotationEuler = function (x, y, z) {
        var matX = new dMatrix().RotationX(dMath.AngleToRadian(x));
        var matY = new dMatrix().RotationY(dMath.AngleToRadian(y));
        var matZ = new dMatrix().RotationZ(dMath.AngleToRadian(z));
        dMatrix.Multiply(this, matX, matY);
        dMatrix.Multiply(this, this, matZ);
        return this;
    };
    dMatrix.prototype.RotationEulerAppend = function (x, y, z) {
        dMatrix.s_pMatrixForAppend.RotationEuler(x, y, z);
        this.MulAppend(dMatrix.s_pMatrixForAppend);
        return this;
    };
    dMatrix.prototype.RotationFromDirection = function (direction, up) {
        if (up === void 0) { up = null; }
        if (!up)
            up = new dVector3(0, 1, 0);
        if (direction.EqualsIgnore(up, 0.001))
            this.Identity();
        else if (direction.EqualsIgnore(up.MulAppendF(-1), 0.001))
            this.RotationAxis(dMath.dPI, new dVector3(up.y, up.z, up.x));
        else {
            up.MulAppendF(-1);
            var from = up;
            var to = direction;
            var c = from.Dot(to);
            var f = (c < 0 ? -c : c);
            var mat = new dMatrix().ToArray();
            if (1.0 - f < 0.0000001) {
                var x = new dVector3(0, 0, 0);
                if (dMath.Abs(from.x) < dMath.Abs(from.y)) {
                    if (dMath.Abs(from.x) < dMath.Abs(from.z))
                        x.x = 1;
                    else
                        x.z = 1;
                }
                else {
                    if (dMath.Abs(from.y) < dMath.Abs(from.z))
                        x.y = 1;
                    else
                        x.z = 1;
                }
                var u = x.Sub(from);
                var v = x.Sub(to);
                var c1 = 2 / u.Dot(u);
                var c2 = 2 / v.Dot(v);
                var c3 = c1 * c2 * u.Dot(v);
                for (var i = 0; i < 3; i++) {
                    for (var j = 0; j < 3; j++) {
                        mat[i * 4 + j] = c3 * v.GetAt(i) * u.GetAt(j)
                            - c2 * v.GetAt(i) * v.GetAt(j)
                            - c1 * u.GetAt(i) * u.GetAt(j);
                    }
                    mat[i * 4 + i] += 1;
                }
            }
            else {
                var v = from.Cross(to);
                var h = 1 / (1 + c);
                var hvx = h * v.x;
                var hvz = h * v.z;
                var hvxy = hvx * v.y;
                var hvxz = hvx * v.z;
                var hvyz = hvz * v.y;
                mat[0] = c + hvx * v.x;
                mat[1] = hvxy + v.z;
                mat[2] = hvxz - v.y;
                mat[4] = hvxy - v.z;
                mat[5] = c + h * v.y * v.y;
                mat[6] = hvyz + v.x;
                mat[8] = hvxz + v.y;
                mat[9] = hvyz - v.x;
                mat[10] = c + hvz * v.z;
            }
            this.FromArray(mat);
        }
        return this;
    };
    dMatrix.prototype.FromQuaternion = function (q) {
        if (q.x == 0 && q.y == 0 && q.z == 0 && q.w == 1) {
            this.Identity();
            return this;
        }
        var a = this;
        var xx, yy, zz, xy, wz, xz, wy, yz, wx;
        xx = q.x * q.x;
        yy = q.y * q.y;
        zz = q.z * q.z;
        a._11 = (1.0 - 2.0 * (yy + zz));
        a._22 = (1.0 - 2.0 * (zz + xx));
        a._33 = (1.0 - 2.0 * (xx + yy));
        xy = q.x * q.y;
        wz = q.w * q.z;
        a._21 = 2.0 * (xy - wz);
        a._12 = 2.0 * (xy + wz);
        xz = q.x * q.z;
        wy = q.w * q.y;
        a._31 = 2.0 * (xz + wy);
        a._13 = 2.0 * (xz - wy);
        yz = q.y * q.z;
        wx = q.w * q.x;
        a._32 = 2.0 * (yz - wx);
        a._23 = 2.0 * (yz + wx);
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = 0.0;
        a._44 = 1.0;
        a._14 = 0.0;
        a._24 = 0.0;
        a._34 = 0.0;
        return this;
    };
    dMatrix.prototype.ToQuaternion = function () {
        var a = this;
        if (dMath.FloatEquals(a._11, 0) && dMath.FloatEquals(a._22, 0) && dMath.FloatEquals(a._33, 0) &&
            dMath.FloatEquals(a._21, 0) && dMath.FloatEquals(a._22, 0) && dMath.FloatEquals(a._23, 0) &&
            dMath.FloatEquals(a._31, 0) && dMath.FloatEquals(a._32, 0) && dMath.FloatEquals(a._33, 0))
            return new dVector4(0, 0, 0, 1);
        var q = new dVector4();
        var tr, s;
        tr = a._11 + a._22 + a._33;
        if (tr >= 0) {
            q.w = dMath.Sqrt(tr + 1.0) * 0.5;
            s = 0.25 / q.w;
            q.x = (a._23 - a._32) * s;
            q.y = (a._31 - a._13) * s;
            q.z = (a._12 - a._21) * s;
            return q;
        }
        else {
            if (a._11 > a._22 && a._11 > a._33) {
                q.x = dMath.Sqrt(a._11 - (a._22 + a._33) + 1.0) * 0.5;
                s = 0.25 / q.x;
                q.y = (a._12 + a._21) * s;
                q.z = (a._13 + a._31) * s;
                q.w = (a._32 - a._23) * s;
            }
            else if (a._22 > a._11 && a._22 > a._33) {
                q.y = dMath.Sqrt(a._22 - (a._33 + a._11) + 1.0) * 0.5;
                s = 0.25 / q.y;
                q.z = (a._23 + a._32) * s;
                q.x = (a._21 + a._12) * s;
                q.w = (a._13 - a._31) * s;
            }
            else {
                q.z = dMath.Sqrt(a._33 - (a._11 + a._22) + 1.0) * 0.5;
                s = 0.25 / q.z;
                q.x = (a._31 + a._13) * s;
                q.y = (a._32 + a._23) * s;
                q.w = (a._21 - a._12) * s;
            }
        }
        q.w = -q.w;
        if (q.x < 0.0 && q.y < 0.0 && q.z < 0.0) {
            q.x = -q.x;
            q.y = -q.y;
            q.z = -q.z;
            q.w = -q.w;
        }
        return q;
    };
    dMatrix.prototype.Determinant = function () {
        var p = this;
        var a = p._22 * (p._33 * p._44 - p._43 * p._34) - p._23 * (p._32 * p._44 - p._34 * p._42) + p._24 * (p._32 * p._43 - p._33 * p._42);
        var b = p._21 * (p._33 * p._44 - p._34 * p._43) - p._23 * (p._31 * p._44 - p._34 * p._41) + p._24 * (p._31 * p._43 - p._33 * p._41);
        var c = p._21 * (p._32 * p._44 - p._34 * p._42) - p._22 * (p._31 * p._44 - p._34 * p._41) + p._24 * (p._31 * p._42 - p._32 * p._41);
        var d = p._21 * (p._32 * p._43 - p._33 * p._42) - p._22 * (p._31 * p._43 - p._33 * p._41) + p._23 * (p._31 * p._42 - p._32 * p._41);
        return p._11 * a - p._12 * b + p._13 * c - p._14 * d;
    };
    dMatrix.prototype.Inverse = function () {
        var a = this;
        if (dMath.FloatEquals(a._11, 0) && dMath.FloatEquals(a._12, 0) && dMath.FloatEquals(a._13, 0) &&
            dMath.FloatEquals(a._21, 0) && dMath.FloatEquals(a._22, 0) && dMath.FloatEquals(a._23, 0) &&
            dMath.FloatEquals(a._31, 0) && dMath.FloatEquals(a._32, 0) && dMath.FloatEquals(a._33, 0)) {
            a._11 = a._12 = a._13 = a._14 = 0;
            a._21 = a._22 = a._23 = a._24 = 0;
            a._31 = a._32 = a._33 = a._34 = 0;
            a._41 = a._42 = a._43 = 0;
            a._44 = 1;
            return this;
        }
        var d = this.Determinant();
        if (d == 0.0)
            d = 1.0;
        d = 1.0 / d;
        var m = new dMatrix();
        m._11 = (a._22 * (a._33 * a._44 - a._43 * a._34) - a._23 * (a._32 * a._44 - a._34 * a._42) + a._24 * (a._32 * a._43 - a._33 * a._42)) * d;
        m._21 = -(a._21 * (a._33 * a._44 - a._34 * a._43) - a._23 * (a._31 * a._44 - a._34 * a._41) + a._24 * (a._31 * a._43 - a._33 * a._41)) * d;
        m._31 = (a._21 * (a._32 * a._44 - a._34 * a._42) - a._22 * (a._31 * a._44 - a._34 * a._41) + a._24 * (a._31 * a._42 - a._32 * a._41)) * d;
        m._41 = -(a._21 * (a._32 * a._43 - a._33 * a._42) - a._22 * (a._31 * a._43 - a._33 * a._41) + a._23 * (a._31 * a._42 - a._32 * a._41)) * d;
        m._12 = -(a._12 * (a._33 * a._44 - a._43 * a._34) - a._32 * (a._13 * a._44 - a._43 * a._14) + a._42 * (a._13 * a._34 - a._33 * a._14)) * d;
        m._22 = (a._11 * (a._33 * a._44 - a._43 * a._34) - a._31 * (a._13 * a._44 - a._43 * a._14) + a._41 * (a._13 * a._34 - a._33 * a._14)) * d;
        m._32 = -(a._11 * (a._32 * a._44 - a._42 * a._34) - a._31 * (a._12 * a._44 - a._42 * a._14) + a._41 * (a._12 * a._34 - a._32 * a._14)) * d;
        m._42 = (a._11 * (a._32 * a._43 - a._42 * a._33) - a._31 * (a._12 * a._43 - a._42 * a._13) + a._41 * (a._12 * a._33 - a._32 * a._13)) * d;
        m._13 = (a._12 * (a._23 * a._44 - a._43 * a._24) - a._22 * (a._13 * a._44 - a._43 * a._14) + a._42 * (a._13 * a._24 - a._23 * a._14)) * d;
        m._23 = -(a._11 * (a._23 * a._44 - a._43 * a._24) - a._21 * (a._13 * a._44 - a._43 * a._14) + a._41 * (a._13 * a._24 - a._23 * a._14)) * d;
        m._33 = (a._11 * (a._22 * a._44 - a._42 * a._24) - a._21 * (a._12 * a._44 - a._42 * a._14) + a._41 * (a._12 * a._24 - a._22 * a._14)) * d;
        m._43 = -(a._11 * (a._22 * a._43 - a._42 * a._23) - a._21 * (a._12 * a._43 - a._42 * a._13) + a._41 * (a._12 * a._23 - a._22 * a._13)) * d;
        m._14 = -(a._12 * (a._23 * a._34 - a._33 * a._24) - a._22 * (a._13 * a._34 - a._33 * a._14) + a._32 * (a._13 * a._24 - a._23 * a._14)) * d;
        m._24 = (a._11 * (a._23 * a._34 - a._33 * a._24) - a._21 * (a._13 * a._34 - a._33 * a._14) + a._31 * (a._13 * a._24 - a._23 * a._14)) * d;
        m._34 = -(a._11 * (a._22 * a._34 - a._32 * a._24) - a._21 * (a._12 * a._34 - a._32 * a._14) + a._31 * (a._12 * a._24 - a._22 * a._14)) * d;
        m._44 = (a._11 * (a._22 * a._33 - a._32 * a._23) - a._21 * (a._12 * a._33 - a._32 * a._13) + a._31 * (a._12 * a._23 - a._22 * a._13)) * d;
        this.Copy(m);
        return this;
    };
    dMatrix.prototype.InverseToNewMatrix = function () {
        var ret = new dMatrix();
        ret.Copy(this);
        ret.Inverse();
        return ret;
    };
    dMatrix.prototype.PerspectiveFovLH = function (fovy, Aspect, zn, zf) {
        var a = this;
        var yScale = 1.0 / dMath.Tan(fovy / 2.0);
        var xScale = yScale / Aspect;
        a._11 = xScale;
        a._12 = 0.0;
        a._13 = 0.0;
        a._14 = 0.0;
        a._21 = 0.0;
        a._22 = yScale;
        a._23 = 0.0;
        a._24 = 0.0;
        a._31 = 0.0;
        a._32 = 0.0;
        a._33 = zf / (zf - zn);
        a._34 = 1.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = -zn * zf / (zf - zn);
        a._44 = 0.0;
        return this;
    };
    dMatrix.prototype.PerspectiveFovRH = function (fovy, Aspect, zn, zf) {
        var a = this;
        var yScale = 1.0 / dMath.Tan(fovy / 2.0);
        var xScale = yScale / Aspect;
        a._11 = xScale;
        a._12 = 0.0;
        a._13 = 0.0;
        a._14 = 0.0;
        a._21 = 0.0;
        a._22 = yScale;
        a._23 = 0.0;
        a._24 = 0.0;
        a._31 = 0.0;
        a._32 = 0.0;
        a._33 = zf / (zn - zf);
        a._34 = -1.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = zn * zf / (zn - zf);
        a._44 = 0.0;
        return this;
    };
    dMatrix.prototype.OrthoLH = function (w, h, zn, zf) {
        var a = this;
        a._11 = 2.0 / w;
        a._12 = 0.0;
        a._13 = 0.0;
        a._14 = 0.0;
        a._21 = 0.0;
        a._22 = 2.0 / h;
        a._23 = 0.0;
        a._24 = 0.0;
        a._31 = 0.0;
        a._32 = 0.0;
        a._33 = 1.0 / (zf - zn);
        a._34 = 0.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = zn / (zn - zf);
        a._44 = 1.0;
        return this;
    };
    dMatrix.prototype.OrthoRH = function (w, h, zn, zf) {
        var a = this;
        a._11 = 2.0 / w;
        a._12 = 0.0;
        a._13 = 0.0;
        a._14 = 0.0;
        a._21 = 0.0;
        a._22 = 2.0 / h;
        a._23 = 0.0;
        a._24 = 0.0;
        a._31 = 0.0;
        a._32 = 0.0;
        a._33 = 1.0 / (zn - zf);
        a._34 = 0.0;
        a._41 = 0.0;
        a._42 = 0.0;
        a._43 = zn / (zn - zf);
        a._44 = 1.0;
        return this;
    };
    dMatrix.prototype.MatrixLookAtLH = function (vEye, vLookat, vUp) {
        var a = this;
        var zaxis = vLookat.Sub(vEye);
        zaxis.Normalize();
        var xaxis = vUp.Cross(zaxis);
        xaxis.Normalize();
        var yaxis = zaxis.Cross(xaxis);
        a._11 = xaxis.x;
        a._12 = yaxis.x;
        a._13 = zaxis.x;
        a._14 = 0.0;
        a._21 = xaxis.y;
        a._22 = yaxis.y;
        a._23 = zaxis.y;
        a._24 = 0.0;
        a._31 = xaxis.z;
        a._32 = yaxis.z;
        a._33 = zaxis.z;
        a._34 = 0.0;
        a._41 = -xaxis.Dot(vEye);
        a._42 = -yaxis.Dot(vEye);
        a._43 = -zaxis.Dot(vEye);
        a._44 = 1.0;
    };
    dMatrix.prototype.MatrixLookAtRH = function (vEye, vLookat, vUp) {
        var a = this;
        var zaxis = vEye.Sub(vLookat);
        zaxis.Normalize();
        var xaxis = vUp.Cross(zaxis);
        xaxis.Normalize();
        var yaxis = zaxis.Cross(xaxis);
        a._11 = xaxis.x;
        a._12 = yaxis.x;
        a._13 = zaxis.x;
        a._14 = 0.0;
        a._21 = xaxis.y;
        a._22 = yaxis.y;
        a._23 = zaxis.y;
        a._24 = 0.0;
        a._31 = xaxis.z;
        a._32 = yaxis.z;
        a._33 = zaxis.z;
        a._34 = 0.0;
        a._41 = -xaxis.Dot(vEye);
        a._42 = -yaxis.Dot(vEye);
        a._43 = -zaxis.Dot(vEye);
        a._44 = 1.0;
    };
    dMatrix.prototype.ReadFromBin = function (data) {
        var a = this;
        a._11 = data.ReadFloat();
        a._12 = data.ReadFloat();
        a._13 = data.ReadFloat();
        a._14 = data.ReadFloat();
        a._21 = data.ReadFloat();
        a._22 = data.ReadFloat();
        a._23 = data.ReadFloat();
        a._24 = data.ReadFloat();
        a._31 = data.ReadFloat();
        a._32 = data.ReadFloat();
        a._33 = data.ReadFloat();
        a._34 = data.ReadFloat();
        a._41 = data.ReadFloat();
        a._42 = data.ReadFloat();
        a._43 = data.ReadFloat();
        a._44 = data.ReadFloat();
        return this;
    };
    dMatrix.prototype.WriteToBin = function (data) {
        var a = this;
        data.WriteFloat(a._11);
        data.WriteFloat(a._12);
        data.WriteFloat(a._13);
        data.WriteFloat(a._14);
        data.WriteFloat(a._21);
        data.WriteFloat(a._22);
        data.WriteFloat(a._23);
        data.WriteFloat(a._24);
        data.WriteFloat(a._31);
        data.WriteFloat(a._32);
        data.WriteFloat(a._33);
        data.WriteFloat(a._34);
        data.WriteFloat(a._41);
        data.WriteFloat(a._42);
        data.WriteFloat(a._43);
        data.WriteFloat(a._44);
        return this;
    };
    dMatrix.prototype.GetAt = function (at) {
        switch (at) {
            case 0: return this._11;
            case 1: return this._12;
            case 2: return this._13;
            case 3: return this._14;
            case 4: return this._21;
            case 5: return this._22;
            case 6: return this._23;
            case 7: return this._24;
            case 8: return this._31;
            case 9: return this._32;
            case 10: return this._33;
            case 11: return this._34;
            case 12: return this._41;
            case 13: return this._42;
            case 14: return this._43;
            case 15: return this._44;
        }
        return 0;
    };
    dMatrix.prototype.toRow = function (bTranspose) {
        if (bTranspose === void 0) { bTranspose = false; }
        var a = this;
        var b = dMatrix.s_pRowBuffer;
        if (bTranspose) {
            b[0] = a._11;
            b[1] = a._21;
            b[2] = a._31;
            b[3] = a._41;
            b[4] = a._12;
            b[5] = a._22;
            b[6] = a._32;
            b[7] = a._42;
            b[8] = a._13;
            b[9] = a._23;
            b[10] = a._33;
            b[11] = a._43;
            b[12] = a._14;
            b[13] = a._24;
            b[14] = a._34;
            b[15] = a._44;
        }
        else {
            b[0] = a._11;
            b[1] = a._12;
            b[2] = a._13;
            b[3] = a._14;
            b[4] = a._21;
            b[5] = a._22;
            b[6] = a._23;
            b[7] = a._24;
            b[8] = a._31;
            b[9] = a._32;
            b[10] = a._33;
            b[11] = a._34;
            b[12] = a._41;
            b[13] = a._42;
            b[14] = a._43;
            b[15] = a._44;
        }
        return b;
    };
    dMatrix.prototype.Transpose = function () {
        var a = this;
        var m = new dMatrix();
        m._11 = a._11;
        m._12 = a._21;
        m._13 = a._31;
        m._14 = a._41;
        m._21 = a._12;
        m._22 = a._22;
        m._23 = a._32;
        m._24 = a._42;
        m._31 = a._13;
        m._32 = a._23;
        m._33 = a._33;
        m._34 = a._43;
        m._41 = a._14;
        m._42 = a._24;
        m._43 = a._34;
        m._44 = a._44;
        return m;
    };
    dMatrix.prototype.TransposeAppend = function () {
        var a = this;
        var t_12 = a._12;
        var t_13 = a._13;
        var t_14 = a._14;
        var t_21 = a._21;
        var t_23 = a._23;
        var t_24 = a._24;
        var t_31 = a._31;
        var t_32 = a._32;
        var t_34 = a._34;
        var t_41 = a._41;
        var t_42 = a._42;
        var t_43 = a._43;
        a._12 = t_21;
        a._13 = t_31;
        a._14 = t_41;
        a._21 = t_12;
        a._23 = t_32;
        a._24 = t_42;
        a._31 = t_13;
        a._32 = t_23;
        a._34 = t_43;
        a._41 = t_14;
        a._42 = t_24;
        a._43 = t_34;
        return this;
    };
    dMatrix.prototype.TransformFloatArray3 = function (buffer, startIndex) {
        var a = this;
        var x = buffer[startIndex];
        var y = buffer[startIndex + 1];
        var z = buffer[startIndex + 2];
        var _x = x * a._11 + y * a._21 + z * a._31 + a._41;
        var _y = x * a._12 + y * a._22 + z * a._32 + a._42;
        var _z = x * a._13 + y * a._23 + z * a._33 + a._43;
        var _w = x * a._14 + y * a._24 + z * a._34 + a._44;
        if (_w != 0.0) {
            buffer[startIndex] = _x / _w;
            buffer[startIndex + 1] = _y / _w;
            buffer[startIndex + 2] = _z / _w;
        }
        else {
            buffer[startIndex] = _x;
            buffer[startIndex + 1] = _y;
            buffer[startIndex + 2] = _z;
        }
        return this;
    };
    dMatrix.prototype.ToArray = function (buffer) {
        if (buffer === void 0) { buffer = null; }
        var a = this;
        if (buffer == null)
            buffer = dMatrix.s_pMatrixForToArray;
        buffer[0] = a._11;
        buffer[1] = a._12;
        buffer[2] = a._13;
        buffer[3] = a._14;
        buffer[4] = a._21;
        buffer[5] = a._22;
        buffer[6] = a._23;
        buffer[7] = a._24;
        buffer[8] = a._31;
        buffer[9] = a._32;
        buffer[10] = a._33;
        buffer[11] = a._34;
        buffer[12] = a._41;
        buffer[13] = a._42;
        buffer[14] = a._43;
        buffer[15] = a._44;
        return buffer;
    };
    dMatrix.prototype.FromArray = function (arr) {
        var a = this;
        a._11 = arr[0];
        a._12 = arr[1];
        a._13 = arr[2];
        a._14 = arr[3];
        a._21 = arr[4];
        a._22 = arr[5];
        a._23 = arr[6];
        a._24 = arr[7];
        a._31 = arr[8];
        a._32 = arr[9];
        a._33 = arr[10];
        a._34 = arr[11];
        a._41 = arr[12];
        a._42 = arr[13];
        a._43 = arr[14];
        a._44 = arr[15];
        return this;
    };
    dMatrix.prototype.FromArray3x3 = function (arr) {
        var a = this;
        a._11 = arr[0];
        a._12 = arr[1];
        a._13 = arr[2];
        a._14 = 0;
        a._21 = arr[3];
        a._22 = arr[4];
        a._23 = arr[5];
        a._24 = 0;
        a._31 = arr[6];
        a._32 = arr[7];
        a._33 = arr[8];
        a._34 = 0;
        a._41 = 0;
        a._42 = 0;
        a._43 = 0;
        a._44 = 1;
        return this;
    };
    dMatrix.s_pMatrixForAppend = new dMatrix();
    dMatrix.s_pMatrixForToArray = new Array(16);
    dMatrix.s_mulAppendTemp = new dMatrix();
    dMatrix.IDENTITY = new dMatrix();
    dMatrix.s_pRowBuffer = new Array(16);
    return dMatrix;
}(dObject));
var dMeshData = (function (_super) {
    __extends(dMeshData, _super);
    function dMeshData() {
        var _this = _super.call(this) || this;
        _this.m_verticesData = null;
        _this.m_verticesDataFloat = null;
        _this.m_indices = null;
        _this.m_vertexTypeList = null;
        _this.m_nVertexCount = 0;
        _this.m_nIndicesCount = 0;
        _this.vb = null;
        _this.ib = null;
        _this.m_vecDecl = null;
        _this.m_nTriNumber = 0;
        _this.m_nAccessWriteFlag = 0;
        return _this;
    }
    dMeshData.prototype.Release = function () {
        if (this.vb) {
            dInterface.ptr.webgl.deleteBuffer(this.vb);
            this.vb = null;
        }
        if (this.ib) {
            dInterface.ptr.webgl.deleteBuffer(this.ib);
            this.ib = null;
        }
        this.m_vecDecl = null;
    };
    dMeshData.prototype.GetVertexDataVector3 = function (vertexType, at) {
        this.m_verticesData.SetPosition(at * this.GetVertexStrideInByte());
        for (var i = 0; i < this.m_vertexTypeList.length; i++) {
            var type = this.m_vertexTypeList[i];
            if (type == vertexType) {
                var ret = new dVector3();
                ret.x = this.m_verticesData.ReadFloat();
                ret.y = this.m_verticesData.ReadFloat();
                ret.z = this.m_verticesData.ReadFloat();
                return ret;
            }
            else
                this.m_verticesData.Skip(this.GetStrideInByte(type));
        }
        return null;
    };
    dMeshData.prototype.SetVertexDataVector3 = function (vertexType, at, value) {
        this.m_verticesData.SetPosition(at * this.GetVertexStrideInByte());
        for (var i = 0; i < this.m_vertexTypeList.length; i++) {
            var type = this.m_vertexTypeList[i];
            if (type == vertexType) {
                this.m_verticesData.WriteFloat(value.x);
                this.m_verticesData.WriteFloat(value.y);
                this.m_verticesData.WriteFloat(value.z);
                return;
            }
            else
                this.m_verticesData.Skip(this.GetStrideInByte(type));
        }
    };
    dMeshData.prototype.GetVertexDataVector4 = function (vertexType, at) {
        this.m_verticesData.SetPosition(at * this.GetVertexStrideInByte());
        for (var i = 0; i < this.m_vertexTypeList.length; i++) {
            var type = this.m_vertexTypeList[i];
            if (type == vertexType) {
                var ret = new dVector4();
                ret.x = this.m_verticesData.ReadFloat();
                ret.y = this.m_verticesData.ReadFloat();
                ret.z = this.m_verticesData.ReadFloat();
                ret.w = this.m_verticesData.ReadFloat();
                return ret;
            }
            else
                this.m_verticesData.Skip(this.GetStrideInByte(type));
        }
        return null;
    };
    dMeshData.prototype.SetVertexDataVector4 = function (vertexType, at, value) {
        this.m_verticesData.SetPosition(at * this.GetVertexStrideInByte());
        for (var i = 0; i < this.m_vertexTypeList.length; i++) {
            var type = this.m_vertexTypeList[i];
            if (type == vertexType) {
                this.m_verticesData.WriteFloat(value.x);
                this.m_verticesData.WriteFloat(value.y);
                this.m_verticesData.WriteFloat(value.z);
                this.m_verticesData.WriteFloat(value.w);
                return;
            }
            else
                this.m_verticesData.Skip(this.GetStrideInByte(type));
        }
    };
    dMeshData.prototype.GetVertexDataInt = function (vertexType, at) {
        this.m_verticesData.SetPosition(at * this.GetVertexStrideInByte());
        for (var i = 0; i < this.m_vertexTypeList.length; i++) {
            var type = this.m_vertexTypeList[i];
            if (type == vertexType) {
                var ret = this.m_verticesData.ReadInt();
                return ret;
            }
            else
                this.m_verticesData.Skip(this.GetStrideInByte(type));
        }
        return 0;
    };
    dMeshData.prototype.SetVertexDataInt = function (vertexType, at, value) {
        this.m_verticesData.SetPosition(at * this.GetVertexStrideInByte());
        for (var i = 0; i < this.m_vertexTypeList.length; i++) {
            var type = this.m_vertexTypeList[i];
            if (type == vertexType) {
                this.m_verticesData.WriteInt(value);
                return;
            }
            else
                this.m_verticesData.Skip(this.GetStrideInByte(type));
        }
    };
    dMeshData.prototype.SetData = function (vertices, vertexCount, indices, vertexTypeList, AccessWriteFlag, verticesFloat, indexCount) {
        if (AccessWriteFlag === void 0) { AccessWriteFlag = dMeshData.ACCESS_WRITE_TYPE_STATIC_DRAW; }
        if (verticesFloat === void 0) { verticesFloat = null; }
        if (indexCount === void 0) { indexCount = 0; }
        this.m_verticesData = vertices;
        this.m_indices = indices;
        this.m_verticesDataFloat = verticesFloat;
        this.m_nVertexCount = vertexCount;
        this.m_vertexTypeList = vertexTypeList;
        this.m_nAccessWriteFlag = AccessWriteFlag;
        if (indexCount == 0)
            indexCount = indices.length;
        this.m_nIndicesCount = indexCount;
        this.UpdateData();
    };
    dMeshData.prototype.UpdateData = function () {
        if (this.m_verticesData != null)
            this.m_verticesData.SetPosition(0);
        this._SetData(this.m_verticesData == null ? null : this.m_verticesData, this.m_nVertexCount, this.m_indices, this.m_vertexTypeList, this.m_verticesDataFloat, this.m_nIndicesCount);
        if (this.m_verticesData != null)
            this.m_verticesData.SetPosition(0);
    };
    dMeshData.prototype._SetData = function (verticesByteArray, vertexCount, indices, vertexTypeList, verticesDataFloat, nIndicesCount) {
        if (vertexCount == 0)
            return;
        var webgl = dInterface.ptr.webgl;
        if (!webgl)
            return;
        var drawType = webgl.STATIC_DRAW;
        if (this.m_nAccessWriteFlag == dMeshData.ACCESS_WRITE_TYPE_STATIC_DRAW)
            drawType = webgl.STATIC_DRAW;
        else if (this.m_nAccessWriteFlag == dMeshData.ACCESS_WRITE_TYPE_STREAM_DRAW)
            drawType = webgl.STREAM_DRAW;
        else if (this.m_nAccessWriteFlag == dMeshData.ACCESS_WRITE_TYPE_DYNAMIC_DRAW)
            drawType = webgl.DYNAMIC_DRAW;
        if (!this.vb)
            this.vb = webgl.createBuffer();
        webgl.bindBuffer(webgl.ARRAY_BUFFER, this.vb);
        var stride = 0;
        for (var i = 0, n = vertexTypeList.length; i < n; i++) {
            stride += this.GetStrideInByte(vertexTypeList[i]);
        }
        if (verticesDataFloat) {
            if (vertexCount * stride / 4 != verticesDataFloat.length)
                verticesDataFloat = verticesDataFloat.slice(0, vertexCount * stride / 4);
            webgl.bufferData(webgl.ARRAY_BUFFER, new Float32Array(verticesDataFloat), drawType);
        }
        else
            webgl.bufferData(webgl.ARRAY_BUFFER, verticesByteArray.m_pArraybuffer, drawType);
        webgl.bindBuffer(webgl.ARRAY_BUFFER, null);
        if (!this.ib)
            this.ib = webgl.createBuffer();
        webgl.bindBuffer(webgl.ELEMENT_ARRAY_BUFFER, this.ib);
        webgl.bufferData(webgl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), drawType);
        webgl.bindBuffer(webgl.ELEMENT_ARRAY_BUFFER, null);
        this.m_nTriNumber = nIndicesCount ? nIndicesCount : indices.length;
        if (!this.m_vecDecl) {
            this.m_vecDecl = new Array(vertexTypeList.length);
            var offset = 0;
            for (var i = 0; i < vertexTypeList.length; i++) {
                var decl = new __dVertexDecl();
                switch (vertexTypeList[i] & 0xFF) {
                    case dMeshData.Vertex_Type_Float1:
                        decl.dataNum = 1;
                        decl.nSizePerVertex = 4;
                        decl.nDataType = webgl.FLOAT;
                        decl.nStartOffset = offset;
                        break;
                    case dMeshData.Vertex_Type_Float2:
                        decl.dataNum = 2;
                        decl.nSizePerVertex = 4 * 2;
                        decl.nDataType = webgl.FLOAT;
                        decl.nStartOffset = offset;
                        break;
                    case dMeshData.Vertex_Type_Float3:
                        decl.dataNum = 3;
                        decl.nSizePerVertex = 4 * 3;
                        decl.nDataType = webgl.FLOAT;
                        decl.nStartOffset = offset;
                        break;
                    case dMeshData.Vertex_Type_Float4:
                        decl.dataNum = 4;
                        decl.nSizePerVertex = 4 * 4;
                        decl.nDataType = webgl.FLOAT;
                        decl.nStartOffset = offset;
                        break;
                    case dMeshData.Vertex_Type_Byte4:
                        decl.dataNum = 4;
                        decl.nSizePerVertex = 4;
                        decl.nDataType = webgl.UNSIGNED_BYTE;
                        decl.nStartOffset = offset;
                        break;
                    case dMeshData.Vertex_Type_Color:
                        decl.dataNum = 4;
                        decl.nSizePerVertex = 4;
                        decl.nDataType = webgl.UNSIGNED_BYTE;
                        decl.nStartOffset = offset;
                        decl.bNormalized = true;
                        break;
                }
                this.m_vecDecl[i] = decl;
                offset += decl.nSizePerVertex;
            }
            for (var i = 0; i < this.m_vecDecl.length; i++)
                this.m_vecDecl[i].nStrideInBytePerVertex = offset;
        }
    };
    dMeshData.prototype.ComputeVertexUnIndexed = function () {
        var arr = new dByteArray();
        arr.SetEndian(dMeshData.GetMeshDataEndian());
        this.m_verticesData.SetPosition(0);
        var stride = this.GetVertexStrideInByte();
        var vertices = new Array(this.m_nVertexCount);
        for (var i = 0; i < this.m_nVertexCount; i++) {
            vertices[i] = this.m_verticesData.ReadBinEx(stride);
        }
        for (var i = 0; i < this.m_nIndicesCount; i++) {
            var index = this.m_indices[i];
            arr.WriteBinEx(vertices[index], vertices[index].Size());
        }
        arr.SetPosition(0);
        this.m_verticesData = arr;
        this.m_nVertexCount = this.m_nIndicesCount;
        for (var i = 0; i < this.m_nIndicesCount; i++)
            this.m_indices[i] = i;
        this.UpdateData();
    };
    dMeshData.prototype.ComputeVertexIndexed = function () {
        var arr = new dByteArray();
        arr.SetEndian(dMeshData.GetMeshDataEndian());
        var vertexCount = 0;
        var newIndices = new Array(this.m_nIndicesCount);
        var stride = this.GetVertexStrideInByte();
        var arrVertexHash = new Map();
        var oldVertices = new Array(this.m_nVertexCount);
        var oldVerticesHash = new Array(this.m_nVertexCount);
        this.m_verticesData.SetPosition(0);
        for (var i = 0; i < this.m_nVertexCount; i++) {
            oldVertices[i] = this.m_verticesData.ReadBinEx(stride);
            oldVerticesHash[i] = oldVertices[i].ToBinString();
        }
        var k = 0;
        for (var i = 0; i < this.m_nIndicesCount; i++) {
            var v = oldVertices[this.m_indices[i]];
            var hash = oldVerticesHash[this.m_indices[i]];
            if (arrVertexHash.has(hash)) {
                newIndices[k++] = arrVertexHash.get(hash);
            }
            else {
                var size = arrVertexHash.size;
                newIndices[k++] = size;
                arrVertexHash.set(hash, size);
                arr.WriteBinEx(v, v.Size());
                vertexCount++;
            }
        }
        arr.SetPosition(0);
        this.m_verticesData = arr;
        this.m_nVertexCount = vertexCount;
        this.m_indices = newIndices;
        this.UpdateData();
    };
    dMeshData.GetMeshDataEndian = function () {
        return dByteArray.LITTLE_ENDIAN;
    };
    dMeshData.prototype.GetVerticesData = function () {
        return this.m_verticesData;
    };
    dMeshData.prototype.GetVerticesDataFloat = function () {
        return this.m_verticesDataFloat;
    };
    dMeshData.prototype.GetVertexCount = function () {
        return this.m_nVertexCount;
    };
    dMeshData.prototype.GetIndicesData = function () {
        return this.m_indices;
    };
    dMeshData.prototype.GetVertexTypeList = function () {
        return this.m_vertexTypeList;
    };
    dMeshData.prototype.GetStrideInByte = function (type) {
        switch (type & 0xFF) {
            case dMeshData.Vertex_Type_Float1:
                return 4;
            case dMeshData.Vertex_Type_Float2:
                return 8;
            case dMeshData.Vertex_Type_Float3:
                return 12;
            case dMeshData.Vertex_Type_Float4:
                return 16;
            case dMeshData.Vertex_Type_Byte4:
                return 4;
            case dMeshData.Vertex_Type_Color:
                return 4;
        }
        return 0;
    };
    dMeshData.prototype.GetVertexStrideInByte = function () {
        var ret = 0;
        for (var i = 0; i < this.m_vertexTypeList.length; i++) {
            ret += this.GetStrideInByte(this.m_vertexTypeList[i]);
        }
        return ret;
    };
    dMeshData.prototype._Draw = function (pShader) {
        if (this.m_vecDecl == null || pShader.m_vecAttributeList.length != this.m_vecDecl.length)
            return;
        var webgl = dInterface.ptr.webgl;
        webgl.bindBuffer(webgl.ARRAY_BUFFER, this.vb);
        for (var i = 0; i < pShader.m_vecAttributeList.length; i++)
            webgl.vertexAttribPointer(pShader.m_vecAttributeList[i], this.m_vecDecl[i].dataNum, this.m_vecDecl[i].nDataType, this.m_vecDecl[i].bNormalized, this.m_vecDecl[i].nStrideInBytePerVertex, this.m_vecDecl[i].nStartOffset);
        webgl.bindBuffer(webgl.ELEMENT_ARRAY_BUFFER, this.ib);
        webgl.drawElements(webgl.TRIANGLES, this.m_nTriNumber, webgl.UNSIGNED_SHORT, 0);
    };
    dMeshData.prototype._UnDraw = function () {
        var webgl = dInterface.ptr.webgl;
        webgl.bindBuffer(webgl.ARRAY_BUFFER, null);
        webgl.bindBuffer(webgl.ELEMENT_ARRAY_BUFFER, null);
    };
    dMeshData.Vertex_Type_Float1 = 1;
    dMeshData.Vertex_Type_Float2 = 2;
    dMeshData.Vertex_Type_Float3 = 3;
    dMeshData.Vertex_Type_Float4 = 4;
    dMeshData.Vertex_Type_Byte4 = 5;
    dMeshData.Vertex_Type_Color = 6;
    dMeshData.Vertex_Type_Pos2 = 0x800 | dMeshData.Vertex_Type_Float2;
    dMeshData.Vertex_Type_Pos3 = 0x100 | dMeshData.Vertex_Type_Float3;
    dMeshData.Vertex_Type_Normal3 = 0x200 | dMeshData.Vertex_Type_Float3;
    dMeshData.Vertex_Type_UV2 = 0x300 | dMeshData.Vertex_Type_Float2;
    dMeshData.Vertex_Type_UV3 = 0x400 | dMeshData.Vertex_Type_Float3;
    dMeshData.Vertex_Type_BoneIndex1 = 0x500 | dMeshData.Vertex_Type_Byte4;
    dMeshData.Vertex_Type_Weights4 = 0x600 | dMeshData.Vertex_Type_Float4;
    dMeshData.Vertex_Type_Color4 = 0x700 | dMeshData.Vertex_Type_Float4;
    dMeshData.ACCESS_WRITE_TYPE_STATIC_DRAW = 0;
    dMeshData.ACCESS_WRITE_TYPE_DYNAMIC_DRAW = 1;
    dMeshData.ACCESS_WRITE_TYPE_STREAM_DRAW = 2;
    return dMeshData;
}(dObject));
var __dVertexDecl = (function () {
    function __dVertexDecl() {
        this.dataNum = 0;
        this.nSizePerVertex = 0;
        this.nDataType = 0;
        this.bNormalized = false;
        this.nStrideInBytePerVertex = 0;
        this.nStartOffset = 0;
    }
    return __dVertexDecl;
}());
var dRect = (function (_super) {
    __extends(dRect, _super);
    function dRect(_left, _top, _right, _bottom) {
        if (_left === void 0) { _left = 0; }
        if (_top === void 0) { _top = 0; }
        if (_right === void 0) { _right = 0; }
        if (_bottom === void 0) { _bottom = 0; }
        var _this = _super.call(this) || this;
        _this.left = _left;
        _this.top = _top;
        _this.right = _right;
        _this.bottom = _bottom;
        return _this;
    }
    dRect.prototype.SetValue = function (_left, _top, _right, _bottom) {
        if (_left === void 0) { _left = 0; }
        if (_top === void 0) { _top = 0; }
        if (_right === void 0) { _right = 0; }
        if (_bottom === void 0) { _bottom = 0; }
        this.left = _left;
        this.top = _top;
        this.right = _right;
        this.bottom = _bottom;
        return this;
    };
    dRect.prototype.SetPosSize = function (_left, _top, width, height) {
        this.left = _left;
        this.top = _top;
        this.right = this.left + width;
        this.bottom = this.top + height;
        return this;
    };
    dRect.prototype.SetCenterSize = function (cx, cy, width, height) {
        this.left = cx - width / 2;
        this.top = cy - height / 2;
        this.right = this.left + width;
        this.bottom = this.top + height;
        return this;
    };
    dRect.prototype.SetWidth = function (width) {
        this.right = this.left + width;
        return this;
    };
    dRect.prototype.SetHeight = function (height) {
        this.bottom = this.top + height;
        return this;
    };
    dRect.prototype.TranslationAppend = function (x, y) {
        this.left += x;
        this.right += x;
        this.top += y;
        this.bottom += y;
        return this;
    };
    dRect.prototype.Copy = function (pFrom) {
        this.left = pFrom.left;
        this.top = pFrom.top;
        this.right = pFrom.right;
        this.bottom = pFrom.bottom;
        return this;
    };
    dRect.prototype.Width = function () {
        return this.right - this.left;
    };
    dRect.prototype.Height = function () {
        return this.bottom - this.top;
    };
    dRect.prototype.Collect = function (r2, collRectOut) {
        if (collRectOut === void 0) { collRectOut = null; }
        if (this.right < r2.left || r2.right < this.left || r2.bottom < this.top || r2.top > this.bottom)
            return false;
        else if (collRectOut) {
            collRectOut.bottom = dMath.Min(r2.bottom, this.bottom);
            collRectOut.top = dMath.Max(this.top, r2.top);
            collRectOut.right = dMath.Min(r2.right, this.right);
            collRectOut.left = dMath.Max(this.left, r2.left);
        }
        return true;
    };
    dRect.prototype.CollectPoint = function (x, y) {
        return this.left <= x && x <= this.right && this.top <= y && y <= this.bottom;
    };
    dRect.prototype.CollectCircle = function (arcOx, arcOy, arcR) {
        var rectX = this.left;
        var rectY = this.top;
        var rectW = this.Width();
        var rectH = this.Height();
        if (((rectX - arcOx) * (rectX - arcOx) + (rectY - arcOy) * (rectY - arcOy)) <= arcR * arcR)
            return true;
        if (((rectX + rectW - arcOx) * (rectX + rectW - arcOx) + (rectY - arcOy) * (rectY - arcOy)) <= arcR * arcR)
            return true;
        if (((rectX - arcOx) * (rectX - arcOx) + (rectY + rectH - arcOy) * (rectY + rectH - arcOy)) <= arcR * arcR)
            return true;
        if (((rectX + rectW - arcOx) * (rectX + rectW - arcOx) + (rectY + rectH - arcOy) * (rectY + rectH - arcOy)) <= arcR * arcR)
            return true;
        var minDisX = 0;
        if (arcOy >= rectY && arcOy <= rectY + rectH) {
            if (arcOx < rectX)
                minDisX = rectX - arcOx;
            else if (arcOx > rectX + rectW)
                minDisX = arcOx - rectX - rectW;
            else
                return true;
            if (minDisX <= arcR)
                return true;
        }
        var minDisY = 0;
        if (arcOx >= rectX && arcOx <= rectX + rectW) {
            if (arcOy < rectY)
                minDisY = rectY - arcOy;
            else if (arcOy > rectY + rectH)
                minDisY = arcOy - rectY - rectH;
            else
                return true;
            if (minDisY <= arcR)
                return true;
        }
        return false;
    };
    dRect.prototype.RowData = function () {
        return [this.left, this.top, this.right, this.bottom];
    };
    dRect.prototype.isZero = function () {
        return this.left == 0 && this.top == 0 && this.right == 0 && this.bottom == 0;
    };
    dRect.prototype.OriginX = function () {
        return this.right - this.left;
    };
    dRect.prototype.OriginY = function () {
        return this.bottom - this.top;
    };
    dRect.prototype.MakeValidSize = function () {
        if (this.left > this.right) {
            var tmp = this.right;
            this.right = this.left;
            this.left = tmp;
        }
        if (this.top > this.bottom) {
            var tmp = this.bottom;
            this.bottom = this.top;
            this.top = tmp;
        }
        return this;
    };
    dRect.prototype.AddAppend = function (rc) {
        this.left += rc.left;
        this.top += rc.top;
        this.right += rc.right;
        this.bottom += rc.bottom;
        return this;
    };
    dRect.prototype.SubAppend = function (rc) {
        this.left -= rc.left;
        this.top -= rc.top;
        this.right -= rc.right;
        this.bottom -= rc.bottom;
        return this;
    };
    dRect.prototype.Equals = function (rc) {
        if (!rc)
            return false;
        return this.left == rc.left && this.top == rc.top && this.right == rc.right && this.bottom == rc.bottom;
    };
    dRect.RectEquals = function (rc1, rc2) {
        if (!rc1 && !rc2)
            return true;
        if (!rc1 || !rc2)
            return false;
        return rc1.Equals(rc2);
    };
    dRect.prototype.GetCenterX = function () {
        return (this.right - this.left) / 2 + this.left;
    };
    dRect.prototype.GetCenterY = function () {
        return (this.bottom - this.top) / 2 + this.top;
    };
    dRect.prototype.GetCenter = function () {
        return new dVector2(this.GetCenterX(), this.GetCenterY());
    };
    dRect.prototype.ToStringBuffer = function (split) {
        if (split === void 0) { split = ","; }
        return this.left + split + this.top + split + this.right + split + this.bottom;
    };
    dRect.prototype.FromString = function (value, split) {
        if (split === void 0) { split = ","; }
        var s = value.split(split);
        this.left = dMath.ParseFloat(s[0]);
        this.top = dMath.ParseFloat(s[1]);
        this.right = dMath.ParseFloat(s[2]);
        this.bottom = dMath.ParseFloat(s[3]);
        return this;
    };
    dRect.prototype.Clip = function (rc) {
        this.left = dMath.Max(this.left, rc.left);
        this.top = dMath.Max(this.top, rc.top);
        this.right = dMath.Min(this.right, rc.right);
        this.bottom = dMath.Min(this.bottom, rc.bottom);
        if (this.right < this.left)
            this.right = this.left;
        if (this.bottom < this.top)
            this.bottom = this.top;
    };
    dRect.prototype.Merge = function (rc) {
        if (this.left > rc.left)
            this.left = rc.left;
        if (this.right < rc.right)
            this.right = rc.right;
        if (this.top > rc.top)
            this.top = rc.top;
        if (this.bottom < rc.bottom)
            this.bottom = rc.bottom;
    };
    dRect.ZERO = new dRect();
    return dRect;
}(dObject));
var dSocket = (function (_super) {
    __extends(dSocket, _super);
    function dSocket() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    dSocket.RequestHttp = function (url, pResponse, method, postData) {
        if (pResponse === void 0) { pResponse = null; }
        if (method === void 0) { method = "get"; }
        if (postData === void 0) { postData = null; }
        dInterface.ptr.RequestHttp(url, pResponse, method, postData);
    };
    return dSocket;
}(dObject));
var dSound = (function (_super) {
    __extends(dSound, _super);
    function dSound() {
        return _super.call(this) || this;
    }
    dSound.PlaySound = function (fileName) {
        if (dSound.s_globalSoundVolume > 0)
            dInterface.ptr.PlayAudio(fileName, 0, false, dSound.s_globalSoundVolume, false);
    };
    dSound.PlayMusic = function (fileName, loop, position, volume) {
        if (loop === void 0) { loop = true; }
        if (position === void 0) { position = 0; }
        if (volume === void 0) { volume = 1; }
        if (dSound.s_strCurMusicFileName == fileName)
            return;
        if (dSound.s_pMusicPlayer)
            dSound.StopMusic();
        dSound.s_strCurMusicFileName = fileName;
        dSound.s_pMusicPlayer = dInterface.ptr.PlayAudio(fileName, position, loop, volume * dSound.s_globalMusicVolume, true);
        dSound.s_pMusicPlayer.m_curVolume = volume;
    };
    dSound.StopMusic = function () {
        dSound.s_strCurMusicFileName = "";
        if (dSound.s_pMusicPlayer) {
            dSound.s_pMusicPlayer.stop();
            dSound.s_pMusicPlayer = null;
        }
    };
    dSound.SetGlobalSoundVolume = function (volume) {
        dSound.s_globalSoundVolume = volume;
    };
    dSound.SetGlobalMusicVolume = function (volume) {
        dSound.s_globalMusicVolume = volume;
        if (dSound.s_pMusicPlayer)
            dSound.s_pMusicPlayer.volume = dSound.s_pMusicPlayer.m_curVolume * dSound.s_globalMusicVolume;
    };
    dSound.s_pMusicPlayer = null;
    dSound.s_globalSoundVolume = 1;
    dSound.s_globalMusicVolume = 1;
    dSound.s_strCurMusicFileName = "";
    return dSound;
}(dObject));
var dStringUtils = (function () {
    function dStringUtils() {
    }
    dStringUtils.NonNull = function (str) {
        if (!str)
            return "";
        return str;
    };
    dStringUtils.SplitFileName = function (strFileName) {
        if (strFileName == null)
            return ["", "", "", ""];
        strFileName = dStringUtils.ReplaceAll(strFileName, "\\", "/");
        var vecDriver = dStringUtils.HalfStringFind(strFileName, ":", -2, false);
        var vecPath = dStringUtils.HalfStringFindLast(vecDriver[1], "/", -1, false);
        var vecFileName = dStringUtils.HalfStringFindLast(vecPath[1], ".", 0, true);
        return [vecDriver[0], vecPath[0], vecFileName[0], vecFileName[1]];
    };
    dStringUtils.HalfStringFind = function (str, find, nFindStringInLeft, bNoFindPushFirst) {
        var left = (nFindStringInLeft < 0) ? -nFindStringInLeft : 0;
        var right = (nFindStringInLeft > 0) ? nFindStringInLeft : 0;
        var ret = str.indexOf(find);
        if (ret != -1)
            return [str.substring(0, ret + left), str.substring(ret + left + right, str.length)];
        else if (bNoFindPushFirst)
            return [str, ""];
        else
            return ["", str];
    };
    dStringUtils.HalfStringFindLast = function (str, find, nFindStringInLeft, bNoFindPushFirst) {
        var left = (nFindStringInLeft < 0) ? -nFindStringInLeft : 0;
        var right = (nFindStringInLeft > 0) ? nFindStringInLeft : 0;
        var ret = str.lastIndexOf(find);
        if (ret != -1)
            return [str.substring(0, ret + left), str.substring(ret + left + right, str.length)];
        else if (bNoFindPushFirst)
            return [str, ""];
        else
            return ["", str];
    };
    dStringUtils.ReplaceAll = function (str, strFind, strReplace) {
        var indexOf;
        while ((indexOf = str.indexOf(strFind)) != -1) {
            str = str.substring(0, indexOf) + strReplace + str.substring(indexOf + strFind.length, str.length);
        }
        return str;
    };
    dStringUtils.FormatInt = function (t, nForceBit) {
        var str = dMath.ToInt(t).toString();
        if (nForceBit > 0) {
            for (var i = str.length; i < nForceBit; i++)
                str = "0" + str;
        }
        return str;
    };
    dStringUtils.FormatNumber = function (f, nAfterDot, erase0) {
        if (erase0 === void 0) { erase0 = false; }
        if (nAfterDot == 0)
            return String(dMath.ToInt(f));
        var str = String(f);
        if (str.indexOf(".") == -1 && !erase0) {
            if (nAfterDot > 0)
                str += ".";
            for (var i = 0; i < nAfterDot; i++)
                str += "0";
            return str;
        }
        var ret = str.substring(0, str.indexOf(".") + nAfterDot + 1);
        if (!erase0) {
            for (var i = ret.length - ret.indexOf("."); i <= nAfterDot; i++)
                ret += "0";
        }
        else {
            while (ret.charCodeAt(ret.length - 1) == '0'.charCodeAt(0))
                ret = ret.substring(0, ret.length - 1);
            if (ret.charCodeAt(ret.length - 1) == '.'.charCodeAt(0))
                ret = ret.substring(0, ret.length - 1);
        }
        return ret;
    };
    dStringUtils.FormatString = function (dst, args) {
        if (args == null)
            return dst;
        var ret = "";
        for (var i = 0, j = 0; i < dst.length; i++) {
            if (dst.charCodeAt(i) != '%'.charCodeAt(0)) {
                ret += dst.charAt(i);
            }
            else if (j < args.length) {
                ret += args[j++];
            }
        }
        return ret;
    };
    dStringUtils.isNullOrEmpty = function (str) {
        return str == undefined || str == null || str == "";
    };
    dStringUtils.FourCC = function (a, b, c, d, nEndian) {
        if (nEndian === void 0) { nEndian = dByteArray.BIG_ENDIAN; }
        var c1 = a.charCodeAt(0);
        var c2 = b.charCodeAt(0);
        var c3 = c.charCodeAt(0);
        var c4 = d.charCodeAt(0);
        if (nEndian == dByteArray.BIG_ENDIAN)
            return (c1 << 24 | c2 << 16 | c3 << 8 | c4);
        else
            return (c4 << 24 | c3 << 16 | c2 << 8 | c1);
        return 0;
    };
    dStringUtils.GetFileNameExt = function (strFileName, bWithDot) {
        if (bWithDot === void 0) { bWithDot = true; }
        if (strFileName.lastIndexOf(".") != -1) {
            return strFileName.substring(strFileName.lastIndexOf(".") + (bWithDot ? 0 : 1), strFileName.length);
        }
        return "";
    };
    dStringUtils.GetFileNamePath = function (strFileName, bWithSlash) {
        if (bWithSlash === void 0) { bWithSlash = false; }
        if (strFileName.indexOf("/") != -1)
            return strFileName.substring(0, strFileName.lastIndexOf("/") + Number(bWithSlash));
        return "";
    };
    dStringUtils.GetFileNameName = function (strFileName, bWithExt) {
        if (bWithExt === void 0) { bWithExt = true; }
        if (strFileName.indexOf("/") != -1)
            strFileName = strFileName.substring(strFileName.lastIndexOf("/") + 1, strFileName.length);
        if (!bWithExt && strFileName.lastIndexOf(".") != -1)
            strFileName = strFileName.substring(0, strFileName.lastIndexOf("."));
        return strFileName;
    };
    dStringUtils.SplitStringEquals = function (strSource, strSplit, bKeyWithoutSpace, bValueWithoutSpace, strEquals) {
        if (strSplit === void 0) { strSplit = ","; }
        if (bKeyWithoutSpace === void 0) { bKeyWithoutSpace = false; }
        if (bValueWithoutSpace === void 0) { bValueWithoutSpace = false; }
        if (strEquals === void 0) { strEquals = "="; }
        var ret = ["", ""];
        if (strSource == null || strSource == "")
            return ret;
        var m = strSource.split(strSplit);
        for (var i = 0, n = m.length; i < n; i++) {
            var m2 = m[i].split(strEquals, 2);
            if (m2.length > 2) {
                for (var j = 2; j < m2.length; j++)
                    m2[1] += "=" + m2[j];
            }
            if (m2[0] != null && m2[0] != "") {
                var key = m2[0];
                var value = m2[1];
                if (bKeyWithoutSpace) {
                    while (key.length && key.charCodeAt(0) <= 32)
                        key = key.substring(1, key.length);
                    while (key.length && key.charCodeAt(key.length - 1) <= 32)
                        key = key.substring(0, key.length - 1);
                }
                if (bValueWithoutSpace) {
                    while (value.length && value.charCodeAt(0) <= 32)
                        value = value.substring(1, value.length);
                    while (value.length && value.charCodeAt(value.length - 1) <= 32)
                        value = value.substring(0, value.length - 1);
                }
                ret[0] = key;
                ret[1] = value;
            }
        }
        return ret;
    };
    dStringUtils.StringToNumber = function (str) {
        for (var i = 0; i < str.length; i++) {
            var code = str.charCodeAt(i);
            if (code >= '0'.charCodeAt(0) && code <= '9'.charCodeAt(0) || code == '-'.charCodeAt(0) && i == 0)
                continue;
            str = str.substring(0, i);
            break;
        }
        return Number(str);
    };
    dStringUtils.InswertStr = function (src, at, insert) {
        return src.substring(0, at) + insert + src.substring(at, src.length);
    };
    dStringUtils.StringToBoolean = function (str) {
        if (!str || str == "0" || str.toLowerCase() == "false")
            return false;
        return true;
    };
    dStringUtils.CODE_PAGE_UTF8 = 0;
    dStringUtils.CODE_PAGE_UNICODE = 1;
    dStringUtils.CODE_PAGE_GBK = 2;
    dStringUtils.CODE_PAGE_SHIFTJIS = 3;
    dStringUtils.CODE_PAGE_JIS_X_0201 = 4;
    dStringUtils.dLANG_ENGLISH = 120;
    dStringUtils.dLANG_CHINESE_SIMPLIFIED = 110;
    return dStringUtils;
}());
var dTimer = (function (_super) {
    __extends(dTimer, _super);
    function dTimer(pSprite) {
        if (pSprite === void 0) { pSprite = null; }
        var _this = _super.call(this) || this;
        _this.m_pSpriteForStop = null;
        _this.m_nLastCheckSpriteTime = 0;
        _this.m_nRepeatCountEnd = 0;
        _this.m_nRepeatCountAdd = 0;
        _this.m_nRepeatCountAddStep = 0;
        _this.m_bRunning = false;
        _this.m_bPause = false;
        _this.m_nCallTimes = 1;
        _this.m_nDelay = 0;
        _this.m_pBaseObject = null;
        _this.m_onTimerCallback = null;
        _this.m_nTargetTick = 0;
        _this.m_nLastApplyTick = 0;
        _this.m_pSpriteForStop = pSprite;
        return _this;
    }
    dTimer.prototype.SetCallTimes = function (data) {
        this.m_nCallTimes = data;
        return this;
    };
    dTimer.prototype.GetCallTimes = function () {
        return this.m_nCallTimes;
    };
    dTimer.prototype.Stop = function () {
        this.m_bRunning = false;
        if (this.m_pBaseObject != null) {
            dInterface.ptr.m_vecTimerWillDelete.push(this.m_pBaseObject);
            this.m_pBaseObject = null;
        }
        this.m_nRepeatCountEnd = 0;
        this.m_nRepeatCountAdd = 0;
        this.m_nRepeatCountAddStep = 0;
    };
    dTimer.prototype.isRunning = function () {
        return this.m_bRunning;
    };
    dTimer.prototype.Apply = function (fTimeElapse) {
        if (fTimeElapse === void 0) { fTimeElapse = 0; }
        if (!this.m_bRunning)
            return;
        var bStop = false;
        for (var i = 0; i < this.m_nCallTimes; i++) {
            this.m_nRepeatCountAdd += this.m_nRepeatCountAddStep;
            if (this.m_nRepeatCountEnd > 0 && this.m_nRepeatCountAdd - this.m_nRepeatCountAddStep >= this.m_nRepeatCountEnd) {
                this.Stop();
                bStop = true;
                break;
            }
            else {
                if (!bStop && this.m_onTimerCallback != null) {
                    if (this.m_pSpriteForStop == null || !this.m_pSpriteForStop.isDestroyed())
                        this.m_onTimerCallback(this, this.m_nRepeatCountAdd - this.m_nRepeatCountAddStep, fTimeElapse);
                }
                if (bStop)
                    break;
            }
        }
        if (this.m_pSpriteForStop != null) {
            if (this.m_pSpriteForStop.isDestroyed()) {
                this.Stop();
                bStop = true;
            }
            else {
                var time = dTimer.GetTickCount();
                if (this.m_nLastCheckSpriteTime == 0)
                    this.m_nLastCheckSpriteTime = time;
                if (time > this.m_nLastCheckSpriteTime + 1000) {
                    if (!this.m_pSpriteForStop.isInRoot()) {
                        this.Stop();
                    }
                    this.m_nLastCheckSpriteTime = time;
                }
            }
        }
    };
    dTimer.prototype.SetDelay = function (delay) {
        this.m_nDelay = delay;
    };
    dTimer.prototype.Pause = function () {
        this.m_bPause = true;
    };
    dTimer.prototype.Resume = function () {
        this.m_bPause = false;
    };
    dTimer.prototype.isPause = function () {
        return this.m_bPause;
    };
    dTimer.prototype.SetRepeatCount = function (repeatCount) {
        this.m_nRepeatCountEnd = repeatCount;
        return this;
    };
    dTimer.prototype.Restart = function () {
        this.m_nLastApplyTick = dInterface.ptr.GetRenderTick();
        this.m_nTargetTick = this.m_nLastApplyTick + this.m_nDelay;
    };
    dTimer.prototype.GetRepeatCount = function () {
        return this.m_nRepeatCountEnd;
    };
    dTimer.prototype.isLastRepeat = function () {
        return this.m_nRepeatCountAdd >= this.m_nRepeatCountEnd;
    };
    dTimer.prototype.Create = function (delay, repeatCount, onTimer) {
        var _this = this;
        this.Stop();
        this.m_bRunning = true;
        this.m_nRepeatCountEnd = repeatCount;
        this.m_nRepeatCountAddStep = 1;
        this.m_onTimerCallback = onTimer;
        this.m_nDelay = delay;
        this.m_nLastApplyTick = dInterface.ptr.GetRenderTick();
        this.m_nTargetTick = this.m_nLastApplyTick + delay;
        if (this.m_pBaseObject == null) {
            this.m_pBaseObject = function (elapseTime, curTick) {
                if (curTick >= _this.m_nTargetTick) {
                    var fElapse = (curTick - _this.m_nLastApplyTick) / 1000;
                    _this.m_nLastApplyTick = curTick;
                    if (_this.m_nDelay > 0) {
                        var sub = (curTick - _this.m_nTargetTick) % _this.m_nDelay;
                        _this.m_nTargetTick = curTick + _this.m_nDelay - sub;
                    }
                    else {
                        _this.m_nTargetTick = curTick;
                    }
                    _this.Apply(dMath.Min(fElapse, dTimer.MAX_ELAPSE_TIME));
                }
            };
            dInterface.ptr.m_vecTimer.push(this.m_pBaseObject);
        }
        return this;
    };
    dTimer.GetTickCount = function () {
        return new Date().getTime() - dTimer.__g_nFirstGetTickCountTime;
    };
    dTimer.SetTimeScale = function (fScale) {
    };
    dTimer.GetTimeScale = function () {
        return 0;
    };
    dTimer.PauseAllTimer = function (bPause) {
    };
    dTimer.SetGlobalSleep = function (time) {
    };
    dTimer.__g_nFirstGetTickCountTime = new Date().getTime();
    dTimer.MAX_ELAPSE_TIME = 1;
    return dTimer;
}(dObject));
var dVector2 = (function (_super) {
    __extends(dVector2, _super);
    function dVector2(x, y) {
        if (x === void 0) { x = 0; }
        if (y === void 0) { y = 0; }
        var _this = _super.call(this) || this;
        _this.x = x;
        _this.y = y;
        return _this;
    }
    dVector2.prototype.SetValue = function (_x, _y) {
        if (_x === void 0) { _x = 0.0; }
        if (_y === void 0) { _y = 0.0; }
        this.x = _x;
        this.y = _y;
        return this;
    };
    dVector2.prototype.Copy = function (t) {
        this.x = t.x;
        this.y = t.y;
        return this;
    };
    dVector2.prototype.Equals = function (p) {
        if (p == null)
            return false;
        return this.x == p.x && this.y == p.y;
    };
    dVector2.prototype.ToStringBuffer = function (split) {
        if (split === void 0) { split = " "; }
        return this.x + split + this.y;
    };
    dVector2.prototype.FromString = function (value, split) {
        if (split === void 0) { split = " "; }
        var arr = value.split(split);
        this.x = dMath.ParseFloat(arr[0]);
        this.y = dMath.ParseFloat(arr[1]);
        return this;
    };
    dVector2.prototype.Transform = function (mat) {
        var _x = this.x * mat._11 + this.y * mat._21 + mat._41;
        var _y = this.x * mat._12 + this.y * mat._22 + mat._42;
        var _w = this.x * mat._14 + this.y * mat._24 + mat._44;
        if (_w != 0.0) {
            this.x = _x / _w;
            this.y = _y / _w;
        }
        else {
            this.x = _x;
            this.y = _y;
        }
        return this;
    };
    dVector2.prototype.AddAppend = function (v) {
        this.x += v.x;
        this.y += v.y;
        return this;
    };
    dVector2.prototype.AddAppendF = function (f) {
        this.x += f;
        this.y += f;
        return this;
    };
    dVector2.prototype.SubAppend = function (v) {
        this.x -= v.x;
        this.y -= v.y;
        return this;
    };
    dVector2.prototype.SubAppendF = function (f) {
        this.x -= f;
        this.y -= f;
        return this;
    };
    dVector2.prototype.MulAppendF = function (f) {
        this.x *= f;
        this.y *= f;
        return this;
    };
    dVector2.prototype.DivAppendF = function (f) {
        if (f == 0.0) {
            this.x = 0.0;
            this.y = 0.0;
        }
        else {
            this.x /= f;
            this.y /= f;
        }
        return this;
    };
    dVector2.prototype.Add = function (v) {
        return new dVector2(this.x + v.x, this.y + v.y);
    };
    dVector2.prototype.AddF = function (f) {
        return new dVector2(this.x + f, this.y + f);
    };
    dVector2.prototype.Sub = function (v) {
        return new dVector2(this.x - v.x, this.y - v.y);
    };
    dVector2.prototype.SubF = function (f) {
        return new dVector2(this.x - f, this.y - f);
    };
    dVector2.prototype.MulF = function (f) {
        return new dVector2(this.x * f, this.y * f);
    };
    dVector2.prototype.DivF = function (f) {
        if (f == 0.0)
            return new dVector2();
        return new dVector2(this.x / f, this.y / f);
    };
    dVector2.prototype.Cross = function (p) {
        return new dVector2(this.x * p.y - p.x * this.y);
    };
    dVector2.prototype.Length = function () {
        return dMath.Sqrt(this.x * this.x + this.y * this.y);
    };
    dVector2.prototype.LengthTo = function (p) {
        var ret = dMath.Sqrt((this.x - p.x) * (this.x - p.x) + (this.y - p.y) * (this.y - p.y));
        return ret;
    };
    dVector2.prototype.Normalize = function () {
        var l = this.Length();
        if (l != 0.0) {
            this.x /= l;
            this.y /= l;
        }
        return this;
    };
    dVector2.prototype.Dot = function (p) {
        return this.x * p.x + this.y * p.y;
    };
    dVector2.prototype.WriteToBin = function (to) {
        to.WriteFloat(this.x);
        to.WriteFloat(this.y);
    };
    dVector2.prototype.ReadFromBin = function (data) {
        this.x = data.ReadFloat();
        this.y = data.ReadFloat();
        return this;
    };
    dVector2.prototype.ToAngle = function (vTo) {
        if (vTo === void 0) { vTo = null; }
        return dMath.RadianToAngle(this.ToRadian(vTo));
    };
    dVector2.prototype.FromAngle = function (v) {
        return this.FromRadian(dMath.AngleToRadian(v));
    };
    dVector2.prototype.FromRadian = function (v) {
        this.x = dMath.Sin(v);
        this.y = -dMath.Cos(v);
        return this;
    };
    dVector2.prototype.ToRadian = function (vTo) {
        if (vTo === void 0) { vTo = null; }
        if (vTo == null)
            vTo = new dVector2(0, 1);
        else {
            return dMath.AngleToRadian(dMath.SubAngle(dMath.RadianToAngle(this.ToRadian()), dMath.RadianToAngle(vTo.ToRadian())));
        }
        var fRotAngle = 0.0;
        if (dMath.Abs(this.x) < 0.00001) {
            if (this.y < 0.0)
                fRotAngle = 0;
            else
                fRotAngle = dMath.dPI;
        }
        else {
            fRotAngle = dMath.dPI - dMath.Acos(this.Dot(vTo));
            if (this.x < 0)
                fRotAngle = -fRotAngle;
        }
        return fRotAngle;
    };
    dVector2.prototype.ToVector3 = function () {
        return new dVector3(this.x, this.y, 0);
    };
    dVector2.ZERO = new dVector2();
    return dVector2;
}(dObject));
var dVector3 = (function (_super) {
    __extends(dVector3, _super);
    function dVector3(x, y, z) {
        if (x === void 0) { x = 0; }
        if (y === void 0) { y = 0; }
        if (z === void 0) { z = 0; }
        var _this = _super.call(this) || this;
        _this.x = x;
        _this.y = y;
        _this.z = z;
        return _this;
    }
    dVector3.prototype.SetValue = function (_x, _y, _z) {
        if (_x === void 0) { _x = 0.0; }
        if (_y === void 0) { _y = 0.0; }
        if (_z === void 0) { _z = 0.0; }
        this.x = _x;
        this.y = _y;
        this.z = _z;
        return this;
    };
    dVector3.prototype.Copy = function (t) {
        if (t != null) {
            this.x = t.x;
            this.y = t.y;
            this.z = t.z;
        }
        return this;
    };
    dVector3.prototype.ToStringBuffer = function (split) {
        if (split === void 0) { split = " "; }
        return this.x + split + this.y + split + this.z;
    };
    dVector3.prototype.FromString = function (value, split) {
        if (split === void 0) { split = " "; }
        var arr = value.split(split);
        this.x = dMath.ParseFloat(arr[0]);
        this.y = dMath.ParseFloat(arr[1]);
        this.z = dMath.ParseFloat(arr[2]);
        return this;
    };
    dVector3.prototype.GetAt = function (at) {
        if (at == 0)
            return this.x;
        if (at == 1)
            return this.y;
        if (at == 2)
            return this.z;
        return 0.0;
    };
    dVector3.prototype.SetAt = function (at, data) {
        if (at == 0)
            this.x = data;
        if (at == 1)
            this.y = data;
        if (at == 2)
            this.z = data;
        return this;
    };
    dVector3.Vec3Sub = function (_out, v1, v2) {
        _out.x = v1.x - v2.x;
        _out.y = v1.y - v2.y;
        _out.z = v1.z - v2.z;
        return _out;
    };
    dVector3.prototype.Equals = function (v) {
        return this.x == v.x && this.y == v.y && this.z == v.z;
    };
    dVector3.prototype.EqualsIgnore = function (v, ignore) {
        if (ignore === void 0) { ignore = 0.0001; }
        return dMath.FloatEquals(this.x, v.x, ignore) && dMath.FloatEquals(this.y, v.y, ignore) && dMath.FloatEquals(this.z, v.z, ignore);
    };
    dVector3.prototype.NotEquals = function (v) {
        return !(this.Equals(v));
    };
    dVector3.prototype.AddAppend = function (v) {
        this.x += v.x;
        this.y += v.y;
        this.z += v.z;
        return this;
    };
    dVector3.prototype.AddAppendF = function (f) {
        this.x += f;
        this.y += f;
        this.z += f;
        return this;
    };
    dVector3.prototype.SubAppend = function (v) {
        this.x -= v.x;
        this.y -= v.y;
        this.z -= v.z;
        return this;
    };
    dVector3.prototype.SubAppendF = function (f) {
        this.x -= f;
        this.y -= f;
        this.z -= f;
        return this;
    };
    dVector3.prototype.MulAppend = function (v) {
        this.x *= v.x;
        this.y *= v.y;
        this.z *= v.z;
        return this;
    };
    dVector3.prototype.MulAppendF = function (f) {
        this.x *= f;
        this.y *= f;
        this.z *= f;
        return this;
    };
    dVector3.prototype.DivAppendF = function (f) {
        if (f == 0.0) {
            this.x = 0.0;
            this.y = 0.0;
            this.z = 0.0;
        }
        else {
            this.x /= f;
            this.y /= f;
            this.z /= f;
        }
        return this;
    };
    dVector3.prototype.Add = function (v) {
        return new dVector3(this.x + v.x, this.y + v.y, this.z + v.z);
    };
    dVector3.prototype.AddF = function (f) {
        return new dVector3(this.x + f, this.y + f, this.z + f);
    };
    dVector3.prototype.Sub = function (v) {
        return new dVector3(this.x - v.x, this.y - v.y, this.z - v.z);
    };
    dVector3.prototype.SubF = function (f) {
        return new dVector3(this.x - f, this.y - f, this.z - f);
    };
    dVector3.prototype.MulF = function (f) {
        return new dVector3(this.x * f, this.y * f, this.z * f);
    };
    dVector3.prototype.DivF = function (f) {
        if (f == 0.0)
            return new dVector3();
        return new dVector3(this.x / f, this.y / f, this.z / f);
    };
    dVector3.prototype.Cross = function (p) {
        return new dVector3(this.y * p.z - p.y * this.z, this.z * p.x - p.z * this.x, this.x * p.y - p.x * this.y);
    };
    dVector3.prototype.CrossAppend = function (p) {
        var xx = this.y * p.z - p.y * this.z;
        var yy = this.z * p.x - p.z * this.x;
        var zz = this.x * p.y - p.x * this.y;
        this.SetValue(xx, yy, zz);
        return this;
    };
    dVector3.Vec3Cross = function (_out, v1, v2) {
        _out.x = v1.y * v2.z - v2.y * v1.z;
        _out.y = v1.z * v2.x - v2.z * v1.x;
        _out.z = v1.x * v2.y - v2.x * v1.y;
        return _out;
    };
    dVector3.prototype.isZero = function () {
        return this.x == 0 && this.y == 0 && this.z == 0;
    };
    dVector3.prototype.Length = function () {
        return dMath.Sqrt(this.x * this.x + this.y * this.y + this.z * this.z);
    };
    dVector3.prototype.LengthTo = function (p) {
        return dMath.Sqrt((this.x - p.x) * (this.x - p.x) + (this.y - p.y) * (this.y - p.y) + (this.z - p.z) * (this.z - p.z));
    };
    dVector3.prototype.SquareMagnitude = function () {
        return this.x * this.x + this.y * this.y + this.z * this.z;
    };
    dVector3.prototype.Normalize = function () {
        var l = this.Length();
        if (l != 0.0) {
            this.x /= l;
            this.y /= l;
            this.z /= l;
        }
        return this;
    };
    dVector3.prototype.NormalizeToNewVector = function () {
        return new dVector3().Copy(this).Normalize();
    };
    dVector3.prototype.Dot = function (p) {
        return this.x * p.x + this.y * p.y + this.z * p.z;
    };
    dVector3.Vec3Dot = function (a, p) {
        return a.x * p.x + a.y * p.y + a.z * p.z;
    };
    dVector3.prototype.ToAngle = function (vTo) {
        if (vTo === void 0) { vTo = null; }
        if (vTo == null)
            vTo = new dVector3(0, 1, 0);
        return dMath.RadianToAngle(dMath.Acos(this.Dot(vTo)));
    };
    dVector3.prototype.FromAngle = function (angle, vAxis) {
        if (vAxis === void 0) { vAxis = null; }
        if (vAxis == null)
            vAxis = new dVector3(0, 0, 1);
        var mat = new dMatrix();
        mat.RotationAxis(dMath.AngleToRadian(angle), vAxis);
        this.SetValue(0, 1, 0);
        this.Transform(mat);
        return this;
    };
    dVector3.prototype.Transform = function (mat) {
        var _x = this.x * mat._11 + this.y * mat._21 + this.z * mat._31 + mat._41;
        var _y = this.x * mat._12 + this.y * mat._22 + this.z * mat._32 + mat._42;
        var _z = this.x * mat._13 + this.y * mat._23 + this.z * mat._33 + mat._43;
        var _w = this.x * mat._14 + this.y * mat._24 + this.z * mat._34 + mat._44;
        if (_w != 0.0) {
            this.x = _x / _w;
            this.y = _y / _w;
            this.z = _z / _w;
        }
        else {
            this.x = _x;
            this.y = _y;
            this.z = _z;
        }
        return this;
    };
    dVector3.prototype.TransformNormal = function (mat) {
        var _x = this.x * mat._11 + this.y * mat._21 + this.z * mat._31;
        var _y = this.x * mat._12 + this.y * mat._22 + this.z * mat._32;
        var _z = this.x * mat._13 + this.y * mat._23 + this.z * mat._33;
        this.x = _x;
        this.y = _y;
        this.z = _z;
        return this;
    };
    dVector3.LerpVector = function (out1, p1, p2, t) {
        var inv = 1.0 - t;
        out1.SetValue(p1.x * inv + p2.x * t, p1.y * inv + p2.y * t, p1.z * inv + p2.z * t);
        return out1;
    };
    dVector3.Unproject = function (vScreen, fViewX, fViewY, fViewWidth, fViewHeight, fViewZMin, fViewZMax, matWorldViewProj) {
        var A = new dMatrix().Copy(matWorldViewProj).Inverse();
        var v = new dVector4();
        v.x = (vScreen.x - fViewX) / fViewWidth * 2.0 - 1.0;
        v.y = -((vScreen.y - fViewY) / fViewHeight * 2.0 - 1.0);
        v.z = 2.0 * vScreen.z - 1.0;
        v.w = 1.0;
        v.Transform(A);
        if (v.w == 0.0)
            return new dVector3();
        v.w = 1.0 / v.w;
        return new dVector3(v.x * v.w, v.y * v.w, v.z * v.w);
    };
    dVector3.prototype.WriteToBin = function (to) {
        to.WriteFloat(this.x);
        to.WriteFloat(this.y);
        to.WriteFloat(this.z);
        return this;
    };
    dVector3.prototype.ReadFromBin = function (data) {
        this.x = data.ReadFloat();
        this.y = data.ReadFloat();
        this.z = data.ReadFloat();
        return this;
    };
    dVector3.ZERO = new dVector3();
    return dVector3;
}(dObject));
var dVector4 = (function (_super) {
    __extends(dVector4, _super);
    function dVector4(x, y, z, w) {
        if (x === void 0) { x = 0; }
        if (y === void 0) { y = 0; }
        if (z === void 0) { z = 0; }
        if (w === void 0) { w = 0; }
        var _this = _super.call(this) || this;
        _this.x = x;
        _this.y = y;
        _this.z = z;
        _this.w = w;
        return _this;
    }
    dVector4.prototype.SetValue = function (_x, _y, _z, _w) {
        if (_x === void 0) { _x = 0.0; }
        if (_y === void 0) { _y = 0.0; }
        if (_z === void 0) { _z = 0.0; }
        if (_w === void 0) { _w = 0.0; }
        this.x = _x;
        this.y = _y;
        this.z = _z;
        this.w = _w;
        return this;
    };
    dVector4.prototype.Copy = function (t) {
        this.x = t.x;
        this.y = t.y;
        this.z = t.z;
        this.w = t.w;
        return this;
    };
    dVector4.prototype.ToStringBuffer = function (split) {
        if (split === void 0) { split = " "; }
        return this.x + split + this.y + split + this.z + split + this.w;
    };
    dVector4.prototype.FromString = function (value, split) {
        if (split === void 0) { split = " "; }
        var arr = value.split(split);
        this.x = dMath.ParseFloat(arr[0]);
        this.y = dMath.ParseFloat(arr[1]);
        this.z = dMath.ParseFloat(arr[2]);
        this.w = dMath.ParseFloat(arr[3]);
        return this;
    };
    dVector4.prototype.Equals = function (v) {
        if (v == null)
            return false;
        return this.x == v.x && this.y == v.y && this.z == v.z && this.w == v.w;
    };
    dVector4.prototype.AddAppend = function (v) {
        this.x += v.x;
        this.y += v.y;
        this.z += v.z;
        this.w += v.w;
        return this;
    };
    dVector4.prototype.AddAppendF = function (f) {
        this.x += f;
        this.y += f;
        this.z += f;
        this.w += f;
        return this;
    };
    dVector4.prototype.SubAppend = function (v) {
        this.x -= v.x;
        this.y -= v.y;
        this.z -= v.z;
        this.w -= v.z;
        return this;
    };
    dVector4.prototype.SubAppendF = function (f) {
        this.x -= f;
        this.y -= f;
        this.z -= f;
        this.z -= f;
        return this;
    };
    dVector4.prototype.MulAppend = function (v) {
        this.x *= v.x;
        this.y *= v.y;
        this.z *= v.z;
        this.w *= v.w;
        return this;
    };
    dVector4.prototype.MulAppendF = function (f) {
        this.x *= f;
        this.y *= f;
        this.z *= f;
        this.w *= f;
        return this;
    };
    dVector4.prototype.DivAppendF = function (f) {
        if (f == 0.0) {
            this.x = 0.0;
            this.y = 0.0;
            this.z = 0.0;
            this.w = 0.0;
        }
        else {
            this.x /= f;
            this.y /= f;
            this.z /= f;
            this.w /= f;
        }
        return this;
    };
    dVector4.prototype.Add = function (v) {
        return new dVector4(this.x + v.x, this.y + v.y, this.z + v.z, this.w + v.w);
    };
    dVector4.prototype.AddF = function (f) {
        return new dVector4(this.x + f, this.y + f, this.z + f, this.w + f);
    };
    dVector4.prototype.Sub = function (v) {
        return new dVector4(this.x - v.x, this.y - v.y, this.z - v.z, this.w - v.w);
    };
    dVector4.prototype.SubF = function (f) {
        return new dVector4(this.x - f, this.y - f, this.z - f, this.w - f);
    };
    dVector4.prototype.MulF = function (f) {
        return new dVector4(this.x * f, this.y * f, this.z * f, this.w * f);
    };
    dVector4.prototype.DivF = function (f) {
        if (f == 0.0)
            return new dVector4();
        return new dVector4(this.x / f, this.y / f, this.z / f, this.w / f);
    };
    dVector4.prototype.Length = function () {
        return dMath.Sqrt(this.x * this.x + this.y * this.y + this.z * this.z + this.w * this.w);
    };
    dVector4.prototype.LengthTo = function (p) {
        return dMath.Sqrt((this.x - p.x) * (this.x - p.x) + (this.y - p.y) * (this.y - p.y) + (this.z - p.z) * (this.z - p.z) + (this.w - p.w) * (this.w - p.w));
    };
    dVector4.prototype.Length3 = function () {
        return dMath.Sqrt(this.x * this.x + this.y * this.y + this.z * this.z);
    };
    dVector4.prototype.Normalize = function () {
        var l = this.Length();
        if (l != 0.0) {
            this.x /= l;
            this.y /= l;
            this.z /= l;
            this.w /= l;
        }
        return this;
    };
    dVector4.prototype.Normalize3 = function () {
        var l = this.Length3();
        if (l != 0.0) {
            this.x /= l;
            this.y /= l;
            this.z /= l;
        }
        return this;
    };
    dVector4.prototype.Dot = function (p) {
        return this.x * p.x + this.y * p.y + this.z * p.z + this.w * p.w;
    };
    dVector4.QuaternionSlerp = function (out1, p1, p2, t) {
        var cosa = p1.x * p2.x + p1.y * p2.y + p1.z * p2.z + p1.w * p2.w;
        if (cosa < 0.0) {
            p2.x = -p2.x;
            p2.y = -p2.y;
            p2.z = -p2.z;
            p2.w = -p2.w;
            cosa = -cosa;
        }
        var k0, k1;
        if (cosa > 0.9999) {
            k0 = 1.0 - t;
            k1 = t;
        }
        else {
            var sina = dMath.Sqrt(1.0 - cosa * cosa);
            var a = dMath.Atan2(sina, cosa);
            var invSina = 1.0 / sina;
            k0 = dMath.Sin((1.0 - t) * a) * invSina;
            k1 = dMath.Sin(t * a) * invSina;
        }
        out1.SetValue(p1.x * k0 + p2.x * k1, p1.y * k0 + p2.y * k1, p1.z * k0 + p2.z * k1, p1.w * k0 + p2.w * k1);
        return out1;
    };
    dVector4.prototype.QuaternionIdentity = function () {
        this.x = this.y = this.z = 0;
        this.w = 1;
        return this;
    };
    dVector4.prototype.QuaternionRotationAxisAngle = function (axis, angle) {
        var s, c;
        angle = angle * 0.5;
        s = dMath.Sin(angle);
        c = dMath.Cos(angle);
        var n = axis.Length();
        if (n < 1e-6) {
            this.QuaternionIdentity();
        }
        else {
            s = s / n;
            this.x = axis.x * s;
            this.y = axis.y * s;
            this.z = axis.z * s;
            this.w = c;
        }
        return this;
    };
    dVector4.prototype.QuaternionRotationX = function (angle) {
        angle = angle * 0.5;
        this.x = dMath.Sin(angle);
        this.y = 0;
        this.z = 0;
        this.w = dMath.Cos(angle);
        return this;
    };
    dVector4.prototype.QuaternionRotationY = function (angle) {
        angle = angle * 0.5;
        this.x = 0;
        this.y = dMath.Sin(angle);
        this.z = 0;
        this.w = dMath.Cos(angle);
        return this;
    };
    dVector4.prototype.QuaternionRotationZ = function (angle) {
        angle = angle * 0.5;
        this.x = 0;
        this.y = 0;
        this.z = dMath.Sin(angle);
        this.w = dMath.Cos(angle);
        return this;
    };
    dVector4.prototype.Transform = function (mat) {
        var _x = this.x * mat._11 + this.y * mat._21 + this.z * mat._31 + this.w * mat._41;
        var _y = this.x * mat._12 + this.y * mat._22 + this.z * mat._32 + this.w * mat._42;
        var _z = this.x * mat._13 + this.y * mat._23 + this.z * mat._33 + this.w * mat._43;
        var _w = this.x * mat._14 + this.y * mat._24 + this.z * mat._34 + this.w * mat._44;
        this.SetValue(_x, _y, _z, _w);
        return this;
    };
    dVector4.prototype.WriteToBin = function (to) {
        to.WriteFloat(this.x);
        to.WriteFloat(this.y);
        to.WriteFloat(this.z);
        to.WriteFloat(this.w);
        return this;
    };
    dVector4.prototype.ReadFromBin = function (data) {
        this.x = data.ReadFloat();
        this.y = data.ReadFloat();
        this.z = data.ReadFloat();
        this.w = data.ReadFloat();
        return this;
    };
    dVector4.prototype.QuaternionToEuler = function () {
        var _rotationX = dMath.Atan2(2.0 * (this.w * this.x + this.y * this.z), 1.0 - 2.0 * (this.x * this.x + this.y * this.y));
        var sy = 2.0 * (this.w * this.y - this.z * this.x);
        sy = dMath.Clamp(sy, -1, 1);
        var _rotationY = dMath.Asin(sy);
        var _rotationZ = dMath.Atan2(2.0 * (this.w * this.z + this.x * this.y), 1.0 - 2.0 * (this.y * this.y + this.z * this.z));
        return new dVector3(dMath.RadianToAngle(_rotationX), dMath.RadianToAngle(_rotationY), dMath.RadianToAngle(_rotationZ));
    };
    dVector4.prototype.QuaternionFromEuler = function (euler) {
        var halfRadx = dMath.AngleToRadian(euler.x / 2.0);
        var halfRady = dMath.AngleToRadian(euler.y / 2.0);
        var halfRadz = dMath.AngleToRadian(euler.z / 2.0);
        var coshalfRadx = dMath.Cos(halfRadx);
        var sinhalfRadx = dMath.Sin(halfRadx);
        var coshalfRady = dMath.Cos(halfRady);
        var sinhalfRady = dMath.Sin(halfRady);
        var coshalfRadz = dMath.Cos(halfRadz);
        var sinhalfRadz = dMath.Sin(halfRadz);
        this.x = sinhalfRadx * coshalfRady * coshalfRadz - coshalfRadx * sinhalfRady * sinhalfRadz;
        this.y = coshalfRadx * sinhalfRady * coshalfRadz + sinhalfRadx * coshalfRady * sinhalfRadz;
        this.z = coshalfRadx * coshalfRady * sinhalfRadz - sinhalfRadx * sinhalfRady * coshalfRadz;
        this.w = coshalfRadx * coshalfRady * coshalfRadz + sinhalfRadx * sinhalfRady * sinhalfRadz;
        return this;
    };
    dVector4.ZERO = new dVector4();
    return dVector4;
}(dObject));
var dAnimationImage = (function (_super) {
    __extends(dAnimationImage, _super);
    function dAnimationImage() {
        var _this = _super.call(this) || this;
        _this.m_pFrames = new Array();
        _this.m_pImage = new dSprite();
        _this.m_nDelay = 0;
        _this.m_nLoop = 0;
        _this.m_pPlayTimer = null;
        _this.AddChild(_this.m_pImage);
        return _this;
    }
    Object.defineProperty(dAnimationImage.prototype, "Frames", {
        get: function () {
            return this.m_pFrames;
        },
        enumerable: false,
        configurable: true
    });
    dAnimationImage.prototype.GetFrameData = function (frame) {
        return this.m_pFrames[frame];
    };
    dAnimationImage.prototype.GetFrameBitmapData = function (frame) {
        if (frame >= 0 && frame < this.m_pFrames.length)
            return this.m_pFrames[frame].bmp;
        return null;
    };
    dAnimationImage.prototype.InitWithAnimationFrames = function (arrayOfAnimationFrames) {
        this.m_pFrames = arrayOfAnimationFrames;
        return true;
    };
    dAnimationImage.prototype.SetAnchor = function (u, v) {
        _super.prototype.SetAnchor.call(this, u, v);
        this.UpdateFrame();
    };
    dAnimationImage.prototype.SetColor = function (colorARGB, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetColor.call(this, colorARGB, bSetToChild);
        if (!bSetToChild)
            this.m_pImage.SetColor(colorARGB, bSetToChild);
    };
    dAnimationImage.prototype.SetBlendMode = function (mode, bWithChild) {
        if (bWithChild === void 0) { bWithChild = false; }
        _super.prototype.SetBlendMode.call(this, mode, bWithChild);
        if (!bWithChild)
            this.m_pImage.SetBlendMode(mode, bWithChild);
    };
    dAnimationImage.prototype.ClearFrame = function () {
        this.m_pFrames.clear();
    };
    dAnimationImage.prototype.AddFrameWithFileName = function (pszFileName, rect, index, onComplete) {
        var _this = this;
        if (rect === void 0) { rect = null; }
        if (index === void 0) { index = -1; }
        if (onComplete === void 0) { onComplete = null; }
        var bmp = new dBitmapData();
        var frameData = this._AddFrameWithBitmapData(bmp, index);
        if (rect != null)
            frameData.rcSource.Copy(rect);
        else
            frameData.rcSource.SetPosSize(0, 0, 1, 1);
        if (pszFileName != "") {
            bmp.LoadFromFile(pszFileName, function () {
                _this.UpdateFrame();
                if (onComplete)
                    onComplete(_this);
            });
        }
        else {
            if (onComplete)
                onComplete(this);
        }
    };
    dAnimationImage.prototype.AddFrameWithSplitRect = function (pszFileName, width_count, height_count, startFrame, endFrame) {
        var _this = this;
        if (startFrame === void 0) { startFrame = 0; }
        if (endFrame === void 0) { endFrame = 0; }
        if (width_count < 1)
            width_count = 1;
        if (height_count < 1)
            height_count = 1;
        var bmp = new dBitmapData();
        for (var j = startFrame / width_count; j < height_count; j++) {
            for (var i = startFrame % width_count; i < width_count; i++) {
                var per_width = 1 / width_count;
                var per_height = 1 / height_count;
                var frameData = this._AddFrameWithBitmapData(bmp);
                frameData.rcSource.SetPosSize(i * per_width, j * per_height, per_width, per_height);
                if (endFrame > 0 && this.m_pFrames.length >= endFrame)
                    break;
            }
            if (endFrame > 0 && this.m_pFrames.length >= endFrame)
                break;
        }
        bmp.LoadFromFile(pszFileName, function () {
            _this.UpdateFrame();
        });
    };
    dAnimationImage.prototype.AddFrameWithBitmapDatas = function (pobTextures) {
        for (var i = 0; i < pobTextures.length; i++) {
            this._AddFrameWithBitmapData(pobTextures[i]);
        }
    };
    dAnimationImage.prototype._AddFrameWithBitmapData = function (pobTexture, index) {
        if (index === void 0) { index = -1; }
        if (index == -1 || index >= this.m_pFrames.length) {
            var frameData = new FrameData();
            frameData.bmp = pobTexture;
            this.Frames.push(frameData);
            return frameData;
        }
        else {
            var frameData = this.m_pFrames[index];
            if (frameData == null)
                this.m_pFrames[index] = frameData = new FrameData();
            frameData.bmp = pobTexture;
            return frameData;
        }
    };
    dAnimationImage.prototype.AddFrameWithBitmapData = function (pobTexture, width_count, height_count, startFrame, endFrame) {
        if (width_count === void 0) { width_count = 1; }
        if (height_count === void 0) { height_count = 1; }
        if (startFrame === void 0) { startFrame = 0; }
        if (endFrame === void 0) { endFrame = 0; }
        if (width_count < 1)
            width_count = 1;
        if (height_count < 1)
            height_count = 1;
        var frameCountAdd = 0;
        for (var j = startFrame / width_count; j < height_count; j++) {
            for (var i = startFrame % width_count; i < width_count; i++) {
                var bmp = pobTexture;
                var per_width = 1 / width_count;
                var per_height = 1 / height_count;
                var frameData = this._AddFrameWithBitmapData(bmp);
                frameData.rcSource.SetPosSize(i * per_width, j * per_height, per_width, per_height);
                frameCountAdd++;
                if (endFrame > 0 && frameCountAdd >= endFrame)
                    break;
            }
            if (endFrame > 0 && frameCountAdd >= endFrame)
                break;
        }
    };
    dAnimationImage.prototype.SetLoadCompleteCallback = function (onComplete) {
        var callback = new dCompleteCallback(this);
        for (var i = 0; i < this.m_pFrames.length; i++) {
            if (this.m_pFrames[i].bmp != null) {
                this.m_pFrames[i].bmp.SetLoadCompleteCallback(callback.CreateCompleteFun_Normal());
            }
        }
        callback.SetCompleteFun(onComplete);
    };
    dAnimationImage.prototype.DeleteFrame = function (frame) {
        this.m_pFrames.erase(frame);
    };
    dAnimationImage.prototype.WhenLoadFinish = function (onComplete) {
        var _this = this;
        var pTimer = new dTimer();
        pTimer.Create(30, 0, function (p, ii, f) {
            for (var i = 0; i < _this.m_pFrames.length; i++)
                if (_this.m_pFrames[i].bmp != null && _this.m_pFrames[i].bmp.isLoading())
                    return;
            onComplete(_this);
            pTimer.Stop();
        });
    };
    dAnimationImage.prototype.GetMaxFrame = function () {
        return this.m_pFrames.length;
    };
    dAnimationImage.prototype.SetSize = function (w, h) {
    };
    dAnimationImage.prototype.EndDsc = function () {
        _super.prototype.EndDsc.call(this);
        this.UpdateFrame();
    };
    dAnimationImage.prototype.SetShow = function (bShow) {
        _super.prototype.SetShow.call(this, bShow);
        this.UpdateFrame();
    };
    dAnimationImage.prototype.GetBitmapData = function (at) {
        if (at === void 0) { at = 0; }
        return this.m_pImage.GetBitmapData(at);
    };
    dAnimationImage.prototype.SetFrameDataList = function (dataList) {
        _super.prototype.SetFrameDataList.call(this, dataList);
        this.UpdateFrame();
    };
    dAnimationImage.prototype.UpdateFrame = function () {
        if (this.m_bBeginDsc)
            return;
        if (this.m_pFrames == null)
            return;
        if (!this.isShow())
            return;
        var frame = dMath.ToInt(this.m_nSpriteFrame);
        if (frame >= 0 && frame < this.m_pFrames.length) {
            if (this.m_vecFrameData && frame < this.m_vecFrameData.length) {
                frame = this.m_vecFrameData[frame].spriteFrame;
            }
            var frameData = this.m_pFrames[frame];
            if (frameData && frameData.bmp) {
                this.m_pImage.SetBitmapData(frameData.bmp, frameData.rcSource);
                this.m_pImage.SetSize(frameData.bmp.GetWidth() * frameData.rcSource.Width(), frameData.bmp.GetHeight() * frameData.rcSource.Height());
                _super.prototype.SetSize.call(this, this.m_pImage.width, this.m_pImage.height);
                this.m_pImage.SetAnchor(this.anchorU, this.anchorV);
                this.m_pImage.SetPos(frameData.x, frameData.y);
                this.m_pImage.SetScale(frameData.sx, frameData.sy);
                this.m_pImage.SetRotation(frameData.rotation);
            }
            else {
                this.m_pImage.SetSize(0, 0);
            }
        }
        else if (this.m_pImage.GetBitmapData() != null) {
            this.m_pImage.SetBitmapData(null);
            _super.prototype.SetSize.call(this, 0, 0);
        }
    };
    dAnimationImage.prototype.SetFrame = function (frame) {
        _super.prototype.SetFrame.call(this, frame);
        this.UpdateFrame();
    };
    Object.defineProperty(dAnimationImage.prototype, "resourceFileName", {
        get: function () {
            var ret = "";
            for (var i = 0; i < this.m_pFrames.length; i++) {
                if (i != 0)
                    ret += "|";
                if (this.m_pFrames[i] != null && this.m_pFrames[i].bmp.GetResourceFileName() != null)
                    ret += this.m_pFrames[i].bmp.GetResourceFileName();
            }
            return ret;
        },
        set: function (fileName) {
            this.LoadFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    dAnimationImage.prototype.LoadFromFile = function (strFileName) {
        var _this = this;
        var vec = strFileName.split("|");
        this.m_pFrames.resize(vec.length);
        var callback = new dCompleteCallback(this);
        for (var i = 0; i < vec.length; i++)
            this.AddFrameWithFileName(vec[i], null, i, callback.CreateCompleteFun_Normal());
        callback.SetCompleteFun(function () {
            _this.UpdateFrame();
        });
    };
    Object.defineProperty(dAnimationImage.prototype, "resourceOffsetsAndScale", {
        get: function () {
            var ret = "";
            for (var i = 0; i < this.m_pFrames.length; i++) {
                if (i != 0)
                    ret += ",";
                var frameData = this.m_pFrames[i];
                ret += frameData.x + "," + frameData.y + "," + frameData.sx + "," + frameData.sy;
            }
            return ret;
        },
        set: function (value) {
            var vec = value.split(",");
            if (this.m_pFrames.length < vec.length / 4)
                this.m_pFrames.resize(vec.length / 4);
            for (var i = 0; i < vec.length; i += 4) {
                if (this.m_pFrames[i / 4] == null)
                    this.m_pFrames[i / 4] = new FrameData();
                this.m_pFrames[i / 4].x = dMath.ParseFloat(vec[i]);
                this.m_pFrames[i / 4].y = dMath.ParseFloat(vec[i + 1]);
                this.m_pFrames[i / 4].sx = dMath.ParseFloat(vec[i + 2]);
                this.m_pFrames[i / 4].sy = dMath.ParseFloat(vec[i + 3]);
            }
            this.UpdateFrame();
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dAnimationImage.prototype, "resourceOffsetsAndScaleAndRotation", {
        get: function () {
            var ret = "";
            for (var i = 0; i < this.m_pFrames.length; i++) {
                if (i != 0)
                    ret += ",";
                var v4 = this.m_pFrames[i];
                ret += v4.x + "," + v4.y + "," + v4.sx + "," + v4.sy + "," + v4.rotation;
            }
            return ret;
        },
        set: function (value) {
            var vec = value.split(",");
            if (this.m_pFrames.length < vec.length / 5)
                this.m_pFrames.resize(vec.length / 5);
            for (var i = 0; i < vec.length; i += 5) {
                this.m_pFrames[i / 5].x = dMath.ParseFloat(vec[i]);
                this.m_pFrames[i / 5].y = dMath.ParseFloat(vec[i + 1]);
                this.m_pFrames[i / 5].sx = dMath.ParseFloat(vec[i + 2]);
                this.m_pFrames[i / 5].sy = dMath.ParseFloat(vec[i + 3]);
                this.m_pFrames[i / 5].rotation = dMath.ParseFloat(vec[i + 4]);
            }
            this.UpdateFrame();
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dAnimationImage.prototype, "resourceOffsets", {
        set: function (value) {
            var vec = value.split(",");
            if (this.m_pFrames.length < vec.length / 2)
                this.m_pFrames.resize(vec.length / 2);
            for (var i = 0; i < vec.length; i += 2) {
                this.m_pFrames[i / 2].x = dMath.ParseFloat(vec[i]);
                this.m_pFrames[i / 2].y = dMath.ParseFloat(vec[i + 1]);
            }
            this.UpdateFrame();
        },
        enumerable: false,
        configurable: true
    });
    dAnimationImage.prototype.SetResourceOffset = function (frame, ox, oy, sx, sy, rotation) {
        if (rotation === void 0) { rotation = 0; }
        if (frame >= 0 && frame < this.GetMaxFrame()) {
            this.m_pFrames[frame].x = ox;
            this.m_pFrames[frame].y = oy;
            this.m_pFrames[frame].sx = sx;
            this.m_pFrames[frame].sy = sy;
            this.m_pFrames[frame].rotation = rotation;
        }
    };
    dAnimationImage.prototype.Play = function (loop, delay, bAutoRemove) {
        var _this = this;
        if (loop === void 0) { loop = 1; }
        if (delay === void 0) { delay = 100; }
        if (bAutoRemove === void 0) { bAutoRemove = true; }
        this.m_nLoop = loop;
        this.m_nDelay = delay;
        if (this.GetMaxFrame() == 0)
            return;
        var count = 0;
        if (loop > 0)
            count = this.GetMaxFrame() * loop + 1;
        this.Stop();
        this.m_pPlayTimer = new dTimer(this).Create(delay, count, function (sender, iTimer, fTimer) {
            if (iTimer == count - 1)
                _this.m_pPlayTimer = null;
            if (iTimer == count - 1 && bAutoRemove)
                _this.RemoveParent();
            else
                _this.SetFrame(iTimer % _this.GetMaxFrame());
        });
        this.m_pPlayTimer.Apply();
    };
    dAnimationImage.prototype.Stop = function () {
        if (this.m_pPlayTimer != null) {
            this.m_pPlayTimer.Stop();
            this.m_pPlayTimer = null;
        }
    };
    dAnimationImage.prototype.isPlaying = function () {
        return this.m_pPlayTimer != null;
    };
    dAnimationImage.prototype.GetLoop = function () {
        return this.m_nLoop;
    };
    dAnimationImage.prototype.GetDelay = function () {
        return this.m_nDelay;
    };
    dAnimationImage.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("resourceFileName"))
            this.resourceFileName = json.resourceFileName;
        if (json.hasOwnProperty("resourceOffsets"))
            this.resourceOffsets = json.resourceOffsets;
        if (json.hasOwnProperty("resourceOffsetsAndScale"))
            this.resourceOffsetsAndScale = json.resourceOffsetsAndScale;
        if (json.hasOwnProperty("resourceOffsetsAndScaleAndRotation"))
            this.resourceOffsetsAndScaleAndRotation = this.resourceOffsetsAndScaleAndRotation;
    };
    return dAnimationImage;
}(dBaseControl));
var FrameData = (function () {
    function FrameData() {
        this.rcSource = new dRect();
        this.x = 0;
        this.y = 0;
        this.sx = 1;
        this.sy = 1;
        this.rotation = 0;
        this.bmp = null;
    }
    return FrameData;
}());
var dLabel = (function (_super) {
    __extends(dLabel, _super);
    function dLabel() {
        var _this = _super.call(this) || this;
        _this.m_strText = "";
        _this.m_fWordSpace = 0;
        _this.m_fLineSpace = 0;
        _this.m_bAutoWrap = false;
        _this.m_bAutoSetSize = true;
        _this.m_bPassword = false;
        _this.m_nAlign = dLabel.ALIGN_LEFT;
        _this.m_nFontSize = 16;
        _this.m_nFontColor = 0xffffffff;
        _this.m_bBold = false;
        _this.m_bItalic = false;
        _this.m_nEdgeSize = 0;
        _this.m_nEdgeColor = 0;
        _this.m_bNeedUpdate = false;
        return _this;
    }
    Object.defineProperty(dLabel.prototype, "autoWrap", {
        get: function () {
            return this.m_bAutoWrap;
        },
        set: function (bAutoWrap) {
            if (this.m_bAutoWrap != bAutoWrap) {
                this.m_bAutoWrap = bAutoWrap;
                this.m_bNeedUpdate = true;
            }
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLabel.prototype, "autoSetSize", {
        get: function () {
            return this.m_bAutoSetSize;
        },
        set: function (bAuto) {
            if (this.m_bAutoSetSize != bAuto) {
                this.m_bAutoSetSize = bAuto;
                this.m_bNeedUpdate = true;
            }
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLabel.prototype, "password", {
        get: function () {
            return this.m_bPassword;
        },
        set: function (bPassword) {
            if (this.m_bPassword != bPassword) {
                this.m_bPassword = bPassword;
                this.m_bNeedUpdate = true;
            }
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLabel.prototype, "align", {
        get: function () {
            return this.m_nAlign;
        },
        set: function (type) {
            if (this.m_nAlign != type) {
                this.m_nAlign = type;
                this.m_bNeedUpdate = true;
            }
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLabel.prototype, "text", {
        get: function () {
            return this.GetText();
        },
        set: function (str) {
            this.SetText(str);
        },
        enumerable: false,
        configurable: true
    });
    dLabel.prototype.SetText = function (str) {
        if (this.m_strText != str) {
            this.m_strText = str;
            this.m_bNeedUpdate = true;
        }
    };
    dLabel.prototype.GetText = function () {
        return this.m_strText;
    };
    Object.defineProperty(dLabel.prototype, "lineSpace", {
        get: function () {
            return this.m_fLineSpace;
        },
        set: function (value) {
            if (this.m_fLineSpace != value) {
                this.m_fLineSpace = value;
                this.m_bNeedUpdate = true;
            }
        },
        enumerable: false,
        configurable: true
    });
    dLabel.prototype.SetFontSize = function (size) {
        if (this.m_nFontSize != size) {
            this.m_nFontSize = size;
            this.m_bNeedUpdate = true;
        }
    };
    dLabel.prototype.GetFontSize = function () {
        return this.m_nFontSize;
    };
    Object.defineProperty(dLabel.prototype, "fontSize", {
        get: function () {
            return this.GetFontSize();
        },
        set: function (size) {
            this.SetFontSize(size);
        },
        enumerable: false,
        configurable: true
    });
    dLabel.prototype.SetFontColor = function (color) {
        if (this.m_nFontColor != color) {
            this.m_nFontColor = color;
            this.m_bNeedUpdate = true;
        }
    };
    dLabel.prototype.GetFontColor = function () {
        return this.m_nFontColor;
    };
    Object.defineProperty(dLabel.prototype, "fontColor", {
        get: function () {
            return this.GetFontColor();
        },
        set: function (color) {
            this.SetFontColor(color);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLabel.prototype, "bold", {
        get: function () {
            return this.m_bBold;
        },
        set: function (bBold) {
            if (this.m_bBold != bBold) {
                this.m_bBold = bBold;
                this.m_bNeedUpdate = true;
            }
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLabel.prototype, "italic", {
        get: function () {
            return this.m_bItalic;
        },
        set: function (bItalic) {
            if (this.m_bItalic != bItalic) {
                this.m_bItalic = bItalic;
                this.m_bNeedUpdate = true;
            }
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLabel.prototype, "edgeSize", {
        get: function () {
            return this.m_nEdgeSize;
        },
        set: function (size) {
            if (this.m_nEdgeSize != size) {
                this.m_nEdgeSize = size;
                this.m_bNeedUpdate = true;
            }
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLabel.prototype, "edgeColor", {
        get: function () {
            return this.m_nEdgeColor;
        },
        set: function (color) {
            if (this.m_nEdgeColor != color) {
                this.m_nEdgeColor = color;
                this.m_bNeedUpdate = true;
            }
        },
        enumerable: false,
        configurable: true
    });
    dLabel.prototype.GetWidth = function () {
        if (this.m_bNeedUpdate)
            this.UpdateText();
        return _super.prototype.GetWidth.call(this);
    };
    dLabel.prototype.GetHeight = function () {
        if (this.m_bNeedUpdate)
            this.UpdateText();
        return _super.prototype.GetHeight.call(this);
    };
    dLabel.prototype.UpdateText = function () {
        if (this.m_bNeedUpdate) {
            this.m_bNeedUpdate = false;
            var bmp = this.GetBitmapData();
            if (bmp == null) {
                bmp = new dBitmapData();
                this.SetBitmapData(bmp);
            }
            bmp.FillText(this.m_strText, this.m_nFontSize, this.m_nFontColor, this.m_bBold, this.m_bItalic, this.autoWrap ? this.GetWidth() : -1, this.align, 0, this.m_fWordSpace, this.m_fLineSpace, this.m_nEdgeSize, this.m_nEdgeColor, 0, this.m_nFontSize * dLabel.s_globalFontOffsetY);
            if (this.m_bAutoSetSize)
                this.SetSize(bmp.GetWidth(), bmp.GetHeight());
        }
    };
    dLabel.prototype.PrepareRender = function () {
        if (this.m_bNeedUpdate)
            this.UpdateText();
        _super.prototype.PrepareRender.call(this);
    };
    dLabel.prototype.LoadFromJson = function (j) {
        _super.prototype.LoadFromJson.call(this, j);
        if (j.hasOwnProperty("autoWrap"))
            this.autoWrap = Boolean(dMath.ParseInt(j.autoWrap));
        if (j.hasOwnProperty("fontSize"))
            this.fontSize = dMath.ParseFloat(j.fontSize);
        if (dInterface.ptr.GetLocalLanguage() == dStringUtils.dLANG_CHINESE_SIMPLIFIED && j.hasOwnProperty("text_LANG_CHINESE_SIMPLIFIED"))
            this.text = j.text_LANG_CHINESE_SIMPLIFIED;
        else if (j.hasOwnProperty("text")) {
            if (j.text.indexOf("\\") != -1)
                j.text = dStringUtils.ReplaceAll(j.text, "\\n", "\n");
            this.text = j.text;
        }
        if (j.hasOwnProperty("fontEdgeSize"))
            this.edgeSize = dMath.ParseFloat(j.fontEdgeSize);
        if (j.hasOwnProperty("fontEdgeColor"))
            this.edgeColor = dMath.ParseInt(j.fontEdgeColor);
        if (j.hasOwnProperty("align"))
            this.align = dMath.ParseInt(j.align);
        if (j.hasOwnProperty("bold"))
            this.bold = Boolean(dMath.ParseInt(j.bold));
        if (j.hasOwnProperty("italic"))
            this.italic = Boolean(dMath.ParseInt(j.italic));
        if (j.hasOwnProperty("lineSpace"))
            this.lineSpace = dMath.ParseFloat(j.lineSpace);
    };
    dLabel.autoWrapWithFullWordDefault = false;
    dLabel.ALIGN_LEFT = -1;
    dLabel.ALIGN_CENTER = 0;
    dLabel.ALIGN_RIGHT = 1;
    dLabel.s_globalFontOffsetY = 0;
    return dLabel;
}(dBaseControl));
var dBitmapFont = (function (_super) {
    __extends(dBitmapFont, _super);
    function dBitmapFont() {
        var _this = _super.call(this) || this;
        _this.m_vecImageBuffer = new Array();
        _this.m_arrRect = new Map();
        _this.m_strFileName = "";
        _this.m_pBitmapData = new Array();
        _this.m_strContext = "";
        _this.m_fBlankWidth = dBitmapFont.globalBlankWidth;
        _this.m_fEnterHeight = 16;
        _this.m_nImageVisibleCount = 0;
        _this.m_vecRenderBatch = new Array();
        _this.m_bNeedComputeRenderBatch = false;
        _this.m_matBuffer = new dMatrix();
        _this.m_fOrgSize = 64;
        _this.m_bLoading = 0;
        _this.m_bImageLoading = [0];
        _this.m_vertices = null;
        _this.m_indices = null;
        _this.m_nLineCount = 0;
        _this.m_fileWordSpace = 0;
        _this.maxHeightLessThenFontHeight = false;
        _this.m_bForceRender = true;
        _this.SetMeshData(dSpriteDefaultShader.Instance().m_pStreamMeshData);
        return _this;
    }
    Object.defineProperty(dBitmapFont.prototype, "wordSpace", {
        get: function () {
            if (this.m_fWordSpace == dBitmapFont.globalWordSpace)
                return 0;
            return this.m_fWordSpace;
        },
        set: function (value) {
            if (value == 0)
                value = dBitmapFont.globalWordSpace;
            this.m_fWordSpace = value;
            this.m_bNeedUpdate = true;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dBitmapFont.prototype, "blankWidth", {
        get: function () {
            return this.m_fBlankWidth;
        },
        set: function (value) {
            this.m_fBlankWidth = value;
        },
        enumerable: false,
        configurable: true
    });
    dBitmapFont.prototype.GetFileName = function () {
        return this.m_strFileName;
    };
    Object.defineProperty(dBitmapFont.prototype, "resourceFileName", {
        get: function () {
            return this.GetFileName();
        },
        set: function (fileName) {
            this.LoadFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    dBitmapFont.PreLoadBuffer = function (strImage, onComplete) {
        if (onComplete === void 0) { onComplete = null; }
        var buffer = new dBitmapFont();
        buffer.LoadFromFile(strImage, function () {
            if (onComplete != null)
                onComplete(buffer);
        });
    };
    dBitmapFont.prototype._AddLoadComplete = function (onComplete) {
        if (onComplete) {
            if (!this.m_vecOnLoadComplete)
                this.m_vecOnLoadComplete = new Array();
            this.m_vecOnLoadComplete.push(onComplete);
        }
    };
    dBitmapFont.prototype._DoLoadComplete = function () {
        if (this.m_vecOnLoadComplete) {
            for (var i = 0; i < this.m_vecOnLoadComplete.length; i++)
                this.m_vecOnLoadComplete[i](this);
            this.m_vecOnLoadComplete = null;
        }
    };
    dBitmapFont.prototype.LoadFromFile = function (strImage, onComplete) {
        var _this = this;
        if (onComplete === void 0) { onComplete = null; }
        if (strImage != null && strImage != "" && this.m_strFileName != strImage) {
            this.m_pBitmapData = new Array();
            this.m_strFileName = strImage;
            if (dBitmapFont.s_arrPreloadFontData != null && dBitmapFont.s_arrPreloadFontData.has(strImage)) {
                var buffer = dBitmapFont.s_arrPreloadFontData.get(strImage);
                if (buffer.m_bLoading) {
                    buffer._AddLoadComplete(function () {
                        _this.LoadFromBitmapFont(buffer);
                    });
                    buffer._AddLoadComplete(onComplete);
                }
                else {
                    this.LoadFromBitmapFont(buffer);
                    if (onComplete != null)
                        onComplete(this);
                }
            }
            else {
                if (dBitmapFont.s_arrPreloadFontData == null)
                    dBitmapFont.s_arrPreloadFontData = new Map();
                dBitmapFont.s_arrPreloadFontData.set(strImage, this);
                this._AddLoadComplete(onComplete);
                var arr = new dByteArray();
                this.m_bLoading++;
                arr.LoadFromFile(strImage, function () {
                    _this.m_bLoading--;
                    _this.LoadFromString(arr.ToStringBuffer());
                    _this._DoLoadComplete();
                });
            }
        }
        return this;
    };
    dBitmapFont.prototype.LoadFromBitmapFont = function (from) {
        this.m_strContext = from.m_strContext;
        this.m_arrRect = from.m_arrRect;
        this.m_pBitmapData = from.m_pBitmapData;
        this.m_fEnterHeight = from.m_fEnterHeight;
        this.m_fBlankWidth = from.m_fBlankWidth;
        this.m_fOrgSize = from.m_fOrgSize;
        this.m_bImageLoading = from.m_bImageLoading;
        this.m_fileWordSpace = from.m_fileWordSpace;
        this.m_bNeedUpdate = true;
    };
    dBitmapFont.prototype.LoadFromJsonString = function (str) {
        var _this = this;
        var json = JSON.parse(str);
        this.m_strContext = "";
        var maxIndex = -1;
        if (json.orgSize)
            this.m_fOrgSize = dMath.ParseFloat(json.orgSize);
        if (json.wordSpace)
            this.m_fileWordSpace = dMath.ParseFloat(json.wordSpace);
        var chars = json.chars;
        for (var i = 0, n = chars.length; i < n; i++) {
            var rc = new dBitmapFontTextRect();
            var c = chars[i];
            if (c.x)
                rc.left = dMath.ParseFloat(c.x);
            if (c.y)
                rc.top = dMath.ParseFloat(c.y);
            if (c.w)
                rc.right = dMath.ParseFloat(c.w) + rc.left;
            if (c.h)
                rc.bottom = dMath.ParseFloat(c.h) + rc.top;
            if (c.i)
                rc.bmpIndex = dMath.ParseFloat(c.i);
            if (maxIndex < rc.bmpIndex)
                maxIndex = rc.bmpIndex;
            var code = dMath.ParseInt(c.c);
            this.m_arrRect.set(code, rc);
            this.m_strContext += String.fromCharCode(code);
            if (i == 0 || code == 32) {
                this.m_fEnterHeight = rc.Height();
                this.m_fBlankWidth = rc.Width();
            }
        }
        var split = dStringUtils.SplitFileName(this.m_strFileName);
        if (maxIndex >= 0) {
            this.m_pBitmapData = new Array(maxIndex + 1);
            for (var i = 0; i <= maxIndex; i++) {
                var pBitmapData = new dBitmapData();
                var fileName;
                if (i == 0)
                    fileName = split[0] + split[1] + split[2] + ".png";
                else
                    fileName = split[0] + split[1] + split[2] + "_" + i + ".png";
                this.m_bImageLoading[0]++;
                pBitmapData.LoadFromFile(fileName, function () {
                    _this.m_bImageLoading[0]--;
                });
                this.m_pBitmapData[i] = pBitmapData;
            }
        }
        this.m_bNeedUpdate = true;
    };
    dBitmapFont.prototype.LoadFromString = function (str) {
        var _this = this;
        if (str.charCodeAt(0) == 123)
            return this.LoadFromJsonString(str);
        this.m_strContext = "";
        var index = str.indexOf("FONTGROUP");
        if (index != -1)
            str = str.substring(0, index);
        var split = str.split("\n");
        var maxIndex = -1;
        var bFollowIsChar = false;
        for (var i = 0; i < split.length; i++) {
            var split2 = split[i].split(" ");
            if (bFollowIsChar || split2[0] == "char") {
                bFollowIsChar = true;
                var rc = new dBitmapFontTextRect();
                rc.left = dMath.ParseFloat(split2[2]);
                rc.top = dMath.ParseFloat(split2[3]);
                rc.right = dMath.ParseFloat(split2[4]);
                rc.bottom = dMath.ParseFloat(split2[5]);
                rc.bmpIndex = dMath.ParseFloat(split2[6]);
                if (maxIndex < rc.bmpIndex)
                    maxIndex = rc.bmpIndex;
                var code = dMath.ParseInt(split2[1]);
                this.m_arrRect.set(code, rc);
                this.m_strContext += String.fromCharCode(code);
                if (i == 0 || code == 32) {
                    this.m_fEnterHeight = rc.Height();
                    this.m_fBlankWidth = rc.Width();
                }
            }
            else if (split2[0] == "orgSize") {
                this.m_fOrgSize = dMath.ParseFloat(split2[1]);
            }
            else
                break;
        }
        split = dStringUtils.SplitFileName(this.m_strFileName);
        if (maxIndex >= 0) {
            this.m_pBitmapData = new Array(maxIndex + 1);
            for (var i = 0; i <= maxIndex; i++) {
                var pBitmapData = new dBitmapData();
                var fileName;
                if (i == 0)
                    fileName = split[0] + split[1] + split[2] + ".png";
                else
                    fileName = split[0] + split[1] + split[2] + "_" + i + ".png";
                this.m_bImageLoading[0]++;
                pBitmapData.LoadFromFile(fileName, function () {
                    _this.m_bImageLoading[0]--;
                });
                this.m_pBitmapData[i] = pBitmapData;
            }
        }
        this.m_bNeedUpdate = true;
    };
    dBitmapFont.prototype.SetAnchor = function (u, v) {
        _super.prototype.SetAnchor.call(this, u, v);
        this.m_bNeedUpdate = true;
    };
    dBitmapFont.prototype.UpdateText = function () {
        var a = this;
        if (a.m_bBeginDsc || a.m_bLoading)
            return;
        a.m_bNeedUpdate = false;
        if (a.m_strText == null)
            return;
        if (a.m_strContext == "")
            return;
        var str = a.m_strText;
        var k = 0;
        var max_width = 0;
        if (a.m_bAutoWrap)
            max_width = a.GetWidth();
        var max_height = this.m_nFontSize;
        if (this.maxHeightLessThenFontHeight)
            max_height = 1;
        var x = 0;
        var y = 0;
        var fontScale = a.m_nFontSize / a.m_fOrgSize;
        var lineWidth = new Array();
        for (var i = 0, n = str.length; i < n; i++) {
            var rc = null;
            var code = str.charCodeAt(i);
            if (code == 10) {
                lineWidth.push(x - (a.m_fWordSpace + a.m_fileWordSpace));
                x = 0;
                y += a.m_fEnterHeight * fontScale + a.m_fLineSpace;
            }
            else if (code == 32)
                rc = new dBitmapFontTextRect().SetPosSize(0, 0, a.m_fBlankWidth, 1);
            else {
                if (!a.m_arrRect.has(code))
                    console.log("code not found: " + String.fromCharCode(code) + " in " + dStringUtils.NonNull(a.m_strFileName));
                rc = a.m_arrRect.get(code);
            }
            if (rc == null)
                continue;
            if (a.m_bAutoWrap && x + rc.Width() * fontScale > a.GetWidth()) {
                lineWidth.push(x - (a.m_fWordSpace + a.m_fileWordSpace));
                x = 0;
                y += a.m_fEnterHeight * fontScale + a.m_fLineSpace;
            }
            if (k >= a.m_vecImageBuffer.length) {
                var pImage = new dBitmapFontTextObj();
                pImage.SetAnchor(0, 0);
                a.m_vecImageBuffer.push(pImage);
                pImage.SetColor(a.GetColor());
            }
            var pImage = a.m_vecImageBuffer[k++];
            pImage.SetShow(true);
            if (rc.bmpIndex < a.m_pBitmapData.length)
                pImage.SetBitmapData(a.m_pBitmapData[rc.bmpIndex]);
            pImage.SetSize(rc.Width(), rc.Height());
            pImage.SetPos(x, y);
            pImage.SetScale(fontScale, fontScale);
            pImage.lineIndex = lineWidth.length;
            pImage.rc = rc;
            pImage.code = code;
            pImage.textIndex = i;
            if (!a.m_bAutoWrap) {
                if (max_width < x + rc.Width() * fontScale)
                    max_width = x + rc.Width() * fontScale;
            }
            if (max_height < y + rc.Height() * fontScale)
                max_height = y + rc.Height() * fontScale;
            x += rc.Width() * fontScale + (a.m_fWordSpace + a.m_fileWordSpace);
        }
        lineWidth.push(x - (a.m_fWordSpace + a.m_fileWordSpace));
        if (a.m_bAutoSetSize) {
            if (a.m_bAutoWrap)
                _super.prototype.SetSize.call(this, this.GetWidth(), max_height);
            else
                _super.prototype.SetSize.call(this, max_width, max_height);
        }
        if (a.m_bAutoWrap) {
            if (fontScale == 0)
                max_width = 0;
            else
                max_width = a.GetWidth();
        }
        for (var i = 0; i < k; i++) {
            var pImage = a.m_vecImageBuffer[i];
            var offX = 0;
            if (a.m_nAlign == dLabel.ALIGN_CENTER)
                offX = (max_width - lineWidth[pImage.lineIndex]) / 2;
            else if (a.m_nAlign == dLabel.ALIGN_RIGHT)
                offX = (max_width - lineWidth[pImage.lineIndex]);
            pImage.SetPos(pImage.positionX - max_width * a.anchorU + offX, pImage.positionY - max_height * a.anchorV);
        }
        a.m_nImageVisibleCount = k;
        a.m_bNeedComputeRenderBatch = true;
        a.m_nLineCount = lineWidth.length;
    };
    dBitmapFont.prototype.GetLineCount = function () {
        if (this.m_bNeedUpdate)
            this.UpdateText();
        return this.m_nLineCount;
    };
    dBitmapFont.prototype.GetTextObj = function () {
        if (this.m_bNeedUpdate)
            this.UpdateText();
        return this.m_vecImageBuffer;
    };
    dBitmapFont.prototype.GetTextObjCount = function () {
        if (this.m_bNeedUpdate)
            this.UpdateText();
        return this.m_nImageVisibleCount;
    };
    dBitmapFont.prototype.GetEnterHeight = function () {
        if (this.m_bNeedUpdate)
            this.UpdateText();
        var fontScale = this.m_nFontSize / this.m_fOrgSize;
        return this.m_fEnterHeight * fontScale;
    };
    dBitmapFont.prototype.ComputeRenderBatch = function () {
        var a = this;
        if (a.m_vertices == null || a.m_vertices.length < a.m_nImageVisibleCount * 20)
            a.m_vertices = new Array(a.m_nImageVisibleCount * 20);
        if (a.m_indices == null || a.m_indices.length < a.m_nImageVisibleCount * 6)
            a.m_indices = new Array(a.m_nImageVisibleCount * 6);
        var t_vertices = a.m_vertices;
        var t_indices = a.m_indices;
        var j = 0;
        var lastBmp = null;
        a.m_vecRenderBatch.clear();
        var fontScale = a.m_nFontSize / a.m_fOrgSize;
        for (var i = 0, n = a.m_nImageVisibleCount; i < n; i++, j++) {
            var image = a.m_vecImageBuffer[i];
            if (!image.visible)
                break;
            var bmp = image.GetBitmapData();
            if (bmp == null)
                continue;
            if (lastBmp != null && bmp != lastBmp) {
                a.m_vecRenderBatch.push(new dBitmapFontRenderBatch(lastBmp, t_vertices, j * 4 * 5, t_indices, j * 6));
                j = 0;
            }
            lastBmp = bmp;
            var width = image.GetWidth();
            var height = image.GetHeight();
            var mat2 = a.m_matBuffer.Copy(a.m_matRenderMatrixSelf);
            mat2.Scaling(width / a.GetWidth() * fontScale, height / a.GetHeight() * fontScale, 1);
            mat2.TranslationFast(image.GetPosX() / a.GetWidth() + a.GetAnchorU(), image.GetPosY() / a.GetHeight() + a.GetAnchorV(), 0);
            var t_left = image.rc.left / bmp.GetWidth();
            var t_top = 1 - image.rc.top / bmp.GetHeight();
            var t_right = image.rc.right / bmp.GetWidth();
            var t_bottom = 1 - image.rc.bottom / bmp.GetHeight();
            var index = j * 20;
            t_vertices[index] = 0.0;
            t_vertices[index + 1] = 0.0;
            t_vertices[index + 2] = 0.0;
            t_vertices[index + 3] = t_left;
            t_vertices[index + 4] = t_top;
            t_vertices[index + 5] = 1.0;
            t_vertices[index + 6] = 0.0;
            t_vertices[index + 7] = 0.0;
            t_vertices[index + 8] = t_right;
            t_vertices[index + 9] = t_top;
            t_vertices[index + 10] = 0.0;
            t_vertices[index + 11] = 1.0;
            t_vertices[index + 12] = 0.0;
            t_vertices[index + 13] = t_left;
            t_vertices[index + 14] = t_bottom;
            t_vertices[index + 15] = 1.0;
            t_vertices[index + 16] = 1.0;
            t_vertices[index + 17] = 0.0;
            t_vertices[index + 18] = t_right;
            t_vertices[index + 19] = t_bottom;
            mat2.TransformFloatArray3(t_vertices, index);
            mat2.TransformFloatArray3(t_vertices, index + 5);
            mat2.TransformFloatArray3(t_vertices, index + 10);
            mat2.TransformFloatArray3(t_vertices, index + 15);
            index = j * 6;
            var m = j * 4;
            t_indices[index] = 1 + m;
            t_indices[index + 1] = 0 + m;
            t_indices[index + 2] = 2 + m;
            t_indices[index + 3] = 1 + m;
            t_indices[index + 4] = 2 + m;
            t_indices[index + 5] = 3 + m;
        }
        if (lastBmp != null) {
            a.m_vecRenderBatch.push(new dBitmapFontRenderBatch(lastBmp, t_vertices, j * 4 * 5, t_indices, j * 6));
        }
    };
    dBitmapFont.prototype.SpriteRender = function () {
        if (this.m_nImageVisibleCount <= 0)
            return;
        var a = this;
        if (a.m_bNeedComputeRenderBatch && a.m_bImageLoading[0] == 0) {
            a.m_bNeedComputeRenderBatch = false;
            a.ComputeRenderBatch();
        }
        for (var i = 0; i < a.m_vecRenderBatch.length; i++) {
            var renderBatch = a.m_vecRenderBatch[i];
            a.SetBitmapData(renderBatch.bmp);
            var bAccessWrite = dMeshData.ACCESS_WRITE_TYPE_STREAM_DRAW;
            dSpriteDefaultShader.Instance().m_pStreamMeshData.SetData(null, renderBatch.vertices.length / 5, renderBatch.indices, dSpriteDefaultShader.Instance().m_vertexDecl, bAccessWrite, renderBatch.vertices, renderBatch.indices.length);
            _super.prototype.SpriteRender.call(this);
        }
    };
    dBitmapFont.prototype.LoadFromJson = function (j) {
        _super.prototype.LoadFromJson.call(this, j);
        if (j.hasOwnProperty("resourceFileName"))
            this.resourceFileName = j.resourceFileName;
        if (j.hasOwnProperty("wordSpace"))
            this.wordSpace = dMath.ParseFloat(j.wordSpace);
        if (j.hasOwnProperty("lineSpace"))
            this.lineSpace = dMath.ParseFloat(j.lineSpace);
    };
    dBitmapFont.globalWordSpace = 0;
    dBitmapFont.globalBlankWidth = 10;
    dBitmapFont.m_vertices = null;
    dBitmapFont.m_indices = null;
    dBitmapFont.s_arrPreloadFontData = null;
    return dBitmapFont;
}(dLabel));
var dBitmapFontTextRect = (function (_super) {
    __extends(dBitmapFontTextRect, _super);
    function dBitmapFontTextRect() {
        var _this = _super.call(this) || this;
        _this.bmpIndex = 0;
        return _this;
    }
    return dBitmapFontTextRect;
}(dRect));
var dBitmapFontTextObj = (function (_super) {
    __extends(dBitmapFontTextObj, _super);
    function dBitmapFontTextObj() {
        var _this = _super.call(this) || this;
        _this.lineIndex = 0;
        _this.textIndex = 0;
        _this.rc = null;
        _this.code = 0;
        return _this;
    }
    return dBitmapFontTextObj;
}(dImage));
var dBitmapFontRenderBatch = (function () {
    function dBitmapFontRenderBatch(bmp, vertices, verCount, indices, indexCount) {
        this.bmp = bmp;
        this.vertices = new Array(verCount);
        for (var i = 0; i < verCount; i++)
            this.vertices[i] = vertices[i];
        this.indices = new Array(indexCount);
        for (var i = 0; i < indexCount; i++)
            this.indices[i] = indices[i];
    }
    return dBitmapFontRenderBatch;
}());
var dButtonContainer = (function (_super) {
    __extends(dButtonContainer, _super);
    function dButtonContainer() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    dButtonContainer.prototype.AddChild = function (pChild, at) {
        if (at === void 0) { at = -1; }
        _super.prototype.AddChild.call(this, pChild, at);
        this.UpdateImage();
    };
    dButtonContainer.prototype.RemoveChild = function (pChild) {
        _super.prototype.RemoveChild.call(this, pChild);
        this.UpdateImage();
    };
    dButtonContainer.prototype.RemoveAllChild = function () {
        _super.prototype.RemoveAllChild.call(this);
        this.UpdateImage();
    };
    dButtonContainer.prototype.UpdateImage = function () {
        var vec = this.GetChildList();
        this.m_pNormal = this.m_pTouchDown = this.m_pDisable = null;
        if (vec.length > 0)
            this.m_pNormal = vec[0];
        if (vec.length > 1)
            this.m_pTouchDown = vec[1];
        if (vec.length > 2)
            this.m_pDisable = vec[2];
    };
    return dButtonContainer;
}(dButton));
var dCheckBox = (function (_super) {
    __extends(dCheckBox, _super);
    function dCheckBox() {
        var _this = _super.call(this) || this;
        _this.m_pCheckImage = null;
        _this.m_pUnCheckImage = null;
        _this.m_vecLoadingCallback = null;
        _this.m_vecLoadingCheckCallback = null;
        _this.SetHandleMouse(true);
        _this.CreateCheckImage();
        return _this;
    }
    dCheckBox.prototype.CreateCheckImage = function () {
        this.m_pCheckImage = new dImage();
        this.m_pUnCheckImage = new dImage();
        this.AddChild(this.m_pCheckImage);
        this.AddChild(this.m_pUnCheckImage);
    };
    dCheckBox.prototype.OnTouchUp = function (x, y) {
        if (this.isEnable()) {
            this.SetCheck(!this.isCheck());
            if (this.m_pEvent != null)
                this.m_pEvent.OnCheck(this);
        }
    };
    dCheckBox.prototype.SetSize = function (w, h) {
        _super.prototype.SetSize.call(this, w, h);
    };
    dCheckBox.prototype.LoadFromFile = function (strUncheckedImageName, onComplete) {
        var _this = this;
        if (onComplete === void 0) { onComplete = null; }
        if (this.m_pUnCheckImage != null && this.m_pUnCheckImage.resourceFileName != strUncheckedImageName) {
            if (onComplete) {
                if (!this.m_vecLoadingCallback)
                    this.m_vecLoadingCallback = new Array();
                this.m_vecLoadingCallback.push(onComplete);
            }
            this.m_pUnCheckImage.LoadFromFile(strUncheckedImageName, function () {
                _this.SetSize(dMath.Max(_this.m_pCheckImage.width, _this.m_pUnCheckImage.width), dMath.Max(_this.m_pCheckImage.height, _this.m_pUnCheckImage.height));
                if (_this.m_vecLoadingCallback) {
                    for (var i = 0; i < _this.m_vecLoadingCallback.length; i++)
                        _this.m_vecLoadingCallback[i](_this);
                    _this.m_vecLoadingCallback = null;
                }
            });
        }
        else {
            if (onComplete) {
                if (this.m_vecLoadingCallback)
                    this.m_vecLoadingCallback.push(onComplete);
                else
                    onComplete(this);
            }
        }
        return this;
    };
    dCheckBox.prototype.LoadCheckFromFile = function (strCheckedImageName, onComplete) {
        var _this = this;
        if (onComplete === void 0) { onComplete = null; }
        if (this.m_pCheckImage != null && this.m_pCheckImage.resourceFileName != strCheckedImageName) {
            if (onComplete) {
                if (!this.m_vecLoadingCheckCallback)
                    this.m_vecLoadingCheckCallback = new Array();
                this.m_vecLoadingCheckCallback.push(onComplete);
            }
            this.m_pCheckImage.LoadFromFile(strCheckedImageName, function () {
                _this.SetSize(dMath.Max(_this.m_pCheckImage.width, _this.m_pUnCheckImage.width), dMath.Max(_this.m_pCheckImage.height, _this.m_pUnCheckImage.height));
                if (_this.m_vecLoadingCheckCallback) {
                    for (var i = 0; i < _this.m_vecLoadingCheckCallback.length; i++)
                        _this.m_vecLoadingCheckCallback[i](_this);
                    _this.m_vecLoadingCheckCallback = null;
                }
            });
        }
        else {
            if (onComplete) {
                if (this.m_vecLoadingCheckCallback)
                    this.m_vecLoadingCheckCallback.push(onComplete);
                else
                    onComplete(this);
            }
        }
        return this;
    };
    dCheckBox.prototype.GetFileName = function () {
        if (this.m_pUnCheckImage == null)
            return "";
        return this.m_pUnCheckImage.GetFileName();
    };
    dCheckBox.prototype.GetCheckFileName = function () {
        if (this.m_pCheckImage == null)
            return "";
        return this.m_pCheckImage.GetFileName();
    };
    dCheckBox.prototype.SetCheck = function (bCheck) {
        if (this.m_pCheckImage != null)
            this.m_pCheckImage.SetShow(bCheck);
        if (this.m_pUnCheckImage != null)
            this.m_pUnCheckImage.SetShow(!bCheck);
        if (this.GetParent() instanceof dCheckBoxGroup) {
            if (bCheck)
                this.GetParent().OnCheck(this);
            else if (this.GetParent().GetChecked() == null)
                this.SetCheck(true);
        }
    };
    dCheckBox.prototype.UpdateCheck = function () {
        this.SetCheck(this.isCheck());
    };
    dCheckBox.prototype.SetColor = function (colorARGB, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        if (this.m_pCheckImage != null)
            this.m_pCheckImage.SetColor(colorARGB, bSetToChild);
        if (this.m_pUnCheckImage != null)
            this.m_pUnCheckImage.SetColor(colorARGB, bSetToChild);
        _super.prototype.SetColor.call(this, colorARGB, bSetToChild);
    };
    dCheckBox.prototype.SetAlpha = function (alpha, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        if (this.m_pCheckImage != null)
            this.m_pCheckImage.SetAlpha(alpha, bSetToChild);
        if (this.m_pUnCheckImage != null)
            this.m_pUnCheckImage.SetAlpha(alpha, bSetToChild);
        _super.prototype.SetAlpha.call(this, alpha, bSetToChild);
    };
    dCheckBox.prototype.isCheck = function () {
        if (this.m_pCheckImage == null)
            return false;
        return this.m_pCheckImage.isShow();
    };
    Object.defineProperty(dCheckBox.prototype, "check", {
        get: function () {
            return this.isCheck();
        },
        set: function (bCheck) {
            this.SetCheck(bCheck);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dCheckBox.prototype, "resourceFileName", {
        get: function () {
            return this.GetFileName();
        },
        set: function (fileName) {
            this.LoadFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dCheckBox.prototype, "checkImage", {
        get: function () {
            return this.GetCheckFileName();
        },
        set: function (fileName) {
            this.LoadCheckFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    dCheckBox.prototype.AddChild = function (pChild, at) {
        if (at === void 0) { at = -1; }
        _super.prototype.AddChild.call(this, pChild, at);
        this.UpdateCheck();
    };
    dCheckBox.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("resourceFileName"))
            this.resourceFileName = json.resourceFileName;
        if (json.hasOwnProperty("checkImage"))
            this.checkImage = json.checkImage;
        if (json.hasOwnProperty("check"))
            this.check = Boolean(dMath.ParseInt(json.check));
    };
    return dCheckBox;
}(dBaseControl));
var dCheckBoxContainer = (function (_super) {
    __extends(dCheckBoxContainer, _super);
    function dCheckBoxContainer() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    dCheckBoxContainer.prototype.SetCheck = function (bCheck) {
        var vecChild = this.GetChildList();
        if (vecChild.length >= 4) {
            vecChild[2].visible = bCheck;
            vecChild[3].visible = !bCheck;
        }
        _super.prototype.SetCheck.call(this, bCheck);
    };
    return dCheckBoxContainer;
}(dCheckBox));
var dCheckBoxGroup = (function (_super) {
    __extends(dCheckBoxGroup, _super);
    function dCheckBoxGroup() {
        var _this = _super.call(this) || this;
        _this.m_bDoingSetCheck = false;
        return _this;
    }
    dCheckBoxGroup.prototype.OnCheck = function (checkBox) {
        if (this.m_bDoingSetCheck)
            return;
        this.m_bDoingSetCheck = true;
        var vecChild = this.GetChildList();
        for (var i = 0; i < vecChild.length; i++) {
            if (vecChild[i] instanceof dCheckBox) {
                vecChild[i].SetCheck(vecChild[i] == checkBox);
            }
        }
        this.m_bDoingSetCheck = false;
    };
    dCheckBoxGroup.prototype.GetChecked = function () {
        var vecChild = this.GetChildList();
        for (var i = 0; i < vecChild.length; i++) {
            if (vecChild[i] instanceof dCheckBox && vecChild[i].isCheck()) {
                return vecChild[i];
            }
        }
        return null;
    };
    return dCheckBoxGroup;
}(dBaseControl));
var dCheckBoxScale9 = (function (_super) {
    __extends(dCheckBoxScale9, _super);
    function dCheckBoxScale9() {
        return _super.call(this) || this;
    }
    dCheckBoxScale9.prototype.CreateCheckImage = function () {
        this.m_pCheckImage = new dScale9();
        this.m_pUnCheckImage = new dScale9();
        this.AddChild(this.m_pCheckImage);
        this.AddChild(this.m_pUnCheckImage);
    };
    return dCheckBoxScale9;
}(dCheckBox));
var dControlLoader = (function () {
    function dControlLoader() {
    }
    dControlLoader.SetOnCreateConsole = function (onCreateConsole) {
        dControlLoader.s_onCreateConsole = onCreateConsole;
    };
    dControlLoader.CreateUIByJson = function (p, json, root, rootName) {
        if (root === void 0) { root = null; }
        if (rootName === void 0) { rootName = ""; }
        if (!root)
            root = p;
        var classType = json.classType;
        if (!p) {
            switch (classType) {
                case "dSprite":
                    p = new dBaseControl();
                    break;
                case "dAnimationImage":
                    p = new dAnimationImage();
                    break;
                case "dBitmapFont":
                    p = new dBitmapFont();
                    break;
                case "dButton":
                    p = new dButton();
                    break;
                case "dButtonContainer":
                    p = new dButtonContainer();
                    break;
                case "dButtonScale9":
                    p = new dButtonScale9();
                    break;
                case "dCheckBox":
                    p = new dCheckBox();
                    break;
                case "dCheckBoxContainer":
                    p = new dCheckBoxContainer();
                    break;
                case "dCheckBoxGroup":
                    p = new dCheckBoxGroup();
                    break;
                case "dCheckBoxScale9":
                    p = new dCheckBoxScale9();
                    break;
                case "dImage":
                    p = new dImage();
                    break;
                case "dInputBox":
                    p = new dInputBox();
                    break;
                case "dLabel":
                    p = new dLabel();
                    break;
                case "dLayoutHBox":
                    p = new dLayoutHBox();
                    break;
                case "dLayoutVBox":
                    p = new dLayoutVBox();
                    break;
                case "dLayoutLimitScale":
                    p = new dLayoutLimitScale();
                    break;
                case "dLine":
                    p = new dLine();
                    break;
                case "dListBox":
                    p = new dListBox();
                    break;
                case "dListBoxPageView":
                    p = new dListBoxPageView();
                    break;
                case "dMover":
                    p = new dMover();
                    break;
                case "dProgress":
                    p = new dProgress();
                    break;
                case "dRepeatImage":
                    p = new dRepeatImage();
                    break;
                case "dScale9":
                    p = new dScale9();
                    break;
                case "dScrollView":
                    p = new dScrollView();
                    break;
                case "dTabView":
                    p = new dTabView();
                    break;
                default:
                    {
                        if (dControlLoader.s_onCreateConsole) {
                            p = dControlLoader.s_onCreateConsole(classType);
                        }
                        if (!p) {
                            console.log("class not found " + classType);
                        }
                    }
            }
        }
        if (p) {
            p.LoadFromJson(json);
            if (json.hasOwnProperty("_child")) {
                var child = json._child;
                for (var i = 0, n = child.length; i < n; i++) {
                    var className = child[i].className;
                    var rootName2 = "";
                    if (rootName != "")
                        rootName2 = rootName + "_" + className;
                    else
                        rootName2 = className;
                    var p2 = dControlLoader.CreateUIByJson(null, child[i], root, rootName2);
                    if (p2) {
                        p.AddChild(p2);
                        if (className) {
                            p2.spriteName = className;
                            root[rootName2] = p2;
                        }
                    }
                }
            }
            if (json.hasOwnProperty("_linkChild")) {
                var linkChilds = json._linkChild.split(",");
                for (var i = 0, n = linkChilds.length; i < n; i += 2) {
                    var p1 = p.FindChild(linkChilds[i]);
                    var p2 = p.FindChild(linkChilds[i + 1]);
                    if (p1 && p2) {
                        p1.AddLinkSprite(p2);
                    }
                }
            }
            if (p != root && json.hasOwnProperty("_frames") && json["_frames"]) {
                var frames = json["_frames"];
                var maxFrame = 0;
                for (var i = 0; i < frames.length; i++) {
                    if (maxFrame < frames[i].frame + 1)
                        maxFrame = frames[i].frame + 1;
                }
                if (maxFrame == frames.length) {
                }
                else {
                    var frames2 = new Array();
                    frames2.resize(maxFrame);
                    for (var i = 0; i < frames.length; i++)
                        frames2[frames[i].frame] = frames[i];
                    for (var i = 0; i < maxFrame; i++) {
                        if (frames2[i] == null) {
                            frames2[i] = dControlLoader._CreateSpriteFrame();
                            frames2[i].frame = i;
                        }
                    }
                    for (var i = 0; i < maxFrame; i++) {
                        if (frames2[i] == null)
                            frames2[i] = dControlLoader._CreateSpriteFrame();
                        dControlLoader.LerpKey(p, frames2, i, 0xFFFFFFFF, maxFrame);
                    }
                    frames = frames2;
                }
                for (var i = 0; i < frames.length; i++) {
                    var frameData = frames[i];
                    frameData.x += p.positionX;
                    frameData.y += p.positionY;
                    frameData.z += p.positionZ;
                    frameData.rx += p.rotationX;
                    frameData.ry += p.rotationY;
                    frameData.rz += p.rotation;
                    frameData.sx *= p.scaleX;
                    frameData.sy *= p.scaleY;
                    frameData.sz *= p.scaleZ;
                }
                p.SetFrameDataList(frames);
            }
            if (json.hasOwnProperty("editor____customKeyValue")) {
                var keyValue = dStringUtils.SplitStringEquals(json["editor____customKeyValue"]);
                if (!p.userData)
                    p.userData = {};
                p.userData[keyValue[0]] = keyValue[1];
            }
        }
        return p;
    };
    dControlLoader._CreateSpriteFrame = function () {
        return {
            frame: 0,
            majorKey: 0,
            aniName: "default",
            alpha: 0,
            x: 0,
            y: 0,
            z: 0,
            rz: 0,
            rx: 0,
            ry: 0,
            sx: 1,
            sy: 1,
            sz: 1,
            spriteColor: 0xffffffff,
            spriteFrame: 0,
            visible: 1
        };
    };
    dControlLoader.LerpAngle = function (from, to, lerp) {
        if (from - to >= 180)
            return dMath.Lerp(from - 360.0, to, lerp);
        else
            return dMath.Lerp(from, to, lerp);
    };
    dControlLoader.LerpKey = function (firstKey, arrKeyFrameData, start, majoy_mask, maxFrame) {
        var prev = null;
        var next = null;
        var prevIndex = 0;
        var nextIndex = 0;
        for (var i = start; i >= 0; i--) {
            var key = arrKeyFrameData[i];
            if (key.majorKey & majoy_mask) {
                prev = key;
                prevIndex = i;
                break;
            }
        }
        for (var i = start; i < maxFrame; i++) {
            var key = arrKeyFrameData[i];
            if (key.majorKey & majoy_mask) {
                next = key;
                nextIndex = i;
                break;
            }
        }
        var zero = dControlLoader._CreateSpriteFrame();
        if (prev == null) {
            prev = zero;
            prevIndex = 0;
        }
        if (next == null) {
            next = prev;
            nextIndex = prevIndex;
        }
        var lerp = 0.0;
        if (nextIndex != prevIndex)
            lerp = (start - prevIndex) / (nextIndex - prevIndex);
        {
            arrKeyFrameData[start].x = dMath.Lerp(prev.x + firstKey.positionX, next.x + firstKey.positionX, lerp) - firstKey.positionX;
            arrKeyFrameData[start].y = dMath.Lerp(prev.y + firstKey.positionY, next.y + firstKey.positionY, lerp) - firstKey.positionY;
            arrKeyFrameData[start].z = dMath.Lerp(prev.z + firstKey.positionZ, next.z + firstKey.positionZ, lerp) - firstKey.positionZ;
        }
        {
            arrKeyFrameData[start].sx = dMath.Lerp(prev.sx * firstKey.scaleX, next.sx * firstKey.scaleX, lerp) / firstKey.scaleX;
            arrKeyFrameData[start].sy = dMath.Lerp(prev.sy * firstKey.scaleY, next.sy * firstKey.scaleY, lerp) / firstKey.scaleY;
            arrKeyFrameData[start].sz = dMath.Lerp(prev.sz * firstKey.scaleZ, next.sz * firstKey.scaleZ, lerp) / firstKey.scaleZ;
        }
        {
            arrKeyFrameData[start].rx = dControlLoader.LerpAngle(prev.rx + firstKey.rotationX, next.rx + firstKey.rotationX, lerp) - firstKey.rotationX;
            arrKeyFrameData[start].ry = dControlLoader.LerpAngle(prev.ry + firstKey.rotationY, next.ry + firstKey.rotationY, lerp) - firstKey.rotationY;
            arrKeyFrameData[start].rz = dControlLoader.LerpAngle(prev.rz + firstKey.rotation, next.rz + firstKey.rotation, lerp) - firstKey.rotation;
        }
        {
            arrKeyFrameData[start].spriteColor = prev.spriteColor;
        }
        {
            arrKeyFrameData[start].spriteFrame = prev.spriteFrame;
        }
        {
            arrKeyFrameData[start].visible = prev.visible;
        }
        {
        }
        {
            arrKeyFrameData[start].alpha = dMath.Lerp(prev.alpha, next.alpha, lerp);
        }
    };
    dControlLoader.s_onCreateConsole = null;
    return dControlLoader;
}());
var dEvent = (function (_super) {
    __extends(dEvent, _super);
    function dEvent() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.m_onButtonDown = null;
        _this.m_onButtonUp = null;
        _this.m_onButtonUpOutside = null;
        _this.m_onScroll = null;
        _this.m_onInputBegin = null;
        _this.m_onInput = null;
        _this.m_onCheck = null;
        _this.m_onListShowView = null;
        _this.m_onListShowViewEnd = null;
        _this.m_onListShowVirtualChild = null;
        _this.m_onScrollViewTouchDownToChild = null;
        _this.m_onScrollViewTouchUpToChild = null;
        _this.m_onScrollViewPosChanged = null;
        _this.m_onSliderValueChanging = null;
        _this.m_onSliderValueChangeFinished = null;
        _this.m_onUpdateLayout = null;
        return _this;
    }
    dEvent.prototype.OnButtonDown = function (sender) {
        if (this.m_onButtonDown)
            this.m_onButtonDown(sender);
    };
    dEvent.prototype.OnButtonUp = function (sender) {
        if (this.m_onButtonUp)
            this.m_onButtonUp(sender);
    };
    dEvent.prototype.OnButtonUpOutside = function (sender) {
        if (this.m_onButtonUpOutside)
            this.m_onButtonUpOutside(sender);
    };
    dEvent.prototype.OnScroll = function (sender) {
        if (this.m_onScroll)
            this.m_onScroll(sender);
    };
    dEvent.prototype.OnInputBegin = function (sender) {
        if (this.m_onInputBegin)
            this.m_onInputBegin(sender);
    };
    dEvent.prototype.OnInput = function (sender) {
        if (this.m_onInput)
            this.m_onInput(sender);
    };
    dEvent.prototype.OnCheck = function (sender) {
        if (this.m_onCheck)
            this.m_onCheck(sender);
    };
    dEvent.prototype.OnListShowView = function (sender) {
        if (this.m_onListShowView)
            this.m_onListShowView(sender);
    };
    dEvent.prototype.OnListShowViewEnd = function (sender) {
        if (this.m_onListShowViewEnd)
            this.m_onListShowViewEnd(sender);
    };
    dEvent.prototype.OnListShowVirtualChild = function (sender, childIndex, virtualIndex) {
        if (this.m_onListShowVirtualChild)
            this.m_onListShowVirtualChild(sender, childIndex, virtualIndex);
    };
    dEvent.prototype.OnScrollViewTouchDownToChild = function (child) {
        if (this.m_onScrollViewTouchDownToChild)
            return this.m_onScrollViewTouchDownToChild(child);
        return false;
    };
    dEvent.prototype.OnScrollViewTouchUpToChild = function (child) {
        if (this.m_onScrollViewTouchUpToChild)
            this.m_onScrollViewTouchUpToChild(child);
        return false;
    };
    dEvent.prototype.OnScrollViewPosChanged = function (child) {
        if (this.m_onScrollViewPosChanged)
            this.m_onScrollViewPosChanged(child);
    };
    dEvent.prototype.OnSliderValueChanging = function (sender) {
        if (this.m_onSliderValueChanging)
            this.m_onSliderValueChanging(sender);
    };
    dEvent.prototype.OnSliderValueChangeFinished = function (sender) {
        if (this.m_onSliderValueChangeFinished)
            this.m_onSliderValueChangeFinished(sender);
    };
    dEvent.prototype.OnUpdateLayout = function (sender) {
        if (this.m_onUpdateLayout)
            this.m_onUpdateLayout(sender);
    };
    dEvent.prototype.SetOnButtonDown = function (callback) {
        this.m_onButtonDown = callback;
        return this;
    };
    dEvent.prototype.SetOnButtonUp = function (callback) {
        this.m_onButtonUp = callback;
        return this;
    };
    dEvent.prototype.SetOnButtonUpOutside = function (callback) {
        this.m_onButtonUpOutside = callback;
        return this;
    };
    dEvent.prototype.SetOnScroll = function (callback) {
        this.m_onScroll = callback;
        return this;
    };
    dEvent.prototype.SetOnInputBegin = function (callback) {
        this.m_onInputBegin = callback;
        return this;
    };
    dEvent.prototype.SetOnInput = function (callback) {
        this.m_onInput = callback;
        return this;
    };
    dEvent.prototype.SetOnCheck = function (callback) {
        this.m_onCheck = callback;
        return this;
    };
    dEvent.prototype.SetOnListShowView = function (callback) {
        this.m_onListShowView = callback;
        return this;
    };
    dEvent.prototype.SetOnListShowViewEnd = function (callback) {
        this.m_onListShowViewEnd = callback;
        return this;
    };
    dEvent.prototype.SetOnListShowVirtualChild = function (callback) {
        this.m_onListShowVirtualChild = callback;
        return this;
    };
    dEvent.prototype.SetOnScrollViewTouchDownToChild = function (callback) {
        this.m_onScrollViewTouchDownToChild = callback;
        return this;
    };
    dEvent.prototype.SetOnScrollViewTouchUpToChild = function (callback) {
        this.m_onScrollViewTouchUpToChild = callback;
        return this;
    };
    dEvent.prototype.SetOnScrollViewPosChanged = function (callback) {
        this.m_onScrollViewPosChanged = callback;
        return this;
    };
    dEvent.prototype.SetOnSliderValueChanging = function (callback) {
        this.m_onSliderValueChanging = callback;
        return this;
    };
    dEvent.prototype.SetOnSliderValueChangeFinished = function (callback) {
        this.m_onSliderValueChangeFinished = callback;
        return this;
    };
    dEvent.prototype.SetOnUpdateLayout = function (callback) {
        this.m_onUpdateLayout = callback;
        return this;
    };
    return dEvent;
}(dObject));
var dInputBox = (function (_super) {
    __extends(dInputBox, _super);
    function dInputBox() {
        var _this = _super.call(this) || this;
        _this.m_pLabel = new dLabel();
        _this.m_bMultiLine = false;
        _this.m_nAlignVertical = dLabel.ALIGN_CENTER;
        _this.m_nAlignHorizontal = dLabel.ALIGN_LEFT;
        _this.m_nMaxLength = 0;
        _this.m_strDefaultText = "";
        _this.SetHandleMouse(true);
        _this.m_pLabel.SetAnchor(0, 0);
        _this.SetClipChild(true);
        _this.AddChild(_this.m_pLabel);
        return _this;
    }
    dInputBox.prototype.GetText = function () {
        var ret = this.m_pLabel.GetText();
        if (ret == this.m_strDefaultText)
            ret = "";
        return ret;
    };
    dInputBox.prototype.SetText = function (str) {
        if (str == "") {
            str = this.m_strDefaultText;
            this.m_pLabel.alpha = 0.5;
        }
        else {
            this.m_pLabel.alpha = 1;
        }
        this.m_pLabel.SetText(str);
        this._UpdateText();
    };
    dInputBox.prototype.SetDefaultText = function (str) {
        this.m_strDefaultText = str;
        this.SetText(this.GetText());
    };
    Object.defineProperty(dInputBox.prototype, "text", {
        get: function () {
            return this.GetText();
        },
        set: function (v) {
            this.SetText(v);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dInputBox.prototype, "autoWrap", {
        get: function () {
            return this.m_pLabel.autoWrap;
        },
        set: function (bAutoWrap) {
            this.m_pLabel.autoWrap = bAutoWrap;
            if (bAutoWrap)
                this.m_pLabel.SetSize(this.GetWidth(), this.GetHeight());
            this.m_pLabel.UpdateText();
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dInputBox.prototype, "password", {
        get: function () {
            return this.m_pLabel.password;
        },
        set: function (bPassword) {
            this.m_pLabel.password = bPassword;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dInputBox.prototype, "alignVertical", {
        get: function () {
            return this.m_nAlignVertical;
        },
        set: function (type) {
            this.m_nAlignVertical = type;
            this._UpdateText();
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dInputBox.prototype, "alignHorizontal", {
        get: function () {
            return this.m_nAlignHorizontal;
        },
        set: function (type) {
            this.m_nAlignHorizontal = type;
            this._UpdateText();
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dInputBox.prototype, "multiLine", {
        get: function () {
            return this.m_bMultiLine;
        },
        set: function (bMulti) {
            this.m_bMultiLine = bMulti;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dInputBox.prototype, "maxLength", {
        get: function () {
            return this.m_nMaxLength;
        },
        set: function (len) {
            this.m_nMaxLength = len;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dInputBox.prototype, "fontSize", {
        get: function () {
            return this.m_pLabel.fontSize;
        },
        set: function (v) {
            this.m_pLabel.fontSize = v;
        },
        enumerable: false,
        configurable: true
    });
    dInputBox.prototype.SetColor = function (color, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetColor.call(this, color);
        this.m_pLabel.SetColor(color, bSetToChild);
    };
    dInputBox.prototype.SetAlpha = function (alpha, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetAlpha.call(this, alpha);
        this.m_pLabel.SetAlpha(alpha);
    };
    dInputBox.prototype.SetSize = function (w, h) {
        if (this.GetWidth() != w || this.GetHeight() != h) {
            _super.prototype.SetSize.call(this, w, h);
            this.m_pLabel.SetSize(w, h);
            this._UpdateText();
        }
    };
    dInputBox.prototype.OnTouchDown = function (x, y, delta) {
        if (this.m_onTouchEvent != null)
            this.m_onTouchEvent.OnTouchDown(x, y, delta);
        else {
            if (this.isEnable())
                this.SetFocus();
        }
    };
    dInputBox.prototype.SetFocus = function () {
        var _this = this;
        if (this.m_pEvent != null)
            this.m_pEvent.OnInputBegin(this);
        var flag = 0;
        if (this.m_bMultiLine)
            flag |= dSprite.INPUTBOX_STYLE_CANENTERLINE;
        if (this.autoWrap)
            flag |= dSprite.INPUBBOX_STYPE_AUTOENTERLINE;
        if (this.password)
            flag |= dSprite.INPUTBOX_STYLE_PASSWORD;
        var strText = this.GetText();
        var mat = this.GetMatrixWorld();
        var pos = new dVector3(-this.width * this.anchorU, -this.height * this.anchorV);
        pos.Transform(mat);
        var size = new dVector3(this.width, this.height, 0);
        mat._41 = mat._42 = mat._43 = 0;
        size.Transform(mat);
        this.m_pLabel.visible = false;
        dSprite.s_pCurrentInputingBox = this;
        dInterface.ptr.ShowInputBox(strText, pos.x, pos.y, size.x, size.y, this.m_pLabel.GetColor(), this.m_pLabel.GetFontSize() * mat._11, this.m_nMaxLength, this.m_bMultiLine, function (inputText) {
            dSprite.s_pCurrentInputingBox = null;
            _this.m_pLabel.visible = true;
            if (!_this.m_bMultiLine && inputText.charAt(inputText.length - 1) == "\n")
                inputText = inputText.substring(0, inputText.length - 1);
            _this.SetText(inputText);
            if (_this.m_pEvent != null)
                _this.m_pEvent.OnInput(_this);
        }, function () {
            dSprite.s_pCurrentInputingBox = null;
            _this.m_pLabel.visible = true;
            _this.SetText(strText);
        });
    };
    dInputBox.prototype._UpdateText = function () {
        if (this.m_bBeginDsc || this.m_pLabel == null)
            return;
        var xoff = 0;
        var yoff = 0;
        if (this.m_nAlignHorizontal == dLabel.ALIGN_CENTER)
            xoff = (this.GetWidth() - this.m_pLabel.GetWidth()) / 2;
        else if (this.m_nAlignHorizontal == dLabel.ALIGN_RIGHT)
            xoff = this.GetWidth() - this.m_pLabel.GetWidth();
        if (this.m_nAlignVertical == dLabel.ALIGN_CENTER)
            yoff = (this.GetHeight() - this.m_pLabel.GetHeight()) / 2;
        else if (this.m_nAlignVertical == dLabel.ALIGN_RIGHT)
            yoff = this.GetHeight() - this.m_pLabel.GetHeight();
        this.m_pLabel.SetPos(-this.GetWidth() * this.GetAnchorU() + xoff, -this.GetHeight() * this.GetAnchorV() + yoff);
    };
    dInputBox.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("text"))
            this.text = json.text;
        if (json.hasOwnProperty("fontSize"))
            this.fontSize = json.fontSize;
        if (json.hasOwnProperty("alignVertical"))
            this.alignVertical = json.alignVertical;
        if (json.hasOwnProperty("alignHorizontal"))
            this.alignHorizontal = json.alignHorizontal;
        if (json.hasOwnProperty("password"))
            this.password = Boolean(dMath.ParseInt(json.password));
        if (json.hasOwnProperty("autoWrap"))
            this.autoWrap = Boolean(dMath.ParseInt(json.autoWrap));
    };
    return dInputBox;
}(dLabel));
var dLayoutHBox = (function (_super) {
    __extends(dLayoutHBox, _super);
    function dLayoutHBox() {
        var _this = _super.call(this) || this;
        _this.m_bNeedUpdate = false;
        _this.m_nAlignType = dLabel.ALIGN_CENTER;
        _this.m_fSpace = 10;
        _this.m_bSpaceAverage = false;
        _this.m_pResizeEvent = null;
        _this.m_pResizeEvent = new dSprite();
        _this.m_pResizeEvent.SetSize = function (w, h) {
            _this.m_bNeedUpdate = true;
        };
        _this.m_pResizeEvent.SetScale = function (x, y) {
            _this.m_bNeedUpdate = true;
        };
        _this.m_pResizeEvent.SetPos = function (x, y) {
            _this.m_bNeedUpdate = true;
        };
        return _this;
    }
    dLayoutHBox.prototype.AddChild = function (pChild, at) {
        if (at === void 0) { at = -1; }
        _super.prototype.AddChild.call(this, pChild, at);
        pChild.SetTouchEvent(this.m_pResizeEvent);
        this.m_bNeedUpdate = true;
    };
    dLayoutHBox.prototype.RemoveChild = function (pChild) {
        _super.prototype.RemoveChild.call(this, pChild);
        pChild.SetTouchEvent(null);
        this.m_bNeedUpdate = true;
    };
    dLayoutHBox.prototype.SetSize = function (w, h) {
        this.m_bNeedUpdate = true;
        _super.prototype.SetSize.call(this, w, h);
    };
    dLayoutHBox.prototype.SetAlignType = function (type) {
        this.m_nAlignType = type;
        this.m_bNeedUpdate = true;
    };
    dLayoutHBox.prototype.GetAlignType = function () {
        return this.m_nAlignType;
    };
    Object.defineProperty(dLayoutHBox.prototype, "alignType", {
        get: function () {
            return this.GetAlignType();
        },
        set: function (type) {
            this.SetAlignType(type);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLayoutHBox.prototype, "space", {
        get: function () {
            return this.m_fSpace;
        },
        set: function (value) {
            this.m_fSpace = value;
            this.m_bNeedUpdate = true;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dLayoutHBox.prototype, "spaceAverage", {
        get: function () {
            return this.m_bSpaceAverage;
        },
        set: function (bAverage) {
            this.m_bSpaceAverage = bAverage;
            this.m_bNeedUpdate = true;
        },
        enumerable: false,
        configurable: true
    });
    dLayoutHBox.prototype._Render = function (mat, windowWidth, windowHeight, bFatherMatrixDirty) {
        if (this.m_bNeedUpdate) {
            this.UpdateLayout();
        }
        _super.prototype._Render.call(this, mat, windowWidth, windowHeight, bFatherMatrixDirty);
    };
    dLayoutHBox.prototype.UpdateLayout = function () {
        this.m_bNeedUpdate = false;
        var vec = this.GetChildList();
        if (vec.length == 0)
            return;
        var totalWidth = 0;
        var count = 0;
        for (var i = 0, n = vec.length; i < n; i++) {
            var p = vec[i];
            if (p.visible) {
                totalWidth += p.width * p.scaleX;
                count++;
            }
        }
        var space = this.m_fSpace;
        if (this.m_bSpaceAverage)
            space = (this.width - totalWidth) / (count + 1);
        totalWidth += (count - 1) * space;
        var mul = 0.5;
        if (this.m_nAlignType == dLabel.ALIGN_LEFT)
            mul = 0;
        else if (this.m_nAlignType == dLabel.ALIGN_RIGHT)
            mul = 1;
        var add = 0;
        for (var i = 0, n = vec.length; i < n; i++) {
            var p = vec[i];
            if (p.visible) {
                p.positionX = (this.width - totalWidth) * mul + add + p.anchorU * p.width * p.scaleX - this.anchorU * this.width;
                add += p.width * p.scaleX + space;
            }
        }
        if (this.GetEvent())
            this.GetEvent().OnUpdateLayout(this);
    };
    dLayoutHBox.prototype.LoadFromJson = function (j) {
        _super.prototype.LoadFromJson.call(this, j);
        if (j.hasOwnProperty("alignType"))
            this.alignType = dMath.ParseInt(j.alignType);
        if (j.hasOwnProperty("space"))
            this.space = dMath.ParseFloat(j.space);
        if (j.hasOwnProperty("spaceAverage"))
            this.spaceAverage = Boolean(dMath.ParseInt(j.spaceAverage));
    };
    return dLayoutHBox;
}(dBaseControl));
var dLayoutLimitScale = (function (_super) {
    __extends(dLayoutLimitScale, _super);
    function dLayoutLimitScale() {
        var _this = _super.call(this) || this;
        _this.m_bNeedUpdate = false;
        _this.m_pView = new dSprite();
        _this.m_pResizeEvent = new dSprite();
        _this.m_pResizeEvent.SetSize = function (w, h) {
            _this.m_bNeedUpdate = true;
        };
        _this.m_pResizeEvent.SetScale = function (x, y) {
            _this.m_bNeedUpdate = true;
        };
        _this.m_pResizeEvent.SetPos = function (x, y) {
            _this.m_bNeedUpdate = true;
        };
        _this.m_pView.SetAnchor(0.5, 0.5);
        _super.prototype.AddChild.call(_this, _this.m_pView);
        return _this;
    }
    dLayoutLimitScale.prototype.GetChildList = function () {
        return this.m_pView.GetChildList();
    };
    dLayoutLimitScale.prototype.AddChild = function (pChild, at) {
        if (at === void 0) { at = -1; }
        this.m_pView.AddChild(pChild, at);
        pChild.SetTouchEvent(this.m_pResizeEvent);
        this.m_bNeedUpdate = true;
    };
    dLayoutLimitScale.prototype.RemoveChild = function (pChild) {
        this.m_pView.RemoveChild(pChild);
        pChild.SetTouchEvent(null);
        this.m_bNeedUpdate = true;
    };
    dLayoutLimitScale.prototype.SetSize = function (w, h) {
        this.m_bNeedUpdate = true;
        _super.prototype.SetSize.call(this, w, h);
    };
    dLayoutLimitScale.prototype._Render = function (mat, windowWidth, windowHeight, bFatherMatrixDirty) {
        if (this.m_bNeedUpdate) {
            this.UpdateLayout();
        }
        _super.prototype._Render.call(this, mat, windowWidth, windowHeight, bFatherMatrixDirty);
    };
    dLayoutLimitScale.prototype.UpdateLayout = function () {
        this.m_bNeedUpdate = false;
        var vec = this.m_pView.GetChildList();
        if (vec.length == 0)
            return;
        var left;
        var top;
        var right;
        var bottom;
        var bFirst = true;
        for (var i = 0, n = vec.length; i < n; i++) {
            if (vec[i].visible) {
                var t_left = vec[i].positionX - vec[i].width * vec[i].anchorU * vec[i].scaleX;
                var t_right = vec[i].positionX + vec[i].width * vec[i].anchorU * vec[i].scaleX;
                var t_top = vec[i].positionY - vec[i].height * vec[i].anchorV * vec[i].scaleY;
                var t_bottom = vec[i].positionY + vec[i].height * vec[i].anchorV * vec[i].scaleY;
                if (bFirst) {
                    left = t_left;
                    top = t_top;
                    right = t_right;
                    bottom = t_bottom;
                    bFirst = false;
                }
                else {
                    if (left > t_left)
                        left = t_left;
                    if (right < t_right)
                        right = t_right;
                    if (top > t_top)
                        top = t_top;
                    if (bottom < t_bottom)
                        bottom = t_bottom;
                }
            }
        }
        var scaleLeft = this.width * 0.5 / dMath.Max(-left, this.width * 0.5);
        var scaleRight = this.width * 0.5 / dMath.Max(right, this.width * 0.5);
        var scaleTop = this.height * 0.5 / dMath.Max(-top, this.height * 0.5);
        var scaleBottom = this.height * 0.5 / dMath.Max(bottom, this.height * 0.5);
        var scale = scaleLeft;
        if (scale > scaleRight)
            scale = scaleRight;
        if (scale > scaleTop)
            scale = scaleTop;
        if (scale > scaleBottom)
            scale = scaleBottom;
        if (scale > 1)
            scale = 1;
        this.m_pView.SetScale(scale, scale);
    };
    return dLayoutLimitScale;
}(dBaseControl));
var dLayoutVBox = (function (_super) {
    __extends(dLayoutVBox, _super);
    function dLayoutVBox() {
        return _super.call(this) || this;
    }
    dLayoutVBox.prototype.UpdateLayout = function () {
        this.m_bNeedUpdate = false;
        var vec = this.GetChildList();
        if (vec.length == 0)
            return;
        var totalHeight = 0;
        var count = 0;
        for (var i = 0, n = vec.length; i < n; i++) {
            var p = vec[i];
            if (p.visible) {
                totalHeight += p.height * p.scaleY;
                count++;
            }
        }
        var space = this.m_fSpace;
        if (this.m_bSpaceAverage)
            space = (this.height - totalHeight) / (count + 1);
        totalHeight += (count - 1) * space;
        var mul = 0.5;
        if (this.m_nAlignType == dLabel.ALIGN_LEFT)
            mul = 0;
        else if (this.m_nAlignType == dLabel.ALIGN_RIGHT)
            mul = 1;
        var add = 0;
        for (var i = 0, n = vec.length; i < n; i++) {
            var p = vec[i];
            if (p.visible) {
                p.positionY = (this.height - totalHeight) * mul + add + p.anchorV * p.height * p.scaleY - this.anchorV * this.height;
                add += p.height * p.scaleY + space;
            }
        }
    };
    return dLayoutVBox;
}(dLayoutHBox));
var dLine = (function (_super) {
    __extends(dLine, _super);
    function dLine() {
        var _this = _super.call(this) || this;
        _this.m_vecImage = new Array();
        _this.m_fLineWidth = 1;
        _this.m_vMoveTo = new dVector2();
        _this.m_nUsingImageIndex = 0;
        _this.m_hasMoveTo = false;
        _this.m_repeatMode = false;
        return _this;
    }
    dLine.prototype.SetColor = function (color, bWithChild) {
        if (bWithChild === void 0) { bWithChild = false; }
        _super.prototype.SetColor.call(this, color, bWithChild);
        for (var i = 0; i < this.m_vecImage.length; i++)
            this.m_vecImage[i].SetColor(color);
    };
    dLine.prototype.Release = function () {
        for (var i = 0; i < this.m_vecImage.length; i++)
            this.RemoveChild(this.m_vecImage[i]);
        this.m_vecImage.clear();
    };
    dLine.prototype.Clear = function () {
        this.m_nUsingImageIndex = 0;
        for (var i = 0; i < this.m_vecImage.length; i++)
            this.m_vecImage[i].visible = false;
        this.m_vMoveTo.SetValue(0, 0);
        this.m_hasMoveTo = false;
    };
    dLine.prototype.MoveTo = function (x, y) {
        this.m_vMoveTo.SetValue(x, y);
        this.m_hasMoveTo = true;
    };
    dLine.prototype.hasMoveTo = function () {
        return this.m_hasMoveTo;
    };
    Object.defineProperty(dLine.prototype, "lineWidth", {
        get: function () {
            return this.m_fLineWidth;
        },
        set: function (value) {
            this.m_fLineWidth = value;
        },
        enumerable: false,
        configurable: true
    });
    dLine.prototype.SetBitmapData = function (bmp, pSourceRect, at, sampleType) {
        if (pSourceRect === void 0) { pSourceRect = null; }
        if (at === void 0) { at = 0; }
        if (sampleType === void 0) { sampleType = 0; }
        _super.prototype.SetBitmapData.call(this, bmp, pSourceRect, at, sampleType);
        if (bmp != null) {
            for (var i = 0; i < this.m_vecImage.length; i++) {
                this.m_vecImage[i].pureColor = false;
                this.m_vecImage[i].SetBitmapData(bmp, pSourceRect, at, sampleType);
            }
        }
        else {
            for (var i = 0; i < this.m_vecImage.length; i++) {
                this.m_vecImage[i].SetBitmapData(null);
                this.m_vecImage[i].pureColor = true;
            }
        }
    };
    dLine.prototype.CreateLineImage = function () {
        if (this.m_nUsingImageIndex < this.m_vecImage.length)
            return this.m_vecImage[this.m_nUsingImageIndex++];
        var pImage;
        if (this.m_repeatMode)
            pImage = new dRepeatImage();
        else
            pImage = new dImage();
        pImage.SetAnchor(0, 0.5);
        pImage.SetTransparentMouse(this.isTransparentMouse());
        if (this.GetBitmapData() != null)
            pImage.SetBitmapData(this.GetBitmapData(), this.GetBitmapSourceRect());
        else
            pImage.pureColor = true;
        pImage.SetColor(this.GetColor());
        this.AddChild(pImage);
        this.m_vecImage.push(pImage);
        this.m_nUsingImageIndex++;
        return pImage;
    };
    dLine.prototype.RemoveAllChild = function (bDestory) {
        if (bDestory === void 0) { bDestory = false; }
        _super.prototype.RemoveAllChild.call(this, bDestory);
        for (var i = 0; i < this.m_vecImage.length; i++)
            this.AddChild(this.m_vecImage[i]);
    };
    dLine.prototype.LineTo = function (x, y) {
        var pImage = this.CreateLineImage();
        pImage.visible = true;
        var vStart = new dVector2(this.m_vMoveTo.x, this.m_vMoveTo.y);
        var vEnd = new dVector2(x, y);
        pImage.SetPos(this.m_vMoveTo.x, this.m_vMoveTo.y);
        pImage.SetSize(vEnd.LengthTo(vStart), this.m_fLineWidth);
        pImage.rotation = dMath.RadianToAngle((vEnd.Sub(vStart).Normalize().ToRadian() - dMath.dPI / 2));
        this.m_vMoveTo.SetValue(x, y);
    };
    dLine.prototype.SetLastPos = function (x, y) {
        if (this.GetLineCount() > 0) {
            var pImage = this.m_vecImage[this.m_nUsingImageIndex - 1];
            pImage.visible = true;
            var vStart = new dVector2(pImage.positionX, pImage.positionY);
            var vEnd = new dVector2(x, y);
            pImage.SetSize(vEnd.LengthTo(vStart), this.m_fLineWidth);
            pImage.rotation = dMath.RadianToAngle((vEnd.Sub(vStart).Normalize().ToRadian() - dMath.dPI / 2));
            this.m_vMoveTo.SetValue(x, y);
        }
        else
            this.LineTo(x, y);
    };
    dLine.prototype.GetPointList = function () {
        var ret = new Array();
        for (var i = 0; i < this.GetLineCount(); i++)
            ret.push(new dVector2(this.GetLineToX(i), this.GetLineToY(i)));
        if (this.hasMoveTo())
            ret.push(new dVector2(this.GetMoveToX(), this.GetMoveToY()));
        return ret;
    };
    dLine.prototype.GetMoveToX = function () {
        return this.m_vMoveTo.x;
    };
    dLine.prototype.GetMoveToY = function () {
        return this.m_vMoveTo.y;
    };
    dLine.prototype.GetMoveTo = function () {
        return new dVector2(this.m_vMoveTo.x, this.m_vMoveTo.y);
    };
    dLine.prototype.GetLineCount = function () {
        return this.m_nUsingImageIndex;
    };
    dLine.prototype.GetLineList = function () {
        return this.m_vecImage;
    };
    dLine.prototype.GetLineToX = function (at) {
        if (at === void 0) { at = 0; }
        if (at < 0)
            return this.GetMoveToX();
        if (at >= this.m_vecImage.length)
            return 0;
        return this.m_vecImage[at].positionX;
    };
    dLine.prototype.GetLineToY = function (at) {
        if (at === void 0) { at = 0; }
        if (at < 0)
            return this.GetMoveToY();
        if (at >= this.m_vecImage.length)
            return 0;
        return this.m_vecImage[at].positionY;
    };
    dLine.prototype.LoadFromFile = function (strImage, onLoadComplete, bAutoResize, rcSource) {
        var _this = this;
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (bAutoResize === void 0) { bAutoResize = true; }
        if (rcSource === void 0) { rcSource = null; }
        if (bAutoResize)
            this.lineWidth = 0;
        _super.prototype.LoadFromFile.call(this, strImage, function () {
            if (_this.GetBitmapData() != null) {
                if (bAutoResize && _this.lineWidth == 0)
                    _this.lineWidth = _this.GetBitmapData().GetWidth();
            }
            for (var i = 0; i < _this.m_vecImage.length; i++)
                _this.m_vecImage[i].SetBitmapData(_this.GetBitmapData());
            if (onLoadComplete)
                onLoadComplete(_this);
        }, false);
        return this;
    };
    return dLine;
}(dImage));
var dScrollView = (function (_super) {
    __extends(dScrollView, _super);
    function dScrollView() {
        var _this = _super.call(this) || this;
        _this.m_pContainer = new dSprite();
        _this.m_pView = new dBaseControl();
        _this.m_pScrollH = new dScale9();
        _this.m_pScrollV = new dScale9();
        _this.m_pTimer = null;
        _this.m_pScrollHTimer = null;
        _this.m_pScrollVTimer = null;
        _this.m_fScrollHAlpha = 0;
        _this.m_fScrollVAlpha = 0;
        _this.m_vMoveDir = new dVector2();
        _this.m_pHandleMouse = new dSprite();
        _this.m_bCanDragH = false;
        _this.m_bCanDragV = true;
        _this.m_bCanViewOutsideH = true;
        _this.m_bCanViewOutsideV = true;
        _this.m_fViewPosAnimateX = 0;
        _this.m_fViewPosAnimateY = 0;
        _this.m_bPageMode = false;
        _this.m_nLastTouchMoveTime = 0;
        _this.m_vDownedObjScale = new dVector2(1, 1);
        _this.m_bUpdatingPerChild = false;
        _this.m_nPageWidth = 0;
        _this.m_nPageHeight = 0;
        _this.m_fTouchMoveAdd = 0;
        _this.touchMoveThreshold = 1;
        _this.m_bAutoSetScrollAlpha = true;
        _this.m_pCurrentTouchDownScaleSprite = null;
        _this.m_pBindPageView = null;
        _this.m_pTimerForAutoViewSize = null;
        _this.m_bTouchMoved = 0;
        _this.m_bTouchMoving = false;
        _this.m_pTouchDownCollectSprite = null;
        _this.touchDownScaleMode = true;
        _this.m_fTimeAdd = 0;
        var a = _this;
        a.SetClipChild(true);
        _super.prototype.AddChild.call(_this, a.m_pContainer);
        a.m_pContainer.AddChild(a.m_pView);
        if (dScrollView.s_pScrollButtonBitmap == null) {
            dScrollView.s_pScrollButtonBitmap = new dBitmapData();
            dScrollView.s_pScrollButtonBitmap.Create(9, 9, 0);
        }
        a.m_pScrollH.SetBitmapData(dScrollView.s_pScrollButtonBitmap);
        a.m_pScrollV.SetBitmapData(dScrollView.s_pScrollButtonBitmap);
        a.m_pContainer.AddChild(a.m_pScrollH);
        a.m_pContainer.AddChild(a.m_pScrollV);
        if (a.m_bAutoSetScrollAlpha) {
            a.m_pScrollH.SetAlpha(0);
            a.m_pScrollV.SetAlpha(0);
        }
        a.m_pContainer.AddChild(a.m_pHandleMouse);
        a.m_pHandleMouse.SetHandleMouse(true);
        var pTouchEvent = new dSprite();
        pTouchEvent.OnTouchDown = function (x, y, delta) {
            _this.OnTouchDown(x, y, delta);
        };
        pTouchEvent.OnTouchMove = function (x, y, offx, offy, delta) {
            _this.OnTouchMove(x, y, offx, offy, delta);
        };
        pTouchEvent.OnTouchUp = function (x, y) {
            _this.OnTouchUp(x, y);
        };
        a.m_pHandleMouse.SetTouchEvent(pTouchEvent);
        a.m_pView.SetAnchor(0, 0);
        a.m_pContainer.SetAnchor(0, 0);
        a.m_pHandleMouse.SetAnchor(0, 0);
        a.m_pScrollH.SetAnchor(0, 0);
        a.m_pScrollV.SetAnchor(0, 0);
        a.m_pContainer.SetPos(-a.GetAnchorU() * a.GetWidth(), -a.GetAnchorV() * a.GetHeight());
        return _this;
    }
    dScrollView.prototype.SetListBoxPageView = function (pageView) {
        if (this.m_pBindPageView != pageView) {
            this.m_pBindPageView = pageView;
            this.AdjustViewSize();
        }
    };
    dScrollView.prototype.GetListBoxPageView = function () {
        return this.m_pBindPageView;
    };
    dScrollView.prototype.Destroy = function () {
        this.StopMove();
        _super.prototype.Destroy.call(this);
    };
    dScrollView.prototype.SetHandleMouse = function (bHandle) {
        _super.prototype.SetHandleMouse.call(this, bHandle);
        this.m_pHandleMouse.SetHandleMouse(bHandle);
    };
    dScrollView.prototype.SetAnchor = function (u, v) {
        _super.prototype.SetAnchor.call(this, u, v);
        if (this.m_pContainer != null)
            this.m_pContainer.SetPos(-u * this.GetWidth(), -v * this.GetHeight());
    };
    dScrollView.prototype.GetView = function () {
        return this.m_pView;
    };
    dScrollView.prototype.CreateTimer = function () {
        var _this = this;
        if (!this.isDestroyed() && this.m_pTimer == null) {
            if (this.m_vMoveDir.x != 0 || this.m_vMoveDir.y != 0 || this.GetOffsetX() != 0 || this.GetOffsetY() != 0 ||
                this.m_fViewPosAnimateX != this.m_pView.positionX || this.m_fViewPosAnimateY != this.m_pView.positionY) {
                this.m_pTimer = new dTimer();
                this.m_pTimer.Create(0, 0, function (p, i, fTimeElapse) {
                    _this._OnTimer(fTimeElapse);
                });
            }
        }
    };
    dScrollView.prototype.SetSize = function (width, height) {
        _super.prototype.SetSize.call(this, width, height);
        this.m_pHandleMouse.SetSize(width, height);
        this.m_pContainer.SetPos(-this.GetAnchorU() * this.GetWidth(), -this.GetAnchorV() * this.GetHeight());
        this.UpdateScrollButtonSize();
        this.CreateTimer();
    };
    dScrollView.prototype._SetViewSize = function (width, height) {
        if (this.pageMode) {
            width = width + (width % this._GetPageWidth());
            height = height + (height % this._GetPageHeight());
        }
        this.SetViewSize(width, height);
        if (this.m_pBindPageView != null) {
            if (this.canDragH)
                this.m_pBindPageView.SetPageCount(this.GetPageCountX());
            else
                this.m_pBindPageView.SetPageCount(this.GetPageCountY());
        }
    };
    dScrollView.prototype.SetViewSize = function (width, height) {
        if (this.m_pTimerForAutoViewSize != null)
            this.m_pTimerForAutoViewSize.Apply();
        this.m_pView.SetSize(width, height);
        this.UpdateScrollButtonSize();
        this.CreateTimer();
    };
    dScrollView.prototype.GetViewWidth = function () {
        if (this.m_pTimerForAutoViewSize != null)
            this.m_pTimerForAutoViewSize.Apply();
        return this.m_pView.GetWidth();
    };
    dScrollView.prototype.GetViewHeight = function () {
        if (this.m_pTimerForAutoViewSize != null)
            this.m_pTimerForAutoViewSize.Apply();
        return this.m_pView.GetHeight();
    };
    dScrollView.prototype.AdjustViewSize = function () {
        var a = this;
        if (!a.isDestroyed() && a.m_pTimerForAutoViewSize == null) {
            a.m_pTimerForAutoViewSize = new dTimer();
            a.m_pTimerForAutoViewSize.Create(0, 1, function (p, iTimer, fTimer) {
                a.m_pTimerForAutoViewSize = null;
                a.m_pView.SetSize(0, 0);
                var rc = a.m_pView.GetBoundRect(false);
                a._SetViewSize(rc.right, rc.bottom);
            });
        }
    };
    dScrollView.prototype.OnTouchDown = function (x, y, delta) {
        var a = this;
        a.m_fTouchMoveAdd = 0;
        a.StopMove();
        a.m_bTouchMoved = 0;
        a.m_bTouchMoving = false;
        a.m_nLastTouchMoveTime = 0;
        a.m_pTouchDownCollectSprite = a.m_pView.CollectionChild(x, y);
        if (a.m_pTouchDownCollectSprite != null) {
            if ((a.m_pTouchDownCollectSprite instanceof dBaseControl) && !a.m_pTouchDownCollectSprite.isEnable()) {
                a.m_pTouchDownCollectSprite = null;
            }
        }
        a.OnTouchDownToChild(a.m_pTouchDownCollectSprite);
        _super.prototype.OnTouchDown.call(this, x, y, delta);
    };
    dScrollView.prototype.SetTouchDownScaleMode = function (bScaleMode) {
        this.touchDownScaleMode = bScaleMode;
    };
    dScrollView.prototype.OnTouchDownToChild = function (child) {
        if (this.m_pEvent == null || this.m_pEvent != null && !this.m_pEvent.OnScrollViewTouchDownToChild(child)) {
            if (child != null && this.touchDownScaleMode) {
                this.m_vDownedObjScale.SetValue(child.scaleX, child.scaleY);
                child.SetScale(child.scaleX - 0.05, child.scaleY - 0.05);
                this.m_pCurrentTouchDownScaleSprite = child;
            }
        }
    };
    dScrollView.prototype.OnTouchUpToChild = function (child) {
        var bRet = false;
        if (this.m_pEvent == null || this.m_pEvent != null && !(bRet = this.m_pEvent.OnScrollViewTouchUpToChild(child))) {
            if (child != null && this.touchDownScaleMode) {
                child.SetScale(this.m_vDownedObjScale.x, this.m_vDownedObjScale.y);
                this.m_pCurrentTouchDownScaleSprite = null;
            }
        }
        return bRet;
    };
    dScrollView.prototype.CheckViewOutside = function () {
        var a = this;
        if (!a.m_bCanViewOutsideH) {
            if (a.GetWidth() >= a.m_pView.GetWidth())
                a._SetViewPos(0, a.m_pView.positionY);
            else {
                if (a.m_pView.positionX > 0)
                    a._SetViewPos(0, a.m_pView.positionY);
                else if (a.m_pView.positionX < -(a.m_pView.GetWidth() - a.GetWidth()))
                    a._SetViewPos(-(a.m_pView.GetWidth() - a.GetWidth()), a.m_pView.positionY);
            }
        }
        if (!a.m_bCanViewOutsideV) {
            if (a.GetHeight() >= a.m_pView.GetHeight())
                a._SetViewPos(a.m_pView.positionX, 0);
            else {
                if (a.m_pView.positionY > 0)
                    a._SetViewPos(a.m_pView.positionX, 0);
                else if (a.m_pView.positionY < -(a.m_pView.GetHeight() - a.GetHeight()))
                    a._SetViewPos(a.m_pView.positionX, -(a.m_pView.GetHeight() - a.GetHeight()));
            }
        }
    };
    dScrollView.prototype.OnTouchMove = function (mouseX, mouseY, x, y, delta) {
        var a = this;
        if (!a.m_bCanDragH)
            x = 0;
        if (!a.m_bCanDragV)
            y = 0;
        if (a.m_pView.GetWidth() < a.GetWidth() && !a.m_bCanViewOutsideH)
            x = 0;
        if (a.m_pView.GetHeight() < a.GetHeight() && !a.m_bCanViewOutsideV)
            y = 0;
        if (dMath.Abs(a.m_fTouchMoveAdd) > a.touchMoveThreshold) {
            a.m_bTouchMoved += x + y;
            a.m_bTouchMoving = true;
            a.m_vMoveDir.SetValue(x, y);
            a._SetViewPos(a.m_pView.GetPosX() + x, a.m_pView.GetPosY() + y);
            a.CheckViewOutside();
            a.UpdateScrollButtonSize();
            if (a.m_pEvent != null)
                a.m_pEvent.OnScroll(this);
        }
        else
            a.m_fTouchMoveAdd += x + y;
        a.m_nLastTouchMoveTime = dTimer.GetTickCount();
        _super.prototype.OnTouchMove.call(this, mouseX, mouseY, x, y, delta);
    };
    dScrollView.prototype.GetPageX = function () {
        var pageWidth = dMath.ToInt(this._GetPageWidth());
        if (pageWidth == 0)
            return 0;
        return -dMath.ToInt((this.m_fViewPosAnimateX - pageWidth / 2) / pageWidth);
    };
    dScrollView.prototype.GetPageY = function () {
        var pageHeight = dMath.ToInt(this._GetPageHeight());
        if (pageHeight == 0)
            return 0;
        return -dMath.ToInt((this.m_fViewPosAnimateY - pageHeight / 2) / pageHeight);
    };
    dScrollView.prototype.GetPageCountX = function () {
        return dMath.Ceil(this.GetViewWidth() / this._GetPageWidth());
    };
    dScrollView.prototype.GetPageCountY = function () {
        return dMath.Ceil(this.GetViewHeight() / this._GetPageHeight());
    };
    dScrollView.prototype.SetPage = function (x, y, bPlayAnimate) {
        if (bPlayAnimate === void 0) { bPlayAnimate = true; }
        if (bPlayAnimate)
            this.SetViewPosAnimate(-x * this._GetPageWidth(), -y * this._GetPageHeight());
        else
            this.SetViewPos(-x * this._GetPageWidth(), -y * this._GetPageHeight(), false);
        if (this.m_pBindPageView != null) {
            if (this.canDragH)
                this.m_pBindPageView.SetCurPage(x);
            else
                this.m_pBindPageView.SetCurPage(y);
        }
    };
    Object.defineProperty(dScrollView.prototype, "pageMode", {
        get: function () {
            return this.m_bPageMode;
        },
        set: function (v) {
            this.m_bPageMode = v;
            this.AdjustViewSize();
        },
        enumerable: false,
        configurable: true
    });
    dScrollView.prototype._GetPageWidth = function () {
        if (this.m_nPageWidth == 0)
            return this.width;
        return this.m_nPageWidth;
    };
    dScrollView.prototype._GetPageHeight = function () {
        if (this.m_nPageHeight == 0)
            return this.height;
        return this.m_nPageHeight;
    };
    dScrollView.prototype.SetPageSize = function (width, height) {
        this.m_nPageWidth = width;
        this.m_nPageHeight = height;
    };
    dScrollView.prototype.GetPageWidth = function () {
        return this.m_nPageWidth;
    };
    dScrollView.prototype.GetPageHeight = function () {
        return this.m_nPageHeight;
    };
    dScrollView.prototype.OnTouchUp = function (x, y) {
        var a = this;
        a.m_bTouchMoving = false;
        if (dTimer.GetTickCount() > a.m_nLastTouchMoveTime + 150)
            a.m_vMoveDir.SetValue(0, 0);
        if (a.m_bPageMode) {
            a._SetViewPosAnimate(a.m_fViewPosAnimateX + (a.m_vMoveDir.x > 0 ? a._GetPageWidth() / 3 : -a._GetPageWidth() / 3), a.m_fViewPosAnimateY + (a.m_vMoveDir.y > 0 ? a._GetPageHeight() / 3 : -a._GetPageHeight() / 3));
            a.SetPage(a.GetPageX(), a.GetPageY());
            a.m_vMoveDir.SetValue(0, 0);
        }
        a.CreateTimer();
        var bTouchUpHandled = a.OnTouchUpToChild(a.m_pTouchDownCollectSprite);
        if (!bTouchUpHandled && a.m_pTouchDownCollectSprite != null) {
            if (dMath.Abs(a.m_bTouchMoved) < 3) {
                var xx = x - a.m_pTouchDownCollectSprite.GetPosX_World(this, false) - a.anchorU * a.width;
                var yy = y - a.m_pTouchDownCollectSprite.GetPosY_World(this, false) - a.anchorV * a.height;
                var bHandleTouch = false;
                if (!bHandleTouch) {
                    a.m_pTouchDownCollectSprite.OnTouchDown(xx, yy, 1);
                    a.m_pTouchDownCollectSprite.OnTouchUp(xx, yy);
                }
            }
            a.m_pTouchDownCollectSprite = null;
        }
        _super.prototype.OnTouchUp.call(this, x, y);
    };
    dScrollView.prototype.StopMove = function () {
        this.m_vMoveDir.SetValue(0, 0);
        if (this.m_pTimer != null) {
            this.m_pTimer.Stop();
            this.m_pTimer = null;
        }
    };
    dScrollView.prototype._OnTimer = function (fTimeElapse) {
        var a = this;
        a.m_fTimeAdd += fTimeElapse;
        if (a.m_fTimeAdd > 1)
            a.m_fTimeAdd = 1;
        var bMoved = false;
        while (a.m_fTimeAdd > 0.01) {
            if (dMath.Abs(a.m_fViewPosAnimateX - a.m_pView.positionX) < 1)
                a.m_fViewPosAnimateX = a.m_pView.positionX;
            if (dMath.Abs(a.m_fViewPosAnimateY - a.m_pView.positionY) < 1)
                a.m_fViewPosAnimateY = a.m_pView.positionY;
            var moveX = (a.m_fViewPosAnimateX - a.m_pView.positionX) * 0.1;
            var moveY = (a.m_fViewPosAnimateY - a.m_pView.positionY) * 0.1;
            if (moveX != 0 || moveY != 0) {
                a._SysSetViewPos(a.m_pView.positionX + moveX, a.m_pView.positionY + moveY);
                bMoved = true;
            }
            if (!a.m_bTouchMoving) {
                a._SetViewPosAnimate(a.m_fViewPosAnimateX + a.m_vMoveDir.x, a.m_fViewPosAnimateY + a.m_vMoveDir.y);
                a.m_vMoveDir.MulAppendF(0.95);
                if (a.m_vMoveDir.Length() < 1)
                    a.m_vMoveDir.SetValue(0, 0);
            }
            else {
                a._SetViewPosAnimate(a.m_fViewPosAnimateX, a.m_fViewPosAnimateY);
            }
            a.m_fTimeAdd -= 0.01;
        }
        if (bMoved) {
            a.UpdateScrollButtonSize();
            a.OnViewScrolled(a.m_pView.positionX, a.m_pView.positionY);
            if (a.m_pEvent != null)
                a.m_pEvent.OnScroll(this);
        }
        if (a.m_vMoveDir.x == 0 && a.m_vMoveDir.y == 0 && a.m_pView.positionX == a.m_fViewPosAnimateX && a.m_pView.positionY == a.m_fViewPosAnimateY)
            a.StopMove();
    };
    dScrollView.prototype.OnViewScrolled = function (x, y) {
    };
    dScrollView.prototype._SysSetViewPos = function (x, y) {
        if (x != this.m_pView.positionX || y != this.m_pView.positionY) {
            this.m_pView.SetPos(x, y);
            if (this.m_pEvent != null)
                this.m_pEvent.OnScrollViewPosChanged(this);
        }
    };
    dScrollView.prototype._SetViewPos = function (x, y) {
        this._SetViewPosAnimate(x, y);
        this._SysSetViewPos(x, y);
        this.OnViewScrolled(x, y);
    };
    dScrollView.prototype.ScrollToTop = function (bAnimate) {
        this.SetViewPos(0, 0, bAnimate);
    };
    dScrollView.prototype.ScrollToBottom = function (bAnimate) {
        this.SetViewPos(0, -this.GetViewHeight(), bAnimate);
    };
    dScrollView.prototype.isViewTop = function () {
        return this.m_pView.positionY > 0;
    };
    dScrollView.prototype.isViewBottom = function () {
        return this.m_pView.positionY < -(this.m_pView.GetHeight() - this.GetHeight());
    };
    dScrollView.prototype.SetViewPos = function (x, y, bAnimate) {
        if (bAnimate === void 0) { bAnimate = true; }
        var a = this;
        if (a.isDestroyed())
            return;
        a.SetViewPosAnimate(x, y);
        if (!bAnimate) {
            a._SetViewPos(x, y);
            if (a.m_bCanDragH) {
                if (a.GetWidth() >= a.m_pView.GetWidth())
                    a._SysSetViewPos(0, a.m_pView.positionY);
                else {
                    if (a.m_pView.positionX > 0)
                        a._SysSetViewPos(0, a.m_pView.positionY);
                    else if (a.m_pView.positionX < -(a.m_pView.GetWidth() - a.GetWidth()))
                        a._SysSetViewPos(-(a.m_pView.GetWidth() - a.GetWidth()), a.m_pView.positionY);
                }
            }
            if (a.m_bCanDragV) {
                if (a.GetHeight() >= a.m_pView.GetHeight())
                    a._SysSetViewPos(a.m_pView.positionX, 0);
                else {
                    if (a.m_pView.positionY > 0)
                        a._SysSetViewPos(a.m_pView.positionX, 0);
                    else if (a.m_pView.positionY < -(a.m_pView.GetHeight() - a.GetHeight()))
                        a._SysSetViewPos(a.m_pView.positionX, -(a.m_pView.GetHeight() - a.GetHeight()));
                }
            }
        }
    };
    dScrollView.prototype._SetViewPosAnimate = function (x, y) {
        var a = this;
        var vw = a.m_pView.width;
        if (vw < a.width)
            vw = a.width;
        var vh = a.m_pView.height;
        if (vh < a.height)
            vh = a.height;
        if (x > 0)
            x = 0;
        else if (x < -vw + a.width)
            x = -vw + a.width;
        if (y > 0)
            y = 0;
        else if (y < -vh + a.height)
            y = -vh + a.height;
        a.m_fViewPosAnimateX = x;
        a.m_fViewPosAnimateY = y;
    };
    dScrollView.prototype.SetViewPosAnimate = function (x, y) {
        if (this.m_fViewPosAnimateX != x || this.m_fViewPosAnimateY != y) {
            if (this.m_pTimerForAutoViewSize != null)
                this.m_pTimerForAutoViewSize.Apply();
            this.m_vMoveDir.SetValue(0, 0);
            this._SetViewPosAnimate(x, y);
            this.CreateTimer();
        }
    };
    dScrollView.prototype.GetViewPosX = function () {
        return this.m_pView.GetPosX();
    };
    dScrollView.prototype.GetViewPosY = function () {
        return this.m_pView.GetPosY();
    };
    dScrollView.prototype.GetOffsetX = function () {
        var width = dMath.Min(this.GetWidth(), this.m_pView.GetWidth());
        if (this.m_pView.GetPosX() > 0)
            return this.m_pView.GetPosX();
        else if (this.m_pView.GetPosX() < (width - this.m_pView.GetWidth()))
            return this.m_pView.GetPosX() - (width - this.m_pView.GetWidth());
        return 0;
    };
    dScrollView.prototype.GetOffsetY = function () {
        var height = dMath.Min(this.GetHeight(), this.m_pView.GetHeight());
        if (this.m_pView.GetPosY() > 0)
            return this.m_pView.GetPosY();
        else if (this.m_pView.GetPosY() < (height - this.m_pView.GetHeight()))
            return this.m_pView.GetPosY() - (height - this.m_pView.GetHeight());
        return 0;
    };
    dScrollView.prototype.GetViewOffsetLeft = function () {
        var width = dMath.Min(this.GetWidth(), this.m_pView.GetWidth());
        if (this.m_pView.GetPosX() > 0)
            return this.m_pView.GetPosX();
        return 0;
    };
    dScrollView.prototype.GetViewOffsetRight = function () {
        var width = dMath.Min(this.GetWidth(), this.m_pView.GetWidth());
        if (this.m_pView.GetPosX() > 0)
            return 0;
        else if (this.m_pView.GetPosX() < (width - this.m_pView.GetWidth()))
            return -(this.m_pView.GetPosX() - (width - this.m_pView.GetWidth()));
        return 0;
    };
    dScrollView.prototype.EndDsc = function () {
        _super.prototype.EndDsc.call(this);
        this.UpdateScrollButtonSize();
    };
    dScrollView.prototype.UpdateScrollButtonSize = function () {
        var a = this;
        if (a.m_bBeginDsc)
            return;
        var width_add = dMath.Abs(a.GetOffsetX());
        var height_add = dMath.Abs(a.GetOffsetY());
        var bNeedShowHScrollButton = false;
        var bNeedShowVScrollButton = false;
        var width = a.GetWidth();
        if (a.m_pView.GetWidth() != 0) {
            width = a.GetWidth() / (a.m_pView.GetWidth() + width_add) * a.GetWidth();
            if (width != a.m_pScrollH.GetWidth())
                bNeedShowHScrollButton = true;
            if (width > a.GetWidth())
                width = a.GetWidth();
        }
        var height = a.GetHeight();
        if (a.m_pView.GetHeight() != 0) {
            height = a.GetHeight() / (a.m_pView.GetHeight() + height_add) * a.GetHeight();
            if (height != a.m_pScrollV.GetHeight())
                bNeedShowVScrollButton = true;
            if (height > a.GetHeight())
                height = a.GetHeight();
        }
        var scrollWidth = 5;
        if (a.m_pScrollH.GetBitmapData() != null && scrollWidth < a.m_pScrollH.GetBitmapData().GetWidth())
            scrollWidth = this.m_pScrollH.GetBitmapData().GetWidth();
        a.m_pScrollH.SetSize(width, scrollWidth);
        a.m_pScrollV.SetSize(scrollWidth, height);
        var x = -a.m_pView.GetPosX() / (a.m_pView.GetWidth() - a.GetWidth()) * (a.GetWidth() - a.m_pScrollH.GetWidth());
        var limit_x = (a.GetWidth() - a.m_pScrollH.GetWidth());
        if (x < 0)
            x = 0;
        else if (x > limit_x)
            x = limit_x;
        if (bNeedShowHScrollButton || x != a.m_pScrollH.GetPosX()) {
            a.m_fScrollHAlpha = 1.5;
            if (a.m_bAutoSetScrollAlpha)
                a.m_pScrollH.SetAlpha(0.5);
            if (!a.m_bCanDragH) {
                a.m_fScrollHAlpha = 0;
                if (a.m_bAutoSetScrollAlpha)
                    a.m_pScrollH.SetAlpha(0);
            }
            else if (a.m_pScrollHTimer == null) {
                a.m_pScrollHTimer = new dTimer();
                a.m_pScrollHTimer.Create(0, 0, function (p, ii, f) {
                    a.m_fScrollHAlpha -= f;
                    if (a.m_fScrollHAlpha < 0) {
                        a.m_fScrollHAlpha = 0;
                        a.m_pScrollHTimer.Stop();
                        a.m_pScrollHTimer = null;
                    }
                    if (a.m_bAutoSetScrollAlpha)
                        a.m_pScrollH.SetAlpha(dMath.Clamp(a.m_fScrollHAlpha, 0, 0.5));
                });
            }
        }
        a.m_pScrollH.SetPos(x, a.GetHeight() - a.m_pScrollH.GetHeight());
        var y = -a.m_pView.GetPosY() / (a.m_pView.GetHeight() - a.GetHeight()) * (a.GetHeight() - a.m_pScrollV.GetHeight());
        var limit_y = (a.GetHeight() - a.m_pScrollV.GetHeight());
        if (y < 0)
            y = 0;
        else if (y > limit_y)
            y = limit_y;
        if (bNeedShowVScrollButton || y != a.m_pScrollV.GetPosY()) {
            a.m_fScrollVAlpha = 1.5;
            if (a.m_bAutoSetScrollAlpha)
                a.m_pScrollV.SetAlpha(0.5);
            if (!a.m_bCanDragV) {
                a.m_fScrollVAlpha = 0;
                if (a.m_bAutoSetScrollAlpha)
                    a.m_pScrollV.SetAlpha(0);
            }
            else if (a.m_pScrollVTimer == null) {
                a.m_pScrollVTimer = new dTimer();
                a.m_pScrollVTimer.Create(0, 0, function (p, ii, f) {
                    a.m_fScrollVAlpha -= f;
                    if (a.m_fScrollVAlpha < 0) {
                        a.m_fScrollVAlpha = 0;
                        a.m_pScrollVTimer.Stop();
                        a.m_pScrollVTimer = null;
                    }
                    if (a.m_bAutoSetScrollAlpha)
                        a.m_pScrollV.SetAlpha(dMath.Clamp(a.m_fScrollVAlpha, 0, 0.5));
                });
            }
        }
        a.m_pScrollV.SetPos(a.GetWidth() - a.m_pScrollV.GetWidth(), y);
    };
    dScrollView.prototype.AddChildToContainer = function (pChild, at) {
        if (at === void 0) { at = -1; }
        _super.prototype.AddChild.call(this, pChild, at);
    };
    dScrollView.prototype.AddChild = function (pChild, at) {
        if (at === void 0) { at = -1; }
        this.m_pView.AddChild(pChild, at);
        this.AdjustViewSize();
    };
    dScrollView.prototype.RemoveChild = function (pChild) {
        this.m_pView.RemoveChild(pChild);
        this.AdjustViewSize();
    };
    dScrollView.prototype.RemoveAllChild = function (bDestory) {
        if (bDestory === void 0) { bDestory = false; }
        this.m_pView.RemoveAllChild(bDestory);
        this.AdjustViewSize();
    };
    dScrollView.prototype.GetChildList = function () {
        return this.m_pView.GetChildList();
    };
    Object.defineProperty(dScrollView.prototype, "canDragH", {
        get: function () {
            return this.m_bCanDragH;
        },
        set: function (bCan) {
            this.m_bCanDragH = bCan;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dScrollView.prototype, "canDragV", {
        get: function () {
            return this.m_bCanDragV;
        },
        set: function (bCan) {
            this.m_bCanDragV = bCan;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dScrollView.prototype, "canOutsideViewH", {
        get: function () {
            return this.m_bCanViewOutsideH;
        },
        set: function (bCan) {
            this.m_bCanViewOutsideH = bCan;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dScrollView.prototype, "canOutsideViewV", {
        get: function () {
            return this.m_bCanViewOutsideV;
        },
        set: function (bCan) {
            this.m_bCanViewOutsideV = bCan;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dScrollView.prototype, "viewPosX", {
        get: function () {
            return this.GetViewPosX();
        },
        set: function (value) {
            this.SetViewPos(value, this.GetViewPosY());
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dScrollView.prototype, "viewPosY", {
        get: function () {
            return this.GetViewPosY();
        },
        set: function (value) {
            this.SetViewPos(this.GetViewPosX(), value);
        },
        enumerable: false,
        configurable: true
    });
    dScrollView.prototype.SetShowScroll = function (bShow) {
        this.m_pScrollH.visible = bShow;
        this.m_pScrollV.visible = bShow;
    };
    dScrollView.prototype.isShowScroll = function () {
        return this.m_pScrollH.visible && this.m_pScrollV.visible;
    };
    dScrollView.prototype.SetScrollBitmapData = function (bmp) {
        this.m_pScrollH.SetBitmapData(bmp);
        this.m_pScrollV.SetBitmapData(bmp);
    };
    dScrollView.prototype.SetScrollAutoSetAlpha = function (bSet) {
        this.m_bAutoSetScrollAlpha = bSet;
        if (!bSet) {
            this.GetScrollH().SetAlpha(this.canDragH ? 1 : 0);
            this.GetScrollV().SetAlpha(this.canDragV ? 1 : 0);
        }
    };
    dScrollView.prototype.GetScrollH = function () {
        return this.m_pScrollH;
    };
    dScrollView.prototype.GetScrollV = function () {
        return this.m_pScrollV;
    };
    dScrollView.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("canDragH"))
            this.canDragH = Boolean(dMath.ParseInt(json.canDragH));
        if (json.hasOwnProperty("canDragV"))
            this.canDragV = Boolean(dMath.ParseInt(json.canDragV));
    };
    dScrollView.s_pScrollButtonBitmap = null;
    return dScrollView;
}(dBaseControl));
var dListBox = (function (_super) {
    __extends(dListBox, _super);
    function dListBox() {
        var _this = _super.call(this) || this;
        _this.m_pSelect = new dImage();
        _this.m_nSelect = -1;
        _this.m_bVerticalList = true;
        _this.m_fLineSpace = 0;
        _this.m_fBlankSpace = 0;
        _this.m_nBlankCount = 1;
        _this.m_nVirtualChildCount = -1;
        _this.m_vecLastVirtualChildIndex = null;
        _this.m_vecCurVirtualChildIndex = null;
        _this.m_vecVirtualChildList = null;
        _this.m_fVirtualChildOffsetY = 0;
        _this.m_fViewSizeOffsetRight = 0;
        _this.m_fViewSizeOffsetBottom = 0;
        _this.m_bHeaderHasSpace = false;
        _this.m_bComputingVirtualChild = false;
        _this.m_pSelect.SetColor(0x800000FF);
        _this.m_pSelect.SetAnchor(0, 0);
        _this.AddChildToContainer(_this.m_pSelect, 0);
        return _this;
    }
    dListBox.prototype.SetViewSizeOffset = function (left, top, right, bottom) {
        this.m_fViewSizeOffsetRight = right;
        this.m_fViewSizeOffsetBottom = bottom;
    };
    dListBox.prototype.SetVirtualChildCount = function (count) {
        count = dMath.ToInt(count);
        this.m_nVirtualChildCount = count;
        this.m_vecLastVirtualChildIndex = null;
        this.m_vecCurVirtualChildIndex = null;
        if (count == -1)
            this.m_vecVirtualChildList = null;
        else {
            this.m_vecVirtualChildList = new Array();
            this.m_vecVirtualChildList.copy(this.m_pView.GetChildList());
        }
        this.UpdateViewSize();
    };
    dListBox.prototype.GetVirtualChildCount = function () {
        return this.m_nVirtualChildCount;
    };
    Object.defineProperty(dListBox.prototype, "vertical", {
        get: function () {
            return this.m_bVerticalList;
        },
        set: function (bVertical) {
            if (this.m_bVerticalList != bVertical) {
                this.m_bVerticalList = bVertical;
                this.canDragH = !bVertical;
                this.canDragV = bVertical;
                this.UpdateViewSize();
            }
        },
        enumerable: false,
        configurable: true
    });
    dListBox.prototype.SetLineSpace = function (value) {
        this.m_fLineSpace = value;
        this.UpdateViewSize();
    };
    dListBox.prototype.GetLineSpace = function () {
        return this.m_fLineSpace;
    };
    Object.defineProperty(dListBox.prototype, "lineSpace", {
        get: function () {
            return this.GetLineSpace();
        },
        set: function (value) {
            this.SetLineSpace(value);
        },
        enumerable: false,
        configurable: true
    });
    dListBox.prototype.SetBlankSpace = function (value) {
        this.m_fBlankSpace = value;
        this.UpdateViewSize();
    };
    dListBox.prototype.GetBlankSpace = function () {
        return this.m_fBlankSpace;
    };
    Object.defineProperty(dListBox.prototype, "blankSpace", {
        get: function () {
            return this.GetBlankSpace();
        },
        set: function (value) {
            this.SetBlankSpace(value);
        },
        enumerable: false,
        configurable: true
    });
    dListBox.prototype.SetBlankCount = function (count) {
        this.m_nBlankCount = count;
        this.UpdateViewSize();
    };
    dListBox.prototype.GetBlankCount = function () {
        return this.m_nBlankCount;
    };
    Object.defineProperty(dListBox.prototype, "blankCount", {
        get: function () {
            return this.GetBlankCount();
        },
        set: function (count) {
            if (count < 1)
                count = 1;
            this.SetBlankCount(count);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dListBox.prototype, "headerHasSpace", {
        get: function () {
            return this.m_bHeaderHasSpace;
        },
        set: function (value) {
            this.m_bHeaderHasSpace = value;
            this.UpdateViewSize();
        },
        enumerable: false,
        configurable: true
    });
    dListBox.prototype.AddChild = function (pChild, at) {
        if (at === void 0) { at = -1; }
        _super.prototype.AddChild.call(this, pChild, at);
        if (this.m_vecVirtualChildList != null && this.m_vecVirtualChildList.indexOf(pChild) == -1)
            this.m_vecVirtualChildList.push(pChild);
        this.UpdateViewSize();
    };
    dListBox.prototype.RemoveChild = function (pChild) {
        _super.prototype.RemoveChild.call(this, pChild);
        if (this.m_vecVirtualChildList != null)
            this.m_vecVirtualChildList.remove(pChild);
        this.UpdateViewSize();
    };
    dListBox.prototype.RemoveAllChild = function (bDestory) {
        if (bDestory === void 0) { bDestory = false; }
        _super.prototype.RemoveAllChild.call(this, bDestory);
        this.UpdateViewSize();
        this.SetViewPos(0, 0);
    };
    dListBox.prototype.GetViewWidth = function () {
        return _super.prototype.GetViewWidth.call(this);
    };
    dListBox.prototype.GetViewHeight = function () {
        return _super.prototype.GetViewHeight.call(this);
    };
    dListBox.prototype.OnUpdatePerChildEnd = function () {
        this.UpdateViewSize();
    };
    dListBox.prototype.EndDsc = function () {
        _super.prototype.EndDsc.call(this);
        this.UpdateViewSize();
    };
    dListBox.prototype.OnViewScrolled = function (x, y) {
        _super.prototype.OnViewScrolled.call(this, x, y);
        this.ComputeVirtualChild(x, y);
    };
    dListBox.prototype.GetVirtualIndexByChildIndex = function (childIndex) {
        return this.m_vecCurVirtualChildIndex[childIndex];
    };
    dListBox.prototype.SetVirtualChildOffsetY = function (offy) {
        this.m_fVirtualChildOffsetY = offy;
    };
    dListBox.prototype.ComputeVirtualChild = function (x, y) {
        var a = this;
        if (a.m_bComputingVirtualChild || a.isDestroyed())
            return;
        y += a.m_fVirtualChildOffsetY;
        a.m_bComputingVirtualChild = true;
        if (a.m_nVirtualChildCount > -1 && a.m_vecVirtualChildList.length > 0) {
            if (a.m_pCurrentTouchDownScaleSprite != null) {
                a.m_pCurrentTouchDownScaleSprite.SetScale(a.m_vDownedObjScale.x, a.m_vDownedObjScale.y);
            }
            var vecChild = a.m_vecVirtualChildList;
            var nLineCount = dMath.ToInt(vecChild.length / a.m_nBlankCount);
            var nVirtualLineCount = dMath.ToInt((a.m_nVirtualChildCount + (a.m_nBlankCount - 1)) / a.m_nBlankCount);
            for (var i = nVirtualLineCount * a.m_nBlankCount; i < vecChild.length; i++)
                vecChild[i].visible = false;
            if (a.m_vecLastVirtualChildIndex == null || a.m_vecLastVirtualChildIndex.length != nLineCount) {
                a.m_vecLastVirtualChildIndex = new Array(nLineCount);
                for (var i = 0; i < a.m_vecLastVirtualChildIndex.length; i++)
                    a.m_vecLastVirtualChildIndex[i] = -1;
            }
            if (a.m_vecCurVirtualChildIndex == null || a.m_vecCurVirtualChildIndex.length != nLineCount) {
                a.m_vecCurVirtualChildIndex = new Array(nLineCount);
            }
            if (a.m_bVerticalList) {
                var xpos = 0;
                var ypos = 0;
                var maxHeight2 = 0;
                for (var i = 0, n = nLineCount; i < n; i++) {
                    xpos = 0;
                    for (var j = 0; j < a.m_nBlankCount; j++) {
                        var index = i * a.m_nBlankCount + j;
                        if (index < vecChild.length) {
                            var pChild = vecChild[index];
                            pChild.SetPos(pChild.GetWidth() * pChild.GetAnchorU() * pChild.GetScaleX() + xpos + (a.m_bHeaderHasSpace ? a.m_fBlankSpace : 0), pChild.GetHeight() * pChild.GetAnchorV() * pChild.GetScaleY() + ypos + (a.m_bHeaderHasSpace ? a.m_fLineSpace : 0));
                            if (maxHeight2 < pChild.GetHeight() * pChild.GetScaleY())
                                maxHeight2 = pChild.GetHeight() * pChild.GetScaleY();
                            xpos += pChild.width * pChild.scaleX + a.m_fBlankSpace;
                        }
                    }
                    ypos += maxHeight2 + a.m_fLineSpace;
                    a.m_vecCurVirtualChildIndex[i] = i;
                }
                if (ypos > 0) {
                    var curTop = 0;
                    var count = 0;
                    var step = -dMath.ToInt(y / ypos);
                    while (a.m_vecCurVirtualChildIndex[a.m_vecCurVirtualChildIndex.length - 1] + step * nLineCount >= nVirtualLineCount)
                        step--;
                    if (step > 0) {
                        for (var i = 0, n = nLineCount; i < n; i++) {
                            a.m_vecCurVirtualChildIndex[i] += step * nLineCount;
                            for (var k = 0; k < a.m_nBlankCount; k++)
                                vecChild[i * a.m_nBlankCount + k].positionY += step * ypos;
                        }
                        count += step * nLineCount;
                    }
                    while (vecChild[curTop * a.m_nBlankCount].positionY + vecChild[curTop * a.m_nBlankCount].height - vecChild[curTop * a.m_nBlankCount].anchorV * vecChild[curTop * a.m_nBlankCount].height + y < 0 &&
                        count < nVirtualLineCount - nLineCount) {
                        for (var k = 0; k < a.m_nBlankCount; k++)
                            vecChild[curTop * a.m_nBlankCount + k].positionY += ypos;
                        a.m_vecCurVirtualChildIndex[curTop] += nLineCount;
                        curTop++;
                        curTop %= nLineCount;
                        count++;
                    }
                }
            }
            else {
                var xpos = 0;
                var ypos = 0;
                var maxWidth2 = 0;
                for (var i = 0, n = nLineCount; i < n; i++) {
                    ypos = 0;
                    for (var j = 0; j < a.m_nBlankCount; j++) {
                        var index = i * a.m_nBlankCount + j;
                        if (index < vecChild.length) {
                            var pChild = vecChild[index];
                            pChild.SetPos(pChild.GetWidth() * pChild.GetAnchorU() * pChild.GetScaleX() + xpos + (a.m_bHeaderHasSpace ? a.m_fLineSpace : 0), pChild.GetHeight() * pChild.GetAnchorV() * pChild.GetScaleY() + ypos + (a.m_bHeaderHasSpace ? a.m_fBlankSpace : 0));
                            if (maxWidth2 < pChild.GetWidth() * pChild.GetScaleX())
                                maxWidth2 = pChild.GetWidth() * pChild.GetScaleX();
                            ypos += pChild.height * pChild.scaleY + a.m_fBlankSpace;
                        }
                    }
                    xpos += maxWidth2 + a.m_fLineSpace;
                    a.m_vecCurVirtualChildIndex[i] = i;
                }
                if (xpos > 0) {
                    var curTop = 0;
                    var count = 0;
                    var step = -dMath.ToInt(x / xpos);
                    while (a.m_vecCurVirtualChildIndex[a.m_vecCurVirtualChildIndex.length - 1] + step * nLineCount >= nVirtualLineCount)
                        step--;
                    if (step > 0) {
                        for (var i = 0, n = nLineCount; i < n; i++) {
                            a.m_vecCurVirtualChildIndex[i] += step * nLineCount;
                            for (var k = 0; k < a.m_nBlankCount; k++)
                                vecChild[i * a.m_nBlankCount + k].positionX += step * xpos;
                        }
                        count += step * nLineCount;
                    }
                    while (vecChild[curTop * a.m_nBlankCount].positionX + vecChild[curTop * a.m_nBlankCount].width - vecChild[curTop * a.m_nBlankCount].anchorU * vecChild[curTop * a.m_nBlankCount].width + x < 0 &&
                        count < nVirtualLineCount - nLineCount) {
                        for (var k = 0; k < a.m_nBlankCount; k++)
                            vecChild[curTop * a.m_nBlankCount + k].positionX += xpos;
                        a.m_vecCurVirtualChildIndex[curTop] += nLineCount;
                        curTop++;
                        curTop %= nLineCount;
                        count++;
                    }
                }
            }
            if (a.m_pCurrentTouchDownScaleSprite != null) {
                a.m_pCurrentTouchDownScaleSprite.SetScale(a.m_vDownedObjScale.x - 0.05, a.m_vDownedObjScale.y - 0.05);
            }
            if (a.m_pEvent != null) {
                for (var i = 0; i < a.m_vecLastVirtualChildIndex.length; i++) {
                    if (a.m_vecLastVirtualChildIndex[i] != a.m_vecCurVirtualChildIndex[i]) {
                        if (i < a.m_nVirtualChildCount) {
                            for (var k = 0; k < a.m_nBlankCount; k++) {
                                var childIndex = i * a.m_nBlankCount + k;
                                var virtualIndex = a.m_vecCurVirtualChildIndex[i] * a.m_nBlankCount + k;
                                a.m_vecVirtualChildList[childIndex].visible = virtualIndex < a.m_nVirtualChildCount;
                                if (a.m_vecVirtualChildList[childIndex].visible) {
                                    a.OnShowVirtualChild(childIndex, virtualIndex, a.m_vecVirtualChildList[childIndex]);
                                }
                            }
                        }
                        a.m_vecLastVirtualChildIndex[i] = a.m_vecCurVirtualChildIndex[i];
                    }
                }
            }
        }
        a.m_bComputingVirtualChild = false;
    };
    dListBox.prototype.SetEvent = function (evt) {
        _super.prototype.SetEvent.call(this, evt);
        this.ComputeVirtualChild(this.GetViewPosX(), this.GetViewPosY());
    };
    dListBox.prototype.OnShowVirtualChild = function (childIndex, virtualIndex, pChild) {
        if (this.m_pEvent)
            this.m_pEvent.OnListShowVirtualChild(pChild, childIndex, virtualIndex);
    };
    dListBox.prototype.AdjustViewSize = function () {
        if (this.m_nVirtualChildCount > 0)
            this.UpdateViewSize();
        else
            _super.prototype.AdjustViewSize.call(this);
    };
    dListBox.prototype.UpdateViewSize = function () {
        var a = this;
        if (a.m_bBeginDsc)
            return;
        if (a.m_bUpdatingPerChild)
            return;
        var vecChild = this.m_pView.GetChildList();
        if (a.m_bVerticalList) {
            var maxX = 0;
            var xpos = 0;
            var ypos = 0;
            if (a.m_bHeaderHasSpace)
                ypos = a.m_fLineSpace;
            var maxHeight2;
            if (vecChild.length > 0) {
                var nLineCount = dMath.ToInt((vecChild.length + (a.m_nBlankCount - 1)) / a.m_nBlankCount);
                var nBlankCount = a.m_nBlankCount;
                if (a.m_nVirtualChildCount > -1) {
                    nLineCount = dMath.ToInt((a.m_nVirtualChildCount + (a.m_nBlankCount - 1)) / a.m_nBlankCount);
                }
                for (var j = 0; j < nLineCount; j++) {
                    xpos = 0;
                    maxHeight2 = 0;
                    if (a.m_bHeaderHasSpace)
                        xpos = a.m_fBlankSpace;
                    for (var i = 0; i < nBlankCount; i++) {
                        var index = j * nBlankCount + i;
                        if (a.m_nVirtualChildCount > -1)
                            index %= vecChild.length;
                        if (index < vecChild.length) {
                            var pChild = vecChild[index];
                            pChild.SetPos(pChild.GetWidth() * pChild.GetAnchorU() * pChild.GetScaleX() + xpos, pChild.GetHeight() * pChild.GetAnchorV() * pChild.GetScaleY() + ypos);
                            if (maxHeight2 < pChild.height * pChild.GetScaleY())
                                maxHeight2 = pChild.height * pChild.GetScaleY();
                            xpos += pChild.width * pChild.scaleX + a.m_fBlankSpace;
                        }
                    }
                    ypos += maxHeight2 + a.m_fLineSpace;
                    if (maxX < xpos)
                        maxX = xpos;
                }
            }
            if (!a.m_bHeaderHasSpace) {
                maxX -= a.m_fBlankSpace;
                ypos -= a.m_fLineSpace;
            }
            a._SetViewSize(maxX, ypos + a.m_fViewSizeOffsetBottom);
        }
        else {
            var maxY = 0;
            var xpos = 0;
            var ypos = 0;
            if (a.m_bHeaderHasSpace)
                xpos = a.m_fLineSpace;
            var maxWidth2;
            if (vecChild.length > 0) {
                var nLineCount = dMath.ToInt((vecChild.length + (a.m_nBlankCount - 1)) / a.m_nBlankCount);
                var nBlankCount = a.m_nBlankCount;
                if (a.m_nVirtualChildCount > -1) {
                    nLineCount = dMath.ToInt((a.m_nVirtualChildCount + (a.m_nBlankCount - 1)) / a.m_nBlankCount);
                }
                for (var j = 0; j < nLineCount; j++) {
                    ypos = 0;
                    maxWidth2 = 0;
                    if (a.m_bHeaderHasSpace)
                        ypos = a.m_fBlankSpace;
                    for (var i = 0; i < nBlankCount; i++) {
                        var index = j * nBlankCount + i;
                        if (a.m_nVirtualChildCount > -1)
                            index %= vecChild.length;
                        if (index < vecChild.length) {
                            var pChild = vecChild[index];
                            pChild.SetPos(pChild.GetWidth() * pChild.GetAnchorU() * pChild.GetScaleX() + xpos, pChild.GetHeight() * pChild.GetAnchorV() * pChild.GetScaleY() + ypos);
                            if (maxWidth2 < pChild.width * pChild.GetScaleX())
                                maxWidth2 = pChild.width * pChild.GetScaleX();
                            ypos += pChild.height * pChild.scaleY + a.m_fBlankSpace;
                        }
                    }
                    xpos += maxWidth2 + a.m_fLineSpace;
                    if (maxY < ypos)
                        maxY = ypos;
                }
            }
            if (!a.m_bHeaderHasSpace) {
                maxY -= a.m_fBlankSpace;
                xpos -= a.m_fLineSpace;
            }
            a._SetViewSize(xpos + a.m_fViewSizeOffsetRight, maxY);
        }
        a.ComputeVirtualChild(a.GetViewPosX(), a.GetViewPosY());
        a.UpdateSelection();
    };
    dListBox.prototype.UpdateVirtualChild = function () {
        if (this.m_vecLastVirtualChildIndex != null) {
            for (var i = 0; i < this.m_vecLastVirtualChildIndex.length; i++)
                this.m_vecLastVirtualChildIndex[i] = -1;
        }
        this.UpdateViewSize();
    };
    dListBox.prototype.SetSelect = function (nSel) {
        var vecChild = this.m_pView.GetChildList();
        if (nSel >= 0 && nSel < vecChild.length) {
            this.m_nSelect = nSel;
            this.UpdateSelection();
        }
    };
    dListBox.prototype.UpdateSelection = function () {
        var a = this;
        var vecChild = a.m_pView.GetChildList();
        var nSel = this.m_nSelect;
        if (nSel >= 0 && nSel < vecChild.length) {
            a.m_pSelect.SetSize(a.GetWidth(), vecChild[nSel].GetHeight());
            this.m_pSelect.SetPos(-a.GetWidth() * a.GetAnchorU() + a.m_pView.GetPosX(), vecChild[nSel].GetPosY() - vecChild[nSel].GetHeight() * vecChild[nSel].GetAnchorV() - a.GetHeight() * a.GetAnchorV() + a.m_pView.GetPosY());
        }
    };
    dListBox.prototype.GetSelect = function () {
        return this.m_nSelect;
    };
    dListBox.prototype.GetSelectObj = function () {
        var vecChild = this.m_pView.GetChildList();
        if (this.m_nSelect >= 0 && this.m_nSelect < vecChild.length)
            return vecChild[this.m_nSelect];
        return null;
    };
    dListBox.prototype.SetSize = function (width, height) {
        _super.prototype.SetSize.call(this, width, height);
        this.UpdateViewSize();
    };
    dListBox.prototype._SetViewPos = function (x, y) {
        _super.prototype._SetViewPos.call(this, x, y);
        this.UpdateSelection();
    };
    dListBox.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("vertical"))
            this.vertical = Boolean(dMath.ParseInt(json.vertical));
        if (json.hasOwnProperty("blankCount"))
            this.blankCount = dMath.ParseInt(json.blankCount);
        if (json.hasOwnProperty("lineSpace"))
            this.lineSpace = dMath.ParseFloat(json.lineSpace);
        if (json.hasOwnProperty("blankSpace"))
            this.blankSpace = dMath.ParseFloat(json.blankSpace);
    };
    return dListBox;
}(dScrollView));
var dListBoxPageView = (function (_super) {
    __extends(dListBoxPageView, _super);
    function dListBoxPageView() {
        var _this = _super.call(this) || this;
        _this.m_strCheckFileName = "";
        _this.m_strUncheckFileName = "";
        _this.m_fSpace = 0;
        _this.m_vecChecks = new Array();
        _this.m_nCurPage = 0;
        _this.SetPageCount(2);
        return _this;
    }
    dListBoxPageView.prototype.LoadFromFile = function (strUncheckedImageName) {
        var _this = this;
        if (this.m_strUncheckFileName != strUncheckedImageName) {
            this.m_strUncheckFileName = strUncheckedImageName;
            var callback = new dCompleteCallback(this);
            for (var i = 0; i < this.m_vecChecks.length; i++)
                this.m_vecChecks[i].LoadFromFile(strUncheckedImageName, callback.CreateCompleteFun_Normal());
            callback.SetCompleteFun(function () {
                _this.UpdatePos();
            });
        }
        return this;
    };
    dListBoxPageView.prototype.LoadCheckFromFile = function (strCheckedImageName) {
        var _this = this;
        if (this.m_strCheckFileName != strCheckedImageName) {
            this.m_strCheckFileName = strCheckedImageName;
            var callback = new dCompleteCallback(this);
            for (var i = 0; i < this.m_vecChecks.length; i++)
                this.m_vecChecks[i].LoadCheckFromFile(strCheckedImageName, callback.CreateCompleteFun_Normal());
            callback.SetCompleteFun(function () {
                _this.UpdatePos();
            });
        }
        return this;
    };
    dListBoxPageView.prototype.GetFileName = function () {
        return this.m_strUncheckFileName;
    };
    dListBoxPageView.prototype.GetCheckFileName = function () {
        return this.m_strCheckFileName;
    };
    Object.defineProperty(dListBoxPageView.prototype, "resourceFileName", {
        get: function () {
            return this.GetFileName();
        },
        set: function (fileName) {
            this.LoadFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dListBoxPageView.prototype, "checkImage", {
        get: function () {
            return this.GetCheckFileName();
        },
        set: function (fileName) {
            this.LoadCheckFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dListBoxPageView.prototype, "space", {
        get: function () {
            return this.m_fSpace;
        },
        set: function (value) {
            this.m_fSpace = value;
            this.UpdatePos();
        },
        enumerable: false,
        configurable: true
    });
    dListBoxPageView.prototype.SetPageCount = function (count) {
        var _this = this;
        if (count != this.m_vecChecks.length) {
            for (var i = count; i < this.m_vecChecks.length; i++)
                this.m_vecChecks[i].RemoveParent();
            this.m_vecChecks.resize(count);
            var callback = new dCompleteCallback(this);
            for (var i = 0; i < count; i++) {
                if (this.m_vecChecks[i] == null) {
                    this.m_vecChecks[i] = new dCheckBox();
                    callback.Add();
                    this.m_vecChecks[i].LoadFromFile(this.m_strUncheckFileName, function () {
                        callback.DoComplete();
                    });
                    callback.Add();
                    this.m_vecChecks[i].LoadCheckFromFile(this.m_strCheckFileName, function () {
                        callback.DoComplete();
                    });
                    this.m_vecChecks[i].SetHandleMouse(false);
                    this.AddChild(this.m_vecChecks[i]);
                }
            }
            callback.SetCompleteFun(function () {
                _this.UpdatePos();
            });
        }
        else
            this.UpdatePos();
    };
    dListBoxPageView.prototype.GetPageCount = function () {
        return this.m_vecChecks.length;
    };
    Object.defineProperty(dListBoxPageView.prototype, "pageCount", {
        get: function () {
            return this.GetPageCount();
        },
        set: function (count) {
            this.SetPageCount(count);
        },
        enumerable: false,
        configurable: true
    });
    dListBoxPageView.prototype.SetCurPage = function (curPage) {
        this.m_nCurPage = curPage;
        this.UpdateCurPageDot();
    };
    dListBoxPageView.prototype.GetCurPage = function () {
        return this.m_nCurPage;
    };
    dListBoxPageView.prototype.UpdatePos = function () {
        if (this.m_vecChecks.length > 0) {
            var totalWidth = this.m_vecChecks.length * this.m_vecChecks[0].width + this.m_fSpace * (this.m_vecChecks.length - 1);
            for (var i = 0; i < this.m_vecChecks.length; i++) {
                this.m_vecChecks[i].positionX = i * this.m_vecChecks[0].width + this.m_fSpace * i - (totalWidth * this.anchorU - this.m_vecChecks[0].width * this.anchorU);
            }
            this.UpdateCurPageDot();
        }
    };
    dListBoxPageView.prototype.UpdateCurPageDot = function () {
        for (var i = 0; i < this.m_vecChecks.length; i++)
            this.m_vecChecks[i].SetCheck(i == this.m_nCurPage);
    };
    dListBoxPageView.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("resourceFileName"))
            this.resourceFileName = json.resourceFileName;
        if (json.hasOwnProperty("checkImage"))
            this.checkImage = json.checkImage;
        if (json.hasOwnProperty("space"))
            this.space = dMath.ParseFloat(json.space);
        if (json.hasOwnProperty("pageCount"))
            this.pageCount = dMath.ParseInt(json.pageCount);
    };
    return dListBoxPageView;
}(dBaseControl));
var dMover = (function (_super) {
    __extends(dMover, _super);
    function dMover() {
        var _this = _super.call(this) || this;
        _this.m_pBkImage = new dImage();
        _this.m_pButton = new dImage();
        _this.m_vDir = new dVector2();
        _this.m_fDownPosX = 0;
        _this.m_fDownPosY = 0;
        _this.m_bTouchDowned = false;
        _this.m_fDirLength = 0;
        _this.AddChild(_this.m_pBkImage);
        _this.AddChild(_this.m_pButton);
        _this.m_pBkImage.SetShow(false);
        _this.m_pButton.SetShow(false);
        _this.SetHandleMouse(true);
        return _this;
    }
    dMover.prototype.IgnoreDirValue = function (value) {
        if (dMath.Abs(value) < 16)
            return 0;
        return value;
    };
    dMover.prototype.CheckGamepad = function () {
    };
    dMover.prototype.OnTouchDown = function (x, y, delta) {
        this.m_bTouchDowned = true;
        this.m_pBkImage.SetPos(x, y);
        this.m_pButton.SetPos(x, y);
        this.m_pBkImage.SetShow(true);
        this.m_pButton.SetShow(true);
        this.m_fDownPosX = x;
        this.m_fDownPosY = y;
        this.m_vDir.SetValue(this.m_pButton.GetPosX() - this.m_pBkImage.GetPosX(), this.m_pButton.GetPosY() - this.m_pBkImage.GetPosY());
        var length = this.m_vDir.Length();
        if (length > (this.m_pBkImage.GetWidth() - this.m_pButton.GetWidth() / 2) / 2)
            length = (this.m_pBkImage.GetWidth() - this.m_pButton.GetWidth() / 2) / 2;
        this.m_vDir.Normalize();
        this.m_pButton.SetPos(this.m_vDir.x * length + this.m_pBkImage.GetPosX(), this.m_vDir.y * length + this.m_pBkImage.GetPosY());
    };
    dMover.prototype.OnTouchMove = function (mouseX, mouseY, x, y, delta) {
        if (this.m_bTouchDowned) {
            this.m_fDownPosX += x;
            this.m_fDownPosY += y;
            this.m_pButton.SetPos(this.m_fDownPosX, this.m_fDownPosY);
            this.m_vDir.SetValue(this.m_pButton.GetPosX() - this.m_pBkImage.GetPosX(), this.m_pButton.GetPosY() - this.m_pBkImage.GetPosY());
            var length = this.m_vDir.Length();
            if (length > (this.m_pBkImage.GetWidth() - this.m_pButton.GetWidth() / 2) / 2)
                length = (this.m_pBkImage.GetWidth() - this.m_pButton.GetWidth() / 2) / 2;
            this.m_vDir.Normalize();
            this.m_fDirLength = length / ((this.m_pBkImage.GetWidth() - this.m_pButton.GetWidth() / 2) / 2);
            this.m_pButton.SetPos(this.m_vDir.x * length + this.m_pBkImage.GetPosX(), this.m_vDir.y * length + this.m_pBkImage.GetPosY());
        }
    };
    dMover.prototype.OnTouchUp = function (x, y) {
        this.m_bTouchDowned = false;
        this.m_pBkImage.SetShow(false);
        this.m_pButton.SetShow(false);
        this.m_vDir.SetValue(0, 0);
    };
    dMover.prototype.LoadFromFile = function (strBkImage, strButton) {
        this.m_pBkImage.LoadFromFile(strBkImage);
        this.m_pButton.LoadFromFile(strButton);
    };
    dMover.prototype.BreakTouch = function () {
        this.m_bTouchDowned = false;
        this.m_pBkImage.SetShow(false);
        this.m_pButton.SetShow(false);
        this.m_vDir.SetValue(0, 0);
    };
    dMover.prototype.SetAlpha = function (alpha, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetAlpha.call(this, alpha, bSetToChild);
        if (!bSetToChild) {
            this.m_pBkImage.SetAlpha(alpha, false);
            this.m_pButton.SetAlpha(alpha, false);
        }
    };
    dMover.prototype.SetColor = function (color, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetColor.call(this, color, bSetToChild);
        if (!bSetToChild) {
            this.m_pBkImage.SetColor(color, false);
            this.m_pButton.SetColor(color, false);
        }
    };
    dMover.prototype.GetDir = function () {
        return this.m_vDir;
    };
    dMover.prototype.GetDirLength = function () {
        return this.m_fDirLength;
    };
    Object.defineProperty(dMover.prototype, "resourceFileName", {
        get: function () {
            return this.m_pBkImage.resourceFileName;
        },
        set: function (fileName) {
            this.m_pBkImage.LoadFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dMover.prototype, "buttonFileName", {
        get: function () {
            return this.m_pButton.resourceFileName;
        },
        set: function (fileName) {
            this.m_pButton.LoadFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    dMover.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("resourceFileName"))
            this.resourceFileName = json.resourceFileName;
        if (json.hasOwnProperty("buttonFileName"))
            this.buttonFileName = json.buttonFileName;
    };
    return dMover;
}(dBaseControl));
var dProgress = (function (_super) {
    __extends(dProgress, _super);
    function dProgress() {
        var _this = _super.call(this) || this;
        _this.m_fValue = 100;
        _this.m_fMaxValue = 100;
        _this.m_pImage = null;
        _this.m_bScale9Type = 1;
        _this.m_nDirectionType = dProgress.DirectionType_LeftToRight;
        _this.m_strResourceFileName = "";
        return _this;
    }
    Object.defineProperty(dProgress.prototype, "resourceFileName", {
        get: function () {
            return this.GetFileName();
        },
        set: function (fileName) {
            this.LoadFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    dProgress.prototype.SetImage = function (image) {
        if (this.m_pImage != null)
            this.m_pImage.RemoveParent();
        this.m_pImage = image;
        this.m_pImage.SetDirection(this.m_nDirectionType);
        this.m_pImage.SetSize(this.width, this.height);
        this.m_pImage.SetPos(-this.width * this.anchorU, -this.height * this.anchorV);
        this.AddChild(this.m_pImage);
        this.Update();
    };
    dProgress.prototype.GetImage = function () {
        return this.m_pImage;
    };
    Object.defineProperty(dProgress.prototype, "scale9Type", {
        get: function () {
            return this.m_bScale9Type;
        },
        set: function (value) {
            this.m_bScale9Type = value;
            this._ReloadFileName(this.resourceFileName, false);
        },
        enumerable: false,
        configurable: true
    });
    dProgress.prototype.LoadFromFile = function (strImage, bAutoSetSize) {
        if (bAutoSetSize === void 0) { bAutoSetSize = true; }
        if (this.GetFileName() != strImage) {
            this.m_strResourceFileName = strImage;
            this._ReloadFileName(strImage, bAutoSetSize);
        }
        return this;
    };
    dProgress.prototype.GetProgressImage = function () {
        return this.m_pImage;
    };
    dProgress.prototype.SetDirectionType = function (direction) {
        this.m_nDirectionType = direction;
        if (this.m_pImage != null)
            this.m_pImage.SetDirection(direction);
        this.Update();
    };
    dProgress.prototype.GetDirectionType = function () {
        return this.m_nDirectionType;
    };
    Object.defineProperty(dProgress.prototype, "direction", {
        get: function () {
            return this.GetDirectionType();
        },
        set: function (direction) {
            this.SetDirectionType(direction);
        },
        enumerable: false,
        configurable: true
    });
    dProgress.prototype._ReloadFileName = function (strImage, bAutoSetSize) {
        var a = this;
        if (a.scale9Type == 2) {
            if (a.m_pImage == null || !(a.m_pImage instanceof ProgressImage_Clipped)) {
                if (a.m_pImage != null)
                    a.m_pImage.RemoveParent();
                a.m_pImage = new ProgressImage_Clipped();
                a.m_pImage.SetColor(a.spriteColor);
                a.m_pImage.SetDirection(a.m_nDirectionType);
                a.m_pImage.SetSize(a.width, a.height);
                a.m_pImage.SetPos(-a.width * a.anchorU, -a.height * a.anchorV);
                a.m_pImage.renderAs3D = a.renderAs3D;
                a.AddChild(a.m_pImage, 0);
            }
        }
        else if (a.scale9Type == 1) {
            if (a.m_pImage == null || !(a.m_pImage instanceof ProgressImage_Scale9)) {
                if (a.m_pImage != null)
                    a.m_pImage.RemoveParent();
                a.m_pImage = new ProgressImage_Scale9();
                a.m_pImage.SetColor(a.spriteColor);
                a.m_pImage.SetDirection(a.m_nDirectionType);
                a.m_pImage.SetSize(a.width, a.height);
                a.m_pImage.SetPos(-a.width * a.anchorU, -a.height * a.anchorV);
                a.m_pImage.renderAs3D = a.renderAs3D;
                a.AddChild(a.m_pImage, 0);
            }
        }
        else {
            if (a.m_pImage == null || !(a.m_pImage instanceof ProgressImage_Resize)) {
                if (a.m_pImage != null)
                    a.m_pImage.RemoveParent();
                a.m_pImage = new ProgressImage_Resize();
                a.m_pImage.SetColor(a.spriteColor);
                a.m_pImage.SetDirection(a.m_nDirectionType);
                a.m_pImage.SetSize(a.width, a.height);
                a.m_pImage.SetPos(-a.width * a.anchorU, -a.height * a.anchorV);
                a.m_pImage.renderAs3D = a.renderAs3D;
                a.AddChild(a.m_pImage, 0);
            }
        }
        a.m_pImage.LoadFromFile(strImage, function () {
            if (bAutoSetSize && a.m_pImage.GetBitmapData() != null && a.GetWidth() == 0 && a.GetHeight() == 0)
                a.SetSize(a.m_pImage.GetBitmapData().GetWidth(), a.m_pImage.GetBitmapData().GetHeight());
        });
        a.Update();
    };
    dProgress.prototype.GetFileName = function () {
        return this.m_strResourceFileName;
    };
    Object.defineProperty(dProgress.prototype, "value", {
        get: function () {
            return this.m_fValue;
        },
        set: function (v) {
            if (v != this.m_fValue) {
                this.m_fValue = v;
                this.Update();
            }
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dProgress.prototype, "maxValue", {
        get: function () {
            return this.m_fMaxValue;
        },
        set: function (v) {
            if (v != this.m_fMaxValue) {
                this.m_fMaxValue = v;
                this.Update();
            }
        },
        enumerable: false,
        configurable: true
    });
    dProgress.prototype.SetAnchor = function (u, v) {
        var a = this;
        if (u != a.m_fAnchorU || v != a.m_fAnchorV) {
            _super.prototype.SetAnchor.call(this, u, v);
            if (a.m_pImage != null) {
                a.m_pImage.SetPos(-a.width * a.anchorU, -a.height * a.anchorV);
            }
        }
    };
    dProgress.prototype.SetColor = function (colorARGB, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetColor.call(this, colorARGB, bSetToChild);
        if (!bSetToChild) {
            if (this.m_pImage != null)
                this.m_pImage.SetColor(colorARGB);
        }
    };
    dProgress.prototype.SetShader = function (pShader, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetShader.call(this, pShader, bSetToChild);
        if (!bSetToChild) {
            if (this.m_pImage != null)
                this.m_pImage.SetShader(pShader);
        }
    };
    dProgress.prototype.SetSize = function (width, height) {
        if (width != this.m_fWidth || height != this.m_fHeight) {
            _super.prototype.SetSize.call(this, width, height);
            if (this.m_pImage != null) {
                this.m_pImage.SetSize(this.width, this.height);
                this.m_pImage.SetPos(-this.width * this.anchorU, -this.height * this.anchorV);
            }
            this.Update();
        }
    };
    dProgress.prototype.EndDsc = function () {
        _super.prototype.EndDsc.call(this);
        this.Update();
    };
    dProgress.prototype.Update = function () {
        if (this.m_bBeginDsc)
            return;
        if (this.m_pImage != null) {
            var cur = this.m_fValue;
            if (cur < 0)
                cur = 0;
            else if (cur > this.m_fMaxValue)
                cur = this.m_fMaxValue;
            this.m_pImage.UpdateValue(cur / this.m_fMaxValue);
        }
    };
    dProgress.prototype.GetValue = function () {
        return this.m_fValue;
    };
    dProgress.prototype.GetMaxValue = function () {
        return this.m_fMaxValue;
    };
    dProgress.prototype.SetValueAndMax = function (value, max) {
        if (value != this.m_fValue || this.m_fMaxValue != max) {
            this.m_fMaxValue = max;
            this.m_fValue = value;
            this.Update();
        }
    };
    dProgress.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("resourceFileName"))
            this.resourceFileName = json.resourceFileName;
        if (json.hasOwnProperty("scale9Type"))
            this.scale9Type = dMath.ParseInt(json.scale9Type);
        if (json.hasOwnProperty("direction"))
            this.direction = dMath.ParseInt(json.direction);
        if (json.hasOwnProperty("value"))
            this.value = dMath.ParseFloat(json.value);
        if (json.hasOwnProperty("maxValue"))
            this.maxValue = dMath.ParseFloat(json.maxValue);
    };
    dProgress.DirectionType_LeftToRight = 0;
    dProgress.DirectionType_RightToLeft = 1;
    dProgress.DirectionType_TopToBottom = 2;
    dProgress.DirectionType_BottomToTop = 3;
    dProgress.Type_Resize = 0;
    dProgress.Type_Scale9 = 1;
    dProgress.Type_Clipped = 2;
    return dProgress;
}(dBaseControl));
var ProgressImage_Base = (function (_super) {
    __extends(ProgressImage_Base, _super);
    function ProgressImage_Base() {
        var _this = _super.call(this) || this;
        _this.m_nDirection = 0;
        return _this;
    }
    ProgressImage_Base.prototype.LoadFromFile = function (fileName, onComplete) {
    };
    ProgressImage_Base.prototype.SetDirection = function (direction) {
        this.m_nDirection = direction;
    };
    ProgressImage_Base.prototype.UpdateValue = function (value) {
    };
    ProgressImage_Base.prototype.GetImage = function () {
        return null;
    };
    ProgressImage_Base.prototype.SetColor = function (colorARGB, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetColor.call(this, colorARGB, bSetToChild);
        if (!bSetToChild && this.GetImage() != null)
            this.GetImage().SetColor(colorARGB, false);
    };
    ProgressImage_Base.prototype.SetAlpha = function (alpha, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetAlpha.call(this, alpha, bSetToChild);
        if (!bSetToChild && this.GetImage() != null)
            this.GetImage().SetAlpha(alpha, false);
    };
    ProgressImage_Base.prototype.SetShader = function (pShader, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetShader.call(this, pShader, bSetToChild);
        if (!bSetToChild && this.GetImage() != null)
            this.GetImage().SetShader(pShader, false);
    };
    ProgressImage_Base.prototype.SetEnableZReadWrite = function (disable_r_rw, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetEnableZReadWrite.call(this, disable_r_rw, bSetToChild);
        if (!bSetToChild && this.GetImage() != null)
            this.GetImage().SetEnableZReadWrite(disable_r_rw, false);
    };
    return ProgressImage_Base;
}(dBaseControl));
var ProgressImage_Scale9 = (function (_super) {
    __extends(ProgressImage_Scale9, _super);
    function ProgressImage_Scale9() {
        var _this = _super.call(this) || this;
        _this.m_pImage = new dScale9();
        _this.m_pImage.SetAnchor(0, 0);
        _this.AddChild(_this.m_pImage);
        return _this;
    }
    ProgressImage_Scale9.prototype.GetImage = function () {
        return this.m_pImage;
    };
    ProgressImage_Scale9.prototype.LoadFromFile = function (fileName, onComplete) {
        this.m_pImage.LoadFromFile(fileName, onComplete);
    };
    ProgressImage_Scale9.prototype.UpdateValue = function (value) {
        switch (this.m_nDirection) {
            case dProgress.DirectionType_LeftToRight:
                this.m_pImage.SetSize(value * this.width, this.height);
                this.m_pImage.SetPos(0, 0);
                break;
            case dProgress.DirectionType_RightToLeft:
                this.m_pImage.SetSize(value * this.width, this.height);
                this.m_pImage.SetPos(this.width - this.m_pImage.width, 0);
                break;
            case dProgress.DirectionType_TopToBottom:
                this.m_pImage.SetSize(this.width, value * this.height);
                this.m_pImage.SetPos(0, 0);
                break;
            case dProgress.DirectionType_BottomToTop:
                this.m_pImage.SetSize(this.width, value * this.height);
                this.m_pImage.SetPos(0, this.height - this.m_pImage.height);
                break;
        }
    };
    return ProgressImage_Scale9;
}(ProgressImage_Base));
var ProgressImage_Resize = (function (_super) {
    __extends(ProgressImage_Resize, _super);
    function ProgressImage_Resize() {
        var _this = _super.call(this) || this;
        _this.m_pImage = new dImage();
        _this.m_pImage.SetAnchor(0, 0);
        _this.AddChild(_this.m_pImage);
        return _this;
    }
    ProgressImage_Resize.prototype.GetImage = function () {
        return this.m_pImage;
    };
    ProgressImage_Resize.prototype.LoadFromFile = function (fileName, onComplete) {
        this.m_pImage.LoadFromFile(fileName, onComplete);
    };
    ProgressImage_Resize.prototype.UpdateValue = function (value) {
        switch (this.m_nDirection) {
            case dProgress.DirectionType_LeftToRight:
                this.m_pImage.SetSize(value * this.width, this.height);
                this.m_pImage.SetPos(0, 0);
                break;
            case dProgress.DirectionType_RightToLeft:
                this.m_pImage.SetSize(value * this.width, this.height);
                this.m_pImage.SetPos(this.width - this.m_pImage.width, 0);
                break;
            case dProgress.DirectionType_TopToBottom:
                this.m_pImage.SetSize(this.width, value * this.height);
                this.m_pImage.SetPos(0, 0);
                break;
            case dProgress.DirectionType_BottomToTop:
                this.m_pImage.SetSize(this.width, value * this.height);
                this.m_pImage.SetPos(0, this.height - this.m_pImage.height);
                break;
        }
    };
    return ProgressImage_Resize;
}(ProgressImage_Base));
var ProgressImage_Clipped = (function (_super) {
    __extends(ProgressImage_Clipped, _super);
    function ProgressImage_Clipped() {
        var _this = _super.call(this) || this;
        _this.m_pClip = new dSprite();
        _this.m_pImage = new dImage();
        _this.m_pClip.clipChild = true;
        _this.m_pImage.SetAnchor(0, 0);
        _this.AddChild(_this.m_pClip);
        _this.m_pClip.AddChild(_this.m_pImage);
        return _this;
    }
    ProgressImage_Clipped.prototype.SetSize = function (w, h) {
        _super.prototype.SetSize.call(this, w, h);
        this.m_pImage.SetSize(w, h);
    };
    ProgressImage_Clipped.prototype.GetImage = function () {
        return this.m_pImage;
    };
    ProgressImage_Clipped.prototype.LoadFromFile = function (fileName, onComplete) {
        this.m_pImage.LoadFromFile(fileName, onComplete);
        this.m_pImage.SetSize(this.width, this.height);
    };
    ProgressImage_Clipped.prototype.UpdateValue = function (value) {
        switch (this.m_nDirection) {
            case dProgress.DirectionType_LeftToRight:
                this.m_pClip.SetSize(value * this.width, this.height);
                this.m_pClip.SetPos(0, 0);
                break;
            case dProgress.DirectionType_RightToLeft:
                this.m_pClip.SetSize(value * this.width, this.height);
                this.m_pClip.SetPos(this.width - this.m_pClip.width, 0);
                break;
            case dProgress.DirectionType_TopToBottom:
                this.m_pClip.SetSize(this.width, value * this.height);
                this.m_pClip.SetPos(0, 0);
                break;
            case dProgress.DirectionType_BottomToTop:
                this.m_pClip.SetSize(this.width, value * this.height);
                this.m_pClip.SetPos(0, this.height - this.m_pClip.height);
                break;
        }
        this.m_pImage.SetPos(-this.m_pClip.positionX, -this.m_pClip.positionY);
    };
    return ProgressImage_Clipped;
}(ProgressImage_Base));
var dRepeatImage = (function (_super) {
    __extends(dRepeatImage, _super);
    function dRepeatImage() {
        var _this = _super.call(this) || this;
        _this.m_vecImage = new Array();
        _this.m_pImageCliper = new dSprite();
        _this.m_nForceWidthCount = 0;
        _this.m_nForceHeightCount = 0;
        _this.m_rcSourceRect = new dRect(0, 0, 1, 1);
        _this.SetAnchor(0.5, 0.5);
        _this.AddChild(_this.m_pImageCliper);
        _this.m_pImageCliper.SetAnchor(0.5, 0.5);
        _this.m_pImageCliper.SetLayoutAlign(dSprite.LAYOUT_ALIGN_RESIZE, dSprite.LAYOUT_ALIGN_RESIZE);
        _this.m_pImageCliper.SetClipChild(true);
        return _this;
    }
    dRepeatImage.prototype.LoadFromFile = function (strImage, onLoadComplete, bAutoResize, rcSrc) {
        var _this = this;
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (bAutoResize === void 0) { bAutoResize = true; }
        if (rcSrc === void 0) { rcSrc = null; }
        if (strImage != null && this.GetFileName() != strImage) {
            if (strImage != "") {
                this.m_pImageBitmapData = new dBitmapData();
                this.m_pImageBitmapData.LoadFromFile(strImage, function () {
                    _this.SetBitmapData(_this.m_pImageBitmapData);
                });
            }
            else if (this.GetBitmapData() != null)
                this.SetBitmapData(null);
        }
        return this;
    };
    dRepeatImage.prototype.SetBitmapData = function (bmp, rc, at, sampleType) {
        if (rc === void 0) { rc = null; }
        if (at === void 0) { at = 0; }
        if (sampleType === void 0) { sampleType = 0; }
        if (at == 0) {
            this.m_pImageBitmapData = bmp;
            if (rc != null)
                this.m_rcSourceRect.Copy(rc);
            else if (bmp != null)
                this.m_rcSourceRect.SetValue(0, 0, 1, 1);
            else
                this.m_rcSourceRect.SetValue(0, 0, 0, 0);
            for (var i = 0; i < this.m_vecImage.length; i++) {
                this.m_vecImage[i].SetBitmapData(this.m_pImageBitmapData, this.m_rcSourceRect, at, sampleType);
                this.m_vecImage[i].SetSize(this.m_rcSourceRect.Width() * bmp.GetWidth(), this.m_rcSourceRect.Height() * bmp.GetHeight());
            }
            this.UpdateSize();
        }
    };
    dRepeatImage.prototype.GetBitmapData = function (at) {
        if (at === void 0) { at = 0; }
        return this.m_pImageBitmapData;
    };
    dRepeatImage.prototype.SetColor = function (colorARGB, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        if (!bSetToChild) {
            for (var i = 0; i < this.m_vecImage.length; i++)
                this.m_vecImage[i].SetColor(colorARGB);
        }
        _super.prototype.SetColor.call(this, colorARGB, bSetToChild);
    };
    dRepeatImage.prototype.SetSize = function (width, height) {
        _super.prototype.SetSize.call(this, width, height);
        this.m_pImageCliper.SetSize(width, height);
        this.UpdateSize();
    };
    dRepeatImage.prototype.EndDsc = function () {
        _super.prototype.EndDsc.call(this);
        this.UpdateSize();
    };
    dRepeatImage.prototype.UpdateSize = function () {
        var a = this;
        if (a.m_bBeginDsc)
            return;
        var bmpWidth = a.GetImageWidth();
        var bmpHeight = a.GetImageHeight();
        if (a.m_pImageBitmapData != null && bmpWidth > 0 && bmpHeight > 0) {
            var widthCount;
            if (a.m_nForceWidthCount == 0)
                widthCount = dMath.Ceil(a.GetWidth() / bmpWidth);
            else
                widthCount = a.m_nForceWidthCount;
            var heightCount;
            if (a.m_nForceHeightCount == 0)
                heightCount = dMath.Ceil(a.GetHeight() / bmpHeight);
            else
                heightCount = this.m_nForceHeightCount;
            widthCount = dMath.Abs(widthCount);
            heightCount = dMath.Abs(heightCount);
            for (var i = widthCount * heightCount; i < a.m_vecImage.length; i++)
                if (this.m_vecImage[i] != null)
                    a.m_vecImage[i].RemoveParent();
            a.m_vecImage.resize(widthCount * heightCount);
            for (var i = 0; i < this.m_vecImage.length; i++) {
                if (a.m_vecImage[i] == null) {
                    a.m_vecImage[i] = new dSprite();
                    a.m_vecImage[i].SetBitmapData(a.m_pImageBitmapData, a.m_rcSourceRect);
                    a.m_vecImage[i].SetColor(this.spriteColor);
                    a.m_vecImage[i].SetSize(bmpWidth, bmpHeight);
                    a.m_vecImage[i].SetLayoutAlign(dSprite.LAYOUT_ALIGN_LEFT_TOP, dSprite.LAYOUT_ALIGN_LEFT_TOP);
                    a.m_pImageCliper.AddChild(a.m_vecImage[i]);
                }
                a.m_vecImage[i].SetPos((i % widthCount) * a.m_vecImage[i].width - this.width * this.anchorU, dMath.ToInt(i / widthCount) * a.m_vecImage[i].height - this.height * this.anchorV);
            }
        }
    };
    dRepeatImage.prototype.SetAnchor = function (u, v) {
        var a = this;
        _super.prototype.SetAnchor.call(this, u, v);
        if (a.m_pImageCliper != null)
            a.m_pImageCliper.SetAnchor(u, v);
        a.UpdateSize();
    };
    Object.defineProperty(dRepeatImage.prototype, "forceWidthCount", {
        get: function () {
            return this.m_nForceWidthCount;
        },
        set: function (value) {
            this.m_nForceWidthCount = value;
            this.UpdateSize();
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dRepeatImage.prototype, "forceHeightCount", {
        get: function () {
            return this.m_nForceHeightCount;
        },
        set: function (value) {
            this.m_nForceHeightCount = value;
            this.UpdateSize();
        },
        enumerable: false,
        configurable: true
    });
    dRepeatImage.prototype.GetImageWidth = function () {
        if (this.m_rcSourceRect == null || this.m_pImageBitmapData == null)
            return 0;
        return this.GetBitmapSourceRect().Width() * this.m_pImageBitmapData.GetWidth();
    };
    dRepeatImage.prototype.GetImageHeight = function () {
        if (this.m_rcSourceRect == null || this.m_pImageBitmapData == null)
            return 0;
        return this.GetBitmapSourceRect().Height() * this.m_pImageBitmapData.GetHeight();
    };
    dRepeatImage.prototype.GetBitmapSourceRect = function () {
        return this.m_rcSourceRect;
    };
    return dRepeatImage;
}(dImage));
var dRoundList = (function (_super) {
    __extends(dRoundList, _super);
    function dRoundList() {
        var _this = _super.call(this) || this;
        _this.m_fAngle = 0;
        _this.m_fAngleOffset = dMath.dPI / 2;
        _this.m_fScaleMin = 0.2;
        _this.m_fScaleMax = 0.7;
        _this.m_nLastSendCurSel = 0;
        _this.m_bSortingChild = false;
        _this.m_pTimer = null;
        _this.m_vecChild = new Array();
        _this.SetHandleMouse(true);
        return _this;
    }
    Object.defineProperty(dRoundList.prototype, "scaleMin", {
        get: function () {
            return this.m_fScaleMin;
        },
        set: function (v) {
            this.m_fScaleMin = v;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dRoundList.prototype, "scaleMax", {
        get: function () {
            return this.m_fScaleMax;
        },
        set: function (v) {
            this.m_fScaleMax = v;
        },
        enumerable: false,
        configurable: true
    });
    dRoundList.prototype.SetSize = function (w, h) {
        _super.prototype.SetSize.call(this, w, h);
        this.UpdateChild();
    };
    dRoundList.prototype.OnTouchMove = function (mouseX, mouseY, x, y, delta) {
        var w = this.GetWidth() / 2;
        if (w == 0)
            w = 1;
        this.m_fAngle -= x / w;
        this.m_fAngle %= dMath.dPI * 2;
        this.UpdateChild();
        _super.prototype.OnTouchMove.call(this, mouseX, mouseY, x, y, delta);
    };
    dRoundList.prototype.OnTouchUp = function (x, y) {
        var curSel = this.GetCurSel();
        this.SetCurSel(curSel);
        if (this.m_nLastSendCurSel != curSel && this.m_pEvent != null) {
            this.m_pEvent.OnListShowViewEnd(curSel);
            this.m_nLastSendCurSel = curSel;
        }
        _super.prototype.OnTouchUp.call(this, x, y);
    };
    dRoundList.prototype.AddChild = function (pChild, at) {
        if (at === void 0) { at = -1; }
        _super.prototype.AddChild.call(this, pChild, at);
        if (!this.m_bSortingChild) {
            this.m_vecChild.remove(pChild);
            if (at == -1)
                this.m_vecChild.push(pChild);
            else
                this.m_vecChild.insert(at, pChild);
            this.UpdateChild();
        }
    };
    dRoundList.prototype.RemoveChild = function (pChild) {
        _super.prototype.RemoveChild.call(this, pChild);
        if (!this.m_bSortingChild) {
            this.UpdateChild();
            this.m_vecChild.remove(pChild);
        }
    };
    dRoundList.prototype.SortChild = function () {
        this.m_bSortingChild = true;
        _super.prototype.SortChild.call(this, function (a1, a2) {
            return a1.GetPosY() - a2.GetPosY();
        });
        this.m_bSortingChild = false;
    };
    dRoundList.prototype.UpdateChild = function () {
        var vecChild = this.m_vecChild;
        for (var i = 0, n = vecChild.length; i < n; i++) {
            var angle = i / vecChild.length * (dMath.dPI * 2) + this.m_fAngle;
            var x = -dMath.Sin(angle) * this.GetWidth() / 2;
            var y = dMath.Cos(angle) * this.GetHeight() / 2;
            vecChild[i].SetPos(x, y);
            var value = (y + this.GetHeight() / 2) / this.GetHeight();
            var scale = value * (this.m_fScaleMax - this.m_fScaleMin) + this.m_fScaleMin;
            vecChild[i].SetScale(scale, scale);
            vecChild[i].SetAlpha(scale + 0.3);
            var bri = value * 0.5 + 0.5;
            vecChild[i].SetBrightness(bri - 1);
        }
        this.SortChild();
        var curSel = this.GetCurSel();
        if (this.m_nLastSendCurSel != curSel && this.m_pEvent != null) {
            this.m_pEvent.OnListShowView(curSel);
            this.m_nLastSendCurSel = curSel;
        }
    };
    dRoundList.prototype.SetCurSel = function (index) {
        var _this = this;
        var vecChild = this.m_vecChild;
        if (vecChild.length == 0)
            return;
        index %= vecChild.length;
        var angle = index / vecChild.length * (dMath.dPI * 2);
        if (this.m_pTimer != null)
            this.m_pTimer.Stop();
        this.m_pTimer = new dTimer();
        this.m_pTimer.Create(0, 20, function (p, iTimer, fTimer) {
            _this.m_fAngle = dMath.LerpAngle(_this.m_fAngle, angle, 0.25);
            if (dMath.Abs(_this.m_fAngle - angle) < 0.01) {
                _this.m_fAngle = angle;
                _this.m_pTimer.Stop();
                _this.m_pTimer = null;
            }
            _this.UpdateChild();
        });
        this.UpdateChild();
    };
    dRoundList.prototype.GetCurSel = function () {
        var vecChild = this.m_vecChild;
        if (vecChild.length == 0)
            return 0;
        var per = (dMath.dPI * 2) / vecChild.length;
        var ret = this.m_fAngle / per;
        var ret2 = dMath.Round(ret) % vecChild.length;
        if (ret2 < 0)
            return vecChild.length + ret2;
        return ret2;
    };
    return dRoundList;
}(dBaseControl));
var dSlider = (function (_super) {
    __extends(dSlider, _super);
    function dSlider() {
        var _this = _super.call(this) || this;
        _this.m_pButton = new dImage();
        _this.m_fValue = 1;
        _this.m_fMaxValue = 1;
        _this.m_bButtonTouchMoved = false;
        _this.AddChild(_this.m_pButton);
        _this.m_pButton.SetHandleMouse(true);
        var pTouchEvent = new dSprite();
        pTouchEvent.OnTouchMove = function (x, y, offx, offy, delta) {
            _this.m_pButton.positionX += offx / _this.m_pButton.GetMatrixWorld()._11;
            if (_this.m_pButton.positionX < -_this.anchorU * _this.width)
                _this.m_pButton.positionX = -_this.anchorU * _this.width;
            else if (_this.m_pButton.positionX > _this.width - _this.anchorU * _this.width)
                _this.m_pButton.positionX = _this.width - _this.anchorU * _this.width;
            var value = (_this.m_pButton.positionX + _this.anchorU * _this.width) / _this.width;
            _this.m_fValue = value * _this.m_fMaxValue;
            _this.m_bButtonTouchMoved = true;
            if (_this.m_pEvent != null)
                _this.m_pEvent.OnSliderValueChanging(_this);
        };
        pTouchEvent.OnTouchUp = function (x, y) {
            if (_this.m_bButtonTouchMoved) {
                _this.m_bButtonTouchMoved = false;
                if (_this.m_pEvent != null)
                    _this.m_pEvent.OnSliderValueChangeFinished(_this);
            }
        };
        _this.m_pButton.SetTouchEvent(pTouchEvent);
        return _this;
    }
    dSlider.prototype.LoadFromFile = function (strImage, onLoadComplete, rcSource) {
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (rcSource === void 0) { rcSource = null; }
        this.m_pButton.LoadFromFile(strImage, onLoadComplete, true, rcSource);
        this.Update();
        return this;
    };
    dSlider.prototype.GetFileName = function () {
        return this.m_pButton.GetFileName();
    };
    Object.defineProperty(dSlider.prototype, "resourceFileName", {
        get: function () {
            return this.GetFileName();
        },
        set: function (fileName) {
            this.LoadFromFile(fileName);
        },
        enumerable: false,
        configurable: true
    });
    dSlider.prototype.SetSize = function (w, h) {
        _super.prototype.SetSize.call(this, w, h);
        this.Update();
    };
    dSlider.prototype.Update = function () {
        this.m_pButton.SetPos(this.width * this.m_fValue / this.m_fMaxValue - this.anchorU * this.width, this.height * 0.5 - this.anchorV * this.height);
    };
    dSlider.prototype.SetValue = function (v) {
        if (v != this.m_fValue) {
            this.m_fValue = v;
            this.Update();
        }
    };
    dSlider.prototype.GetValue = function () {
        return this.m_fValue;
    };
    Object.defineProperty(dSlider.prototype, "value", {
        get: function () {
            return this.m_fValue;
        },
        set: function (v) {
            this.SetValue(v);
        },
        enumerable: false,
        configurable: true
    });
    dSlider.prototype.SetMaxValue = function (v) {
        if (v != this.m_fMaxValue) {
            this.m_fMaxValue = v;
            this.Update();
        }
    };
    dSlider.prototype.GetMaxValue = function () {
        return this.m_fMaxValue;
    };
    Object.defineProperty(dSlider.prototype, "maxValue", {
        get: function () {
            return this.m_fMaxValue;
        },
        set: function (v) {
            this.SetMaxValue(v);
        },
        enumerable: false,
        configurable: true
    });
    dSlider.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("resourceFileName"))
            this.resourceFileName = json.resourceFileName;
    };
    return dSlider;
}(dBaseControl));
var dTabView = (function (_super) {
    __extends(dTabView, _super);
    function dTabView() {
        return _super.call(this) || this;
    }
    dTabView.prototype.AddChild = function (pChild, at) {
        if (at === void 0) { at = -1; }
        _super.prototype.AddChild.call(this, pChild, at);
        this.SetFrame(this.GetCurSel());
    };
    dTabView.prototype.SetFrame = function (frame) {
        this.m_nSpriteFrame = frame;
        var nFrame = dMath.ToInt(frame);
        var vecChild = this.GetChildList();
        for (var i = 0, n = vecChild.length; i < n; i++)
            vecChild[i].SetShow(i == nFrame);
    };
    dTabView.prototype.GetCurSel = function () {
        return this.m_nSpriteFrame;
    };
    dTabView.prototype.GetCurShowPage = function () {
        if (this.m_nSpriteFrame >= 0 && this.m_nSpriteFrame < this.GetChildList().length)
            return this.GetChildList()[this.m_nSpriteFrame];
        return null;
    };
    Object.defineProperty(dTabView.prototype, "showPage", {
        get: function () {
            return this.GetFrame();
        },
        set: function (index) {
            this.SetFrame(index);
        },
        enumerable: false,
        configurable: true
    });
    return dTabView;
}(dBaseControl));
var dTileImage = (function (_super) {
    __extends(dTileImage, _super);
    function dTileImage() {
        var _this = _super.call(this) || this;
        _this.m_pBitmapData = null;
        _this.m_vecImage = new Array();
        _this.m_pTileLayer = new dSprite();
        _this.m_nTileWidth = 0;
        _this.m_nTileHeight = 0;
        _this.m_nWidthCount = 0;
        _this.m_nHeightCount = 0;
        _this.m_nTileSpaceX = 0;
        _this.m_nTileSpaceY = 0;
        _this.m_nTileStartOffsetX = 0;
        _this.m_nTileStartOffsetY = 0;
        _this.m_data = null;
        _this.m_indexProperty = null;
        _this.AddChild(_this.m_pTileLayer);
        _this.UpdateTile();
        return _this;
    }
    dTileImage.prototype.SetTileData = function (tileWidth, tileHeight, widthCount, heightCount, data, tileSpaceX, tileSpaceY, bAutoUpdate) {
        if (tileSpaceX === void 0) { tileSpaceX = 0; }
        if (tileSpaceY === void 0) { tileSpaceY = 0; }
        if (bAutoUpdate === void 0) { bAutoUpdate = true; }
        this.m_nTileWidth = tileWidth;
        this.m_nTileHeight = tileHeight;
        this.m_nWidthCount = widthCount;
        this.m_nHeightCount = heightCount;
        this.m_nTileSpaceX = tileSpaceX;
        this.m_nTileSpaceY = tileSpaceY;
        this.m_data = data;
        if (bAutoUpdate)
            this.UpdateTile();
    };
    dTileImage.prototype.LoadFromFile = function (strImage, onLoadComplete, bAutoResize, rcSrc) {
        var _this = this;
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (bAutoResize === void 0) { bAutoResize = true; }
        if (rcSrc === void 0) { rcSrc = null; }
        if (strImage != null) {
            if (strImage != "") {
                var bmp = new dBitmapData();
                bmp.LoadFromFile(strImage, function (sender) {
                    _this.UpdateTile();
                    if (onLoadComplete != null)
                        onLoadComplete(sender);
                });
                this.SetBitmapData(bmp);
            }
            else
                this.SetBitmapData(null);
        }
        this.UpdateTile();
        return this;
    };
    Object.defineProperty(dTileImage.prototype, "pureColor", {
        get: function () {
            return false;
        },
        set: function (bSet) {
        },
        enumerable: false,
        configurable: true
    });
    dTileImage.prototype.SetBitmapData = function (bmp, rc, at, sampleType) {
        if (rc === void 0) { rc = null; }
        if (at === void 0) { at = 0; }
        if (sampleType === void 0) { sampleType = 0; }
        this.m_pBitmapData = bmp;
        if (bmp == null) {
            for (var i = 0; i < this.m_vecImage.length; i++) {
                if (this.m_vecImage[i] != null)
                    this.m_vecImage[i].SetBitmapData(null);
            }
        }
    };
    dTileImage.prototype.GetBitmapData = function (at) {
        if (at === void 0) { at = 0; }
        return this.m_pBitmapData;
    };
    dTileImage.prototype.SetColor = function (colorARGB, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        _super.prototype.SetColor.call(this, colorARGB, bSetToChild);
        if (!bSetToChild) {
            for (var i = 0; i < this.m_vecImage.length; i++) {
                if (this.m_vecImage[i] != null)
                    this.m_vecImage[i].SetColor(colorARGB, bSetToChild);
            }
        }
    };
    dTileImage.prototype.SetBlendMode = function (mode, bWithChild) {
        if (bWithChild === void 0) { bWithChild = false; }
        _super.prototype.SetBlendMode.call(this, mode, bWithChild);
        if (!bWithChild) {
            for (var i = 0; i < this.m_vecImage.length; i++) {
                if (this.m_vecImage[i] != null)
                    this.m_vecImage[i].SetBlendMode(mode, bWithChild);
            }
        }
    };
    dTileImage.prototype.SetAnchor = function (u, v) {
        _super.prototype.SetAnchor.call(this, u, v);
        if (this.m_vecImage != null)
            this.UpdateTile();
    };
    dTileImage.prototype.GetTileImage = function (x, y) {
        if (x >= 0 && y >= 0 && x < this.m_nWidthCount && y < this.m_nHeightCount)
            return this.m_vecImage[y * this.m_nWidthCount + x];
        return null;
    };
    dTileImage.prototype.UpdateTile = function (rc) {
        if (rc === void 0) { rc = null; }
        if (this.GetBitmapData() == null || this.GetBitmapData().isLoading())
            return;
        this.SetSize(this.m_nWidthCount * this.m_nTileWidth, this.m_nHeightCount * this.m_nTileHeight);
        for (var i = this.m_nWidthCount * this.m_nHeightCount, n = this.m_vecImage.length; i < n; i++) {
            if (this.m_vecImage[i] != null)
                this.m_vecImage[i].RemoveParent();
        }
        this.m_vecImage.resize(this.m_nWidthCount * this.m_nHeightCount);
        var split;
        for (var i = 0, n = this.m_vecImage.length; i < n; i++) {
            var pImage = this.m_vecImage[i];
            var x = i % this.m_nWidthCount;
            var y = i / this.m_nWidthCount;
            if (rc != null && (x < rc.left || y < rc.top || x >= rc.right || y >= rc.bottom))
                return;
            var index = 0;
            var aniCount = 0;
            if (this.m_data != null && i >= 0 && i < this.m_data.length) {
                index = this.m_data[i] & 0xFFFF;
            }
            if (this.m_indexProperty != null && index < this.m_indexProperty.length) {
                aniCount = this.m_indexProperty[index];
            }
            if (index == 0 || this.m_pBitmapData == null || this.m_pBitmapData.GetWidth() == 0) {
                if (pImage != null)
                    pImage.SetBitmapData(null);
            }
            else {
                if (this.m_vecImage[i] == null) {
                    this.m_vecImage[i] = new dImage();
                    this.m_vecImage[i].SetAnchor(0, 0);
                    this.m_vecImage[i].SetColor(this.GetColor());
                    this.m_vecImage[i].SetBlendMode(this.GetBlendMode());
                    this.m_pTileLayer.AddChild(this.m_vecImage[i]);
                    pImage = this.m_vecImage[i];
                }
                var tile_width = (this.m_nTileWidth + this.m_nTileSpaceX * 2);
                var tile_height = (this.m_nTileHeight + this.m_nTileSpaceY * 2);
                var xx = (index - 1) % (this.m_pBitmapData.GetWidth() / tile_width);
                var yy = (index - 1) / (this.m_pBitmapData.GetWidth() / tile_height);
                pImage.SetBitmapData(this.m_pBitmapData, new dRect().SetPosSize(xx * tile_width + this.m_nTileSpaceX, yy * tile_height + this.m_nTileSpaceY, this.m_nTileWidth, this.m_nTileHeight));
                pImage.SetSize(this.m_nTileWidth, this.m_nTileHeight);
                pImage.SetPos(x * this.m_nTileWidth - this.GetWidth() * this.GetAnchorU() + this.m_nTileStartOffsetX * this.m_nTileWidth, y * this.m_nTileHeight - this.GetHeight() * this.GetAnchorV() + this.m_nTileStartOffsetY * this.m_nTileHeight);
            }
        }
    };
    dTileImage.prototype.GetBitmapWidthCount = function () {
        if (this.m_pBitmapData == null)
            return 0;
        var tile_width = this.m_nTileWidth + this.m_nTileSpaceX * 2;
        return this.m_pBitmapData.GetWidth() / tile_width;
    };
    dTileImage.prototype.GetBitmapHeightCount = function () {
        if (this.m_pBitmapData == null)
            return 0;
        var tile_height = this.m_nTileHeight + this.m_nTileSpaceY * 2;
        return this.m_pBitmapData.GetHeight() / tile_height;
    };
    dTileImage.prototype.EndDsc = function () {
        _super.prototype.EndDsc.call(this);
        this.UpdateTile();
    };
    dTileImage.prototype.GetRowData = function () {
        return this.m_data;
    };
    dTileImage.prototype.SetTile = function (x, y, data) {
        if (this.m_data != null && x >= 0 && y >= 0 && x < this.m_nWidthCount && y < this.m_nHeightCount) {
            var index = y * this.m_nWidthCount + x;
            if (index < this.m_data.length)
                this.m_data[index] = data;
        }
    };
    dTileImage.prototype.GetTile = function (x, y) {
        if (this.m_data != null && x >= 0 && y >= 0 && x < this.m_nWidthCount && y < this.m_nHeightCount) {
            var index = y * this.m_nWidthCount + x;
            if (index < this.m_data.length)
                return this.m_data[index];
        }
        return 0;
    };
    Object.defineProperty(dTileImage.prototype, "dataString", {
        get: function () {
            var arr = new dByteArray();
            arr.WriteStringEx(this.m_nWidthCount + "," + this.m_nHeightCount, false);
            if (this.m_data != null) {
                for (var i = 0; i < this.m_data.length; i++) {
                    arr.WriteStringEx("," + this.m_data[i], false);
                }
            }
            return arr.ToStringBuffer();
        },
        set: function (str) {
            if (str != null) {
                var arr = str.split(",");
                if (arr.length < 2)
                    return;
                var nTileWidth = dMath.ParseInt(arr[0]);
                var nTileHeight = dMath.ParseInt(arr[1]);
                this.SetTileCount(nTileWidth, nTileHeight);
                for (var i = 2; i < arr.length; i++) {
                    if (i - 2 < this.m_data.length) {
                        var s = arr[i];
                        this.m_data[i - 2] = dMath.ParseInt(s);
                    }
                }
            }
            else
                this.m_data = null;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dTileImage.prototype, "tileWidth", {
        get: function () {
            return this.m_nTileWidth;
        },
        set: function (value) {
            this.m_nTileWidth = value;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dTileImage.prototype, "tileHeight", {
        get: function () {
            return this.m_nTileHeight;
        },
        set: function (value) {
            this.m_nTileHeight = value;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dTileImage.prototype, "tileSpaceX", {
        get: function () {
            return this.m_nTileSpaceX;
        },
        set: function (value) {
            this.m_nTileSpaceX = value;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dTileImage.prototype, "tileSpaceY", {
        get: function () {
            return this.m_nTileSpaceY;
        },
        set: function (value) {
            this.m_nTileSpaceY = value;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dTileImage.prototype, "widthCount", {
        get: function () {
            return this.m_nWidthCount;
        },
        set: function (value) {
            this.SetTileCount(value, this.heightCount);
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dTileImage.prototype, "heightCount", {
        get: function () {
            return this.m_nHeightCount;
        },
        set: function (value) {
            this.SetTileCount(value, value);
        },
        enumerable: false,
        configurable: true
    });
    dTileImage.prototype.SetTileCount = function (newWidthCount, newHeightCount) {
        if (this.m_nWidthCount != newWidthCount || this.m_nHeightCount != newHeightCount) {
            var newData = new Array(newWidthCount * newHeightCount);
            for (var j = 0; j < this.m_nHeightCount; j++) {
                for (var i = 0; i < this.m_nWidthCount; i++) {
                    if (i < this.m_nWidthCount && j < this.m_nHeightCount && i < newWidthCount && j < newHeightCount)
                        newData[j * newWidthCount + i] = this.m_data[j * this.m_nWidthCount + i];
                }
            }
            this.m_nWidthCount = newWidthCount;
            this.m_nHeightCount = newHeightCount;
            this.m_data = newData;
        }
    };
    Object.defineProperty(dTileImage.prototype, "tileStartOffsetX", {
        get: function () {
            return this.m_nTileStartOffsetX;
        },
        set: function (value) {
            this.m_nTileStartOffsetX = value;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(dTileImage.prototype, "tileStartOffsetY", {
        get: function () {
            return this.m_nTileStartOffsetY;
        },
        set: function (value) {
            this.m_nTileStartOffsetY = value;
        },
        enumerable: false,
        configurable: true
    });
    dTileImage.prototype.GetData = function (x, y) {
        x -= this.tileStartOffsetX;
        y -= this.tileStartOffsetY;
        if (x >= 0 && x < this.widthCount && y >= 0 && y < this.heightCount)
            return this.m_data[y * this.widthCount + x];
        return 0;
    };
    dTileImage.prototype.GetAnimateCount = function (x, y) {
        if (this.m_indexProperty != null && x >= 0 && y >= 0 && x < this.GetBitmapWidthCount() && y < this.GetBitmapHeightCount()) {
            var index = y * this.GetBitmapWidthCount() + x;
            if (index < this.m_indexProperty.length)
                return this.m_indexProperty[index];
        }
        return 0;
    };
    dTileImage.prototype.SetAnimateCount = function (x, y, data) {
        if (this.m_indexProperty == null || this.m_indexProperty.length != this.GetBitmapWidthCount() * this.GetBitmapHeightCount()) {
            this.m_indexProperty = new Array(this.GetBitmapWidthCount() * this.GetBitmapHeightCount());
        }
        if (x >= 0 && y >= 0 && x < this.GetBitmapWidthCount() && y < this.GetBitmapHeightCount()) {
            this.m_indexProperty[y * this.GetBitmapWidthCount() + x] = data;
            var isAllZero = true;
            for (var i = 0; i < this.m_indexProperty.length; i++) {
                if (this.m_indexProperty[i] != 0) {
                    isAllZero = false;
                    break;
                }
            }
            if (isAllZero)
                this.m_indexProperty = null;
        }
    };
    Object.defineProperty(dTileImage.prototype, "indexPropertyString", {
        get: function () {
            var ret = "";
            if (this.m_indexProperty != null) {
                for (var i = 0; i < this.m_indexProperty.length; i++) {
                    if (i != 0)
                        ret += ",";
                    ret += this.m_indexProperty[i];
                }
            }
            return ret;
        },
        set: function (str) {
            if (str != null) {
                var arr = str.split(",");
                if (arr.length) {
                    this.m_indexProperty = new Array(arr.length);
                    for (var i = 0; i < arr.length; i++) {
                        this.m_indexProperty[i] = dMath.ParseInt(arr[i]);
                    }
                }
            }
            else
                this.m_indexProperty = null;
        },
        enumerable: false,
        configurable: true
    });
    dTileImage.prototype.SetFrame = function (frame) {
        _super.prototype.SetFrame.call(this, frame);
        var split;
        if (this.m_indexProperty != null) {
            for (var i = 0, n = this.m_vecImage.length; i < n; i++) {
                if (this.m_vecImage[i] != null && this.m_vecImage[i].GetBitmapData() != null) {
                    var index = 0;
                    var aniCount = 0;
                    if (this.m_data != null && i >= 0 && i < this.m_data.length) {
                        index = this.m_data[i] & 0xFFFF;
                    }
                    if (this.m_indexProperty != null && index > 0 && index <= this.m_indexProperty.length) {
                        aniCount = this.m_indexProperty[index - 1];
                    }
                    if (aniCount != 0 && index != 0) {
                        index = index + (frame % aniCount);
                        var tile_width = (this.m_nTileWidth + this.m_nTileSpaceX * 2);
                        var tile_height = (this.m_nTileHeight + this.m_nTileSpaceY * 2);
                        var xx = (index - 1) % (this.m_pBitmapData.GetWidth() / tile_width);
                        var yy = (index - 1) / (this.m_pBitmapData.GetWidth() / tile_height);
                        this.m_vecImage[i].SetBitmapData(this.m_pBitmapData, new dRect().SetPosSize(xx * tile_width + this.m_nTileSpaceX, yy * tile_height + this.m_nTileSpaceY, this.m_nTileWidth, this.m_nTileHeight));
                    }
                }
            }
        }
    };
    dTileImage.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("tileWidth"))
            this.tileWidth = json.tileWidth;
        if (json.hasOwnProperty("tileHeight"))
            this.tileHeight = json.tileHeight;
        if (json.hasOwnProperty("tileSpaceX"))
            this.tileSpaceX = json.tileSpaceX;
        if (json.hasOwnProperty("tileSpaceY"))
            this.tileSpaceY = json.tileSpaceY;
        if (json.hasOwnProperty("tileStartOffsetX"))
            this.tileStartOffsetX = json.tileStartOffsetX;
        if (json.hasOwnProperty("tileStartOffsetY"))
            this.tileStartOffsetY = json.tileStartOffsetY;
        if (json.hasOwnProperty("dataString"))
            this.dataString = json.dataString;
        if (json.hasOwnProperty("indexPropertyString"))
            this.indexPropertyString = json.indexPropertyString;
    };
    return dTileImage;
}(dImage));
var dTileView = (function (_super) {
    __extends(dTileView, _super);
    function dTileView() {
        var _this = _super.call(this) || this;
        _this.m_pBitmapData = null;
        _this.m_nTileWidth = 0;
        _this.m_nTileHeight = 0;
        _this.m_vecTiles = null;
        _this.m_onCallback = null;
        _this.m_pViewPanel = new dSprite();
        _this.m_vOldViewPos = new dVector2();
        _this.m_nTilesWidthCount = 0;
        _this.m_nTilesHeightCount = 0;
        _this.m_vecLineH = null;
        _this.m_vecLineV = null;
        _this.m_vecBmpBufferLineH = new Array();
        _this.m_vecBmpBufferLineV = new Array();
        _this.m_nViewOffX = 0;
        _this.m_nViewOffY = 0;
        _this.m_vecBmpBuffer = new Array();
        _this.m_nBmpBufferWidth = 0;
        _this.m_nBmpBufferHeight = 0;
        _this.m_nBmpStartX = 0;
        _this.m_nBmpStartY = 0;
        _this.m_ptBuffer = new dVector2();
        _this.m_rcBuffer = new dRect();
        _this.m_matBuffer = new dMatrix();
        _this.AddChild(_this.m_pViewPanel);
        _this.m_bForceRender = true;
        return _this;
    }
    dTileView.prototype.LoadFromFile = function (strImage, onLoadComplete) {
        var _this = this;
        if (onLoadComplete === void 0) { onLoadComplete = null; }
        if (strImage != null && this.GetFileName() != strImage) {
            if (strImage != "") {
                var bmp = new dBitmapData();
                bmp.LoadFromFile(strImage, function (sender) {
                    _this.m_pBitmapData = bmp;
                    if (onLoadComplete != null)
                        onLoadComplete(_this);
                });
            }
            else
                this.m_pBitmapData = null;
        }
        return this;
    };
    dTileView.prototype.GetFileName = function () {
        if (this.m_pBitmapData == null)
            return "";
        return this.m_pBitmapData.GetResourceFileName();
    };
    Object.defineProperty(dTileView.prototype, "resourceFileName", {
        set: function (fileName) {
            this.LoadFromFile(fileName, null);
        },
        enumerable: false,
        configurable: true
    });
    dTileView.prototype.SetTileCallback = function (onCallback) {
        this.m_onCallback = onCallback;
    };
    dTileView.prototype.SetTileSize = function (width, height) {
        this.m_nTileWidth = width;
        this.m_nTileHeight = height;
        this.ResizeTile();
    };
    dTileView.prototype.SetViewOffset = function (offx, offy) {
        this.m_nViewOffX = offx;
        this.m_nViewOffY = offy;
        this.UpdateView();
    };
    dTileView.prototype.SetSize = function (w, h) {
        if (this.m_fWidth != w || this.m_fHeight != h) {
            _super.prototype.SetSize.call(this, w, h);
            this.ResizeTile();
        }
    };
    dTileView.prototype.SetViewPos = function (x, y) {
        if (x != this.m_vOldViewPos.x || y != this.m_vOldViewPos.y) {
            this.m_vOldViewPos.SetValue(this.m_pViewPanel.positionX, this.m_pViewPanel.positionY);
            this.m_pViewPanel.SetPos(x, y);
            this.UpdateView();
        }
    };
    dTileView.prototype.GetViewPosX = function () {
        return this.m_pViewPanel.positionX;
    };
    dTileView.prototype.GetViewPosY = function () {
        return this.m_pViewPanel.positionY;
    };
    dTileView.prototype.ResizeTile = function () {
        var e_10, _a, e_11, _b;
        if (this.m_nTileWidth > 0 && this.m_nTileHeight > 0) {
            var xx = dMath.ToInt(this.GetWidth() / this.m_nTileWidth) + 1;
            var yy = dMath.ToInt(this.GetHeight() / this.m_nTileHeight) + 1;
            var needCount = xx * yy;
            var arrSendAdded = new Map();
            var arrSendRemove = new Map();
            if (this.m_vecTiles != null) {
                for (var i = 0; i < this.m_vecTiles.length; i++) {
                    if (this.m_onCallback != null)
                        arrSendRemove.set(this.m_vecTiles[i].dataY << 16 | this.m_vecTiles[i].dataX, 1);
                    this.m_vecTiles[i].RemoveParent();
                }
            }
            var vecNewTiles = new Array(needCount);
            var offx = this.m_pViewPanel.positionX;
            offx /= this.m_nTileWidth;
            if (this.m_pViewPanel.positionX < 0)
                offx--;
            var offy = this.m_pViewPanel.positionY;
            offy /= this.m_nTileHeight;
            if (this.m_pViewPanel.positionY < 0)
                offy--;
            this.m_vecLineH = new Array(yy);
            this.m_vecLineV = new Array(xx);
            for (var i = 0; i < yy; i++) {
                this.m_vecLineH[i] = new LineData();
                this.m_vecLineH[i].vecTiles.resize(xx);
                this.m_vecLineH[i].y = (i - offy) * this.m_nTileHeight;
            }
            for (var i = 0; i < xx; i++) {
                this.m_vecLineV[i] = new LineData();
                this.m_vecLineV[i].vecTiles.resize(yy);
                this.m_vecLineV[i].x = (i - offx) * this.m_nTileWidth;
            }
            for (var j = 0; j < yy; j++) {
                for (var i = 0; i < xx; i++) {
                    var p = new TileData();
                    p.SetPosI(this.m_vecLineV[i].x, this.m_vecLineH[j].y);
                    p.SetAnchor(0, 0);
                    p.SetSize(this.m_nTileWidth, this.m_nTileHeight);
                    if (this.m_onCallback != null) {
                        var tx = dMath.ToInt(p.posX / this.m_nTileWidth);
                        var ty = dMath.ToInt(p.posY / this.m_nTileHeight);
                        var id = ty << 16 | tx;
                        if (arrSendRemove.has(id))
                            arrSendRemove.delete(id);
                        else
                            arrSendAdded.set(id, 1);
                    }
                    this._UpdateTileImage(p, false);
                    vecNewTiles[j * xx + i] = p;
                    this.m_vecLineH[j].vecTiles[i] = p;
                    this.m_vecLineV[i].vecTiles[j] = p;
                }
            }
            try {
                for (var _c = __values(arrSendRemove.keys()), _d = _c.next(); !_d.done; _d = _c.next()) {
                    var id = _d.value;
                    var x = id & 0xffff;
                    var y = (id >> 16) & 0xffff;
                    this.m_onCallback.OnRemoveTile(x, y);
                }
            }
            catch (e_10_1) { e_10 = { error: e_10_1 }; }
            finally {
                try {
                    if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
                }
                finally { if (e_10) throw e_10.error; }
            }
            try {
                for (var _e = __values(arrSendAdded.keys()), _f = _e.next(); !_f.done; _f = _e.next()) {
                    var id = _f.value;
                    var x = id & 0xffff;
                    var y = (id >> 16) & 0xffff;
                    this.m_onCallback.OnAddTile(x, y);
                }
            }
            catch (e_11_1) { e_11 = { error: e_11_1 }; }
            finally {
                try {
                    if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
                }
                finally { if (e_11) throw e_11.error; }
            }
            this.m_vecTiles = vecNewTiles;
            this.m_nTilesWidthCount = xx;
            this.m_nTilesHeightCount = yy;
        }
        this.UpdateView();
    };
    dTileView.prototype._UpdateTileImage = function (p, bSendAdded) {
        if (bSendAdded === void 0) { bSendAdded = true; }
        var x = p.posX / this.m_nTileWidth;
        var y = p.posY / this.m_nTileHeight;
        var pt = this.m_ptBuffer;
        pt.x = pt.y = -1;
        if (this.m_onCallback != null) {
            if (bSendAdded)
                this.m_onCallback.OnAddTile(x, y);
            this.m_onCallback.OnGetTile(x, y, pt);
        }
        p.dataX = x;
        p.dataY = y;
        var bmpBufferIndexX = (p.posX - this.m_nBmpStartX) / this.m_nBmpBufferWidth;
        var bmpBufferIndexY = (p.posY - this.m_nBmpStartY) / this.m_nBmpBufferHeight;
        var tx = p.posX % this.m_nBmpBufferWidth;
        var ty = p.posY % this.m_nBmpBufferHeight;
        var bmp;
        if (bmpBufferIndexX >= 0 && bmpBufferIndexX < this.m_vecBmpBufferLineV.length && bmpBufferIndexY >= 0 && bmpBufferIndexY < this.m_vecBmpBufferLineV[0].vecTiles.length) {
            var pBmpBuffer = this.m_vecBmpBufferLineV[bmpBufferIndexX].vecTiles[bmpBufferIndexY];
            bmp = pBmpBuffer.GetBitmapData();
        }
    };
    dTileView.prototype._PopTile = function (vec, width, height, x, y) {
        if (x >= 0 && x < width && y >= 0 && y < height) {
            var ret = vec[y * width + x];
            vec[y * width + x] = null;
            return ret;
        }
        return null;
    };
    dTileView.prototype.SetBitmapData = function (bmp, rc, at, sampleType) {
        if (rc === void 0) { rc = null; }
        if (at === void 0) { at = 0; }
        if (sampleType === void 0) { sampleType = 0; }
        this.m_pBitmapData = bmp;
        if (this.m_vecTiles != null) {
            for (var i = 0; i < this.m_vecTiles.length; i++)
                this.m_vecTiles[i].SetBitmapData(bmp, this.m_vecTiles[i].GetBitmapSourceRect(), at, sampleType);
        }
    };
    dTileView.prototype._UpdateBmpBuffer = function () {
        var xx = dMath.ToInt(this.GetWidth() / this.m_nTileWidth) + 1;
        var yy = dMath.ToInt(this.GetHeight() / this.m_nTileHeight) + 1;
        var totalTileWidth = xx * this.m_nTileWidth;
        var totalTileHeight = yy * this.m_nTileHeight;
        var bmpBufferWidth = 1024;
        var bmpBufferHeight = 1024;
        bmpBufferWidth -= 1024 % this.m_nTileWidth;
        bmpBufferHeight -= 1024 % this.m_nTileHeight;
        var xx2 = totalTileWidth / bmpBufferWidth + 2;
        var yy2 = totalTileHeight / bmpBufferHeight + 2;
        xx = xx2;
        yy = yy2;
        totalTileWidth = xx * this.m_nBmpBufferWidth;
        totalTileHeight = yy * this.m_nBmpBufferHeight;
        var panelX = this.m_pViewPanel.positionX;
        var panelY = this.m_pViewPanel.positionY;
        var viewOffX = this.m_nViewOffX - this.m_nBmpBufferWidth;
        var viewOffY = this.m_nViewOffY - this.m_nBmpBufferHeight;
        for (var i = 0, n = this.m_vecBmpBufferLineV.length; i < n; i++) {
            var lineData = this.m_vecBmpBufferLineV[i];
            var x = lineData.x;
            var bNeedUpdateTile = false;
            if (x + panelX < viewOffX) {
                lineData.x = totalTileWidth + ((x + panelX - viewOffX) % totalTileWidth) - panelX + viewOffX;
                bNeedUpdateTile = true;
            }
            else if (x + panelX >= totalTileWidth + viewOffX) {
                lineData.x = (x + panelX - viewOffX) % totalTileWidth - panelX + viewOffX;
                bNeedUpdateTile = true;
            }
            if (bNeedUpdateTile) {
                for (var j = 0, n2 = lineData.vecTiles.length; j < n2; j++) {
                    var tileData = lineData.vecTiles[j];
                    tileData.SetPosI(lineData.x, tileData.posY);
                }
                this.m_nBmpStartX = this.m_vecBmpBufferLineV[0].x;
            }
        }
        for (var i = 0, n = this.m_vecBmpBufferLineH.length; i < n; i++) {
            var lineData = this.m_vecBmpBufferLineH[i];
            var y = lineData.y;
            var bNeedUpdateTile = false;
            if (y + panelY < viewOffY) {
                lineData.y = totalTileHeight + ((y + panelY - viewOffY) % totalTileHeight) - panelY + viewOffY;
                bNeedUpdateTile = true;
            }
            else if (y + panelY >= totalTileHeight + viewOffY) {
                lineData.y = (y + panelY - viewOffY) % totalTileHeight - panelY + viewOffY;
                bNeedUpdateTile = true;
            }
            if (bNeedUpdateTile) {
                for (var j = 0, n2 = lineData.vecTiles.length; j < n2; j++) {
                    var tileData = lineData.vecTiles[j];
                    tileData.SetPosI(tileData.posX, lineData.y);
                }
                for (var j = 0, n2 = this.m_vecBmpBufferLineV.length; j < n2; j++) {
                }
                this.m_nBmpStartY = this.m_vecBmpBufferLineV[0].vecTiles[0].posY;
            }
        }
    };
    dTileView.prototype.UpdateView = function () {
        var xx = dMath.ToInt(this.GetWidth() / this.m_nTileWidth) + 1;
        var yy = dMath.ToInt(this.GetHeight() / this.m_nTileHeight) + 1;
        var totalTileWidth = xx * this.m_nTileWidth;
        var totalTileHeight = yy * this.m_nTileHeight;
        var panelX = this.m_pViewPanel.positionX;
        var panelY = this.m_pViewPanel.positionY;
        for (var i = 0, n = this.m_vecLineV.length; i < n; i++) {
            var lineData = this.m_vecLineV[i];
            var x = lineData.x;
            var bNeedUpdateTile = false;
            if (x + panelX < this.m_nViewOffX) {
                lineData.x = totalTileWidth + ((x + panelX - this.m_nViewOffX) % totalTileWidth) - panelX + this.m_nViewOffX;
                bNeedUpdateTile = true;
            }
            else if (x + panelX >= totalTileWidth + this.m_nViewOffX) {
                lineData.x = (x + panelX - this.m_nViewOffX) % totalTileWidth - panelX + this.m_nViewOffX;
                bNeedUpdateTile = true;
            }
            if (bNeedUpdateTile) {
                for (var j = 0, n2 = lineData.vecTiles.length; j < n2; j++) {
                    var tileData = lineData.vecTiles[j];
                    tileData.SetPosI(lineData.x, tileData.posY);
                    if (this.m_onCallback != null)
                        this.m_onCallback.OnRemoveTile(tileData.dataX, tileData.dataY);
                    this._UpdateTileImage(tileData);
                }
            }
        }
        for (var i = 0, n = this.m_vecLineH.length; i < n; i++) {
            var lineData = this.m_vecLineH[i];
            var y = lineData.y;
            var bNeedUpdateTile = false;
            if (y + panelY < this.m_nViewOffY) {
                lineData.y = totalTileHeight + ((y + panelY - this.m_nViewOffY) % totalTileHeight) - panelY + this.m_nViewOffY;
                bNeedUpdateTile = true;
            }
            else if (y + panelY >= totalTileHeight + this.m_nViewOffY) {
                lineData.y = (y + panelY - this.m_nViewOffY) % totalTileHeight - panelY + this.m_nViewOffY;
                bNeedUpdateTile = true;
            }
            if (bNeedUpdateTile) {
                for (var j = 0, n2 = lineData.vecTiles.length; j < n2; j++) {
                    var tileData = lineData.vecTiles[j];
                    tileData.SetPosI(tileData.posX, lineData.y);
                    if (this.m_onCallback != null)
                        this.m_onCallback.OnRemoveTile(tileData.dataX, tileData.dataY);
                    this._UpdateTileImage(tileData);
                }
            }
        }
    };
    dTileView.prototype.SpriteRender = function () {
        if (this.m_pBitmapData != null) {
            var bUpdateColored = false;
            var bmpWidth = this.m_pBitmapData.GetWidth();
            var bmpHeight = this.m_pBitmapData.GetHeight();
            var matLocal = this.m_matBuffer;
            matLocal.Identity();
            var matWorld = this.m_matRenderMatrixWorld;
            var isFatherRotation = true;
            if (matWorld._12 == 0 && matWorld._13 == 0 && matWorld._21 == 0 && matWorld._23 == 0 && this.rotation == 0 && this.rotationX == 0 && this.rotationY == 0)
                isFatherRotation = false;
            for (var i = 0, n = this.m_vecTiles.length; i < n; i++) {
                var p = this.m_vecTiles[i];
                if (p.isShow() && p.GetBitmapData() != null) {
                    matLocal.TranslationFast(p.GetPosX() + this.m_pViewPanel.GetPosX(), p.GetPosY() + this.m_pViewPanel.GetPosY(), 0);
                    matLocal.ScalingFast(p.GetWidth(), p.GetHeight(), 1);
                    var rcSource = p.GetBitmapSourceRect();
                    var vUV_x = rcSource.left / bmpWidth;
                    var vUV_y = rcSource.top / bmpHeight;
                    var vUV_z = rcSource.Width() / bmpWidth;
                    var vUV_w = rcSource.Height() / bmpHeight;
                    p.SetUniformF("uvTrans", vUV_x, vUV_y + vUV_w, vUV_z, -vUV_w);
                    if (!isFatherRotation) {
                        matLocal._11 *= matWorld._11;
                        matLocal._22 *= matWorld._22;
                        matLocal._33 *= matWorld._33;
                        matLocal._41 *= matWorld._11;
                        matLocal._42 *= matWorld._22;
                        matLocal._41 += matWorld._41;
                        matLocal._42 += matWorld._42;
                    }
                    else
                        matLocal.MulAppend(matWorld);
                    p.SetUniformMatrix("mWorld", matLocal);
                    if (!bUpdateColored) {
                        var color = this.m_nColorARGB;
                        if (color == 0xffffffff)
                            p.SetUniformF("color", 1, 1, 1, this.m_fAlpha * this.alpha);
                        else {
                            var a = ((color & 0xFF000000) >>> 24) / 255.0;
                            var r = ((color & 0x00FF0000) >> 16) / 255.0;
                            var g = ((color & 0x0000FF00) >> 8) / 255.0;
                            var b = ((color & 0x000000FF)) / 255.0;
                            p.SetUniformF("color", r, g, b, a * this.m_fAlpha * this.alpha);
                        }
                        if (this.m_matColorTransform != null)
                            p.SetUniformMatrix("colorMatrix", this.m_matColorTransform);
                        else
                            p.SetUniformMatrix("colorMatrix", dMatrix.IDENTITY);
                        bUpdateColored = true;
                    }
                    p.SpriteRender();
                }
            }
        }
    };
    return dTileView;
}(dBaseControl));
var dTileViewCallback = (function () {
    function dTileViewCallback() {
    }
    dTileViewCallback.prototype.OnGetTile = function (x, y, outPt) {
    };
    dTileViewCallback.prototype.OnAddTile = function (x, y) {
    };
    dTileViewCallback.prototype.OnRemoveTile = function (x, y) {
    };
    return dTileViewCallback;
}());
var TileData = (function (_super) {
    __extends(TileData, _super);
    function TileData() {
        var _this = _super.call(this) || this;
        _this.dataX = 0;
        _this.dataY = 0;
        _this.posX = 0;
        _this.posY = 0;
        return _this;
    }
    TileData.prototype.SetPosI = function (x, y) {
        this.posX = dMath.ToInt(x);
        this.posY = dMath.ToInt(y);
        this.SetPos(x, y);
    };
    return TileData;
}(dImage));
var LineData = (function () {
    function LineData() {
        this.x = 0;
        this.y = 0;
        this.vecTiles = new Array();
    }
    return LineData;
}());
var Actions = (function () {
    function Actions() {
    }
    return Actions;
}());
var CCAction = (function (_super) {
    __extends(CCAction, _super);
    function CCAction() {
        var _this = _super.call(this) || this;
        _this.m_nTag = -1;
        _this.m_pOriginalTarget = null;
        _this.m_pTarget = null;
        _this.name = null;
        _this.m_onStartWithTarget = null;
        return _this;
    }
    CCAction.prototype.Clear = function () {
        this.m_pTarget = null;
        this.m_pOriginalTarget = null;
    };
    Object.defineProperty(CCAction.prototype, "Target", {
        get: function () {
            return this.m_pTarget;
        },
        set: function (value) {
            this.m_pTarget = value;
            if (this.m_pTarget == null)
                throw "target is null";
        },
        enumerable: false,
        configurable: true
    });
    CCAction.prototype.SetTarget = function (p) {
        this.m_pTarget = p;
        return this;
    };
    CCAction.prototype.GetTarget = function () {
        return this.m_pTarget;
    };
    CCAction.prototype.SetTag = function (tag) {
        this.m_nTag = tag;
        return this;
    };
    CCAction.prototype.GetTag = function () {
        return this.m_nTag;
    };
    Object.defineProperty(CCAction.prototype, "OriginalTarget", {
        get: function () {
            return this.m_pOriginalTarget;
        },
        enumerable: false,
        configurable: true
    });
    CCAction.prototype.IsDone = function () {
        return true;
    };
    CCAction.prototype.SetStartWithTarget = function (onStartWithTarget) {
        this.m_onStartWithTarget = onStartWithTarget;
    };
    CCAction.prototype.StartWithTarget = function (target) {
        if (this.m_onStartWithTarget)
            this.m_onStartWithTarget(this);
        this.m_pOriginalTarget = this.m_pTarget = target;
    };
    CCAction.prototype.Stop = function () {
        this.m_pTarget = null;
    };
    CCAction.prototype.Step = function (dt) {
        throw "[Action step]. override me";
    };
    CCAction.prototype.Update = function (time) {
        throw "[Action update]. override me";
    };
    CCAction.prototype.GetActionList = function (outData) {
        outData.push(this);
    };
    return CCAction;
}(dObject));
var CCFiniteTimeAction = (function (_super) {
    __extends(CCFiniteTimeAction, _super);
    function CCFiniteTimeAction() {
        var _this = _super.call(this) || this;
        _this.m_fDuration = 0;
        return _this;
    }
    Object.defineProperty(CCFiniteTimeAction.prototype, "Duration", {
        get: function () {
            return this.m_fDuration;
        },
        set: function (value) {
            this.m_fDuration = value;
        },
        enumerable: false,
        configurable: true
    });
    return CCFiniteTimeAction;
}(CCAction));
var CCActionInterval = (function (_super) {
    __extends(CCActionInterval, _super);
    function CCActionInterval() {
        var _this = _super.call(this) || this;
        _this.m_bFirstTick = false;
        _this.m_elapsed = 0;
        return _this;
    }
    CCActionInterval.prototype.Clear = function () {
        _super.prototype.Clear.call(this);
        this.m_bFirstTick = false;
        this.m_elapsed = 0;
    };
    Object.defineProperty(CCActionInterval.prototype, "Elapsed", {
        get: function () {
            return this.m_elapsed;
        },
        enumerable: false,
        configurable: true
    });
    CCActionInterval.prototype.InitWithDuration = function (d) {
        this.m_fDuration = d;
        if (this.m_fDuration == 0) {
            this.m_fDuration = dMath.dFLOAT_EPSILON;
        }
        this.m_elapsed = 0;
        this.m_bFirstTick = true;
    };
    CCActionInterval.prototype.IsDone = function () {
        return this.m_elapsed >= this.m_fDuration;
    };
    CCActionInterval.prototype.Step = function (dt) {
        if (this.m_bFirstTick) {
            this.m_bFirstTick = false;
            this.m_elapsed = 0;
        }
        else {
            this.m_elapsed += dt;
        }
        this.Update(dMath.Max(0, dMath.Min(1, this.m_elapsed / dMath.Max(this.m_fDuration, dMath.dFLOAT_EPSILON))));
    };
    CCActionInterval.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_elapsed = 0.0;
        this.m_bFirstTick = true;
    };
    Object.defineProperty(CCActionInterval.prototype, "AmplitudeRate", {
        get: function () {
            throw "NotImplementedException";
        },
        set: function (value) {
            throw "NotImplementedException";
        },
        enumerable: false,
        configurable: true
    });
    return CCActionInterval;
}(CCFiniteTimeAction));
var CCActionEase = (function (_super) {
    __extends(CCActionEase, _super);
    function CCActionEase(pAction) {
        var _this = _super.call(this) || this;
        _this.m_pInner = null;
        _this.m_pInner = null;
        _this.InitWithAction(pAction);
        return _this;
    }
    Object.defineProperty(CCActionEase.prototype, "InnerAction", {
        get: function () {
            return this.m_pInner;
        },
        enumerable: false,
        configurable: true
    });
    CCActionEase.prototype.InitWithAction = function (pAction) {
        _super.prototype.InitWithDuration.call(this, pAction.Duration);
        this.m_pInner = pAction;
    };
    CCActionEase.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_pInner.StartWithTarget(this.m_pTarget);
    };
    CCActionEase.prototype.Stop = function () {
        this.m_pInner.Stop();
        _super.prototype.Stop.call(this);
    };
    CCActionEase.prototype.Update = function (time) {
        this.m_pInner.Update(time);
    };
    return CCActionEase;
}(CCActionInterval));
var CCActionInstant = (function (_super) {
    __extends(CCActionInstant, _super);
    function CCActionInstant() {
        return _super.call(this) || this;
    }
    CCActionInstant.prototype.IsDone = function () {
        return true;
    };
    CCActionInstant.prototype.Step = function (dt) {
        this.Update(1);
    };
    CCActionInstant.prototype.Update = function (time) {
    };
    return CCActionInstant;
}(CCFiniteTimeAction));
var CCActionManager = (function (_super) {
    __extends(CCActionManager, _super);
    function CCActionManager() {
        var _this = _super.call(this) || this;
        _this.m_bCurrentTargetSalvaged = false;
        _this.m_pCurrentTarget = null;
        _this.m_pTargets = new Array();
        _this.m_arrSpriteMap = new Map();
        _this.m_pTimer = null;
        return _this;
    }
    CCActionManager.prototype.UpdateElement = function (elt, dt) {
        var m_pCurrentTarget = elt;
        this.m_bCurrentTargetSalvaged = false;
        if (!this.m_pCurrentTarget.Paused) {
            for (this.m_pCurrentTarget.ActionIndex = 0; this.m_pCurrentTarget.ActionIndex < this.m_pCurrentTarget.Actions.length; this.m_pCurrentTarget.ActionIndex++) {
                this.m_pCurrentTarget.CurrentAction = this.m_pCurrentTarget.Actions[this.m_pCurrentTarget.ActionIndex];
                if (this.m_pCurrentTarget.CurrentAction == null) {
                    continue;
                }
                this.m_pCurrentTarget.CurrentActionSalvaged = false;
                this.m_pCurrentTarget.CurrentAction.Step(dt);
                if (this.m_pCurrentTarget.CurrentActionSalvaged) {
                }
                else if (this.m_pCurrentTarget.CurrentAction.IsDone()) {
                    this.m_pCurrentTarget.CurrentAction.Stop();
                    var action = m_pCurrentTarget.CurrentAction;
                    this.m_pCurrentTarget.CurrentAction = null;
                    this.RemoveAction(action);
                }
                this.m_pCurrentTarget.CurrentAction = null;
            }
        }
    };
    CCActionManager.prototype.Update = function (fTimeElapse) {
        var dt = fTimeElapse;
        for (var i = 0; i < this.m_pTargets.length; i++) {
            var elt = this.m_pTargets[i];
            this.m_pCurrentTarget = elt;
            this.m_bCurrentTargetSalvaged = false;
            if (!this.m_pCurrentTarget.Paused) {
                for (this.m_pCurrentTarget.ActionIndex = 0; this.m_pCurrentTarget.ActionIndex < this.m_pCurrentTarget.Actions.length; this.m_pCurrentTarget.ActionIndex++) {
                    this.m_pCurrentTarget.CurrentAction = this.m_pCurrentTarget.Actions[this.m_pCurrentTarget.ActionIndex];
                    if (this.m_pCurrentTarget.CurrentAction == null) {
                        continue;
                    }
                    this.m_pCurrentTarget.CurrentActionSalvaged = false;
                    this.m_pCurrentTarget.CurrentAction.Step(dt);
                    if (this.m_pCurrentTarget.CurrentAction == null) {
                        continue;
                    }
                    if (this.m_pCurrentTarget.CurrentActionSalvaged) {
                    }
                    else if (this.m_pCurrentTarget.CurrentAction.IsDone()) {
                        this.m_pCurrentTarget.CurrentAction.Stop();
                        var action = this.m_pCurrentTarget.CurrentAction;
                        this.m_pCurrentTarget.CurrentAction = null;
                        this.RemoveAction(action);
                    }
                    this.m_pCurrentTarget.CurrentAction = null;
                }
            }
            if (this.m_bCurrentTargetSalvaged && this.m_pCurrentTarget.Actions.length == 0 ||
                this.m_pCurrentTarget.bAutoRemoveWhenChildRemoveRoot && !this.m_pCurrentTarget.Target.isInRoot()) {
                this.DeleteHashElement(this.m_pCurrentTarget);
            }
        }
        this.m_pCurrentTarget = null;
    };
    CCActionManager.prototype.DeleteHashElement = function (element) {
        element.Actions.clear();
        this.m_pTargets.remove(element);
        this.m_arrSpriteMap.remove(element.Target);
        element.Target = null;
    };
    CCActionManager.prototype.ActionAllocWithHashElement = function (element) {
        if (element.Actions == null) {
            element.Actions = Array();
        }
    };
    CCActionManager.prototype.RemoveActionAtIndex = function (index, element) {
        var action = element.Actions[index];
        if (action == element.CurrentAction && (!element.CurrentActionSalvaged)) {
            element.CurrentActionSalvaged = true;
        }
        element.Actions.erase(index);
        if (element.ActionIndex >= index) {
            element.ActionIndex--;
        }
        if (element.Actions.length == 0) {
            if (this.m_pCurrentTarget == element) {
                this.m_bCurrentTargetSalvaged = true;
            }
            else {
                this.DeleteHashElement(element);
            }
        }
    };
    CCActionManager.prototype.FindElementBySprite = function (target) {
        return this.m_arrSpriteMap.get(target);
    };
    CCActionManager.prototype.PauseTarget = function (target) {
        var element = this.FindElementBySprite(target);
        if (element != null) {
            element.Paused = true;
        }
    };
    CCActionManager.prototype.ResumeTarget = function (target) {
        var element = this.FindElementBySprite(target);
        if (element != null) {
            element.Paused = false;
        }
    };
    CCActionManager.prototype.PauseAllRunningActions = function (outData) {
        if (outData === void 0) { outData = null; }
        for (var i = 0, count = this.m_pTargets.length; i < count; i++) {
            var element = this.m_pTargets[i];
            if (!element.Paused) {
                element.Paused = true;
                if (outData != null)
                    outData.push(element.Target);
            }
        }
    };
    CCActionManager.prototype.ResumeAllRunningActions = function (outData) {
        if (outData === void 0) { outData = null; }
        for (var i = 0, count = this.m_pTargets.length; i < count; i++) {
            var element = this.m_pTargets[i];
            if (element.Paused) {
                element.Paused = false;
                if (outData != null)
                    outData.push(element.Target);
            }
        }
    };
    CCActionManager.prototype.ResumeTargets = function (targetsToResume) {
        for (var i = 0; i < targetsToResume.length; i++) {
            this.ResumeTarget(targetsToResume[i]);
        }
    };
    CCActionManager.prototype.SetAction = function (action, target, paused, bAutoRemoveWhenChildRemoveRoot) {
        if (paused === void 0) { paused = false; }
        if (bAutoRemoveWhenChildRemoveRoot === void 0) { bAutoRemoveWhenChildRemoveRoot = true; }
        this.RemoveAllActionsFromTarget(target);
        this.AddAction(action, target, paused, bAutoRemoveWhenChildRemoveRoot);
    };
    CCActionManager.prototype.AddAction = function (action, target, paused, bAutoRemoveWhenChildRemoveRoot, tagID) {
        if (paused === void 0) { paused = false; }
        if (bAutoRemoveWhenChildRemoveRoot === void 0) { bAutoRemoveWhenChildRemoveRoot = true; }
        if (tagID === void 0) { tagID = 0; }
        if (action == null)
            return null;
        if (target == null)
            throw "target is null";
        action.Clear();
        action.SetTag(tagID);
        var element = this.FindElementBySprite(target);
        if (element == null) {
            element = new CCActionHashElement();
            element.Paused = paused;
            element.Target = target;
            element.bAutoRemoveWhenChildRemoveRoot = bAutoRemoveWhenChildRemoveRoot;
            this.m_pTargets.push(element);
            this.m_arrSpriteMap.set(target, element);
        }
        else if (!bAutoRemoveWhenChildRemoveRoot)
            element.bAutoRemoveWhenChildRemoveRoot = false;
        this.ActionAllocWithHashElement(element);
        element.Actions.push(action);
        action.StartWithTarget(target);
        return element;
    };
    CCActionManager.prototype.RemoveAllActions = function () {
        var vec = new Array();
        vec.copy(this.m_pTargets);
        var count = this.m_pTargets.length;
        for (var i = 0; i < count; i++) {
            this.RemoveAllActionsFromHashElement(vec[i]);
        }
    };
    CCActionManager.prototype.RemoveAllActionsFromTargetWithChild = function (target) {
        this.RemoveAllActionsFromTarget(target);
        var child = target.GetChildList();
        for (var i = 0, n = child.length; i < n; i++)
            this.RemoveAllActionsFromTargetWithChild(child[i]);
    };
    CCActionManager.prototype.RemoveAllActionsFromTarget = function (target) {
        var element = this.FindElementBySprite(target);
        if (element != null) {
            this.RemoveAllActionsFromHashElement(element);
        }
    };
    CCActionManager.prototype.RemoveAllActionsFromHashElement = function (element) {
        if (element != null) {
            if (element.Actions.indexOf(element.CurrentAction) != -1 && (!element.CurrentActionSalvaged)) {
                element.CurrentActionSalvaged = true;
            }
            element.Actions.clear();
            if (this.m_pCurrentTarget == element) {
                this.m_bCurrentTargetSalvaged = true;
            }
            else {
                this.DeleteHashElement(element);
            }
        }
    };
    CCActionManager.prototype.hasAction = function (action) {
        if (action == null || action.OriginalTarget == null) {
            return false;
        }
        var target = action.OriginalTarget;
        var element = this.FindElementBySprite(target);
        if (element != null) {
            var i = element.Actions.indexOf(action);
            return i != -1;
        }
        return false;
    };
    CCActionManager.prototype.hasActionByTarget = function (target) {
        var element = this.FindElementBySprite(target);
        if (element != null)
            return element.Actions.length > 0;
        return false;
    };
    CCActionManager.prototype.RemoveAction = function (action) {
        if (action == null || action.OriginalTarget == null) {
            return;
        }
        var target = action.OriginalTarget;
        var element = this.FindElementBySprite(target);
        if (element != null) {
            var i = element.Actions.indexOf(action);
            if (i != -1) {
                this.RemoveActionAtIndex(i, element);
            }
            else {
            }
        }
        else {
        }
        action.Clear();
    };
    CCActionManager.prototype.RemoveActionByTag = function (tag, target) {
        var element = this.FindElementBySprite(target);
        if (element != null) {
            var limit = element.Actions.length;
            for (var i = 0; i < limit; i++) {
                var action = element.Actions[i];
                if (action.GetTag() == tag && action.OriginalTarget == target) {
                    this.RemoveActionAtIndex(i, element);
                    break;
                }
            }
        }
        else {
        }
    };
    CCActionManager.prototype.GetActionByTag = function (tag, target) {
        var element = this.FindElementBySprite(target);
        if (element != null) {
            if (element.Actions != null) {
                var limit = element.Actions.length;
                for (var i = 0; i < limit; i++) {
                    var action = element.Actions[i];
                    if (action.GetTag() == tag) {
                        return action;
                    }
                }
            }
        }
        else {
        }
        return null;
    };
    CCActionManager.prototype.NumberOfRunningActionsInTarget = function (target) {
        var element = this.FindElementBySprite(target);
        if (element != null) {
            return (element.Actions != null) ? element.Actions.length : 0;
        }
        return 0;
    };
    CCActionManager.Instance = function () {
        if (!CCActionManager.s_pInstance) {
            CCActionManager.s_pInstance = new CCActionManager();
            CCActionManager.s_pInstance.SetAutoUpdate(true);
        }
        return CCActionManager.s_pInstance;
    };
    CCActionManager.prototype.GetUpdateTime = function () {
        return this.m_pTimer;
    };
    CCActionManager.prototype.SetAutoUpdate = function (bAutoUpdate) {
        if (bAutoUpdate) {
            if (this.m_pTimer == null) {
                this.m_pTimer = new dTimer();
                var pThis = this;
                this.m_pTimer.Create(0, -1, function (t, ii, fTimeElapse) {
                    pThis.Update(fTimeElapse);
                });
            }
        }
        else {
            if (this.m_pTimer != null) {
                this.m_pTimer.Stop();
                this.m_pTimer = null;
            }
        }
    };
    CCActionManager.s_pInstance = null;
    return CCActionManager;
}(dObject));
var CCActionHashElement = (function () {
    function CCActionHashElement() {
        this.ActionIndex = 0;
        this.Actions = null;
        this.CurrentAction = null;
        this.CurrentActionSalvaged = false;
        this.Paused = false;
        this.Target = null;
        this.bAutoRemoveWhenChildRemoveRoot = false;
    }
    return CCActionHashElement;
}());
var CCAnimate = (function (_super) {
    __extends(CCAnimate, _super);
    function CCAnimate(fDelayPerUnit, nLoops, startFrame, endFrame, bSetFrameWithChild, bRandomStartFrame) {
        if (fDelayPerUnit === void 0) { fDelayPerUnit = 0.1; }
        if (nLoops === void 0) { nLoops = 1; }
        if (startFrame === void 0) { startFrame = 0; }
        if (endFrame === void 0) { endFrame = 1; }
        if (bSetFrameWithChild === void 0) { bSetFrameWithChild = false; }
        if (bRandomStartFrame === void 0) { bRandomStartFrame = false; }
        var _this = _super.call(this) || this;
        _this.m_nNextFrame = 0;
        _this.m_uExecutedLoops = 0;
        _this.m_uLoops = 1;
        _this.m_fDelayPerUnit = 0;
        _this.m_nStartFrame = 0;
        _this.m_nEndFrame = 0;
        _this.m_bSetFrameWithChild = false;
        _this.m_bRandomStartFrame = false;
        _this.m_nRandomStartFrameDelta = 0;
        _this.m_fDelayPerUnit = fDelayPerUnit;
        _this.Loops = nLoops;
        _this.m_bSetFrameWithChild = bSetFrameWithChild;
        _this.m_bRandomStartFrame = bRandomStartFrame;
        _this.m_nStartFrame = startFrame;
        _this.m_nEndFrame = endFrame;
        var singleDuration = (endFrame - startFrame) * _this.m_fDelayPerUnit;
        _super.prototype.InitWithDuration.call(_this, singleDuration * _this.Loops);
        _this.m_nNextFrame = 0;
        _this.m_uExecutedLoops = 0;
        return _this;
    }
    CCAnimate.prototype.GetStartFrame = function () {
        return this.m_nStartFrame;
    };
    CCAnimate.prototype.GetEndFrame = function () {
        return this.m_nEndFrame;
    };
    Object.defineProperty(CCAnimate.prototype, "DelayPerUnit", {
        get: function () {
            return this.m_fDelayPerUnit;
        },
        set: function (value) {
            this.m_fDelayPerUnit = value;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(CCAnimate.prototype, "Loops", {
        get: function () {
            return this.m_uLoops;
        },
        set: function (value) {
            if (value < 0)
                value = dMath.dINT_MAX;
            this.m_uLoops = value;
        },
        enumerable: false,
        configurable: true
    });
    CCAnimate.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_nNextFrame = 0;
        this.m_uExecutedLoops = 0;
        if (this.m_bRandomStartFrame)
            this.m_nRandomStartFrameDelta = dMath.RandomI() % this.GetFrameCount();
        else
            this.m_nRandomStartFrameDelta = 0;
    };
    CCAnimate.prototype.GetFrameCount = function () {
        var ret = this.m_nEndFrame - this.m_nStartFrame;
        if (ret < 1)
            ret = 1;
        return ret;
    };
    CCAnimate.prototype.Stop = function () {
        _super.prototype.Stop.call(this);
    };
    CCAnimate.prototype.Update = function (t) {
        if (t < 1.0) {
            t *= this.Loops;
            var loopNumber = dMath.ToInt(t);
            if (loopNumber > this.m_uExecutedLoops) {
                this.m_nNextFrame = 0;
                this.m_uExecutedLoops++;
            }
            t = t % 1.0;
        }
        var numberOfFrames = this.m_nEndFrame - this.m_nStartFrame;
        for (var i = this.m_nNextFrame; i < numberOfFrames; i++) {
            var splitTime = i / numberOfFrames;
            if (splitTime <= t) {
                this.m_pTarget.SetFrame(((i + this.m_nRandomStartFrameDelta) % numberOfFrames) + this.m_nStartFrame, this.m_bSetFrameWithChild);
                this.m_nNextFrame = i + 1;
            }
            else {
                break;
            }
        }
    };
    return CCAnimate;
}(CCActionInterval));
var CCBezierBy = (function (_super) {
    __extends(CCBezierBy, _super);
    function CCBezierBy(t, c, bSetDir) {
        if (bSetDir === void 0) { bSetDir = false; }
        var _this = _super.call(this) || this;
        _this.m_sConfig = null;
        _this.m_startPosition = null;
        _this.m_previousPosition = null;
        _this.m_bSetDir = bSetDir;
        _super.prototype.InitWithDuration.call(_this, t);
        _this.m_sConfig = c;
        return _this;
    }
    CCBezierBy.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_startPosition = new dVector2(target.GetPosX(), target.GetPosY());
        this.m_previousPosition = new dVector2().Copy(this.m_startPosition);
    };
    CCBezierBy.prototype.Update = function (time) {
        var a = this;
        if (a.m_pTarget != null) {
            var xa = 0;
            var xb = a.m_sConfig.ControlPoint1.x;
            var xc = a.m_sConfig.ControlPoint2.x;
            var xd = a.m_sConfig.EndPosition.x;
            var ya = 0;
            var yb = a.m_sConfig.ControlPoint1.y;
            var yc = a.m_sConfig.ControlPoint2.y;
            var yd = a.m_sConfig.EndPosition.y;
            var x = CCSplineMath.CubicBezier(xa, xb, xc, xd, time);
            var y = CCSplineMath.CubicBezier(ya, yb, yc, yd, time);
            var currentPosX = a.m_pTarget.GetPosX();
            var currentPosY = a.m_pTarget.GetPosY();
            var diffX = currentPosX - a.m_previousPosition.x;
            var diffY = currentPosY - a.m_previousPosition.y;
            a.m_startPosition.x = a.m_startPosition.x + diffX;
            a.m_startPosition.y = a.m_startPosition.y + diffY;
            var newPosX = a.m_startPosition.x + x;
            var newPosY = a.m_startPosition.y + y;
            a.m_pTarget.SetPos(newPosX, newPosY);
            if (a.m_bSetDir) {
                if (!dMath.FloatEquals(newPosX, a.m_previousPosition.x) || !dMath.FloatEquals(newPosY, a.m_previousPosition.y)) {
                    a.m_previousPosition.SetValue(newPosX - a.m_previousPosition.x, newPosY - a.m_previousPosition.y);
                    a.m_previousPosition.Normalize();
                    a.m_pTarget.SetRotation(a.m_previousPosition.ToAngle());
                }
            }
            a.m_previousPosition.SetValue(newPosX, newPosY);
        }
    };
    return CCBezierBy;
}(CCActionInterval));
var CCBezierConfig = (function () {
    function CCBezierConfig(ControlPoint1X, ControlPoint1Y, ControlPoint2X, ControlPoint2Y, EndPositionX, EndPositionY) {
        if (ControlPoint1X === void 0) { ControlPoint1X = 0; }
        if (ControlPoint1Y === void 0) { ControlPoint1Y = 0; }
        if (ControlPoint2X === void 0) { ControlPoint2X = 0; }
        if (ControlPoint2Y === void 0) { ControlPoint2Y = 0; }
        if (EndPositionX === void 0) { EndPositionX = 0; }
        if (EndPositionY === void 0) { EndPositionY = 0; }
        this.ControlPoint1 = new dVector2(ControlPoint1X, ControlPoint1Y);
        this.ControlPoint2 = new dVector2(ControlPoint2X, ControlPoint2Y);
        this.EndPosition = new dVector2(EndPositionX, EndPositionY);
    }
    return CCBezierConfig;
}());
var CCBezierTo = (function (_super) {
    __extends(CCBezierTo, _super);
    function CCBezierTo(t, c, bSetDir) {
        if (bSetDir === void 0) { bSetDir = false; }
        return _super.call(this, t, c, bSetDir) || this;
    }
    CCBezierTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        var a = this;
        a.m_sConfig.ControlPoint1.x -= a.m_startPosition.x;
        a.m_sConfig.ControlPoint1.y -= a.m_startPosition.y;
        a.m_sConfig.ControlPoint2.x -= a.m_startPosition.x;
        a.m_sConfig.ControlPoint2.y -= a.m_startPosition.y;
        a.m_sConfig.EndPosition.x -= a.m_startPosition.x;
        a.m_sConfig.EndPosition.y -= a.m_startPosition.y;
    };
    return CCBezierTo;
}(CCBezierBy));
var CCBlink = (function (_super) {
    __extends(CCBlink, _super);
    function CCBlink(duration, uBlinks) {
        var _this = _super.call(this) || this;
        _this.m_bOriginalState = false;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_nTimes = uBlinks;
        return _this;
    }
    CCBlink.prototype.Stop = function () {
        if (this.m_pTarget != null)
            this.m_pTarget.SetShow(this.m_bOriginalState);
        _super.prototype.Stop.call(this);
    };
    CCBlink.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_bOriginalState = target.isShow();
    };
    CCBlink.prototype.Update = function (time) {
        if (this.m_pTarget != null && !this.IsDone()) {
            if (this.m_nTimes <= 0) {
                this.m_pTarget.visible = !this.m_pTarget.visible;
            }
            else {
                var slice = 1.0 / this.m_nTimes;
                var m = time % slice;
                this.m_pTarget.SetShow(m > (slice / 2));
            }
        }
    };
    return CCBlink;
}(CCActionInterval));
var CCBrightnessTo = (function (_super) {
    __extends(CCBrightnessTo, _super);
    function CCBrightnessTo(duration, brightness, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        var _this = _super.call(this) || this;
        _this.m_fromBrightness = 0;
        _this.m_toBrightness = 0;
        _this.m_bSetToChild = false;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_toBrightness = brightness;
        _this.m_bSetToChild = bSetToChild;
        return _this;
    }
    CCBrightnessTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        if (target != null) {
            this.m_fromBrightness = target.GetBrightness();
        }
    };
    CCBrightnessTo.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            this.m_pTarget.SetBrightness((this.m_fromBrightness + (this.m_toBrightness - this.m_fromBrightness) * time), this.m_bSetToChild);
        }
    };
    return CCBrightnessTo;
}(CCActionInterval));
var CCCallFunc = (function (_super) {
    __extends(CCCallFunc, _super);
    function CCCallFunc(selector, pObject) {
        if (pObject === void 0) { pObject = null; }
        var _this = _super.call(this) || this;
        _this.m_pCallFuncO = null;
        _this.m_pObject = null;
        _this.m_pObject = pObject;
        _this.m_pCallFuncO = selector;
        return _this;
    }
    CCCallFunc.prototype.GetCallback = function () {
        return this.m_pCallFuncO;
    };
    CCCallFunc.prototype.SetCallback = function (call) {
        this.m_pCallFuncO = call;
    };
    CCCallFunc.prototype.Update = function (time) {
        this.Execute();
    };
    CCCallFunc.prototype.Execute = function () {
        if (null != this.m_pCallFuncO) {
            this.m_pCallFuncO(this.m_pObject);
        }
    };
    return CCCallFunc;
}(CCActionInstant));
var CCCustom = (function (_super) {
    __extends(CCCustom, _super);
    function CCCustom(duration, onCallback) {
        var _this = _super.call(this) || this;
        _this.m_onCallback = null;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_onCallback = onCallback;
        return _this;
    }
    CCCustom.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
    };
    CCCustom.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            if (this.m_onCallback != null)
                this.m_onCallback(time);
        }
    };
    return CCCustom;
}(CCActionInterval));
var CCDelayTime = (function (_super) {
    __extends(CCDelayTime, _super);
    function CCDelayTime(d) {
        var _this = _super.call(this) || this;
        _this.InitWithDuration(d);
        return _this;
    }
    CCDelayTime.prototype.Update = function (time) {
    };
    return CCDelayTime;
}(CCActionInterval));
var CCEaseBackIn = (function (_super) {
    __extends(CCEaseBackIn, _super);
    function CCEaseBackIn() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseBackIn.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.BackIn(time));
    };
    return CCEaseBackIn;
}(CCActionEase));
var CCEaseBackInOut = (function (_super) {
    __extends(CCEaseBackInOut, _super);
    function CCEaseBackInOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseBackInOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.BackInOut(time));
    };
    return CCEaseBackInOut;
}(CCActionEase));
var CCEaseBackOut = (function (_super) {
    __extends(CCEaseBackOut, _super);
    function CCEaseBackOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseBackOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.BackOut(time));
    };
    return CCEaseBackOut;
}(CCActionEase));
var CCEaseBounceIn = (function (_super) {
    __extends(CCEaseBounceIn, _super);
    function CCEaseBounceIn() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseBounceIn.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.BounceIn(time));
    };
    return CCEaseBounceIn;
}(CCActionEase));
var CCEaseBounceInOut = (function (_super) {
    __extends(CCEaseBounceInOut, _super);
    function CCEaseBounceInOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseBounceInOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.BounceInOut(time));
    };
    return CCEaseBounceInOut;
}(CCActionEase));
var CCEaseBounceOut = (function (_super) {
    __extends(CCEaseBounceOut, _super);
    function CCEaseBounceOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseBounceOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.BounceOut(time));
    };
    return CCEaseBounceOut;
}(CCActionEase));
var CCEaseCustom = (function (_super) {
    __extends(CCEaseCustom, _super);
    function CCEaseCustom(pAction, easeFunc) {
        var _this = _super.call(this, pAction) || this;
        _super.prototype.InitWithAction.call(_this, pAction);
        _this.m_EaseFunc = easeFunc;
        return _this;
    }
    Object.defineProperty(CCEaseCustom.prototype, "EaseFunc", {
        get: function () {
            return this.m_EaseFunc;
        },
        set: function (value) {
            this.m_EaseFunc = value;
        },
        enumerable: false,
        configurable: true
    });
    CCEaseCustom.prototype.SetEaseFun = function (value) {
        this.m_EaseFunc = value;
        return this;
    };
    CCEaseCustom.prototype.Update = function (time) {
        this.m_pInner.Update(this.m_EaseFunc(time));
    };
    return CCEaseCustom;
}(CCActionEase));
var CCEaseElastic = (function (_super) {
    __extends(CCEaseElastic, _super);
    function CCEaseElastic(pAction, fPeriod) {
        if (fPeriod === void 0) { fPeriod = 0.3; }
        var _this = _super.call(this, pAction) || this;
        _this.m_fPeriod = 0;
        _super.prototype.InitWithAction.call(_this, pAction);
        _this.m_fPeriod = fPeriod;
        return _this;
    }
    Object.defineProperty(CCEaseElastic.prototype, "Period", {
        get: function () {
            return this.m_fPeriod;
        },
        set: function (value) {
            this.m_fPeriod = value;
        },
        enumerable: false,
        configurable: true
    });
    CCEaseElastic.prototype.InitWithAction = function (pAction) {
        _super.prototype.InitWithAction.call(this, pAction);
        this.m_fPeriod = 0.3;
    };
    return CCEaseElastic;
}(CCActionEase));
var CCEaseElasticIn = (function (_super) {
    __extends(CCEaseElasticIn, _super);
    function CCEaseElasticIn() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseElasticIn.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.ElasticIn(time, this.m_fPeriod));
    };
    return CCEaseElasticIn;
}(CCEaseElastic));
var CCEaseElasticInOut = (function (_super) {
    __extends(CCEaseElasticInOut, _super);
    function CCEaseElasticInOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseElasticInOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.ElasticInOut(time, this.m_fPeriod));
    };
    return CCEaseElasticInOut;
}(CCEaseElastic));
var CCEaseElasticOut = (function (_super) {
    __extends(CCEaseElasticOut, _super);
    function CCEaseElasticOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseElasticOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.ElasticOut(time, this.m_fPeriod));
    };
    return CCEaseElasticOut;
}(CCEaseElastic));
var CCEaseExponentialIn = (function (_super) {
    __extends(CCEaseExponentialIn, _super);
    function CCEaseExponentialIn() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseExponentialIn.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.ExponentialIn(time));
    };
    return CCEaseExponentialIn;
}(CCActionEase));
var CCEaseExponentialInOut = (function (_super) {
    __extends(CCEaseExponentialInOut, _super);
    function CCEaseExponentialInOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseExponentialInOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.ExponentialInOut(time));
    };
    return CCEaseExponentialInOut;
}(CCActionEase));
var CCEaseExponentialOut = (function (_super) {
    __extends(CCEaseExponentialOut, _super);
    function CCEaseExponentialOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseExponentialOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.ExponentialOut(time));
    };
    return CCEaseExponentialOut;
}(CCActionEase));
var CCEaseRateAction = (function (_super) {
    __extends(CCEaseRateAction, _super);
    function CCEaseRateAction(pAction, fRate) {
        var _this = _super.call(this, pAction) || this;
        _this.m_fRate = fRate;
        return _this;
    }
    Object.defineProperty(CCEaseRateAction.prototype, "Rate", {
        get: function () {
            return this.m_fRate;
        },
        set: function (value) {
            this.m_fRate = value;
        },
        enumerable: false,
        configurable: true
    });
    return CCEaseRateAction;
}(CCActionEase));
var CCEaseIn = (function (_super) {
    __extends(CCEaseIn, _super);
    function CCEaseIn() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseIn.prototype.Update = function (time) {
        this.m_pInner.Update(dMath.Pow(time, this.m_fRate));
    };
    return CCEaseIn;
}(CCEaseRateAction));
var CCEaseInOut = (function (_super) {
    __extends(CCEaseInOut, _super);
    function CCEaseInOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseInOut.prototype.Update = function (time) {
        time *= 2;
        if (time < 1) {
            this.m_pInner.Update(0.5 * dMath.Pow(time, this.m_fRate));
        }
        else {
            this.m_pInner.Update(1.0 - 0.5 * dMath.Pow(2 - time, this.m_fRate));
        }
    };
    return CCEaseInOut;
}(CCEaseRateAction));
var CCEaseMath = (function () {
    function CCEaseMath() {
    }
    CCEaseMath.BackIn = function (time) {
        var overshoot = 1.70158;
        return time * time * ((overshoot + 1) * time - overshoot);
    };
    CCEaseMath.BackOut = function (time) {
        var overshoot = 1.70158;
        time = time - 1;
        return time * time * ((overshoot + 1) * time + overshoot) + 1;
    };
    CCEaseMath.BackInOut = function (time) {
        var overshoot = 1.70158 * 1.525;
        time = time * 2;
        if (time < 1) {
            return (time * time * ((overshoot + 1) * time - overshoot)) / 2;
        }
        else {
            time = time - 2;
            return (time * time * ((overshoot + 1) * time + overshoot)) / 2 + 1;
        }
    };
    CCEaseMath.BounceOut = function (time) {
        if (time < 1 / 2.75) {
            return 7.5625 * time * time;
        }
        else if (time < 2 / 2.75) {
            time -= 1.5 / 2.75;
            return 7.5625 * time * time + 0.75;
        }
        else if (time < 2.5 / 2.75) {
            time -= 2.25 / 2.75;
            return 7.5625 * time * time + 0.9375;
        }
        time -= 2.625 / 2.75;
        return 7.5625 * time * time + 0.984375;
    };
    CCEaseMath.BounceIn = function (time) {
        return 1 - CCEaseMath.BounceOut(1 - time);
    };
    CCEaseMath.BounceInOut = function (time) {
        if (time < 0.5) {
            time = time * 2;
            return (1 - CCEaseMath.BounceOut(1 - time)) * 0.5;
        }
        return CCEaseMath.BounceOut(time * 2 - 1) * 0.5 + 0.5;
    };
    CCEaseMath.SineOut = function (time) {
        return dMath.Sin(time * (dMath.dPI * 2));
    };
    CCEaseMath.SineIn = function (time) {
        return -1 * dMath.Cos(time * (dMath.dPI * 2)) + 1;
    };
    CCEaseMath.SineInOut = function (time) {
        return -0.5 * (dMath.Cos(dMath.dPI * time) - 1);
    };
    CCEaseMath.ExponentialOut = function (time) {
        return time == 1 ? 1 : (-dMath.Pow(2, -10 * time / 1) + 1);
    };
    CCEaseMath.ExponentialIn = function (time) {
        return time == 0 ? 0 : dMath.Pow(2, 10 * (time / 1 - 1)) - 1 * 0.001;
    };
    CCEaseMath.ExponentialInOut = function (time) {
        time /= 0.5;
        if (time < 1) {
            return 0.5 * dMath.Pow(2, 10 * (time - 1));
        }
        else {
            return 0.5 * (-dMath.Pow(2, -10 * (time - 1)) + 2);
        }
    };
    CCEaseMath.ElasticIn = function (time, period) {
        if (time == 0 || time == 1) {
            return time;
        }
        else {
            var s = period / 4;
            time = time - 1;
            return -(dMath.Pow(2, 10 * time) * dMath.Sin((time - s) * dMath.dPI * 2.0 / period));
        }
    };
    CCEaseMath.ElasticOut = function (time, period) {
        if (time == 0 || time == 1) {
            return time;
        }
        else {
            var s = period / 4;
            return (dMath.Pow(2, -10 * time) * dMath.Sin((time - s) * dMath.dPI * 2 / period) + 1);
        }
    };
    CCEaseMath.ElasticInOut = function (time, period) {
        if (time == 0 || time == 1) {
            return time;
        }
        else {
            time = time * 2;
            if (period == 0) {
                period = 0.3 * 1.5;
            }
            var s = period / 4;
            time = time - 1;
            if (time < 0) {
                return (-0.5 * dMath.Pow(2, 10 * time) * dMath.Sin((time - s) * (dMath.dPI * 2) / period));
            }
            else {
                return (dMath.Pow(2, -10 * time) * dMath.Sin((time - s) * (dMath.dPI * 2) / period) * 0.5 + 1);
            }
        }
    };
    return CCEaseMath;
}());
var CCEaseOut = (function (_super) {
    __extends(CCEaseOut, _super);
    function CCEaseOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseOut.prototype.Update = function (time) {
        this.m_pInner.Update(dMath.Pow(time, 1 / this.m_fRate));
    };
    return CCEaseOut;
}(CCEaseRateAction));
var CCEaseSineIn = (function (_super) {
    __extends(CCEaseSineIn, _super);
    function CCEaseSineIn() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseSineIn.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.SineIn(time));
    };
    return CCEaseSineIn;
}(CCActionEase));
var CCEaseSineInOut = (function (_super) {
    __extends(CCEaseSineInOut, _super);
    function CCEaseSineInOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseSineInOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.SineInOut(time));
    };
    return CCEaseSineInOut;
}(CCActionEase));
var CCEaseSineOut = (function (_super) {
    __extends(CCEaseSineOut, _super);
    function CCEaseSineOut() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCEaseSineOut.prototype.Update = function (time) {
        this.m_pInner.Update(CCEaseMath.SineOut(time));
    };
    return CCEaseSineOut;
}(CCActionEase));
var CCExtraAction = (function (_super) {
    __extends(CCExtraAction, _super);
    function CCExtraAction() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCExtraAction.prototype.Step = function (dt) {
    };
    CCExtraAction.prototype.Update = function (time) {
    };
    return CCExtraAction;
}(CCFiniteTimeAction));
var CCFadeIn = (function (_super) {
    __extends(CCFadeIn, _super);
    function CCFadeIn(d) {
        var _this = _super.call(this) || this;
        _this.InitWithDuration(d);
        return _this;
    }
    CCFadeIn.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            this.m_pTarget.SetAlpha(time, true);
        }
    };
    return CCFadeIn;
}(CCActionInterval));
var CCFadeOut = (function (_super) {
    __extends(CCFadeOut, _super);
    function CCFadeOut(d) {
        var _this = _super.call(this) || this;
        _this.InitWithDuration(d);
        return _this;
    }
    CCFadeOut.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            this.m_pTarget.SetAlpha(1 - time, true);
        }
    };
    return CCFadeOut;
}(CCActionInterval));
var CCFadeTo = (function (_super) {
    __extends(CCFadeTo, _super);
    function CCFadeTo(duration, opacity, bSetToChild) {
        if (bSetToChild === void 0) { bSetToChild = false; }
        var _this = _super.call(this) || this;
        _this.m_fromOpacity = 0;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_toOpacity = opacity;
        _this.m_bSetToChild = bSetToChild;
        return _this;
    }
    CCFadeTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        if (target != null) {
            this.m_fromOpacity = target.GetAlpha();
        }
    };
    CCFadeTo.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            this.m_pTarget.SetAlpha((this.m_fromOpacity + (this.m_toOpacity - this.m_fromOpacity) * time), this.m_bSetToChild);
        }
    };
    return CCFadeTo;
}(CCActionInterval));
var CCFlipX = (function (_super) {
    __extends(CCFlipX, _super);
    function CCFlipX(x) {
        var _this = _super.call(this) || this;
        _this.m_bFlipX = x;
        return _this;
    }
    CCFlipX.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        if (this.m_bFlipX)
            target.scaleX = -dMath.Abs(target.scaleX);
        else
            target.scaleX = dMath.Abs(target.scaleX);
    };
    return CCFlipX;
}(CCActionInstant));
var CCFlipY = (function (_super) {
    __extends(CCFlipY, _super);
    function CCFlipY(y) {
        var _this = _super.call(this) || this;
        _this.m_bFlipY = y;
        return _this;
    }
    CCFlipY.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        if (this.m_bFlipY)
            target.scaleY = -dMath.Abs(target.scaleY);
        else
            target.scaleY = dMath.Abs(target.scaleY);
    };
    return CCFlipY;
}(CCActionInstant));
var CCFollow = (function (_super) {
    __extends(CCFollow, _super);
    function CCFollow(followedNode, rect) {
        var _this = _super.call(this) || this;
        _this.m_bBoundaryFullyCovered = false;
        _this.m_bBoundarySet = false;
        _this.m_fBottomBoundary = 0;
        _this.m_fLeftBoundary = 0;
        _this.m_fRightBoundary = 0;
        _this.m_fTopBoundary = 0;
        _this.m_obFullScreenSize = null;
        _this.m_obHalfScreenSize = null;
        _this.m_pobFollowedNode = null;
        _this.InitWithTarget(followedNode, rect);
        return _this;
    }
    Object.defineProperty(CCFollow.prototype, "BoundarySet", {
        get: function () {
            return this.m_bBoundarySet;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(CCFollow.prototype, "BounderySet", {
        set: function (value) {
            this.m_bBoundarySet = value;
        },
        enumerable: false,
        configurable: true
    });
    CCFollow.prototype.InitWithTarget = function (pFollowedNode, rect) {
        if (pFollowedNode == null)
            throw "pFollowedNode == null";
        this.m_pobFollowedNode = pFollowedNode;
        if (rect.isZero()) {
            this.m_bBoundarySet = false;
        }
        else {
            this.m_bBoundarySet = true;
        }
        this.m_bBoundaryFullyCovered = false;
        var winSize = new dVector2(dThread.GetWindowWidth(), dThread.GetWindowHeight());
        this.m_obFullScreenSize = winSize;
        this.m_obHalfScreenSize = this.m_obFullScreenSize.MulF(0.5);
        if (this.m_bBoundarySet) {
            this.m_fLeftBoundary = -((rect.OriginX() + rect.Width()) - this.m_obFullScreenSize.x);
            this.m_fRightBoundary = -rect.OriginX();
            this.m_fTopBoundary = -rect.OriginY();
            this.m_fBottomBoundary = -((rect.OriginY() + rect.Height()) - this.m_obFullScreenSize.y);
            if (this.m_fRightBoundary < this.m_fLeftBoundary) {
                this.m_fRightBoundary = this.m_fLeftBoundary = (this.m_fLeftBoundary + this.m_fRightBoundary) / 2;
            }
            if (this.m_fTopBoundary < this.m_fBottomBoundary) {
                this.m_fTopBoundary = this.m_fBottomBoundary = (this.m_fTopBoundary + this.m_fBottomBoundary) / 2;
            }
            if ((this.m_fTopBoundary == this.m_fBottomBoundary) && (this.m_fLeftBoundary == this.m_fRightBoundary)) {
                this.m_bBoundaryFullyCovered = true;
            }
        }
    };
    CCFollow.prototype.Step = function (dt) {
        if (this.m_bBoundarySet) {
            if (this.m_bBoundaryFullyCovered) {
                return;
            }
            var tempPos = this.m_obHalfScreenSize.Sub(new dVector2(this.m_pobFollowedNode.GetPosX(), this.m_pobFollowedNode.GetPosY()));
            this.m_pTarget.SetPos(dMath.Clamp(tempPos.x, this.m_fLeftBoundary, this.m_fRightBoundary), dMath.Clamp(tempPos.y, this.m_fBottomBoundary, this.m_fTopBoundary));
        }
        else {
            this.m_pTarget.SetPos(this.m_obHalfScreenSize.x - this.m_pobFollowedNode.GetPosX(), this.m_obHalfScreenSize.y - this.m_pobFollowedNode.GetPosY());
        }
    };
    CCFollow.prototype.Stop = function () {
        this.m_pTarget = null;
        _super.prototype.Stop.call(this);
    };
    return CCFollow;
}(CCAction));
var CCFrameTo = (function (_super) {
    __extends(CCFrameTo, _super);
    function CCFrameTo(frame) {
        var _this = _super.call(this) || this;
        _this.m_nFrame = frame;
        return _this;
    }
    CCFrameTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        target.SetFrame(this.m_nFrame);
    };
    return CCFrameTo;
}(CCActionInstant));
var CCHide = (function (_super) {
    __extends(CCHide, _super);
    function CCHide() {
        return _super.call(this) || this;
    }
    CCHide.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        target.SetShow(false);
    };
    return CCHide;
}(CCActionInstant));
var CCJumpBy = (function (_super) {
    __extends(CCJumpBy, _super);
    function CCJumpBy(duration, position, height, jumps) {
        if (jumps === void 0) { jumps = 1; }
        var _this = _super.call(this) || this;
        _this.m_delta = null;
        _this.m_height = 0;
        _this.m_nJumps = 0;
        _this.m_startPosition = null;
        _this.m_previousPos = null;
        _this.InitWithDuration(duration);
        _this.m_delta = position;
        _this.m_height = height;
        _this.m_nJumps = jumps;
        return _this;
    }
    CCJumpBy.prototype.GetPosition = function () {
        return this.m_delta;
    };
    CCJumpBy.prototype.GetHeight = function () {
        return this.m_height;
    };
    CCJumpBy.prototype.GetJumps = function () {
        return this.m_nJumps;
    };
    CCJumpBy.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_startPosition = new dVector3(target.GetPosX(), target.GetPosY(), target.GetPosZ());
        this.m_previousPos = new dVector3().Copy(this.m_startPosition);
    };
    CCJumpBy.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            var frac = (time * this.m_nJumps) % 1;
            var y = -this.m_height * 4 * frac * (1 - frac);
            y += this.m_delta.y * time;
            var x = this.m_delta.x * time;
            var z = this.m_delta.z * time;
            var currentPosX = this.m_pTarget.GetPosX();
            var currentPosY = this.m_pTarget.GetPosY();
            var currentPosZ = this.m_pTarget.GetPosZ();
            var diffX = currentPosX - this.m_previousPos.x;
            var diffY = currentPosY - this.m_previousPos.y;
            var diffZ = currentPosZ - this.m_previousPos.z;
            this.m_startPosition.x = diffX + this.m_startPosition.x;
            this.m_startPosition.y = diffY + this.m_startPosition.y;
            this.m_startPosition.z = diffZ + this.m_startPosition.z;
            var newPosX = this.m_startPosition.x + x;
            var newPosY = this.m_startPosition.y + y;
            var newPosZ = this.m_startPosition.z + z;
            this.m_pTarget.SetPos3D(newPosX, newPosY, newPosZ);
            this.m_previousPos.x = newPosX;
            this.m_previousPos.y = newPosY;
            this.m_previousPos.z = newPosZ;
        }
    };
    return CCJumpBy;
}(CCActionInterval));
var CCJumpTo = (function (_super) {
    __extends(CCJumpTo, _super);
    function CCJumpTo(duration, position, height, jumps) {
        if (jumps === void 0) { jumps = 1; }
        return _super.call(this, duration, position, height, jumps) || this;
    }
    CCJumpTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_delta = new dVector3(this.m_delta.x - this.m_startPosition.x, this.m_delta.y - this.m_startPosition.y, this.m_delta.z - this.m_startPosition.z);
    };
    return CCJumpTo;
}(CCJumpBy));
var CCMoveBy = (function (_super) {
    __extends(CCMoveBy, _super);
    function CCMoveBy(duration, x, y, z, bSetDir, randomRangeX, randomRangeY, randomRangeZ, bMirrorWithTarget) {
        if (z === void 0) { z = 0; }
        if (bSetDir === void 0) { bSetDir = false; }
        if (randomRangeX === void 0) { randomRangeX = 0; }
        if (randomRangeY === void 0) { randomRangeY = 0; }
        if (randomRangeZ === void 0) { randomRangeZ = 0; }
        if (bMirrorWithTarget === void 0) { bMirrorWithTarget = false; }
        var _this = _super.call(this) || this;
        _this.m_positionDelta = null;
        _this.m_positionDelta2 = null;
        _this.m_randomRangeDelta = null;
        _this.m_randomRangeDelta2 = new dVector3();
        _this.m_endPosition = null;
        _this.m_startPosition = null;
        _this.m_previousPosition = null;
        _this.m_bSetDir = false;
        _this.m_bMirrorWithTarget = false;
        _this.m_vTrans = new dVector3();
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_positionDelta = new dVector3(x, y, z);
        _this.m_randomRangeDelta = new dVector3(randomRangeX, randomRangeY, randomRangeZ);
        _this.m_bSetDir = bSetDir;
        _this.m_bMirrorWithTarget = bMirrorWithTarget;
        return _this;
    }
    CCMoveBy.prototype.GetPositionDelta = function () {
        return this.m_positionDelta;
    };
    CCMoveBy.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_positionDelta2 = new dVector3().Copy(this.m_positionDelta);
        if (this.m_bMirrorWithTarget) {
            var mat = target.GetMatrixWorld();
            if (mat._11 < 0)
                this.m_positionDelta2.x = -this.m_positionDelta2.x;
            if (mat._22 < 0)
                this.m_positionDelta2.y = -this.m_positionDelta2.y;
            if (mat._33 < 0)
                this.m_positionDelta2.z = -this.m_positionDelta2.z;
        }
        this.m_startPosition = new dVector3(target.GetPosX(), target.GetPosY(), target.GetPosZ());
        this.m_previousPosition = new dVector3().Copy(this.m_startPosition);
        this.m_randomRangeDelta2.SetValue(dMath.RandomRange(-this.m_randomRangeDelta.x, this.m_randomRangeDelta.x), dMath.RandomRange(-this.m_randomRangeDelta.y, this.m_randomRangeDelta.y), dMath.RandomRange(-this.m_randomRangeDelta.z, this.m_randomRangeDelta.z));
    };
    CCMoveBy.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            var currentPosX = this.m_pTarget.GetPosX();
            var currentPosY = this.m_pTarget.GetPosY();
            var currentPosZ = this.m_pTarget.GetPosZ();
            var diffX = currentPosX - this.m_previousPosition.x;
            var diffY = currentPosY - this.m_previousPosition.y;
            var diffZ = currentPosZ - this.m_previousPosition.z;
            this.m_startPosition.x = this.m_startPosition.x + diffX;
            this.m_startPosition.y = this.m_startPosition.y + diffY;
            this.m_startPosition.z = this.m_startPosition.z + diffZ;
            this.m_vTrans.SetValue((this.m_positionDelta2.x + this.m_randomRangeDelta2.x), (this.m_positionDelta2.y + this.m_randomRangeDelta2.y), (this.m_positionDelta2.z + this.m_randomRangeDelta2.z));
            var newPosX = this.m_startPosition.x + this.m_vTrans.x * time;
            var newPosY = this.m_startPosition.y + this.m_vTrans.y * time;
            var newPosZ = this.m_startPosition.z + this.m_vTrans.z * time;
            this.m_pTarget.SetPos3D(newPosX, newPosY, newPosZ);
            if (this.m_bSetDir) {
                if (!dMath.FloatEquals(newPosX, this.m_previousPosition.x) || !dMath.FloatEquals(newPosY, this.m_previousPosition.y) || !dMath.FloatEquals(newPosZ, this.m_previousPosition.z)) {
                    this.m_previousPosition.SetValue(newPosX - this.m_previousPosition.x, newPosY - this.m_previousPosition.y, newPosZ - this.m_previousPosition.z);
                    this.m_previousPosition.Normalize();
                    this.m_pTarget.SetRotation(new dVector2(this.m_previousPosition.x, this.m_previousPosition.y).ToAngle());
                }
            }
            this.m_previousPosition.SetValue(newPosX, newPosY, newPosZ);
        }
    };
    return CCMoveBy;
}(CCActionInterval));
var CCMoveTo = (function (_super) {
    __extends(CCMoveTo, _super);
    function CCMoveTo(duration, x, y, z, bSetDir, randomRangeX, randomRangeY, randomRangeZ, bMirrorWithTarget) {
        if (z === void 0) { z = 0; }
        if (bSetDir === void 0) { bSetDir = false; }
        if (randomRangeX === void 0) { randomRangeX = 0; }
        if (randomRangeY === void 0) { randomRangeY = 0; }
        if (randomRangeZ === void 0) { randomRangeZ = 0; }
        if (bMirrorWithTarget === void 0) { bMirrorWithTarget = false; }
        var _this = _super.call(this, duration, x, y, z, bSetDir, randomRangeX, randomRangeY, randomRangeZ, bMirrorWithTarget) || this;
        _this.m_pMoveToTarget = null;
        _this.m_pMoveToTargetRoot = null;
        _this.m_vMoveToTargetOffset = null;
        _this.m_endPosition = new dVector3(x, y, z);
        _this.m_randomRangeDelta = new dVector3(randomRangeX, randomRangeY, randomRangeZ);
        _this.m_bSetDir = bSetDir;
        return _this;
    }
    CCMoveTo.prototype.SetMoveToTarget = function (pMoveToTarget, vMoveToTargetOffset, root) {
        if (vMoveToTargetOffset === void 0) { vMoveToTargetOffset = null; }
        if (root === void 0) { root = null; }
        this.m_pMoveToTarget = pMoveToTarget;
        this.m_pMoveToTargetRoot = root;
        if (vMoveToTargetOffset != null)
            this.m_vMoveToTargetOffset = vMoveToTargetOffset;
        else
            this.m_vMoveToTargetOffset = new dVector3();
        return this;
    };
    CCMoveTo.prototype.GetMoveToTarget = function () {
        return this.m_pMoveToTarget;
    };
    CCMoveTo.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            var currentPosX = this.m_pTarget.GetPosX();
            var currentPosY = this.m_pTarget.GetPosY();
            var currentPosZ = this.m_pTarget.GetPosZ();
            var diffX = currentPosX - this.m_previousPosition.x;
            var diffY = currentPosY - this.m_previousPosition.y;
            var diffZ = currentPosZ - this.m_previousPosition.z;
            var newPosX = this.m_startPosition.x + this.m_positionDelta.x * time;
            var newPosY = this.m_startPosition.y + this.m_positionDelta.y * time;
            var newPosZ = this.m_startPosition.z + this.m_positionDelta.z * time;
            if (this.m_pMoveToTarget != null) {
                var x = this.m_pMoveToTarget.positionX;
                var y = this.m_pMoveToTarget.positionY;
                var z = this.m_pMoveToTarget.positionZ;
                if (this.m_pMoveToTargetRoot) {
                    var v3 = this.m_pMoveToTarget.GetPos_World3D(this.m_pMoveToTargetRoot, false);
                    x = v3.x;
                    y = v3.y;
                    z = v3.z;
                }
                newPosX = dMath.Lerp(this.m_startPosition.x, x + this.m_vMoveToTargetOffset.x, time);
                newPosY = dMath.Lerp(this.m_startPosition.y, y + this.m_vMoveToTargetOffset.y, time);
                newPosZ = dMath.Lerp(this.m_startPosition.z, z + this.m_vMoveToTargetOffset.z, time);
            }
            this.m_pTarget.SetPos3D(newPosX, newPosY, newPosZ);
            if (this.m_bSetDir) {
                if (!dMath.FloatEquals(newPosX, this.m_previousPosition.x) || !dMath.FloatEquals(newPosY, this.m_previousPosition.y) || !dMath.FloatEquals(newPosZ, this.m_previousPosition.z)) {
                    this.m_previousPosition.SetValue(newPosX - this.m_previousPosition.x, newPosY - this.m_previousPosition.y, newPosZ - this.m_previousPosition.z);
                    this.m_previousPosition.Normalize();
                    this.m_pTarget.SetRotation(new dVector2(this.m_previousPosition.x, this.m_previousPosition.y).ToAngle());
                }
            }
            this.m_previousPosition.SetValue(newPosX, newPosY, newPosZ);
        }
    };
    CCMoveTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_startPosition = new dVector3(target.GetPosX(), target.GetPosY(), target.GetPosZ());
        this.m_randomRangeDelta2.SetValue(dMath.RandomRange(-this.m_randomRangeDelta.x, this.m_randomRangeDelta.x), dMath.RandomRange(-this.m_randomRangeDelta.y, this.m_randomRangeDelta.y), dMath.RandomRange(-this.m_randomRangeDelta.z, this.m_randomRangeDelta.z));
        this.m_positionDelta = this.m_endPosition.Add(this.m_randomRangeDelta2).Sub(this.m_startPosition);
    };
    return CCMoveTo;
}(CCMoveBy));
var CCMoveToPath = (function (_super) {
    __extends(CCMoveToPath, _super);
    function CCMoveToPath(duration, pathList, setDir) {
        if (setDir === void 0) { setDir = false; }
        var _this = _super.call(this) || this;
        _this.m_pathList = null;
        _this.m_pathLength = null;
        _this.m_pathDirs = null;
        _this.m_fTotalLength = 0;
        _this.m_previousPosition = new dVector3();
        _this.m_offPosition = new dVector3();
        _this.m_startPosition = new dVector3();
        _this.m_bSetDir = false;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_pathList = pathList;
        _this.m_bSetDir = setDir;
        return _this;
    }
    CCMoveToPath.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_pathLength = new Array(this.m_pathList.length);
        this.m_pathDirs = new Array(this.m_pathList.length);
        this.m_fTotalLength = 0;
        for (var i = 0, n = this.m_pathLength.length; i < n; i++) {
            var dir;
            if (i == 0)
                dir = this.m_pathList[i].Sub(target.GetPosVector3());
            else {
                dir = this.m_pathList[i].Sub(this.m_pathList[i - 1]);
            }
            var length = dir.Length();
            this.m_pathLength[i] = length;
            this.m_fTotalLength += length;
            dir.Normalize();
            this.m_pathDirs[i] = dir;
        }
        this.m_offPosition.SetValue();
        this.m_startPosition = new dVector3(target.GetPosX(), target.GetPosY(), target.GetPosZ());
        this.m_previousPosition = new dVector3(target.GetPosX(), target.GetPosY(), target.GetPosZ());
    };
    CCMoveToPath.prototype.Update = function (time) {
        if (this.m_pTarget != null && this.m_fTotalLength != 0) {
            var currentPosX = this.m_pTarget.GetPosX();
            var currentPosY = this.m_pTarget.GetPosY();
            var currentPosZ = this.m_pTarget.GetPosZ();
            var diffX = currentPosX - this.m_previousPosition.x;
            var diffY = currentPosY - this.m_previousPosition.y;
            var diffZ = currentPosZ - this.m_previousPosition.z;
            this.m_offPosition.x += diffX;
            this.m_offPosition.y += diffY;
            this.m_offPosition.z += diffZ;
            var newPosX = 0;
            var newPosY = 0;
            var newPosZ = 0;
            if (time == 0) {
                newPosX = this.m_startPosition.x;
                newPosY = this.m_startPosition.y;
                newPosZ = this.m_startPosition.z;
            }
            else if (time == 1) {
                var v = this.m_pathList.last();
                newPosX = v.x;
                newPosY = v.y;
                newPosZ = v.z;
            }
            else {
                var curLength = time * this.m_fTotalLength;
                var i = 0;
                for (; i < this.m_pathLength.length; i++) {
                    if (curLength < this.m_pathLength[i])
                        break;
                    curLength -= this.m_pathLength[i];
                }
                var v;
                if (i == 0)
                    v = this.m_startPosition;
                else
                    v = this.m_pathList[i - 1];
                var dir = this.m_pathDirs[i];
                newPosX = v.x + dir.x * curLength;
                newPosY = v.y + dir.y * curLength;
                newPosZ = v.z + dir.z * curLength;
            }
            newPosX += this.m_offPosition.x;
            newPosY += this.m_offPosition.y;
            newPosZ += this.m_offPosition.z;
            this.m_pTarget.SetPos3D(newPosX, newPosY, newPosZ);
            if (this.m_bSetDir) {
                if (!dMath.FloatEquals(newPosX, this.m_previousPosition.x) || !dMath.FloatEquals(newPosY, this.m_previousPosition.y) || !dMath.FloatEquals(newPosZ, this.m_previousPosition.z)) {
                    this.m_previousPosition.SetValue(newPosX - this.m_previousPosition.x, newPosY - this.m_previousPosition.y, newPosZ - this.m_previousPosition.z);
                    this.m_previousPosition.Normalize();
                    this.m_pTarget.SetRotation(new dVector2(this.m_previousPosition.x, this.m_previousPosition.y).ToAngle());
                }
            }
            this.m_previousPosition.SetValue(newPosX, newPosY, newPosZ);
        }
    };
    return CCMoveToPath;
}(CCActionInterval));
var CCOpacity = (function (_super) {
    __extends(CCOpacity, _super);
    function CCOpacity(opacity) {
        var _this = _super.call(this) || this;
        _this.m_fOpacity = opacity;
        return _this;
    }
    CCOpacity.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        target.SetAlpha(this.m_fOpacity);
    };
    return CCOpacity;
}(CCActionInstant));
var CCParallel = (function (_super) {
    __extends(CCParallel, _super);
    function CCParallel(actions) {
        var _this = _super.call(this) || this;
        _this.m_pActions = null;
        if (actions != null) {
            _this.m_pActions = actions;
            var duration = 0;
            for (var i = 0; i < _this.m_pActions.length; i++) {
                var actionDuration = _this.m_pActions[i].Duration;
                if (duration < actionDuration) {
                    duration = actionDuration;
                }
            }
            for (var i = 0; i < _this.m_pActions.length; i++) {
                var actionDuration = _this.m_pActions[i].Duration;
                if (actionDuration < duration) {
                    _this.m_pActions[i] = new CCSequence([_this.m_pActions[i], new CCDelayTime(duration - actionDuration)]);
                }
            }
            _super.prototype.InitWithDuration.call(_this, duration);
        }
        return _this;
    }
    CCParallel.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        for (var i = 0; i < this.m_pActions.length; i++) {
            this.m_pActions[i].StartWithTarget(target);
        }
    };
    CCParallel.prototype.Stop = function () {
        for (var i = 0; i < this.m_pActions.length; i++) {
            this.m_pActions[i].Stop();
        }
        _super.prototype.Stop.call(this);
    };
    CCParallel.prototype.Update = function (time) {
        for (var i = 0; i < this.m_pActions.length; i++) {
            this.m_pActions[i].Update(time);
        }
    };
    return CCParallel;
}(CCActionInterval));
var CCPlace = (function (_super) {
    __extends(CCPlace, _super);
    function CCPlace(pos) {
        var _this = _super.call(this) || this;
        _this.m_tPosition = pos;
        return _this;
    }
    CCPlace.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_pTarget.SetPos3D(this.m_tPosition.x, this.m_tPosition.y, this.m_tPosition.z);
    };
    return CCPlace;
}(CCActionInstant));
var CCPlaySound = (function (_super) {
    __extends(CCPlaySound, _super);
    function CCPlaySound(strSoundFileName, volume, loop, bWav, bPlayNextFrame) {
        if (volume === void 0) { volume = 1; }
        if (loop === void 0) { loop = false; }
        if (bWav === void 0) { bWav = true; }
        if (bPlayNextFrame === void 0) { bPlayNextFrame = false; }
        var _this = _super.call(this) || this;
        _this.m_strSoundFileName = strSoundFileName;
        _this.m_fVolume = volume;
        _this.m_bWav = bWav;
        _this.m_nLoop = loop;
        _this.m_bPlayNextFrame = bPlayNextFrame;
        return _this;
    }
    CCPlaySound.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        if (this.m_strSoundFileName) {
            if (this.m_bWav)
                dSound.PlaySound(this.m_strSoundFileName);
            else
                dSound.PlayMusic(this.m_strSoundFileName, this.m_nLoop, 0, this.m_fVolume);
        }
    };
    return CCPlaySound;
}(CCActionInstant));
var CCRandomChoice = (function (_super) {
    __extends(CCRandomChoice, _super);
    function CCRandomChoice(actions) {
        var _this = _super.call(this) || this;
        _this.m_pActions = actions;
        _this.m_nChoice = -1;
        if (_this.m_pActions.length == 0)
            return _this;
        _this.m_nChoice = dMath.RandomI() % _this.m_pActions.length;
        _super.prototype.InitWithDuration.call(_this, _this.m_pActions[_this.m_nChoice].Duration);
        return _this;
    }
    CCRandomChoice.prototype.Clear = function () {
        _super.prototype.Clear.call(this);
    };
    CCRandomChoice.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        if (this.m_nChoice != -1)
            this.m_pActions[this.m_nChoice].StartWithTarget(target);
    };
    CCRandomChoice.prototype.Stop = function () {
        if (this.m_nChoice != -1) {
            this.m_pActions[this.m_nChoice].Stop();
        }
        _super.prototype.Stop.call(this);
    };
    CCRandomChoice.prototype.Step = function (dt) {
        if (this.m_nChoice > -1 && (this.m_pActions[this.m_nChoice] instanceof CCRepeatForever)) {
            this.m_pActions[this.m_nChoice].Step(dt);
        }
        else {
            _super.prototype.Step.call(this, dt);
        }
    };
    CCRandomChoice.prototype.Update = function (t) {
        this.m_pActions[this.m_nChoice].Update(t);
    };
    CCRandomChoice.prototype.GetActionList = function (outData) {
        _super.prototype.GetActionList.call(this, outData);
        for (var i = 0; i < this.m_pActions.length; i++)
            outData.push(this.m_pActions[i]);
    };
    return CCRandomChoice;
}(CCActionInterval));
var CCRemoveSelf = (function (_super) {
    __extends(CCRemoveSelf, _super);
    function CCRemoveSelf() {
        return _super.call(this) || this;
    }
    CCRemoveSelf.prototype.Update = function (time) {
        this.m_pTarget.Destroy();
        this.m_pTarget.RemoveParent();
    };
    return CCRemoveSelf;
}(CCActionInstant));
var CCRemoveTarget = (function (_super) {
    __extends(CCRemoveTarget, _super);
    function CCRemoveTarget(pTarget) {
        var _this = _super.call(this) || this;
        _this.m_pRemoveTarget = pTarget;
        return _this;
    }
    CCRemoveTarget.prototype.Update = function (time) {
        this.m_pRemoveTarget.Destroy();
        this.m_pRemoveTarget.RemoveParent();
    };
    return CCRemoveTarget;
}(CCActionInstant));
var CCRepeat = (function (_super) {
    __extends(CCRepeat, _super);
    function CCRepeat(action, times) {
        var _this = _super.call(this) || this;
        _this.m_bActionInstant = false;
        _this.m_fNextDt = 0;
        _this.m_pInnerAction = null;
        _this.m_uTimes = 0;
        _this.m_uTotal = 0;
        var d = action.Duration * times;
        _super.prototype.InitWithDuration.call(_this, d);
        _this.m_uTimes = times;
        _this.m_pInnerAction = action;
        _this.m_bActionInstant = action instanceof CCActionInstant;
        if (_this.m_bActionInstant) {
            _this.m_uTimes -= 1;
        }
        _this.m_uTotal = 0;
        return _this;
    }
    Object.defineProperty(CCRepeat.prototype, "InnerAction", {
        get: function () {
            return this.m_pInnerAction;
        },
        set: function (value) {
            this.m_pInnerAction = value;
        },
        enumerable: false,
        configurable: true
    });
    CCRepeat.prototype.StartWithTarget = function (target) {
        this.m_uTotal = 0;
        this.m_fNextDt = this.m_pInnerAction.Duration / this.m_fDuration;
        _super.prototype.StartWithTarget.call(this, target);
        this.m_pInnerAction.StartWithTarget(target);
    };
    CCRepeat.prototype.Stop = function () {
        this.m_pInnerAction.Stop();
        _super.prototype.Stop.call(this);
    };
    CCRepeat.prototype.Update = function (dt) {
        if (dt >= this.m_fNextDt) {
            while (dt >= this.m_fNextDt && this.m_uTotal < this.m_uTimes) {
                this.m_pInnerAction.Update(1.0);
                this.m_uTotal++;
                if (this.m_pInnerAction instanceof CCRepeatForever)
                    break;
                this.m_pInnerAction.Stop();
                this.m_pInnerAction.StartWithTarget(this.m_pTarget);
                this.m_fNextDt += this.m_pInnerAction.Duration / this.m_fDuration;
            }
            if (dt >= 1.0 && this.m_uTotal < this.m_uTimes) {
                this.m_uTotal++;
            }
            if (!this.m_bActionInstant) {
                if (this.m_uTotal == this.m_uTimes) {
                    this.m_pInnerAction.Update(1);
                    this.m_pInnerAction.Stop();
                }
                else {
                    var time = dt - (this.m_fNextDt - this.m_pInnerAction.Duration / this.m_fDuration);
                    this.m_pInnerAction.Update(time);
                }
            }
        }
        else {
            var time = (dt * this.m_uTimes) % 1.0;
            this.m_pInnerAction.Update(time);
        }
    };
    CCRepeat.prototype.IsDone = function () {
        return this.m_uTotal == this.m_uTimes;
    };
    CCRepeat.prototype.GetActionList = function (outData) {
        _super.prototype.GetActionList.call(this, outData);
        outData.push(this.m_pInnerAction);
    };
    return CCRepeat;
}(CCActionInterval));
var CCRepeatForever = (function (_super) {
    __extends(CCRepeatForever, _super);
    function CCRepeatForever(action) {
        return _super.call(this, action, dMath.dINT_MAX) || this;
    }
    return CCRepeatForever;
}(CCRepeat));
var CCReverseTime = (function (_super) {
    __extends(CCReverseTime, _super);
    function CCReverseTime(action) {
        var _this = _super.call(this) || this;
        _this.InitWithDuration(action.Duration);
        _this.m_pOther = action;
        return _this;
    }
    CCReverseTime.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_pOther.StartWithTarget(target);
    };
    CCReverseTime.prototype.Stop = function () {
        this.m_pOther.Stop();
        _super.prototype.Stop.call(this);
    };
    CCReverseTime.prototype.Update = function (time) {
        if (this.m_pOther != null) {
            this.m_pOther.Update(1 - time);
        }
    };
    return CCReverseTime;
}(CCActionInterval));
var CCRotateBy = (function (_super) {
    __extends(CCRotateBy, _super);
    function CCRotateBy(duration, fDeltaAngle, axis) {
        if (axis === void 0) { axis = null; }
        var _this = _super.call(this) || this;
        _this.m_fAngleX = 0;
        _this.m_fAngleY = 0;
        _this.m_fStartAngleX = 0;
        _this.m_fStartAngleY = 0;
        _this.m_axis = null;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_fAngleX = _this.m_fAngleY = fDeltaAngle;
        _this.m_axis = axis;
        return _this;
    }
    CCRotateBy.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_fStartAngleX = target.GetRotation();
        this.m_fStartAngleY = target.GetRotation();
    };
    CCRotateBy.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            if (this.m_axis != null) {
                var mat = new dMatrix();
                mat.RotationAxis(dMath.AngleToRadian(this.m_fStartAngleX + this.m_fAngleX * time), this.m_axis);
                this.m_pTarget.SetRotationMatrix(mat);
            }
            else
                this.m_pTarget.SetRotation(this.m_fStartAngleX + this.m_fAngleX * time);
        }
    };
    return CCRotateBy;
}(CCActionInterval));
var CCRotateTo = (function (_super) {
    __extends(CCRotateTo, _super);
    function CCRotateTo(duration, fDeltaAngle, axis) {
        if (axis === void 0) { axis = null; }
        var _this = _super.call(this) || this;
        _this.m_fDiffAngleY = 0;
        _this.m_fDiffAngleX = 0;
        _this.m_fDstAngleX = 0;
        _this.m_fDstAngleY = 0;
        _this.m_fStartAngleX = 0;
        _this.m_fStartAngleY = 0;
        _this.m_axis = null;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_fDstAngleX = _this.m_fDstAngleY = fDeltaAngle;
        _this.m_axis = axis;
        return _this;
    }
    CCRotateTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_fStartAngleX = this.m_pTarget.GetRotation();
        this.m_fDiffAngleX = this.m_fDstAngleX - this.m_fStartAngleX;
        if (this.m_fDiffAngleX > 180) {
            this.m_fDiffAngleX -= 360;
        }
        if (this.m_fDiffAngleX < -180) {
            this.m_fDiffAngleX += 360;
        }
        this.m_fStartAngleY = this.m_pTarget.GetRotation();
        this.m_fDiffAngleY = this.m_fDstAngleY - this.m_fStartAngleY;
        if (this.m_fDiffAngleY > 180) {
            this.m_fDiffAngleY -= 360;
        }
        if (this.m_fDiffAngleY < -180) {
            this.m_fDiffAngleY += 360;
        }
    };
    CCRotateTo.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            if (this.m_axis != null) {
                var mat = new dMatrix();
                mat.RotationAxis(dMath.AngleToRadian((this.m_fStartAngleX + this.m_fDiffAngleX * time)), this.m_axis);
                this.m_pTarget.SetRotationMatrix(mat);
            }
            else
                this.m_pTarget.SetRotation((this.m_fStartAngleX + this.m_fDiffAngleX * time));
        }
    };
    return CCRotateTo;
}(CCActionInterval));
var CCScaleTo = (function (_super) {
    __extends(CCScaleTo, _super);
    function CCScaleTo(duration, sx, sy, sz) {
        if (sz === void 0) { sz = 1; }
        var _this = _super.call(this) || this;
        _this.m_fDeltaX = 0;
        _this.m_fDeltaY = 0;
        _this.m_fDeltaZ = 0;
        _this.m_fEndScaleX = 0;
        _this.m_fEndScaleY = 0;
        _this.m_fEndScaleZ = 0;
        _this.m_fScaleX = 0;
        _this.m_fScaleY = 0;
        _this.m_fScaleZ = 0;
        _this.m_fStartScaleX = 0;
        _this.m_fStartScaleY = 0;
        _this.m_fStartScaleZ = 0;
        _this.InitWithDuration(duration);
        _this.m_fEndScaleX = sx;
        _this.m_fEndScaleY = sy;
        _this.m_fEndScaleZ = sz;
        return _this;
    }
    CCScaleTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_fStartScaleX = target.GetScaleX();
        this.m_fStartScaleY = target.GetScaleY();
        this.m_fStartScaleZ = target.GetScaleZ();
        this.m_fDeltaX = this.m_fEndScaleX - this.m_fStartScaleX;
        this.m_fDeltaY = this.m_fEndScaleY - this.m_fStartScaleY;
        this.m_fDeltaZ = this.m_fEndScaleZ - this.m_fStartScaleZ;
    };
    CCScaleTo.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            this.m_pTarget.SetScale3D(this.m_fStartScaleX + this.m_fDeltaX * time, this.m_fStartScaleY + this.m_fDeltaY * time, this.m_fStartScaleZ + this.m_fDeltaZ * time);
        }
    };
    return CCScaleTo;
}(CCActionInterval));
var CCScaleBy = (function (_super) {
    __extends(CCScaleBy, _super);
    function CCScaleBy(duration, sx, sy, sz) {
        if (sz === void 0) { sz = 1; }
        return _super.call(this, duration, sx, sy, sz) || this;
    }
    CCScaleBy.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_fDeltaX = this.m_fStartScaleX * this.m_fEndScaleX - this.m_fStartScaleX;
        this.m_fDeltaY = this.m_fStartScaleY * this.m_fEndScaleY - this.m_fStartScaleY;
        this.m_fDeltaZ = this.m_fStartScaleZ * this.m_fEndScaleZ - this.m_fStartScaleZ;
    };
    return CCScaleBy;
}(CCScaleTo));
var CCSequence = (function (_super) {
    __extends(CCSequence, _super);
    function CCSequence(actions) {
        var _this = _super.call(this) || this;
        _this.m_last = 0;
        _this.m_pActions = new Array(2);
        _this.m_split = 0;
        _this._HasInfiniteAction = false;
        if (actions.length > 0) {
            var prev = actions[0];
            if (actions.length == 1) {
                _this.InitOneTwo(prev, new CCExtraAction());
            }
            else {
                for (var i = 1; i < actions.length - 1; i++) {
                    prev = new CCSequence([prev, actions[i]]);
                }
                _this.InitOneTwo(prev, actions[actions.length - 1]);
            }
        }
        return _this;
    }
    CCSequence.prototype.InitOneTwo = function (actionOne, actionTwo) {
        var d = actionOne.Duration + actionTwo.Duration;
        _super.prototype.InitWithDuration.call(this, d);
        this.m_pActions[0] = actionOne;
        this.m_pActions[1] = actionTwo;
        this._HasInfiniteAction = (actionOne instanceof CCRepeatForever) || (actionTwo instanceof CCRepeatForever);
        return true;
    };
    CCSequence.prototype.IsDone = function () {
        if (this._HasInfiniteAction && this.m_pActions[this.m_last] instanceof CCRepeatForever) {
            return false;
        }
        return _super.prototype.IsDone.call(this);
    };
    CCSequence.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_split = this.m_pActions[0].Duration / this.m_fDuration;
        this.m_last = -1;
    };
    CCSequence.prototype.Stop = function () {
        if (this.m_last != -1) {
            this.m_pActions[this.m_last].Stop();
        }
        _super.prototype.Stop.call(this);
    };
    CCSequence.prototype.Step = function (dt) {
        if (this.m_last > -1 && (this.m_pActions[this.m_last] instanceof CCRepeatForever)) {
            this.m_pActions[this.m_last].Step(dt);
        }
        else {
            _super.prototype.Step.call(this, dt);
        }
    };
    CCSequence.prototype.Update = function (t) {
        var bRestart = false;
        var found;
        var new_t;
        if (t < this.m_split) {
            found = 0;
            if (this.m_split != 0)
                new_t = t / this.m_split;
            else
                new_t = 1;
        }
        else {
            found = 1;
            if (this.m_split == 1)
                new_t = 1;
            else
                new_t = (t - this.m_split) / (1 - this.m_split);
        }
        if (found == 1) {
            if (this.m_last == -1) {
                this.m_pActions[0].StartWithTarget(this.m_pTarget);
                this.m_pActions[0].Update(1.0);
                this.m_pActions[0].Stop();
            }
            else if (this.m_last == 0) {
                this.m_pActions[0].Update(1.0);
                this.m_pActions[0].Stop();
            }
        }
        else if (found == 0 && this.m_last == 1) {
            this.m_pActions[1].Update(0);
            this.m_pActions[1].Stop();
        }
        if (found == this.m_last && this.m_pActions[found].IsDone()) {
            return;
        }
        if (found != this.m_last || bRestart) {
            this.m_pActions[found].StartWithTarget(this.m_pTarget);
        }
        this.m_pActions[found].Update(new_t);
        this.m_last = found;
    };
    CCSequence.prototype.GetActionList = function (outData) {
        _super.prototype.GetActionList.call(this, outData);
        for (var i = 0; i < this.m_pActions.length; i++)
            outData.push(this.m_pActions[i]);
    };
    return CCSequence;
}(CCActionInterval));
var CCShake = (function (_super) {
    __extends(CCShake, _super);
    function CCShake(duration, maxRadius, minRadius) {
        var _this = _super.call(this) || this;
        _this.m_maxRadius = 0;
        _this.m_minRadius = 0;
        _this.m_endMaxRadius = 0;
        _this.m_endMinRadius = 0;
        _this.m_fLastMoveOffsetX = 0;
        _this.m_fLastMoveOffsetY = 0;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_maxRadius = maxRadius;
        _this.m_minRadius = minRadius;
        _this.m_endMaxRadius = maxRadius;
        _this.m_endMinRadius = minRadius;
        return _this;
    }
    CCShake.prototype.Update = function (t) {
        this.m_pTarget.SetPos(this.m_pTarget.GetPosX() - this.m_fLastMoveOffsetX, this.m_pTarget.GetPosY() - this.m_fLastMoveOffsetY);
        if (t >= 1) {
            this.m_fLastMoveOffsetX = 0;
            this.m_fLastMoveOffsetY = 0;
        }
        else {
            var radian = dMath.Random() * dMath.dPI * 2;
            var maxR = this.m_maxRadius + (this.m_endMinRadius - this.m_maxRadius) * t;
            var minR = this.m_minRadius + (this.m_endMinRadius - this.m_minRadius) * t;
            var r = dMath.Random() * (maxR - minR) + minR;
            var x = dMath.Cos(radian) * r;
            var y = dMath.Sin(radian) * r;
            this.m_pTarget.SetPos(this.m_pTarget.GetPosX() + x, this.m_pTarget.GetPosY() + y);
            this.m_fLastMoveOffsetX = x;
            this.m_fLastMoveOffsetY = y;
        }
    };
    CCShake.prototype.StartWithTarget = function (pTarget) {
        _super.prototype.StartWithTarget.call(this, pTarget);
        this.m_fLastMoveOffsetX = 0;
        this.m_fLastMoveOffsetY = 0;
    };
    return CCShake;
}(CCActionInterval));
var CCShakeRect = (function (_super) {
    __extends(CCShakeRect, _super);
    function CCShakeRect(duration, rc) {
        var _this = _super.call(this) || this;
        _this.m_rcRect = null;
        _this.m_fLastMoveOffsetX = 0;
        _this.m_fLastMoveOffsetY = 0;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_rcRect = rc;
        return _this;
    }
    CCShakeRect.prototype.Update = function (t) {
        this.m_pTarget.SetPos(this.m_pTarget.GetPosX() - this.m_fLastMoveOffsetX, this.m_pTarget.GetPosY() - this.m_fLastMoveOffsetY);
        if (t >= 1) {
            this.m_fLastMoveOffsetX = 0;
            this.m_fLastMoveOffsetY = 0;
        }
        else {
            var x = dMath.RandomRange(this.m_rcRect.left, this.m_rcRect.right);
            var y = dMath.RandomRange(this.m_rcRect.top, this.m_rcRect.bottom);
            this.m_pTarget.SetPos(this.m_pTarget.GetPosX() + x, this.m_pTarget.GetPosY() + y);
            this.m_fLastMoveOffsetX = x;
            this.m_fLastMoveOffsetY = y;
        }
    };
    CCShakeRect.prototype.StartWithTarget = function (pTarget) {
        _super.prototype.StartWithTarget.call(this, pTarget);
        this.m_fLastMoveOffsetX = 0;
        this.m_fLastMoveOffsetY = 0;
    };
    return CCShakeRect;
}(CCActionInterval));
var CCShow = (function (_super) {
    __extends(CCShow, _super);
    function CCShow() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCShow.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        target.SetShow(true);
    };
    return CCShow;
}(CCActionInstant));
var CCSizeTo = (function (_super) {
    __extends(CCSizeTo, _super);
    function CCSizeTo(duration, sx, sy) {
        var _this = _super.call(this) || this;
        _this.m_fDeltaX = 0;
        _this.m_fDeltaY = 0;
        _this.m_fSizeX = 0;
        _this.m_fSizeY = 0;
        _this.m_fStartSizeX = 0;
        _this.m_fStartSizeY = 0;
        _this.InitWithDuration(duration);
        _this.m_fEndSizeX = sx;
        _this.m_fEndSizeY = sy;
        return _this;
    }
    CCSizeTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_fStartSizeX = target.GetWidth();
        this.m_fStartSizeY = target.GetHeight();
        this.m_fDeltaX = this.m_fEndSizeX - this.m_fStartSizeX;
        this.m_fDeltaY = this.m_fEndSizeY - this.m_fStartSizeY;
    };
    CCSizeTo.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            this.m_pTarget.SetSize(this.m_fStartSizeX + this.m_fDeltaX * time, this.m_fStartSizeY + this.m_fDeltaY * time);
        }
    };
    return CCSizeTo;
}(CCActionInterval));
var CCSizeBy = (function (_super) {
    __extends(CCSizeBy, _super);
    function CCSizeBy() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCSizeBy.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_fDeltaX = this.m_fStartSizeX * this.m_fEndSizeX - this.m_fStartSizeX;
        this.m_fDeltaY = this.m_fStartSizeY * this.m_fEndSizeY - this.m_fStartSizeY;
    };
    return CCSizeBy;
}(CCSizeTo));
var CCSpawn = (function (_super) {
    __extends(CCSpawn, _super);
    function CCSpawn(actions) {
        var _this = _super.call(this) || this;
        _this.m_pOne = null;
        _this.m_pTwo = null;
        if (actions != null) {
            var prev = actions[0];
            if (actions.length == 1) {
                _this.InitOneTwo(prev, new CCExtraAction());
            }
            else {
                for (var i = 1; i < actions.length - 1; i++) {
                    prev = new CCSpawn([prev, actions[i]]);
                }
                _this.InitOneTwo(prev, actions[actions.length - 1]);
            }
        }
        return _this;
    }
    CCSpawn.prototype.InitOneTwo = function (action1, action2) {
        var bRet = false;
        var d1 = action1.Duration;
        var d2 = action2.Duration;
        _super.prototype.InitWithDuration.call(this, dMath.Max(d1, d2));
        this.m_pOne = action1;
        this.m_pTwo = action2;
        if (d1 > d2) {
            this.m_pTwo = new CCSequence([action2, new CCDelayTime(d1 - d2)]);
        }
        else if (d1 < d2) {
            this.m_pOne = new CCSequence([action1, new CCDelayTime(d2 - d1)]);
        }
    };
    CCSpawn.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_pOne.StartWithTarget(target);
        this.m_pTwo.StartWithTarget(target);
    };
    CCSpawn.prototype.Stop = function () {
        this.m_pOne.Stop();
        this.m_pTwo.Stop();
        _super.prototype.Stop.call(this);
    };
    CCSpawn.prototype.Update = function (time) {
        if (this.m_pOne != null) {
            this.m_pOne.Update(time);
        }
        if (this.m_pTwo != null) {
            this.m_pTwo.Update(time);
        }
    };
    CCSpawn.prototype.GetActionList = function (outData) {
        _super.prototype.GetActionList.call(this, outData);
        outData.push(this.m_pOne);
        outData.push(this.m_pTwo);
    };
    return CCSpawn;
}(CCActionInterval));
var CCSpeed = (function (_super) {
    __extends(CCSpeed, _super);
    function CCSpeed(action, fRate) {
        var _this = _super.call(this) || this;
        _this.m_fSpeed = 0;
        _this.m_pInnerAction = action;
        _this.m_fSpeed = fRate;
        return _this;
    }
    Object.defineProperty(CCSpeed.prototype, "Speed", {
        get: function () {
            return this.m_fSpeed;
        },
        set: function (value) {
            this.m_fSpeed = value;
        },
        enumerable: false,
        configurable: true
    });
    CCSpeed.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_pInnerAction.StartWithTarget(target);
    };
    CCSpeed.prototype.Stop = function () {
        this.m_pInnerAction.Stop();
        _super.prototype.Stop.call(this);
    };
    CCSpeed.prototype.Step = function (dt) {
        this.m_pInnerAction.Step(dt * this.m_fSpeed);
    };
    CCSpeed.prototype.IsDone = function () {
        return this.m_pInnerAction.IsDone();
    };
    return CCSpeed;
}(CCAction));
var CCSplineMath = (function () {
    function CCSplineMath() {
    }
    CCSplineMath.CCCardinalSplineAt = function (p0, p1, p2, p3, tension, t) {
        if (tension < 0) {
            tension = 0;
        }
        if (tension > 1) {
            tension = 1;
        }
        var t2 = t * t;
        var t3 = t2 * t;
        var s = (1 - tension) / 2;
        var b1 = s * ((-t3 + (2 * t2)) - t);
        var b2 = s * (-t3 + t2) + (2 * t3 - 3 * t2 + 1);
        var b3 = s * (t3 - 2 * t2 + t) + (-2 * t3 + 3 * t2);
        var b4 = s * (t3 - t2);
        var x = (p0.x * b1 + p1.x * b2 + p2.x * b3 + p3.x * b4);
        var y = (p0.y * b1 + p1.y * b2 + p2.y * b3 + p3.y * b4);
        return new dVector2(x, y);
    };
    CCSplineMath.CubicBezier = function (a, b, c, d, t) {
        var t1 = 1 - t;
        return ((t1 * t1 * t1) * a + 3 * t * (t1 * t1) * b + 3 * (t * t) * (t1) * c + (t * t * t) * d);
    };
    CCSplineMath.QuadBezier = function (a, b, c, t) {
        var t1 = 1 - t;
        return (t1 * t1) * a + 2.0 * (t1) * t * b + (t * t) * c;
    };
    return CCSplineMath;
}());
var CCTargetedAction = (function (_super) {
    __extends(CCTargetedAction, _super);
    function CCTargetedAction(target, pAction) {
        var _this = _super.call(this) || this;
        _this.m_pForcedTarget = null;
        _super.prototype.InitWithDuration.call(_this, pAction.Duration);
        _this.m_pForcedTarget = target;
        _this.m_pAction = pAction;
        return _this;
    }
    Object.defineProperty(CCTargetedAction.prototype, "ForcedTarget", {
        get: function () {
            return this.m_pForcedTarget;
        },
        enumerable: false,
        configurable: true
    });
    CCTargetedAction.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        this.m_pAction.StartWithTarget(this.m_pForcedTarget);
    };
    CCTargetedAction.prototype.Stop = function () {
        this.m_pAction.Stop();
    };
    CCTargetedAction.prototype.Update = function (time) {
        this.m_pAction.Update(time);
    };
    return CCTargetedAction;
}(CCActionInterval));
var CCTintBy = (function (_super) {
    __extends(CCTintBy, _super);
    function CCTintBy(duration, deltaRed, deltaGreen, deltaBlue, deltaAlpha, bSetToChild, bLerp) {
        if (bLerp === void 0) { bLerp = true; }
        var _this = _super.call(this) || this;
        _this.m_deltaB = 0;
        _this.m_deltaG = 0;
        _this.m_deltaR = 0;
        _this.m_deltaA = 0;
        _this.m_fromB = 0;
        _this.m_fromG = 0;
        _this.m_fromR = 0;
        _this.m_fromA = 0;
        _this.m_bSetToChild = false;
        _this.m_bLerp = false;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_deltaR = deltaRed * 255;
        _this.m_deltaG = deltaGreen * 255;
        _this.m_deltaB = deltaBlue * 255;
        _this.m_deltaA = deltaAlpha * 255;
        _this.m_bSetToChild = bSetToChild;
        _this.m_bLerp = bLerp;
        return _this;
    }
    CCTintBy.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        if (target != null) {
            var color = target.GetColor();
            this.m_fromR = (color & 0x00FF0000) >> 16;
            this.m_fromG = (color & 0x0000FF00) >> 8;
            this.m_fromB = color & 0x000000FF;
            this.m_fromA = (color & 0xFF000000) >>> 24;
        }
    };
    CCTintBy.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            var r, g, b, a;
            if (this.m_bLerp) {
                r = dMath.ToInt(this.m_fromR + this.m_deltaR * time);
                g = dMath.ToInt(this.m_fromG + this.m_deltaG * time);
                b = dMath.ToInt(this.m_fromB + this.m_deltaB * time);
                a = dMath.ToInt(this.m_fromA + this.m_deltaA * time);
            }
            else {
                r = this.m_deltaR;
                g = this.m_deltaG;
                b = this.m_deltaB;
                a = this.m_deltaA;
            }
            this.m_pTarget.SetColor(a << 24 | r << 16 | g << 8 | b, this.m_bSetToChild);
        }
    };
    return CCTintBy;
}(CCActionInterval));
var CCTintTo = (function (_super) {
    __extends(CCTintTo, _super);
    function CCTintTo(duration, red, green, blue, alpha, bSetToChild, bLerp) {
        if (bLerp === void 0) { bLerp = true; }
        var _this = _super.call(this) || this;
        _this.m_fromR = 0;
        _this.m_fromG = 0;
        _this.m_fromB = 0;
        _this.m_fromA = 0;
        _this.m_toR = 0;
        _this.m_toG = 0;
        _this.m_toB = 0;
        _this.m_toA = 0;
        _this.m_bSetToChild = false;
        _this.m_bLerp = false;
        _super.prototype.InitWithDuration.call(_this, duration);
        _this.m_toR = red * 255;
        _this.m_toG = green * 255;
        _this.m_toB = blue * 255;
        _this.m_toA = alpha * 255;
        _this.m_bSetToChild = bSetToChild;
        _this.m_bLerp = bLerp;
        return _this;
    }
    CCTintTo.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        if (this.m_pTarget != null) {
            var color = this.m_pTarget.GetColor();
            this.m_fromR = (color & 0x00FF0000) >> 16;
            this.m_fromG = (color & 0x0000FF00) >> 8;
            this.m_fromB = color & 0x000000FF;
            this.m_fromA = (color & 0xFF000000) >>> 24;
        }
    };
    CCTintTo.prototype.Update = function (time) {
        if (this.m_pTarget != null) {
            var r, g, b, a;
            if (this.m_bLerp) {
                r = dMath.ToInt(this.m_fromR + (this.m_toR - this.m_fromR) * time);
                g = dMath.ToInt(this.m_fromG + (this.m_toG - this.m_fromG) * time);
                b = dMath.ToInt(this.m_fromB + (this.m_toB - this.m_fromB) * time);
                a = dMath.ToInt(this.m_fromA + (this.m_toA - this.m_fromA) * time);
            }
            else {
                r = this.m_toR;
                g = this.m_toG;
                b = this.m_toB;
                a = this.m_toA;
            }
            this.m_pTarget.SetColor(a << 24 | r << 16 | g << 8 | b, this.m_bSetToChild);
        }
    };
    return CCTintTo;
}(CCActionInterval));
var CCToggleVisibility = (function (_super) {
    __extends(CCToggleVisibility, _super);
    function CCToggleVisibility() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CCToggleVisibility.prototype.StartWithTarget = function (target) {
        _super.prototype.StartWithTarget.call(this, target);
        target.SetShow(!target.isShow());
    };
    return CCToggleVisibility;
}(CCActionInstant));
var MoreGamePanel = (function (_super) {
    __extends(MoreGamePanel, _super);
    function MoreGamePanel(moreGame2) {
        var _this = _super.call(this) || this;
        dControlLoader.CreateUIByJson(_this, _this._dscData());
        var moreGame = new Array();
        moreGame.copy(moreGame2);
        for (var j = 0; j < moreGame.length; j += 4) {
            if (moreGame[j] == dInterface.ptr.GetPackageAppId()) {
                for (var i = 0; i < 4; i++)
                    moreGame.erase(j);
            }
        }
        var rates = new Array();
        for (var j = 0; j < moreGame.length; j += 4) {
            rates.push(Number(" " + moreGame[j + 3]));
        }
        if (moreGame.length > 9 * 4) {
            var ids = new Array();
            for (var i = 0; i < 9; i++) {
                var rnd = dMath.RandomWeight(rates);
                if (ids.indexOf(rnd) != -1) {
                    i--;
                    continue;
                }
                ids.push(rnd);
            }
            ids.sort(function (a, b) {
                return a - b;
            });
            var moreGame3 = new Array();
            moreGame3.copy(moreGame);
            moreGame.clear();
            for (var i = 0; i < ids.length; i++) {
                for (var j = 0; j < 4; j++)
                    moreGame.push(moreGame3[ids[i] * 4 + j]);
            }
        }
        _this.SetHandleMouse(true);
        _this.Panel_CloseButton.SetEvent(new dEvent().SetOnButtonDown(function () {
            _this.RemoveParent();
        }));
        var icons = [_this.Panel_GameIcon1, _this.Panel_GameIcon2, _this.Panel_GameIcon3,
            _this.Panel_GameIcon4, _this.Panel_GameIcon5, _this.Panel_GameIcon6,
            _this.Panel_GameIcon7, _this.Panel_GameIcon8, _this.Panel_GameIcon9];
        _this.Panel.LoadFromFile("data/common/commonround.png", null, false);
        _this.Panel.SetHandleMouse(true);
        for (var i = 0; i < moreGame.length / 4; i++) {
            var appId = moreGame[i * 4];
            var iconPath = moreGame[i * 4 + 1];
            var appName = moreGame[i * 4 + 2];
            icons[i].FindChild("Image").LoadFromFile(iconPath, null, false);
            icons[i].FindChild("Image1").LoadFromFile("data/common/commonroundmask.png", null, false);
            icons[i].FindChild("Text").SetText(appName);
            var fun = function (appId, appName) {
                icons[i].SetEvent(new dEvent().SetOnButtonDown(function () {
                    dInterface.ptr.OpenMiniProgram(appId);
                    var url = MyAd.s_httpUrl + "/" + "@uploadsave4?" + MyAd.commonUrlParam() + "&type=Box" + "&placement=" + appName;
                    dSocket.RequestHttp(url);
                }));
            };
            fun(appId, appName);
        }
        for (var i = moreGame.length / 4; i < icons.length; i++)
            icons[i].visible = false;
        new dTimer(_this).Create(0, 0, function () {
            _this.LayoutToSize(dThread.GetWindowWidth(), dThread.GetWindowHeight());
        }).Apply();
        return _this;
    }
    MoreGamePanel.prototype._dscData = function () { return { "_child": [{ "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Title", "classType": "dLabel", "fontSize": 42, "height": 42, "spriteColor": -16777216, "text": "", "width": 258, "x": 0, "y": -398 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "dImage1", "classType": "dImage", "height": 10, "pureColor": 1, "rotation": -45, "spriteColor": -10461088, "width": 60, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "dImage2", "classType": "dImage", "height": 10, "pureColor": 1, "rotation": 45, "spriteColor": -10461088, "width": 60, "x": 0, "y": 0 }], "anchorU": 0.5, "anchorV": 0.5, "className": "CloseButton", "classType": "dButton", "height": 100, "resourceFileName": "", "width": 100, "x": 337.511108, "y": -404.495056, "z": -6.258518 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 153, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -16777216, "text": "", "width": 132, "x": 0, "y": 96 }], "anchorU": 0.5, "anchorV": 0.5, "className": "GameIcon1", "classType": "dButton", "height": 154, "resourceFileName": "", "width": 154, "x": -240, "y": -223 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -16777216, "text": "", "width": 132, "x": 0, "y": 96 }], "anchorU": 0.5, "anchorV": 0.5, "className": "GameIcon2", "classType": "dButton", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": -223 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -16777216, "text": "", "width": 132, "x": 0, "y": 96 }], "anchorU": 0.5, "anchorV": 0.5, "className": "GameIcon3", "classType": "dButton", "height": 154, "resourceFileName": "", "width": 154, "x": 240, "y": -223 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -16777216, "text": "", "width": 132, "x": 0, "y": 96 }], "anchorU": 0.5, "anchorV": 0.5, "className": "GameIcon4", "classType": "dButton", "height": 154, "resourceFileName": "", "width": 154, "x": -240, "y": 24 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -16777216, "text": "", "width": 132, "x": 0, "y": 96 }], "anchorU": 0.5, "anchorV": 0.5, "className": "GameIcon5", "classType": "dButton", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 24 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -16777216, "text": "", "width": 132, "x": 0, "y": 96 }], "anchorU": 0.5, "anchorV": 0.5, "className": "GameIcon6", "classType": "dButton", "height": 154, "resourceFileName": "", "width": 154, "x": 240, "y": 24 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -16777216, "text": "", "width": 132, "x": 0, "y": 96 }], "anchorU": 0.5, "anchorV": 0.5, "className": "GameIcon7", "classType": "dButton", "height": 154, "resourceFileName": "", "width": 154, "x": -240, "y": 271 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -16777216, "text": "", "width": 132, "x": 0, "y": 96 }], "anchorU": 0.5, "anchorV": 0.5, "className": "GameIcon8", "classType": "dButton", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 271 }, { "_child": [{ "anchorU": 0.5, "anchorV": 0.5, "className": "Image", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Image1", "classType": "dImage", "height": 154, "resourceFileName": "", "width": 154, "x": 0, "y": 0 }, { "anchorU": 0.5, "anchorV": 0.5, "className": "Text", "classType": "dLabel", "fontSize": 32, "height": 32, "spriteColor": -16777216, "text": "", "width": 132, "x": 0, "y": 96 }], "anchorU": 0.5, "anchorV": 0.5, "className": "GameIcon9", "classType": "dButton", "height": 154, "resourceFileName": "", "width": 154, "x": 240, "y": 271 }], "anchorU": 0.5, "anchorV": 0.5, "className": "Panel", "classType": "dScale9", "height": 960, "resourceFileName": "", "width": 800, "x": 540, "y": 937.5 }], "anchorU": 0, "anchorV": 0, "className": "MessageBoxPanel", "classType": "dImage", "height": 1920, "layoutAlignH": 5, "layoutAlignV": 5, "pureColor": 1, "spriteColor": 1124073472, "width": 1080, "x": 0, "y": 0 }; };
    MoreGamePanel.prototype.OnTouchDown = function (x, y, delta) {
        this.RemoveParent();
    };
    MoreGamePanel.ShowAdMoreGame = function () {
        var moreGame = dInterface.ptr.GetMoreGameList();
        if (moreGame) {
            dThread.GetRootSprite().AddChild(new MoreGamePanel(moreGame));
        }
        else
            MyAd.ShowAdMoreGame();
    };
    return MoreGamePanel;
}(dImage));
var MyAd = (function () {
    function MyAd() {
    }
    MyAd.InitMyAd = function (appName) {
        MyAd.s_strAppName = appName;
        MyAd.SendPlayingTime(0);
        MyAd.SendAppList();
        if (dThread.GetSdkName() == "web" && dThread.GetChannelName() == "mi") {
        }
        else
            MyAd.CheckSign();
        if (dThread.GetSdkName() == "web" && dThread.GetChannelName() == "windows") {
        }
        else {
            dInterface.ptr.m_onErrCallback = function (err) {
                console.log(err.message);
                console.log(err.stack);
                MyAd.SendCrash(err.message, err.stack);
            };
        }
        var appconfigFileName = null;
        if (dThread.GetSdkName() == "web" && dThread.GetChannelName() == "ios")
            appconfigFileName = "appconfigios.json";
        else if (dThread.GetSdkName() == "wx")
            appconfigFileName = "appconfigwx.json";
        if (appconfigFileName && !dStringUtils.isNullOrEmpty(MyAd.s_httpCdn)) {
            new dTimer().Create(3000, 10, function (sender) {
                if (!dInterface.ptr.GetMoreGameList())
                    MyAd.LoadAppConfig(MyAd.s_httpCdn + "/" + appconfigFileName + "?" + dDateTime.NowTime().ToStringBuffer());
                else
                    sender.Stop();
            }).Apply();
        }
    };
    MyAd.isNeedShowPrivacyDialog = function () {
        if (dThread.GetSdkName() == "oppo" || dThread.GetSdkName() == "qq" || dThread.GetSdkName() == "mi" || dThread.GetSdkName() == "hw")
            return true;
        return false;
    };
    MyAd.isNeedShowPrivacyLink = function () {
        if (dThread.GetChannelName() == "gp" || dThread.GetChannelName() == "ios")
            return false;
        if (MyAd.isNeedShowPrivacyDialog() || dThread.GetSdkName() == "web" && dThread.GetChannelName() != "7k7kh5" || dThread.GetSdkName() == "mg")
            return true;
        return false;
    };
    MyAd.isNeedShowPrivacyAppName = function () {
        if (dThread.GetSdkName() == "mi")
            return true;
        return false;
    };
    MyAd.isNeedShowZhuZuo = function () {
        if (dThread.GetSdkName() == "mg" || dThread.GetSdkName() == "hw" || dThread.GetSdkName() == "oppo" || dThread.GetSdkName() == "ks")
            return true;
        if (dThread.GetSdkName() == "web" && dThread.GetChannelName() == "oppo")
            return true;
        return false;
    };
    MyAd.isNeedShowShiLing = function () {
        if (dThread.GetSdkName() == "web" && dThread.GetChannelName() == "7k7kh5")
            return false;
        return true;
    };
    MyAd.GetZhuZuoName = function (appName) {
        if (dThread.GetSdkName() == "web" && dThread.GetChannelName() == "oppo" || dThread.GetSdkName() == "hw" ||
            dThread.GetSdkName() == "oppo")
            return "";
        return "";
    };
    MyAd.LoadAppConfig = function (url) {
        dSocket.RequestHttp(url, function (res) {
            if (res) {
                var data = JSON.parse(res.ToStringBuffer());
                if (data.moregames) {
                    if (dThread.GetChannelName() == "ios")
                        window.moreGameList = data.moregames2;
                    else
                        window.moreGameList = data.moregames;
                }
            }
        });
    };
    MyAd.LoadAdConfig = function (url, sdkName) {
        if (dThread.GetSdkName() == sdkName) {
            dSocket.RequestHttp(url, function (res) {
                if (res) {
                    var data = JSON.parse(res.ToStringBuffer());
                    console.log(data);
                    if (data.adid_rewarded && window && data.adid_rewarded.length)
                        window.adid_rewarded = data.adid_rewarded;
                    if (data.adid_box && window && data.adid_box.length)
                        window.adid_box = data.adid_box;
                    if (data.adid_banner && window && data.adid_banner.length)
                        window.adid_banner = data.adid_banner;
                    if (data.adid_interstitial && window && data.adid_interstitial.length)
                        window.adid_interstitial = data.adid_interstitial;
                }
            });
        }
    };
    MyAd.GetBannerStepTime = function () {
        if (dThread.GetChannelName() == "mo")
            return 300000;
        if (dThread.GetChannelName() == "mi")
            return 60000;
        return 0;
    };
    MyAd.CheckSign = function () {
        var sha1 = dInterface.ptr.GetPackageSha1();
        if (!dStringUtils.isNullOrEmpty(sha1) && !dStringUtils.isNullOrEmpty(MyAd.s_httpUrl)) {
            sha1 = dStringUtils.ReplaceAll(sha1, ":", "");
            var url = MyAd.s_httpUrl + "/getSign?" + MyAd.commonUrlParam() + "&s1=" + sha1;
            dSocket.RequestHttp(url, function (res) {
                if (res) {
                    var str = res.ToStringBuffer();
                    if (str == "signerror") {
                        dInterface.ptr.ExitApp(true);
                    }
                }
            });
        }
    };
    MyAd.SendPassStage = function (stage, index) {
        if (index === void 0) { index = 1; }
        var obj = { passStage: stage, index: index };
        this.SendUserDataKeyValue(null, null, false, obj);
    };
    MyAd.SendPlayingTime = function (step) {
        if (dStringUtils.isNullOrEmpty(MyAd.s_httpUrl))
            return;
        var seconds = [0, 3, 7, 20, 30, 60, 60, 3 * 60, 4 * 60, 10 * 60];
        new dTimer().Create(1000, 0, function (sender, iTimer, fTimer) {
            if (dThread.isWindowActive())
                MyAd.m_fCurTimeAdd += fTimer;
            if (MyAd.m_fCurTimeAdd >= seconds[step]) {
                var url = MyAd.s_httpUrl + "/@playingtime?" + MyAd.commonUrlParam() + "&t=" + seconds[step];
                dSocket.RequestHttp(url);
                MyAd.m_fCurTimeAdd = 0;
                step++;
                if (step > seconds.length - 1)
                    step = seconds.length - 1;
            }
        });
    };
    MyAd.SendCrash = function (message, stack) {
        if (dStringUtils.isNullOrEmpty(MyAd.s_httpUrl))
            return;
        if (!MyAd.s_crashSended) {
            MyAd.s_crashSended = true;
            if (!message)
                message = "unknown";
            if (!stack)
                stack = "unknown";
            var url = MyAd.s_httpUrl + "/@crash?" + MyAd.commonUrlParam();
            var data = new dByteArray();
            data.WriteString(message);
            data.WriteString(stack);
            data.SetPosition(0);
            dSocket.RequestHttp(url, null, "POST", data);
        }
    };
    MyAd.SendAppList = function () {
        var appList = dInterface.ptr.GetAppList();
        if (!dStringUtils.isNullOrEmpty(appList)) {
            this.SendUserDataKeyValue("packList", appList, false);
        }
    };
    MyAd.SendUserDataKeyValue = function (key, value, isDaily, obj) {
        if (isDaily === void 0) { isDaily = true; }
        if (obj === void 0) { obj = null; }
        if (dStringUtils.isNullOrEmpty(MyAd.s_httpUrl))
            return;
        var url = MyAd.s_httpUrl + "/" + "@uploadsave5?" + MyAd.commonUrlParam() + "&daily=" + Number(isDaily);
        if (obj == null)
            obj = {};
        if (key)
            obj[key] = value;
        var arr = new dByteArray();
        arr.WriteStringEx(JSON.stringify(obj), false);
        arr.SetPosition(0);
        dSocket.RequestHttp(url, null, "POST", arr);
    };
    MyAd.commonUrlParam = function () {
        var n = MyAd.s_strAppName;
        var id = dThread.GetUserDeviceId();
        var sdkName = dThread.GetSdkName();
        var ver = dThread.GetPackageVersionCode();
        var packName = dThread.GetPackageName();
        var channelName = dThread.GetChannelName();
        return "n=" + n + "&d=" + id + "&sdk=" + channelName + "&os=" + sdkName + "&v=" + ver + "&packName=" + packName + "&chn=";
    };
    MyAd.ShowAdRewardedVideoTrace = function (name, onComplete) {
        var curTime = dTimer.GetTickCount();
        dInterface.ptr.ShowAdRewardedVideo(function () {
            var useTime = (dTimer.GetTickCount() - curTime);
            if (!dStringUtils.isNullOrEmpty(MyAd.s_httpUrl)) {
                var url = MyAd.s_httpUrl + "/" + "@uploadsave4?" + MyAd.commonUrlParam() + "&type=rewarded" + "&placement=" + name + "&useTime=" + useTime;
                dSocket.RequestHttp(url);
            }
            if (dThread.GetSdkName() == "web" && dThread.GetChannelName() == "tap") {
                if (useTime >= 500) {
                    if (onComplete)
                        onComplete();
                }
            }
            else {
                if (onComplete)
                    onComplete();
            }
        });
    };
    MyAd.ShowAdInterstitialImageTrace = function (name) {
        if (dThread.GetSdkName() == "vivo") {
            dInterface.ptr.ShowAdInterstitialImage(function () {
                if (!dStringUtils.isNullOrEmpty(MyAd.s_httpUrl)) {
                    var url = MyAd.s_httpUrl + "/" + "@uploadsave4?" + MyAd.commonUrlParam() + "&type=InterstitialImage" + "&placement=" + name;
                    dSocket.RequestHttp(url);
                }
            });
        }
    };
    MyAd.ShowAdInterstitialVideoTrace = function (name) {
        dInterface.ptr.ShowAdInterstitialVideo(function () {
        });
    };
    MyAd.isShowAdBanner = function () {
        return MyAd.m_bShowBanner;
    };
    MyAd.isAdInterstitialVideoReady = function () {
        return dInterface.ptr.isAdInterstitialVideoReady();
    };
    MyAd.isAdRewardedReady = function () {
        return dInterface.ptr.isAdRewardedReady();
    };
    MyAd.ShowAdBanner = function (bShow, flag) {
        if (flag === void 0) { flag = 0; }
        if (MyAd.isShowAdBanner() != bShow) {
            console.log("ShowBanner " + bShow);
            MyAd.m_bShowBanner = bShow;
            dInterface.ptr.ShowAdBanner(bShow, flag);
        }
    };
    MyAd.isAdRewardedShowing = function () {
        return dInterface.ptr.isAdRewardedShowing();
    };
    MyAd.GetMoreGameText = function (split) {
        if (split === void 0) { split = null; }
        var str = "";
        if (dThread.GetSdkName() == "web" && dThread.GetChannelName() == "oppo")
            str = "";
        else
            str = "";
        if (!split)
            return str;
        var ret = "";
        for (var i = 0; i < str.length; i++) {
            if (i > 0)
                ret += split;
            ret += str.charAt(i);
        }
        return ret;
    };
    MyAd.hasMoreGame = function () {
        if (dInterface.ptr.GetMoreGameList())
            return true;
        return dInterface.ptr.hasMoreGame();
    };
    MyAd.ShowAdMoreGame = function () {
        dInterface.ptr.ShowAdBox(function () {
            if (!dStringUtils.isNullOrEmpty(MyAd.s_httpUrl)) {
                var url = MyAd.s_httpUrl + "/" + "@uploadsave4?" + MyAd.commonUrlParam() + "&type=Box" + "&placement=show";
                dSocket.RequestHttp(url);
            }
        });
    };
    MyAd.ShowAdMoreGameIcon = function (icon, y, flag, onShow) {
        if (flag === void 0) { flag = 0; }
        if (onShow === void 0) { onShow = null; }
        if (MyAd.s_lastShowMoreGameIconY != y) {
            MyAd.s_lastShowMoreGameIconY = y;
            dInterface.ptr.ShowAdMoreGameIcon(icon, y, flag, function () {
                if (!dStringUtils.isNullOrEmpty(MyAd.s_httpUrl)) {
                    var url = MyAd.s_httpUrl + "/" + "@uploadsave4?" + MyAd.commonUrlParam() + "&type=Box" + "&placement=show";
                    dSocket.RequestHttp(url);
                }
            });
        }
    };
    MyAd.HideAdMoreGameIcon = function () {
        if (MyAd.s_lastShowMoreGameIconY != -1) {
            MyAd.s_lastShowMoreGameIconY = -1;
            dInterface.ptr.HideAdMoreGameIcon();
        }
    };
    MyAd.s_nLastShowFullscreenTime = -30000;
    MyAd.s_nLastShowInterTime = -150000;
    MyAd.s_strAppName = "";
    MyAd.m_fCurTimeAdd = 0;
    MyAd.s_httpUrl = "";
    MyAd.s_httpCdn = "";
    MyAd.m_bShowBanner = false;
    MyAd.UnlockAllStage = false;
    MyAd.yinSiUrl = "privacy.html";
    MyAd.yongHuUrl = "yonghu.html";
    MyAd.s_crashSended = false;
    MyAd.s_lastShowMoreGameIconY = -1;
    return MyAd;
}());
var MyShareRecording = (function () {
    function MyShareRecording() {
        this.m_bRecording = false;
        this.m_nRecordingStartTime = 0;
        this.m_endRecordTimer = null;
    }
    MyShareRecording.Instance = function () {
        if (MyShareRecording.s_pInstance == null)
            MyShareRecording.s_pInstance = new MyShareRecording();
        return MyShareRecording.s_pInstance;
    };
    MyShareRecording.prototype.StartRecord = function () {
        if (this.m_bRecording)
            return;
        if (dThread.GetSdkName() == "tt" || dThread.GetSdkName() == "ks") {
            this.m_bRecording = dInterface.ptr.StartShareRecord();
            this.m_nRecordingStartTime = dTimer.GetTickCount();
            if (this.m_endRecordTimer) {
                this.m_endRecordTimer.Stop();
                this.m_endRecordTimer = null;
            }
        }
    };
    MyShareRecording.prototype.StopRecord = function (onComplete) {
        if (onComplete === void 0) { onComplete = null; }
        if (this.m_bRecording) {
            this.m_bRecording = false;
            dInterface.ptr.StopShareRecord(onComplete);
        }
        if (this.m_endRecordTimer) {
            this.m_endRecordTimer.Stop();
            this.m_endRecordTimer = null;
        }
    };
    MyShareRecording.prototype.isRecording = function () {
        return this.m_bRecording;
    };
    MyShareRecording.prototype.EndRecord = function (ShareButton) {
        ShareButton.visible = this.m_bRecording;
        if (this.m_bRecording) {
            this.StopRecord();
        }
        ShareButton.SetEvent(new dEvent().SetOnButtonUp(function () {
            dSound.PlaySound("data/sound/button.mp3");
            dInterface.ptr.ShareRecord();
        }));
    };
    MyShareRecording.s_pInstance = null;
    return MyShareRecording;
}());
var dBox2D = (function () {
    function dBox2D(gravityX, gravityY, bAllowSleeping) {
        var _this = this;
        this.m_pBaseWorld = null;
        this.m_pBodyListBuffer = new Array(64);
        this.m_pBodyPositionBuffer = new Array(64 * 3);
        this.m_nLastBodyCount = 0;
        this.m_onBeginContact = null;
        this.m_onEndContact = null;
        this.m_onPostSolve = null;
        this.m_onPreSolve = null;
        this.m_listWillRelease = new Array();
        this.m_pCurrentContact = null;
        this.m_fPositionX = 0;
        this.m_fPositionY = 0;
        this.m_settingBodyTransform = false;
        this.m_onBeginContact = function () { _this._OnBeginContact(); };
        this.m_onEndContact = function () { _this._OnEndContact(); };
        this.m_onPostSolve = function () { _this._OnPostSolve(); };
        this.m_onPreSolve = function () { _this._OnPreSolve(); };
        this.m_pBaseWorld = new BoxWorld(new Vec2(gravityX, gravityY));
        this.m_pBaseWorld.setAllowSleep(bAllowSleeping);
        var listener = new ContactListener();
        listener.beginContact = function (contact) {
            _this.m_pCurrentContact = contact;
            var pBody1 = contact.getFixtureA().getBody().getUserData();
            var pBody2 = contact.getFixtureB().getBody().getUserData();
            if (pBody1 == null || pBody1.isDestoryed())
                return;
            if (pBody2 == null || pBody2.isDestoryed())
                return;
            if (pBody1.isRegContactEvent() || pBody2.isRegContactEvent()) {
                _this.m_onBeginContact(_this);
            }
        };
        listener.endContact = function (contact) {
            _this.m_pCurrentContact = contact;
            var pBody1 = contact.getFixtureA().getBody().getUserData();
            var pBody2 = contact.getFixtureB().getBody().getUserData();
            if (pBody1 == null || pBody1.isDestoryed())
                return;
            if (pBody2 == null || pBody2.isDestoryed())
                return;
            if (pBody1.isRegContactEvent() || pBody2.isRegContactEvent()) {
                _this.m_onEndContact(_this);
            }
        };
        listener.preSolve = function (contact, oldManifold) {
            _this.m_pCurrentContact = contact;
            var pBody1 = contact.getFixtureA().getBody().getUserData();
            var pBody2 = contact.getFixtureB().getBody().getUserData();
            if (pBody1 == null || pBody1.isDestoryed())
                return;
            if (pBody2 == null || pBody2.isDestoryed())
                return;
            if (pBody1.isRegContactEvent() || pBody2.isRegContactEvent()) {
                _this.m_onPreSolve(_this);
            }
        };
        listener.postSolve = function (contact, impulse) {
            _this.m_pCurrentContact = contact;
            var pBody1 = contact.getFixtureA().getBody().getUserData();
            var pBody2 = contact.getFixtureB().getBody().getUserData();
            if (pBody1 == null || pBody1.isDestoryed())
                return;
            if (pBody2 == null || pBody2.isDestoryed())
                return;
            if (pBody1.isRegContactEvent() || pBody2.isRegContactEvent()) {
                _this.m_onPostSolve(_this);
            }
        };
        this.m_pBaseWorld.setContactListener(listener);
    }
    dBox2D.prototype.SetPos = function (x, y) {
        this.m_fPositionX = x;
        this.m_fPositionY = y;
    };
    dBox2D.prototype.GetPosX = function () {
        return this.m_fPositionX;
    };
    dBox2D.prototype.GetPosY = function () {
        return this.m_fPositionY;
    };
    dBox2D.prototype.CreateBody = function (pTarget) {
        return new dBox2DBody(this, pTarget);
    };
    dBox2D.prototype.Release = function () {
    };
    dBox2D.prototype._CreateJoint = function (def, pUserData) {
        var pJoint = this.m_pBaseWorld.createJoint(def);
        pJoint.setUserData(pUserData);
        pUserData.m_pBaseJoint = pJoint;
    };
    dBox2D.prototype.GetBodyCountWithoutStatic = function () {
        var ret = 0;
        var body = this.m_pBaseWorld.getBodyList();
        if (body != null) {
            var v = new dVector3(0, 0, 0);
            for (var i = 0; body != null; body = body.getNext(), ++i) {
                var pBox2DBody = body.getUserData();
                if (pBox2DBody != null) {
                    v.SetValue(pBox2DBody.GetPosX(), pBox2DBody.GetPosY(), pBox2DBody.GetRotation());
                    if (v.Equals(pBox2DBody.m_vLastSetPos) == false)
                        ++ret;
                }
            }
        }
        return ret;
    };
    dBox2D.prototype._Step = function (timeStep, velocityIterations, positionIterations) {
        this.CheckReleaseBody();
        this.m_pBaseWorld.step(timeStep, velocityIterations, positionIterations);
        return this.GetBodyCountWithoutStatic();
    };
    dBox2D.prototype.CheckReleaseBody = function () {
        for (var i = 0; i < this.m_listWillRelease.length; i++) {
            this.m_pBaseWorld.destroyBody(this.m_listWillRelease[i]);
        }
        this.m_listWillRelease.clear();
    };
    dBox2D.prototype.FrameMove = function (timeStep, velocityIterations, positionIterations) {
        var bodyCount = this._Step(timeStep, velocityIterations, positionIterations);
        if (bodyCount >= this.m_pBodyListBuffer.length) {
            this.m_pBodyListBuffer = new Array(bodyCount + 64);
            this.m_pBodyPositionBuffer = new Array(bodyCount * 3 + 64 * 3);
        }
        for (var i = bodyCount; i < this.m_nLastBodyCount; i++) {
            this.m_pBodyListBuffer[i] = null;
        }
        this.m_nLastBodyCount = bodyCount;
        if (bodyCount > 0) {
            var body = this.m_pBaseWorld.getBodyList();
            if (body != null) {
                var v = new dVector3(0, 0, 0);
                for (var i = 0; body != null; body = body.getNext()) {
                    var pBox2DBody = body.getUserData();
                    if (pBox2DBody != null) {
                        v.SetValue(pBox2DBody.GetPosX(), pBox2DBody.GetPosY(), pBox2DBody.GetRotation());
                        if (v.Equals(pBox2DBody.m_vLastSetPos) == false) {
                            this.m_pBodyListBuffer[i] = pBox2DBody;
                            this.m_pBodyPositionBuffer[i * 3] = v.x;
                            this.m_pBodyPositionBuffer[i * 3 + 1] = v.y;
                            this.m_pBodyPositionBuffer[i * 3 + 2] = v.z;
                            pBox2DBody.m_vLastSetPos.Copy(v);
                            ++i;
                        }
                    }
                }
            }
            this.OnSetBodyTransform(bodyCount, this.m_pBodyListBuffer, this.m_pBodyPositionBuffer);
        }
    };
    dBox2D.prototype.OnSetBodyTransform = function (bodyCount, pBodyListBuffer, pBodyPositionBuffer) {
        this.m_settingBodyTransform = true;
        for (var i = 0; i < bodyCount; i++) {
            if (pBodyListBuffer[i] == null)
                continue;
            var p = pBodyListBuffer[i].target;
            if (p != null) {
                if (!pBodyListBuffer[i].OnSetPos(pBodyPositionBuffer[i * 3], pBodyPositionBuffer[i * 3 + 1])) {
                    p.SetPos(pBodyPositionBuffer[i * 3] + this.m_fPositionX, pBodyPositionBuffer[i * 3 + 1] + this.m_fPositionY);
                }
                if (!pBodyListBuffer[i].OnSetRotation(pBodyPositionBuffer[i * 3 + 2])) {
                    if (!pBodyListBuffer[i].GetFixedRotation())
                        p.SetRotation(pBodyPositionBuffer[i * 3 + 2]);
                }
            }
        }
        this.m_settingBodyTransform = false;
    };
    dBox2D.prototype.ContactGetBodyA = function () {
        if (this.m_pCurrentContact == null)
            return null;
        return this.m_pCurrentContact.getFixtureA().getBody().getUserData();
    };
    dBox2D.prototype.ContactGetBodyB = function () {
        if (this.m_pCurrentContact == null)
            return null;
        return this.m_pCurrentContact.getFixtureB().getBody().getUserData();
    };
    dBox2D.prototype.ContactGetShapeA = function () {
        if (this.m_pCurrentContact == null)
            return null;
        return this.m_pCurrentContact.getFixtureA().getUserData();
    };
    dBox2D.prototype.ContactGetShapeB = function () {
        if (this.m_pCurrentContact == null)
            return null;
        return this.m_pCurrentContact.getFixtureB().getUserData();
    };
    dBox2D.prototype.ContactSetEnabled = function (flag) {
        if (this.m_pCurrentContact != null)
            this.m_pCurrentContact.setEnabled(flag);
    };
    dBox2D.prototype.ContactIsEnabled = function () {
        if (this.m_pCurrentContact == null)
            return false;
        return this.m_pCurrentContact.isEnabled();
    };
    dBox2D.prototype.ContactSetFriction = function (friction) {
    };
    dBox2D.prototype.ContactGetFriction = function () {
        return 0;
    };
    dBox2D.prototype.ContactResetFriction = function () {
    };
    dBox2D.prototype.ContactSetRestitution = function (restitution) {
    };
    dBox2D.prototype.ContactGetRestitution = function () {
        return 0;
    };
    dBox2D.prototype.ContactResetRestitution = function () {
    };
    dBox2D.prototype.ContactSetTangentSpeed = function (speed) {
    };
    dBox2D.prototype.ContactGetTangentSpeed = function () {
        return 0;
    };
    dBox2D.prototype._OnBeginContact = function () {
        var pBodyA = this.ContactGetBodyA();
        var pBodyB = this.ContactGetBodyB();
        if (pBodyA.GetContactEvent() != null)
            pBodyA.GetContactEvent().OnBeginContact(this, pBodyB, this.ContactGetShapeA(), this.ContactGetShapeB());
        if (pBodyB.GetContactEvent() != null)
            pBodyB.GetContactEvent().OnBeginContact(this, pBodyA, this.ContactGetShapeB(), this.ContactGetShapeA());
        this.OnBeginContact(pBodyA.target, pBodyB.target, this.ContactGetShapeA(), this.ContactGetShapeB());
    };
    dBox2D.prototype.OnBeginContact = function (p1, p2, shape1, shape2) {
    };
    dBox2D.prototype._OnEndContact = function () {
        var pBodyA = this.ContactGetBodyA();
        var pBodyB = this.ContactGetBodyB();
        if (pBodyA.GetContactEvent() != null)
            pBodyA.GetContactEvent().OnEndContact(this, pBodyB, this.ContactGetShapeA(), this.ContactGetShapeB());
        if (pBodyB.GetContactEvent() != null)
            pBodyB.GetContactEvent().OnEndContact(this, pBodyA, this.ContactGetShapeB(), this.ContactGetShapeA());
        this.OnEndContact(pBodyA.target, pBodyB.target, this.ContactGetShapeA(), this.ContactGetShapeB());
    };
    dBox2D.prototype.OnEndContact = function (p1, p2, shape1, shape2) {
    };
    dBox2D.prototype._OnPreSolve = function () {
        var pBodyA = this.ContactGetBodyA();
        var pBodyB = this.ContactGetBodyB();
        if (pBodyA.GetContactEvent() != null)
            pBodyA.GetContactEvent().OnPreSolve(this, pBodyB, this.ContactGetShapeA(), this.ContactGetShapeB());
        if (pBodyB.GetContactEvent() != null)
            pBodyB.GetContactEvent().OnPreSolve(this, pBodyA, this.ContactGetShapeB(), this.ContactGetShapeA());
        this.OnPreSolve(pBodyA.target, pBodyB.target, this.ContactGetShapeA(), this.ContactGetShapeB());
    };
    dBox2D.prototype.OnPreSolve = function (p1, p2, shape1, shape2) {
    };
    dBox2D.prototype._OnPostSolve = function () {
        var pBodyA = this.ContactGetBodyA();
        var pBodyB = this.ContactGetBodyB();
        if (pBodyA.GetContactEvent() != null)
            pBodyA.GetContactEvent().OnPostSolve(this, pBodyB, this.ContactGetShapeA(), this.ContactGetShapeB());
        if (pBodyB.GetContactEvent() != null)
            pBodyB.GetContactEvent().OnPostSolve(this, pBodyA, this.ContactGetShapeB(), this.ContactGetShapeA());
        this.OnPostSolve(pBodyA.target, pBodyB.target, this.ContactGetShapeA(), this.ContactGetShapeB());
    };
    dBox2D.prototype.OnPostSolve = function (p1, p2, shape1, shape2) {
    };
    dBox2D.prototype.RayCast = function (callback, point1, point2) {
        var callback2 = new RayCastCallback();
        callback2.reportFixture = function (fixture, point, normal, fraction) {
            if (callback) {
                var pCollectSprite = fixture.getBody().getUserData().target;
                var pCollectShape = fixture.getUserData();
                return callback.reportFixture(pCollectSprite, pCollectShape, new dVector2(point.x * dBox2D.PTM_RATIO, point.y * dBox2D.PTM_RATIO), new dVector2(normal.x, normal.y), fraction);
            }
            return 0;
        };
        this.m_pBaseWorld.raycast(callback2, new Vec2(point1.x / dBox2D.PTM_RATIO, point1.y / dBox2D.PTM_RATIO), new Vec2(point2.x / dBox2D.PTM_RATIO, point2.y / dBox2D.PTM_RATIO));
    };
    dBox2D.PTM_RATIO = 32;
    dBox2D.b2_staticBody = 0;
    dBox2D.b2_kinematicBody = 1;
    dBox2D.b2_dynamicBody = 2;
    return dBox2D;
}());
var dBox2DRayCastCallback = (function () {
    function dBox2DRayCastCallback() {
    }
    dBox2DRayCastCallback.prototype.reportFixture = function (pSprite, pShape, point, normal, fraction) {
        return 0;
    };
    return dBox2DRayCastCallback;
}());
var dBox2DBodyDef = (function () {
    function dBox2DBodyDef() {
        this.type = dBox2D.b2_staticBody;
        this.linearVelocityX = 0.0;
        this.linearVelocityY = 0.0;
        this.angularVelocity = 0.0;
        this.linearDamping = 0.0;
        this.angularDamping = 0.0;
        this.allowSleep = true;
        this.awake = true;
        this.fixedRotation = false;
        this.bullet = false;
        this.active = true;
        this.gravityScale = 1.0;
        this.friction = 0.2;
        this.restitution = 0.0;
        this.density = 0.0;
        this.isSensor = false;
    }
    return dBox2DBodyDef;
}());
var dBox2DBaseShape = (function () {
    function dBox2DBaseShape(density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) {
        if (density === void 0) { density = 0.0; }
        if (friction === void 0) { friction = 0.2; }
        if (restitution === void 0) { restitution = 0.0; }
        if (isSensor === void 0) { isSensor = false; }
        if (categoryBits === void 0) { categoryBits = 0x0001; }
        if (maskBits === void 0) { maskBits = 0xFFFF; }
        if (groupIndex === void 0) { groupIndex = 0; }
        this.shapeName = "";
        this.pFixture = null;
        this.friction = 0.2;
        this.restitution = 0.0;
        this.density = 0.0;
        this.isSensor = false;
        this.categoryBits = 0x0001;
        this.maskBits = 0xFFFF;
        this.groupIndex = 0;
        this.userData = null;
        this.density = density;
        this.friction = friction;
        this.restitution = restitution;
        this.isSensor = isSensor;
        this.categoryBits = categoryBits;
        this.maskBits = maskBits;
        this.groupIndex = groupIndex;
    }
    dBox2DBaseShape.prototype.SetUserData = function (p) {
        this.userData = p;
        return this;
    };
    dBox2DBaseShape.prototype.GetUserData = function () {
        return this.userData;
    };
    return dBox2DBaseShape;
}());
var dBox2DBoxShape = (function (_super) {
    __extends(dBox2DBoxShape, _super);
    function dBox2DBoxShape(left, top, right, bottom, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) {
        if (density === void 0) { density = 0.0; }
        if (friction === void 0) { friction = 0.2; }
        if (restitution === void 0) { restitution = 0.0; }
        if (isSensor === void 0) { isSensor = false; }
        if (categoryBits === void 0) { categoryBits = 0x0001; }
        if (maskBits === void 0) { maskBits = 0xFFFF; }
        if (groupIndex === void 0) { groupIndex = 0; }
        var _this = _super.call(this, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) || this;
        _this.left = left;
        _this.top = top;
        _this.right = right;
        _this.bottom = bottom;
        return _this;
    }
    return dBox2DBoxShape;
}(dBox2DBaseShape));
var dBox2DEdgeShape = (function (_super) {
    __extends(dBox2DEdgeShape, _super);
    function dBox2DEdgeShape(v0, v1, ghost_v0, ghost_v1, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) {
        if (ghost_v0 === void 0) { ghost_v0 = null; }
        if (ghost_v1 === void 0) { ghost_v1 = null; }
        if (density === void 0) { density = 0.0; }
        if (friction === void 0) { friction = 0.2; }
        if (restitution === void 0) { restitution = 0.0; }
        if (isSensor === void 0) { isSensor = false; }
        if (categoryBits === void 0) { categoryBits = 0x0001; }
        if (maskBits === void 0) { maskBits = 0xFFFF; }
        if (groupIndex === void 0) { groupIndex = 0; }
        var _this = _super.call(this, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) || this;
        _this.v0 = v0;
        _this.v1 = v1;
        _this.ghost_v0 = ghost_v0;
        _this.ghost_v1 = ghost_v1;
        return _this;
    }
    return dBox2DEdgeShape;
}(dBox2DBaseShape));
var dBox2DCircleShape = (function (_super) {
    __extends(dBox2DCircleShape, _super);
    function dBox2DCircleShape(radio, x, y, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) {
        if (density === void 0) { density = 0.0; }
        if (friction === void 0) { friction = 0.2; }
        if (restitution === void 0) { restitution = 0.0; }
        if (isSensor === void 0) { isSensor = false; }
        if (categoryBits === void 0) { categoryBits = 0x0001; }
        if (maskBits === void 0) { maskBits = 0xFFFF; }
        if (groupIndex === void 0) { groupIndex = 0; }
        var _this = _super.call(this, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) || this;
        _this.radio = radio;
        _this.x = x;
        _this.y = y;
        return _this;
    }
    return dBox2DCircleShape;
}(dBox2DBaseShape));
var dBox2DPolygonShape = (function (_super) {
    __extends(dBox2DPolygonShape, _super);
    function dBox2DPolygonShape(vertices, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) {
        if (density === void 0) { density = 0.0; }
        if (friction === void 0) { friction = 0.2; }
        if (restitution === void 0) { restitution = 0.0; }
        if (isSensor === void 0) { isSensor = false; }
        if (categoryBits === void 0) { categoryBits = 0x0001; }
        if (maskBits === void 0) { maskBits = 0xFFFF; }
        if (groupIndex === void 0) { groupIndex = 0; }
        var _this = _super.call(this, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) || this;
        _this.m_vertices = vertices;
        return _this;
    }
    return dBox2DPolygonShape;
}(dBox2DBaseShape));
var dBox2DChainShape = (function (_super) {
    __extends(dBox2DChainShape, _super);
    function dBox2DChainShape(vertices, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) {
        if (density === void 0) { density = 0.0; }
        if (friction === void 0) { friction = 0.2; }
        if (restitution === void 0) { restitution = 0.0; }
        if (isSensor === void 0) { isSensor = false; }
        if (categoryBits === void 0) { categoryBits = 0x0001; }
        if (maskBits === void 0) { maskBits = 0xFFFF; }
        if (groupIndex === void 0) { groupIndex = 0; }
        var _this = _super.call(this, density, friction, restitution, isSensor, categoryBits, maskBits, groupIndex) || this;
        _this.m_vertices = vertices;
        return _this;
    }
    return dBox2DChainShape;
}(dBox2DBaseShape));
var dBox2DContactEvent = (function () {
    function dBox2DContactEvent() {
    }
    dBox2DContactEvent.prototype.OnBeginContact = function (box2D, pOther, myShape, otherShape) {
    };
    dBox2DContactEvent.prototype.OnEndContact = function (box2D, pOther, myShape, otherShape) {
    };
    dBox2DContactEvent.prototype.OnPreSolve = function (box2D, pOther, myShape, otherShape) {
    };
    dBox2DContactEvent.prototype.OnPostSolve = function (box2D, pOther, myShape, otherShape) {
    };
    return dBox2DContactEvent;
}());
var dBox2DBody = (function (_super) {
    __extends(dBox2DBody, _super);
    function dBox2DBody(pBox2D, pTarget) {
        var _this = _super.call(this) || this;
        _this.m_pBox2D = null;
        _this.m_pBaseBody = null;
        _this.target = null;
        _this.m_pContactEvent = null;
        _this.m_vecShapes = new Array();
        _this.m_bDestoryed = false;
        _this.m_pOnSetPosEvent = null;
        _this.m_vLastSetPos = new dVector3();
        _this.m_bRegContactEvent = false;
        _this.m_pBox2D = pBox2D;
        _this.m_pBaseBody = pBox2D.m_pBaseWorld.createBody(new BodyDef());
        _this.m_pBaseBody.setUserData(_this);
        if (pTarget != null) {
            _this.SetPos(pTarget.positionX, pTarget.positionY);
            _this.SetRotation(pTarget.rotation);
        }
        _this.target = pTarget;
        return _this;
    }
    dBox2DBody.prototype.GetBox2DWorld = function () {
        return this.m_pBox2D;
    };
    dBox2DBody.prototype.GetTarget = function () {
        return this.target;
    };
    dBox2DBody.prototype.Release = function () {
        if (!this.m_bDestoryed) {
            this.m_pBox2D.m_listWillRelease.push(this.m_pBaseBody);
            this.m_pContactEvent = null;
            this.m_bDestoryed = true;
        }
    };
    dBox2DBody.prototype.SetOnSetPosEvent = function (pEvent) {
        this.m_pOnSetPosEvent = pEvent;
    };
    dBox2DBody.prototype.isDestoryed = function () {
        return this.m_bDestoryed;
    };
    dBox2DBody.prototype.OnSetPos = function (x, y) {
        if (this.m_pOnSetPosEvent != null) {
            this.m_pOnSetPosEvent.SetPos(x, y);
            return true;
        }
        return false;
    };
    dBox2DBody.prototype.OnSetRotation = function (r) {
        if (this.m_pOnSetPosEvent != null) {
            this.m_pOnSetPosEvent.SetRotation(r);
            return true;
        }
        return false;
    };
    dBox2DBody.prototype.SetContactEvent = function (evt) {
        this.SetRegContactEvent(evt != null);
        this.m_pContactEvent = evt;
    };
    dBox2DBody.prototype.GetContactEvent = function () {
        return this.m_pContactEvent;
    };
    dBox2DBody.prototype.GetActive = function () {
        return this.m_pBaseBody.isActive();
    };
    Object.defineProperty(dBox2DBody.prototype, "active", {
        get: function () {
            return this.GetActive();
        },
        set: function (value) {
            this.SetActive(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetActive = function (active) {
        this.m_pBaseBody.setActive(active);
    };
    dBox2DBody.prototype.GetAngularDamping = function () {
        return this.m_pBaseBody.getAngularDamping();
    };
    Object.defineProperty(dBox2DBody.prototype, "angularDamping", {
        get: function () {
            return this.GetAngularDamping();
        },
        set: function (value) {
            this.SetAngularDamping(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetAngularDamping = function (angularDamping) {
        this.m_pBaseBody.setAngularDamping(angularDamping);
    };
    dBox2DBody.prototype.GetAngularVelocity = function () {
        return this.m_pBaseBody.getAngularVelocity();
    };
    Object.defineProperty(dBox2DBody.prototype, "angularVelocity", {
        get: function () {
            return this.GetAngularVelocity();
        },
        set: function (value) {
            this.SetAngularVelocity(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetAngularVelocity = function (angularVelocity) {
        this.m_pBaseBody.setAngularVelocity(angularVelocity);
    };
    dBox2DBody.prototype.GetAwake = function () {
        return this.m_pBaseBody.isAwake();
    };
    Object.defineProperty(dBox2DBody.prototype, "awake", {
        get: function () {
            return this.GetAwake();
        },
        set: function (value) {
            this.SetAwake(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetAwake = function (awake) {
        this.m_pBaseBody.setAwake(awake);
    };
    dBox2DBody.prototype.isBullet = function () {
        return this.m_pBaseBody.isBullet();
    };
    Object.defineProperty(dBox2DBody.prototype, "bullet", {
        get: function () {
            return this.isBullet();
        },
        set: function (value) {
            this.SetBullet(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetBullet = function (bullet) {
        this.m_pBaseBody.setBullet(bullet);
    };
    dBox2DBody.prototype.GetFixedRotation = function () {
        return this.m_pBaseBody.isFixedRotation();
    };
    Object.defineProperty(dBox2DBody.prototype, "fixedRotation", {
        get: function () {
            return this.GetFixedRotation();
        },
        set: function (value) {
            this.SetFixedRotation(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetFixedRotation = function (fixedRotation) {
        this.m_pBaseBody.setFixedRotation(fixedRotation);
    };
    dBox2DBody.prototype.GetGravityScale = function () {
        return this.m_pBaseBody.getGravityScale();
    };
    Object.defineProperty(dBox2DBody.prototype, "gravityScale", {
        get: function () {
            return this.GetGravityScale();
        },
        set: function (value) {
            this.SetGravityScale(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetGravityScale = function (gravityScale) {
        this.m_pBaseBody.setGravityScale(gravityScale);
    };
    dBox2DBody.prototype.GetLinearDamping = function () {
        return this.m_pBaseBody.getLinearDamping();
    };
    Object.defineProperty(dBox2DBody.prototype, "linearDamping", {
        get: function () {
            return this.GetLinearDamping();
        },
        set: function (value) {
            this.SetLinearDamping(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetLinearDamping = function (linearDamping) {
        this.m_pBaseBody.setLinearDamping(linearDamping);
    };
    dBox2DBody.prototype.GetLinearVelocityX = function () {
        return this.m_pBaseBody.getLinearVelocity().x * dBox2D.PTM_RATIO;
    };
    Object.defineProperty(dBox2DBody.prototype, "linearVelocityX", {
        get: function () {
            return this.GetLinearVelocityX();
        },
        set: function (value) {
            this.SetLinearVelocity(value, this.linearVelocityY);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.GetLinearVelocityY = function () {
        return this.m_pBaseBody.getLinearVelocity().y * dBox2D.PTM_RATIO;
    };
    Object.defineProperty(dBox2DBody.prototype, "linearVelocityY", {
        get: function () {
            return this.GetLinearVelocityY();
        },
        set: function (value) {
            this.SetLinearVelocity(this.linearVelocityX, value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetLinearVelocity = function (linearVelocityX, linearVelocityY) {
        this.m_pBaseBody.setLinearVelocity(new Vec2(linearVelocityX / dBox2D.PTM_RATIO, linearVelocityY / dBox2D.PTM_RATIO));
    };
    dBox2DBody.prototype.GetSleepingAllowed = function () {
        return this.m_pBaseBody.isSleepingAllowed();
    };
    Object.defineProperty(dBox2DBody.prototype, "sleepingAllowed", {
        get: function () {
            return this.GetSleepingAllowed();
        },
        set: function (value) {
            this.SetSleepingAllowed(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetSleepingAllowed = function (allowSleep) {
        this.m_pBaseBody.setSleepingAllowed(allowSleep);
    };
    dBox2DBody.prototype.GetType = function () {
        return this.m_pBaseBody.getType();
    };
    Object.defineProperty(dBox2DBody.prototype, "type", {
        get: function () {
            return this.GetType();
        },
        set: function (value) {
            this.SetType(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetType = function (type) {
        this.m_pBaseBody.setType(type);
    };
    dBox2DBody.prototype.GetPosX = function () {
        return this.m_pBaseBody.getPosition().x * dBox2D.PTM_RATIO;
    };
    Object.defineProperty(dBox2DBody.prototype, "positionX", {
        get: function () {
            return this.GetPosX();
        },
        set: function (value) {
            this.SetPos(value, this.positionY);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.GetPosY = function () {
        return this.m_pBaseBody.getPosition().y * dBox2D.PTM_RATIO;
    };
    Object.defineProperty(dBox2DBody.prototype, "positionY", {
        get: function () {
            return this.GetPosY();
        },
        set: function (value) {
            this.SetPos(this.positionX, value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetPos = function (x, y) {
        this.m_pBaseBody.setTransform(new Vec2(x / dBox2D.PTM_RATIO, y / dBox2D.PTM_RATIO), this.m_pBaseBody.getAngle());
    };
    dBox2DBody.prototype.SetPos3D = function (x, y, z) {
        this.SetPos(x, y);
    };
    dBox2DBody.prototype.GetPos3D = function () {
        return new dVector3(this.GetPosX(), this.GetPosY(), 0);
    };
    dBox2DBody.prototype.GetCenterPosX = function () {
        return this.m_pBaseBody.getWorldCenter().x / dBox2D.PTM_RATIO;
    };
    dBox2DBody.prototype.GetCenterPosY = function () {
        return this.m_pBaseBody.getWorldCenter().y / dBox2D.PTM_RATIO;
    };
    dBox2DBody.prototype.MoveTo = function (x, y) {
        var previousPositionX = this.GetPosX();
        var previousPositionY = this.GetPosY();
        var distanceX = previousPositionX - x;
        var distanceY = previousPositionY - y;
        this.SetLinearVelocity(-distanceX * dBox2D.PTM_RATIO, -distanceY * dBox2D.PTM_RATIO);
    };
    dBox2DBody.prototype.GetRotation = function () {
        return dMath.RadianToAngle(this.m_pBaseBody.getAngle());
    };
    Object.defineProperty(dBox2DBody.prototype, "rotation", {
        get: function () {
            return this.GetRotation();
        },
        set: function (value) {
            this.SetRotation(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetRotation = function (angle) {
        this.m_pBaseBody.setTransform(this.m_pBaseBody.getPosition(), dMath.AngleToRadian(angle));
    };
    dBox2DBody.prototype.isRegContactEvent = function () {
        return this.m_bRegContactEvent;
    };
    Object.defineProperty(dBox2DBody.prototype, "regContactEvent", {
        get: function () {
            return this.isRegContactEvent();
        },
        set: function (value) {
            this.SetRegContactEvent(value);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DBody.prototype.SetRegContactEvent = function (value) {
        this.m_bRegContactEvent = value;
    };
    dBox2DBody.prototype.ApplyLinearImpulse = function (impulse_x, implulse_y) {
        this.m_pBaseBody.applyLinearImpulse(new Vec2(impulse_x / dBox2D.PTM_RATIO, implulse_y / dBox2D.PTM_RATIO), this.m_pBaseBody.getWorldCenter(), true);
    };
    dBox2DBody.prototype.ApplyAngularImpulse = function (impulse) {
        this.m_pBaseBody.applyAngularImpulse(impulse);
    };
    dBox2DBody.prototype.ApplyForce = function (force_x, force_y, center) {
        if (center === void 0) { center = null; }
        this.m_pBaseBody.applyForce(new Vec2(force_x / dBox2D.PTM_RATIO, force_y / dBox2D.PTM_RATIO), center == null ? this.m_pBaseBody.getWorldCenter() : new Vec2(center.x / dBox2D.PTM_RATIO, center.y / dBox2D.PTM_RATIO));
    };
    dBox2DBody.prototype.AddShape = function (pShape) {
        this.UpdateShape(pShape);
        this.m_vecShapes.push(pShape);
    };
    dBox2DBody.prototype.ApplyTorque = function (torque) {
        this.m_pBaseBody.applyTorque(torque / dBox2D.PTM_RATIO);
    };
    dBox2DBody.prototype.SetCategoryBits = function (bits) {
        for (var i = 0; i < this.m_vecShapes.length; i++)
            this.m_vecShapes[i].categoryBits = bits;
        for (var p = this.m_pBaseBody.getFixtureList(); p != null; p = p.getNext())
            p.getFilterData().categoryBits = bits;
    };
    dBox2DBody.prototype.SetMaskBits = function (bits) {
        for (var i = 0; i < this.m_vecShapes.length; i++)
            this.m_vecShapes[i].maskBits = bits;
        for (var p = this.m_pBaseBody.getFixtureList(); p != null; p = p.getNext())
            p.getFilterData().maskBits = bits;
    };
    dBox2DBody.prototype.SetMaskBitsByShapeName = function (bits, shapeName) {
        for (var p = this.m_pBaseBody.getFixtureList(); p != null; p = p.getNext())
            if (p.m_userData.shapeName == shapeName)
                p.getFilterData().maskBits = bits;
    };
    dBox2DBody.prototype.UpdateShape = function (pShape) {
        var def = new FixtureDef();
        def.friction = pShape.friction;
        def.restitution = pShape.restitution;
        def.density = pShape.density;
        def.isSensor = pShape.isSensor;
        def.filter.categoryBits = pShape.categoryBits;
        def.filter.maskBits = pShape.maskBits;
        def.filter.groupIndex = pShape.groupIndex;
        if (pShape instanceof dBox2DBoxShape) {
            var pBoxShape = pShape;
            if (pBoxShape.right > pBoxShape.left && pBoxShape.bottom > pBoxShape.top) {
                var left = pBoxShape.left;
                var top = pBoxShape.top;
                var right = pBoxShape.right;
                var bottom = pBoxShape.bottom;
                if (right - left > 0 || bottom - top > 0) {
                    var p = pShape.pFixture;
                    if (p != null) {
                        if (p.getShape() != null && p.getShape().getType() == ShapeType.POLYGON) {
                            var polygon = p.getShape();
                            var halfWidth = (right - left) * 0.5;
                            var halfHeight = (bottom - top) * 0.5;
                            var centerX = (right + left) * 0.5;
                            var centerY = (bottom + top) * 0.5;
                            polygon.setAsBox(halfWidth / dBox2D.PTM_RATIO, halfHeight / dBox2D.PTM_RATIO, new Vec2(centerX / dBox2D.PTM_RATIO, centerY / dBox2D.PTM_RATIO), 0.0);
                            this.m_pBaseBody.setAwake(true);
                        }
                        pShape.pFixture = p;
                    }
                    else {
                        var boxShape = new PolygonShape();
                        var halfWidth = (right - left) * 0.5;
                        var halfHeight = (bottom - top) * 0.5;
                        var centerX = (right + left) * 0.5;
                        var centerY = (bottom + top) * 0.5;
                        boxShape.setAsBox(halfWidth / dBox2D.PTM_RATIO, halfHeight / dBox2D.PTM_RATIO, new Vec2(centerX / dBox2D.PTM_RATIO, centerY / dBox2D.PTM_RATIO), 0.0);
                        def.shape = boxShape;
                        def.userData = pShape;
                        pShape.pFixture = this.m_pBaseBody.createFixture(def);
                    }
                }
            }
        }
        else if (pShape instanceof dBox2DEdgeShape) {
            var pEdgeShape = pShape;
            var hasGhostV0 = pEdgeShape.ghost_v0 != null;
            var hasGhostV1 = pEdgeShape.ghost_v1 != null;
            var ghost_v0_x = 0;
            var ghost_v0_y = 0;
            var ghost_v1_x = 0;
            var ghost_v1_y = 0;
            if (hasGhostV0) {
                ghost_v0_x = pEdgeShape.ghost_v0.x;
                ghost_v0_y = pEdgeShape.ghost_v0.y;
            }
            if (hasGhostV1) {
                ghost_v1_x = pEdgeShape.ghost_v1.x;
                ghost_v1_y = pEdgeShape.ghost_v1.y;
            }
            var p = pShape.pFixture;
            if (p != null) {
                if (p.getShape() != null && p.getShape().getType() == ShapeType.EDGE) {
                    var edgeShape = p.getShape();
                    edgeShape.set(new Vec2(pEdgeShape.v0.x / dBox2D.PTM_RATIO, pEdgeShape.v0.y / dBox2D.PTM_RATIO), new Vec2(pEdgeShape.v1.x / dBox2D.PTM_RATIO, pEdgeShape.v1.y / dBox2D.PTM_RATIO));
                    this.m_pBaseBody.setAwake(true);
                }
                pShape.pFixture = p;
            }
            else {
                var edgeShape = new EdgeShape();
                edgeShape.set(new Vec2(pEdgeShape.v0.x / dBox2D.PTM_RATIO, pEdgeShape.v0.y / dBox2D.PTM_RATIO), new Vec2(pEdgeShape.v1.x / dBox2D.PTM_RATIO, pEdgeShape.v1.y / dBox2D.PTM_RATIO));
                def.shape = edgeShape;
                def.userData = pShape;
                pShape.pFixture = this.m_pBaseBody.createFixture(def);
            }
        }
        else if (pShape instanceof dBox2DCircleShape) {
            var pCircleShape = pShape;
            var p = pShape.pFixture;
            if (p != null) {
                if (p.getShape() != null && p.getShape().getType() == ShapeType.CIRCLE) {
                    var circle = p.getShape();
                    circle.m_radius = pCircleShape.radio / dBox2D.PTM_RATIO;
                    circle.m_p = new Vec2(pCircleShape.x / dBox2D.PTM_RATIO, pCircleShape.y / dBox2D.PTM_RATIO);
                    this.m_pBaseBody.setAwake(true);
                }
                pShape.pFixture = p;
            }
            else {
                var circle = new CircleShape();
                circle.m_radius = pCircleShape.radio / dBox2D.PTM_RATIO;
                circle.m_p = new Vec2(pCircleShape.x / dBox2D.PTM_RATIO, pCircleShape.y / dBox2D.PTM_RATIO);
                def.shape = circle;
                def.userData = pShape;
                pShape.pFixture = this.m_pBaseBody.createFixture(def);
            }
        }
        else if (pShape instanceof dBox2DPolygonShape) {
            var pPolygonShape = pShape;
            var p = pShape.pFixture;
            if (p != null) {
                if (p.getShape() != null && p.getShape().getType() == ShapeType.POLYGON) {
                    var polyShape = p.getShape();
                    polyShape.setV2(pPolygonShape.m_vertices);
                    this.m_pBaseBody.setAwake(true);
                }
                pShape.pFixture = p;
            }
            else {
                var polyShape = new PolygonShape();
                polyShape.setV2(pPolygonShape.m_vertices);
                def.shape = polyShape;
                def.userData = pShape;
                pShape.pFixture = this.m_pBaseBody.createFixture(def);
            }
        }
        else if (pShape instanceof dBox2DChainShape) {
            var pChainShape = pShape;
            var p = pShape.pFixture;
            if (p != null) {
                if (p.getShape() != null && p.getShape().getType() == ShapeType.CHAIN) {
                    var chainShape = p.getShape();
                    chainShape.setV2(pChainShape.m_vertices);
                    this.m_pBaseBody.setAwake(true);
                }
                pShape.pFixture = p;
            }
            else {
                var chainShape = new ChainShape();
                chainShape.setV2(pChainShape.m_vertices);
                def.shape = chainShape;
                def.userData = pShape;
                pShape.pFixture = this.m_pBaseBody.createFixture(def);
            }
        }
    };
    dBox2DBody.prototype.RemoveShape = function (pShape) {
        for (var p = this.m_pBaseBody.getFixtureList(); p != null;) {
            if (pShape.pFixture == p) {
                this.m_pBaseBody.destroyFixture(p);
                this.m_vecShapes.remove(pShape);
                pShape.pFixture = null;
                break;
            }
        }
    };
    dBox2DBody.prototype.RemoveAllShape = function () {
        for (var p = this.m_pBaseBody.getFixtureList(); p != null;) {
            var next = p.getNext();
            this.m_pBaseBody.destroyFixture(p);
            p = next;
        }
        this.m_vecShapes.clear();
    };
    dBox2DBody.prototype.GetShape = function (index) {
        if (index >= 0 && index < this.m_vecShapes.length)
            return this.m_vecShapes[index];
        return null;
    };
    dBox2DBody.prototype.GetShapeByName = function (shapeName) {
        for (var i = 0; i < this.m_vecShapes.length; i++)
            if (this.m_vecShapes[i].shapeName == shapeName)
                return this.m_vecShapes[i];
        return null;
    };
    dBox2DBody.prototype.GetShapeCount = function () {
        return this.m_vecShapes.length;
    };
    dBox2DBody.prototype.GetShapeList = function () {
        return this.m_vecShapes;
    };
    dBox2DBody.prototype.GetMass = function () {
        return this.m_pBaseBody.getMass();
    };
    return dBox2DBody;
}(dSprite));
var dBox2DBaseJoint = (function () {
    function dBox2DBaseJoint(box2D) {
        this.m_pBaseJoint = null;
        this.m_box2D = null;
        this.m_body1 = null;
        this.m_body2 = null;
        this.m_collideConnected = false;
        this.m_box2D = box2D;
    }
    dBox2DBaseJoint.prototype.Release = function () {
        if (this.m_pBaseJoint) {
            this.m_box2D.m_pBaseWorld.destroyJoint(this.m_pBaseJoint);
            this.m_pBaseJoint = null;
        }
    };
    dBox2DBaseJoint.prototype.GetReactionForceX = function (inv_dt) {
        var outData = new Vec2();
        this.m_pBaseJoint.getReactionForce(inv_dt, outData);
        return outData.x;
    };
    dBox2DBaseJoint.prototype.GetReactionForceY = function (inv_dt) {
        var outData = new Vec2();
        this.m_pBaseJoint.getReactionForce(inv_dt, outData);
        return outData.y;
    };
    dBox2DBaseJoint.prototype.GetReactionTorque = function (inv_dt) {
        return this.m_pBaseJoint.getReactionTorque(inv_dt);
    };
    dBox2DBaseJoint.prototype.GetBodyA = function () {
        return this.m_body1;
    };
    dBox2DBaseJoint.prototype.GetBodyB = function () {
        return this.m_body2;
    };
    dBox2DBaseJoint.prototype.IsCollideConnected = function () {
        return this.m_collideConnected;
    };
    return dBox2DBaseJoint;
}());
var dBox2DRevoluteJoint = (function (_super) {
    __extends(dBox2DRevoluteJoint, _super);
    function dBox2DRevoluteJoint(box2D, body1, body2, localAnchorAX, localAnchorAY, localAnchorBX, localAnchorBY, referenceAngle, enableLimit, lowerAngle, upperAngle, enableMotor, motorSpeed, maxMotorTorque, collideConnected) {
        if (localAnchorAX === void 0) { localAnchorAX = 0; }
        if (localAnchorAY === void 0) { localAnchorAY = 0; }
        if (localAnchorBX === void 0) { localAnchorBX = 0; }
        if (localAnchorBY === void 0) { localAnchorBY = 0; }
        if (referenceAngle === void 0) { referenceAngle = 0; }
        if (enableLimit === void 0) { enableLimit = false; }
        if (lowerAngle === void 0) { lowerAngle = 0; }
        if (upperAngle === void 0) { upperAngle = 0; }
        if (enableMotor === void 0) { enableMotor = false; }
        if (motorSpeed === void 0) { motorSpeed = 0; }
        if (maxMotorTorque === void 0) { maxMotorTorque = 0; }
        if (collideConnected === void 0) { collideConnected = false; }
        var _this = _super.call(this, box2D) || this;
        _this.m_localAnchorA = new dVector2();
        _this.m_localAnchorB = new dVector2();
        _this.m_referenceAngle = 0;
        _this.m_enableLimit = false;
        _this.m_lowerAngle = 0;
        _this.m_upperAngle = 0;
        _this.m_enableMotor = false;
        _this.m_motorSpeed = 0;
        _this.m_maxMotorTorque = 0;
        _this.m_body1 = body1;
        _this.m_body2 = body2;
        _this.m_collideConnected = collideConnected;
        _this.m_localAnchorA.SetValue(localAnchorAX, localAnchorAY);
        _this.m_localAnchorB.SetValue(localAnchorBX, localAnchorBY);
        _this.m_referenceAngle = referenceAngle;
        _this.m_enableLimit = enableLimit;
        _this.m_lowerAngle = lowerAngle;
        _this.m_upperAngle = upperAngle;
        _this.m_enableMotor = enableMotor;
        _this.m_motorSpeed = motorSpeed;
        _this.m_maxMotorTorque = maxMotorTorque;
        var def = new RevoluteJointDef();
        def.bodyA = body1.m_pBaseBody;
        def.bodyB = body2.m_pBaseBody;
        def.collideConnected = collideConnected;
        def.localAnchorA.setValue(localAnchorAX / dBox2D.PTM_RATIO, localAnchorAY / dBox2D.PTM_RATIO);
        def.localAnchorB.setValue(localAnchorBX / dBox2D.PTM_RATIO, localAnchorBY / dBox2D.PTM_RATIO);
        def.referenceAngle = referenceAngle;
        def.enableLimit = enableLimit;
        def.lowerAngle = lowerAngle;
        def.upperAngle = upperAngle;
        def.enableMotor = enableMotor;
        def.motorSpeed = motorSpeed;
        def.maxMotorTorque = maxMotorTorque;
        box2D._CreateJoint(def, _this);
        return _this;
    }
    dBox2DRevoluteJoint.prototype.EnableLimit = function (flag) {
        this.m_enableLimit = flag;
        this.m_pBaseJoint.enableLimit(flag);
    };
    dBox2DRevoluteJoint.prototype.IsLimitEnabled = function () {
        return this.m_enableLimit;
    };
    dBox2DRevoluteJoint.prototype.SetLimits = function (lower, upper) {
        this.m_lowerAngle = lower;
        this.m_upperAngle = upper;
        this.m_pBaseJoint.setLimits(lower, upper);
    };
    dBox2DRevoluteJoint.prototype.IsMotorEnabled = function () {
        return this.m_enableMotor;
    };
    dBox2DRevoluteJoint.prototype.EnableMotor = function (flag) {
        this.m_enableMotor = flag;
        this.m_pBaseJoint.enableMotor(flag);
    };
    dBox2DRevoluteJoint.prototype.SetMotorSpeed = function (speed) {
        this.m_motorSpeed = speed;
        this.m_pBaseJoint.setMotorSpeed(speed);
    };
    dBox2DRevoluteJoint.prototype.GetMotorSpeed = function () {
        return this.m_motorSpeed;
    };
    dBox2DRevoluteJoint.prototype.SetMaxMotorTorque = function (torque) {
        this.m_maxMotorTorque = torque;
        this.m_pBaseJoint.setMaxMotorTorque(torque);
    };
    dBox2DRevoluteJoint.prototype.GetMaxMotorTorque = function () {
        return this.m_maxMotorTorque;
    };
    return dBox2DRevoluteJoint;
}(dBox2DBaseJoint));
var dBox2DDistanceJoint = (function (_super) {
    __extends(dBox2DDistanceJoint, _super);
    function dBox2DDistanceJoint(box2D, body1, body2, localAnchorAX, localAnchorAY, localAnchorBX, localAnchorBY, length, frequencyHz, dampingRatio, collideConnected) {
        if (localAnchorAX === void 0) { localAnchorAX = 0; }
        if (localAnchorAY === void 0) { localAnchorAY = 0; }
        if (localAnchorBX === void 0) { localAnchorBX = 0; }
        if (localAnchorBY === void 0) { localAnchorBY = 0; }
        if (length === void 0) { length = 1; }
        if (frequencyHz === void 0) { frequencyHz = 0; }
        if (dampingRatio === void 0) { dampingRatio = 0; }
        if (collideConnected === void 0) { collideConnected = false; }
        var _this = _super.call(this, box2D) || this;
        _this.m_localAnchorA = new dVector2();
        _this.m_localAnchorB = new dVector2();
        _this.m_length = 1.0;
        _this.m_frequencyHz = 0.0;
        _this.m_dampingRatio = 0.0;
        _this.m_body1 = body1;
        _this.m_body2 = body2;
        _this.m_collideConnected = collideConnected;
        _this.m_localAnchorA.SetValue(localAnchorAX, localAnchorAY);
        _this.m_localAnchorB.SetValue(localAnchorBX, localAnchorBY);
        _this.m_length = length;
        _this.m_frequencyHz = frequencyHz;
        _this.m_dampingRatio = dampingRatio;
        var def = new DistanceJointDef();
        def.bodyA = body1.m_pBaseBody;
        def.bodyB = body2.m_pBaseBody;
        def.collideConnected = collideConnected;
        def.localAnchorA.setValue(localAnchorAX / dBox2D.PTM_RATIO, localAnchorAY / dBox2D.PTM_RATIO);
        def.localAnchorB.setValue(localAnchorBX / dBox2D.PTM_RATIO, localAnchorBY / dBox2D.PTM_RATIO);
        def.length = length / dBox2D.PTM_RATIO;
        def.frequencyHz = frequencyHz;
        def.dampingRatio = dampingRatio;
        box2D._CreateJoint(def, _this);
        return _this;
    }
    dBox2DDistanceJoint.prototype.SetLength = function (length) {
        this.m_length = length;
        this.m_pBaseJoint.setLength(length);
    };
    dBox2DDistanceJoint.prototype.GetLength = function () {
        return this.m_length;
    };
    dBox2DDistanceJoint.prototype.SetFrequency = function (hz) {
        this.m_frequencyHz = hz;
        this.m_pBaseJoint.setFrequency(hz);
    };
    dBox2DDistanceJoint.prototype.GetFrequency = function () {
        return this.m_frequencyHz;
    };
    dBox2DDistanceJoint.prototype.SetDampingRatio = function (ratio) {
        this.m_dampingRatio = ratio;
        this.m_pBaseJoint.setDampingRatio(ratio);
    };
    dBox2DDistanceJoint.prototype.GetDampingRatio = function () {
        return this.m_dampingRatio;
    };
    return dBox2DDistanceJoint;
}(dBox2DBaseJoint));
var dBox2DPulleyJoint = (function (_super) {
    __extends(dBox2DPulleyJoint, _super);
    function dBox2DPulleyJoint(box2D, body1, body2, groundAnchorAX, groundAnchorAY, groundAnchorBX, groundAnchorBY, localAnchorAX, localAnchorAY, localAnchorBX, localAnchorBY, lengthA, lengthB, ratio, collideConnected) {
        if (groundAnchorAX === void 0) { groundAnchorAX = -1; }
        if (groundAnchorAY === void 0) { groundAnchorAY = 1; }
        if (groundAnchorBX === void 0) { groundAnchorBX = 1; }
        if (groundAnchorBY === void 0) { groundAnchorBY = 1; }
        if (localAnchorAX === void 0) { localAnchorAX = -1; }
        if (localAnchorAY === void 0) { localAnchorAY = 0; }
        if (localAnchorBX === void 0) { localAnchorBX = 1; }
        if (localAnchorBY === void 0) { localAnchorBY = 0; }
        if (lengthA === void 0) { lengthA = 0; }
        if (lengthB === void 0) { lengthB = 0; }
        if (ratio === void 0) { ratio = 0; }
        if (collideConnected === void 0) { collideConnected = true; }
        var _this = _super.call(this, box2D) || this;
        _this.m_groundAnchorA = new dVector2(-1, 1);
        _this.m_groundAnchorB = new dVector2(1, 1);
        _this.m_localAnchorA = new dVector2(-1, 0);
        _this.m_localAnchorB = new dVector2(1, 0);
        _this.m_lengthA = 0;
        _this.m_lengthB = 0;
        _this.m_ratio = 0;
        _this.m_body1 = body1;
        _this.m_body2 = body2;
        _this.m_collideConnected = collideConnected;
        _this.m_groundAnchorA.SetValue(groundAnchorAX, groundAnchorAY);
        _this.m_groundAnchorB.SetValue(groundAnchorBX, groundAnchorBY);
        _this.m_localAnchorA.SetValue(localAnchorAX, localAnchorAY);
        _this.m_localAnchorB.SetValue(localAnchorBX, localAnchorBY);
        _this.m_lengthA = lengthA;
        _this.m_lengthB = lengthB;
        _this.m_ratio = ratio;
        var def = new PulleyJointDef();
        def.bodyA = body1.m_pBaseBody;
        def.bodyB = body2.m_pBaseBody;
        def.collideConnected = collideConnected;
        def.groundAnchorA.setValue(groundAnchorAX, groundAnchorAY);
        def.groundAnchorB.setValue(groundAnchorBX, groundAnchorBY);
        def.localAnchorA.setValue(localAnchorAX, localAnchorAY);
        def.localAnchorB.setValue(localAnchorBX, localAnchorBY);
        def.lengthA = lengthA;
        def.lengthB = lengthB;
        def.ratio = ratio;
        box2D._CreateJoint(def, _this);
        return _this;
    }
    return dBox2DPulleyJoint;
}(dBox2DBaseJoint));
var dBox2DGearJoint = (function (_super) {
    __extends(dBox2DGearJoint, _super);
    function dBox2DGearJoint(box2D, body1, body2, joint1, joint2, ratio, collideConnected) {
        if (ratio === void 0) { ratio = 1.0; }
        if (collideConnected === void 0) { collideConnected = false; }
        var _this = _super.call(this, box2D) || this;
        _this.m_fRatio = 1.0;
        _this.m_body1 = body1;
        _this.m_body2 = body2;
        _this.m_collideConnected = collideConnected;
        _this.m_fRatio = ratio;
        var def = new GearJointDef();
        def.bodyA = body1.m_pBaseBody;
        def.bodyB = body2.m_pBaseBody;
        def.joint1 = joint1.m_pBaseJoint;
        def.joint2 = joint2.m_pBaseJoint;
        def.collideConnected = collideConnected;
        def.ratio = ratio;
        box2D._CreateJoint(def, _this);
        return _this;
    }
    dBox2DGearJoint.prototype.GetRatio = function () {
        return this.m_fRatio;
    };
    dBox2DGearJoint.prototype.SetRatio = function (ratio) {
        this.m_fRatio = ratio;
        this.m_pBaseJoint.setRatio(ratio);
    };
    return dBox2DGearJoint;
}(dBox2DBaseJoint));
var dBox2DMouseJoint = (function (_super) {
    __extends(dBox2DMouseJoint, _super);
    function dBox2DMouseJoint(box2D, body1, body2, target, maxForce, frequencyHz, dampingRatio, collideConnected) {
        if (maxForce === void 0) { maxForce = 0.0; }
        if (frequencyHz === void 0) { frequencyHz = 5.0; }
        if (dampingRatio === void 0) { dampingRatio = 0.7; }
        if (collideConnected === void 0) { collideConnected = false; }
        var _this = _super.call(this, box2D) || this;
        _this.m_vTarget = new dVector2();
        _this.m_fMaxForce = 0;
        _this.m_fFrequencyHz = 0;
        _this.m_fDampingRatio = 0;
        _this.m_body1 = body1;
        _this.m_body2 = body2;
        _this.m_collideConnected = collideConnected;
        _this.m_vTarget = target;
        _this.m_fMaxForce = maxForce;
        _this.m_fFrequencyHz = frequencyHz;
        _this.m_fDampingRatio = dampingRatio;
        var def = new MouseJointDef();
        def.bodyA = body1.m_pBaseBody;
        def.bodyB = body2.m_pBaseBody;
        def.collideConnected = collideConnected;
        def.target.setValue(target.x / dBox2D.PTM_RATIO, target.y / dBox2D.PTM_RATIO);
        def.maxForce = maxForce;
        def.frequencyHz = frequencyHz;
        def.dampingRatio = dampingRatio;
        box2D._CreateJoint(def, _this);
        return _this;
    }
    dBox2DMouseJoint.prototype.SetTarget = function (target) {
        this.m_vTarget = target;
        this.m_pBaseJoint.setTarget(new Vec2(target.x / dBox2D.PTM_RATIO, target.y / dBox2D.PTM_RATIO));
    };
    dBox2DMouseJoint.prototype.GetTarget = function () {
        return this.m_vTarget;
    };
    dBox2DMouseJoint.prototype.SetMaxForce = function (force) {
        this.m_fMaxForce = force;
        this.m_pBaseJoint.setMaxForce(force);
    };
    dBox2DMouseJoint.prototype.GetMaxForce = function () {
        return this.m_fMaxForce;
    };
    dBox2DMouseJoint.prototype.SetFrequency = function (hz) {
        this.m_fFrequencyHz = hz;
        this.m_pBaseJoint.setFrequency(hz);
    };
    dBox2DMouseJoint.prototype.GetFrequency = function () {
        return this.m_fFrequencyHz;
    };
    dBox2DMouseJoint.prototype.SetDampingRatio = function (ratio) {
        this.m_fDampingRatio = ratio;
        this.m_pBaseJoint.setDampingRatio(ratio);
    };
    dBox2DMouseJoint.prototype.GetDampingRatio = function () {
        return this.m_fDampingRatio;
    };
    return dBox2DMouseJoint;
}(dBox2DBaseJoint));
var dBox2DSprite = (function (_super) {
    __extends(dBox2DSprite, _super);
    function dBox2DSprite() {
        var _this = _super.call(this) || this;
        _this.m_pBody = null;
        _this.m_pJoint = null;
        _this.m_nShapeType = dBox2DSprite.ShapeType_None;
        _this.m_bodyType = dBox2DSprite.BodyType_None;
        _this.m_jointType = dBox2DSprite.JointType_None;
        _this.m_density = 0.1;
        _this.m_friction = 0.2;
        _this.m_restitution = 0.0;
        _this.m_isSensor = false;
        _this.m_categoryBits = 0x0001;
        _this.m_maskBits = 0xFFFFFFFF;
        _this.m_groupIndex = 0;
        _this.m_pureColor = false;
        _this.m_fixedRotation = false;
        _this.SetAnchor(0.5, 0.5);
        return _this;
    }
    dBox2DSprite.prototype.GetBody = function () {
        return this.m_pBody;
    };
    dBox2DSprite.prototype.GetJoint = function () {
        return this.m_pJoint;
    };
    dBox2DSprite.prototype.SetShapeType = function (shapeType) {
        this.m_nShapeType = shapeType;
    };
    dBox2DSprite.prototype.GetShapeType = function () {
        return this.m_nShapeType;
    };
    dBox2DSprite.prototype.SetBodyType = function (type) {
        this.m_bodyType = type;
        if (this.m_pBody)
            this.m_pBody.SetType(this.m_bodyType - 1);
    };
    dBox2DSprite.prototype.GetBodyType = function () {
        return this.m_bodyType;
    };
    dBox2DSprite.prototype.SetJointType = function (type) {
        this.m_jointType = type;
    };
    dBox2DSprite.prototype.GetJointType = function () {
        return this.m_jointType;
    };
    dBox2DSprite.prototype.SetDensity = function (value) {
        this.m_density = value;
    };
    dBox2DSprite.prototype.GetDensity = function () {
        return this.m_density;
    };
    dBox2DSprite.prototype.SetFriction = function (value) {
        this.m_friction = value;
    };
    dBox2DSprite.prototype.GetFriction = function () {
        return this.m_friction;
    };
    dBox2DSprite.prototype.SetRestitution = function (value) {
        this.m_restitution = value;
    };
    dBox2DSprite.prototype.GetRestitution = function () {
        return this.m_restitution;
    };
    dBox2DSprite.prototype.SetSensor = function (value) {
        this.m_isSensor = value;
    };
    dBox2DSprite.prototype.isSensor = function () {
        return this.m_isSensor;
    };
    dBox2DSprite.prototype.SetCategoryBits = function (value) {
        this.m_categoryBits = value;
        if (this.m_pBody)
            this.m_pBody.SetCategoryBits(value);
    };
    dBox2DSprite.prototype.GetCategoryBits = function () {
        return this.m_categoryBits;
    };
    dBox2DSprite.prototype.SetMaskBits = function (value) {
        this.m_maskBits = value;
        if (this.m_pBody)
            this.m_pBody.SetMaskBits(value);
    };
    dBox2DSprite.prototype.GetMaskBits = function () {
        return this.m_maskBits;
    };
    dBox2DSprite.prototype.SetGroupIndex = function (value) {
        this.m_groupIndex = value;
    };
    dBox2DSprite.prototype.GetGroupIndex = function () {
        return this.m_groupIndex;
    };
    dBox2DSprite.prototype.SetPos = function (x, y) {
        if (this.m_fPosX != x || this.m_fPosY != y) {
            _super.prototype.SetPos.call(this, x, y);
            if (this.m_pBody && !this.m_pBody.GetBox2DWorld().m_settingBodyTransform)
                this.m_pBody.SetPos(x, y);
        }
    };
    dBox2DSprite.prototype.SetRotation = function (angle) {
        if (this.m_fRotation != angle) {
            _super.prototype.SetRotation.call(this, angle);
            if (this.m_pBody && !this.m_pBody.GetBox2DWorld().m_settingBodyTransform)
                this.m_pBody.SetRotation(angle);
        }
    };
    dBox2DSprite.prototype.SetFixedRotation = function (isFixed) {
        this.m_fixedRotation = isFixed;
        if (this.m_pBody)
            this.m_pBody.SetFixedRotation(isFixed);
    };
    dBox2DSprite.prototype.isFixedRotation = function () {
        if (this.m_pBody)
            return this.m_pBody.GetFixedRotation();
        return this.m_fixedRotation;
    };
    dBox2DSprite.prototype.InitWorld = function (pWorld) {
        if (this.ChildHasBox2DSprite()) {
            var vec = this.GetChildList();
            for (var i = 0; i < vec.length; i++) {
                vec[i].positionX += this.positionX;
                vec[i].positionY += this.positionY;
            }
            this.SetPos(0, 0);
        }
        if (this.m_bodyType != dBox2DSprite.BodyType_None) {
            var vecShapeS = new Array();
            this.ComputeShapes(this, vecShapeS, new dMatrix().Scaling(this.scaleX, this.scaleY, this.scaleZ));
            this.m_pBody = pWorld.CreateBody(this);
            this.m_pBody.SetType(this.m_bodyType - 1);
            for (var i = 0; i < vecShapeS.length; i++)
                this.m_pBody.AddShape(vecShapeS[i]);
        }
        if (this.m_pBody) {
            this.m_pBody.SetPos(this.positionX, this.positionY);
            this.m_pBody.SetRotation(this.rotation);
            this.m_pBody.SetFixedRotation(this.m_fixedRotation);
        }
        if (this.ChildHasBox2DSprite()) {
            var vec = this.GetChildList();
            for (var i = 0; i < vec.length; i++) {
                if (vec[i] instanceof dBox2DSprite && vec[i].GetBodyType() != dBox2DSprite.BodyType_None)
                    vec[i].InitWorld(pWorld);
            }
        }
    };
    dBox2DSprite.prototype.InitJoint = function (pWorld) {
        if (this.m_jointType == dBox2DSprite.JointType_Revolute) {
            var pLinkOther = this.GetLinkOtherBox2DSprite(0);
            if (pLinkOther) {
                var offsetName = this.spriteName + "JointOffset";
                var pSelfLinkOffset = this.FindChild(offsetName);
                var pLinkOtherOffset = pLinkOther.FindChild(offsetName);
                this.m_pJoint = new dBox2DRevoluteJoint(pWorld, this.GetBody(), pLinkOther.GetBody(), pSelfLinkOffset ? pSelfLinkOffset.positionX : 0, pSelfLinkOffset ? pSelfLinkOffset.positionY : 0, pLinkOtherOffset ? pLinkOtherOffset.positionX : 0, pLinkOtherOffset ? pLinkOtherOffset.positionY : 0);
            }
        }
        else if (this.m_jointType == dBox2DSprite.JointType_Distance) {
            var pLinkOther = this.GetLinkOtherBox2DSprite(0);
            if (pLinkOther) {
                var length = this.GetPosVector2().LengthTo(pLinkOther.GetPosVector2());
                var offsetName = this.spriteName + "JointOffset";
                var pSelfLinkOffset = this.FindChild(offsetName);
                if (pSelfLinkOffset)
                    length -= pSelfLinkOffset.GetPosVector2().Length();
                var pLinkOtherOffset = pLinkOther.FindChild(offsetName);
                if (pLinkOtherOffset)
                    length -= pLinkOtherOffset.GetPosVector2().Length();
                this.m_pJoint = new dBox2DDistanceJoint(pWorld, this.GetBody(), pLinkOther.GetBody(), pSelfLinkOffset ? pSelfLinkOffset.positionX : 0, pSelfLinkOffset ? pSelfLinkOffset.positionY : 0, pLinkOtherOffset ? pLinkOtherOffset.positionX : 0, pLinkOtherOffset ? pLinkOtherOffset.positionY : 0, dMath.Abs(length));
            }
        }
        if (this.ChildHasBox2DSprite()) {
            var vec = this.GetChildList();
            for (var i = 0; i < vec.length; i++) {
                if (vec[i] instanceof dBox2DSprite)
                    vec[i].InitJoint(pWorld);
            }
        }
    };
    dBox2DSprite.prototype.UpdateShape = function (shapeName) {
        if (this.GetBody()) {
            var vecShapeS = new Array();
            this.ComputeShapes(this, vecShapeS, new dMatrix().Scaling(this.scaleX, this.scaleY, this.scaleZ));
            for (var i = 0; i < vecShapeS.length; i++) {
                if (shapeName == null || vecShapeS[i].shapeName == shapeName) {
                    vecShapeS[i].pFixture = this.GetBody().GetShape(i).pFixture;
                    this.GetBody().UpdateShape(vecShapeS[i]);
                }
            }
        }
    };
    dBox2DSprite.prototype.GetLinkOtherBox2DSprite = function (at) {
        if (at === void 0) { at = 0; }
        var pLinks = this.GetLinkList();
        if (pLinks && at >= 0 && at < pLinks.length && pLinks[at] instanceof dBox2DSprite)
            return pLinks[at];
        return null;
    };
    dBox2DSprite.prototype.ChildHasBox2DSprite = function () {
        var vec = this.GetChildList();
        for (var i = 0; i < vec.length; i++)
            if (vec[i] instanceof dBox2DSprite && vec[i].GetBodyType() != dBox2DSprite.BodyType_None)
                return true;
        return false;
    };
    dBox2DSprite.prototype.ComputeShapes = function (p, vec, matSelf) {
        var pShape = null;
        switch (p.m_nShapeType) {
            case dBox2DSprite.ShapeType_Box:
                var left = -p.width * p.anchorU;
                var top = -p.height * p.anchorV;
                var right = p.width * (1 - p.anchorU);
                var bottom = p.height * (1 - p.anchorV);
                var v1 = new dVector2(left, top);
                v1.Transform(matSelf);
                var v2 = new dVector2(right, bottom);
                v2.Transform(matSelf);
                var rc = new dRect(v1.x, v1.y, v2.x, v2.y);
                rc.MakeValidSize();
                pShape = new dBox2DBoxShape(rc.left, rc.top, rc.right, rc.bottom, this.m_density, this.m_friction, this.m_restitution, p.m_isSensor, this.m_categoryBits, this.m_maskBits, this.m_groupIndex);
                pShape.shapeName = p.spriteName;
                break;
            case dBox2DSprite.ShapeType_Circle:
                var scale = new dVector3();
                var pos = new dVector3();
                matSelf.Decompose(pos, scale, null);
                pShape = new dBox2DCircleShape(p.width * 0.5 * scale.x, pos.x, pos.y, this.m_density, this.m_friction, this.m_restitution, p.m_isSensor, this.m_categoryBits, this.m_maskBits, this.m_groupIndex);
                pShape.shapeName = p.spriteName;
                break;
            case dBox2DSprite.ShapeType_Polygon:
                var edgeFirst = p.FindChild("Edge1");
                if (edgeFirst) {
                    var edgeCur = edgeFirst;
                    var edgePrev = null;
                    var edgeNext = this.GetLinkSpriteExceptT(edgeCur, edgePrev);
                    var vertices = new Array();
                    vertices.push(edgeCur.GetPosVector2().Transform(matSelf));
                    while (edgeNext) {
                        var v2 = edgeNext.GetPosVector2();
                        v2.Transform(matSelf);
                        vertices.push(v2);
                        if (edgeNext == edgeFirst)
                            break;
                        edgePrev = edgeCur;
                        edgeCur = edgeNext;
                        edgeNext = this.GetLinkSpriteExceptT(edgeCur, edgePrev);
                    }
                    pShape = new dBox2DPolygonShape(vertices, this.m_density, this.m_friction, this.m_restitution, p.m_isSensor, this.m_categoryBits, this.m_maskBits, this.m_groupIndex);
                    pShape.shapeName = p.spriteName;
                }
                else {
                    var left = -p.width * p.anchorU;
                    var top = -p.height * p.anchorV;
                    var right = p.width * (1 - p.anchorU);
                    var bottom = p.height * (1 - p.anchorV);
                    var vertices = [new dVector2(left, top), new dVector2(right, top), new dVector2(right, bottom), new dVector2(left, bottom)];
                    for (var i = 0; i < vertices.length; i++)
                        vertices[i].Transform(matSelf);
                    pShape = new dBox2DPolygonShape(vertices, this.m_density, this.m_friction, this.m_restitution, p.m_isSensor, this.m_categoryBits, this.m_maskBits, this.m_groupIndex);
                    pShape.shapeName = p.spriteName;
                }
                break;
            case dBox2DSprite.ShapeType_Edge:
                var edgeFirst = p.FindChild("Edge1");
                if (edgeFirst) {
                    var edgeCur = edgeFirst;
                    var edgePrev = null;
                    var edgeNext = this.GetLinkSpriteExceptT(edgeCur, edgePrev);
                    while (edgeNext) {
                        var v1 = edgeCur.GetPosVector2();
                        var v2 = edgeNext.GetPosVector2();
                        v1.Transform(matSelf);
                        v2.Transform(matSelf);
                        pShape = new dBox2DEdgeShape(v1, v2, null, null, this.m_density, this.m_friction, this.m_restitution, this.m_isSensor, this.m_categoryBits, this.m_maskBits, this.m_groupIndex);
                        vec.push(pShape);
                        if (edgeNext == edgeFirst)
                            break;
                        edgePrev = edgeCur;
                        edgeCur = edgeNext;
                        edgeNext = this.GetLinkSpriteExceptT(edgeCur, edgePrev);
                    }
                    pShape = null;
                }
                break;
        }
        var list = p.GetChildList();
        for (var i = 0; i < list.length; i++) {
            if (list[i] instanceof dBox2DSprite) {
                this.ComputeShapes(list[i], vec, list[i].GetMatrixLocal().Mul(matSelf));
            }
        }
        if (pShape)
            vec.push(pShape);
    };
    dBox2DSprite.prototype.GetLinkSpriteExceptT = function (p, except) {
        var list = p.GetLinkList();
        if (!list)
            return null;
        for (var i = 0; i < list.length; i++) {
            if (list[i] == except)
                continue;
            return list[i];
        }
        return null;
    };
    Object.defineProperty(dBox2DSprite.prototype, "pureColor", {
        get: function () {
            return this.m_pureColor;
        },
        set: function (bSet) {
            this.m_pureColor = bSet;
            if (this.m_pureColor)
                this.SetBitmapData(dBitmapData.WHITE_BITMAPDATA);
            else
                this.SetBitmapData(null);
        },
        enumerable: false,
        configurable: true
    });
    dBox2DSprite.prototype.AddShapeByLine = function (line, offset) {
        if (offset === void 0) { offset = null; }
        var list = line.GetLineList();
        for (var i = 0; i < line.GetLineCount(); i++) {
            var p = new dBox2DSprite();
            if (offset)
                p.SetPosVector2(new dVector2(list[i].positionX, list[i].positionY).Transform(offset));
            else
                p.SetPos(list[i].positionX, list[i].positionY);
            p.SetSize(list[i].width, list[i].height);
            p.SetRotation(list[i].rotation);
            p.SetAnchor(list[i].anchorU, list[i].anchorV);
            p.SetShapeType(dBox2DSprite.ShapeType_Polygon);
            p.SetSensor(this.isSensor());
            this.AddChild(p);
        }
    };
    dBox2DSprite.prototype.LoadFromJson = function (json) {
        _super.prototype.LoadFromJson.call(this, json);
        if (json.hasOwnProperty("shapeType"))
            this.SetShapeType(Number(json.shapeType));
        if (json.hasOwnProperty("bodyType"))
            this.SetBodyType(Number(json.bodyType));
        if (json.hasOwnProperty("jointType"))
            this.SetJointType(Number(json.jointType));
        if (json.hasOwnProperty("density"))
            this.SetDensity(Number(json.density));
        if (json.hasOwnProperty("friction"))
            this.SetFriction(Number(json.friction));
        if (json.hasOwnProperty("restitution"))
            this.SetRestitution(Number(json.restitution));
        if (json.hasOwnProperty("isSensor"))
            this.SetSensor(Boolean(json.isSensor));
        if (json.hasOwnProperty("categoryBits"))
            this.SetCategoryBits(Number(json.categoryBits));
        if (json.hasOwnProperty("maskBits"))
            this.SetMaskBits(Number(json.maskBits));
        if (json.hasOwnProperty("groupIndex"))
            this.SetGroupIndex(Number(json.groupIndex));
        if (json.hasOwnProperty("pureColor"))
            this.pureColor = json.pureColor;
        if (json.hasOwnProperty("fixedRotation"))
            this.SetFixedRotation(Boolean(json.fixedRotation));
    };
    dBox2DSprite.ShapeType_None = 0;
    dBox2DSprite.ShapeType_Box = 1;
    dBox2DSprite.ShapeType_Edge = 2;
    dBox2DSprite.ShapeType_Circle = 3;
    dBox2DSprite.ShapeType_Polygon = 4;
    dBox2DSprite.BodyType_None = 0;
    dBox2DSprite.BodyType_Static = 1;
    dBox2DSprite.BodyType_Kinematic = 2;
    dBox2DSprite.BodyType_Dynamic = 3;
    dBox2DSprite.JointType_None = 0;
    dBox2DSprite.JointType_Revolute = 1;
    dBox2DSprite.JointType_Distance = 2;
    dBox2DSprite.JointType_Pulley = 3;
    dBox2DSprite.JointType_Gear = 4;
    dBox2DSprite.JointType_Mouse = 5;
    return dBox2DSprite;
}(dSprite));
var ContactFilter = (function () {
    function ContactFilter() {
    }
    ContactFilter.prototype.shouldCollide = function (fixtureA, fixtureB) {
        var filterA = fixtureA.getFilterData();
        var filterB = fixtureB.getFilterData();
        if (filterA.groupIndex == filterB.groupIndex && filterA.groupIndex != 0) {
            return filterA.groupIndex > 0;
        }
        var collide = (filterA.maskBits & filterB.categoryBits) != 0 &&
            (filterA.categoryBits & filterB.maskBits) != 0;
        return collide;
    };
    return ContactFilter;
}());
var ContactImpulse = (function () {
    function ContactImpulse() {
        this.normalImpulses = new Array(Settings.maxManifoldPoints);
        this.tangentImpulses = new Array(Settings.maxManifoldPoints);
        this.count = 0;
    }
    return ContactImpulse;
}());
var ContactListener = (function () {
    function ContactListener() {
    }
    ContactListener.prototype.beginContact = function (contact) {
    };
    ContactListener.prototype.endContact = function (contact) {
    };
    ContactListener.prototype.preSolve = function (contact, oldManifold) {
    };
    ContactListener.prototype.postSolve = function (contact, impulse) {
    };
    return ContactListener;
}());
var DestructionListener = (function () {
    function DestructionListener() {
    }
    DestructionListener.prototype.sayGoodbyeJoint = function (joint) {
    };
    DestructionListener.prototype.sayGoodbyeFixture = function (fixture) {
    };
    return DestructionListener;
}());
var PairCallback = (function () {
    function PairCallback() {
    }
    PairCallback.prototype.addPair = function (userDataA, userDataB) {
    };
    return PairCallback;
}());
var QueryCallback = (function () {
    function QueryCallback() {
    }
    QueryCallback.prototype.reportFixture = function (fixture) {
        return false;
    };
    return QueryCallback;
}());
var RayCastCallback = (function () {
    function RayCastCallback() {
    }
    RayCastCallback.prototype.reportFixture = function (fixture, point, normal, fraction) {
        return 0;
    };
    return RayCastCallback;
}());
var BroadPhase = (function () {
    function BroadPhase() {
    }
    BroadPhase.prototype.createProxy = function (aabb, userData) {
        return 0;
    };
    BroadPhase.prototype.destroyProxy = function (proxyId) {
    };
    BroadPhase.prototype.moveProxy = function (proxyId, aabb, displacement) {
    };
    BroadPhase.prototype.touchProxy = function (proxyId) {
    };
    BroadPhase.prototype.getUserData = function (proxyId) {
        return null;
    };
    BroadPhase.prototype.getFatAABB = function (proxyId) {
        return null;
    };
    BroadPhase.prototype.testOverlap = function (proxyIdA, proxyIdB) {
        return false;
    };
    BroadPhase.prototype.getProxyCount = function () {
        return 0;
    };
    BroadPhase.prototype.updatePairs = function (callback) {
    };
    BroadPhase.prototype.query = function (callback, aabb) {
    };
    BroadPhase.prototype.raycast = function (callback, input) {
    };
    BroadPhase.prototype.getTreeHeight = function () {
        return 0;
    };
    BroadPhase.prototype.getTreeBalance = function () {
        return 0;
    };
    BroadPhase.prototype.getTreeQuality = function () {
        return 0;
    };
    return BroadPhase;
}());
var TreeCallback = (function (_super) {
    __extends(TreeCallback, _super);
    function TreeCallback() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    TreeCallback.prototype.treeCallback = function (proxyId) {
        return false;
    };
    return TreeCallback;
}(BroadPhase));
var TreeRayCastCallback = (function () {
    function TreeRayCastCallback() {
    }
    TreeRayCastCallback.prototype.raycastCallback = function (input, nodeId) {
        return 0;
    };
    return TreeRayCastCallback;
}());
var AABB = (function () {
    function AABB() {
        this.lowerBound = null;
        this.upperBound = null;
        this.lowerBound = new Vec2();
        this.upperBound = new Vec2();
    }
    AABB.prototype.Copy = function (copy) {
        this.CopyFromVec2(copy.lowerBound, copy.upperBound);
        return this;
    };
    AABB.prototype.CopyFromVec2 = function (lowerVertex, upperVertex) {
        this.lowerBound = lowerVertex.clone();
        this.upperBound = upperVertex.clone();
        return this;
    };
    AABB.prototype.set = function (aabb) {
        var v = aabb.lowerBound;
        this.lowerBound.x = v.x;
        this.lowerBound.y = v.y;
        var v1 = aabb.upperBound;
        this.upperBound.x = v1.x;
        this.upperBound.y = v1.y;
    };
    AABB.prototype.isValid = function () {
        var dx = this.upperBound.x - this.lowerBound.x;
        if (dx < 0) {
            return false;
        }
        var dy = this.upperBound.y - this.lowerBound.y;
        if (dy < 0) {
            return false;
        }
        return this.lowerBound.isValid() && this.upperBound.isValid();
    };
    AABB.prototype.getCenter = function () {
        var center = new Vec2(this.lowerBound.x, this.lowerBound.y);
        center.addLocal(this.upperBound);
        center.mulLocal(0.5);
        return center;
    };
    AABB.prototype.getCenterToOut = function (outData2) {
        outData2.x = (this.lowerBound.x + this.upperBound.x) * 0.5;
        outData2.y = (this.lowerBound.y + this.upperBound.y) * 0.5;
    };
    AABB.prototype.getExtents = function () {
        var center = new Vec2(this.upperBound.x, this.upperBound.y);
        center.subLocal(this.lowerBound);
        center.mulLocal(0.5);
        return center;
    };
    AABB.prototype.getExtentsToOut = function (outData2) {
        outData2.x = (this.upperBound.x - this.lowerBound.x) * 0.5;
        outData2.y = (this.upperBound.y - this.lowerBound.y) * 0.5;
    };
    AABB.prototype.getVertices = function (argRay) {
        argRay[0].set(this.lowerBound);
        argRay[1].set(this.lowerBound);
        argRay[1].x += this.upperBound.x - this.lowerBound.x;
        argRay[2].set(this.upperBound);
        argRay[3].set(this.upperBound);
        argRay[3].x -= this.upperBound.x - this.lowerBound.x;
    };
    AABB.prototype.combine2 = function (aabb1, aab) {
        this.lowerBound.x = aabb1.lowerBound.x < aab.lowerBound.x ? aabb1.lowerBound.x : aab.lowerBound.x;
        this.lowerBound.y = aabb1.lowerBound.y < aab.lowerBound.y ? aabb1.lowerBound.y : aab.lowerBound.y;
        this.upperBound.x = aabb1.upperBound.x > aab.upperBound.x ? aabb1.upperBound.x : aab.upperBound.x;
        this.upperBound.y = aabb1.upperBound.y > aab.upperBound.y ? aabb1.upperBound.y : aab.upperBound.y;
    };
    AABB.prototype.getPerimeter = function () {
        return 2.0 * (this.upperBound.x - this.lowerBound.x + this.upperBound.y - this.lowerBound.y);
    };
    AABB.prototype.combine = function (aabb) {
        this.lowerBound.x = this.lowerBound.x < aabb.lowerBound.x ? this.lowerBound.x : aabb.lowerBound.x;
        this.lowerBound.y = this.lowerBound.y < aabb.lowerBound.y ? this.lowerBound.y : aabb.lowerBound.y;
        this.upperBound.x = this.upperBound.x > aabb.upperBound.x ? this.upperBound.x : aabb.upperBound.x;
        this.upperBound.y = this.upperBound.y > aabb.upperBound.y ? this.upperBound.y : aabb.upperBound.y;
    };
    AABB.prototype.contains = function (aabb) {
        return this.lowerBound.x <= aabb.lowerBound.x && this.lowerBound.y <= aabb.lowerBound.y
            && aabb.upperBound.x <= this.upperBound.x && aabb.upperBound.y <= this.upperBound.y;
    };
    AABB.prototype.raycast = function (output, input, argPool) {
        if (argPool === void 0) { argPool = null; }
        if (argPool == null)
            argPool = new DefaultWorldPool(4);
        var tmin = -dMath.dFLOAT_MAX;
        var tmax = dMath.dFLOAT_MAX;
        var p = argPool.popVec2();
        var d = argPool.popVec2();
        var absD = argPool.popVec2();
        var normal = argPool.popVec2();
        p.set(input.p1);
        d.set(input.p2).subLocal(input.p1);
        Vec2.absToOut(d, absD);
        if (absD.x < Settings.EPSILON) {
            if (p.x < this.lowerBound.x || this.upperBound.x < p.x) {
                argPool.pushVec2(4);
                return false;
            }
        }
        else {
            var inv_d = 1.0 / d.x;
            var t1 = (this.lowerBound.x - p.x) * inv_d;
            var t2 = (this.upperBound.x - p.x) * inv_d;
            var s = -1.0;
            if (t1 > t2) {
                var temp = t1;
                t1 = t2;
                t2 = temp;
                s = 1.0;
            }
            if (t1 > tmin) {
                normal.setZero();
                normal.x = s;
                tmin = t1;
            }
            tmax = dMath.Min(tmax, t2);
            if (tmin > tmax) {
                argPool.pushVec2(4);
                return false;
            }
        }
        if (absD.y < Settings.EPSILON) {
            if (p.y < this.lowerBound.y || this.upperBound.y < p.y) {
                argPool.pushVec2(4);
                return false;
            }
        }
        else {
            var inv_d = 1.0 / d.y;
            var t1 = (this.lowerBound.y - p.y) * inv_d;
            var t2 = (this.upperBound.y - p.y) * inv_d;
            var s = -1.0;
            if (t1 > t2) {
                var temp = t1;
                t1 = t2;
                t2 = temp;
                s = 1.0;
            }
            if (t1 > tmin) {
                normal.setZero();
                normal.y = s;
                tmin = t1;
            }
            tmax = dMath.Min(tmax, t2);
            if (tmin > tmax) {
                argPool.pushVec2(4);
                return false;
            }
        }
        if (tmin < 0.0 || input.maxFraction < tmin) {
            argPool.pushVec2(4);
            return false;
        }
        output.fraction = tmin;
        output.normal.x = normal.x;
        output.normal.y = normal.y;
        argPool.pushVec2(4);
        return true;
    };
    AABB.testOverlap = function (a, b) {
        if (b.lowerBound.x - a.upperBound.x > 0.0 || b.lowerBound.y - a.upperBound.y > 0.0) {
            return false;
        }
        if (a.lowerBound.x - b.upperBound.x > 0.0 || a.lowerBound.y - b.upperBound.y > 0.0) {
            return false;
        }
        return true;
    };
    return AABB;
}());
var Vec2 = (function () {
    function Vec2(x, y) {
        if (x === void 0) { x = 0; }
        if (y === void 0) { y = 0; }
        this.x = 0;
        this.y = 0;
        this.x = x;
        this.y = y;
    }
    Vec2.prototype.setZero = function () {
        this.x = 0.0;
        this.y = 0.0;
    };
    Vec2.prototype.setValue = function (x, y) {
        this.x = x;
        this.y = y;
        return this;
    };
    Vec2.prototype.set = function (v) {
        this.x = v.x;
        this.y = v.y;
        return this;
    };
    Vec2.prototype.add = function (v) {
        return new Vec2(this.x + v.x, this.y + v.y);
    };
    Vec2.prototype.sub = function (v) {
        return new Vec2(this.x - v.x, this.y - v.y);
    };
    Vec2.prototype.mul = function (a) {
        return new Vec2(this.x * a, this.y * a);
    };
    Vec2.prototype.negate = function () {
        return new Vec2(-this.x, -this.y);
    };
    Vec2.prototype.negateLocal = function () {
        this.x = -this.x;
        this.y = -this.y;
        return this;
    };
    Vec2.prototype.addLocal = function (v) {
        this.x += v.x;
        this.y += v.y;
        return this;
    };
    Vec2.prototype.addLocalValue = function (x, y) {
        this.x += x;
        this.y += y;
        return this;
    };
    Vec2.prototype.subLocal = function (v) {
        this.x -= v.x;
        this.y -= v.y;
        return this;
    };
    Vec2.prototype.mulLocal = function (a) {
        this.x *= a;
        this.y *= a;
        return this;
    };
    Vec2.prototype.skew = function () {
        return new Vec2(-this.y, this.x);
    };
    Vec2.prototype.skew__2 = function (outData) {
        outData.x = -this.y;
        outData.y = this.x;
    };
    Vec2.prototype.length = function () {
        return MathUtils.sqrt(this.x * this.x + this.y * this.y);
    };
    Vec2.prototype.lengthSquared = function () {
        return (this.x * this.x + this.y * this.y);
    };
    Vec2.prototype.normalize = function () {
        var length = this.length();
        if (length < Settings.EPSILON) {
            return 0;
        }
        var invLength = 1.0 / length;
        this.x *= invLength;
        this.y *= invLength;
        return length;
    };
    Vec2.prototype.isValid = function () {
        return !Number.isNaN(this.x) && !Number.isNaN(this.y);
    };
    Vec2.prototype.abs = function () {
        return new Vec2(dMath.Abs(this.x), dMath.Abs(this.y));
    };
    Vec2.prototype.absLocal = function () {
        this.x = dMath.Abs(this.x);
        this.y = dMath.Abs(this.y);
    };
    Vec2.prototype.clone = function () {
        return new Vec2(this.x, this.y);
    };
    Vec2.absToOut = function (a, outData) {
        outData.x = dMath.Abs(a.x);
        outData.y = dMath.Abs(a.y);
    };
    Vec2.dot = function (a, b) {
        return a.x * b.x + a.y * b.y;
    };
    Vec2.cross = function (a, b) {
        return a.x * b.y - a.y * b.x;
    };
    Vec2.cross__2 = function (a, s) {
        return new Vec2(s * a.y, -s * a.x);
    };
    Vec2.crossToOut = function (a, s, outData) {
        var tempy = -s * a.x;
        outData.x = s * a.y;
        outData.y = tempy;
    };
    Vec2.crossToOutUnsafe = function (a, s, outData) {
        outData.x = s * a.y;
        outData.y = -s * a.x;
    };
    Vec2.crossF = function (s, a) {
        return new Vec2(-s * a.y, s * a.x);
    };
    Vec2.crossToOut__2 = function (s, a, outData) {
        var tempY = s * a.x;
        outData.x = -s * a.y;
        outData.y = tempY;
    };
    Vec2.crossToOutUnsafe__2 = function (s, a, outData) {
        outData.x = -s * a.y;
        outData.y = s * a.x;
    };
    Vec2.negateToOut = function (a, outData) {
        outData.x = -a.x;
        outData.y = -a.y;
    };
    Vec2.min = function (a, b) {
        return new Vec2(a.x < b.x ? a.x : b.x, a.y < b.y ? a.y : b.y);
    };
    Vec2.max = function (a, b) {
        return new Vec2(a.x > b.x ? a.x : b.x, a.y > b.y ? a.y : b.y);
    };
    Vec2.minToOut = function (a, b, outData) {
        outData.x = a.x < b.x ? a.x : b.x;
        outData.y = a.y < b.y ? a.y : b.y;
    };
    Vec2.maxToOut = function (a, b, outData) {
        outData.x = a.x > b.x ? a.x : b.x;
        outData.y = a.y > b.y ? a.y : b.y;
    };
    return Vec2;
}());
var Collision = (function () {
    function Collision(argPool) {
        this.pool = null;
        this.input = new DistanceInput();
        this.cache = new DistanceSimplexCache();
        this.output = new DistanceOutput();
        this.temp = new Vec2();
        this.xf = new Transform();
        this.n = new Vec2();
        this.v1 = new Vec2();
        this.results1 = new CollisionEdgeResults();
        this.results2 = new CollisionEdgeResults();
        this.incidentEdge = new Array(2);
        this.localTangent = new Vec2();
        this.localNormal = new Vec2();
        this.planePoint = new Vec2();
        this.tangent = new Vec2();
        this.v11 = new Vec2();
        this.v12 = new Vec2();
        this.clipPoints1 = new Array(2);
        this.clipPoints2 = new Array(2);
        this.Q = new Vec2();
        this.e = new Vec2();
        this.cf = new ContactID();
        this.e1 = new Vec2();
        this.P = new Vec2();
        this.collider = new CollisionEPCollider();
        this.incidentEdge[0] = new CollisionClipVertex();
        this.incidentEdge[1] = new CollisionClipVertex();
        this.clipPoints1[0] = new CollisionClipVertex();
        this.clipPoints1[1] = new CollisionClipVertex();
        this.clipPoints2[0] = new CollisionClipVertex();
        this.clipPoints2[1] = new CollisionClipVertex();
        this.pool = argPool;
    }
    Collision.prototype.testOverlap = function (shapeA, indexA, shapeB, indexB, xfA, xfB) {
        this.input.proxyA.set(shapeA, indexA);
        this.input.proxyB.set(shapeB, indexB);
        this.input.transformA.set(xfA);
        this.input.transformB.set(xfB);
        this.input.useRadii = true;
        this.cache.count = 0;
        this.pool.getDistance().distance(this.output, this.cache, this.input);
        return this.output.distance < 10.0 * Settings.EPSILON;
    };
    Collision.prototype.getPointStates = function (state1, state2, manifold1, manifold2) {
        for (var i = 0; i < Settings.maxManifoldPoints; i++) {
            state1[i] = CollisionPointState.NULL_STATE;
            state2[i] = CollisionPointState.NULL_STATE;
        }
        for (var i = 0; i < manifold1.pointCount; i++) {
            var id = manifold1.points[i].id;
            state1[i] = CollisionPointState.REMOVE_STATE;
            for (var j = 0; j < manifold2.pointCount; j++) {
                if (manifold2.points[j].id.isEqual(id)) {
                    state1[i] = CollisionPointState.PERSIST_STATE;
                    break;
                }
            }
        }
        for (var i = 0; i < manifold2.pointCount; i++) {
            var id = manifold2.points[i].id;
            state2[i] = CollisionPointState.ADD_STATE;
            for (var j = 0; j < manifold1.pointCount; j++) {
                if (manifold1.points[j].id.isEqual(id)) {
                    state2[i] = CollisionPointState.PERSIST_STATE;
                    break;
                }
            }
        }
    };
    Collision.clipSegmentToLine = function (vOut, vIn, normal, offset, vertexIndexA) {
        var numOut = 0;
        var vIn0 = vIn[0];
        var vIn1 = vIn[1];
        var vIn0v = vIn0.v;
        var vIn1v = vIn1.v;
        var distance0 = Vec2.dot(normal, vIn0v) - offset;
        var distance1 = Vec2.dot(normal, vIn1v) - offset;
        if (distance0 <= 0.0) {
            vOut[numOut++].set(vIn0);
        }
        if (distance1 <= 0.0) {
            vOut[numOut++].set(vIn1);
        }
        if (distance0 * distance1 < 0.0) {
            var interp = distance0 / (distance0 - distance1);
            var vOutNO = vOut[numOut];
            vOutNO.v.x = vIn0v.x + interp * (vIn1v.x - vIn0v.x);
            vOutNO.v.y = vIn0v.y + interp * (vIn1v.y - vIn0v.y);
            vOutNO.id.indexA = vertexIndexA;
            vOutNO.id.indexB = vIn0.id.indexB;
            vOutNO.id.typeA = ContactID.Type_VERTEX;
            vOutNO.id.typeB = ContactID.Type_FACE;
            ++numOut;
        }
        return numOut;
    };
    Collision.prototype.collideCircles = function (manifold, circle1, xfA, circle2, xfB) {
        manifold.pointCount = 0;
        var circle1p = circle1.m_p;
        var circle2p = circle2.m_p;
        var pAx = (xfA.q.c * circle1p.x - xfA.q.s * circle1p.y) + xfA.p.x;
        var pAy = (xfA.q.s * circle1p.x + xfA.q.c * circle1p.y) + xfA.p.y;
        var pBx = (xfB.q.c * circle2p.x - xfB.q.s * circle2p.y) + xfB.p.x;
        var pBy = (xfB.q.s * circle2p.x + xfB.q.c * circle2p.y) + xfB.p.y;
        var dx = pBx - pAx;
        var dy = pBy - pAy;
        var distSqr = dx * dx + dy * dy;
        var radius = circle1.m_radius + circle2.m_radius;
        if (distSqr > radius * radius) {
            return;
        }
        manifold.type = Manifold.ManifoldType_CIRCLES;
        manifold.localPoint.set(circle1p);
        manifold.localNormal.setZero();
        manifold.pointCount = 1;
        manifold.points[0].localPoint.set(circle2p);
        manifold.points[0].id.zero();
    };
    Collision.prototype.collidePolygonAndCircle = function (manifold, polygon, xfA, circle, xfB) {
        manifold.pointCount = 0;
        var circlep = circle.m_p;
        var xfBq = xfB.q;
        var xfAq = xfA.q;
        var cx = (xfBq.c * circlep.x - xfBq.s * circlep.y) + xfB.p.x;
        var cy = (xfBq.s * circlep.x + xfBq.c * circlep.y) + xfB.p.y;
        var px = cx - xfA.p.x;
        var py = cy - xfA.p.y;
        var cLocalx = (xfAq.c * px + xfAq.s * py);
        var cLocaly = (-xfAq.s * px + xfAq.c * py);
        var normalIndex = 0;
        var separation = -dMath.dFLOAT_MAX;
        var radius = polygon.m_radius + circle.m_radius;
        var vertexCount = polygon.m_count;
        var s = 0;
        var vertices = polygon.m_vertices;
        var normals = polygon.m_normals;
        for (var i = 0; i < vertexCount; i++) {
            var vertex = vertices[i];
            var tempx = cLocalx - vertex.x;
            var tempy = cLocaly - vertex.y;
            s = normals[i].x * tempx + normals[i].y * tempy;
            if (s > radius) {
                return;
            }
            if (s > separation) {
                separation = s;
                normalIndex = i;
            }
        }
        var vertIndex1 = normalIndex;
        var vertIndex2 = vertIndex1 + 1 < vertexCount ? vertIndex1 + 1 : 0;
        var v1 = vertices[vertIndex1];
        var v2 = vertices[vertIndex2];
        if (separation < Settings.EPSILON) {
            manifold.pointCount = 1;
            manifold.type = Manifold.ManifoldType_FACE_A;
            var normal = normals[normalIndex];
            manifold.localNormal.x = normal.x;
            manifold.localNormal.y = normal.y;
            manifold.localPoint.x = (v1.x + v2.x) * 0.5;
            manifold.localPoint.y = (v1.y + v2.y) * 0.5;
            var mpoint = manifold.points[0];
            mpoint.localPoint.x = circlep.x;
            mpoint.localPoint.y = circlep.y;
            mpoint.id.zero();
            return;
        }
        var tempX = cLocalx - v1.x;
        var tempY = cLocaly - v1.y;
        var temp2X = v2.x - v1.x;
        var temp2Y = v2.y - v1.y;
        var u1 = tempX * temp2X + tempY * temp2Y;
        var temp3X = cLocalx - v2.x;
        var temp3Y = cLocaly - v2.y;
        var temp4X = v1.x - v2.x;
        var temp4Y = v1.y - v2.y;
        var u2 = temp3X * temp4X + temp3Y * temp4Y;
        if (u1 <= 0) {
            var dx = cLocalx - v1.x;
            var dy = cLocaly - v1.y;
            if (dx * dx + dy * dy > radius * radius) {
                return;
            }
            manifold.pointCount = 1;
            manifold.type = Manifold.ManifoldType_FACE_A;
            manifold.localNormal.x = cLocalx - v1.x;
            manifold.localNormal.y = cLocaly - v1.y;
            manifold.localNormal.normalize();
            manifold.localPoint.set(v1);
            manifold.points[0].localPoint.set(circlep);
            manifold.points[0].id.zero();
        }
        else if (u2 <= 0.0) {
            var dx = cLocalx - v2.x;
            var dy = cLocaly - v2.y;
            if (dx * dx + dy * dy > radius * radius) {
                return;
            }
            manifold.pointCount = 1;
            manifold.type = Manifold.ManifoldType_FACE_A;
            manifold.localNormal.x = cLocalx - v2.x;
            manifold.localNormal.y = cLocaly - v2.y;
            manifold.localNormal.normalize();
            manifold.localPoint.set(v2);
            manifold.points[0].localPoint.set(circlep);
            manifold.points[0].id.zero();
        }
        else {
            var fcx = (v1.x + v2.x) * 0.5;
            var fcy = (v1.y + v2.y) * 0.5;
            var tx = cLocalx - fcx;
            var ty = cLocaly - fcy;
            var normal = normals[vertIndex1];
            separation = tx * normal.x + ty * normal.y;
            if (separation > radius) {
                return;
            }
            manifold.pointCount = 1;
            manifold.type = Manifold.ManifoldType_FACE_A;
            manifold.localNormal.set(normals[vertIndex1]);
            manifold.localPoint.x = fcx;
            manifold.localPoint.y = fcy;
            manifold.points[0].localPoint.set(circlep);
            manifold.points[0].id.zero();
        }
    };
    Collision.prototype.findMaxSeparation = function (results, poly1, xf1, poly2, xf2) {
        var count1 = poly1.m_count;
        var count2 = poly2.m_count;
        var n1s = poly1.m_normals;
        var v1s = poly1.m_vertices;
        var v2s = poly2.m_vertices;
        Transform.mulTransToOutUnsafe(xf2, xf1, this.xf);
        var xfq = this.xf.q;
        var bestIndex = 0;
        var maxSeparation = -dMath.dFLOAT_MAX;
        for (var i = 0; i < count1; i++) {
            Rot.mulToOutUnsafe(xfq, n1s[i], this.n);
            Transform.mulToOutUnsafe(this.xf, v1s[i], this.v1);
            var si = dMath.dFLOAT_MAX;
            for (var j = 0; j < count2; ++j) {
                var v2sj = v2s[j];
                var sij = this.n.x * (v2sj.x - this.v1.x) + this.n.y * (v2sj.y - this.v1.y);
                if (sij < si) {
                    si = sij;
                }
            }
            if (si > maxSeparation) {
                maxSeparation = si;
                bestIndex = i;
            }
        }
        results.edgeIndex = bestIndex;
        results.separation = maxSeparation;
    };
    Collision.prototype.findIncidentEdge = function (c, poly1, xf1, edge1, poly2, xf2) {
        var count1 = poly1.m_count;
        var normals1 = poly1.m_normals;
        var count2 = poly2.m_count;
        var vertices2 = poly2.m_vertices;
        var normals2 = poly2.m_normals;
        var c0 = c[0];
        var c1 = c[1];
        var xf1q = xf1.q;
        var xf2q = xf2.q;
        var v = normals1[edge1];
        var tempx = xf1q.c * v.x - xf1q.s * v.y;
        var tempy = xf1q.s * v.x + xf1q.c * v.y;
        var normal1x = xf2q.c * tempx + xf2q.s * tempy;
        var normal1y = -xf2q.s * tempx + xf2q.c * tempy;
        var index = 0;
        var minDot = dMath.dFLOAT_MAX;
        for (var i = 0; i < count2; ++i) {
            var b = normals2[i];
            var dot = normal1x * b.x + normal1y * b.y;
            if (dot < minDot) {
                minDot = dot;
                index = i;
            }
        }
        var i1 = index;
        var i2 = i1 + 1 < count2 ? i1 + 1 : 0;
        var v1 = vertices2[i1];
        var outData = c0.v;
        outData.x = (xf2q.c * v1.x - xf2q.s * v1.y) + xf2.p.x;
        outData.y = (xf2q.s * v1.x + xf2q.c * v1.y) + xf2.p.y;
        c0.id.indexA = edge1;
        c0.id.indexB = i1;
        c0.id.typeA = ContactID.Type_FACE;
        c0.id.typeB = ContactID.Type_VERTEX;
        var v2 = vertices2[i2];
        var outData1 = c1.v;
        outData1.x = (xf2q.c * v2.x - xf2q.s * v2.y) + xf2.p.x;
        outData1.y = (xf2q.s * v2.x + xf2q.c * v2.y) + xf2.p.y;
        c1.id.indexA = edge1;
        c1.id.indexB = i2;
        c1.id.typeA = ContactID.Type_FACE;
        c1.id.typeB = ContactID.Type_VERTEX;
    };
    Collision.prototype.collidePolygons = function (manifold, polyA, xfA, polyB, xfB) {
        manifold.pointCount = 0;
        var totalRadius = polyA.m_radius + polyB.m_radius;
        this.findMaxSeparation(this.results1, polyA, xfA, polyB, xfB);
        if (this.results1.separation > totalRadius) {
            return;
        }
        this.findMaxSeparation(this.results2, polyB, xfB, polyA, xfA);
        if (this.results2.separation > totalRadius) {
            return;
        }
        var poly1 = null;
        var poly2 = null;
        var xf1 = null;
        var xf2 = null;
        var edge1 = 0;
        var flip = false;
        var k_tol = 0.1 * Settings.linearSlop;
        if (this.results2.separation > this.results1.separation + k_tol) {
            poly1 = polyB;
            poly2 = polyA;
            xf1 = xfB;
            xf2 = xfA;
            edge1 = this.results2.edgeIndex;
            manifold.type = Manifold.ManifoldType_FACE_B;
            flip = true;
        }
        else {
            poly1 = polyA;
            poly2 = polyB;
            xf1 = xfA;
            xf2 = xfB;
            edge1 = this.results1.edgeIndex;
            manifold.type = Manifold.ManifoldType_FACE_A;
            flip = false;
        }
        var xf1q = xf1.q;
        this.findIncidentEdge(this.incidentEdge, poly1, xf1, edge1, poly2, xf2);
        var count1 = poly1.m_count;
        var vertices1 = poly1.m_vertices;
        var iv1 = edge1;
        var iv2 = edge1 + 1 < count1 ? edge1 + 1 : 0;
        this.v11.set(vertices1[iv1]);
        this.v12.set(vertices1[iv2]);
        this.localTangent.x = this.v12.x - this.v11.x;
        this.localTangent.y = this.v12.y - this.v11.y;
        this.localTangent.normalize();
        this.localNormal.x = 1 * this.localTangent.y;
        this.localNormal.y = -1 * this.localTangent.x;
        this.planePoint.x = (this.v11.x + this.v12.x) * 0.5;
        this.planePoint.y = (this.v11.y + this.v12.y) * 0.5;
        this.tangent.x = xf1q.c * this.localTangent.x - xf1q.s * this.localTangent.y;
        this.tangent.y = xf1q.s * this.localTangent.x + xf1q.c * this.localTangent.y;
        var normalx = 1 * this.tangent.y;
        var normaly = -1 * this.tangent.x;
        Transform.mulToOut(xf1, this.v11, this.v11);
        Transform.mulToOut(xf1, this.v12, this.v12);
        var frontOffset = normalx * this.v11.x + normaly * this.v11.y;
        var sideOffset1 = -(this.tangent.x * this.v11.x + this.tangent.y * this.v11.y) + totalRadius;
        var sideOffset2 = this.tangent.x * this.v12.x + this.tangent.y * this.v12.y + totalRadius;
        var np;
        this.tangent.negateLocal();
        np = Collision.clipSegmentToLine(this.clipPoints1, this.incidentEdge, this.tangent, sideOffset1, iv1);
        this.tangent.negateLocal();
        if (np < 2) {
            return;
        }
        np = Collision.clipSegmentToLine(this.clipPoints2, this.clipPoints1, this.tangent, sideOffset2, iv2);
        if (np < 2) {
            return;
        }
        manifold.localNormal.set(this.localNormal);
        manifold.localPoint.set(this.planePoint);
        var pointCount = 0;
        for (var i = 0; i < Settings.maxManifoldPoints; ++i) {
            var separation = normalx * this.clipPoints2[i].v.x + normaly * this.clipPoints2[i].v.y - frontOffset;
            if (separation <= totalRadius) {
                var cp = manifold.points[pointCount];
                var outData = cp.localPoint;
                var px = this.clipPoints2[i].v.x - xf2.p.x;
                var py = this.clipPoints2[i].v.y - xf2.p.y;
                outData.x = (xf2.q.c * px + xf2.q.s * py);
                outData.y = (-xf2.q.s * px + xf2.q.c * py);
                cp.id.set(this.clipPoints2[i].id);
                if (flip) {
                    cp.id.flip();
                }
                ++pointCount;
            }
        }
        manifold.pointCount = pointCount;
    };
    Collision.prototype.collideEdgeAndCircle = function (manifold, edgeA, xfA, circleB, xfB) {
        manifold.pointCount = 0;
        Transform.mulToOutUnsafe(xfB, circleB.m_p, this.temp);
        Transform.mulTransToOutUnsafeVec2(xfA, this.temp, this.Q);
        var A = edgeA.m_vertex1;
        var B = edgeA.m_vertex2;
        this.e.set(B).subLocal(A);
        var u = Vec2.dot(this.e, this.temp.set(B).subLocal(this.Q));
        var v = Vec2.dot(this.e, this.temp.set(this.Q).subLocal(A));
        var radius = edgeA.m_radius + circleB.m_radius;
        this.cf.indexB = 0;
        this.cf.typeB = ContactID.Type_VERTEX;
        if (v <= 0.0) {
            var P = A;
            Collision.d.set(this.Q).subLocal(P);
            var dd = Vec2.dot(Collision.d, Collision.d);
            if (dd > radius * radius) {
                return;
            }
            if (edgeA.m_hasVertex0) {
                var A1 = edgeA.m_vertex0;
                var B1 = A;
                this.e1.set(B1).subLocal(A1);
                var u1 = Vec2.dot(this.e1, this.temp.set(B1).subLocal(this.Q));
                if (u1 > 0.0) {
                    return;
                }
            }
            this.cf.indexA = 0;
            this.cf.typeA = ContactID.Type_VERTEX;
            manifold.pointCount = 1;
            manifold.type = Manifold.ManifoldType_CIRCLES;
            manifold.localNormal.setZero();
            manifold.localPoint.set(P);
            manifold.points[0].id.set(this.cf);
            manifold.points[0].localPoint.set(circleB.m_p);
            return;
        }
        if (u <= 0.0) {
            var P = B;
            Collision.d.set(this.Q).subLocal(this.P);
            var dd = Vec2.dot(Collision.d, Collision.d);
            if (dd > radius * radius) {
                return;
            }
            if (edgeA.m_hasVertex3) {
                var B2 = edgeA.m_vertex3;
                var A2 = B;
                var e2 = this.e1;
                e2.set(B2).subLocal(A2);
                var v2 = Vec2.dot(e2, this.temp.set(this.Q).subLocal(A2));
                if (v2 > 0.0) {
                    return;
                }
            }
            this.cf.indexA = 1;
            this.cf.typeA = ContactID.Type_VERTEX;
            manifold.pointCount = 1;
            manifold.type = Manifold.ManifoldType_CIRCLES;
            manifold.localNormal.setZero();
            manifold.localPoint.set(P);
            manifold.points[0].id.set(this.cf);
            manifold.points[0].localPoint.set(circleB.m_p);
            return;
        }
        var den = Vec2.dot(this.e, this.e);
        var P = new Vec2((1.0 / den) * (u * A.x + v * B.x), (1.0 / den) * (u * A.y + v * B.y));
        P.set(A).mulLocal(u).addLocal(this.temp.set(B).mulLocal(v));
        P.mulLocal(1.0 / den);
        Collision.d.set(this.Q).subLocal(P);
        var dd = Vec2.dot(Collision.d, Collision.d);
        if (dd > radius * radius) {
            return;
        }
        this.n.x = -this.e.y;
        this.n.y = this.e.x;
        if (Vec2.dot(this.n, this.temp.set(this.Q).subLocal(A)) < 0.0) {
            this.n.setValue(-this.n.x, -this.n.y);
        }
        this.n.normalize();
        this.cf.indexA = 0;
        this.cf.typeA = ContactID.Type_FACE;
        manifold.pointCount = 1;
        manifold.type = Manifold.ManifoldType_FACE_A;
        manifold.localNormal.set(this.n);
        manifold.localPoint.set(A);
        manifold.points[0].id.set(this.cf);
        manifold.points[0].localPoint.set(circleB.m_p);
    };
    Collision.prototype.collideEdgeAndPolygon = function (manifold, edgeA, xfA, polygonB, xfB) {
        this.collider.collide(manifold, edgeA, xfA, polygonB, xfB);
    };
    Collision.NULL_FEATURE = dMath.dINT_MAX;
    Collision.d = new Vec2();
    return Collision;
}());
var CollisionEdgeResults = (function () {
    function CollisionEdgeResults() {
        this.separation = 0;
        this.edgeIndex = 0;
    }
    return CollisionEdgeResults;
}());
var CollisionClipVertex = (function () {
    function CollisionClipVertex() {
        this.v = null;
        this.id = null;
        this.v = new Vec2();
        this.id = new ContactID();
    }
    CollisionClipVertex.prototype.set = function (cv) {
        var v1 = cv.v;
        this.v.x = v1.x;
        this.v.y = v1.y;
        var c = cv.id;
        this.id.indexA = c.indexA;
        this.id.indexB = c.indexB;
        this.id.typeA = c.typeA;
        this.id.typeB = c.typeB;
    };
    return CollisionClipVertex;
}());
var CollisionPointState;
(function (CollisionPointState) {
    CollisionPointState[CollisionPointState["NULL_STATE"] = 0] = "NULL_STATE";
    CollisionPointState[CollisionPointState["ADD_STATE"] = 1] = "ADD_STATE";
    CollisionPointState[CollisionPointState["PERSIST_STATE"] = 2] = "PERSIST_STATE";
    CollisionPointState[CollisionPointState["REMOVE_STATE"] = 3] = "REMOVE_STATE";
})(CollisionPointState || (CollisionPointState = {}));
var CollisionEPAxis = (function () {
    function CollisionEPAxis() {
        this.type = 0;
        this.index = 0;
        this.separation = 0;
    }
    CollisionEPAxis.Type_UNKNOWN = 0;
    CollisionEPAxis.Type_EDGE_A = 1;
    CollisionEPAxis.Type_EDGE_B = 2;
    return CollisionEPAxis;
}());
var CollisionTempPolygon = (function () {
    function CollisionTempPolygon() {
        this.vertices = new Array(Settings.maxPolygonVertices);
        this.normals = new Array(Settings.maxPolygonVertices);
        this.count = 0;
        for (var i = 0; i < this.vertices.length; i++) {
            this.vertices[i] = new Vec2();
            this.normals[i] = new Vec2();
        }
    }
    return CollisionTempPolygon;
}());
var CollisionReferenceFace = (function () {
    function CollisionReferenceFace() {
        this.i1 = 0;
        this.i2 = 0;
        this.v1 = new Vec2();
        this.v2 = new Vec2();
        this.normal = new Vec2();
        this.sideNormal1 = new Vec2();
        this.sideOffset1 = 0;
        this.sideNormal2 = new Vec2();
        this.sideOffset2 = 0;
    }
    return CollisionReferenceFace;
}());
var CollisionEPCollider = (function () {
    function CollisionEPCollider() {
        this.m_polygonB = new CollisionTempPolygon();
        this.m_xf = new Transform();
        this.m_centroidB = new Vec2();
        this.m_v0 = new Vec2();
        this.m_v1 = new Vec2();
        this.m_v2 = new Vec2();
        this.m_v3 = new Vec2();
        this.m_normal0 = new Vec2();
        this.m_normal1 = new Vec2();
        this.m_normal2 = new Vec2();
        this.m_normal = new Vec2();
        this.m_type1 = 0;
        this.m_type2 = 0;
        this.m_lowerLimit = new Vec2();
        this.m_upperLimit = new Vec2();
        this.m_radius = 0;
        this.m_front = false;
        this.edge1 = new Vec2();
        this.temp = new Vec2();
        this.edge0 = new Vec2();
        this.edge2 = new Vec2();
        this.ie = new Array(2);
        this.clipPoints1 = new Array(2);
        this.clipPoints2 = new Array(2);
        this.rf = new CollisionReferenceFace();
        this.edgeAxis = new CollisionEPAxis();
        this.polygonAxis = new CollisionEPAxis();
        this.perp = new Vec2();
        this.n = new Vec2();
        for (var i = 0; i < 2; i++) {
            this.ie[i] = new CollisionClipVertex();
            this.clipPoints1[i] = new CollisionClipVertex();
            this.clipPoints2[i] = new CollisionClipVertex();
        }
    }
    CollisionEPCollider.prototype.collide = function (manifold, edgeA, xfA, polygonB, xfB) {
        Transform.mulTransToOutUnsafe(xfA, xfB, this.m_xf);
        Transform.mulToOutUnsafe(this.m_xf, polygonB.m_centroid, this.m_centroidB);
        this.m_v0 = edgeA.m_vertex0;
        this.m_v1 = edgeA.m_vertex1;
        this.m_v2 = edgeA.m_vertex2;
        this.m_v3 = edgeA.m_vertex3;
        var hasVertex0 = edgeA.m_hasVertex0;
        var hasVertex3 = edgeA.m_hasVertex3;
        this.edge1.set(this.m_v2).subLocal(this.m_v1);
        this.edge1.normalize();
        this.m_normal1.setValue(this.edge1.y, -this.edge1.x);
        var offset1 = Vec2.dot(this.m_normal1, this.temp.set(this.m_centroidB).subLocal(this.m_v1));
        var offset0 = 0.0, offset2 = 0.0;
        var convex1 = false, convex2 = false;
        if (hasVertex0) {
            this.edge0.set(this.m_v1).subLocal(this.m_v0);
            this.edge0.normalize();
            this.m_normal0.setValue(this.edge0.y, -this.edge0.x);
            convex1 = Vec2.cross(this.edge0, this.edge1) >= 0.0;
            offset0 = Vec2.dot(this.m_normal0, this.temp.set(this.m_centroidB).subLocal(this.m_v0));
        }
        if (hasVertex3) {
            this.edge2.set(this.m_v3).subLocal(this.m_v2);
            this.edge2.normalize();
            this.m_normal2.setValue(this.edge2.y, -this.edge2.x);
            convex2 = Vec2.cross(this.edge1, this.edge2) > 0.0;
            offset2 = Vec2.dot(this.m_normal2, this.temp.set(this.m_centroidB).subLocal(this.m_v2));
        }
        if (hasVertex0 && hasVertex3) {
            if (convex1 && convex2) {
                this.m_front = offset0 >= 0.0 || offset1 >= 0.0 || offset2 >= 0.0;
                if (this.m_front) {
                    this.m_normal.x = this.m_normal1.x;
                    this.m_normal.y = this.m_normal1.y;
                    this.m_lowerLimit.x = this.m_normal0.x;
                    this.m_lowerLimit.y = this.m_normal0.y;
                    this.m_upperLimit.x = this.m_normal2.x;
                    this.m_upperLimit.y = this.m_normal2.y;
                }
                else {
                    this.m_normal.x = -this.m_normal1.x;
                    this.m_normal.y = -this.m_normal1.y;
                    this.m_lowerLimit.x = -this.m_normal1.x;
                    this.m_lowerLimit.y = -this.m_normal1.y;
                    this.m_upperLimit.x = -this.m_normal1.x;
                    this.m_upperLimit.y = -this.m_normal1.y;
                }
            }
            else if (convex1) {
                this.m_front = offset0 >= 0.0 || (offset1 >= 0.0 && offset2 >= 0.0);
                if (this.m_front) {
                    this.m_normal.x = this.m_normal1.x;
                    this.m_normal.y = this.m_normal1.y;
                    this.m_lowerLimit.x = this.m_normal0.x;
                    this.m_lowerLimit.y = this.m_normal0.y;
                    this.m_upperLimit.x = this.m_normal1.x;
                    this.m_upperLimit.y = this.m_normal1.y;
                }
                else {
                    this.m_normal.x = -this.m_normal1.x;
                    this.m_normal.y = -this.m_normal1.y;
                    this.m_lowerLimit.x = -this.m_normal2.x;
                    this.m_lowerLimit.y = -this.m_normal2.y;
                    this.m_upperLimit.x = -this.m_normal1.x;
                    this.m_upperLimit.y = -this.m_normal1.y;
                }
            }
            else if (convex2) {
                this.m_front = offset2 >= 0.0 || (offset0 >= 0.0 && offset1 >= 0.0);
                if (this.m_front) {
                    this.m_normal.x = this.m_normal1.x;
                    this.m_normal.y = this.m_normal1.y;
                    this.m_lowerLimit.x = this.m_normal1.x;
                    this.m_lowerLimit.y = this.m_normal1.y;
                    this.m_upperLimit.x = this.m_normal2.x;
                    this.m_upperLimit.y = this.m_normal2.y;
                }
                else {
                    this.m_normal.x = -this.m_normal1.x;
                    this.m_normal.y = -this.m_normal1.y;
                    this.m_lowerLimit.x = -this.m_normal1.x;
                    this.m_lowerLimit.y = -this.m_normal1.y;
                    this.m_upperLimit.x = -this.m_normal0.x;
                    this.m_upperLimit.y = -this.m_normal0.y;
                }
            }
            else {
                this.m_front = offset0 >= 0.0 && offset1 >= 0.0 && offset2 >= 0.0;
                if (this.m_front) {
                    this.m_normal.x = this.m_normal1.x;
                    this.m_normal.y = this.m_normal1.y;
                    this.m_lowerLimit.x = this.m_normal1.x;
                    this.m_lowerLimit.y = this.m_normal1.y;
                    this.m_upperLimit.x = this.m_normal1.x;
                    this.m_upperLimit.y = this.m_normal1.y;
                }
                else {
                    this.m_normal.x = -this.m_normal1.x;
                    this.m_normal.y = -this.m_normal1.y;
                    this.m_lowerLimit.x = -this.m_normal2.x;
                    this.m_lowerLimit.y = -this.m_normal2.y;
                    this.m_upperLimit.x = -this.m_normal0.x;
                    this.m_upperLimit.y = -this.m_normal0.y;
                }
            }
        }
        else if (hasVertex0) {
            if (convex1) {
                this.m_front = offset0 >= 0.0 || offset1 >= 0.0;
                if (this.m_front) {
                    this.m_normal.x = this.m_normal1.x;
                    this.m_normal.y = this.m_normal1.y;
                    this.m_lowerLimit.x = this.m_normal0.x;
                    this.m_lowerLimit.y = this.m_normal0.y;
                    this.m_upperLimit.x = -this.m_normal1.x;
                    this.m_upperLimit.y = -this.m_normal1.y;
                }
                else {
                    this.m_normal.x = -this.m_normal1.x;
                    this.m_normal.y = -this.m_normal1.y;
                    this.m_lowerLimit.x = this.m_normal1.x;
                    this.m_lowerLimit.y = this.m_normal1.y;
                    this.m_upperLimit.x = -this.m_normal1.x;
                    this.m_upperLimit.y = -this.m_normal1.y;
                }
            }
            else {
                this.m_front = offset0 >= 0.0 && offset1 >= 0.0;
                if (this.m_front) {
                    this.m_normal.x = this.m_normal1.x;
                    this.m_normal.y = this.m_normal1.y;
                    this.m_lowerLimit.x = this.m_normal1.x;
                    this.m_lowerLimit.y = this.m_normal1.y;
                    this.m_upperLimit.x = -this.m_normal1.x;
                    this.m_upperLimit.y = -this.m_normal1.y;
                }
                else {
                    this.m_normal.x = -this.m_normal1.x;
                    this.m_normal.y = -this.m_normal1.y;
                    this.m_lowerLimit.x = this.m_normal1.x;
                    this.m_lowerLimit.y = this.m_normal1.y;
                    this.m_upperLimit.x = -this.m_normal0.x;
                    this.m_upperLimit.y = -this.m_normal0.y;
                }
            }
        }
        else if (hasVertex3) {
            if (convex2) {
                this.m_front = offset1 >= 0.0 || offset2 >= 0.0;
                if (this.m_front) {
                    this.m_normal.x = this.m_normal1.x;
                    this.m_normal.y = this.m_normal1.y;
                    this.m_lowerLimit.x = -this.m_normal1.x;
                    this.m_lowerLimit.y = -this.m_normal1.y;
                    this.m_upperLimit.x = this.m_normal2.x;
                    this.m_upperLimit.y = this.m_normal2.y;
                }
                else {
                    this.m_normal.x = -this.m_normal1.x;
                    this.m_normal.y = -this.m_normal1.y;
                    this.m_lowerLimit.x = -this.m_normal1.x;
                    this.m_lowerLimit.y = -this.m_normal1.y;
                    this.m_upperLimit.x = this.m_normal1.x;
                    this.m_upperLimit.y = this.m_normal1.y;
                }
            }
            else {
                this.m_front = offset1 >= 0.0 && offset2 >= 0.0;
                if (this.m_front) {
                    this.m_normal.x = this.m_normal1.x;
                    this.m_normal.y = this.m_normal1.y;
                    this.m_lowerLimit.x = -this.m_normal1.x;
                    this.m_lowerLimit.y = -this.m_normal1.y;
                    this.m_upperLimit.x = this.m_normal1.x;
                    this.m_upperLimit.y = this.m_normal1.y;
                }
                else {
                    this.m_normal.x = -this.m_normal1.x;
                    this.m_normal.y = -this.m_normal1.y;
                    this.m_lowerLimit.x = -this.m_normal2.x;
                    this.m_lowerLimit.y = -this.m_normal2.y;
                    this.m_upperLimit.x = this.m_normal1.x;
                    this.m_upperLimit.y = this.m_normal1.y;
                }
            }
        }
        else {
            this.m_front = offset1 >= 0.0;
            if (this.m_front) {
                this.m_normal.x = this.m_normal1.x;
                this.m_normal.y = this.m_normal1.y;
                this.m_lowerLimit.x = -this.m_normal1.x;
                this.m_lowerLimit.y = -this.m_normal1.y;
                this.m_upperLimit.x = -this.m_normal1.x;
                this.m_upperLimit.y = -this.m_normal1.y;
            }
            else {
                this.m_normal.x = -this.m_normal1.x;
                this.m_normal.y = -this.m_normal1.y;
                this.m_lowerLimit.x = this.m_normal1.x;
                this.m_lowerLimit.y = this.m_normal1.y;
                this.m_upperLimit.x = this.m_normal1.x;
                this.m_upperLimit.y = this.m_normal1.y;
            }
        }
        this.m_polygonB.count = polygonB.m_count;
        for (var i = 0; i < polygonB.m_count; ++i) {
            Transform.mulToOutUnsafe(this.m_xf, polygonB.m_vertices[i], this.m_polygonB.vertices[i]);
            Rot.mulToOutUnsafe(this.m_xf.q, polygonB.m_normals[i], this.m_polygonB.normals[i]);
        }
        this.m_radius = 2.0 * Settings.polygonRadius;
        manifold.pointCount = 0;
        this.computeEdgeSeparation(this.edgeAxis);
        if (this.edgeAxis.type == CollisionEPAxis.Type_UNKNOWN) {
            return;
        }
        if (this.edgeAxis.separation > this.m_radius) {
            return;
        }
        this.computePolygonSeparation(this.polygonAxis);
        if (this.polygonAxis.type != CollisionEPAxis.Type_UNKNOWN && this.polygonAxis.separation > this.m_radius) {
            return;
        }
        var k_relativeTol = 0.98;
        var k_absoluteTol = 0.001;
        var primaryAxis;
        if (this.polygonAxis.type == CollisionEPAxis.Type_UNKNOWN) {
            primaryAxis = this.edgeAxis;
        }
        else if (this.polygonAxis.separation > k_relativeTol * this.edgeAxis.separation + k_absoluteTol) {
            primaryAxis = this.polygonAxis;
        }
        else {
            primaryAxis = this.edgeAxis;
        }
        var ie0 = this.ie[0];
        var ie1 = this.ie[1];
        if (primaryAxis.type == CollisionEPAxis.Type_EDGE_A) {
            manifold.type = Manifold.ManifoldType_FACE_A;
            var bestIndex = 0;
            var bestValue = Vec2.dot(this.m_normal, this.m_polygonB.normals[0]);
            for (var i = 1; i < this.m_polygonB.count; ++i) {
                var value = Vec2.dot(this.m_normal, this.m_polygonB.normals[i]);
                if (value < bestValue) {
                    bestValue = value;
                    bestIndex = i;
                }
            }
            var i1 = bestIndex;
            var i2 = i1 + 1 < this.m_polygonB.count ? i1 + 1 : 0;
            ie0.v.set(this.m_polygonB.vertices[i1]);
            ie0.id.indexA = 0;
            ie0.id.indexB = i1;
            ie0.id.typeA = ContactID.Type_FACE;
            ie0.id.typeB = ContactID.Type_VERTEX;
            ie1.v.set(this.m_polygonB.vertices[i2]);
            ie1.id.indexA = 0;
            ie1.id.indexB = i2;
            ie1.id.typeA = ContactID.Type_FACE;
            ie1.id.typeB = ContactID.Type_VERTEX;
            if (this.m_front) {
                this.rf.i1 = 0;
                this.rf.i2 = 1;
                this.rf.v1.set(this.m_v1);
                this.rf.v2.set(this.m_v2);
                this.rf.normal.set(this.m_normal1);
            }
            else {
                this.rf.i1 = 1;
                this.rf.i2 = 0;
                this.rf.v1.set(this.m_v2);
                this.rf.v2.set(this.m_v1);
                this.rf.normal.set(this.m_normal1).negateLocal();
            }
        }
        else {
            manifold.type = Manifold.ManifoldType_FACE_B;
            ie0.v.set(this.m_v1);
            ie0.id.indexA = 0;
            ie0.id.indexB = primaryAxis.index;
            ie0.id.typeA = ContactID.Type_VERTEX;
            ie0.id.typeB = ContactID.Type_FACE;
            ie1.v.set(this.m_v2);
            ie1.id.indexA = 0;
            ie1.id.indexB = primaryAxis.index;
            ie1.id.typeA = ContactID.Type_VERTEX;
            ie1.id.typeB = ContactID.Type_FACE;
            this.rf.i1 = primaryAxis.index;
            this.rf.i2 = this.rf.i1 + 1 < this.m_polygonB.count ? this.rf.i1 + 1 : 0;
            this.rf.v1.set(this.m_polygonB.vertices[this.rf.i1]);
            this.rf.v2.set(this.m_polygonB.vertices[this.rf.i2]);
            this.rf.normal.set(this.m_polygonB.normals[this.rf.i1]);
        }
        this.rf.sideNormal1.setValue(this.rf.normal.y, -this.rf.normal.x);
        this.rf.sideNormal2.set(this.rf.sideNormal1).negateLocal();
        this.rf.sideOffset1 = Vec2.dot(this.rf.sideNormal1, this.rf.v1);
        this.rf.sideOffset2 = Vec2.dot(this.rf.sideNormal2, this.rf.v2);
        var np;
        np = Collision.clipSegmentToLine(this.clipPoints1, this.ie, this.rf.sideNormal1, this.rf.sideOffset1, this.rf.i1);
        if (np < Settings.maxManifoldPoints) {
            return;
        }
        np = Collision.clipSegmentToLine(this.clipPoints2, this.clipPoints1, this.rf.sideNormal2, this.rf.sideOffset2, this.rf.i2);
        if (np < Settings.maxManifoldPoints) {
            return;
        }
        if (primaryAxis.type == CollisionEPAxis.Type_EDGE_A) {
            manifold.localNormal.set(this.rf.normal);
            manifold.localPoint.set(this.rf.v1);
        }
        else {
            manifold.localNormal.set(polygonB.m_normals[this.rf.i1]);
            manifold.localPoint.set(polygonB.m_vertices[this.rf.i1]);
        }
        var pointCount = 0;
        for (var i = 0; i < Settings.maxManifoldPoints; ++i) {
            var separation;
            separation = Vec2.dot(this.rf.normal, this.temp.set(this.clipPoints2[i].v).subLocal(this.rf.v1));
            if (separation <= this.m_radius) {
                var cp = manifold.points[pointCount];
                if (primaryAxis.type == CollisionEPAxis.Type_EDGE_A) {
                    Transform.mulTransToOutUnsafeVec2(this.m_xf, this.clipPoints2[i].v, cp.localPoint);
                    cp.id.set(this.clipPoints2[i].id);
                }
                else {
                    cp.localPoint.set(this.clipPoints2[i].v);
                    cp.id.typeA = this.clipPoints2[i].id.typeB;
                    cp.id.typeB = this.clipPoints2[i].id.typeA;
                    cp.id.indexA = this.clipPoints2[i].id.indexB;
                    cp.id.indexB = this.clipPoints2[i].id.indexA;
                }
                ++pointCount;
            }
        }
        manifold.pointCount = pointCount;
    };
    CollisionEPCollider.prototype.computeEdgeSeparation = function (axis) {
        axis.type = CollisionEPAxis.Type_EDGE_A;
        axis.index = this.m_front ? 0 : 1;
        axis.separation = dMath.dFLOAT_MAX;
        var nx = this.m_normal.x;
        var ny = this.m_normal.y;
        for (var i = 0; i < this.m_polygonB.count; ++i) {
            var v = this.m_polygonB.vertices[i];
            var tempx = v.x - this.m_v1.x;
            var tempy = v.y - this.m_v1.y;
            var s = nx * tempx + ny * tempy;
            if (s < axis.separation) {
                axis.separation = s;
            }
        }
    };
    CollisionEPCollider.prototype.computePolygonSeparation = function (axis) {
        axis.type = CollisionEPAxis.Type_UNKNOWN;
        axis.index = -1;
        axis.separation = -dMath.dFLOAT_MAX;
        this.perp.x = -this.m_normal.y;
        this.perp.y = this.m_normal.x;
        for (var i = 0; i < this.m_polygonB.count; ++i) {
            var normalB = this.m_polygonB.normals[i];
            var vB = this.m_polygonB.vertices[i];
            this.n.x = -normalB.x;
            this.n.y = -normalB.y;
            var tempx = vB.x - this.m_v1.x;
            var tempy = vB.y - this.m_v1.y;
            var s1 = this.n.x * tempx + this.n.y * tempy;
            tempx = vB.x - this.m_v2.x;
            tempy = vB.y - this.m_v2.y;
            var s2 = this.n.x * tempx + this.n.y * tempy;
            var s = dMath.Min(s1, s2);
            if (s > this.m_radius) {
                axis.type = CollisionEPAxis.Type_EDGE_B;
                axis.index = i;
                axis.separation = s;
                return;
            }
            if (this.n.x * this.perp.x + this.n.y * this.perp.y >= 0.0) {
                if (Vec2.dot(this.temp.set(this.n).subLocal(this.m_upperLimit), this.m_normal) < -Settings.angularSlop) {
                    continue;
                }
            }
            else {
                if (Vec2.dot(this.temp.set(this.n).subLocal(this.m_lowerLimit), this.m_normal) < -Settings.angularSlop) {
                    continue;
                }
            }
            if (s > axis.separation) {
                axis.type = CollisionEPAxis.Type_EDGE_B;
                axis.index = i;
                axis.separation = s;
            }
        }
    };
    CollisionEPCollider.VertexType_ISOLATED = 0;
    CollisionEPCollider.VertexType_CONCAVE = 1;
    CollisionEPCollider.VertexType_CONVEX = 2;
    return CollisionEPCollider;
}());
var ContactID = (function () {
    function ContactID() {
        this.indexA = 0;
        this.indexB = 0;
        this.typeA = 0;
        this.typeB = 0;
    }
    ContactID.prototype.getKey = function () {
        return (this.indexA & 0xff) << 24 | (this.indexB & 0xff) << 16 | (this.typeA & 0xff) << 8 | (this.typeB & 0xff);
    };
    ContactID.prototype.isEqual = function (cid) {
        return this.getKey() == cid.getKey();
    };
    ContactID.prototype.ContactID = function () {
    };
    ContactID.prototype.set = function (c) {
        this.indexA = c.indexA;
        this.indexB = c.indexB;
        this.typeA = c.typeA;
        this.typeB = c.typeB;
        return this;
    };
    ContactID.prototype.flip = function () {
        var tempA = this.indexA;
        this.indexA = this.indexB;
        this.indexB = tempA;
        tempA = this.typeA;
        this.typeA = this.typeB;
        this.typeB = tempA;
    };
    ContactID.prototype.zero = function () {
        this.indexA = 0;
        this.indexB = 0;
        this.typeA = 0;
        this.typeB = 0;
    };
    ContactID.prototype.compareTo = function (o) {
        return this.getKey() - o.getKey();
    };
    ContactID.Type_VERTEX = 0;
    ContactID.Type_FACE = 1;
    return ContactID;
}());
var Distance = (function () {
    function Distance() {
        this.simplex = new Simplex();
        this.saveA = new Array(3);
        this.saveB = new Array(3);
        this.closestPoint = new Vec2();
        this.d = new Vec2();
        this.temp = new Vec2();
        this.normal = new Vec2();
    }
    Distance.prototype.distance = function (output, cache, input) {
        Distance.GJK_CALLS++;
        var proxyA = input.proxyA;
        var proxyB = input.proxyB;
        var transformA = input.transformA;
        var transformB = input.transformB;
        this.simplex.readCache(cache, proxyA, transformA, proxyB, transformB);
        var vertices = this.simplex.vertices;
        var saveCount = 0;
        this.simplex.getClosestPoint(this.closestPoint);
        var distanceSqr1 = this.closestPoint.lengthSquared();
        var distanceSqr2 = distanceSqr1;
        var iter = 0;
        while (iter < Distance.MAX_ITERS) {
            saveCount = this.simplex.m_count;
            for (var i = 0; i < saveCount; i++) {
                this.saveA[i] = vertices[i].indexA;
                this.saveB[i] = vertices[i].indexB;
            }
            switch (this.simplex.m_count) {
                case 1:
                    break;
                case 2:
                    this.simplex.solve2();
                    break;
                case 3:
                    this.simplex.solve3();
                    break;
                default:
            }
            if (this.simplex.m_count == 3) {
                break;
            }
            this.simplex.getClosestPoint(this.closestPoint);
            distanceSqr2 = this.closestPoint.lengthSquared();
            if (distanceSqr2 >= distanceSqr1) {
            }
            distanceSqr1 = distanceSqr2;
            this.simplex.getSearchDirection(this.d);
            if (this.d.lengthSquared() < Settings.EPSILON * Settings.EPSILON) {
                break;
            }
            var vertex = vertices[this.simplex.m_count];
            Rot.mulTransUnsafeVec2(transformA.q, this.d.negateLocal(), this.temp);
            vertex.indexA = proxyA.getSupport(this.temp);
            Transform.mulToOutUnsafe(transformA, proxyA.getVertex(vertex.indexA), vertex.wA);
            Rot.mulTransUnsafeVec2(transformB.q, this.d.negateLocal(), this.temp);
            vertex.indexB = proxyB.getSupport(this.temp);
            Transform.mulToOutUnsafe(transformB, proxyB.getVertex(vertex.indexB), vertex.wB);
            vertex.w.set(vertex.wB).subLocal(vertex.wA);
            ++iter;
            ++Distance.GJK_ITERS;
            var duplicate = false;
            for (var i = 0; i < saveCount; ++i) {
                if (vertex.indexA == this.saveA[i] && vertex.indexB == this.saveB[i]) {
                    duplicate = true;
                    break;
                }
            }
            if (duplicate) {
                break;
            }
            ++this.simplex.m_count;
        }
        Distance.GJK_MAX_ITERS = dMath.Max(Distance.GJK_MAX_ITERS, iter);
        this.simplex.getWitnessPoints(output.pointA, output.pointB);
        output.distance = MathUtils.distance(output.pointA, output.pointB);
        output.iterations = iter;
        this.simplex.writeCache(cache);
        if (input.useRadii) {
            var rA = proxyA.m_radius;
            var rB = proxyB.m_radius;
            if (output.distance > rA + rB && output.distance > Settings.EPSILON) {
                output.distance -= rA + rB;
                this.normal.set(output.pointB).subLocal(output.pointA);
                this.normal.normalize();
                this.temp.set(this.normal).mulLocal(rA);
                output.pointA.addLocal(this.temp);
                this.temp.set(this.normal).mulLocal(rB);
                output.pointB.subLocal(this.temp);
            }
            else {
                output.pointA.addLocal(output.pointB).mulLocal(0.5);
                output.pointB.set(output.pointA);
                output.distance = 0.0;
            }
        }
    };
    Distance.MAX_ITERS = 20;
    Distance.GJK_CALLS = 0;
    Distance.GJK_ITERS = 0;
    Distance.GJK_MAX_ITERS = 20;
    return Distance;
}());
var SimplexVertex = (function () {
    function SimplexVertex() {
        this.wA = new Vec2();
        this.wB = new Vec2();
        this.w = new Vec2();
        this.a = 0;
        this.indexA = 0;
        this.indexB = 0;
    }
    SimplexVertex.prototype.set = function (sv) {
        this.wA.set(sv.wA);
        this.wB.set(sv.wB);
        this.w.set(sv.w);
        this.a = sv.a;
        this.indexA = sv.indexA;
        this.indexB = sv.indexB;
    };
    return SimplexVertex;
}());
var DistanceSimplexCache = (function () {
    function DistanceSimplexCache() {
        this.metric = 0;
        this.count = 0;
        this.indexA = new Array(3);
        this.indexB = new Array(3);
        this.metric = 0;
        this.count = 0;
        this.indexA[0] = dMath.dINT_MAX;
        this.indexA[1] = dMath.dINT_MAX;
        this.indexA[2] = dMath.dINT_MAX;
        this.indexB[0] = dMath.dINT_MAX;
        this.indexB[1] = dMath.dINT_MAX;
        this.indexB[2] = dMath.dINT_MAX;
    }
    DistanceSimplexCache.prototype.set = function (sc) {
        for (var i = 0; i < this.indexA.length; i++)
            this.indexA[i] = sc.indexA[i];
        for (var i = 0; i < this.indexB.length; i++)
            this.indexB[i] = sc.indexB[i];
        this.metric = sc.metric;
        this.count = sc.count;
    };
    return DistanceSimplexCache;
}());
var Simplex = (function () {
    function Simplex() {
        this.m_v1 = new SimplexVertex();
        this.m_v2 = new SimplexVertex();
        this.m_v3 = new SimplexVertex();
        this.vertices = [this.m_v1, this.m_v2, this.m_v3];
        this.m_count = 0;
        this.e12 = new Vec2();
        this.case2 = new Vec2();
        this.case22 = new Vec2();
        this.case3 = new Vec2();
        this.case33 = new Vec2();
        this.e13 = new Vec2();
        this.e23 = new Vec2();
        this.w1 = new Vec2();
        this.w2 = new Vec2();
        this.w3 = new Vec2();
    }
    Simplex.prototype.readCache = function (cache, proxyA, transformA, proxyB, transformB) {
        this.m_count = cache.count;
        for (var i = 0; i < this.m_count; ++i) {
            var v = this.vertices[i];
            v.indexA = cache.indexA[i];
            v.indexB = cache.indexB[i];
            var wALocal = proxyA.getVertex(v.indexA);
            var wBLocal = proxyB.getVertex(v.indexB);
            Transform.mulToOutUnsafe(transformA, wALocal, v.wA);
            Transform.mulToOutUnsafe(transformB, wBLocal, v.wB);
            v.w.set(v.wB).subLocal(v.wA);
            v.a = 0.0;
        }
        if (this.m_count > 1) {
            var metric1 = cache.metric;
            var metric2 = this.getMetric();
            if (metric2 < 0.5 * metric1 || 2.0 * metric1 < metric2 || metric2 < Settings.EPSILON) {
                this.m_count = 0;
            }
        }
        if (this.m_count == 0) {
            var v = this.vertices[0];
            v.indexA = 0;
            v.indexB = 0;
            var wALocal = proxyA.getVertex(0);
            var wBLocal = proxyB.getVertex(0);
            Transform.mulToOutUnsafe(transformA, wALocal, v.wA);
            Transform.mulToOutUnsafe(transformB, wBLocal, v.wB);
            v.w.set(v.wB).subLocal(v.wA);
            this.m_count = 1;
        }
    };
    Simplex.prototype.writeCache = function (cache) {
        cache.metric = this.getMetric();
        cache.count = this.m_count;
        for (var i = 0; i < this.m_count; ++i) {
            cache.indexA[i] = (this.vertices[i].indexA);
            cache.indexB[i] = (this.vertices[i].indexB);
        }
    };
    Simplex.prototype.getSearchDirection = function (outData2) {
        switch (this.m_count) {
            case 1:
                outData2.set(this.m_v1.w).negateLocal();
                return;
            case 2:
                this.e12.set(this.m_v2.w).subLocal(this.m_v1.w);
                outData2.set(this.m_v1.w).negateLocal();
                var sgn = Vec2.cross(this.e12, outData2);
                if (sgn > 0) {
                    Vec2.crossToOutUnsafe(this.e12, -1, outData2);
                    return;
                }
                else {
                    Vec2.crossToOutUnsafe(this.e12, 1, outData2);
                    return;
                }
            default:
                outData2.setZero();
                return;
        }
    };
    Simplex.prototype.getClosestPoint = function (outData) {
        switch (this.m_count) {
            case 0:
                outData.setZero();
                return;
            case 1:
                outData.set(this.m_v1.w);
                return;
            case 2:
                this.case22.set(this.m_v2.w).mulLocal(this.m_v2.a);
                this.case2.set(this.m_v1.w).mulLocal(this.m_v1.a).addLocal(this.case22);
                outData.set(this.case2);
                return;
            case 3:
                outData.setZero();
                return;
            default:
                outData.setZero();
                return;
        }
    };
    Simplex.prototype.getWitnessPoints = function (pA, pB) {
        switch (this.m_count) {
            case 0:
                break;
            case 1:
                pA.set(this.m_v1.wA);
                pB.set(this.m_v1.wB);
                break;
            case 2:
                this.case2.set(this.m_v1.wA).mulLocal(this.m_v1.a);
                pA.set(this.m_v2.wA).mulLocal(this.m_v2.a).addLocal(this.case2);
                this.case2.set(this.m_v1.wB).mulLocal(this.m_v1.a);
                pB.set(this.m_v2.wB).mulLocal(this.m_v2.a).addLocal(this.case2);
                break;
            case 3:
                pA.set(this.m_v1.wA).mulLocal(this.m_v1.a);
                this.case3.set(this.m_v2.wA).mulLocal(this.m_v2.a);
                this.case33.set(this.m_v3.wA).mulLocal(this.m_v3.a);
                pA.addLocal(this.case3).addLocal(this.case33);
                pB.set(pA);
                break;
            default:
                break;
        }
    };
    Simplex.prototype.getMetric = function () {
        switch (this.m_count) {
            case 0:
                return 0.0;
            case 1:
                return 0.0;
            case 2:
                return MathUtils.distance(this.m_v1.w, this.m_v2.w);
            case 3:
                this.case3.set(this.m_v2.w).subLocal(this.m_v1.w);
                this.case33.set(this.m_v3.w).subLocal(this.m_v1.w);
                return Vec2.cross(this.case3, this.case33);
            default:
                return 0.0;
        }
    };
    Simplex.prototype.solve2 = function () {
        var w1 = this.m_v1.w;
        var w2 = this.m_v2.w;
        this.e12.set(w2).subLocal(w1);
        var d12_2 = -Vec2.dot(w1, this.e12);
        if (d12_2 <= 0.0) {
            this.m_v1.a = 1.0;
            this.m_count = 1;
            return;
        }
        var d12_1 = Vec2.dot(w2, this.e12);
        if (d12_1 <= 0.0) {
            this.m_v2.a = 1.0;
            this.m_count = 1;
            this.m_v1.set(this.m_v2);
            return;
        }
        var inv_d12 = 1.0 / (d12_1 + d12_2);
        this.m_v1.a = d12_1 * inv_d12;
        this.m_v2.a = d12_2 * inv_d12;
        this.m_count = 2;
    };
    Simplex.prototype.solve3 = function () {
        this.w1.set(this.m_v1.w);
        this.w2.set(this.m_v2.w);
        this.w3.set(this.m_v3.w);
        this.e12.set(this.w2).subLocal(this.w1);
        var w1e12 = Vec2.dot(this.w1, this.e12);
        var w2e12 = Vec2.dot(this.w2, this.e12);
        var d12_1 = w2e12;
        var d12_2 = -w1e12;
        this.e13.set(this.w3).subLocal(this.w1);
        var w1e13 = Vec2.dot(this.w1, this.e13);
        var w3e13 = Vec2.dot(this.w3, this.e13);
        var d13_1 = w3e13;
        var d13_2 = -w1e13;
        this.e23.set(this.w3).subLocal(this.w2);
        var w2e23 = Vec2.dot(this.w2, this.e23);
        var w3e23 = Vec2.dot(this.w3, this.e23);
        var d23_1 = w3e23;
        var d23_2 = -w2e23;
        var n123 = Vec2.cross(this.e12, this.e13);
        var d123_1 = n123 * Vec2.cross(this.w2, this.w3);
        var d123_2 = n123 * Vec2.cross(this.w3, this.w1);
        var d123_3 = n123 * Vec2.cross(this.w1, this.w2);
        if (d12_2 <= 0.0 && d13_2 <= 0.0) {
            this.m_v1.a = 1.0;
            this.m_count = 1;
            return;
        }
        if (d12_1 > 0.0 && d12_2 > 0.0 && d123_3 <= 0.0) {
            var inv_d12 = 1.0 / (d12_1 + d12_2);
            this.m_v1.a = d12_1 * inv_d12;
            this.m_v2.a = d12_2 * inv_d12;
            this.m_count = 2;
            return;
        }
        if (d13_1 > 0.0 && d13_2 > 0.0 && d123_2 <= 0.0) {
            var inv_d13 = 1.0 / (d13_1 + d13_2);
            this.m_v1.a = d13_1 * inv_d13;
            this.m_v3.a = d13_2 * inv_d13;
            this.m_count = 2;
            this.m_v2.set(this.m_v3);
            return;
        }
        if (d12_1 <= 0.0 && d23_2 <= 0.0) {
            this.m_v2.a = 1.0;
            this.m_count = 1;
            this.m_v1.set(this.m_v2);
            return;
        }
        if (d13_1 <= 0.0 && d23_1 <= 0.0) {
            this.m_v3.a = 1.0;
            this.m_count = 1;
            this.m_v1.set(this.m_v3);
            return;
        }
        if (d23_1 > 0.0 && d23_2 > 0.0 && d123_1 <= 0.0) {
            var inv_d23 = 1.0 / (d23_1 + d23_2);
            this.m_v2.a = d23_1 * inv_d23;
            this.m_v3.a = d23_2 * inv_d23;
            this.m_count = 2;
            this.m_v1.set(this.m_v3);
            return;
        }
        var inv_d123 = 1.0 / (d123_1 + d123_2 + d123_3);
        this.m_v1.a = d123_1 * inv_d123;
        this.m_v2.a = d123_2 * inv_d123;
        this.m_v3.a = d123_3 * inv_d123;
        this.m_count = 3;
    };
    return Simplex;
}());
var DistanceProxy = (function () {
    function DistanceProxy() {
        this.m_vertices = null;
        this.m_count = 0;
        this.m_radius = 0;
        this.m_buffer = null;
        this.m_vertices = new Array(Settings.maxPolygonVertices);
        for (var i = 0; i < this.m_vertices.length; i++) {
            this.m_vertices[i] = new Vec2();
        }
        this.m_buffer = new Array(2);
        this.m_count = 0;
        this.m_radius = 0;
    }
    DistanceProxy.prototype.set = function (shape, index) {
        switch (shape.getType()) {
            case ShapeType.CIRCLE:
                var circle = shape;
                this.m_vertices[0].set(circle.m_p);
                this.m_count = 1;
                this.m_radius = circle.m_radius;
                break;
            case ShapeType.POLYGON:
                var poly = shape;
                this.m_count = poly.m_count;
                this.m_radius = poly.m_radius;
                for (var i = 0; i < this.m_count; i++) {
                    this.m_vertices[i].set(poly.m_vertices[i]);
                }
                break;
            case ShapeType.CHAIN:
                var chain = shape;
                this.m_buffer[0] = chain.m_vertices[index];
                if (index + 1 < chain.m_count) {
                    this.m_buffer[1] = chain.m_vertices[index + 1];
                }
                else {
                    this.m_buffer[1] = chain.m_vertices[0];
                }
                this.m_vertices[0].set(this.m_buffer[0]);
                this.m_vertices[1].set(this.m_buffer[1]);
                this.m_count = 2;
                this.m_radius = chain.m_radius;
                break;
            case ShapeType.EDGE:
                var edge = shape;
                this.m_vertices[0].set(edge.m_vertex1);
                this.m_vertices[1].set(edge.m_vertex2);
                this.m_count = 2;
                this.m_radius = edge.m_radius;
                break;
            default:
        }
    };
    DistanceProxy.prototype.getSupport = function (d) {
        var bestIndex = 0;
        var bestValue = Vec2.dot(this.m_vertices[0], d);
        for (var i = 1; i < this.m_count; i++) {
            var value = Vec2.dot(this.m_vertices[i], d);
            if (value > bestValue) {
                bestIndex = i;
                bestValue = value;
            }
        }
        return bestIndex;
    };
    DistanceProxy.prototype.getSupportVertex = function (d) {
        var bestIndex = 0;
        var bestValue = Vec2.dot(this.m_vertices[0], d);
        for (var i = 1; i < this.m_count; i++) {
            var value = Vec2.dot(this.m_vertices[i], d);
            if (value > bestValue) {
                bestIndex = i;
                bestValue = value;
            }
        }
        return this.m_vertices[bestIndex];
    };
    DistanceProxy.prototype.getVertexCount = function () {
        return this.m_count;
    };
    DistanceProxy.prototype.getVertex = function (index) {
        return this.m_vertices[index];
    };
    return DistanceProxy;
}());
var DistanceInput = (function () {
    function DistanceInput() {
        this.proxyA = new DistanceProxy();
        this.proxyB = new DistanceProxy();
        this.transformA = new Transform();
        this.transformB = new Transform();
        this.useRadii = false;
    }
    return DistanceInput;
}());
var DistanceOutput = (function () {
    function DistanceOutput() {
        this.pointA = new Vec2();
        this.pointB = new Vec2();
        this.distance = 0;
        this.iterations = 0;
    }
    return DistanceOutput;
}());
var Manifold = (function () {
    function Manifold() {
        this.points = null;
        this.localNormal = null;
        this.localPoint = null;
        this.type = 0;
        this.pointCount = 0;
        this.points = new Array(Settings.maxManifoldPoints);
        for (var i = 0; i < Settings.maxManifoldPoints; i++) {
            this.points[i] = new ManifoldPoint();
        }
        this.localNormal = new Vec2();
        this.localPoint = new Vec2();
        this.pointCount = 0;
    }
    Manifold.prototype.set = function (cp) {
        for (var i = 0; i < cp.pointCount; i++) {
            this.points[i].set(cp.points[i]);
        }
        this.type = cp.type;
        this.localNormal.set(cp.localNormal);
        this.localPoint.set(cp.localPoint);
        this.pointCount = cp.pointCount;
    };
    Manifold.ManifoldType_CIRCLES = 0;
    Manifold.ManifoldType_FACE_A = 1;
    Manifold.ManifoldType_FACE_B = 2;
    return Manifold;
}());
var ManifoldPoint = (function () {
    function ManifoldPoint() {
        this.localPoint = null;
        this.normalImpulse = 0;
        this.tangentImpulse = 0;
        this.id = null;
        this.localPoint = new Vec2();
        this.normalImpulse = this.tangentImpulse = 0;
        this.id = new ContactID();
    }
    ManifoldPoint.prototype.Copy = function (cp) {
        this.localPoint = cp.localPoint.clone();
        this.normalImpulse = cp.normalImpulse;
        this.tangentImpulse = cp.tangentImpulse;
        this.id = new ContactID().set(cp.id);
        return this;
    };
    ManifoldPoint.prototype.set = function (cp) {
        this.localPoint.set(cp.localPoint);
        this.normalImpulse = cp.normalImpulse;
        this.tangentImpulse = cp.tangentImpulse;
        this.id.set(cp.id);
    };
    return ManifoldPoint;
}());
var RayCastInput = (function () {
    function RayCastInput() {
        this.p1 = null;
        this.p2 = null;
        this.maxFraction = 0;
        this.p1 = new Vec2();
        this.p2 = new Vec2();
        this.maxFraction = 0;
    }
    RayCastInput.prototype.set = function (rci) {
        this.p1.set(rci.p1);
        this.p2.set(rci.p2);
        this.maxFraction = rci.maxFraction;
    };
    return RayCastInput;
}());
var RayCastOutput = (function () {
    function RayCastOutput() {
        this.normal = null;
        this.fraction = 0;
        this.normal = new Vec2();
        this.fraction = 0;
    }
    RayCastOutput.prototype.set = function (rco) {
        this.normal.set(rco.normal);
        this.fraction = rco.fraction;
    };
    return RayCastOutput;
}());
var TimeOfImpact = (function () {
    function TimeOfImpact(argPool) {
        this.cache = new DistanceSimplexCache();
        this.distanceInput = new DistanceInput();
        this.xfA = new Transform();
        this.xfB = new Transform();
        this.distanceOutput = new DistanceOutput();
        this.fcn = new SeparationFunction();
        this.indexes = new Array(2);
        this.sweepA = new Sweep();
        this.sweepB = new Sweep();
        this.pool = null;
        this.pool = argPool;
    }
    TimeOfImpact.prototype.timeOfImpact = function (output, input) {
        ++TimeOfImpact.toiCalls;
        output.state = TimeOfImpact.TOIOutputState_UNKNOWN;
        output.t = input.tMax;
        var proxyA = input.proxyA;
        var proxyB = input.proxyB;
        this.sweepA.set(input.sweepA);
        this.sweepB.set(input.sweepB);
        this.sweepA.normalize();
        this.sweepB.normalize();
        var tMax = input.tMax;
        var totalRadius = proxyA.m_radius + proxyB.m_radius;
        var target = dMath.Max(Settings.linearSlop, totalRadius - 3.0 * Settings.linearSlop);
        var tolerance = 0.25 * Settings.linearSlop;
        var t1 = 0;
        var iter = 0;
        this.cache.count = 0;
        this.distanceInput.proxyA = input.proxyA;
        this.distanceInput.proxyB = input.proxyB;
        this.distanceInput.useRadii = false;
        for (;;) {
            this.sweepA.getTransform(this.xfA, t1);
            this.sweepB.getTransform(this.xfB, t1);
            this.distanceInput.transformA = this.xfA;
            this.distanceInput.transformB = this.xfB;
            this.pool.getDistance().distance(this.distanceOutput, this.cache, this.distanceInput);
            if (this.distanceOutput.distance <= 0) {
                output.state = TimeOfImpact.TOIOutputState_OVERLAPPED;
                output.t = 0;
                break;
            }
            if (this.distanceOutput.distance < target + tolerance) {
                output.state = TimeOfImpact.TOIOutputState_TOUCHING;
                output.t = t1;
                break;
            }
            this.fcn.initialize(this.cache, proxyA, this.sweepA, proxyB, this.sweepB, t1);
            var done = false;
            var t2 = tMax;
            var pushBackIter = 0;
            for (;;) {
                var s2 = this.fcn.findMinSeparation(this.indexes, t2);
                if (s2 > target + tolerance) {
                    output.state = TimeOfImpact.TOIOutputState_SEPARATED;
                    output.t = tMax;
                    done = true;
                    break;
                }
                if (s2 > target - tolerance) {
                    t1 = t2;
                    break;
                }
                var s1 = this.fcn.evaluate(this.indexes[0], this.indexes[1], t1);
                if (s1 < target - tolerance) {
                    output.state = TimeOfImpact.TOIOutputState_FAILED;
                    output.t = t1;
                    done = true;
                    break;
                }
                if (s1 <= target + tolerance) {
                    output.state = TimeOfImpact.TOIOutputState_TOUCHING;
                    output.t = t1;
                    done = true;
                    break;
                }
                var rootIterCount = 0;
                var a1 = t1, a2 = t2;
                for (;;) {
                    var t;
                    if ((rootIterCount & 1) == 1) {
                        t = a1 + (target - s1) * (a2 - a1) / (s2 - s1);
                    }
                    else {
                        t = 0.5 * (a1 + a2);
                    }
                    ++rootIterCount;
                    ++TimeOfImpact.toiRootIters;
                    var s = this.fcn.evaluate(this.indexes[0], this.indexes[1], t);
                    if (dMath.Abs(s - target) < tolerance) {
                        t2 = t;
                        break;
                    }
                    if (s > target) {
                        a1 = t;
                        s1 = s;
                    }
                    else {
                        a2 = t;
                        s2 = s;
                    }
                    if (rootIterCount == TimeOfImpact.MAX_ROOT_ITERATIONS) {
                        break;
                    }
                }
                TimeOfImpact.toiMaxRootIters = dMath.Max(TimeOfImpact.toiMaxRootIters, rootIterCount);
                ++pushBackIter;
                if (pushBackIter == Settings.maxPolygonVertices || rootIterCount == TimeOfImpact.MAX_ROOT_ITERATIONS) {
                    break;
                }
            }
            ++iter;
            ++TimeOfImpact.toiIters;
            if (done) {
                break;
            }
            if (iter == TimeOfImpact.MAX_ITERATIONS) {
                output.state = TimeOfImpact.TOIOutputState_FAILED;
                output.t = t1;
                break;
            }
        }
        TimeOfImpact.toiMaxIters = dMath.Max(TimeOfImpact.toiMaxIters, iter);
    };
    TimeOfImpact.MAX_ITERATIONS = 20;
    TimeOfImpact.MAX_ROOT_ITERATIONS = 50;
    TimeOfImpact.toiCalls = 0;
    TimeOfImpact.toiIters = 0;
    TimeOfImpact.toiMaxIters = 0;
    TimeOfImpact.toiRootIters = 0;
    TimeOfImpact.toiMaxRootIters = 0;
    TimeOfImpact.Type_POINTS = 0;
    TimeOfImpact.Type_FACE_A = 1;
    TimeOfImpact.Type_FACE_B = 2;
    TimeOfImpact.TOIOutputState_UNKNOWN = 1;
    TimeOfImpact.TOIOutputState_FAILED = 2;
    TimeOfImpact.TOIOutputState_OVERLAPPED = 3;
    TimeOfImpact.TOIOutputState_TOUCHING = 4;
    TimeOfImpact.TOIOutputState_SEPARATED = 5;
    return TimeOfImpact;
}());
var SeparationFunction = (function () {
    function SeparationFunction() {
        this.m_proxyA = null;
        this.m_proxyB = null;
        this.m_type = 0;
        this.m_localPoint = new Vec2();
        this.m_axis = new Vec2();
        this.m_sweepA = null;
        this.m_sweepB = null;
        this.localPointA = new Vec2();
        this.localPointB = new Vec2();
        this.pointA = new Vec2();
        this.pointB = new Vec2();
        this.localPointA1 = new Vec2();
        this.localPointA2 = new Vec2();
        this.normal = new Vec2();
        this.localPointB1 = new Vec2();
        this.localPointB2 = new Vec2();
        this.temp = new Vec2();
        this.xfa = new Transform();
        this.xfb = new Transform();
        this.axisA = new Vec2();
        this.axisB = new Vec2();
    }
    SeparationFunction.prototype.initialize = function (cache, proxyA, sweepA, proxyB, sweepB, t1) {
        this.m_proxyA = proxyA;
        this.m_proxyB = proxyB;
        var count = cache.count;
        this.m_sweepA = sweepA;
        this.m_sweepB = sweepB;
        this.m_sweepA.getTransform(this.xfa, t1);
        this.m_sweepB.getTransform(this.xfb, t1);
        if (count == 1) {
            this.m_type = TimeOfImpact.Type_POINTS;
            this.localPointA.set(this.m_proxyA.getVertex(cache.indexA[0]));
            this.localPointB.set(this.m_proxyB.getVertex(cache.indexB[0]));
            Transform.mulToOutUnsafe(this.xfa, this.localPointA, this.pointA);
            Transform.mulToOutUnsafe(this.xfb, this.localPointB, this.pointB);
            this.m_axis.set(this.pointB).subLocal(this.pointA);
            var s = this.m_axis.normalize();
            return s;
        }
        else if (cache.indexA[0] == cache.indexA[1]) {
            this.m_type = TimeOfImpact.Type_FACE_B;
            this.localPointB1.set(this.m_proxyB.getVertex(cache.indexB[0]));
            this.localPointB2.set(this.m_proxyB.getVertex(cache.indexB[1]));
            this.temp.set(this.localPointB2).subLocal(this.localPointB1);
            Vec2.crossToOutUnsafe(this.temp, 1, this.m_axis);
            this.m_axis.normalize();
            Rot.mulToOutUnsafe(this.xfb.q, this.m_axis, this.normal);
            this.m_localPoint.set(this.localPointB1).addLocal(this.localPointB2).mulLocal(0.5);
            Transform.mulToOutUnsafe(this.xfb, this.m_localPoint, this.pointB);
            this.localPointA.set(proxyA.getVertex(cache.indexA[0]));
            Transform.mulToOutUnsafe(this.xfa, this.localPointA, this.pointA);
            this.temp.set(this.pointA).subLocal(this.pointB);
            var s = Vec2.dot(this.temp, this.normal);
            if (s < 0.0) {
                this.m_axis.negateLocal();
                s = -s;
            }
            return s;
        }
        else {
            this.m_type = TimeOfImpact.Type_FACE_A;
            this.localPointA1.set(this.m_proxyA.getVertex(cache.indexA[0]));
            this.localPointA2.set(this.m_proxyA.getVertex(cache.indexA[1]));
            this.temp.set(this.localPointA2).subLocal(this.localPointA1);
            Vec2.crossToOutUnsafe(this.temp, 1.0, this.m_axis);
            this.m_axis.normalize();
            Rot.mulToOutUnsafe(this.xfa.q, this.m_axis, this.normal);
            this.m_localPoint.set(this.localPointA1).addLocal(this.localPointA2).mulLocal(0.5);
            Transform.mulToOutUnsafe(this.xfa, this.m_localPoint, this.pointA);
            this.localPointB.set(this.m_proxyB.getVertex(cache.indexB[0]));
            Transform.mulToOutUnsafe(this.xfb, this.localPointB, this.pointB);
            this.temp.set(this.pointB).subLocal(this.pointA);
            var s = Vec2.dot(this.temp, this.normal);
            if (s < 0.0) {
                this.m_axis.negateLocal();
                s = -s;
            }
            return s;
        }
    };
    SeparationFunction.prototype.findMinSeparation = function (indexes, t) {
        this.m_sweepA.getTransform(this.xfa, t);
        this.m_sweepB.getTransform(this.xfb, t);
        switch (this.m_type) {
            case TimeOfImpact.Type_POINTS:
                {
                    Rot.mulTransUnsafeVec2(this.xfa.q, this.m_axis, this.axisA);
                    Rot.mulTransUnsafeVec2(this.xfb.q, this.m_axis.negateLocal(), this.axisB);
                    this.m_axis.negateLocal();
                    indexes[0] = this.m_proxyA.getSupport(this.axisA);
                    indexes[1] = this.m_proxyB.getSupport(this.axisB);
                    this.localPointA.set(this.m_proxyA.getVertex(indexes[0]));
                    this.localPointB.set(this.m_proxyB.getVertex(indexes[1]));
                    Transform.mulToOutUnsafe(this.xfa, this.localPointA, this.pointA);
                    Transform.mulToOutUnsafe(this.xfb, this.localPointB, this.pointB);
                    var separation = Vec2.dot(this.pointB.subLocal(this.pointA), this.m_axis);
                    return separation;
                }
            case TimeOfImpact.Type_FACE_A:
                {
                    Rot.mulToOutUnsafe(this.xfa.q, this.m_axis, this.normal);
                    Transform.mulToOutUnsafe(this.xfa, this.m_localPoint, this.pointA);
                    Rot.mulTransUnsafeVec2(this.xfb.q, this.normal.negateLocal(), this.axisB);
                    this.normal.negateLocal();
                    indexes[0] = -1;
                    indexes[1] = this.m_proxyB.getSupport(this.axisB);
                    this.localPointB.set(this.m_proxyB.getVertex(indexes[1]));
                    Transform.mulToOutUnsafe(this.xfb, this.localPointB, this.pointB);
                    var separation = Vec2.dot(this.pointB.subLocal(this.pointA), this.normal);
                    return separation;
                }
            case TimeOfImpact.Type_FACE_B:
                {
                    Rot.mulToOutUnsafe(this.xfb.q, this.m_axis, this.normal);
                    Transform.mulToOutUnsafe(this.xfb, this.m_localPoint, this.pointB);
                    Rot.mulTransUnsafeVec2(this.xfa.q, this.normal.negateLocal(), this.axisA);
                    this.normal.negateLocal();
                    indexes[1] = -1;
                    indexes[0] = this.m_proxyA.getSupport(this.axisA);
                    this.localPointA.set(this.m_proxyA.getVertex(indexes[0]));
                    Transform.mulToOutUnsafe(this.xfa, this.localPointA, this.pointA);
                    var separation = Vec2.dot(this.pointA.subLocal(this.pointB), this.normal);
                    return separation;
                }
            default:
                indexes[0] = -1;
                indexes[1] = -1;
                return 0;
        }
    };
    SeparationFunction.prototype.evaluate = function (indexA, indexB, t) {
        this.m_sweepA.getTransform(this.xfa, t);
        this.m_sweepB.getTransform(this.xfb, t);
        switch (this.m_type) {
            case TimeOfImpact.Type_POINTS:
                {
                    this.localPointA.set(this.m_proxyA.getVertex(indexA));
                    this.localPointB.set(this.m_proxyB.getVertex(indexB));
                    Transform.mulToOutUnsafe(this.xfa, this.localPointA, this.pointA);
                    Transform.mulToOutUnsafe(this.xfb, this.localPointB, this.pointB);
                    var separation = Vec2.dot(this.pointB.subLocal(this.pointA), this.m_axis);
                    return separation;
                }
            case TimeOfImpact.Type_FACE_A:
                {
                    Rot.mulToOutUnsafe(this.xfa.q, this.m_axis, this.normal);
                    Transform.mulToOutUnsafe(this.xfa, this.m_localPoint, this.pointA);
                    this.localPointB.set(this.m_proxyB.getVertex(indexB));
                    Transform.mulToOutUnsafe(this.xfb, this.localPointB, this.pointB);
                    var separation = Vec2.dot(this.pointB.subLocal(this.pointA), this.normal);
                    return separation;
                }
            case TimeOfImpact.Type_FACE_B:
                {
                    Rot.mulToOutUnsafe(this.xfb.q, this.m_axis, this.normal);
                    Transform.mulToOutUnsafe(this.xfb, this.m_localPoint, this.pointB);
                    this.localPointA.set(this.m_proxyA.getVertex(indexA));
                    Transform.mulToOutUnsafe(this.xfa, this.localPointA, this.pointA);
                    var separation = Vec2.dot(this.pointA.subLocal(this.pointB), this.normal);
                    return separation;
                }
            default:
                return 0;
        }
    };
    return SeparationFunction;
}());
var TimeOfImpactTOIInput = (function () {
    function TimeOfImpactTOIInput() {
        this.proxyA = new DistanceProxy();
        this.proxyB = new DistanceProxy();
        this.sweepA = new Sweep();
        this.sweepB = new Sweep();
        this.tMax = 0;
    }
    return TimeOfImpactTOIInput;
}());
var TimeOfImpactTOIOutput = (function () {
    function TimeOfImpactTOIOutput() {
        this.state = 0;
        this.t = 0;
    }
    return TimeOfImpactTOIOutput;
}());
var WorldManifold = (function () {
    function WorldManifold() {
        this.normal = null;
        this.points = null;
        this.separations = null;
        this.pool3 = new Vec2();
        this.pool4 = new Vec2();
        this.normal = new Vec2();
        this.points = new Array(Settings.maxManifoldPoints);
        this.separations = new Array(Settings.maxManifoldPoints);
        for (var i = 0; i < Settings.maxManifoldPoints; i++) {
            this.points[i] = new Vec2();
        }
    }
    WorldManifold.prototype.initialize = function (manifold, xfA, radiusA, xfB, radiusB) {
        if (manifold.pointCount == 0) {
            return;
        }
        switch (manifold.type) {
            case Manifold.ManifoldType_CIRCLES:
                {
                    var pointA = this.pool3;
                    var pointB = this.pool4;
                    this.normal.x = 1;
                    this.normal.y = 0;
                    var v = manifold.localPoint;
                    pointA.x = (xfA.q.c * v.x - xfA.q.s * v.y) + xfA.p.x;
                    pointA.y = (xfA.q.s * v.x + xfA.q.c * v.y) + xfA.p.y;
                    var mp0p = manifold.points[0].localPoint;
                    pointB.x = (xfB.q.c * mp0p.x - xfB.q.s * mp0p.y) + xfB.p.x;
                    pointB.y = (xfB.q.s * mp0p.x + xfB.q.c * mp0p.y) + xfB.p.y;
                    if (MathUtils.distanceSquared(pointA, pointB) > Settings.EPSILON * Settings.EPSILON) {
                        this.normal.x = pointB.x - pointA.x;
                        this.normal.y = pointB.y - pointA.y;
                        this.normal.normalize();
                    }
                    var cAx = this.normal.x * radiusA + pointA.x;
                    var cAy = this.normal.y * radiusA + pointA.y;
                    var cBx = -this.normal.x * radiusB + pointB.x;
                    var cBy = -this.normal.y * radiusB + pointB.y;
                    this.points[0].x = (cAx + cBx) * 0.5;
                    this.points[0].y = (cAy + cBy) * 0.5;
                    this.separations[0] = (cBx - cAx) * this.normal.x + (cBy - cAy) * this.normal.y;
                }
                break;
            case Manifold.ManifoldType_FACE_A:
                {
                    var planePoint = this.pool3;
                    Rot.mulToOutUnsafe(xfA.q, manifold.localNormal, this.normal);
                    Transform.mulToOut(xfA, manifold.localPoint, planePoint);
                    var clipPoint = this.pool4;
                    for (var i = 0; i < manifold.pointCount; i++) {
                        Transform.mulToOut(xfB, manifold.points[i].localPoint, clipPoint);
                        var scalar = radiusA - ((clipPoint.x - planePoint.x) * this.normal.x + (clipPoint.y - planePoint.y) * this.normal.y);
                        var cAx = this.normal.x * scalar + clipPoint.x;
                        var cAy = this.normal.y * scalar + clipPoint.y;
                        var cBx = -this.normal.x * radiusB + clipPoint.x;
                        var cBy = -this.normal.y * radiusB + clipPoint.y;
                        this.points[i].x = (cAx + cBx) * 0.5;
                        this.points[i].y = (cAy + cBy) * 0.5;
                        this.separations[i] = (cBx - cAx) * this.normal.x + (cBy - cAy) * this.normal.y;
                    }
                }
                break;
            case Manifold.ManifoldType_FACE_B:
                var planePoint = this.pool3;
                Rot.mulToOutUnsafe(xfB.q, manifold.localNormal, this.normal);
                Transform.mulToOut(xfB, manifold.localPoint, planePoint);
                var clipPoint = this.pool4;
                for (var i = 0; i < manifold.pointCount; i++) {
                    Transform.mulToOut(xfA, manifold.points[i].localPoint, clipPoint);
                    var scalar = radiusB - ((clipPoint.x - planePoint.x) * this.normal.x + (clipPoint.y - planePoint.y) * this.normal.y);
                    var cBx = this.normal.x * scalar + clipPoint.x;
                    var cBy = this.normal.y * scalar + clipPoint.y;
                    var cAx = -this.normal.x * radiusA + clipPoint.x;
                    var cAy = -this.normal.y * radiusA + clipPoint.y;
                    this.points[i].x = (cAx + cBx) * 0.5;
                    this.points[i].y = (cAy + cBy) * 0.5;
                    this.separations[i] = (cAx - cBx) * this.normal.x + (cAy - cBy) * this.normal.y;
                }
                this.normal.x = -this.normal.x;
                this.normal.y = -this.normal.y;
                break;
        }
    };
    return WorldManifold;
}());
var BroadPhaseStrategy = (function () {
    function BroadPhaseStrategy() {
    }
    BroadPhaseStrategy.prototype.createProxy = function (aabb, userData) {
        return 0;
    };
    BroadPhaseStrategy.prototype.destroyProxy = function (proxyId) {
    };
    BroadPhaseStrategy.prototype.moveProxy = function (proxyId, aabb, displacement) {
        return false;
    };
    BroadPhaseStrategy.prototype.getUserData = function (proxyId) {
        return null;
    };
    BroadPhaseStrategy.prototype.getFatAABB = function (proxyId) {
        return null;
    };
    BroadPhaseStrategy.prototype.query = function (callback, aabb) {
    };
    BroadPhaseStrategy.prototype.raycast = function (callback, input) {
    };
    BroadPhaseStrategy.prototype.computeHeight = function () {
        return 0;
    };
    BroadPhaseStrategy.prototype.getHeight = function () {
        return 0;
    };
    BroadPhaseStrategy.prototype.getMaxBalance = function () {
        return 0;
    };
    BroadPhaseStrategy.prototype.getAreaRatio = function () {
        return 0;
    };
    return BroadPhaseStrategy;
}());
var DefaultBroadPhaseBuffer = (function (_super) {
    __extends(DefaultBroadPhaseBuffer, _super);
    function DefaultBroadPhaseBuffer(strategy) {
        var _this = _super.call(this) || this;
        _this.m_tree = null;
        _this.m_proxyCount = 0;
        _this.m_moveBuffer = null;
        _this.m_moveCapacity = 0;
        _this.m_moveCount = 0;
        _this.m_pairBuffer = null;
        _this.m_pairCapacity = 0;
        _this.m_pairCount = 0;
        _this.m_queryProxyId = 0;
        _this.m_proxyCount = 0;
        _this.m_pairCapacity = 16;
        _this.m_pairCount = 0;
        _this.m_pairBuffer = new Array(_this.m_pairCapacity);
        for (var i = 0; i < _this.m_pairCapacity; i++) {
            _this.m_pairBuffer[i] = new Pair();
        }
        _this.m_moveCapacity = 16;
        _this.m_moveCount = 0;
        _this.m_moveBuffer = new Array(_this.m_moveCapacity);
        _this.m_tree = strategy;
        _this.m_queryProxyId = Settings.NULL_PROXY;
        return _this;
    }
    DefaultBroadPhaseBuffer.prototype.createProxy = function (aabb, userData) {
        var proxyId = this.m_tree.createProxy(aabb, userData);
        ++this.m_proxyCount;
        this.bufferMove(proxyId);
        return proxyId;
    };
    DefaultBroadPhaseBuffer.prototype.destroyProxy = function (proxyId) {
        this.unbufferMove(proxyId);
        --this.m_proxyCount;
        this.m_tree.destroyProxy(proxyId);
    };
    DefaultBroadPhaseBuffer.prototype.moveProxy = function (proxyId, aabb, displacement) {
        var buffer = this.m_tree.moveProxy(proxyId, aabb, displacement);
        if (buffer) {
            this.bufferMove(proxyId);
        }
    };
    DefaultBroadPhaseBuffer.prototype.touchProxy = function (proxyId) {
        this.bufferMove(proxyId);
    };
    DefaultBroadPhaseBuffer.prototype.getUserData = function (proxyId) {
        return this.m_tree.getUserData(proxyId);
    };
    DefaultBroadPhaseBuffer.prototype.getFatAABB = function (proxyId) {
        return this.m_tree.getFatAABB(proxyId);
    };
    DefaultBroadPhaseBuffer.prototype.testOverlap = function (proxyIdA, proxyIdB) {
        var a = this.m_tree.getFatAABB(proxyIdA);
        var b = this.m_tree.getFatAABB(proxyIdB);
        if (b.lowerBound.x - a.upperBound.x > 0.0 || b.lowerBound.y - a.upperBound.y > 0.0) {
            return false;
        }
        if (a.lowerBound.x - b.upperBound.x > 0.0 || a.lowerBound.y - b.upperBound.y > 0.0) {
            return false;
        }
        return true;
    };
    DefaultBroadPhaseBuffer.prototype.getProxyCount = function () {
        return this.m_proxyCount;
    };
    DefaultBroadPhaseBuffer.prototype.updatePairs = function (callback) {
        this.m_pairCount = 0;
        for (var i = 0; i < this.m_moveCount; ++i) {
            this.m_queryProxyId = this.m_moveBuffer[i];
            if (this.m_queryProxyId == Settings.NULL_PROXY) {
                continue;
            }
            var fatAABB = this.m_tree.getFatAABB(this.m_queryProxyId);
            this.m_tree.query(this, fatAABB);
        }
        this.m_moveCount = 0;
        var i = 0;
        while (i < this.m_pairCount) {
            var primaryPair = this.m_pairBuffer[i];
            var userDataA = this.m_tree.getUserData(primaryPair.proxyIdA);
            var userDataB = this.m_tree.getUserData(primaryPair.proxyIdB);
            callback.addPair(userDataA, userDataB);
            ++i;
            while (i < this.m_pairCount) {
                var pair = this.m_pairBuffer[i];
                if (pair.proxyIdA != primaryPair.proxyIdA || pair.proxyIdB != primaryPair.proxyIdB) {
                    break;
                }
                ++i;
            }
        }
    };
    DefaultBroadPhaseBuffer.prototype.query = function (callback, aabb) {
        this.m_tree.query(callback, aabb);
    };
    DefaultBroadPhaseBuffer.prototype.raycast = function (callback, input) {
        this.m_tree.raycast(callback, input);
    };
    DefaultBroadPhaseBuffer.prototype.getTreeHeight = function () {
        return this.m_tree.getHeight();
    };
    DefaultBroadPhaseBuffer.prototype.getTreeBalance = function () {
        return this.m_tree.getMaxBalance();
    };
    DefaultBroadPhaseBuffer.prototype.getTreeQuality = function () {
        return this.m_tree.getAreaRatio();
    };
    DefaultBroadPhaseBuffer.prototype.bufferMove = function (proxyId) {
        if (this.m_moveCount == this.m_moveCapacity) {
            var old = this.m_moveBuffer;
            this.m_moveCapacity *= 2;
            this.m_moveBuffer = new Array(this.m_moveCapacity);
            MathUtils.arraycopy(old, this.m_moveBuffer);
        }
        this.m_moveBuffer[this.m_moveCount] = proxyId;
        ++this.m_moveCount;
    };
    DefaultBroadPhaseBuffer.prototype.unbufferMove = function (proxyId) {
        for (var i = 0; i < this.m_moveCount; i++) {
            if (this.m_moveBuffer[i] == proxyId) {
                this.m_moveBuffer[i] = Settings.NULL_PROXY;
            }
        }
    };
    DefaultBroadPhaseBuffer.prototype.treeCallback = function (proxyId) {
        if (proxyId == this.m_queryProxyId) {
            return true;
        }
        if (this.m_pairCount == this.m_pairCapacity) {
            var oldBuffer = this.m_pairBuffer;
            this.m_pairCapacity *= 2;
            this.m_pairBuffer = new Array(this.m_pairCapacity);
            MathUtils.arraycopy(oldBuffer, this.m_pairBuffer);
            for (var i = oldBuffer.length; i < this.m_pairCapacity; i++) {
                this.m_pairBuffer[i] = new Pair();
            }
        }
        if (proxyId < this.m_queryProxyId) {
            this.m_pairBuffer[this.m_pairCount].proxyIdA = proxyId;
            this.m_pairBuffer[this.m_pairCount].proxyIdB = this.m_queryProxyId;
        }
        else {
            this.m_pairBuffer[this.m_pairCount].proxyIdA = this.m_queryProxyId;
            this.m_pairBuffer[this.m_pairCount].proxyIdB = proxyId;
        }
        ++this.m_pairCount;
        return true;
    };
    return DefaultBroadPhaseBuffer;
}(TreeCallback));
var DynamicTree = (function (_super) {
    __extends(DynamicTree, _super);
    function DynamicTree() {
        var _this = _super.call(this) || this;
        _this.m_root = null;
        _this.m_nodes = null;
        _this.m_nodeCount = 0;
        _this.m_nodeCapacity = 0;
        _this.m_freeList = 0;
        _this.drawVecs = new Array(4);
        _this.nodeStack = new Array(20);
        _this.nodeStackIndex = 0;
        _this.r = new Vec2();
        _this.aabb = new AABB();
        _this.subInput = new RayCastInput();
        _this.combinedAABB = new AABB();
        _this.m_root = null;
        _this.m_nodeCount = 0;
        _this.m_nodeCapacity = 16;
        _this.m_nodes = new Array(16);
        for (var i = _this.m_nodeCapacity - 1; i >= 0; i--) {
            _this.m_nodes[i] = new DynamicTreeNode(i);
            _this.m_nodes[i].parent = (i == _this.m_nodeCapacity - 1) ? null : _this.m_nodes[i + 1];
            _this.m_nodes[i].height = -1;
        }
        _this.m_freeList = 0;
        for (var i = 0; i < _this.drawVecs.length; i++) {
            _this.drawVecs[i] = new Vec2();
        }
        return _this;
    }
    DynamicTree.prototype.createProxy = function (aabb, userData) {
        var node = this.allocateNode();
        var proxyId = node.id;
        var nodeAABB = node.aabb;
        nodeAABB.lowerBound.x = aabb.lowerBound.x - Settings.aabbExtension;
        nodeAABB.lowerBound.y = aabb.lowerBound.y - Settings.aabbExtension;
        nodeAABB.upperBound.x = aabb.upperBound.x + Settings.aabbExtension;
        nodeAABB.upperBound.y = aabb.upperBound.y + Settings.aabbExtension;
        node.userData = userData;
        this.insertLeaf(proxyId);
        return proxyId;
    };
    DynamicTree.prototype.destroyProxy = function (proxyId) {
        var node = this.m_nodes[proxyId];
        this.removeLeaf(node);
        this.freeNode(node);
    };
    DynamicTree.prototype.moveProxy = function (proxyId, aabb, displacement) {
        var node = this.m_nodes[proxyId];
        var nodeAABB = node.aabb;
        if (nodeAABB.lowerBound.x <= aabb.lowerBound.x && nodeAABB.lowerBound.y <= aabb.lowerBound.y
            && aabb.upperBound.x <= nodeAABB.upperBound.x && aabb.upperBound.y <= nodeAABB.upperBound.y) {
            return false;
        }
        this.removeLeaf(node);
        var lowerBound = nodeAABB.lowerBound;
        var upperBound = nodeAABB.upperBound;
        lowerBound.x = aabb.lowerBound.x - Settings.aabbExtension;
        lowerBound.y = aabb.lowerBound.y - Settings.aabbExtension;
        upperBound.x = aabb.upperBound.x + Settings.aabbExtension;
        upperBound.y = aabb.upperBound.y + Settings.aabbExtension;
        var dx = displacement.x * Settings.aabbMultiplier;
        var dy = displacement.y * Settings.aabbMultiplier;
        if (dx < 0.0) {
            lowerBound.x += dx;
        }
        else {
            upperBound.x += dx;
        }
        if (dy < 0.0) {
            lowerBound.y += dy;
        }
        else {
            upperBound.y += dy;
        }
        this.insertLeaf(proxyId);
        return true;
    };
    DynamicTree.prototype.getUserData = function (proxyId) {
        return this.m_nodes[proxyId].userData;
    };
    DynamicTree.prototype.getFatAABB = function (proxyId) {
        return this.m_nodes[proxyId].aabb;
    };
    DynamicTree.prototype.query = function (callback, aabb) {
        this.nodeStackIndex = 0;
        this.nodeStack[this.nodeStackIndex++] = this.m_root;
        while (this.nodeStackIndex > 0) {
            var node = this.nodeStack[--this.nodeStackIndex];
            if (node == null) {
                continue;
            }
            if (AABB.testOverlap(node.aabb, aabb)) {
                if (node.child1 == null) {
                    var proceed = callback.treeCallback(node.id);
                    if (!proceed) {
                        return;
                    }
                }
                else {
                    if (this.nodeStack.length - this.nodeStackIndex - 2 <= 0) {
                        var newBuffer = new Array(this.nodeStack.length * 2);
                        MathUtils.arraycopy(this.nodeStack, newBuffer);
                        this.nodeStack = newBuffer;
                    }
                    this.nodeStack[this.nodeStackIndex++] = node.child1;
                    this.nodeStack[this.nodeStackIndex++] = node.child2;
                }
            }
        }
    };
    DynamicTree.prototype.raycast = function (callback, input) {
        var p1 = input.p1;
        var p2 = input.p2;
        var p1x = p1.x, p2x = p2.x, p1y = p1.y, p2y = p2.y;
        var vx, vy;
        var rx, ry;
        var absVx, absVy;
        var cx, cy;
        var hx, hy;
        var tempx, tempy;
        this.r.x = p2x - p1x;
        this.r.y = p2y - p1y;
        this.r.normalize();
        rx = this.r.x;
        ry = this.r.y;
        vx = -1 * ry;
        vy = 1 * rx;
        absVx = dMath.Abs(vx);
        absVy = dMath.Abs(vy);
        var maxFraction = input.maxFraction;
        var segAABB = this.aabb;
        tempx = (p2x - p1x) * maxFraction + p1x;
        tempy = (p2y - p1y) * maxFraction + p1y;
        segAABB.lowerBound.x = p1x < tempx ? p1x : tempx;
        segAABB.lowerBound.y = p1y < tempy ? p1y : tempy;
        segAABB.upperBound.x = p1x > tempx ? p1x : tempx;
        segAABB.upperBound.y = p1y > tempy ? p1y : tempy;
        this.nodeStackIndex = 0;
        this.nodeStack[this.nodeStackIndex++] = this.m_root;
        while (this.nodeStackIndex > 0) {
            var node = this.nodeStack[--this.nodeStackIndex];
            if (node == null) {
                continue;
            }
            var nodeAABB = node.aabb;
            if (!AABB.testOverlap(nodeAABB, segAABB)) {
                continue;
            }
            cx = (nodeAABB.lowerBound.x + nodeAABB.upperBound.x) * 0.5;
            cy = (nodeAABB.lowerBound.y + nodeAABB.upperBound.y) * 0.5;
            hx = (nodeAABB.upperBound.x - nodeAABB.lowerBound.x) * 0.5;
            hy = (nodeAABB.upperBound.y - nodeAABB.lowerBound.y) * 0.5;
            tempx = p1x - cx;
            tempy = p1y - cy;
            var separation = dMath.Abs(vx * tempx + vy * tempy) - (absVx * hx + absVy * hy);
            if (separation > 0.0) {
                continue;
            }
            if (node.child1 == null) {
                this.subInput.p1.x = p1x;
                this.subInput.p1.y = p1y;
                this.subInput.p2.x = p2x;
                this.subInput.p2.y = p2y;
                this.subInput.maxFraction = maxFraction;
                var value = callback.raycastCallback(this.subInput, node.id);
                if (value == 0.0) {
                    return;
                }
                if (value > 0.0) {
                    maxFraction = value;
                    tempx = (p2x - p1x) * maxFraction + p1x;
                    tempy = (p2y - p1y) * maxFraction + p1y;
                    segAABB.lowerBound.x = p1x < tempx ? p1x : tempx;
                    segAABB.lowerBound.y = p1y < tempy ? p1y : tempy;
                    segAABB.upperBound.x = p1x > tempx ? p1x : tempx;
                    segAABB.upperBound.y = p1y > tempy ? p1y : tempy;
                }
            }
            else {
                if (this.nodeStack.length - this.nodeStackIndex - 2 <= 0) {
                    var newBuffer = new Array(this.nodeStack.length * 2);
                    MathUtils.arraycopy(this.nodeStack, newBuffer);
                    this.nodeStack = newBuffer;
                }
                this.nodeStack[this.nodeStackIndex++] = node.child1;
                this.nodeStack[this.nodeStackIndex++] = node.child2;
            }
        }
    };
    DynamicTree.prototype.computeHeight = function () {
        return this.computeHeight2(this.m_root);
    };
    DynamicTree.prototype.computeHeight2 = function (node) {
        if (node.child1 == null) {
            return 0;
        }
        var height1 = this.computeHeight2(node.child1);
        var height2 = this.computeHeight2(node.child2);
        return 1 + dMath.Max(height1, height2);
    };
    DynamicTree.prototype.validate = function () {
        this.validateStructure(this.m_root);
        this.validateMetrics(this.m_root);
        var freeCount = 0;
        var freeNode = this.m_freeList != DynamicTree.NULL_NODE ? this.m_nodes[this.m_freeList] : null;
        while (freeNode != null) {
            freeNode = freeNode.parent;
            ++freeCount;
        }
    };
    DynamicTree.prototype.getHeight = function () {
        if (this.m_root == null) {
            return 0;
        }
        return this.m_root.height;
    };
    DynamicTree.prototype.getMaxBalance = function () {
        var maxBalance = 0;
        for (var i = 0; i < this.m_nodeCapacity; ++i) {
            var node = this.m_nodes[i];
            if (node.height <= 1) {
                continue;
            }
            var child1 = node.child1;
            var child2 = node.child2;
            var balance = dMath.Abs(child2.height - child1.height);
            maxBalance = dMath.Max(maxBalance, balance);
        }
        return maxBalance;
    };
    DynamicTree.prototype.getAreaRatio = function () {
        if (this.m_root == null) {
            return 0.0;
        }
        var root = this.m_root;
        var rootArea = root.aabb.getPerimeter();
        var totalArea = 0.0;
        for (var i = 0; i < this.m_nodeCapacity; ++i) {
            var node = this.m_nodes[i];
            if (node.height < 0) {
                continue;
            }
            totalArea += node.aabb.getPerimeter();
        }
        return totalArea / rootArea;
    };
    DynamicTree.prototype.rebuildBottomUp = function () {
        var nodes = new Array(this.m_nodeCount);
        var count = 0;
        for (var i = 0; i < this.m_nodeCapacity; ++i) {
            if (this.m_nodes[i].height < 0) {
                continue;
            }
            var node = this.m_nodes[i];
            if (node.child1 == null) {
                node.parent = null;
                nodes[count] = i;
                ++count;
            }
            else {
                this.freeNode(node);
            }
        }
        var b = new AABB();
        while (count > 1) {
            var minCost = dMath.dFLOAT_MAX;
            var iMin = -1, jMin = -1;
            for (var i = 0; i < count; ++i) {
                var aabbi = this.m_nodes[nodes[i]].aabb;
                for (var j = i + 1; j < count; ++j) {
                    var aabbj = this.m_nodes[nodes[j]].aabb;
                    b.combine2(aabbi, aabbj);
                    var cost = b.getPerimeter();
                    if (cost < minCost) {
                        iMin = i;
                        jMin = j;
                        minCost = cost;
                    }
                }
            }
            var index1 = nodes[iMin];
            var index2 = nodes[jMin];
            var child1 = this.m_nodes[index1];
            var child2 = this.m_nodes[index2];
            var parent = this.allocateNode();
            parent.child1 = child1;
            parent.child2 = child2;
            parent.height = 1 + dMath.Max(child1.height, child2.height);
            parent.aabb.combine2(child1.aabb, child2.aabb);
            parent.parent = null;
            child1.parent = parent;
            child2.parent = parent;
            nodes[jMin] = nodes[count - 1];
            nodes[iMin] = parent.id;
            --count;
        }
        this.m_root = this.m_nodes[nodes[0]];
        this.validate();
    };
    DynamicTree.prototype.allocateNode = function () {
        if (this.m_freeList == DynamicTree.NULL_NODE) {
            var old = this.m_nodes;
            this.m_nodeCapacity *= 2;
            this.m_nodes = new Array(this.m_nodeCapacity);
            MathUtils.arraycopy(old, this.m_nodes);
            for (var i = this.m_nodeCapacity - 1; i >= this.m_nodeCount; i--) {
                this.m_nodes[i] = new DynamicTreeNode(i);
                this.m_nodes[i].parent = (i == this.m_nodeCapacity - 1) ? null : this.m_nodes[i + 1];
                this.m_nodes[i].height = -1;
            }
            this.m_freeList = this.m_nodeCount;
        }
        var nodeId = this.m_freeList;
        var treeNode = this.m_nodes[nodeId];
        this.m_freeList = treeNode.parent != null ? treeNode.parent.id : DynamicTree.NULL_NODE;
        treeNode.parent = null;
        treeNode.child1 = null;
        treeNode.child2 = null;
        treeNode.height = 0;
        treeNode.userData = null;
        ++this.m_nodeCount;
        return treeNode;
    };
    DynamicTree.prototype.freeNode = function (node) {
        node.parent = this.m_freeList != DynamicTree.NULL_NODE ? this.m_nodes[this.m_freeList] : null;
        node.height = -1;
        this.m_freeList = node.id;
        this.m_nodeCount--;
    };
    DynamicTree.prototype.insertLeaf = function (leaf_index) {
        var leaf = this.m_nodes[leaf_index];
        if (this.m_root == null) {
            this.m_root = leaf;
            this.m_root.parent = null;
            return;
        }
        var leafAABB = leaf.aabb;
        var index = this.m_root;
        while (index.child1 != null) {
            var node = index;
            var child1 = node.child1;
            var child2 = node.child2;
            var area = node.aabb.getPerimeter();
            this.combinedAABB.combine2(node.aabb, leafAABB);
            var combinedArea = this.combinedAABB.getPerimeter();
            var cost = 2.0 * combinedArea;
            var inheritanceCost = 2.0 * (combinedArea - area);
            var cost1;
            if (child1.child1 == null) {
                this.combinedAABB.combine2(leafAABB, child1.aabb);
                cost1 = this.combinedAABB.getPerimeter() + inheritanceCost;
            }
            else {
                this.combinedAABB.combine2(leafAABB, child1.aabb);
                var oldArea = child1.aabb.getPerimeter();
                var newArea = this.combinedAABB.getPerimeter();
                cost1 = (newArea - oldArea) + inheritanceCost;
            }
            var cost2;
            if (child2.child1 == null) {
                this.combinedAABB.combine2(leafAABB, child2.aabb);
                cost2 = this.combinedAABB.getPerimeter() + inheritanceCost;
            }
            else {
                this.combinedAABB.combine2(leafAABB, child2.aabb);
                var oldArea = child2.aabb.getPerimeter();
                var newArea = this.combinedAABB.getPerimeter();
                cost2 = newArea - oldArea + inheritanceCost;
            }
            if (cost < cost1 && cost < cost2) {
                break;
            }
            if (cost1 < cost2) {
                index = child1;
            }
            else {
                index = child2;
            }
        }
        var sibling = index;
        var oldParent = this.m_nodes[sibling.id].parent;
        var newParent = this.allocateNode();
        newParent.parent = oldParent;
        newParent.userData = null;
        newParent.aabb.combine2(leafAABB, sibling.aabb);
        newParent.height = sibling.height + 1;
        if (oldParent != null) {
            if (oldParent.child1 == sibling) {
                oldParent.child1 = newParent;
            }
            else {
                oldParent.child2 = newParent;
            }
            newParent.child1 = sibling;
            newParent.child2 = leaf;
            sibling.parent = newParent;
            leaf.parent = newParent;
        }
        else {
            newParent.child1 = sibling;
            newParent.child2 = leaf;
            sibling.parent = newParent;
            leaf.parent = newParent;
            this.m_root = newParent;
        }
        index = leaf.parent;
        while (index != null) {
            index = this.balance(index);
            var child1 = index.child1;
            var child2 = index.child2;
            index.height = 1 + dMath.Max(child1.height, child2.height);
            index.aabb.combine2(child1.aabb, child2.aabb);
            index = index.parent;
        }
    };
    DynamicTree.prototype.removeLeaf = function (leaf) {
        if (leaf == this.m_root) {
            this.m_root = null;
            return;
        }
        var parent = leaf.parent;
        var grandParent = parent.parent;
        var sibling;
        if (parent.child1 == leaf) {
            sibling = parent.child2;
        }
        else {
            sibling = parent.child1;
        }
        if (grandParent != null) {
            if (grandParent.child1 == parent) {
                grandParent.child1 = sibling;
            }
            else {
                grandParent.child2 = sibling;
            }
            sibling.parent = grandParent;
            this.freeNode(parent);
            var index = grandParent;
            while (index != null) {
                index = this.balance(index);
                var child1 = index.child1;
                var child2 = index.child2;
                index.aabb.combine2(child1.aabb, child2.aabb);
                index.height = 1 + dMath.Max(child1.height, child2.height);
                index = index.parent;
            }
        }
        else {
            this.m_root = sibling;
            sibling.parent = null;
            this.freeNode(parent);
        }
    };
    DynamicTree.prototype.balance = function (iA) {
        var A = iA;
        if (A.child1 == null || A.height < 2) {
            return iA;
        }
        var iB = A.child1;
        var iC = A.child2;
        var B = iB;
        var C = iC;
        var balance = C.height - B.height;
        if (balance > 1) {
            var iF = C.child1;
            var iG = C.child2;
            var F = iF;
            var G = iG;
            C.child1 = iA;
            C.parent = A.parent;
            A.parent = iC;
            if (C.parent != null) {
                if (C.parent.child1 == iA) {
                    C.parent.child1 = iC;
                }
                else {
                    C.parent.child2 = iC;
                }
            }
            else {
                this.m_root = iC;
            }
            if (F.height > G.height) {
                C.child2 = iF;
                A.child2 = iG;
                G.parent = iA;
                A.aabb.combine2(B.aabb, G.aabb);
                C.aabb.combine2(A.aabb, F.aabb);
                A.height = 1 + dMath.Max(B.height, G.height);
                C.height = 1 + dMath.Max(A.height, F.height);
            }
            else {
                C.child2 = iG;
                A.child2 = iF;
                F.parent = iA;
                A.aabb.combine2(B.aabb, F.aabb);
                C.aabb.combine2(A.aabb, G.aabb);
                A.height = 1 + dMath.Max(B.height, F.height);
                C.height = 1 + dMath.Max(A.height, G.height);
            }
            return iC;
        }
        if (balance < -1) {
            var iD = B.child1;
            var iE = B.child2;
            var D = iD;
            var E = iE;
            B.child1 = iA;
            B.parent = A.parent;
            A.parent = iB;
            if (B.parent != null) {
                if (B.parent.child1 == iA) {
                    B.parent.child1 = iB;
                }
                else {
                    B.parent.child2 = iB;
                }
            }
            else {
                this.m_root = iB;
            }
            if (D.height > E.height) {
                B.child2 = iD;
                A.child1 = iE;
                E.parent = iA;
                A.aabb.combine2(C.aabb, E.aabb);
                B.aabb.combine2(A.aabb, D.aabb);
                A.height = 1 + dMath.Max(C.height, E.height);
                B.height = 1 + dMath.Max(A.height, D.height);
            }
            else {
                B.child2 = iE;
                A.child1 = iD;
                D.parent = iA;
                A.aabb.combine2(C.aabb, D.aabb);
                B.aabb.combine2(A.aabb, E.aabb);
                A.height = 1 + dMath.Max(C.height, D.height);
                B.height = 1 + dMath.Max(A.height, E.height);
            }
            return iB;
        }
        return iA;
    };
    DynamicTree.prototype.validateStructure = function (node) {
        if (node == null) {
            return;
        }
        if (node == this.m_root) {
        }
        var child1 = node.child1;
        var child2 = node.child2;
        if (node.child1 == null) {
            return;
        }
        this.validateStructure(child1);
        this.validateStructure(child2);
    };
    DynamicTree.prototype.validateMetrics = function (node) {
        if (node == null) {
            return;
        }
        var child1 = node.child1;
        var child2 = node.child2;
        if (node.child1 == null) {
            return;
        }
        var height1 = child1.height;
        var height2 = child2.height;
        var height;
        height = 1 + dMath.Max(height1, height2);
        var aabb = new AABB();
        aabb.combine2(child1.aabb, child2.aabb);
        this.validateMetrics(child1);
        this.validateMetrics(child2);
    };
    DynamicTree.MAX_STACK_SIZE = 64;
    DynamicTree.NULL_NODE = -1;
    return DynamicTree;
}(BroadPhaseStrategy));
var DynamicTreeFlatNodes = (function (_super) {
    __extends(DynamicTreeFlatNodes, _super);
    function DynamicTreeFlatNodes() {
        var _this = _super.call(this) || this;
        _this.m_root = 0;
        _this.m_aabb = new Array();
        _this.m_userData = new Array();
        _this.m_parent = new Array();
        _this.m_child1 = new Array();
        _this.m_child2 = new Array();
        _this.m_height = new Array();
        _this.m_nodeCount = 0;
        _this.m_nodeCapacity = 0;
        _this.m_freeList = 0;
        _this.drawVecs = new Array(4);
        _this.nodeStack = new Array(20);
        _this.nodeStackIndex = 0;
        _this.r = new Vec2();
        _this.aabb = new AABB();
        _this.subInput = new RayCastInput();
        _this.combinedAABB = new AABB();
        _this.m_root = DynamicTreeFlatNodes.NULL_NODE;
        _this.m_nodeCount = 0;
        _this.m_nodeCapacity = 16;
        _this.expandBuffers(0, _this.m_nodeCapacity);
        for (var i = 0; i < _this.drawVecs.length; i++) {
            _this.drawVecs[i] = new Vec2();
        }
        return _this;
    }
    DynamicTreeFlatNodes.prototype.expandBuffers = function (oldSize, newSize) {
        this.m_aabb.resize(newSize);
        this.m_userData.resize(newSize);
        this.m_parent.resize(newSize);
        this.m_child1.resize(newSize);
        this.m_child2.resize(newSize);
        this.m_height.resize(newSize);
        for (var i = oldSize; i < newSize; i++) {
            this.m_aabb[i] = new AABB();
            this.m_parent[i] = (i == newSize - 1) ? DynamicTreeFlatNodes.NULL_NODE : i + 1;
            this.m_height[i] = -1;
            this.m_child1[i] = -1;
            this.m_child2[i] = -1;
        }
        this.m_freeList = oldSize;
    };
    DynamicTreeFlatNodes.prototype.createProxy = function (aabb, userData) {
        var node = this.allocateNode();
        var nodeAABB = this.m_aabb[node];
        nodeAABB.lowerBound.x = aabb.lowerBound.x - Settings.aabbExtension;
        nodeAABB.lowerBound.y = aabb.lowerBound.y - Settings.aabbExtension;
        nodeAABB.upperBound.x = aabb.upperBound.x + Settings.aabbExtension;
        nodeAABB.upperBound.y = aabb.upperBound.y + Settings.aabbExtension;
        this.m_userData[node] = userData;
        this.insertLeaf(node);
        return node;
    };
    DynamicTreeFlatNodes.prototype.destroyProxy = function (proxyId) {
        this.removeLeaf(proxyId);
        this.freeNode(proxyId);
    };
    DynamicTreeFlatNodes.prototype.moveProxy = function (proxyId, aabb, displacement) {
        var node = proxyId;
        var nodeAABB = this.m_aabb[node];
        if (nodeAABB.lowerBound.x <= aabb.lowerBound.x && nodeAABB.lowerBound.y <= aabb.lowerBound.y
            && aabb.upperBound.x <= nodeAABB.upperBound.x && aabb.upperBound.y <= nodeAABB.upperBound.y) {
            return false;
        }
        this.removeLeaf(node);
        var lowerBound = nodeAABB.lowerBound;
        var upperBound = nodeAABB.upperBound;
        lowerBound.x = aabb.lowerBound.x - Settings.aabbExtension;
        lowerBound.y = aabb.lowerBound.y - Settings.aabbExtension;
        upperBound.x = aabb.upperBound.x + Settings.aabbExtension;
        upperBound.y = aabb.upperBound.y + Settings.aabbExtension;
        var dx = displacement.x * Settings.aabbMultiplier;
        var dy = displacement.y * Settings.aabbMultiplier;
        if (dx < 0.0) {
            lowerBound.x += dx;
        }
        else {
            upperBound.x += dx;
        }
        if (dy < 0.0) {
            lowerBound.y += dy;
        }
        else {
            upperBound.y += dy;
        }
        this.insertLeaf(proxyId);
        return true;
    };
    DynamicTreeFlatNodes.prototype.getUserData = function (proxyId) {
        return this.m_userData[proxyId];
    };
    DynamicTreeFlatNodes.prototype.getFatAABB = function (proxyId) {
        return this.m_aabb[proxyId];
    };
    DynamicTreeFlatNodes.prototype.query = function (callback, aabb) {
        this.nodeStackIndex = 0;
        this.nodeStack[this.nodeStackIndex++] = this.m_root;
        while (this.nodeStackIndex > 0) {
            var node = this.nodeStack[--this.nodeStackIndex];
            if (node == DynamicTreeFlatNodes.NULL_NODE) {
                continue;
            }
            if (AABB.testOverlap(this.m_aabb[node], aabb)) {
                var child1 = this.m_child1[node];
                if (child1 == DynamicTreeFlatNodes.NULL_NODE) {
                    var proceed = callback.treeCallback(node);
                    if (!proceed) {
                        return;
                    }
                }
                else {
                    if (this.nodeStack.length - this.nodeStackIndex - 2 <= 0) {
                        this.nodeStack =
                            this.reallocateBuffer(this.nodeStack, this.nodeStack.length, this.nodeStack.length * 2);
                    }
                    this.nodeStack[this.nodeStackIndex++] = child1;
                    this.nodeStack[this.nodeStackIndex++] = this.m_child2[node];
                }
            }
        }
    };
    DynamicTreeFlatNodes.prototype.reallocateBuffer = function (oldData, oldSize, newSize) {
        var newData = new Array(newSize);
        for (var i = 0; i < oldSize; i++)
            newData[i] = oldData[i];
        return newData;
    };
    DynamicTreeFlatNodes.prototype.raycast = function (callback, input) {
        var p1 = input.p1;
        var p2 = input.p2;
        var p1x = p1.x, p2x = p2.x, p1y = p1.y, p2y = p2.y;
        var vx, vy;
        var rx, ry;
        var absVx, absVy;
        var cx, cy;
        var hx, hy;
        var tempx, tempy;
        this.r.x = p2x - p1x;
        this.r.y = p2y - p1y;
        this.r.normalize();
        rx = this.r.x;
        ry = this.r.y;
        vx = -1 * ry;
        vy = 1 * rx;
        absVx = dMath.Abs(vx);
        absVy = dMath.Abs(vy);
        var maxFraction = input.maxFraction;
        var segAABB = this.aabb;
        tempx = (p2x - p1x) * maxFraction + p1x;
        tempy = (p2y - p1y) * maxFraction + p1y;
        segAABB.lowerBound.x = p1x < tempx ? p1x : tempx;
        segAABB.lowerBound.y = p1y < tempy ? p1y : tempy;
        segAABB.upperBound.x = p1x > tempx ? p1x : tempx;
        segAABB.upperBound.y = p1y > tempy ? p1y : tempy;
        this.nodeStackIndex = 0;
        this.nodeStack[this.nodeStackIndex++] = this.m_root;
        while (this.nodeStackIndex > 0) {
            var node = this.nodeStack[--this.nodeStackIndex] = this.m_root;
            if (node == DynamicTreeFlatNodes.NULL_NODE) {
                continue;
            }
            var nodeAABB = this.m_aabb[node];
            if (!AABB.testOverlap(nodeAABB, segAABB)) {
                continue;
            }
            cx = (nodeAABB.lowerBound.x + nodeAABB.upperBound.x) * 0.5;
            cy = (nodeAABB.lowerBound.y + nodeAABB.upperBound.y) * 0.5;
            hx = (nodeAABB.upperBound.x - nodeAABB.lowerBound.x) * 0.5;
            hy = (nodeAABB.upperBound.y - nodeAABB.lowerBound.y) * 0.5;
            tempx = p1x - cx;
            tempy = p1y - cy;
            var separation = dMath.Abs(vx * tempx + vy * tempy) - (absVx * hx + absVy * hy);
            if (separation > 0.0) {
                continue;
            }
            var child1 = this.m_child1[node];
            if (child1 == DynamicTreeFlatNodes.NULL_NODE) {
                this.subInput.p1.x = p1x;
                this.subInput.p1.y = p1y;
                this.subInput.p2.x = p2x;
                this.subInput.p2.y = p2y;
                this.subInput.maxFraction = maxFraction;
                var value = callback.raycastCallback(this.subInput, node);
                if (value == 0.0) {
                    return;
                }
                if (value > 0.0) {
                    maxFraction = value;
                    tempx = (p2x - p1x) * maxFraction + p1x;
                    tempy = (p2y - p1y) * maxFraction + p1y;
                    segAABB.lowerBound.x = p1x < tempx ? p1x : tempx;
                    segAABB.lowerBound.y = p1y < tempy ? p1y : tempy;
                    segAABB.upperBound.x = p1x > tempx ? p1x : tempx;
                    segAABB.upperBound.y = p1y > tempy ? p1y : tempy;
                }
            }
            else {
                this.nodeStack[this.nodeStackIndex++] = child1;
                this.nodeStack[this.nodeStackIndex++] = this.m_child2[node];
            }
        }
    };
    DynamicTreeFlatNodes.prototype.computeHeight = function () {
        return this.computeHeightNode(this.m_root);
    };
    DynamicTreeFlatNodes.prototype.computeHeightNode = function (node) {
        if (this.m_child1[node] == DynamicTreeFlatNodes.NULL_NODE) {
            return 0;
        }
        var height1 = this.computeHeightNode(this.m_child1[node]);
        var height2 = this.computeHeightNode(this.m_child2[node]);
        return 1 + dMath.Max(height1, height2);
    };
    DynamicTreeFlatNodes.prototype.validate = function () {
        this.validateStructure(this.m_root);
        this.validateMetrics(this.m_root);
        var freeCount = 0;
        var freeNode = this.m_freeList;
        while (freeNode != DynamicTreeFlatNodes.NULL_NODE) {
            freeNode = this.m_parent[freeNode];
            ++freeCount;
        }
    };
    DynamicTreeFlatNodes.prototype.getHeight = function () {
        if (this.m_root == DynamicTreeFlatNodes.NULL_NODE) {
            return 0;
        }
        return this.m_height[this.m_root];
    };
    DynamicTreeFlatNodes.prototype.getMaxBalance = function () {
        var maxBalance = 0;
        for (var i = 0; i < this.m_nodeCapacity; ++i) {
            if (this.m_height[i] <= 1) {
                continue;
            }
            var child1 = this.m_child1[i];
            var child2 = this.m_child2[i];
            var balance = dMath.Abs(this.m_height[child2] - this.m_height[child1]);
            maxBalance = dMath.Max(maxBalance, balance);
        }
        return maxBalance;
    };
    DynamicTreeFlatNodes.prototype.getAreaRatio = function () {
        if (this.m_root == DynamicTreeFlatNodes.NULL_NODE) {
            return 0.0;
        }
        var root = this.m_root;
        var rootArea = this.m_aabb[root].getPerimeter();
        var totalArea = 0.0;
        for (var i = 0; i < this.m_nodeCapacity; ++i) {
            if (this.m_height[i] < 0) {
                continue;
            }
            totalArea += this.m_aabb[i].getPerimeter();
        }
        return totalArea / rootArea;
    };
    DynamicTreeFlatNodes.prototype.allocateNode = function () {
        if (this.m_freeList == DynamicTreeFlatNodes.NULL_NODE) {
            this.m_nodeCapacity *= 2;
            this.expandBuffers(this.m_nodeCount, this.m_nodeCapacity);
        }
        var node = this.m_freeList;
        this.m_freeList = this.m_parent[node];
        this.m_parent[node] = DynamicTreeFlatNodes.NULL_NODE;
        this.m_child1[node] = DynamicTreeFlatNodes.NULL_NODE;
        this.m_height[node] = 0;
        ++this.m_nodeCount;
        return node;
    };
    DynamicTreeFlatNodes.prototype.freeNode = function (node) {
        this.m_parent[node] = this.m_freeList != DynamicTreeFlatNodes.NULL_NODE ? this.m_freeList : DynamicTreeFlatNodes.NULL_NODE;
        this.m_height[node] = -1;
        this.m_freeList = node;
        this.m_nodeCount--;
    };
    DynamicTreeFlatNodes.prototype.insertLeaf = function (leaf) {
        if (this.m_root == DynamicTreeFlatNodes.NULL_NODE) {
            this.m_root = leaf;
            this.m_parent[this.m_root] = DynamicTreeFlatNodes.NULL_NODE;
            return;
        }
        var leafAABB = this.m_aabb[leaf];
        var index = this.m_root;
        while (this.m_child1[index] != DynamicTreeFlatNodes.NULL_NODE) {
            var node = index;
            var child1 = this.m_child1[node];
            var child2 = this.m_child2[node];
            var nodeAABB = this.m_aabb[node];
            var area = nodeAABB.getPerimeter();
            this.combinedAABB.combine2(nodeAABB, leafAABB);
            var combinedArea = this.combinedAABB.getPerimeter();
            var cost = 2.0 * combinedArea;
            var inheritanceCost = 2.0 * (combinedArea - area);
            var cost1 = 0;
            var child1AABB = this.m_aabb[child1];
            if (this.m_child1[child1] == DynamicTreeFlatNodes.NULL_NODE) {
                this.combinedAABB.combine2(leafAABB, child1AABB);
                cost1 = this.combinedAABB.getPerimeter() + inheritanceCost;
            }
            else {
                this.combinedAABB.combine2(leafAABB, child1AABB);
                var oldArea = child1AABB.getPerimeter();
                var newArea = this.combinedAABB.getPerimeter();
                cost1 = (newArea - oldArea) + inheritanceCost;
            }
            var cost2 = 0;
            var child2AABB = this.m_aabb[child2];
            if (this.m_child1[child2] == DynamicTreeFlatNodes.NULL_NODE) {
                this.combinedAABB.combine2(leafAABB, child2AABB);
                cost2 = this.combinedAABB.getPerimeter() + inheritanceCost;
            }
            else {
                this.combinedAABB.combine2(leafAABB, child2AABB);
                var oldArea = child2AABB.getPerimeter();
                var newArea = this.combinedAABB.getPerimeter();
                cost2 = newArea - oldArea + inheritanceCost;
            }
            if (cost < cost1 && cost < cost2) {
                break;
            }
            if (cost1 < cost2) {
                index = child1;
            }
            else {
                index = child2;
            }
        }
        var sibling = index;
        var oldParent = this.m_parent[sibling];
        var newParent = this.allocateNode();
        this.m_parent[newParent] = oldParent;
        this.m_userData[newParent] = null;
        this.m_aabb[newParent].combine2(leafAABB, this.m_aabb[sibling]);
        this.m_height[newParent] = this.m_height[sibling] + 1;
        if (oldParent != DynamicTreeFlatNodes.NULL_NODE) {
            if (this.m_child1[oldParent] == sibling) {
                this.m_child1[oldParent] = newParent;
            }
            else {
                this.m_child2[oldParent] = newParent;
            }
            this.m_child1[newParent] = sibling;
            this.m_child2[newParent] = leaf;
            this.m_parent[sibling] = newParent;
            this.m_parent[leaf] = newParent;
        }
        else {
            this.m_child1[newParent] = sibling;
            this.m_child2[newParent] = leaf;
            this.m_parent[sibling] = newParent;
            this.m_parent[leaf] = newParent;
            this.m_root = newParent;
        }
        index = this.m_parent[leaf];
        while (index != DynamicTreeFlatNodes.NULL_NODE) {
            index = this.balance(index);
            var child1 = this.m_child1[index];
            var child2 = this.m_child2[index];
            this.m_height[index] = 1 + dMath.Max(this.m_height[child1], this.m_height[child2]);
            this.m_aabb[index].combine2(this.m_aabb[child1], this.m_aabb[child2]);
            index = this.m_parent[index];
        }
    };
    DynamicTreeFlatNodes.prototype.removeLeaf = function (leaf) {
        if (leaf == this.m_root) {
            this.m_root = DynamicTreeFlatNodes.NULL_NODE;
            return;
        }
        var parent = this.m_parent[leaf];
        var grandParent = this.m_parent[parent];
        var parentChild1 = this.m_child1[parent];
        var parentChild2 = this.m_child2[parent];
        var sibling;
        if (parentChild1 == leaf) {
            sibling = parentChild2;
        }
        else {
            sibling = parentChild1;
        }
        if (grandParent != DynamicTreeFlatNodes.NULL_NODE) {
            if (this.m_child1[grandParent] == parent) {
                this.m_child1[grandParent] = sibling;
            }
            else {
                this.m_child2[grandParent] = sibling;
            }
            this.m_parent[sibling] = grandParent;
            this.freeNode(parent);
            var index = grandParent;
            while (index != DynamicTreeFlatNodes.NULL_NODE) {
                index = this.balance(index);
                var child1 = this.m_child1[index];
                var child2 = this.m_child2[index];
                this.m_aabb[index].combine2(this.m_aabb[child1], this.m_aabb[child2]);
                this.m_height[index] = 1 + dMath.Max(this.m_height[child1], this.m_height[child2]);
                index = this.m_parent[index];
            }
        }
        else {
            this.m_root = sibling;
            this.m_parent[sibling] = DynamicTreeFlatNodes.NULL_NODE;
            this.freeNode(parent);
        }
    };
    DynamicTreeFlatNodes.prototype.balance = function (iA) {
        var A = iA;
        if (this.m_child1[A] == DynamicTreeFlatNodes.NULL_NODE || this.m_height[A] < 2) {
            return iA;
        }
        var iB = this.m_child1[A];
        var iC = this.m_child2[A];
        var B = iB;
        var C = iC;
        var balance = this.m_height[C] - this.m_height[B];
        if (balance > 1) {
            var iF = this.m_child1[C];
            var iG = this.m_child2[C];
            var F = iF;
            var G = iG;
            this.m_child1[C] = iA;
            var cParent;
            cParent = this.m_parent[C] = this.m_parent[A];
            this.m_parent[A] = iC;
            if (cParent != DynamicTreeFlatNodes.NULL_NODE) {
                if (this.m_child1[cParent] == iA) {
                    this.m_child1[cParent] = iC;
                }
                else {
                    this.m_child2[cParent] = iC;
                }
            }
            else {
                this.m_root = iC;
            }
            if (this.m_height[F] > this.m_height[G]) {
                this.m_child2[C] = iF;
                this.m_child2[A] = iG;
                this.m_parent[G] = iA;
                this.m_aabb[A].combine2(this.m_aabb[B], this.m_aabb[G]);
                this.m_aabb[C].combine2(this.m_aabb[A], this.m_aabb[F]);
                this.m_height[A] = 1 + dMath.Max(this.m_height[B], this.m_height[G]);
                this.m_height[C] = 1 + dMath.Max(this.m_height[A], this.m_height[F]);
            }
            else {
                this.m_child2[C] = iG;
                this.m_child2[A] = iF;
                this.m_parent[F] = iA;
                this.m_aabb[A].combine2(this.m_aabb[B], this.m_aabb[F]);
                this.m_aabb[C].combine2(this.m_aabb[A], this.m_aabb[G]);
                this.m_height[A] = 1 + dMath.Max(this.m_height[B], this.m_height[F]);
                this.m_height[C] = 1 + dMath.Max(this.m_height[A], this.m_height[G]);
            }
            return iC;
        }
        if (balance < -1) {
            var iD = this.m_child1[B];
            var iE = this.m_child2[B];
            var D = iD;
            var E = iE;
            this.m_child1[B] = iA;
            var Bparent;
            Bparent = this.m_parent[B] = this.m_parent[A];
            this.m_parent[A] = iB;
            if (Bparent != DynamicTreeFlatNodes.NULL_NODE) {
                if (this.m_child1[Bparent] == iA) {
                    this.m_child1[Bparent] = iB;
                }
                else {
                    this.m_child2[Bparent] = iB;
                }
            }
            else {
                this.m_root = iB;
            }
            if (this.m_height[D] > this.m_height[E]) {
                this.m_child2[B] = iD;
                this.m_child1[A] = iE;
                this.m_parent[E] = iA;
                this.m_aabb[A].combine2(this.m_aabb[C], this.m_aabb[E]);
                this.m_aabb[B].combine2(this.m_aabb[A], this.m_aabb[D]);
                this.m_height[A] = 1 + dMath.Max(this.m_height[C], this.m_height[E]);
                this.m_height[B] = 1 + dMath.Max(this.m_height[A], this.m_height[D]);
            }
            else {
                this.m_child2[B] = iE;
                this.m_child1[A] = iD;
                this.m_parent[D] = iA;
                this.m_aabb[A].combine2(this.m_aabb[C], this.m_aabb[D]);
                this.m_aabb[B].combine2(this.m_aabb[A], this.m_aabb[E]);
                this.m_height[A] = 1 + dMath.Max(this.m_height[C], this.m_height[D]);
                this.m_height[B] = 1 + dMath.Max(this.m_height[A], this.m_height[E]);
            }
            return iB;
        }
        return iA;
    };
    DynamicTreeFlatNodes.prototype.validateStructure = function (node) {
        if (node == DynamicTreeFlatNodes.NULL_NODE) {
            return;
        }
        if (node == this.m_root) {
        }
        var child1 = this.m_child1[node];
        var child2 = this.m_child2[node];
        if (child1 == DynamicTreeFlatNodes.NULL_NODE) {
            return;
        }
        this.validateStructure(child1);
        this.validateStructure(child2);
    };
    DynamicTreeFlatNodes.prototype.validateMetrics = function (node) {
        if (node == DynamicTreeFlatNodes.NULL_NODE) {
            return;
        }
        var child1 = this.m_child1[node];
        var child2 = this.m_child2[node];
        if (child1 == DynamicTreeFlatNodes.NULL_NODE) {
            return;
        }
        var height1 = this.m_height[child1];
        var height2 = this.m_height[child2];
        var height;
        height = 1 + dMath.Max(height1, height2);
        var aabb = new AABB();
        aabb.combine2(this.m_aabb[child1], this.m_aabb[child2]);
        this.validateMetrics(child1);
        this.validateMetrics(child2);
    };
    DynamicTreeFlatNodes.MAX_STACK_SIZE = 64;
    DynamicTreeFlatNodes.NULL_NODE = -1;
    DynamicTreeFlatNodes.INITIAL_BUFFER_LENGTH = 16;
    return DynamicTreeFlatNodes;
}(BroadPhaseStrategy));
var DynamicTreeNode = (function () {
    function DynamicTreeNode(id) {
        this.aabb = new AABB();
        this.userData = null;
        this.parent = null;
        this.child1 = null;
        this.child2 = null;
        this.id = 0;
        this.height = 0;
        this.id = id;
    }
    DynamicTreeNode.prototype.getUserData = function () {
        return this.userData;
    };
    DynamicTreeNode.prototype.setUserData = function (argData) {
        this.userData = argData;
    };
    return DynamicTreeNode;
}());
var Pair = (function () {
    function Pair() {
        this.proxyIdA = 0;
        this.proxyIdB = 0;
    }
    Pair.prototype.compareTo = function (pair2) {
        if (this.proxyIdA < pair2.proxyIdA) {
            return -1;
        }
        if (this.proxyIdA == pair2.proxyIdA) {
            return this.proxyIdB < pair2.proxyIdB ? -1 : this.proxyIdB == pair2.proxyIdB ? 0 : 1;
        }
        return 1;
    };
    return Pair;
}());
var Shape = (function () {
    function Shape(type) {
        this.m_type = 0;
        this.m_radius = 0;
        this.m_type = type;
    }
    Shape.prototype.getType = function () {
        return this.m_type;
    };
    Shape.prototype.getRadius = function () {
        return this.m_radius;
    };
    Shape.prototype.setRadius = function (radius) {
        this.m_radius = radius;
    };
    Shape.prototype.getChildCount = function () {
        return 0;
    };
    Shape.prototype.testPoint = function (xf, p) {
        return false;
    };
    Shape.prototype.raycast = function (output, input, transform, childIndex) {
        return false;
    };
    Shape.prototype.computeAABB = function (aabb, xf, childIndex) {
    };
    Shape.prototype.computeMass = function (massData, density) {
    };
    Shape.prototype.computeDistanceToOut = function (xf, p, childIndex, normalOut) {
        return 0;
    };
    Shape.prototype.clone = function () {
        return null;
    };
    return Shape;
}());
var ChainShape = (function (_super) {
    __extends(ChainShape, _super);
    function ChainShape() {
        var _this = _super.call(this, ShapeType.CHAIN) || this;
        _this.m_vertices = null;
        _this.m_count = 0;
        _this.m_prevVertex = new Vec2();
        _this.m_nextVertex = new Vec2();
        _this.m_hasPrevVertex = false;
        _this.m_hasNextVertex = false;
        _this.pool0 = new EdgeShape();
        _this.m_vertices = null;
        _this.m_radius = Settings.polygonRadius;
        _this.m_count = 0;
        return _this;
    }
    ChainShape.prototype.clear = function () {
        this.m_vertices = null;
        this.m_count = 0;
    };
    ChainShape.prototype.getChildCount = function () {
        return this.m_count - 1;
    };
    ChainShape.prototype.getChildEdge = function (edge, index) {
        edge.m_radius = this.m_radius;
        var v0 = this.m_vertices[index + 0];
        var v1 = this.m_vertices[index + 1];
        edge.m_vertex1.x = v0.x;
        edge.m_vertex1.y = v0.y;
        edge.m_vertex2.x = v1.x;
        edge.m_vertex2.y = v1.y;
        if (index > 0) {
            var v = this.m_vertices[index - 1];
            edge.m_vertex0.x = v.x;
            edge.m_vertex0.y = v.y;
            edge.m_hasVertex0 = true;
        }
        else {
            edge.m_vertex0.x = this.m_prevVertex.x;
            edge.m_vertex0.y = this.m_prevVertex.y;
            edge.m_hasVertex0 = this.m_hasPrevVertex;
        }
        if (index < this.m_count - 2) {
            var v = this.m_vertices[index + 2];
            edge.m_vertex3.x = v.x;
            edge.m_vertex3.y = v.y;
            edge.m_hasVertex3 = true;
        }
        else {
            edge.m_vertex3.x = this.m_nextVertex.x;
            edge.m_vertex3.y = this.m_nextVertex.y;
            edge.m_hasVertex3 = this.m_hasNextVertex;
        }
    };
    ChainShape.prototype.computeDistanceToOut = function (xf, p, childIndex, normalOut) {
        var edge = this.pool0;
        this.getChildEdge(edge, childIndex);
        return edge.computeDistanceToOut(xf, p, 0, normalOut);
    };
    ChainShape.prototype.testPoint = function (xf, p) {
        return false;
    };
    ChainShape.prototype.raycast = function (output, input, xf, childIndex) {
        var edgeShape = this.pool0;
        var i1 = childIndex;
        var i2 = childIndex + 1;
        if (i2 == this.m_count) {
            i2 = 0;
        }
        var v = this.m_vertices[i1];
        edgeShape.m_vertex1.x = v.x;
        edgeShape.m_vertex1.y = v.y;
        var v1 = this.m_vertices[i2];
        edgeShape.m_vertex2.x = v1.x;
        edgeShape.m_vertex2.y = v1.y;
        return edgeShape.raycast(output, input, xf, 0);
    };
    ChainShape.prototype.computeAABB = function (aabb, xf, childIndex) {
        var lower = aabb.lowerBound;
        var upper = aabb.upperBound;
        var i1 = childIndex;
        var i2 = childIndex + 1;
        if (i2 == this.m_count) {
            i2 = 0;
        }
        var vi1 = this.m_vertices[i1];
        var vi2 = this.m_vertices[i2];
        var xfq = xf.q;
        var xfp = xf.p;
        var v1x = (xfq.c * vi1.x - xfq.s * vi1.y) + xfp.x;
        var v1y = (xfq.s * vi1.x + xfq.c * vi1.y) + xfp.y;
        var v2x = (xfq.c * vi2.x - xfq.s * vi2.y) + xfp.x;
        var v2y = (xfq.s * vi2.x + xfq.c * vi2.y) + xfp.y;
        lower.x = v1x < v2x ? v1x : v2x;
        lower.y = v1y < v2y ? v1y : v2y;
        upper.x = v1x > v2x ? v1x : v2x;
        upper.y = v1y > v2y ? v1y : v2y;
    };
    ChainShape.prototype.computeMass = function (massData, density) {
        massData.mass = 0.0;
        massData.center.setZero();
        massData.I = 0.0;
    };
    ChainShape.prototype.clone = function () {
        var clone = new ChainShape();
        clone.createChain(this.m_vertices, this.m_count);
        clone.m_prevVertex.set(this.m_prevVertex);
        clone.m_nextVertex.set(this.m_nextVertex);
        clone.m_hasPrevVertex = this.m_hasPrevVertex;
        clone.m_hasNextVertex = this.m_hasNextVertex;
        return clone;
    };
    ChainShape.prototype.createLoop = function (vertices, count) {
        this.m_count = count + 1;
        this.m_vertices = new Array(this.m_count);
        for (var i = 1; i < count; i++) {
            var v1 = vertices[i - 1];
            var v2 = vertices[i];
            if (MathUtils.distanceSquared(v1, v2) < Settings.linearSlop * Settings.linearSlop) {
                throw "Vertices of chain shape are too close together";
            }
        }
        for (var i = 0; i < count; i++) {
            this.m_vertices[i] = vertices[i].clone();
        }
        this.m_vertices[count] = new Vec2().set(this.m_vertices[0]);
        this.m_prevVertex.set(this.m_vertices[this.m_count - 2]);
        this.m_nextVertex.set(this.m_vertices[1]);
        this.m_hasPrevVertex = true;
        this.m_hasNextVertex = true;
    };
    ChainShape.prototype.setV2 = function (verts) {
        var v = new Array(verts.length);
        for (var i = 0; i < verts.length; i++)
            v[i] = new Vec2(verts[i].x / dBox2D.PTM_RATIO, verts[i].y / dBox2D.PTM_RATIO);
        this.createChain(v, v.length);
    };
    ChainShape.prototype.createChain = function (vertices, count) {
        this.m_count = count;
        this.m_vertices = new Array(this.m_count);
        for (var i = 1; i < this.m_count; i++) {
            var v1 = vertices[i - 1];
            var v2 = vertices[i];
            if (MathUtils.distanceSquared(v1, v2) < Settings.linearSlop * Settings.linearSlop) {
                throw "Vertices of chain shape are too close together";
            }
        }
        for (var i = 0; i < this.m_count; i++) {
            this.m_vertices[i] = new Vec2().set(vertices[i]);
        }
        this.m_hasPrevVertex = false;
        this.m_hasNextVertex = false;
        this.m_prevVertex.setZero();
        this.m_nextVertex.setZero();
    };
    ChainShape.prototype.setPrevVertex = function (prevVertex) {
        this.m_prevVertex.set(prevVertex);
        this.m_hasPrevVertex = true;
    };
    ChainShape.prototype.setNextVertex = function (nextVertex) {
        this.m_nextVertex.set(nextVertex);
        this.m_hasNextVertex = true;
    };
    return ChainShape;
}(Shape));
var CircleShape = (function (_super) {
    __extends(CircleShape, _super);
    function CircleShape() {
        var _this = _super.call(this, ShapeType.CIRCLE) || this;
        _this.m_p = null;
        _this.m_p = new Vec2();
        _this.m_radius = 0;
        return _this;
    }
    CircleShape.prototype.clone = function () {
        var shape = new CircleShape();
        shape.m_p.x = this.m_p.x;
        shape.m_p.y = this.m_p.y;
        shape.m_radius = this.m_radius;
        return shape;
    };
    CircleShape.prototype.getChildCount = function () {
        return 1;
    };
    CircleShape.prototype.getSupport = function (d) {
        return 0;
    };
    CircleShape.prototype.getSupportVertex = function (d) {
        return this.m_p;
    };
    CircleShape.prototype.getVertexCount = function () {
        return 1;
    };
    CircleShape.prototype.getVertex = function (index) {
        return this.m_p;
    };
    CircleShape.prototype.testPoint = function (transform, p) {
        var q = transform.q;
        var tp = transform.p;
        var centerx = -(q.c * this.m_p.x - q.s * this.m_p.y + tp.x - p.x);
        var centery = -(q.s * this.m_p.x + q.c * this.m_p.y + tp.y - p.y);
        return centerx * centerx + centery * centery <= this.m_radius * this.m_radius;
    };
    CircleShape.prototype.computeDistanceToOut = function (xf, p, childIndex, normalOut) {
        var xfq = xf.q;
        var centerx = xfq.c * this.m_p.x - xfq.s * this.m_p.y + xf.p.x;
        var centery = xfq.s * this.m_p.x + xfq.c * this.m_p.y + xf.p.y;
        var dx = p.x - centerx;
        var dy = p.y - centery;
        var d1 = MathUtils.sqrt(dx * dx + dy * dy);
        normalOut.x = dx * 1 / d1;
        normalOut.y = dy * 1 / d1;
        return d1 - this.m_radius;
    };
    CircleShape.prototype.raycast = function (output, input, transform, childIndex) {
        var inputp1 = input.p1;
        var inputp2 = input.p2;
        var tq = transform.q;
        var tp = transform.p;
        var positionx = tq.c * this.m_p.x - tq.s * this.m_p.y + tp.x;
        var positiony = tq.s * this.m_p.x + tq.c * this.m_p.y + tp.y;
        var sx = inputp1.x - positionx;
        var sy = inputp1.y - positiony;
        var b = sx * sx + sy * sy - this.m_radius * this.m_radius;
        var rx = inputp2.x - inputp1.x;
        var ry = inputp2.y - inputp1.y;
        var c = sx * rx + sy * ry;
        var rr = rx * rx + ry * ry;
        var sigma = c * c - rr * b;
        if (sigma < 0.0 || rr < Settings.EPSILON) {
            return false;
        }
        var a = -(c + MathUtils.sqrt(sigma));
        if (0.0 <= a && a <= input.maxFraction * rr) {
            a /= rr;
            output.fraction = a;
            output.normal.x = rx * a + sx;
            output.normal.y = ry * a + sy;
            output.normal.normalize();
            return true;
        }
        return false;
    };
    CircleShape.prototype.computeAABB = function (aabb, transform, childIndex) {
        var tq = transform.q;
        var tp = transform.p;
        var px = tq.c * this.m_p.x - tq.s * this.m_p.y + tp.x;
        var py = tq.s * this.m_p.x + tq.c * this.m_p.y + tp.y;
        aabb.lowerBound.x = px - this.m_radius;
        aabb.lowerBound.y = py - this.m_radius;
        aabb.upperBound.x = px + this.m_radius;
        aabb.upperBound.y = py + this.m_radius;
    };
    CircleShape.prototype.computeMass = function (massData, density) {
        massData.mass = density * dMath.dPI * this.m_radius * this.m_radius;
        massData.center.x = this.m_p.x;
        massData.center.y = this.m_p.y;
        massData.I = massData.mass * (0.5 * this.m_radius * this.m_radius + (this.m_p.x * this.m_p.x + this.m_p.y * this.m_p.y));
    };
    return CircleShape;
}(Shape));
var EdgeShape = (function (_super) {
    __extends(EdgeShape, _super);
    function EdgeShape() {
        var _this = _super.call(this, ShapeType.EDGE) || this;
        _this.m_vertex1 = new Vec2();
        _this.m_vertex2 = new Vec2();
        _this.m_vertex0 = new Vec2();
        _this.m_vertex3 = new Vec2();
        _this.m_hasVertex0 = false;
        _this.m_hasVertex3 = false;
        _this.normal = new Vec2();
        _this.m_radius = Settings.polygonRadius;
        return _this;
    }
    EdgeShape.prototype.getChildCount = function () {
        return 1;
    };
    EdgeShape.prototype.set = function (v1, v2) {
        this.m_vertex1.set(v1);
        this.m_vertex2.set(v2);
        this.m_hasVertex0 = this.m_hasVertex3 = false;
    };
    EdgeShape.prototype.testPoint = function (xf, p) {
        return false;
    };
    EdgeShape.prototype.computeDistanceToOut = function (xf, p, childIndex, normalOut) {
        var xfqc = xf.q.c;
        var xfqs = xf.q.s;
        var xfpx = xf.p.x;
        var xfpy = xf.p.y;
        var v1x = (xfqc * this.m_vertex1.x - xfqs * this.m_vertex1.y) + xfpx;
        var v1y = (xfqs * this.m_vertex1.x + xfqc * this.m_vertex1.y) + xfpy;
        var v2x = (xfqc * this.m_vertex2.x - xfqs * this.m_vertex2.y) + xfpx;
        var v2y = (xfqs * this.m_vertex2.x + xfqc * this.m_vertex2.y) + xfpy;
        var dx = p.x - v1x;
        var dy = p.y - v1y;
        var sx = v2x - v1x;
        var sy = v2y - v1y;
        var ds = dx * sx + dy * sy;
        if (ds > 0) {
            var s2 = sx * sx + sy * sy;
            if (ds > s2) {
                dx = p.x - v2x;
                dy = p.y - v2y;
            }
            else {
                dx -= ds / s2 * sx;
                dy -= ds / s2 * sy;
            }
        }
        var d1 = MathUtils.sqrt(dx * dx + dy * dy);
        if (d1 > 0) {
            normalOut.x = 1 / d1 * dx;
            normalOut.y = 1 / d1 * dy;
        }
        else {
            normalOut.x = 0;
            normalOut.y = 0;
        }
        return d1;
    };
    EdgeShape.prototype.raycast = function (output, input, xf, childIndex) {
        var tempx = 0, tempy = 0;
        var v1 = this.m_vertex1;
        var v2 = this.m_vertex2;
        var xfq = xf.q;
        var xfp = xf.p;
        tempx = input.p1.x - xfp.x;
        tempy = input.p1.y - xfp.y;
        var p1x = xfq.c * tempx + xfq.s * tempy;
        var p1y = -xfq.s * tempx + xfq.c * tempy;
        tempx = input.p2.x - xfp.x;
        tempy = input.p2.y - xfp.y;
        var p2x = xfq.c * tempx + xfq.s * tempy;
        var p2y = -xfq.s * tempx + xfq.c * tempy;
        var dx = p2x - p1x;
        var dy = p2y - p1y;
        this.normal.x = v2.y - v1.y;
        this.normal.y = v1.x - v2.x;
        this.normal.normalize();
        var normalx = this.normal.x;
        var normaly = this.normal.y;
        tempx = v1.x - p1x;
        tempy = v1.y - p1y;
        var numerator = normalx * tempx + normaly * tempy;
        var denominator = normalx * dx + normaly * dy;
        if (denominator == 0.0) {
            return false;
        }
        var t = numerator / denominator;
        if (t < 0.0 || 1.0 < t) {
            return false;
        }
        var qx = p1x + t * dx;
        var qy = p1y + t * dy;
        var rx = v2.x - v1.x;
        var ry = v2.y - v1.y;
        var rr = rx * rx + ry * ry;
        if (rr == 0.0) {
            return false;
        }
        tempx = qx - v1.x;
        tempy = qy - v1.y;
        var s = (tempx * rx + tempy * ry) / rr;
        if (s < 0.0 || 1.0 < s) {
            return false;
        }
        output.fraction = t;
        if (numerator > 0.0) {
            output.normal.x = -xfq.c * this.normal.x + xfq.s * this.normal.y;
            output.normal.y = -xfq.s * this.normal.x - xfq.c * this.normal.y;
        }
        else {
            output.normal.x = xfq.c * this.normal.x - xfq.s * this.normal.y;
            output.normal.y = xfq.s * this.normal.x + xfq.c * this.normal.y;
        }
        return true;
    };
    EdgeShape.prototype.computeAABB = function (aabb, xf, childIndex) {
        var lowerBound = aabb.lowerBound;
        var upperBound = aabb.upperBound;
        var xfq = xf.q;
        var v1x = (xfq.c * this.m_vertex1.x - xfq.s * this.m_vertex1.y) + xf.p.x;
        var v1y = (xfq.s * this.m_vertex1.x + xfq.c * this.m_vertex1.y) + xf.p.y;
        var v2x = (xfq.c * this.m_vertex2.x - xfq.s * this.m_vertex2.y) + xf.p.x;
        var v2y = (xfq.s * this.m_vertex2.x + xfq.c * this.m_vertex2.y) + xf.p.y;
        lowerBound.x = v1x < v2x ? v1x : v2x;
        lowerBound.y = v1y < v2y ? v1y : v2y;
        upperBound.x = v1x > v2x ? v1x : v2x;
        upperBound.y = v1y > v2y ? v1y : v2y;
        lowerBound.x -= this.m_radius;
        lowerBound.y -= this.m_radius;
        upperBound.x += this.m_radius;
        upperBound.y += this.m_radius;
    };
    EdgeShape.prototype.computeMass = function (massData, density) {
        massData.mass = 0.0;
        massData.center.set(this.m_vertex1).addLocal(this.m_vertex2).mulLocal(0.5);
        massData.I = 0.0;
    };
    EdgeShape.prototype.clone = function () {
        var edge = new EdgeShape();
        edge.m_radius = this.m_radius;
        edge.m_hasVertex0 = this.m_hasVertex0;
        edge.m_hasVertex3 = this.m_hasVertex3;
        edge.m_vertex0.set(this.m_vertex0);
        edge.m_vertex1.set(this.m_vertex1);
        edge.m_vertex2.set(this.m_vertex2);
        edge.m_vertex3.set(this.m_vertex3);
        return edge;
    };
    return EdgeShape;
}(Shape));
var MassData = (function () {
    function MassData() {
        this.mass = 0;
        this.center = null;
        this.I = 0;
        this.mass = this.I = 0;
        this.center = new Vec2();
    }
    MassData.prototype.set = function (md) {
        this.mass = md.mass;
        this.I = md.I;
        this.center.set(md.center);
        return this;
    };
    MassData.prototype.clone = function () {
        return new MassData().set(this);
    };
    return MassData;
}());
var PolygonShape = (function (_super) {
    __extends(PolygonShape, _super);
    function PolygonShape() {
        var _this = _super.call(this, ShapeType.POLYGON) || this;
        _this.m_centroid = new Vec2();
        _this.m_vertices = null;
        _this.m_normals = null;
        _this.m_count = 0;
        _this.pool1 = new Vec2();
        _this.pool2 = new Vec2();
        _this.pool3 = new Vec2();
        _this.pool4 = new Vec2();
        _this.poolt1 = new Transform();
        _this.m_count = 0;
        _this.m_vertices = new Array(Settings.maxPolygonVertices);
        for (var i = 0; i < _this.m_vertices.length; i++) {
            _this.m_vertices[i] = new Vec2();
        }
        _this.m_normals = new Array(Settings.maxPolygonVertices);
        for (var i = 0; i < _this.m_normals.length; i++) {
            _this.m_normals[i] = new Vec2();
        }
        _this.setRadius(Settings.polygonRadius);
        _this.m_centroid.setZero();
        return _this;
    }
    PolygonShape.prototype.clone = function () {
        var shape = new PolygonShape();
        shape.m_centroid.set(this.m_centroid);
        for (var i = 0; i < shape.m_normals.length; i++) {
            shape.m_normals[i].set(this.m_normals[i]);
            shape.m_vertices[i].set(this.m_vertices[i]);
        }
        shape.setRadius(this.getRadius());
        shape.m_count = this.m_count;
        return shape;
    };
    PolygonShape.prototype.setV2 = function (verts) {
        var v = new Array(verts.length);
        for (var i = 0; i < verts.length; i++)
            v[i] = new Vec2(verts[i].x / dBox2D.PTM_RATIO, verts[i].y / dBox2D.PTM_RATIO);
        this.set(v);
    };
    PolygonShape.prototype.set = function (verts, num, vecPool, intPool) {
        if (num === void 0) { num = 0; }
        if (vecPool === void 0) { vecPool = null; }
        if (intPool === void 0) { intPool = null; }
        if (num == 0)
            num = verts.length;
        if (num < 3) {
            this.setAsBox2(1.0, 1.0);
            return;
        }
        var n = dMath.Min(num, Settings.maxPolygonVertices);
        var ps = (vecPool != null)
            ? vecPool.get(Settings.maxPolygonVertices)
            : new Array(Settings.maxPolygonVertices);
        var tempCount = 0;
        for (var i = 0; i < n; ++i) {
            var v = verts[i];
            var unique = true;
            for (var j = 0; j < tempCount; ++j) {
                if (MathUtils.distanceSquared(v, ps[j]) < 0.5 * Settings.linearSlop) {
                    unique = false;
                    break;
                }
            }
            if (unique) {
                ps[tempCount++] = v;
            }
        }
        n = tempCount;
        if (n < 3) {
            this.setAsBox2(1.0, 1.0);
            return;
        }
        var i0 = 0;
        var x0 = ps[0].x;
        for (var i = 1; i < n; ++i) {
            var x = ps[i].x;
            if (x > x0 || (x == x0 && ps[i].y < ps[i0].y)) {
                i0 = i;
                x0 = x;
            }
        }
        var hull = (intPool != null)
            ? intPool.get(Settings.maxPolygonVertices)
            : new Array(Settings.maxPolygonVertices);
        var m = 0;
        var ih = i0;
        while (true) {
            hull[m] = ih;
            var ie = 0;
            for (var j = 1; j < n; ++j) {
                if (ie == ih) {
                    ie = j;
                    continue;
                }
                var r = this.pool1.set(ps[ie]).subLocal(ps[hull[m]]);
                var v = this.pool2.set(ps[j]).subLocal(ps[hull[m]]);
                var c = Vec2.cross(r, v);
                if (c < 0.0) {
                    ie = j;
                }
                if (c == 0.0 && v.lengthSquared() > r.lengthSquared()) {
                    ie = j;
                }
            }
            ++m;
            ih = ie;
            if (ie == i0) {
                break;
            }
        }
        this.m_count = m;
        for (var i = 0; i < this.m_count; ++i) {
            if (this.m_vertices[i] == null) {
                this.m_vertices[i] = new Vec2();
            }
            this.m_vertices[i].set(ps[hull[i]]);
        }
        var edge = this.pool1;
        for (var i = 0; i < this.m_count; ++i) {
            var i1 = i;
            var i2 = i + 1 < this.m_count ? i + 1 : 0;
            edge.set(this.m_vertices[i2]).subLocal(this.m_vertices[i1]);
            Vec2.crossToOutUnsafe(edge, 1, this.m_normals[i]);
            this.m_normals[i].normalize();
        }
        this.computeCentroidToOut(this.m_vertices, this.m_count, this.m_centroid);
    };
    PolygonShape.prototype.setAsBox2 = function (hx, hy) {
        this.m_count = 4;
        this.m_vertices[0].setValue(-hx, -hy);
        this.m_vertices[1].setValue(hx, -hy);
        this.m_vertices[2].setValue(hx, hy);
        this.m_vertices[3].setValue(-hx, hy);
        this.m_normals[0].setValue(0.0, -1.0);
        this.m_normals[1].setValue(1.0, 0.0);
        this.m_normals[2].setValue(0.0, 1.0);
        this.m_normals[3].setValue(-1.0, 0.0);
        this.m_centroid.setZero();
    };
    PolygonShape.prototype.setAsBox = function (hx, hy, center, angle) {
        this.m_count = 4;
        this.m_vertices[0].setValue(-hx, -hy);
        this.m_vertices[1].setValue(hx, -hy);
        this.m_vertices[2].setValue(hx, hy);
        this.m_vertices[3].setValue(-hx, hy);
        this.m_normals[0].setValue(0.0, -1.0);
        this.m_normals[1].setValue(1.0, 0.0);
        this.m_normals[2].setValue(0.0, 1.0);
        this.m_normals[3].setValue(-1.0, 0.0);
        this.m_centroid.set(center);
        var xf = this.poolt1;
        xf.p.set(center);
        xf.q.setValue(angle);
        for (var i = 0; i < this.m_count; ++i) {
            Transform.mulToOut(xf, this.m_vertices[i], this.m_vertices[i]);
            Rot.mulToOut(xf.q, this.m_normals[i], this.m_normals[i]);
        }
    };
    PolygonShape.prototype.getChildCount = function () {
        return 1;
    };
    PolygonShape.prototype.testPoint = function (xf, p) {
        var tempx = 0, tempy = 0;
        var xfq = xf.q;
        tempx = p.x - xf.p.x;
        tempy = p.y - xf.p.y;
        var pLocalx = xfq.c * tempx + xfq.s * tempy;
        var pLocaly = -xfq.s * tempx + xfq.c * tempy;
        for (var i = 0; i < this.m_count; ++i) {
            var vertex = this.m_vertices[i];
            var normal = this.m_normals[i];
            tempx = pLocalx - vertex.x;
            tempy = pLocaly - vertex.y;
            var dot = normal.x * tempx + normal.y * tempy;
            if (dot > 0.0) {
                return false;
            }
        }
        return true;
    };
    PolygonShape.prototype.computeAABB = function (aabb, xf, childIndex) {
        var lower = aabb.lowerBound;
        var upper = aabb.upperBound;
        var v1 = this.m_vertices[0];
        var xfqc = xf.q.c;
        var xfqs = xf.q.s;
        var xfpx = xf.p.x;
        var xfpy = xf.p.y;
        lower.x = (xfqc * v1.x - xfqs * v1.y) + xfpx;
        lower.y = (xfqs * v1.x + xfqc * v1.y) + xfpy;
        upper.x = lower.x;
        upper.y = lower.y;
        for (var i = 1; i < this.m_count; ++i) {
            var v2 = this.m_vertices[i];
            var vx = (xfqc * v2.x - xfqs * v2.y) + xfpx;
            var vy = (xfqs * v2.x + xfqc * v2.y) + xfpy;
            lower.x = lower.x < vx ? lower.x : vx;
            lower.y = lower.y < vy ? lower.y : vy;
            upper.x = upper.x > vx ? upper.x : vx;
            upper.y = upper.y > vy ? upper.y : vy;
        }
        lower.x -= this.m_radius;
        lower.y -= this.m_radius;
        upper.x += this.m_radius;
        upper.y += this.m_radius;
    };
    PolygonShape.prototype.getVertexCount = function () {
        return this.m_count;
    };
    PolygonShape.prototype.getVertex = function (index) {
        return this.m_vertices[index];
    };
    PolygonShape.prototype.computeDistanceToOut = function (xf, p, childIndex, normalOut) {
        var xfqc = xf.q.c;
        var xfqs = xf.q.s;
        var tx = p.x - xf.p.x;
        var ty = p.y - xf.p.y;
        var pLocalx = xfqc * tx + xfqs * ty;
        var pLocaly = -xfqs * tx + xfqc * ty;
        var maxDistance = -dMath.dFLOAT_MAX;
        var normalForMaxDistanceX = pLocalx;
        var normalForMaxDistanceY = pLocaly;
        for (var i = 0; i < this.m_count; ++i) {
            var vertex = this.m_vertices[i];
            var normal = this.m_normals[i];
            tx = pLocalx - vertex.x;
            ty = pLocaly - vertex.y;
            var dot = normal.x * tx + normal.y * ty;
            if (dot > maxDistance) {
                maxDistance = dot;
                normalForMaxDistanceX = normal.x;
                normalForMaxDistanceY = normal.y;
            }
        }
        var distance = 0;
        if (maxDistance > 0) {
            var minDistanceX = normalForMaxDistanceX;
            var minDistanceY = normalForMaxDistanceY;
            var minDistance2 = maxDistance * maxDistance;
            for (var i = 0; i < this.m_count; ++i) {
                var vertex = this.m_vertices[i];
                var distanceVecX = pLocalx - vertex.x;
                var distanceVecY = pLocaly - vertex.y;
                var distance2 = (distanceVecX * distanceVecX + distanceVecY * distanceVecY);
                if (minDistance2 > distance2) {
                    minDistanceX = distanceVecX;
                    minDistanceY = distanceVecY;
                    minDistance2 = distance2;
                }
            }
            distance = MathUtils.sqrt(minDistance2);
            normalOut.x = xfqc * minDistanceX - xfqs * minDistanceY;
            normalOut.y = xfqs * minDistanceX + xfqc * minDistanceY;
            normalOut.normalize();
        }
        else {
            distance = maxDistance;
            normalOut.x = xfqc * normalForMaxDistanceX - xfqs * normalForMaxDistanceY;
            normalOut.y = xfqs * normalForMaxDistanceX + xfqc * normalForMaxDistanceY;
        }
        return distance;
    };
    PolygonShape.prototype.raycast = function (output, input, xf, childIndex) {
        var xfqc = xf.q.c;
        var xfqs = xf.q.s;
        var xfp = xf.p;
        var tempx = 0, tempy = 0;
        tempx = input.p1.x - xfp.x;
        tempy = input.p1.y - xfp.y;
        var p1x = xfqc * tempx + xfqs * tempy;
        var p1y = -xfqs * tempx + xfqc * tempy;
        tempx = input.p2.x - xfp.x;
        tempy = input.p2.y - xfp.y;
        var p2x = xfqc * tempx + xfqs * tempy;
        var p2y = -xfqs * tempx + xfqc * tempy;
        var dx = p2x - p1x;
        var dy = p2y - p1y;
        var lower = 0, upper = input.maxFraction;
        var index = -1;
        for (var i = 0; i < this.m_count; ++i) {
            var normal = this.m_normals[i];
            var vertex = this.m_vertices[i];
            var tempxn = vertex.x - p1x;
            var tempyn = vertex.y - p1y;
            var numerator = normal.x * tempxn + normal.y * tempyn;
            var denominator = normal.x * dx + normal.y * dy;
            if (denominator == 0.0) {
                if (numerator < 0.0) {
                    return false;
                }
            }
            else {
                if (denominator < 0.0 && numerator < lower * denominator) {
                    lower = numerator / denominator;
                    index = i;
                }
                else if (denominator > 0.0 && numerator < upper * denominator) {
                    upper = numerator / denominator;
                }
            }
            if (upper < lower) {
                return false;
            }
        }
        if (index >= 0) {
            output.fraction = lower;
            var normal = this.m_normals[index];
            var outData2 = output.normal;
            outData2.x = xfqc * normal.x - xfqs * normal.y;
            outData2.y = xfqs * normal.x + xfqc * normal.y;
            return true;
        }
        return false;
    };
    PolygonShape.prototype.computeCentroidToOut = function (vs, count, outData2) {
        outData2.setValue(0.0, 0.0);
        var area = 0.0;
        var pRef = this.pool1;
        pRef.setZero();
        var e1 = this.pool2;
        var e2 = this.pool3;
        var inv3 = 1.0 / 3.0;
        for (var i = 0; i < count; ++i) {
            var p1 = pRef;
            var p2 = vs[i];
            var p3 = i + 1 < count ? vs[i + 1] : vs[0];
            e1.set(p2).subLocal(p1);
            e2.set(p3).subLocal(p1);
            var D = Vec2.cross(e1, e2);
            var triangleArea = 0.5 * D;
            area += triangleArea;
            e1.set(p1).addLocal(p2).addLocal(p3).mulLocal(triangleArea * inv3);
            outData2.addLocal(e1);
        }
        outData2.mulLocal(1.0 / area);
    };
    PolygonShape.prototype.computeMass = function (massData, density) {
        var center = this.pool1;
        center.setZero();
        var area = 0.0;
        var I = 0.0;
        var s = this.pool2;
        s.setZero();
        for (var i = 0; i < this.m_count; ++i) {
            s.addLocal(this.m_vertices[i]);
        }
        s.mulLocal(1.0 / this.m_count);
        var k_inv3 = 1.0 / 3.0;
        var e1 = this.pool3;
        var e2 = this.pool4;
        for (var i = 0; i < this.m_count; ++i) {
            e1.set(this.m_vertices[i]).subLocal(s);
            e2.set(s).negateLocal().addLocal(i + 1 < this.m_count ? this.m_vertices[i + 1] : this.m_vertices[0]);
            var D = Vec2.cross(e1, e2);
            var triangleArea = 0.5 * D;
            area += triangleArea;
            center.x += triangleArea * k_inv3 * (e1.x + e2.x);
            center.y += triangleArea * k_inv3 * (e1.y + e2.y);
            var ex1 = e1.x, ey1 = e1.y;
            var ex2 = e2.x, ey2 = e2.y;
            var intx2 = ex1 * ex1 + ex2 * ex1 + ex2 * ex2;
            var inty2 = ey1 * ey1 + ey2 * ey1 + ey2 * ey2;
            I += (0.25 * k_inv3 * D) * (intx2 + inty2);
        }
        massData.mass = density * area;
        center.mulLocal(1.0 / area);
        massData.center.set(center).addLocal(s);
        massData.I = I * density;
        massData.I += massData.mass * (Vec2.dot(massData.center, massData.center));
    };
    PolygonShape.prototype.validate = function () {
        for (var i = 0; i < this.m_count; ++i) {
            var i1 = i;
            var i2 = i < this.m_count - 1 ? i1 + 1 : 0;
            var p = this.m_vertices[i1];
            var e = this.pool1.set(this.m_vertices[i2]).subLocal(p);
            for (var j = 0; j < this.m_count; ++j) {
                if (j == i1 || j == i2) {
                    continue;
                }
                var v = this.pool2.set(this.m_vertices[j]).subLocal(p);
                var c = Vec2.cross(e, v);
                if (c < 0.0) {
                    return false;
                }
            }
        }
        return true;
    };
    PolygonShape.prototype.getVertices = function () {
        return this.m_vertices;
    };
    PolygonShape.prototype.getNormals = function () {
        return this.m_normals;
    };
    PolygonShape.prototype.centroid = function (xf) {
        return Transform.mul(xf, this.m_centroid);
    };
    PolygonShape.prototype.centroidToOut = function (xf, outData2) {
        Transform.mulToOutUnsafe(xf, this.m_centroid, outData2);
        return outData2;
    };
    PolygonShape.m_debug = false;
    return PolygonShape;
}(Shape));
var ShapeType;
(function (ShapeType) {
    ShapeType[ShapeType["CIRCLE"] = 0] = "CIRCLE";
    ShapeType[ShapeType["EDGE"] = 1] = "EDGE";
    ShapeType[ShapeType["POLYGON"] = 2] = "POLYGON";
    ShapeType[ShapeType["CHAIN"] = 3] = "CHAIN";
    ShapeType[ShapeType["MAX"] = 4] = "MAX";
})(ShapeType || (ShapeType = {}));
var IViewportTransform = (function () {
    function IViewportTransform() {
    }
    IViewportTransform.prototype.isYFlip = function () {
        return false;
    };
    IViewportTransform.prototype.setYFlip = function (yFlip) {
    };
    IViewportTransform.prototype.getExtents = function () {
        return null;
    };
    IViewportTransform.prototype.setExtents = function (argExtents) {
    };
    IViewportTransform.prototype.getCenter = function () {
        return null;
    };
    IViewportTransform.prototype.setCenter = function (argExtents) {
    };
    IViewportTransform.prototype.setCamera = function (x, y, scale) {
    };
    IViewportTransform.prototype.getWorldVectorToScreen = function (world, screen) {
    };
    IViewportTransform.prototype.getScreenVectorToWorld = function (screen, world) {
    };
    IViewportTransform.prototype.getMat22Representation = function () {
        return null;
    };
    IViewportTransform.prototype.getWorldToScreen = function (world, screen) {
    };
    IViewportTransform.prototype.getScreenToWorld = function (screen, world) {
    };
    IViewportTransform.prototype.mulByTransform = function (transform) {
    };
    return IViewportTransform;
}());
var Mat22 = (function () {
    function Mat22() {
        this.ex = null;
        this.ey = null;
        this.ex = new Vec2();
        this.ey = new Vec2();
    }
    Mat22.prototype.setValue = function (exx, col2x, exy, col2y) {
        this.ex.x = exx;
        this.ex.y = exy;
        this.ey.x = col2x;
        this.ey.y = col2y;
        return this;
    };
    Mat22.prototype.set = function (from) {
        this.ex.x = from.ex.x;
        this.ex.y = from.ex.y;
        this.ey.x = from.ey.x;
        this.ey.y = from.ey.y;
        return this;
    };
    Mat22.prototype.setAngle = function (angle) {
        var c = MathUtils.cos(angle), s = MathUtils.sin(angle);
        this.ex.x = c;
        this.ey.x = -s;
        this.ex.y = s;
        this.ey.y = c;
    };
    Mat22.prototype.setIdentity = function () {
        this.ex.x = 1.0;
        this.ey.x = 0.0;
        this.ex.y = 0.0;
        this.ey.y = 1.0;
    };
    Mat22.prototype.setZero = function () {
        this.ex.x = 0.0;
        this.ey.x = 0.0;
        this.ex.y = 0.0;
        this.ey.y = 0.0;
    };
    Mat22.prototype.getAngle = function () {
        return MathUtils.atan2(this.ex.y, this.ex.x);
    };
    Mat22.prototype.invert = function () {
        var a = this.ex.x, b = this.ey.x, c = this.ex.y, d = this.ey.y;
        var B = new Mat22();
        var det = a * d - b * c;
        if (det != 0) {
            det = 1.0 / det;
        }
        B.ex.x = det * d;
        B.ey.x = -det * b;
        B.ex.y = -det * c;
        B.ey.y = det * a;
        return B;
    };
    Mat22.prototype.invertLocal = function () {
        var a = this.ex.x, b = this.ey.x, c = this.ex.y, d = this.ey.y;
        var det = a * d - b * c;
        if (det != 0) {
            det = 1.0 / det;
        }
        this.ex.x = det * d;
        this.ey.x = -det * b;
        this.ex.y = -det * c;
        this.ey.y = det * a;
        return this;
    };
    Mat22.prototype.invertToOut = function (outData) {
        var a = this.ex.x, b = this.ey.x, c = this.ex.y, d = this.ey.y;
        var det = a * d - b * c;
        det = 1.0 / det;
        outData.ex.x = det * d;
        outData.ey.x = -det * b;
        outData.ex.y = -det * c;
        outData.ey.y = det * a;
    };
    Mat22.prototype.abs = function () {
        return new Mat22().setValue(dMath.Abs(this.ex.x), dMath.Abs(this.ey.x), dMath.Abs(this.ex.y), dMath.Abs(this.ey.y));
    };
    Mat22.prototype.absLocal = function () {
        this.ex.absLocal();
        this.ey.absLocal();
    };
    Mat22.absR = function (R) {
        return R.abs();
    };
    Mat22.absToOut = function (R, outData) {
        outData.ex.x = dMath.Abs(R.ex.x);
        outData.ex.y = dMath.Abs(R.ex.y);
        outData.ey.x = dMath.Abs(R.ey.x);
        outData.ey.y = dMath.Abs(R.ey.y);
    };
    Mat22.prototype.mulVec2 = function (v) {
        return new Vec2(this.ex.x * v.x + this.ey.x * v.y, this.ex.y * v.x + this.ey.y * v.y);
    };
    Mat22.prototype.mulToOutVec2Vec2 = function (v, outData) {
        var tempy = this.ex.y * v.x + this.ey.y * v.y;
        outData.x = this.ex.x * v.x + this.ey.x * v.y;
        outData.y = tempy;
    };
    Mat22.prototype.mulToOutUnsafeVec2Vec2 = function (v, outData) {
        outData.x = this.ex.x * v.x + this.ey.x * v.y;
        outData.y = this.ex.y * v.x + this.ey.y * v.y;
    };
    Mat22.prototype.mul = function (R) {
        var C = new Mat22();
        C.ex.x = this.ex.x * R.ex.x + this.ey.x * R.ex.y;
        C.ex.y = this.ex.y * R.ex.x + this.ey.y * R.ex.y;
        C.ey.x = this.ex.x * R.ey.x + this.ey.x * R.ey.y;
        C.ey.y = this.ex.y * R.ey.x + this.ey.y * R.ey.y;
        return C;
    };
    Mat22.prototype.mulLocal = function (R) {
        this.mulToOut(R, this);
        return this;
    };
    Mat22.prototype.mulToOut = function (R, outData) {
        var tempy1 = this.ex.y * R.ex.x + this.ey.y * R.ex.y;
        var tempx1 = this.ex.x * R.ex.x + this.ey.x * R.ex.y;
        outData.ex.x = tempx1;
        outData.ex.y = tempy1;
        var tempy2 = this.ex.y * R.ey.x + this.ey.y * R.ey.y;
        var tempx2 = this.ex.x * R.ey.x + this.ey.x * R.ey.y;
        outData.ey.x = tempx2;
        outData.ey.y = tempy2;
    };
    Mat22.prototype.mulToOutUnsafe = function (R, outData) {
        outData.ex.x = this.ex.x * R.ex.x + this.ey.x * R.ex.y;
        outData.ex.y = this.ex.y * R.ex.x + this.ey.y * R.ex.y;
        outData.ey.x = this.ex.x * R.ey.x + this.ey.x * R.ey.y;
        outData.ey.y = this.ex.y * R.ey.x + this.ey.y * R.ey.y;
    };
    Mat22.prototype.mulTrans = function (B) {
        var C = new Mat22();
        C.ex.x = Vec2.dot(this.ex, B.ex);
        C.ex.y = Vec2.dot(this.ey, B.ex);
        C.ey.x = Vec2.dot(this.ex, B.ey);
        C.ey.y = Vec2.dot(this.ey, B.ey);
        return C;
    };
    Mat22.prototype.mulTransLocal = function (B) {
        this.mulTransToOut(B, this);
        return this;
    };
    Mat22.prototype.mulTransToOut = function (B, outData) {
        var x1 = this.ex.x * B.ex.x + this.ex.y * B.ex.y;
        var y1 = this.ey.x * B.ex.x + this.ey.y * B.ex.y;
        var x2 = this.ex.x * B.ey.x + this.ex.y * B.ey.y;
        var y2 = this.ey.x * B.ey.x + this.ey.y * B.ey.y;
        outData.ex.x = x1;
        outData.ey.x = x2;
        outData.ex.y = y1;
        outData.ey.y = y2;
    };
    Mat22.prototype.mulTransToOutUnsafe = function (B, outData) {
        outData.ex.x = this.ex.x * B.ex.x + this.ex.y * B.ex.y;
        outData.ey.x = this.ex.x * B.ey.x + this.ex.y * B.ey.y;
        outData.ex.y = this.ey.x * B.ex.x + this.ey.y * B.ex.y;
        outData.ey.y = this.ey.x * B.ey.x + this.ey.y * B.ey.y;
    };
    Mat22.prototype.mulTrans2 = function (v) {
        return new Vec2((v.x * this.ex.x + v.y * this.ex.y), (v.x * this.ey.x + v.y * this.ey.y));
    };
    Mat22.prototype.mulTransToOutVec2Vec2 = function (v, outData) {
        var tempx = v.x * this.ex.x + v.y * this.ex.y;
        outData.y = v.x * this.ey.x + v.y * this.ey.y;
        outData.x = tempx;
    };
    Mat22.prototype.add = function (B) {
        var m = new Mat22();
        m.ex.x = this.ex.x + B.ex.x;
        m.ex.y = this.ex.y + B.ex.y;
        m.ey.x = this.ey.x + B.ey.x;
        m.ey.y = this.ey.y + B.ey.y;
        return m;
    };
    Mat22.prototype.addLocal = function (B) {
        this.ex.x += B.ex.x;
        this.ex.y += B.ex.y;
        this.ey.x += B.ey.x;
        this.ey.y += B.ey.y;
        return this;
    };
    Mat22.prototype.solve = function (b) {
        var a11 = this.ex.x, a12 = this.ey.x, a21 = this.ex.y, a22 = this.ey.y;
        var det = a11 * a22 - a12 * a21;
        if (det != 0.0) {
            det = 1.0 / det;
        }
        var x = new Vec2(det * (a22 * b.x - a12 * b.y), det * (a11 * b.y - a21 * b.x));
        return x;
    };
    Mat22.prototype.solveToOut = function (b, outData) {
        var a11 = this.ex.x, a12 = this.ey.x, a21 = this.ex.y, a22 = this.ey.y;
        var det = a11 * a22 - a12 * a21;
        if (det != 0.0) {
            det = 1.0 / det;
        }
        var tempy = det * (a11 * b.y - a21 * b.x);
        outData.x = det * (a22 * b.x - a12 * b.y);
        outData.y = tempy;
    };
    Mat22.mul2 = function (R, v) {
        return new Vec2(R.ex.x * v.x + R.ey.x * v.y, R.ex.y * v.x + R.ey.y * v.y);
    };
    Mat22.mulToOutVec2 = function (R, v, outData) {
        var tempy = R.ex.y * v.x + R.ey.y * v.y;
        outData.x = R.ex.x * v.x + R.ey.x * v.y;
        outData.y = tempy;
    };
    Mat22.mulToOutUnsafeVec2 = function (R, v, outData) {
        outData.x = R.ex.x * v.x + R.ey.x * v.y;
        outData.y = R.ex.y * v.x + R.ey.y * v.y;
    };
    Mat22.mul__2 = function (A, B) {
        var C = new Mat22();
        C.ex.x = A.ex.x * B.ex.x + A.ey.x * B.ex.y;
        C.ex.y = A.ex.y * B.ex.x + A.ey.y * B.ex.y;
        C.ey.x = A.ex.x * B.ey.x + A.ey.x * B.ey.y;
        C.ey.y = A.ex.y * B.ey.x + A.ey.y * B.ey.y;
        return C;
    };
    Mat22.mulToOut__2 = function (A, B, outData) {
        var tempy1 = A.ex.y * B.ex.x + A.ey.y * B.ex.y;
        var tempx1 = A.ex.x * B.ex.x + A.ey.x * B.ex.y;
        var tempy2 = A.ex.y * B.ey.x + A.ey.y * B.ey.y;
        var tempx2 = A.ex.x * B.ey.x + A.ey.x * B.ey.y;
        outData.ex.x = tempx1;
        outData.ex.y = tempy1;
        outData.ey.x = tempx2;
        outData.ey.y = tempy2;
    };
    Mat22.mulToOutUnsafe__2 = function (A, B, outData) {
        outData.ex.x = A.ex.x * B.ex.x + A.ey.x * B.ex.y;
        outData.ex.y = A.ex.y * B.ex.x + A.ey.y * B.ex.y;
        outData.ey.x = A.ex.x * B.ey.x + A.ey.x * B.ey.y;
        outData.ey.y = A.ex.y * B.ey.x + A.ey.y * B.ey.y;
    };
    Mat22.mulTrans__2 = function (R, v) {
        return new Vec2((v.x * R.ex.x + v.y * R.ex.y), (v.x * R.ey.x + v.y * R.ey.y));
    };
    Mat22.mulTransToOut__3 = function (R, v, outData) {
        var outx = v.x * R.ex.x + v.y * R.ex.y;
        outData.y = v.x * R.ey.x + v.y * R.ey.y;
        outData.x = outx;
    };
    Mat22.mulTransToOutUnsafe__3 = function (R, v, outData) {
        outData.y = v.x * R.ey.x + v.y * R.ey.y;
        outData.x = v.x * R.ex.x + v.y * R.ex.y;
    };
    Mat22.mulTrans__3 = function (A, B) {
        var C = new Mat22();
        C.ex.x = A.ex.x * B.ex.x + A.ex.y * B.ex.y;
        C.ex.y = A.ey.x * B.ex.x + A.ey.y * B.ex.y;
        C.ey.x = A.ex.x * B.ey.x + A.ex.y * B.ey.y;
        C.ey.y = A.ey.x * B.ey.x + A.ey.y * B.ey.y;
        return C;
    };
    Mat22.mulTransToOut__4 = function (A, B, outData) {
        var x1 = A.ex.x * B.ex.x + A.ex.y * B.ex.y;
        var y1 = A.ey.x * B.ex.x + A.ey.y * B.ex.y;
        var x2 = A.ex.x * B.ey.x + A.ex.y * B.ey.y;
        var y2 = A.ey.x * B.ey.x + A.ey.y * B.ey.y;
        outData.ex.x = x1;
        outData.ex.y = y1;
        outData.ey.x = x2;
        outData.ey.y = y2;
    };
    Mat22.mulTransToOutUnsafe__4 = function (A, B, outData) {
        outData.ex.x = A.ex.x * B.ex.x + A.ex.y * B.ex.y;
        outData.ex.y = A.ey.x * B.ex.x + A.ey.y * B.ex.y;
        outData.ey.x = A.ex.x * B.ey.x + A.ex.y * B.ey.y;
        outData.ey.y = A.ey.x * B.ey.x + A.ey.y * B.ey.y;
    };
    Mat22.createRotationalTransform = function (angle) {
        var mat = new Mat22();
        var c = MathUtils.cos(angle);
        var s = MathUtils.sin(angle);
        mat.ex.x = c;
        mat.ey.x = -s;
        mat.ex.y = s;
        mat.ey.y = c;
        return mat;
    };
    Mat22.createRotationalTransform__2 = function (angle, outData) {
        var c = MathUtils.cos(angle);
        var s = MathUtils.sin(angle);
        outData.ex.x = c;
        outData.ey.x = -s;
        outData.ex.y = s;
        outData.ey.y = c;
    };
    Mat22.createScaleTransform = function (scale) {
        var mat = new Mat22();
        mat.ex.x = scale;
        mat.ey.y = scale;
        return mat;
    };
    Mat22.createScaleTransformTo = function (scale, outData) {
        outData.ex.x = scale;
        outData.ey.y = scale;
    };
    return Mat22;
}());
var Vec3 = (function () {
    function Vec3(argX, argY, argZ) {
        if (argX === void 0) { argX = 0; }
        if (argY === void 0) { argY = 0; }
        if (argZ === void 0) { argZ = 0; }
        this.x = 0;
        this.y = 0;
        this.z = 0;
        this.x = argX;
        this.y = argY;
        this.z = argZ;
    }
    Vec3.prototype.set = function (vec) {
        this.x = vec.x;
        this.y = vec.y;
        this.z = vec.z;
        return this;
    };
    Vec3.prototype.setValue = function (argX, argY, argZ) {
        this.x = argX;
        this.y = argY;
        this.z = argZ;
        return this;
    };
    Vec3.prototype.addLocal = function (argVec) {
        this.x += argVec.x;
        this.y += argVec.y;
        this.z += argVec.z;
        return this;
    };
    Vec3.prototype.add = function (argVec) {
        return new Vec3(this.x + argVec.x, this.y + argVec.y, this.z + argVec.z);
    };
    Vec3.prototype.subLocal = function (argVec) {
        this.x -= argVec.x;
        this.y -= argVec.y;
        this.z -= argVec.z;
        return this;
    };
    Vec3.prototype.sub = function (argVec) {
        return new Vec3(this.x - argVec.x, this.y - argVec.y, this.z - argVec.z);
    };
    Vec3.prototype.mulLocal = function (argScalar) {
        this.x *= argScalar;
        this.y *= argScalar;
        this.z *= argScalar;
        return this;
    };
    Vec3.prototype.mul = function (argScalar) {
        return new Vec3(this.x * argScalar, this.y * argScalar, this.z * argScalar);
    };
    Vec3.prototype.negate = function () {
        return new Vec3(-this.x, -this.y, -this.z);
    };
    Vec3.prototype.negateLocal = function () {
        this.x = -this.x;
        this.y = -this.y;
        this.z = -this.z;
        return this;
    };
    Vec3.prototype.setZero = function () {
        this.x = 0;
        this.y = 0;
        this.z = 0;
    };
    Vec3.dot = function (a, b) {
        return a.x * b.x + a.y * b.y + a.z * b.z;
    };
    Vec3.cross = function (a, b) {
        return new Vec3(a.y * b.z - a.z * b.y, a.z * b.x - a.x * b.z, a.x * b.y - a.y * b.x);
    };
    Vec3.crossToOut = function (a, b, outData) {
        var tempy = a.z * b.x - a.x * b.z;
        var tempz = a.x * b.y - a.y * b.x;
        outData.x = a.y * b.z - a.z * b.y;
        outData.y = tempy;
        outData.z = tempz;
    };
    Vec3.crossToOutUnsafe = function (a, b, outData) {
        outData.x = a.y * b.z - a.z * b.y;
        outData.y = a.z * b.x - a.x * b.z;
        outData.z = a.x * b.y - a.y * b.x;
    };
    return Vec3;
}());
var Mat33 = (function () {
    function Mat33() {
        this.ex = null;
        this.ey = null;
        this.ez = null;
        this.ex = new Vec3();
        this.ey = new Vec3();
        this.ez = new Vec3();
    }
    Mat33.prototype.setValue = function (exx, exy, exz, eyx, eyy, eyz, ezx, ezy, ezz) {
        this.ex.x = exx;
        this.ex.y = exy;
        this.ex.z = exz;
        this.ey.x = eyx;
        this.ey.y = eyy;
        this.ey.z = eyz;
        this.ez.x = eyx;
        this.ez.y = eyy;
        this.ez.z = eyz;
        return this;
    };
    Mat33.prototype.CopyFromVec3 = function (argCol1, argCol2, argCol3) {
        this.ex.set(argCol1);
        this.ey.set(argCol2);
        this.ez.set(argCol3);
        return this;
    };
    Mat33.prototype.setZero = function () {
        this.ex.setZero();
        this.ey.setZero();
        this.ez.setZero();
    };
    Mat33.prototype.set = function (from) {
        this.ex.x = from.ex.x;
        this.ex.y = from.ex.y;
        this.ex.z = from.ex.z;
        this.ey.x = from.ey.x;
        this.ey.y = from.ey.y;
        this.ey.z = from.ey.z;
        this.ez.x = from.ey.x;
        this.ez.y = from.ey.y;
        this.ez.z = from.ey.z;
        return this;
    };
    Mat33.prototype.setFromMat33 = function (mat) {
        var vec = mat.ex;
        this.ex.x = vec.x;
        this.ex.y = vec.y;
        this.ex.z = vec.z;
        var vec1 = mat.ey;
        this.ey.x = vec1.x;
        this.ey.y = vec1.y;
        this.ey.z = vec1.z;
        var vec2 = mat.ez;
        this.ez.x = vec2.x;
        this.ez.y = vec2.y;
        this.ez.z = vec2.z;
    };
    Mat33.prototype.setIdentity = function () {
        this.ex.x = 1;
        this.ex.y = 0;
        this.ex.z = 0;
        this.ey.x = 0;
        this.ey.y = 1;
        this.ey.z = 0;
        this.ez.x = 0;
        this.ez.y = 0;
        this.ez.z = 1;
    };
    Mat33.prototype.mul = function (A, v) {
        return new Vec3(v.x * A.ex.x + v.y * A.ey.x + v.z + A.ez.x, v.x * A.ex.y + v.y * A.ey.y + v.z
            * A.ez.y, v.x * A.ex.z + v.y * A.ey.z + v.z * A.ez.z);
    };
    Mat33.prototype.mul22 = function (A, v) {
        return new Vec2(A.ex.x * v.x + A.ey.x * v.y, A.ex.y * v.x + A.ey.y * v.y);
    };
    Mat33.prototype.mul22ToOut = function (A, v, outData) {
        var tempx = A.ex.x * v.x + A.ey.x * v.y;
        outData.y = A.ex.y * v.x + A.ey.y * v.y;
        outData.x = tempx;
    };
    Mat33.mul22ToOutUnsafe = function (A, v, outData) {
        outData.y = A.ex.y * v.x + A.ey.y * v.y;
        outData.x = A.ex.x * v.x + A.ey.x * v.y;
    };
    Mat33.mulToOut = function (A, v, outData) {
        var tempy = v.x * A.ex.y + v.y * A.ey.y + v.z * A.ez.y;
        var tempz = v.x * A.ex.z + v.y * A.ey.z + v.z * A.ez.z;
        outData.x = v.x * A.ex.x + v.y * A.ey.x + v.z * A.ez.x;
        outData.y = tempy;
        outData.z = tempz;
    };
    Mat33.mulToOutUnsafe = function (A, v, outData) {
        outData.x = v.x * A.ex.x + v.y * A.ey.x + v.z * A.ez.x;
        outData.y = v.x * A.ex.y + v.y * A.ey.y + v.z * A.ez.y;
        outData.z = v.x * A.ex.z + v.y * A.ey.z + v.z * A.ez.z;
    };
    Mat33.prototype.solve22 = function (b) {
        var x = new Vec2();
        this.solve22ToOut(b, x);
        return x;
    };
    Mat33.prototype.solve22ToOut = function (b, outData2) {
        var a11 = this.ex.x, a12 = this.ey.x, a21 = this.ex.y, a22 = this.ey.y;
        var det = a11 * a22 - a12 * a21;
        if (det != 0.0) {
            det = 1.0 / det;
        }
        outData2.x = det * (a22 * b.x - a12 * b.y);
        outData2.y = det * (a11 * b.y - a21 * b.x);
    };
    Mat33.prototype.solve33 = function (b) {
        var x = new Vec3();
        this.solve33ToOut(b, x);
        return x;
    };
    Mat33.prototype.solve33ToOut = function (b, outData) {
        Vec3.crossToOutUnsafe(this.ey, this.ez, outData);
        var det = Vec3.dot(this.ex, outData);
        if (det != 0.0) {
            det = 1.0 / det;
        }
        Vec3.crossToOutUnsafe(this.ey, this.ez, outData);
        var x = det * Vec3.dot(b, outData);
        Vec3.crossToOutUnsafe(b, this.ez, outData);
        var y = det * Vec3.dot(this.ex, outData);
        Vec3.crossToOutUnsafe(this.ey, b, outData);
        var z = det * Vec3.dot(this.ex, outData);
        outData.x = x;
        outData.y = y;
        outData.z = z;
    };
    Mat33.prototype.getInverse22 = function (M) {
        var a = this.ex.x, b = this.ey.x, c = this.ex.y, d = this.ey.y;
        var det = a * d - b * c;
        if (det != 0.0) {
            det = 1.0 / det;
        }
        M.ex.x = det * d;
        M.ey.x = -det * b;
        M.ex.z = 0.0;
        M.ex.y = -det * c;
        M.ey.y = det * a;
        M.ey.z = 0.0;
        M.ez.x = 0.0;
        M.ez.y = 0.0;
        M.ez.z = 0.0;
    };
    Mat33.prototype.getSymInverse33 = function (M) {
        var bx = this.ey.y * this.ez.z - this.ey.z * this.ez.y;
        var by = this.ey.z * this.ez.x - this.ey.x * this.ez.z;
        var bz = this.ey.x * this.ez.y - this.ey.y * this.ez.x;
        var det = this.ex.x * bx + this.ex.y * by + this.ex.z * bz;
        if (det != 0.0) {
            det = 1.0 / det;
        }
        var a11 = this.ex.x, a12 = this.ey.x, a13 = this.ez.x;
        var a22 = this.ey.y, a23 = this.ez.y;
        var a33 = this.ez.z;
        M.ex.x = det * (a22 * a33 - a23 * a23);
        M.ex.y = det * (a13 * a23 - a12 * a33);
        M.ex.z = det * (a12 * a23 - a13 * a22);
        M.ey.x = M.ex.y;
        M.ey.y = det * (a11 * a33 - a13 * a13);
        M.ey.z = det * (a13 * a12 - a11 * a23);
        M.ez.x = M.ex.z;
        M.ez.y = M.ey.z;
        M.ez.z = det * (a11 * a22 - a12 * a12);
    };
    Mat33.setScaleTransform = function (scale, outData) {
        outData.ex.x = scale;
        outData.ey.y = scale;
    };
    Mat33.IDENTITY = new Mat33().setValue(1, 0, 0, 0, 1, 0, 0, 0, 1);
    return Mat33;
}());
var MathUtils = (function () {
    function MathUtils() {
    }
    MathUtils.GetSinLUT = function () {
        if (MathUtils._sinLUT == null) {
            MathUtils._sinLUT = new Array(Settings.SINCOS_LUT_LENGTH);
            for (var i = 0; i < Settings.SINCOS_LUT_LENGTH; i++) {
                MathUtils._sinLUT[i] = dMath.Sin(i * Settings.SINCOS_LUT_PRECISION);
            }
        }
        return MathUtils._sinLUT;
    };
    MathUtils.sin = function (x) {
        if (Settings.SINCOS_LUT_ENABLED) {
            return MathUtils.sinLUT(x);
        }
        else {
            return dMath.Sin(x);
        }
    };
    MathUtils.sinLUT = function (x) {
        x %= MathUtils.TWOPI;
        if (x < 0) {
            x += MathUtils.TWOPI;
        }
        if (Settings.SINCOS_LUT_LERP) {
            x /= Settings.SINCOS_LUT_PRECISION;
            var index = dMath.ToInt(x);
            if (index != 0) {
                x %= index;
            }
            if (index == Settings.SINCOS_LUT_LENGTH - 1) {
                return ((1 - x) * MathUtils.GetSinLUT()[index] + x * MathUtils.GetSinLUT()[0]);
            }
            else {
                return ((1 - x) * MathUtils.GetSinLUT()[index] + x * MathUtils.GetSinLUT()[index + 1]);
            }
        }
        else {
            return MathUtils.GetSinLUT()[MathUtils.round(x / Settings.SINCOS_LUT_PRECISION) % Settings.SINCOS_LUT_LENGTH];
        }
    };
    MathUtils.cos = function (x) {
        if (Settings.SINCOS_LUT_ENABLED) {
            return MathUtils.sinLUT(MathUtils.HALF_PI - x);
        }
        else {
            return dMath.Cos(x);
        }
    };
    MathUtils.floor = function (x) {
        if (Settings.FAST_FLOOR) {
            return MathUtils.fastFloor(x);
        }
        else {
            return dMath.Floor(x);
        }
    };
    MathUtils.fastFloor = function (x) {
        var y = dMath.ToInt(x);
        if (x < y) {
            return y - 1;
        }
        return y;
    };
    MathUtils.ceil = function (x) {
        if (Settings.FAST_CEIL) {
            return MathUtils.fastCeil(x);
        }
        else {
            return dMath.Ceil(x);
        }
    };
    MathUtils.fastCeil = function (x) {
        var y = dMath.ToInt(x);
        if (x > y) {
            return y + 1;
        }
        return y;
    };
    MathUtils.round = function (x) {
        if (Settings.FAST_ROUND) {
            return MathUtils.floor(x + 0.5);
        }
        else {
            return dMath.Round(x);
        }
    };
    MathUtils.ceilPowerOf2 = function (x) {
        var pow2 = 1;
        while (pow2 < x) {
            pow2 <<= 1;
        }
        return pow2;
    };
    MathUtils.map = function (val, fromMin, fromMax, toMin, toMax) {
        var mult = (val - fromMin) / (fromMax - fromMin);
        var res = toMin + mult * (toMax - toMin);
        return res;
    };
    MathUtils.clamp = function (a, low, high) {
        return dMath.Max(low, dMath.Min(a, high));
    };
    MathUtils.clampVec2 = function (a, low, high) {
        var min = new Vec2();
        min.x = a.x < high.x ? a.x : high.x;
        min.y = a.y < high.y ? a.y : high.y;
        min.x = low.x > min.x ? low.x : min.x;
        min.y = low.y > min.y ? low.y : min.y;
        return min;
    };
    MathUtils.clampToOut = function (a, low, high, dest) {
        dest.x = a.x < high.x ? a.x : high.x;
        dest.y = a.y < high.y ? a.y : high.y;
        dest.x = low.x > dest.x ? low.x : dest.x;
        dest.y = low.y > dest.y ? low.y : dest.y;
    };
    MathUtils.nextPowerOfTwo = function (x) {
        x |= x >> 1;
        x |= x >> 2;
        x |= x >> 4;
        x |= x >> 8;
        x |= x >> 16;
        return x + 1;
    };
    MathUtils.isPowerOfTwo = function (x) {
        return x > 0 && (x & x - 1) == 0;
    };
    MathUtils.pow = function (a, b) {
        return dMath.Pow(a, b);
    };
    MathUtils.atan2 = function (y, x) {
        if (Settings.FAST_ATAN2) {
            return MathUtils.fastAtan2(y, x);
        }
        else {
            return dMath.Atan2(y, x);
        }
    };
    MathUtils.fastAtan2 = function (y, x) {
        if (x == 0.0) {
            if (y > 0.0)
                return MathUtils.HALF_PI;
            if (y == 0.0)
                return 0.0;
            return -MathUtils.HALF_PI;
        }
        var atan = 0;
        var z = y / x;
        if (dMath.Abs(z) < 1.0) {
            atan = z / (1.0 + 0.28 * z * z);
            if (x < 0.0) {
                if (y < 0.0)
                    return atan - dMath.dPI;
                return atan + dMath.dPI;
            }
        }
        else {
            atan = MathUtils.HALF_PI - z / (z * z + 0.28);
            if (y < 0.0)
                return atan - dMath.dPI;
        }
        return atan;
    };
    MathUtils.reduceAngle = function (theta) {
        theta %= MathUtils.TWOPI;
        if (dMath.Abs(theta) > dMath.dPI) {
            theta = theta - MathUtils.TWOPI;
        }
        if (dMath.Abs(theta) > MathUtils.HALF_PI) {
            theta = dMath.dPI - theta;
        }
        return theta;
    };
    MathUtils.randomFloat = function (argLow, argHigh) {
        return dMath.Random() * (argHigh - argLow) + argLow;
    };
    MathUtils.sqrt = function (x) {
        return dMath.Sqrt(x);
    };
    MathUtils.distanceSquared = function (v1, v2) {
        var dx = (v1.x - v2.x);
        var dy = (v1.y - v2.y);
        return dx * dx + dy * dy;
    };
    MathUtils.distance = function (v1, v2) {
        return MathUtils.sqrt(MathUtils.distanceSquared(v1, v2));
    };
    MathUtils.arraycopy = function (from, to) {
        for (var i = 0; i < from.length; i++)
            to[i] = from[i];
    };
    MathUtils.PI = dMath.dPI;
    MathUtils.TWOPI = (dMath.dPI * 2);
    MathUtils.INV_PI = 1 / dMath.dPI;
    MathUtils.HALF_PI = dMath.dPI / 2;
    MathUtils.QUARTER_PI = dMath.dPI / 4;
    MathUtils.THREE_HALVES_PI = MathUtils.TWOPI - MathUtils.HALF_PI;
    MathUtils.DEG2RAD = dMath.dPI / 180;
    MathUtils.RAD2DEG = 180 / dMath.dPI;
    MathUtils._sinLUT = null;
    return MathUtils;
}());
var OBBViewportTransform = (function (_super) {
    __extends(OBBViewportTransform, _super);
    function OBBViewportTransform() {
        var _this = _super.call(this) || this;
        _this.box = new OBB();
        _this.yFlip = false;
        _this.yFlipMat = new Mat22().setValue(1, 0, 0, -1);
        _this.inv = new Mat22();
        _this.inv2 = new Mat22();
        _this.box.R.setIdentity();
        return _this;
    }
    OBBViewportTransform.prototype.set = function (vpt) {
        this.box.center.set(vpt.box.center);
        this.box.extents.set(vpt.box.extents);
        this.box.R.set(vpt.box.R);
        this.yFlip = vpt.yFlip;
    };
    OBBViewportTransform.prototype.setCamera = function (x, y, scale) {
        this.box.center.setValue(x, y);
        Mat22.createScaleTransformTo(scale, this.box.R);
    };
    OBBViewportTransform.prototype.getExtents = function () {
        return this.box.extents;
    };
    OBBViewportTransform.prototype.getMat22Representation = function () {
        return this.box.R;
    };
    OBBViewportTransform.prototype.setExtents = function (argExtents) {
        this.box.extents.set(argExtents);
    };
    OBBViewportTransform.prototype.setExtents__2 = function (halfWidth, halfHeight) {
        this.box.extents.setValue(halfWidth, halfHeight);
    };
    OBBViewportTransform.prototype.getCenter = function () {
        return this.box.center;
    };
    OBBViewportTransform.prototype.setCenter = function (argPos) {
        this.box.center.set(argPos);
    };
    OBBViewportTransform.prototype.setCenter__2 = function (x, y) {
        this.box.center.setValue(x, y);
    };
    OBBViewportTransform.prototype.getTransform = function () {
        return this.box.R;
    };
    OBBViewportTransform.prototype.setTransform = function (transform) {
        this.box.R.set(transform);
    };
    OBBViewportTransform.prototype.mulByTransform = function (transform) {
        this.box.R.mulLocal(transform);
    };
    OBBViewportTransform.prototype.isYFlip = function () {
        return this.yFlip;
    };
    OBBViewportTransform.prototype.setYFlip = function (yFlip) {
        this.yFlip = yFlip;
    };
    OBBViewportTransform.prototype.getScreenVectorToWorld = function (screen, world) {
        this.box.R.invertToOut(this.inv);
        this.inv.mulToOutVec2Vec2(screen, world);
        if (this.yFlip) {
            this.yFlipMat.mulToOutVec2Vec2(world, world);
        }
    };
    OBBViewportTransform.prototype.getWorldVectorToScreen = function (world, screen) {
        this.box.R.mulToOutVec2Vec2(world, screen);
        if (this.yFlip) {
            this.yFlipMat.mulToOutVec2Vec2(screen, screen);
        }
    };
    OBBViewportTransform.prototype.getWorldToScreen = function (world, screen) {
        screen.x = world.x - this.box.center.x;
        screen.y = world.y - this.box.center.y;
        this.box.R.mulToOutVec2Vec2(screen, screen);
        if (this.yFlip) {
            this.yFlipMat.mulToOutVec2Vec2(screen, screen);
        }
        screen.x += this.box.extents.x;
        screen.y += this.box.extents.y;
    };
    OBBViewportTransform.prototype.getScreenToWorld = function (screen, world) {
        world.x = screen.x - this.box.extents.x;
        world.y = screen.y - this.box.extents.y;
        if (this.yFlip) {
            this.yFlipMat.mulToOutVec2Vec2(world, world);
        }
        this.box.R.invertToOut(this.inv2);
        this.inv2.mulToOutVec2Vec2(world, world);
        world.x += this.box.center.x;
        world.y += this.box.center.y;
    };
    return OBBViewportTransform;
}(IViewportTransform));
var OBB = (function () {
    function OBB() {
        this.R = new Mat22();
        this.center = new Vec2();
        this.extents = new Vec2();
    }
    return OBB;
}());
var RaycastResult = (function () {
    function RaycastResult() {
        this.lambda = 0.0;
        this.normal = new Vec2();
    }
    RaycastResult.prototype.set = function (argOther) {
        this.lambda = argOther.lambda;
        this.normal.set(argOther.normal);
        return this;
    };
    return RaycastResult;
}());
var Rot = (function () {
    function Rot() {
        this.s = 0;
        this.c = 0;
        this.setIdentity();
    }
    Rot.prototype.getSin = function () {
        return this.s;
    };
    Rot.prototype.getCos = function () {
        return this.c;
    };
    Rot.prototype.setValue = function (angle) {
        this.s = MathUtils.sin(angle);
        this.c = MathUtils.cos(angle);
        return this;
    };
    Rot.prototype.set = function (other) {
        this.s = other.s;
        this.c = other.c;
        return this;
    };
    Rot.prototype.setIdentity = function () {
        this.s = 0;
        this.c = 1;
        return this;
    };
    Rot.prototype.getAngle = function () {
        return MathUtils.atan2(this.s, this.c);
    };
    Rot.prototype.getXAxis = function (xAxis) {
        xAxis.setValue(this.c, this.s);
    };
    Rot.prototype.getYAxis = function (yAxis) {
        yAxis.setValue(-this.s, this.c);
    };
    Rot.prototype.clone = function () {
        var copy = new Rot();
        copy.s = this.s;
        copy.c = this.c;
        return copy;
    };
    Rot.mul = function (q, r, outData) {
        var tempc = q.c * r.c - q.s * r.s;
        outData.s = q.s * r.c + q.c * r.s;
        outData.c = tempc;
    };
    Rot.mulUnsafe = function (q, r, outData) {
        outData.s = q.s * r.c + q.c * r.s;
        outData.c = q.c * r.c - q.s * r.s;
    };
    Rot.mulTrans = function (q, r, outData) {
        var tempc = q.c * r.c + q.s * r.s;
        outData.s = q.c * r.s - q.s * r.c;
        outData.c = tempc;
    };
    Rot.mulTransUnsafe = function (q, r, outData) {
        outData.s = q.c * r.s - q.s * r.c;
        outData.c = q.c * r.c + q.s * r.s;
    };
    Rot.mulToOut = function (q, v, outData) {
        var tempy = q.s * v.x + q.c * v.y;
        outData.x = q.c * v.x - q.s * v.y;
        outData.y = tempy;
    };
    Rot.mulToOutUnsafe = function (q, v, outData) {
        outData.x = q.c * v.x - q.s * v.y;
        outData.y = q.s * v.x + q.c * v.y;
    };
    Rot.mulTransVec2 = function (q, v, outData) {
        var tempy = -q.s * v.x + q.c * v.y;
        outData.x = q.c * v.x + q.s * v.y;
        outData.y = tempy;
    };
    Rot.mulTransUnsafeVec2 = function (q, v, outData) {
        outData.x = q.c * v.x + q.s * v.y;
        outData.y = -q.s * v.x + q.c * v.y;
    };
    return Rot;
}());
var Settings = (function () {
    function Settings() {
    }
    Settings.mixFriction = function (friction1, friction2) {
        return MathUtils.sqrt(friction1 * friction2);
    };
    Settings.mixRestitution = function (restitution1, restitution2) {
        return restitution1 > restitution2 ? restitution1 : restitution2;
    };
    Settings.box_assert = function (b) {
        if (!b)
            throw "assert failed";
    };
    Settings.EPSILON = 1.1920928955078125e-7;
    Settings.FAST_ABS = true;
    Settings.FAST_FLOOR = true;
    Settings.FAST_CEIL = true;
    Settings.FAST_ROUND = true;
    Settings.FAST_ATAN2 = true;
    Settings.FAST_POW = true;
    Settings.CONTACT_STACK_INIT_SIZE = 10;
    Settings.SINCOS_LUT_ENABLED = false;
    Settings.NULL_PROXY = -1;
    Settings.SINCOS_LUT_PRECISION = 0.00011;
    Settings.SINCOS_LUT_LENGTH = dMath.Ceil(dMath.dPI * 2 / Settings.SINCOS_LUT_PRECISION);
    Settings.SINCOS_LUT_LERP = false;
    Settings.maxManifoldPoints = 2;
    Settings.maxPolygonVertices = 8;
    Settings.aabbExtension = 0.1;
    Settings.aabbMultiplier = 2.0;
    Settings.linearSlop = 0.005;
    Settings.angularSlop = (2.0 / 180.0 * dMath.dPI);
    Settings.polygonRadius = (2.0 * Settings.linearSlop);
    Settings.maxSubSteps = 8;
    Settings.maxTOIContacts = 32;
    Settings.velocityThreshold = 1.0;
    Settings.maxLinearCorrection = 0.2;
    Settings.maxAngularCorrection = (8.0 / 180.0 * dMath.dPI);
    Settings.maxTranslation = 2.0;
    Settings.maxTranslationSquared = (Settings.maxTranslation * Settings.maxTranslation);
    Settings.maxRotation = (0.5 * dMath.dPI);
    Settings.maxRotationSquared = (Settings.maxRotation * Settings.maxRotation);
    Settings.baumgarte = 0.2;
    Settings.toiBaugarte = 0.75;
    Settings.timeToSleep = 0.5;
    Settings.linearSleepTolerance = 0.01;
    Settings.angularSleepTolerance = (2.0 / 180.0 * dMath.dPI);
    Settings.maxTriadDistance = 2;
    Settings.maxTriadDistanceSquared = (Settings.maxTriadDistance * Settings.maxTriadDistance);
    return Settings;
}());
var Sweep = (function () {
    function Sweep() {
        this.localCenter = null;
        this.c0 = null;
        this.c = null;
        this.a0 = 0;
        this.a = 0;
        this.alpha0 = 0;
        this.localCenter = new Vec2();
        this.c0 = new Vec2();
        this.c = new Vec2();
    }
    Sweep.prototype.normalize = function () {
        var d = MathUtils.TWOPI * MathUtils.floor(this.a0 / MathUtils.TWOPI);
        this.a0 -= d;
        this.a -= d;
    };
    Sweep.prototype.set = function (other) {
        this.localCenter.set(other.localCenter);
        this.c0.set(other.c0);
        this.c.set(other.c);
        this.a0 = other.a0;
        this.a = other.a;
        this.alpha0 = other.alpha0;
        return this;
    };
    Sweep.prototype.getTransform = function (xf, beta) {
        xf.p.x = (1.0 - beta) * this.c0.x + beta * this.c.x;
        xf.p.y = (1.0 - beta) * this.c0.y + beta * this.c.y;
        var angle = (1.0 - beta) * this.a0 + beta * this.a;
        xf.q.setValue(angle);
        var q = xf.q;
        xf.p.x -= q.c * this.localCenter.x - q.s * this.localCenter.y;
        xf.p.y -= q.s * this.localCenter.x + q.c * this.localCenter.y;
    };
    Sweep.prototype.advance = function (alpha) {
        var beta = (alpha - this.alpha0) / (1.0 - this.alpha0);
        this.c0.x += beta * (this.c.x - this.c0.x);
        this.c0.y += beta * (this.c.y - this.c0.y);
        this.a0 += beta * (this.a - this.a0);
        this.alpha0 = alpha;
    };
    return Sweep;
}());
var Transform = (function () {
    function Transform() {
        this.p = null;
        this.q = null;
        this.p = new Vec2();
        this.q = new Rot();
    }
    Transform.prototype.Copy = function (xf) {
        this.p = xf.p.clone();
        this.q = xf.q.clone();
        return this;
    };
    Transform.prototype.CopyFromVec2 = function (_position, _R) {
        this.p = _position.clone();
        this.q = _R.clone();
        return this;
    };
    Transform.prototype.set = function (xf) {
        this.p.set(xf.p);
        this.q.set(xf.q);
        return this;
    };
    Transform.prototype.setFromVec2 = function (p, angle) {
        this.p.set(p);
        this.q.setValue(angle);
    };
    Transform.prototype.setIdentity = function () {
        this.p.setZero();
        this.q.setIdentity();
    };
    Transform.mul = function (T, v) {
        return new Vec2((T.q.c * v.x - T.q.s * v.y) + T.p.x, (T.q.s * v.x + T.q.c * v.y) + T.p.y);
    };
    Transform.mulToOut = function (T, v, outData) {
        var tempy = (T.q.s * v.x + T.q.c * v.y) + T.p.y;
        outData.x = (T.q.c * v.x - T.q.s * v.y) + T.p.x;
        outData.y = tempy;
    };
    Transform.mulToOutUnsafe = function (T, v, outData) {
        outData.x = (T.q.c * v.x - T.q.s * v.y) + T.p.x;
        outData.y = (T.q.s * v.x + T.q.c * v.y) + T.p.y;
    };
    Transform.mulTrans = function (T, v) {
        var px = v.x - T.p.x;
        var py = v.y - T.p.y;
        return new Vec2((T.q.c * px + T.q.s * py), (-T.q.s * px + T.q.c * py));
    };
    Transform.mulTransToOut = function (T, v, outData) {
        var px = v.x - T.p.x;
        var py = v.y - T.p.y;
        var tempy = (-T.q.s * px + T.q.c * py);
        outData.x = (T.q.c * px + T.q.s * py);
        outData.y = tempy;
    };
    Transform.mulTransToOutUnsafeVec2 = function (T, v, outData) {
        var px = v.x - T.p.x;
        var py = v.y - T.p.y;
        outData.x = (T.q.c * px + T.q.s * py);
        outData.y = (-T.q.s * px + T.q.c * py);
    };
    Transform.mul2 = function (A, B) {
        var C = new Transform();
        Rot.mulUnsafe(A.q, B.q, C.q);
        Rot.mulToOutUnsafe(A.q, B.p, C.p);
        C.p.addLocal(A.p);
        return C;
    };
    Transform.mulToOut__2 = function (A, B, outData) {
        Rot.mul(A.q, B.q, outData.q);
        Rot.mulToOut(A.q, B.p, outData.p);
        outData.p.addLocal(A.p);
    };
    Transform.mulToOutUnsafe__2 = function (A, B, outData) {
        Rot.mulUnsafe(A.q, B.q, outData.q);
        Rot.mulToOutUnsafe(A.q, B.p, outData.p);
        outData.p.addLocal(A.p);
    };
    Transform.mulTrans__2 = function (A, B) {
        var C = new Transform();
        Rot.mulTransUnsafe(A.q, B.q, C.q);
        this.pool.set(B.p).subLocal(A.p);
        Rot.mulTransUnsafeVec2(A.q, this.pool, C.p);
        return C;
    };
    Transform.mulTransToOut__2 = function (A, B, outData) {
        Rot.mulTrans(A.q, B.q, outData.q);
        this.pool.set(B.p).subLocal(A.p);
        Rot.mulTransVec2(A.q, this.pool, outData.p);
    };
    Transform.mulTransToOutUnsafe = function (A, B, outData) {
        Rot.mulTransUnsafe(A.q, B.q, outData.q);
        this.pool.set(B.p).subLocal(A.p);
        Rot.mulTransUnsafeVec2(A.q, this.pool, outData.p);
    };
    Transform.pool = new Vec2();
    return Transform;
}());
var BodyDef = (function () {
    function BodyDef() {
        this.userData = null;
        this.position = new Vec2();
        this.angle = 0;
        this.linearVelocity = new Vec2();
        this.angularVelocity = 0;
        this.linearDamping = 0;
        this.angularDamping = 0;
        this.allowSleep = true;
        this.awake = true;
        this.fixedRotation = false;
        this.bullet = false;
        this.type = BodyType.STATIC;
        this.active = true;
        this.gravityScale = 1.0;
    }
    BodyDef.prototype.getType = function () {
        return this.type;
    };
    BodyDef.prototype.setType = function (type) {
        this.type = type;
    };
    BodyDef.prototype.getUserData = function () {
        return this.userData;
    };
    BodyDef.prototype.setUserData = function (userData) {
        this.userData = userData;
    };
    BodyDef.prototype.getPosition = function () {
        return this.position;
    };
    BodyDef.prototype.setPosition = function (position) {
        this.position = position;
    };
    BodyDef.prototype.getAngle = function () {
        return this.angle;
    };
    BodyDef.prototype.setAngle = function (angle) {
        this.angle = angle;
    };
    BodyDef.prototype.getLinearVelocity = function () {
        return this.linearVelocity;
    };
    BodyDef.prototype.setLinearVelocity = function (linearVelocity) {
        this.linearVelocity = linearVelocity;
    };
    BodyDef.prototype.getAngularVelocity = function () {
        return this.angularVelocity;
    };
    BodyDef.prototype.setAngularVelocity = function (angularVelocity) {
        this.angularVelocity = angularVelocity;
    };
    BodyDef.prototype.getLinearDamping = function () {
        return this.linearDamping;
    };
    BodyDef.prototype.setLinearDamping = function (linearDamping) {
        this.linearDamping = linearDamping;
    };
    BodyDef.prototype.getAngularDamping = function () {
        return this.angularDamping;
    };
    BodyDef.prototype.setAngularDamping = function (angularDamping) {
        this.angularDamping = angularDamping;
    };
    BodyDef.prototype.isAllowSleep = function () {
        return this.allowSleep;
    };
    BodyDef.prototype.setAllowSleep = function (allowSleep) {
        this.allowSleep = allowSleep;
    };
    BodyDef.prototype.isAwake = function () {
        return this.awake;
    };
    BodyDef.prototype.setAwake = function (awake) {
        this.awake = awake;
    };
    BodyDef.prototype.isFixedRotation = function () {
        return this.fixedRotation;
    };
    BodyDef.prototype.setFixedRotation = function (fixedRotation) {
        this.fixedRotation = fixedRotation;
    };
    BodyDef.prototype.isBullet = function () {
        return this.bullet;
    };
    BodyDef.prototype.setBullet = function (bullet) {
        this.bullet = bullet;
    };
    BodyDef.prototype.isActive = function () {
        return this.active;
    };
    BodyDef.prototype.setActive = function (active) {
        this.active = active;
    };
    BodyDef.prototype.getGravityScale = function () {
        return this.gravityScale;
    };
    BodyDef.prototype.setGravityScale = function (gravityScale) {
        this.gravityScale = gravityScale;
    };
    return BodyDef;
}());
var BodyType;
(function (BodyType) {
    BodyType[BodyType["STATIC"] = 0] = "STATIC";
    BodyType[BodyType["KINEMATIC"] = 1] = "KINEMATIC";
    BodyType[BodyType["DYNAMIC"] = 2] = "DYNAMIC";
})(BodyType || (BodyType = {}));
var BoxBody = (function () {
    function BoxBody(bd, world) {
        this.m_type = 0;
        this.m_flags = 0;
        this.m_islandIndex = 0;
        this.m_xf = new Transform();
        this.m_xf0 = new Transform();
        this.m_sweep = new Sweep();
        this.m_linearVelocity = new Vec2();
        this.m_angularVelocity = 0;
        this.m_force = new Vec2();
        this.m_torque = 0;
        this.m_world = null;
        this.m_prev = null;
        this.m_next = null;
        this.m_fixtureList = null;
        this.m_fixtureCount = 0;
        this.m_jointList = null;
        this.m_contactList = null;
        this.m_mass = 0;
        this.m_invMass = 0;
        this.m_I = 0;
        this.m_invI = 0;
        this.m_linearDamping = 0;
        this.m_angularDamping = 0;
        this.m_gravityScale = 0;
        this.m_sleepTime = 0;
        this.m_userData = null;
        this.fixDef = new FixtureDef();
        this.pmd = new MassData();
        this.pxf = new Transform();
        this.m_flags = 0;
        if (bd.bullet) {
            this.m_flags |= BoxBody.e_bulletFlag;
        }
        if (bd.fixedRotation) {
            this.m_flags |= BoxBody.e_fixedRotationFlag;
        }
        if (bd.allowSleep) {
            this.m_flags |= BoxBody.e_autoSleepFlag;
        }
        if (bd.awake) {
            this.m_flags |= BoxBody.e_awakeFlag;
        }
        if (bd.active) {
            this.m_flags |= BoxBody.e_activeFlag;
        }
        this.m_world = world;
        this.m_xf.p.set(bd.position);
        this.m_xf.q.setValue(bd.angle);
        this.m_sweep.localCenter.setZero();
        this.m_sweep.c0.set(this.m_xf.p);
        this.m_sweep.c.set(this.m_xf.p);
        this.m_sweep.a0 = bd.angle;
        this.m_sweep.a = bd.angle;
        this.m_sweep.alpha0 = 0.0;
        this.m_jointList = null;
        this.m_contactList = null;
        this.m_prev = null;
        this.m_next = null;
        this.m_linearVelocity.set(bd.linearVelocity);
        this.m_angularVelocity = bd.angularVelocity;
        this.m_linearDamping = bd.linearDamping;
        this.m_angularDamping = bd.angularDamping;
        this.m_gravityScale = bd.gravityScale;
        this.m_force.setZero();
        this.m_torque = 0.0;
        this.m_sleepTime = 0.0;
        this.m_type = bd.type;
        if (this.m_type == BodyType.DYNAMIC) {
            this.m_mass = 1;
            this.m_invMass = 1;
        }
        else {
            this.m_mass = 0;
            this.m_invMass = 0;
        }
        this.m_I = 0.0;
        this.m_invI = 0.0;
        this.m_userData = bd.userData;
        this.m_fixtureList = null;
        this.m_fixtureCount = 0;
    }
    BoxBody.prototype.createFixture = function (def) {
        if (this.m_world.isLocked() == true) {
            return null;
        }
        var fixture = new Fixture();
        fixture.create(this, def);
        if ((this.m_flags & BoxBody.e_activeFlag) == BoxBody.e_activeFlag) {
            var broadPhase = this.m_world.m_contactManager.m_broadPhase;
            fixture.createProxies(broadPhase, this.m_xf);
        }
        fixture.m_next = this.m_fixtureList;
        this.m_fixtureList = fixture;
        ++this.m_fixtureCount;
        fixture.m_body = this;
        if (fixture.m_density > 0.0) {
            this.resetMassData();
        }
        this.m_world.m_flags |= BoxWorld.NEW_FIXTURE;
        return fixture;
    };
    BoxBody.prototype.destroyFixture = function (fixture) {
        if (this.m_world.isLocked() == true) {
            return;
        }
        var node = this.m_fixtureList;
        var last = null;
        var found = false;
        while (node != null) {
            if (node == fixture) {
                node = fixture.m_next;
                found = true;
                break;
            }
            last = node;
            node = node.m_next;
        }
        if (last == null) {
            this.m_fixtureList = fixture.m_next;
        }
        else {
            last.m_next = fixture.m_next;
        }
        var edge = this.m_contactList;
        while (edge != null) {
            var c = edge.contact;
            edge = edge.next;
            var fixtureA = c.getFixtureA();
            var fixtureB = c.getFixtureB();
            if (fixture == fixtureA || fixture == fixtureB) {
                this.m_world.m_contactManager.destroy(c);
            }
        }
        if ((this.m_flags & BoxBody.e_activeFlag) == BoxBody.e_activeFlag) {
            var broadPhase = this.m_world.m_contactManager.m_broadPhase;
            fixture.destroyProxies(broadPhase);
        }
        fixture.destroy();
        fixture.m_body = null;
        fixture.m_next = null;
        fixture = null;
        --this.m_fixtureCount;
        this.resetMassData();
    };
    BoxBody.prototype.setTransform = function (position, angle) {
        if (this.m_world.isLocked() == true) {
            return;
        }
        this.m_xf.q.setValue(angle);
        this.m_xf.p.set(position);
        Transform.mulToOutUnsafe(this.m_xf, this.m_sweep.localCenter, this.m_sweep.c);
        this.m_sweep.a = angle;
        this.m_sweep.c0.set(this.m_sweep.c);
        this.m_sweep.a0 = this.m_sweep.a;
        var broadPhase = this.m_world.m_contactManager.m_broadPhase;
        for (var f = this.m_fixtureList; f != null; f = f.m_next) {
            f.synchronize(broadPhase, this.m_xf, this.m_xf);
        }
    };
    BoxBody.prototype.getTransform = function () {
        return this.m_xf;
    };
    BoxBody.prototype.getPosition = function () {
        return this.m_xf.p;
    };
    BoxBody.prototype.getAngle = function () {
        return this.m_sweep.a;
    };
    BoxBody.prototype.getWorldCenter = function () {
        return this.m_sweep.c;
    };
    BoxBody.prototype.getLocalCenter = function () {
        return this.m_sweep.localCenter;
    };
    BoxBody.prototype.setLinearVelocity = function (v) {
        if (this.m_type == BodyType.STATIC) {
            return;
        }
        if (Vec2.dot(v, v) > 0.0) {
            this.setAwake(true);
        }
        this.m_linearVelocity.set(v);
    };
    BoxBody.prototype.getLinearVelocity = function () {
        return this.m_linearVelocity;
    };
    BoxBody.prototype.setAngularVelocity = function (w) {
        if (this.m_type == BodyType.STATIC) {
            return;
        }
        if (w * w > 0) {
            this.setAwake(true);
        }
        this.m_angularVelocity = w;
    };
    BoxBody.prototype.getAngularVelocity = function () {
        return this.m_angularVelocity;
    };
    BoxBody.prototype.getGravityScale = function () {
        return this.m_gravityScale;
    };
    BoxBody.prototype.setGravityScale = function (gravityScale) {
        this.m_gravityScale = gravityScale;
    };
    BoxBody.prototype.applyForce = function (force, point) {
        if (this.m_type != BodyType.DYNAMIC) {
            return;
        }
        if (this.isAwake() == false) {
            this.setAwake(true);
        }
        this.m_force.x += force.x;
        this.m_force.y += force.y;
        this.m_torque += (point.x - this.m_sweep.c.x) * force.y - (point.y - this.m_sweep.c.y) * force.x;
    };
    BoxBody.prototype.applyForceToCenter = function (force) {
        if (this.m_type != BodyType.DYNAMIC) {
            return;
        }
        if (this.isAwake() == false) {
            this.setAwake(true);
        }
        this.m_force.x += force.x;
        this.m_force.y += force.y;
    };
    BoxBody.prototype.applyTorque = function (torque) {
        if (this.m_type != BodyType.DYNAMIC) {
            return;
        }
        if (this.isAwake() == false) {
            this.setAwake(true);
        }
        this.m_torque += torque;
    };
    BoxBody.prototype.applyLinearImpulse = function (impulse, point, wake) {
        if (this.m_type != BodyType.DYNAMIC) {
            return;
        }
        if (!this.isAwake()) {
            if (wake) {
                this.setAwake(true);
            }
            else {
                return;
            }
        }
        this.m_linearVelocity.x += impulse.x * this.m_invMass;
        this.m_linearVelocity.y += impulse.y * this.m_invMass;
        this.m_angularVelocity +=
            this.m_invI * ((point.x - this.m_sweep.c.x) * impulse.y - (point.y - this.m_sweep.c.y) * impulse.x);
    };
    BoxBody.prototype.applyAngularImpulse = function (impulse) {
        if (this.m_type != BodyType.DYNAMIC) {
            return;
        }
        if (this.isAwake() == false) {
            this.setAwake(true);
        }
        this.m_angularVelocity += this.m_invI * impulse;
    };
    BoxBody.prototype.getMass = function () {
        return this.m_mass;
    };
    BoxBody.prototype.getInertia = function () {
        return this.m_I
            + this.m_mass
                * (this.m_sweep.localCenter.x * this.m_sweep.localCenter.x + this.m_sweep.localCenter.y
                    * this.m_sweep.localCenter.y);
    };
    BoxBody.prototype.getMassData = function (data) {
        data.mass = this.m_mass;
        data.I =
            this.m_I + this.m_mass
                * (this.m_sweep.localCenter.x * this.m_sweep.localCenter.x + this.m_sweep.localCenter.y
                    * this.m_sweep.localCenter.y);
        data.center.x = this.m_sweep.localCenter.x;
        data.center.y = this.m_sweep.localCenter.y;
    };
    BoxBody.prototype.setMassData = function (massData) {
        if (this.m_world.isLocked() == true) {
            return;
        }
        if (this.m_type != BodyType.DYNAMIC) {
            return;
        }
        this.m_invMass = 0.0;
        this.m_I = 0.0;
        this.m_invI = 0.0;
        this.m_mass = massData.mass;
        if (this.m_mass <= 0.0) {
            this.m_mass = 1;
        }
        this.m_invMass = 1.0 / this.m_mass;
        if (massData.I > 0.0 && (this.m_flags & BoxBody.e_fixedRotationFlag) == 0) {
            this.m_I = massData.I - this.m_mass * Vec2.dot(massData.center, massData.center);
            this.m_invI = 1.0 / this.m_I;
        }
        var oldCenter = this.m_world.getPool().popVec2();
        oldCenter.set(this.m_sweep.c);
        this.m_sweep.localCenter.set(massData.center);
        Transform.mulToOutUnsafe(this.m_xf, this.m_sweep.localCenter, this.m_sweep.c0);
        this.m_sweep.c.set(this.m_sweep.c0);
        var temp = this.m_world.getPool().popVec2();
        temp.set(this.m_sweep.c).subLocal(oldCenter);
        Vec2.crossToOut(temp, -this.m_angularVelocity, temp);
        this.m_linearVelocity.addLocal(temp);
        this.m_world.getPool().pushVec2(2);
    };
    BoxBody.prototype.resetMassData = function () {
        this.m_mass = 0.0;
        this.m_invMass = 0.0;
        this.m_I = 0.0;
        this.m_invI = 0.0;
        this.m_sweep.localCenter.setZero();
        if (this.m_type == BodyType.STATIC || this.m_type == BodyType.KINEMATIC) {
            this.m_sweep.c0.set(this.m_xf.p);
            this.m_sweep.c.set(this.m_xf.p);
            this.m_sweep.a0 = this.m_sweep.a;
            return;
        }
        var localCenter = this.m_world.getPool().popVec2();
        localCenter.setZero();
        var temp = this.m_world.getPool().popVec2();
        var massData = this.pmd;
        for (var f = this.m_fixtureList; f != null; f = f.m_next) {
            if (f.m_density == 0.0) {
                continue;
            }
            f.getMassData(massData);
            this.m_mass += massData.mass;
            temp.set(massData.center).mulLocal(massData.mass);
            localCenter.addLocal(temp);
            this.m_I += massData.I;
        }
        if (this.m_mass > 0.0) {
            this.m_invMass = 1.0 / this.m_mass;
            localCenter.mulLocal(this.m_invMass);
        }
        else {
            this.m_mass = 1.0;
            this.m_invMass = 1.0;
        }
        if (this.m_I > 0.0 && (this.m_flags & BoxBody.e_fixedRotationFlag) == 0) {
            this.m_I -= this.m_mass * Vec2.dot(localCenter, localCenter);
            this.m_invI = 1.0 / this.m_I;
        }
        else {
            this.m_I = 0.0;
            this.m_invI = 0.0;
        }
        var oldCenter = this.m_world.getPool().popVec2();
        oldCenter.set(this.m_sweep.c);
        this.m_sweep.localCenter.set(localCenter);
        Transform.mulToOutUnsafe(this.m_xf, this.m_sweep.localCenter, this.m_sweep.c0);
        this.m_sweep.c.set(this.m_sweep.c0);
        temp.set(this.m_sweep.c).subLocal(oldCenter);
        var temp2 = oldCenter;
        Vec2.crossToOutUnsafe(temp, -this.m_angularVelocity, temp2);
        this.m_linearVelocity.addLocal(temp2);
        this.m_world.getPool().pushVec2(3);
    };
    BoxBody.prototype.getWorldPoint = function (localPoint) {
        var v = new Vec2();
        this.getWorldPointToOut(localPoint, v);
        return v;
    };
    BoxBody.prototype.getWorldPointToOut = function (localPoint, outData) {
        Transform.mulToOut(this.m_xf, localPoint, outData);
    };
    BoxBody.prototype.getWorldVector = function (localVector) {
        var outData = new Vec2();
        this.getWorldVectorToOut(localVector, outData);
        return outData;
    };
    BoxBody.prototype.getWorldVectorToOut = function (localVector, outData) {
        Rot.mulToOut(this.m_xf.q, localVector, outData);
    };
    BoxBody.prototype.getWorldVectorToOutUnsafe = function (localVector, outData) {
        Rot.mulToOutUnsafe(this.m_xf.q, localVector, outData);
    };
    BoxBody.prototype.getLocalPoint = function (worldPoint) {
        var outData = new Vec2();
        this.getLocalPointToOut(worldPoint, outData);
        return outData;
    };
    BoxBody.prototype.getLocalPointToOut = function (worldPoint, outData) {
        Transform.mulTransToOut(this.m_xf, worldPoint, outData);
    };
    BoxBody.prototype.getLocalVector = function (worldVector) {
        var outData = new Vec2();
        this.getLocalVectorToOut(worldVector, outData);
        return outData;
    };
    BoxBody.prototype.getLocalVectorToOut = function (worldVector, outData) {
        Rot.mulTransVec2(this.m_xf.q, worldVector, outData);
    };
    BoxBody.prototype.getLocalVectorToOutUnsafe = function (worldVector, outData) {
        Rot.mulTransUnsafeVec2(this.m_xf.q, worldVector, outData);
    };
    BoxBody.prototype.getLinearVelocityFromWorldPoint = function (worldPoint) {
        var outData = new Vec2();
        this.getLinearVelocityFromWorldPointToOut(worldPoint, outData);
        return outData;
    };
    BoxBody.prototype.getLinearVelocityFromWorldPointToOut = function (worldPoint, outData) {
        var tempX = worldPoint.x - this.m_sweep.c.x;
        var tempY = worldPoint.y - this.m_sweep.c.y;
        outData.x = -this.m_angularVelocity * tempY + this.m_linearVelocity.x;
        outData.y = this.m_angularVelocity * tempX + this.m_linearVelocity.y;
    };
    BoxBody.prototype.getLinearVelocityFromLocalPoint = function (localPoint) {
        var outData = new Vec2();
        this.getLinearVelocityFromLocalPointToOut(localPoint, outData);
        return outData;
    };
    BoxBody.prototype.getLinearVelocityFromLocalPointToOut = function (localPoint, outData) {
        this.getWorldPointToOut(localPoint, outData);
        this.getLinearVelocityFromWorldPointToOut(outData, outData);
    };
    BoxBody.prototype.getLinearDamping = function () {
        return this.m_linearDamping;
    };
    BoxBody.prototype.setLinearDamping = function (linearDamping) {
        this.m_linearDamping = linearDamping;
    };
    BoxBody.prototype.getAngularDamping = function () {
        return this.m_angularDamping;
    };
    BoxBody.prototype.setAngularDamping = function (angularDamping) {
        this.m_angularDamping = angularDamping;
    };
    BoxBody.prototype.getType = function () {
        return this.m_type;
    };
    BoxBody.prototype.setType = function (type) {
        if (this.m_world.isLocked() == true) {
            return;
        }
        if (this.m_type == type) {
            return;
        }
        this.m_type = type;
        this.resetMassData();
        if (this.m_type == BodyType.STATIC) {
            this.m_linearVelocity.setZero();
            this.m_angularVelocity = 0.0;
            this.m_sweep.a0 = this.m_sweep.a;
            this.m_sweep.c0.set(this.m_sweep.c);
            this.synchronizeFixtures();
        }
        this.setAwake(true);
        this.m_force.setZero();
        this.m_torque = 0.0;
        var ce = this.m_contactList;
        while (ce != null) {
            var ce0 = ce;
            ce = ce.next;
            this.m_world.m_contactManager.destroy(ce0.contact);
        }
        this.m_contactList = null;
        var broadPhase = this.m_world.m_contactManager.m_broadPhase;
        for (var f = this.m_fixtureList; f != null; f = f.m_next) {
            var proxyCount = f.m_proxyCount;
            for (var i = 0; i < proxyCount; ++i) {
                broadPhase.touchProxy(f.m_proxies[i].proxyId);
            }
        }
    };
    BoxBody.prototype.isBullet = function () {
        return (this.m_flags & BoxBody.e_bulletFlag) == BoxBody.e_bulletFlag;
    };
    BoxBody.prototype.setBullet = function (flag) {
        if (flag) {
            this.m_flags |= BoxBody.e_bulletFlag;
        }
        else {
            this.m_flags &= ~BoxBody.e_bulletFlag;
        }
    };
    BoxBody.prototype.setSleepingAllowed = function (flag) {
        if (flag) {
            this.m_flags |= BoxBody.e_autoSleepFlag;
        }
        else {
            this.m_flags &= ~BoxBody.e_autoSleepFlag;
            this.setAwake(true);
        }
    };
    BoxBody.prototype.isSleepingAllowed = function () {
        return (this.m_flags & BoxBody.e_autoSleepFlag) == BoxBody.e_autoSleepFlag;
    };
    BoxBody.prototype.setAwake = function (flag) {
        if (flag) {
            if ((this.m_flags & BoxBody.e_awakeFlag) == 0) {
                this.m_flags |= BoxBody.e_awakeFlag;
                this.m_sleepTime = 0.0;
            }
        }
        else {
            this.m_flags &= ~BoxBody.e_awakeFlag;
            this.m_sleepTime = 0.0;
            this.m_linearVelocity.setZero();
            this.m_angularVelocity = 0.0;
            this.m_force.setZero();
            this.m_torque = 0.0;
        }
    };
    BoxBody.prototype.isAwake = function () {
        return (this.m_flags & BoxBody.e_awakeFlag) == BoxBody.e_awakeFlag;
    };
    BoxBody.prototype.setActive = function (flag) {
        if (flag == this.isActive()) {
            return;
        }
        if (flag) {
            this.m_flags |= BoxBody.e_activeFlag;
            var broadPhase = this.m_world.m_contactManager.m_broadPhase;
            for (var f = this.m_fixtureList; f != null; f = f.m_next) {
                f.createProxies(broadPhase, this.m_xf);
            }
        }
        else {
            this.m_flags &= ~BoxBody.e_activeFlag;
            var broadPhase = this.m_world.m_contactManager.m_broadPhase;
            for (var f = this.m_fixtureList; f != null; f = f.m_next) {
                f.destroyProxies(broadPhase);
            }
            var ce = this.m_contactList;
            while (ce != null) {
                var ce0 = ce;
                ce = ce.next;
                this.m_world.m_contactManager.destroy(ce0.contact);
            }
            this.m_contactList = null;
        }
    };
    BoxBody.prototype.isActive = function () {
        return (this.m_flags & BoxBody.e_activeFlag) == BoxBody.e_activeFlag;
    };
    BoxBody.prototype.setFixedRotation = function (flag) {
        if (flag) {
            this.m_flags |= BoxBody.e_fixedRotationFlag;
        }
        else {
            this.m_flags &= ~BoxBody.e_fixedRotationFlag;
        }
        this.resetMassData();
    };
    BoxBody.prototype.isFixedRotation = function () {
        return (this.m_flags & BoxBody.e_fixedRotationFlag) == BoxBody.e_fixedRotationFlag;
    };
    BoxBody.prototype.getFixtureList = function () {
        return this.m_fixtureList;
    };
    BoxBody.prototype.getJointList = function () {
        return this.m_jointList;
    };
    BoxBody.prototype.getContactList = function () {
        return this.m_contactList;
    };
    BoxBody.prototype.getNext = function () {
        return this.m_next;
    };
    BoxBody.prototype.getUserData = function () {
        return this.m_userData;
    };
    BoxBody.prototype.setUserData = function (data) {
        this.m_userData = data;
    };
    BoxBody.prototype.getWorld = function () {
        return this.m_world;
    };
    BoxBody.prototype.synchronizeFixtures = function () {
        var xf1 = this.pxf;
        xf1.q.s = MathUtils.sin(this.m_sweep.a0);
        xf1.q.c = MathUtils.cos(this.m_sweep.a0);
        xf1.p.x = this.m_sweep.c0.x - xf1.q.c * this.m_sweep.localCenter.x + xf1.q.s * this.m_sweep.localCenter.y;
        xf1.p.y = this.m_sweep.c0.y - xf1.q.s * this.m_sweep.localCenter.x - xf1.q.c * this.m_sweep.localCenter.y;
        for (var f = this.m_fixtureList; f != null; f = f.m_next) {
            f.synchronize(this.m_world.m_contactManager.m_broadPhase, xf1, this.m_xf);
        }
    };
    BoxBody.prototype.synchronizeTransform = function () {
        this.m_xf.q.s = MathUtils.sin(this.m_sweep.a);
        this.m_xf.q.c = MathUtils.cos(this.m_sweep.a);
        var q = this.m_xf.q;
        var v = this.m_sweep.localCenter;
        this.m_xf.p.x = this.m_sweep.c.x - q.c * v.x + q.s * v.y;
        this.m_xf.p.y = this.m_sweep.c.y - q.s * v.x - q.c * v.y;
    };
    BoxBody.prototype.shouldCollide = function (other) {
        if (this.m_type != BodyType.DYNAMIC && other.m_type != BodyType.DYNAMIC) {
            return false;
        }
        for (var jn = this.m_jointList; jn != null; jn = jn.next) {
            if (jn.other == other) {
                if (jn.joint.getCollideConnected() == false) {
                    return false;
                }
            }
        }
        return true;
    };
    BoxBody.prototype.advance = function (t) {
        this.m_sweep.advance(t);
        this.m_sweep.c.set(this.m_sweep.c0);
        this.m_sweep.a = this.m_sweep.a0;
        this.m_xf.q.setValue(this.m_sweep.a);
        Rot.mulToOutUnsafe(this.m_xf.q, this.m_sweep.localCenter, this.m_xf.p);
        this.m_xf.p.mulLocal(-1).addLocal(this.m_sweep.c);
    };
    BoxBody.e_islandFlag = 0x0001;
    BoxBody.e_awakeFlag = 0x0002;
    BoxBody.e_autoSleepFlag = 0x0004;
    BoxBody.e_bulletFlag = 0x0008;
    BoxBody.e_fixedRotationFlag = 0x0010;
    BoxBody.e_activeFlag = 0x0020;
    BoxBody.e_toiFlag = 0x0040;
    return BoxBody;
}());
var BoxWorld = (function () {
    function BoxWorld(gravity) {
        this.activeContacts = 0;
        this.contactPoolCount = 0;
        this.m_flags = 0;
        this.m_contactManager = null;
        this.m_bodyList = null;
        this.m_jointList = null;
        this.m_bodyCount = 0;
        this.m_jointCount = 0;
        this.m_gravity = new Vec2();
        this.m_allowSleep = false;
        this.m_destructionListener = null;
        this.pool = null;
        this.m_inv_dt0 = 0;
        this.m_warmStarting = false;
        this.m_continuousPhysics = false;
        this.m_subStepping = false;
        this.m_stepComplete = false;
        this.contactStacks = new Array(ShapeType.MAX);
        this.timeStep = new TimeStep();
        this.wqwrapper = new WorldQueryWrapper();
        this.wrcwrapper = new WorldRayCastWrapper();
        this.input = new RayCastInput();
        this.island = new Island();
        this.stack = new Array(10);
        this.toiIsland = new Island();
        this.toiInput = new TimeOfImpactTOIInput();
        this.toiOutput = new TimeOfImpactTOIOutput();
        this.subStep = new TimeStep();
        this.tempBodies = new Array(2);
        this.backup1 = new Sweep();
        this.backup2 = new Sweep();
        for (var i = 0; i < this.contactStacks.length; i++)
            this.contactStacks[i] = new Array(ShapeType.MAX);
        var pool = new DefaultWorldPool(BoxWorld.WORLD_POOL_SIZE);
        var broadPhase = new DefaultBroadPhaseBuffer(new DynamicTree());
        this.pool = pool;
        this.m_destructionListener = null;
        this.m_bodyList = null;
        this.m_jointList = null;
        this.m_bodyCount = 0;
        this.m_jointCount = 0;
        this.m_warmStarting = true;
        this.m_continuousPhysics = true;
        this.m_subStepping = false;
        this.m_stepComplete = true;
        this.m_allowSleep = true;
        this.m_gravity.set(gravity);
        this.m_flags = BoxWorld.CLEAR_FORCES;
        this.m_inv_dt0 = 0;
        this.m_contactManager = new ContactManager(this, broadPhase);
        this.initializeRegisters();
    }
    BoxWorld.prototype.setAllowSleep = function (flag) {
        if (flag == this.m_allowSleep) {
            return;
        }
        this.m_allowSleep = flag;
        if (this.m_allowSleep == false) {
            for (var b = this.m_bodyList; b != null; b = b.m_next) {
                b.setAwake(true);
            }
        }
    };
    BoxWorld.prototype.setSubStepping = function (subStepping) {
        this.m_subStepping = subStepping;
    };
    BoxWorld.prototype.isSubStepping = function () {
        return this.m_subStepping;
    };
    BoxWorld.prototype.isAllowSleep = function () {
        return this.m_allowSleep;
    };
    BoxWorld.prototype.addType = function (creator, type1, type2) {
        var register3 = new ContactRegister();
        register3.creator = creator;
        register3.primary = true;
        this.contactStacks[type1][type2] = register3;
        if (type1 != type2) {
            var register2 = new ContactRegister();
            register2.creator = creator;
            register2.primary = false;
            this.contactStacks[type2][type1] = register2;
        }
    };
    BoxWorld.prototype.initializeRegisters = function () {
        this.addType(this.pool.getCircleContactStack(), ShapeType.CIRCLE, ShapeType.CIRCLE);
        this.addType(this.pool.getPolyCircleContactStack(), ShapeType.POLYGON, ShapeType.CIRCLE);
        this.addType(this.pool.getPolyContactStack(), ShapeType.POLYGON, ShapeType.POLYGON);
        this.addType(this.pool.getEdgeCircleContactStack(), ShapeType.EDGE, ShapeType.CIRCLE);
        this.addType(this.pool.getEdgePolyContactStack(), ShapeType.EDGE, ShapeType.POLYGON);
        this.addType(this.pool.getChainCircleContactStack(), ShapeType.CHAIN, ShapeType.CIRCLE);
        this.addType(this.pool.getChainPolyContactStack(), ShapeType.CHAIN, ShapeType.POLYGON);
    };
    BoxWorld.prototype.getDestructionListener = function () {
        return this.m_destructionListener;
    };
    BoxWorld.prototype.popContact = function (fixtureA, indexA, fixtureB, indexB) {
        var type1 = fixtureA.getType();
        var type2 = fixtureB.getType();
        var reg = this.contactStacks[type1][type2];
        if (reg != null) {
            if (reg.primary) {
                var c = reg.creator.pop();
                c.init(fixtureA, indexA, fixtureB, indexB);
                return c;
            }
            else {
                var c = reg.creator.pop();
                c.init(fixtureB, indexB, fixtureA, indexA);
                return c;
            }
        }
        else {
            return null;
        }
    };
    BoxWorld.prototype.pushContact = function (contact) {
        var fixtureA = contact.getFixtureA();
        var fixtureB = contact.getFixtureB();
        if (contact.m_manifold.pointCount > 0 && !fixtureA.isSensor() && !fixtureB.isSensor()) {
            fixtureA.getBody().setAwake(true);
            fixtureB.getBody().setAwake(true);
        }
        var type1 = fixtureA.getType();
        var type2 = fixtureB.getType();
        var creator = this.contactStacks[type1][type2].creator;
        creator.push(contact);
    };
    BoxWorld.prototype.getPool = function () {
        return this.pool;
    };
    BoxWorld.prototype.setDestructionListener = function (listener) {
        this.m_destructionListener = listener;
    };
    BoxWorld.prototype.setContactFilter = function (filter) {
        this.m_contactManager.m_contactFilter = filter;
    };
    BoxWorld.prototype.setContactListener = function (listener) {
        this.m_contactManager.m_contactListener = listener;
    };
    BoxWorld.prototype.createBody = function (def) {
        if (this.isLocked()) {
            return null;
        }
        var b = new BoxBody(def, this);
        b.m_prev = null;
        b.m_next = this.m_bodyList;
        if (this.m_bodyList != null) {
            this.m_bodyList.m_prev = b;
        }
        this.m_bodyList = b;
        ++this.m_bodyCount;
        return b;
    };
    BoxWorld.prototype.destroyBody = function (body) {
        if (this.isLocked()) {
            return;
        }
        var je = body.m_jointList;
        while (je != null) {
            var je0 = je;
            je = je.next;
            if (this.m_destructionListener != null) {
                this.m_destructionListener.sayGoodbyeJoint(je0.joint);
            }
            this.destroyJoint(je0.joint);
            body.m_jointList = je;
        }
        body.m_jointList = null;
        var ce = body.m_contactList;
        while (ce != null) {
            var ce0 = ce;
            ce = ce.next;
            this.m_contactManager.destroy(ce0.contact);
        }
        body.m_contactList = null;
        var f = body.m_fixtureList;
        while (f != null) {
            var f0 = f;
            f = f.m_next;
            if (this.m_destructionListener != null) {
                this.m_destructionListener.sayGoodbyeFixture(f0);
            }
            f0.destroyProxies(this.m_contactManager.m_broadPhase);
            f0.destroy();
            body.m_fixtureList = f;
            body.m_fixtureCount -= 1;
        }
        body.m_fixtureList = null;
        body.m_fixtureCount = 0;
        if (body.m_prev != null) {
            body.m_prev.m_next = body.m_next;
        }
        if (body.m_next != null) {
            body.m_next.m_prev = body.m_prev;
        }
        if (body == this.m_bodyList) {
            this.m_bodyList = body.m_next;
        }
        --this.m_bodyCount;
    };
    BoxWorld.prototype.createJoint = function (def) {
        if (this.isLocked()) {
            return null;
        }
        var j = Joint.Create(this, def);
        j.m_prev = null;
        j.m_next = this.m_jointList;
        if (this.m_jointList != null) {
            this.m_jointList.m_prev = j;
        }
        this.m_jointList = j;
        ++this.m_jointCount;
        j.m_edgeA.joint = j;
        j.m_edgeA.other = j.getBodyB();
        j.m_edgeA.prev = null;
        j.m_edgeA.next = j.getBodyA().m_jointList;
        if (j.getBodyA().m_jointList != null) {
            j.getBodyA().m_jointList.prev = j.m_edgeA;
        }
        j.getBodyA().m_jointList = j.m_edgeA;
        j.m_edgeB.joint = j;
        j.m_edgeB.other = j.getBodyA();
        j.m_edgeB.prev = null;
        j.m_edgeB.next = j.getBodyB().m_jointList;
        if (j.getBodyB().m_jointList != null) {
            j.getBodyB().m_jointList.prev = j.m_edgeB;
        }
        j.getBodyB().m_jointList = j.m_edgeB;
        var bodyA = def.bodyA;
        var bodyB = def.bodyB;
        if (def.collideConnected == false) {
            var edge = bodyB.getContactList();
            while (edge != null) {
                if (edge.other == bodyA) {
                    edge.contact.flagForFiltering();
                }
                edge = edge.next;
            }
        }
        return j;
    };
    BoxWorld.prototype.destroyJoint = function (j) {
        if (this.isLocked()) {
            return;
        }
        var collideConnected = j.getCollideConnected();
        if (j.m_prev != null) {
            j.m_prev.m_next = j.m_next;
        }
        if (j.m_next != null) {
            j.m_next.m_prev = j.m_prev;
        }
        if (j == this.m_jointList) {
            this.m_jointList = j.m_next;
        }
        var bodyA = j.getBodyA();
        var bodyB = j.getBodyB();
        bodyA.setAwake(true);
        bodyB.setAwake(true);
        if (j.m_edgeA.prev != null) {
            j.m_edgeA.prev.next = j.m_edgeA.next;
        }
        if (j.m_edgeA.next != null) {
            j.m_edgeA.next.prev = j.m_edgeA.prev;
        }
        if (j.m_edgeA == bodyA.m_jointList) {
            bodyA.m_jointList = j.m_edgeA.next;
        }
        j.m_edgeA.prev = null;
        j.m_edgeA.next = null;
        if (j.m_edgeB.prev != null) {
            j.m_edgeB.prev.next = j.m_edgeB.next;
        }
        if (j.m_edgeB.next != null) {
            j.m_edgeB.next.prev = j.m_edgeB.prev;
        }
        if (j.m_edgeB == bodyB.m_jointList) {
            bodyB.m_jointList = j.m_edgeB.next;
        }
        j.m_edgeB.prev = null;
        j.m_edgeB.next = null;
        Joint.destroy(j);
        --this.m_jointCount;
        if (collideConnected == false) {
            var edge = bodyB.getContactList();
            while (edge != null) {
                if (edge.other == bodyA) {
                    edge.contact.flagForFiltering();
                }
                edge = edge.next;
            }
        }
    };
    BoxWorld.prototype.step = function (dt, velocityIterations, positionIterations) {
        if ((this.m_flags & BoxWorld.NEW_FIXTURE) == BoxWorld.NEW_FIXTURE) {
            this.m_contactManager.findNewContacts();
            this.m_flags &= ~BoxWorld.NEW_FIXTURE;
        }
        this.m_flags |= BoxWorld.LOCKED;
        this.timeStep.dt = dt;
        this.timeStep.velocityIterations = velocityIterations;
        this.timeStep.positionIterations = positionIterations;
        if (dt > 0.0) {
            this.timeStep.inv_dt = 1.0 / dt;
        }
        else {
            this.timeStep.inv_dt = 0.0;
        }
        this.timeStep.dtRatio = this.m_inv_dt0 * dt;
        this.timeStep.warmStarting = this.m_warmStarting;
        this.m_contactManager.collide();
        if (this.m_stepComplete && this.timeStep.dt > 0.0) {
            this.solve(this.timeStep);
        }
        if (this.m_continuousPhysics && this.timeStep.dt > 0.0) {
            this.solveTOI(this.timeStep);
        }
        if (this.timeStep.dt > 0.0) {
            this.m_inv_dt0 = this.timeStep.inv_dt;
        }
        if ((this.m_flags & BoxWorld.CLEAR_FORCES) == BoxWorld.CLEAR_FORCES) {
            this.clearForces();
        }
        this.m_flags &= ~BoxWorld.LOCKED;
    };
    BoxWorld.prototype.clearForces = function () {
        for (var body = this.m_bodyList; body != null; body = body.getNext()) {
            body.m_force.setZero();
            body.m_torque = 0.0;
        }
    };
    BoxWorld.prototype.queryAABB = function (callback, aabb) {
        this.wqwrapper.broadPhase = this.m_contactManager.m_broadPhase;
        this.wqwrapper.callback = callback;
        this.m_contactManager.m_broadPhase.query(this.wqwrapper, aabb);
    };
    BoxWorld.prototype.raycast = function (callback, point1, point2) {
        this.wrcwrapper.broadPhase = this.m_contactManager.m_broadPhase;
        this.wrcwrapper.callback = callback;
        this.input.maxFraction = 1.0;
        this.input.p1.set(point1);
        this.input.p2.set(point2);
        this.m_contactManager.m_broadPhase.raycast(this.wrcwrapper, this.input);
    };
    BoxWorld.prototype.getBodyList = function () {
        return this.m_bodyList;
    };
    BoxWorld.prototype.getJointList = function () {
        return this.m_jointList;
    };
    BoxWorld.prototype.getContactList = function () {
        return this.m_contactManager.m_contactList;
    };
    BoxWorld.prototype.isSleepingAllowed = function () {
        return this.m_allowSleep;
    };
    BoxWorld.prototype.setSleepingAllowed = function (sleepingAllowed) {
        this.m_allowSleep = sleepingAllowed;
    };
    BoxWorld.prototype.setWarmStarting = function (flag) {
        this.m_warmStarting = flag;
    };
    BoxWorld.prototype.isWarmStarting = function () {
        return this.m_warmStarting;
    };
    BoxWorld.prototype.setContinuousPhysics = function (flag) {
        this.m_continuousPhysics = flag;
    };
    BoxWorld.prototype.isContinuousPhysics = function () {
        return this.m_continuousPhysics;
    };
    BoxWorld.prototype.getProxyCount = function () {
        return this.m_contactManager.m_broadPhase.getProxyCount();
    };
    BoxWorld.prototype.getBodyCount = function () {
        return this.m_bodyCount;
    };
    BoxWorld.prototype.getJointCount = function () {
        return this.m_jointCount;
    };
    BoxWorld.prototype.getContactCount = function () {
        return this.m_contactManager.m_contactCount;
    };
    BoxWorld.prototype.getTreeHeight = function () {
        return this.m_contactManager.m_broadPhase.getTreeHeight();
    };
    BoxWorld.prototype.getTreeBalance = function () {
        return this.m_contactManager.m_broadPhase.getTreeBalance();
    };
    BoxWorld.prototype.getTreeQuality = function () {
        return this.m_contactManager.m_broadPhase.getTreeQuality();
    };
    BoxWorld.prototype.setGravity = function (gravity) {
        this.m_gravity.set(gravity);
    };
    BoxWorld.prototype.getGravity = function () {
        return this.m_gravity;
    };
    BoxWorld.prototype.isLocked = function () {
        return (this.m_flags & BoxWorld.LOCKED) == BoxWorld.LOCKED;
    };
    BoxWorld.prototype.setAutoClearForces = function (flag) {
        if (flag) {
            this.m_flags |= BoxWorld.CLEAR_FORCES;
        }
        else {
            this.m_flags &= ~BoxWorld.CLEAR_FORCES;
        }
    };
    BoxWorld.prototype.getAutoClearForces = function () {
        return (this.m_flags & BoxWorld.CLEAR_FORCES) == BoxWorld.CLEAR_FORCES;
    };
    BoxWorld.prototype.getContactManager = function () {
        return this.m_contactManager;
    };
    BoxWorld.prototype.solve = function (step) {
        for (var b = this.m_bodyList; b != null; b = b.m_next) {
            b.m_xf0.set(b.m_xf);
        }
        this.island.init(this.m_bodyCount, this.m_contactManager.m_contactCount, this.m_jointCount, this.m_contactManager.m_contactListener);
        for (var b = this.m_bodyList; b != null; b = b.m_next) {
            b.m_flags &= ~BoxBody.e_islandFlag;
        }
        for (var c = this.m_contactManager.m_contactList; c != null; c = c.m_next) {
            c.m_flags &= ~Contact.ISLAND_FLAG;
        }
        for (var j = this.m_jointList; j != null; j = j.m_next) {
            j.m_islandFlag = false;
        }
        var stackSize = this.m_bodyCount;
        if (this.stack.length < stackSize) {
            this.stack = new Array(stackSize);
        }
        for (var seed = this.m_bodyList; seed != null; seed = seed.m_next) {
            if ((seed.m_flags & BoxBody.e_islandFlag) == BoxBody.e_islandFlag) {
                continue;
            }
            if (seed.isAwake() == false || seed.isActive() == false) {
                continue;
            }
            if (seed.getType() == BodyType.STATIC) {
                continue;
            }
            this.island.clear();
            var stackCount = 0;
            this.stack[stackCount++] = seed;
            seed.m_flags |= BoxBody.e_islandFlag;
            while (stackCount > 0) {
                var b = this.stack[--stackCount];
                this.island.addBody(b);
                b.setAwake(true);
                if (b.getType() == BodyType.STATIC) {
                    continue;
                }
                for (var ce = b.m_contactList; ce != null; ce = ce.next) {
                    var contact = ce.contact;
                    if ((contact.m_flags & Contact.ISLAND_FLAG) == Contact.ISLAND_FLAG) {
                        continue;
                    }
                    if (contact.isEnabled() == false || contact.isTouching() == false) {
                        continue;
                    }
                    var sensorA = contact.m_fixtureA.m_isSensor;
                    var sensorB = contact.m_fixtureB.m_isSensor;
                    if (sensorA || sensorB) {
                        continue;
                    }
                    this.island.addContact(contact);
                    contact.m_flags |= Contact.ISLAND_FLAG;
                    var other = ce.other;
                    if ((other.m_flags & BoxBody.e_islandFlag) == BoxBody.e_islandFlag) {
                        continue;
                    }
                    this.stack[stackCount++] = other;
                    other.m_flags |= BoxBody.e_islandFlag;
                }
                for (var je = b.m_jointList; je != null; je = je.next) {
                    if (je.joint.m_islandFlag == true) {
                        continue;
                    }
                    var other = je.other;
                    if (other.isActive() == false) {
                        continue;
                    }
                    this.island.addJoint(je.joint);
                    je.joint.m_islandFlag = true;
                    if ((other.m_flags & BoxBody.e_islandFlag) == BoxBody.e_islandFlag) {
                        continue;
                    }
                    this.stack[stackCount++] = other;
                    other.m_flags |= BoxBody.e_islandFlag;
                }
            }
            this.island.solve(step, this.m_gravity, this.m_allowSleep);
            for (var i = 0; i < this.island.m_bodyCount; ++i) {
                var b = this.island.m_bodies[i];
                if (b.getType() == BodyType.STATIC) {
                    b.m_flags &= ~BoxBody.e_islandFlag;
                }
            }
        }
        for (var b = this.m_bodyList; b != null; b = b.getNext()) {
            if ((b.m_flags & BoxBody.e_islandFlag) == 0) {
                continue;
            }
            if (b.getType() == BodyType.STATIC) {
                continue;
            }
            b.synchronizeFixtures();
        }
        this.m_contactManager.findNewContacts();
    };
    BoxWorld.prototype.solveTOI = function (step) {
        var island = this.toiIsland;
        island.init(2 * Settings.maxTOIContacts, Settings.maxTOIContacts, 0, this.m_contactManager.m_contactListener);
        if (this.m_stepComplete) {
            for (var b = this.m_bodyList; b != null; b = b.m_next) {
                b.m_flags &= ~BoxBody.e_islandFlag;
                b.m_sweep.alpha0 = 0.0;
            }
            for (var c = this.m_contactManager.m_contactList; c != null; c = c.m_next) {
                c.m_flags &= ~(Contact.TOI_FLAG | Contact.ISLAND_FLAG);
                c.m_toiCount = 0;
                c.m_toi = 1.0;
            }
        }
        for (;;) {
            var minContact = null;
            var minAlpha = 1.0;
            for (var c = this.m_contactManager.m_contactList; c != null; c = c.m_next) {
                if (c.isEnabled() == false) {
                    continue;
                }
                if (c.m_toiCount > Settings.maxSubSteps) {
                    continue;
                }
                var alpha = 1.0;
                if ((c.m_flags & Contact.TOI_FLAG) != 0) {
                    alpha = c.m_toi;
                }
                else {
                    var fA = c.getFixtureA();
                    var fB = c.getFixtureB();
                    if (fA.isSensor() || fB.isSensor()) {
                        continue;
                    }
                    var bA = fA.getBody();
                    var bB = fB.getBody();
                    var typeA = bA.m_type;
                    var typeB = bB.m_type;
                    var activeA = bA.isAwake() && typeA != BodyType.STATIC;
                    var activeB = bB.isAwake() && typeB != BodyType.STATIC;
                    if (activeA == false && activeB == false) {
                        continue;
                    }
                    var collideA = bA.isBullet() || typeA != BodyType.DYNAMIC;
                    var collideB = bB.isBullet() || typeB != BodyType.DYNAMIC;
                    if (collideA == false && collideB == false) {
                        continue;
                    }
                    var alpha0 = bA.m_sweep.alpha0;
                    if (bA.m_sweep.alpha0 < bB.m_sweep.alpha0) {
                        alpha0 = bB.m_sweep.alpha0;
                        bA.m_sweep.advance(alpha0);
                    }
                    else if (bB.m_sweep.alpha0 < bA.m_sweep.alpha0) {
                        alpha0 = bA.m_sweep.alpha0;
                        bB.m_sweep.advance(alpha0);
                    }
                    var indexA = c.getChildIndexA();
                    var indexB = c.getChildIndexB();
                    var input = this.toiInput;
                    input.proxyA.set(fA.getShape(), indexA);
                    input.proxyB.set(fB.getShape(), indexB);
                    input.sweepA.set(bA.m_sweep);
                    input.sweepB.set(bB.m_sweep);
                    input.tMax = 1.0;
                    this.pool.getTimeOfImpact().timeOfImpact(this.toiOutput, input);
                    var beta = this.toiOutput.t;
                    if (this.toiOutput.state == TimeOfImpact.TOIOutputState_TOUCHING) {
                        alpha = dMath.Min(alpha0 + (1.0 - alpha0) * beta, 1.0);
                    }
                    else {
                        alpha = 1.0;
                    }
                    c.m_toi = alpha;
                    c.m_flags |= Contact.TOI_FLAG;
                }
                if (alpha < minAlpha) {
                    minContact = c;
                    minAlpha = alpha;
                }
            }
            if (minContact == null || 1.0 - 10.0 * Settings.EPSILON < minAlpha) {
                this.m_stepComplete = true;
                break;
            }
            var fA = minContact.getFixtureA();
            var fB = minContact.getFixtureB();
            var bA = fA.getBody();
            var bB = fB.getBody();
            this.backup1.set(bA.m_sweep);
            this.backup2.set(bB.m_sweep);
            bA.advance(minAlpha);
            bB.advance(minAlpha);
            minContact.update(this.m_contactManager.m_contactListener);
            minContact.m_flags &= ~Contact.TOI_FLAG;
            ++minContact.m_toiCount;
            if (minContact.isEnabled() == false || minContact.isTouching() == false) {
                minContact.setEnabled(false);
                bA.m_sweep.set(this.backup1);
                bB.m_sweep.set(this.backup2);
                bA.synchronizeTransform();
                bB.synchronizeTransform();
                continue;
            }
            bA.setAwake(true);
            bB.setAwake(true);
            island.clear();
            island.addBody(bA);
            island.addBody(bB);
            island.addContact(minContact);
            bA.m_flags |= BoxBody.e_islandFlag;
            bB.m_flags |= BoxBody.e_islandFlag;
            minContact.m_flags |= Contact.ISLAND_FLAG;
            this.tempBodies[0] = bA;
            this.tempBodies[1] = bB;
            for (var i = 0; i < 2; ++i) {
                var body = this.tempBodies[i];
                if (body.m_type == BodyType.DYNAMIC) {
                    for (var ce = body.m_contactList; ce != null; ce = ce.next) {
                        if (island.m_bodyCount == island.m_bodyCapacity) {
                            break;
                        }
                        if (island.m_contactCount == island.m_contactCapacity) {
                            break;
                        }
                        var contact = ce.contact;
                        if ((contact.m_flags & Contact.ISLAND_FLAG) != 0) {
                            continue;
                        }
                        var other = ce.other;
                        if (other.m_type == BodyType.DYNAMIC && body.isBullet() == false && other.isBullet() == false) {
                            continue;
                        }
                        var sensorA = contact.m_fixtureA.m_isSensor;
                        var sensorB = contact.m_fixtureB.m_isSensor;
                        if (sensorA || sensorB) {
                            continue;
                        }
                        this.backup1.set(other.m_sweep);
                        if ((other.m_flags & BoxBody.e_islandFlag) == 0) {
                            other.advance(minAlpha);
                        }
                        contact.update(this.m_contactManager.m_contactListener);
                        if (contact.isEnabled() == false) {
                            other.m_sweep.set(this.backup1);
                            other.synchronizeTransform();
                            continue;
                        }
                        if (contact.isTouching() == false) {
                            other.m_sweep.set(this.backup1);
                            other.synchronizeTransform();
                            continue;
                        }
                        contact.m_flags |= Contact.ISLAND_FLAG;
                        island.addContact(contact);
                        if ((other.m_flags & BoxBody.e_islandFlag) != 0) {
                            continue;
                        }
                        other.m_flags |= BoxBody.e_islandFlag;
                        if (other.m_type != BodyType.STATIC) {
                            other.setAwake(true);
                        }
                        island.addBody(other);
                    }
                }
            }
            this.subStep.dt = (1.0 - minAlpha) * step.dt;
            this.subStep.inv_dt = 1.0 / this.subStep.dt;
            this.subStep.dtRatio = 1.0;
            this.subStep.positionIterations = 20;
            this.subStep.velocityIterations = step.velocityIterations;
            this.subStep.warmStarting = false;
            island.solveTOI(this.subStep, bA.m_islandIndex, bB.m_islandIndex);
            for (var i = 0; i < island.m_bodyCount; ++i) {
                var body = island.m_bodies[i];
                body.m_flags &= ~BoxBody.e_islandFlag;
                if (body.m_type != BodyType.DYNAMIC) {
                    continue;
                }
                body.synchronizeFixtures();
                for (var ce = body.m_contactList; ce != null; ce = ce.next) {
                    ce.contact.m_flags &= ~(Contact.TOI_FLAG | Contact.ISLAND_FLAG);
                }
            }
            this.m_contactManager.findNewContacts();
            if (this.m_subStepping) {
                this.m_stepComplete = false;
                break;
            }
        }
    };
    BoxWorld.WORLD_POOL_SIZE = 100;
    BoxWorld.NEW_FIXTURE = 0x0001;
    BoxWorld.LOCKED = 0x0002;
    BoxWorld.CLEAR_FORCES = 0x0004;
    return BoxWorld;
}());
var WorldQueryWrapper = (function (_super) {
    __extends(WorldQueryWrapper, _super);
    function WorldQueryWrapper() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.broadPhase = null;
        _this.callback = null;
        return _this;
    }
    WorldQueryWrapper.prototype.treeCallback = function (nodeId) {
        var proxy = this.broadPhase.getUserData(nodeId);
        return this.callback.reportFixture(proxy.fixture);
    };
    return WorldQueryWrapper;
}(TreeCallback));
var WorldRayCastWrapper = (function (_super) {
    __extends(WorldRayCastWrapper, _super);
    function WorldRayCastWrapper() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.output = new RayCastOutput();
        _this.temp = new Vec2();
        _this.point = new Vec2();
        _this.broadPhase = null;
        _this.callback = null;
        return _this;
    }
    WorldRayCastWrapper.prototype.raycastCallback = function (input, nodeId) {
        var userData = this.broadPhase.getUserData(nodeId);
        var proxy = userData;
        var fixture = proxy.fixture;
        var index = proxy.childIndex;
        var hit = fixture.raycast(this.output, input, index);
        if (hit) {
            var fraction = this.output.fraction;
            this.temp.set(input.p2).mulLocal(fraction);
            this.point.set(input.p1).mulLocal(1 - fraction).addLocal(this.temp);
            return this.callback.reportFixture(fixture, this.point, this.output.normal, fraction);
        }
        return input.maxFraction;
    };
    return WorldRayCastWrapper;
}(TreeRayCastCallback));
var ContactManager = (function (_super) {
    __extends(ContactManager, _super);
    function ContactManager(argPool, broadPhase) {
        var _this = _super.call(this) || this;
        _this.m_broadPhase = null;
        _this.m_contactList = null;
        _this.m_contactCount = 0;
        _this.m_contactFilter = null;
        _this.m_contactListener = null;
        _this.pool = null;
        _this.m_contactList = null;
        _this.m_contactCount = 0;
        _this.m_contactFilter = new ContactFilter();
        _this.m_contactListener = null;
        _this.m_broadPhase = broadPhase;
        _this.pool = argPool;
        return _this;
    }
    ContactManager.prototype.addPair = function (proxyUserDataA, proxyUserDataB) {
        var proxyA = proxyUserDataA;
        var proxyB = proxyUserDataB;
        var fixtureA = proxyA.fixture;
        var fixtureB = proxyB.fixture;
        var indexA = proxyA.childIndex;
        var indexB = proxyB.childIndex;
        var bodyA = fixtureA.getBody();
        var bodyB = fixtureB.getBody();
        if (bodyA == bodyB) {
            return;
        }
        var edge = bodyB.getContactList();
        while (edge != null) {
            if (edge.other == bodyA) {
                var fA = edge.contact.getFixtureA();
                var fB = edge.contact.getFixtureB();
                var iA = edge.contact.getChildIndexA();
                var iB = edge.contact.getChildIndexB();
                if (fA == fixtureA && iA == indexA && fB == fixtureB && iB == indexB) {
                    return;
                }
                if (fA == fixtureB && iA == indexB && fB == fixtureA && iB == indexA) {
                    return;
                }
            }
            edge = edge.next;
        }
        if (bodyB.shouldCollide(bodyA) == false) {
            return;
        }
        if (this.m_contactFilter != null && this.m_contactFilter.shouldCollide(fixtureA, fixtureB) == false) {
            return;
        }
        var c = this.pool.popContact(fixtureA, indexA, fixtureB, indexB);
        if (c == null) {
            return;
        }
        fixtureA = c.getFixtureA();
        fixtureB = c.getFixtureB();
        indexA = c.getChildIndexA();
        indexB = c.getChildIndexB();
        bodyA = fixtureA.getBody();
        bodyB = fixtureB.getBody();
        c.m_prev = null;
        c.m_next = this.m_contactList;
        if (this.m_contactList != null) {
            this.m_contactList.m_prev = c;
        }
        this.m_contactList = c;
        c.m_nodeA.contact = c;
        c.m_nodeA.other = bodyB;
        c.m_nodeA.prev = null;
        c.m_nodeA.next = bodyA.m_contactList;
        if (bodyA.m_contactList != null) {
            bodyA.m_contactList.prev = c.m_nodeA;
        }
        bodyA.m_contactList = c.m_nodeA;
        c.m_nodeB.contact = c;
        c.m_nodeB.other = bodyA;
        c.m_nodeB.prev = null;
        c.m_nodeB.next = bodyB.m_contactList;
        if (bodyB.m_contactList != null) {
            bodyB.m_contactList.prev = c.m_nodeB;
        }
        bodyB.m_contactList = c.m_nodeB;
        if (!fixtureA.isSensor() && !fixtureB.isSensor()) {
            bodyA.setAwake(true);
            bodyB.setAwake(true);
        }
        ++this.m_contactCount;
    };
    ContactManager.prototype.findNewContacts = function () {
        this.m_broadPhase.updatePairs(this);
    };
    ContactManager.prototype.destroy = function (c) {
        var fixtureA = c.getFixtureA();
        var fixtureB = c.getFixtureB();
        var bodyA = fixtureA.getBody();
        var bodyB = fixtureB.getBody();
        if (this.m_contactListener != null && c.isTouching()) {
            this.m_contactListener.endContact(c);
        }
        if (c.m_prev != null) {
            c.m_prev.m_next = c.m_next;
        }
        if (c.m_next != null) {
            c.m_next.m_prev = c.m_prev;
        }
        if (c == this.m_contactList) {
            this.m_contactList = c.m_next;
        }
        if (c.m_nodeA.prev != null) {
            c.m_nodeA.prev.next = c.m_nodeA.next;
        }
        if (c.m_nodeA.next != null) {
            c.m_nodeA.next.prev = c.m_nodeA.prev;
        }
        if (c.m_nodeA == bodyA.m_contactList) {
            bodyA.m_contactList = c.m_nodeA.next;
        }
        if (c.m_nodeB.prev != null) {
            c.m_nodeB.prev.next = c.m_nodeB.next;
        }
        if (c.m_nodeB.next != null) {
            c.m_nodeB.next.prev = c.m_nodeB.prev;
        }
        if (c.m_nodeB == bodyB.m_contactList) {
            bodyB.m_contactList = c.m_nodeB.next;
        }
        this.pool.pushContact(c);
        --this.m_contactCount;
    };
    ContactManager.prototype.collide = function () {
        var c = this.m_contactList;
        while (c != null) {
            var fixtureA = c.getFixtureA();
            var fixtureB = c.getFixtureB();
            var indexA = c.getChildIndexA();
            var indexB = c.getChildIndexB();
            var bodyA = fixtureA.getBody();
            var bodyB = fixtureB.getBody();
            if ((c.m_flags & Contact.FILTER_FLAG) == Contact.FILTER_FLAG) {
                if (bodyB.shouldCollide(bodyA) == false) {
                    var cNuke = c;
                    c = cNuke.getNext();
                    this.destroy(cNuke);
                    continue;
                }
                if (this.m_contactFilter != null && this.m_contactFilter.shouldCollide(fixtureA, fixtureB) == false) {
                    var cNuke = c;
                    c = cNuke.getNext();
                    this.destroy(cNuke);
                    continue;
                }
                c.m_flags &= ~Contact.FILTER_FLAG;
            }
            var activeA = bodyA.isAwake() && bodyA.m_type != BodyType.STATIC;
            var activeB = bodyB.isAwake() && bodyB.m_type != BodyType.STATIC;
            if (activeA == false && activeB == false) {
                c = c.getNext();
                continue;
            }
            var proxyIdA = fixtureA.m_proxies[indexA].proxyId;
            var proxyIdB = fixtureB.m_proxies[indexB].proxyId;
            var overlap = this.m_broadPhase.testOverlap(proxyIdA, proxyIdB);
            if (overlap == false) {
                var cNuke = c;
                c = cNuke.getNext();
                this.destroy(cNuke);
                continue;
            }
            c.update(this.m_contactListener);
            c = c.getNext();
        }
    };
    return ContactManager;
}(PairCallback));
var Filter = (function () {
    function Filter() {
        this.categoryBits = 0x0001;
        this.maskBits = 0xFFFF;
        this.groupIndex = 0;
    }
    Filter.prototype.set = function (argOther) {
        this.categoryBits = argOther.categoryBits;
        this.maskBits = argOther.maskBits;
        this.groupIndex = argOther.groupIndex;
    };
    return Filter;
}());
var Fixture = (function () {
    function Fixture() {
        this.m_density = 0;
        this.m_next = null;
        this.m_body = null;
        this.m_shape = null;
        this.m_friction = 0;
        this.m_restitution = 0;
        this.m_proxies = null;
        this.m_proxyCount = 0;
        this.m_filter = null;
        this.m_isSensor = false;
        this.m_userData = null;
        this.pool1 = new AABB();
        this.pool2 = new AABB();
        this.displacement = new Vec2();
        this.m_userData = null;
        this.m_body = null;
        this.m_next = null;
        this.m_proxies = null;
        this.m_proxyCount = 0;
        this.m_shape = null;
        this.m_filter = new Filter();
    }
    Fixture.prototype.getType = function () {
        return this.m_shape.getType();
    };
    Fixture.prototype.getShape = function () {
        return this.m_shape;
    };
    Fixture.prototype.isSensor = function () {
        return this.m_isSensor;
    };
    Fixture.prototype.setSensor = function (sensor) {
        if (sensor != this.m_isSensor) {
            this.m_body.setAwake(true);
            this.m_isSensor = sensor;
        }
    };
    Fixture.prototype.setFilterData = function (filter) {
        this.m_filter.set(filter);
        this.refilter();
    };
    Fixture.prototype.getFilterData = function () {
        return this.m_filter;
    };
    Fixture.prototype.refilter = function () {
        if (this.m_body == null) {
            return;
        }
        var edge = this.m_body.getContactList();
        while (edge != null) {
            var contact = edge.contact;
            var fixtureA = contact.getFixtureA();
            var fixtureB = contact.getFixtureB();
            if (fixtureA == this || fixtureB == this) {
                contact.flagForFiltering();
            }
            edge = edge.next;
        }
        var world = this.m_body.getWorld();
        if (world == null) {
            return;
        }
        var broadPhase = world.m_contactManager.m_broadPhase;
        for (var i = 0; i < this.m_proxyCount; ++i) {
            broadPhase.touchProxy(this.m_proxies[i].proxyId);
        }
    };
    Fixture.prototype.getBody = function () {
        return this.m_body;
    };
    Fixture.prototype.getNext = function () {
        return this.m_next;
    };
    Fixture.prototype.setDensity = function (density) {
        this.m_density = density;
    };
    Fixture.prototype.getDensity = function () {
        return this.m_density;
    };
    Fixture.prototype.getUserData = function () {
        return this.m_userData;
    };
    Fixture.prototype.setUserData = function (data) {
        this.m_userData = data;
    };
    Fixture.prototype.testPoint = function (p) {
        return this.m_shape.testPoint(this.m_body.m_xf, p);
    };
    Fixture.prototype.raycast = function (output, input, childIndex) {
        return this.m_shape.raycast(output, input, this.m_body.m_xf, childIndex);
    };
    Fixture.prototype.getMassData = function (massData) {
        this.m_shape.computeMass(massData, this.m_density);
    };
    Fixture.prototype.getFriction = function () {
        return this.m_friction;
    };
    Fixture.prototype.setFriction = function (friction) {
        this.m_friction = friction;
    };
    Fixture.prototype.getRestitution = function () {
        return this.m_restitution;
    };
    Fixture.prototype.setRestitution = function (restitution) {
        this.m_restitution = restitution;
    };
    Fixture.prototype.getAABB = function (childIndex) {
        return this.m_proxies[childIndex].aabb;
    };
    Fixture.prototype.computeDistance = function (p, childIndex, normalOut) {
        return this.m_shape.computeDistanceToOut(this.m_body.getTransform(), p, childIndex, normalOut);
    };
    Fixture.prototype.create = function (body, def) {
        this.m_userData = def.userData;
        this.m_friction = def.friction;
        this.m_restitution = def.restitution;
        this.m_body = body;
        this.m_next = null;
        this.m_filter.set(def.filter);
        this.m_isSensor = def.isSensor;
        this.m_shape = def.shape.clone();
        var childCount = this.m_shape.getChildCount();
        if (this.m_proxies == null) {
            this.m_proxies = new Array(childCount);
            for (var i = 0; i < childCount; i++) {
                this.m_proxies[i] = new FixtureProxy();
                this.m_proxies[i].fixture = null;
                this.m_proxies[i].proxyId = Settings.NULL_PROXY;
            }
        }
        if (this.m_proxies.length < childCount) {
            var old = this.m_proxies;
            var newLen = dMath.Max(old.length * 2, childCount);
            this.m_proxies = new Array(newLen);
            MathUtils.arraycopy(old, this.m_proxies);
            for (var i = 0; i < newLen; i++) {
                if (i >= old.length) {
                    this.m_proxies[i] = new FixtureProxy();
                }
                this.m_proxies[i].fixture = null;
                this.m_proxies[i].proxyId = Settings.NULL_PROXY;
            }
        }
        this.m_proxyCount = 0;
        this.m_density = def.density;
    };
    Fixture.prototype.destroy = function () {
        this.m_shape = null;
        this.m_proxies = null;
        this.m_next = null;
    };
    Fixture.prototype.createProxies = function (broadPhase, xf) {
        this.m_proxyCount = this.m_shape.getChildCount();
        for (var i = 0; i < this.m_proxyCount; ++i) {
            var proxy = this.m_proxies[i];
            this.m_shape.computeAABB(proxy.aabb, xf, i);
            proxy.proxyId = broadPhase.createProxy(proxy.aabb, proxy);
            proxy.fixture = this;
            proxy.childIndex = i;
        }
    };
    Fixture.prototype.destroyProxies = function (broadPhase) {
        for (var i = 0; i < this.m_proxyCount; ++i) {
            var proxy = this.m_proxies[i];
            broadPhase.destroyProxy(proxy.proxyId);
            proxy.proxyId = Settings.NULL_PROXY;
        }
        this.m_proxyCount = 0;
    };
    Fixture.prototype.synchronize = function (broadPhase, transform1, transform2) {
        if (this.m_proxyCount == 0) {
            return;
        }
        for (var i = 0; i < this.m_proxyCount; ++i) {
            var proxy = this.m_proxies[i];
            var aabb1 = this.pool1;
            var aab = this.pool2;
            this.m_shape.computeAABB(aabb1, transform1, proxy.childIndex);
            this.m_shape.computeAABB(aab, transform2, proxy.childIndex);
            proxy.aabb.lowerBound.x =
                aabb1.lowerBound.x < aab.lowerBound.x ? aabb1.lowerBound.x : aab.lowerBound.x;
            proxy.aabb.lowerBound.y =
                aabb1.lowerBound.y < aab.lowerBound.y ? aabb1.lowerBound.y : aab.lowerBound.y;
            proxy.aabb.upperBound.x =
                aabb1.upperBound.x > aab.upperBound.x ? aabb1.upperBound.x : aab.upperBound.x;
            proxy.aabb.upperBound.y =
                aabb1.upperBound.y > aab.upperBound.y ? aabb1.upperBound.y : aab.upperBound.y;
            this.displacement.x = transform2.p.x - transform1.p.x;
            this.displacement.y = transform2.p.y - transform1.p.y;
            broadPhase.moveProxy(proxy.proxyId, proxy.aabb, this.displacement);
        }
    };
    return Fixture;
}());
var FixtureDef = (function () {
    function FixtureDef() {
        this.shape = null;
        this.shape = null;
        this.userData = null;
        this.friction = 0.2;
        this.restitution = 0;
        this.density = 0;
        this.filter = new Filter();
        this.isSensor = false;
    }
    return FixtureDef;
}());
var FixtureProxy = (function () {
    function FixtureProxy() {
        this.aabb = new AABB();
        this.fixture = null;
        this.childIndex = 0;
        this.proxyId = 0;
    }
    return FixtureProxy;
}());
var Island = (function () {
    function Island() {
        this.m_listener = null;
        this.m_bodies = null;
        this.m_contacts = null;
        this.m_joints = null;
        this.m_positions = null;
        this.m_velocities = null;
        this.m_bodyCount = 0;
        this.m_jointCount = 0;
        this.m_contactCount = 0;
        this.m_bodyCapacity = 0;
        this.m_contactCapacity = 0;
        this.m_jointCapacity = 0;
        this.contactSolver = new ContactSolver();
        this.solverData = new SolverData();
        this.solverDef = new ContactSolverDef();
        this.toiContactSolver = new ContactSolver();
        this.toiSolverDef = new ContactSolverDef();
        this.impulse = new ContactImpulse();
    }
    Island.prototype.init = function (bodyCapacity, contactCapacity, jointCapacity, listener) {
        this.m_bodyCapacity = bodyCapacity;
        this.m_contactCapacity = contactCapacity;
        this.m_jointCapacity = jointCapacity;
        this.m_bodyCount = 0;
        this.m_contactCount = 0;
        this.m_jointCount = 0;
        this.m_listener = listener;
        if (this.m_bodies == null || this.m_bodyCapacity > this.m_bodies.length) {
            this.m_bodies = new Array(this.m_bodyCapacity);
        }
        if (this.m_joints == null || this.m_jointCapacity > this.m_joints.length) {
            this.m_joints = new Array(this.m_jointCapacity);
        }
        if (this.m_contacts == null || this.m_contactCapacity > this.m_contacts.length) {
            this.m_contacts = new Array(this.m_contactCapacity);
        }
        if (this.m_velocities == null || this.m_bodyCapacity > this.m_velocities.length) {
            var old = this.m_velocities == null ? new Array(0) : this.m_velocities;
            this.m_velocities = new Array(this.m_bodyCapacity);
            MathUtils.arraycopy(old, this.m_velocities);
            for (var i = old.length; i < this.m_velocities.length; i++) {
                this.m_velocities[i] = new Velocity();
            }
        }
        if (this.m_positions == null || this.m_bodyCapacity > this.m_positions.length) {
            var old2 = this.m_positions == null ? new Array(0) : this.m_positions;
            this.m_positions = new Array(this.m_bodyCapacity);
            MathUtils.arraycopy(old2, this.m_positions);
            for (var i = old2.length; i < this.m_positions.length; i++) {
                this.m_positions[i] = new Position();
            }
        }
    };
    Island.prototype.clear = function () {
        this.m_bodyCount = 0;
        this.m_contactCount = 0;
        this.m_jointCount = 0;
    };
    Island.prototype.solve = function (step, gravity, allowSleep) {
        var h = step.dt;
        for (var i = 0; i < this.m_bodyCount; ++i) {
            var b = this.m_bodies[i];
            var bm_sweep = b.m_sweep;
            var c = bm_sweep.c;
            var a = bm_sweep.a;
            var v = b.m_linearVelocity;
            var w = b.m_angularVelocity;
            bm_sweep.c0.set(bm_sweep.c);
            bm_sweep.a0 = bm_sweep.a;
            if (b.m_type == BodyType.DYNAMIC) {
                v.x += h * (b.m_gravityScale * gravity.x + b.m_invMass * b.m_force.x);
                v.y += h * (b.m_gravityScale * gravity.y + b.m_invMass * b.m_force.y);
                w += h * b.m_invI * b.m_torque;
                v.x *= 1.0 / (1.0 + h * b.m_linearDamping);
                v.y *= 1.0 / (1.0 + h * b.m_linearDamping);
                w *= 1.0 / (1.0 + h * b.m_angularDamping);
            }
            this.m_positions[i].c.x = c.x;
            this.m_positions[i].c.y = c.y;
            this.m_positions[i].a = a;
            this.m_velocities[i].v.x = v.x;
            this.m_velocities[i].v.y = v.y;
            this.m_velocities[i].w = w;
        }
        this.solverData.step = step;
        this.solverData.positions = this.m_positions;
        this.solverData.velocities = this.m_velocities;
        this.solverDef.step = step;
        this.solverDef.contacts = this.m_contacts;
        this.solverDef.count = this.m_contactCount;
        this.solverDef.positions = this.m_positions;
        this.solverDef.velocities = this.m_velocities;
        this.contactSolver.init(this.solverDef);
        this.contactSolver.initializeVelocityConstraints();
        if (step.warmStarting) {
            this.contactSolver.warmStart();
        }
        for (var i = 0; i < this.m_jointCount; ++i) {
            this.m_joints[i].initVelocityConstraints(this.solverData);
        }
        for (var i = 0; i < step.velocityIterations; ++i) {
            for (var j = 0; j < this.m_jointCount; ++j) {
                this.m_joints[j].solveVelocityConstraints(this.solverData);
            }
            this.contactSolver.solveVelocityConstraints();
        }
        this.contactSolver.storeImpulses();
        for (var i = 0; i < this.m_bodyCount; ++i) {
            var c = this.m_positions[i].c;
            var a = this.m_positions[i].a;
            var v = this.m_velocities[i].v;
            var w = this.m_velocities[i].w;
            var translationx = v.x * h;
            var translationy = v.y * h;
            if (translationx * translationx + translationy * translationy > Settings.maxTranslationSquared) {
                var ratio = Settings.maxTranslation
                    / MathUtils.sqrt(translationx * translationx + translationy * translationy);
                v.x *= ratio;
                v.y *= ratio;
            }
            var rotation = h * w;
            if (rotation * rotation > Settings.maxRotationSquared) {
                var ratio = Settings.maxRotation / dMath.Abs(rotation);
                w *= ratio;
            }
            c.x += h * v.x;
            c.y += h * v.y;
            a += h * w;
            this.m_positions[i].a = a;
            this.m_velocities[i].w = w;
        }
        var positionSolved = false;
        for (var i = 0; i < step.positionIterations; ++i) {
            var contactsOkay = this.contactSolver.solvePositionConstraints();
            var jointsOkay = true;
            for (var j = 0; j < this.m_jointCount; ++j) {
                var jointOkay = this.m_joints[j].solvePositionConstraints(this.solverData);
                jointsOkay = jointsOkay && jointOkay;
            }
            if (contactsOkay && jointsOkay) {
                positionSolved = true;
                break;
            }
        }
        for (var i = 0; i < this.m_bodyCount; ++i) {
            var body = this.m_bodies[i];
            body.m_sweep.c.x = this.m_positions[i].c.x;
            body.m_sweep.c.y = this.m_positions[i].c.y;
            body.m_sweep.a = this.m_positions[i].a;
            body.m_linearVelocity.x = this.m_velocities[i].v.x;
            body.m_linearVelocity.y = this.m_velocities[i].v.y;
            body.m_angularVelocity = this.m_velocities[i].w;
            body.synchronizeTransform();
        }
        this.report(this.contactSolver.m_velocityConstraints);
        if (allowSleep) {
            var minSleepTime = dMath.dFLOAT_MAX;
            var linTolSqr = Settings.linearSleepTolerance * Settings.linearSleepTolerance;
            var angTolSqr = Settings.angularSleepTolerance * Settings.angularSleepTolerance;
            for (var i = 0; i < this.m_bodyCount; ++i) {
                var b = this.m_bodies[i];
                if (b.getType() == BodyType.STATIC) {
                    continue;
                }
                if ((b.m_flags & BoxBody.e_autoSleepFlag) == 0
                    || b.m_angularVelocity * b.m_angularVelocity > angTolSqr
                    || Vec2.dot(b.m_linearVelocity, b.m_linearVelocity) > linTolSqr) {
                    b.m_sleepTime = 0.0;
                    minSleepTime = 0.0;
                }
                else {
                    b.m_sleepTime += h;
                    minSleepTime = dMath.Min(minSleepTime, b.m_sleepTime);
                }
            }
            if (minSleepTime >= Settings.timeToSleep && positionSolved) {
                for (var i = 0; i < this.m_bodyCount; ++i) {
                    var b = this.m_bodies[i];
                    b.setAwake(false);
                }
            }
        }
    };
    Island.prototype.solveTOI = function (subStep, toiIndexA, toiIndexB) {
        for (var i = 0; i < this.m_bodyCount; ++i) {
            this.m_positions[i].c.x = this.m_bodies[i].m_sweep.c.x;
            this.m_positions[i].c.y = this.m_bodies[i].m_sweep.c.y;
            this.m_positions[i].a = this.m_bodies[i].m_sweep.a;
            this.m_velocities[i].v.x = this.m_bodies[i].m_linearVelocity.x;
            this.m_velocities[i].v.y = this.m_bodies[i].m_linearVelocity.y;
            this.m_velocities[i].w = this.m_bodies[i].m_angularVelocity;
        }
        this.toiSolverDef.contacts = this.m_contacts;
        this.toiSolverDef.count = this.m_contactCount;
        this.toiSolverDef.step = subStep;
        this.toiSolverDef.positions = this.m_positions;
        this.toiSolverDef.velocities = this.m_velocities;
        this.toiContactSolver.init(this.toiSolverDef);
        for (var i = 0; i < subStep.positionIterations; ++i) {
            var contactsOkay = this.toiContactSolver.solveTOIPositionConstraints(toiIndexA, toiIndexB);
            if (contactsOkay) {
                break;
            }
        }
        this.m_bodies[toiIndexA].m_sweep.c0.x = this.m_positions[toiIndexA].c.x;
        this.m_bodies[toiIndexA].m_sweep.c0.y = this.m_positions[toiIndexA].c.y;
        this.m_bodies[toiIndexA].m_sweep.a0 = this.m_positions[toiIndexA].a;
        this.m_bodies[toiIndexB].m_sweep.c0.set(this.m_positions[toiIndexB].c);
        this.m_bodies[toiIndexB].m_sweep.a0 = this.m_positions[toiIndexB].a;
        this.toiContactSolver.initializeVelocityConstraints();
        for (var i = 0; i < subStep.velocityIterations; ++i) {
            this.toiContactSolver.solveVelocityConstraints();
        }
        var h = subStep.dt;
        for (var i = 0; i < this.m_bodyCount; ++i) {
            var c = this.m_positions[i].c;
            var a = this.m_positions[i].a;
            var v = this.m_velocities[i].v;
            var w = this.m_velocities[i].w;
            var translationx = v.x * h;
            var translationy = v.y * h;
            if (translationx * translationx + translationy * translationy > Settings.maxTranslationSquared) {
                var ratio = Settings.maxTranslation
                    / MathUtils.sqrt(translationx * translationx + translationy * translationy);
                v.mulLocal(ratio);
            }
            var rotation = h * w;
            if (rotation * rotation > Settings.maxRotationSquared) {
                var ratio = Settings.maxRotation / dMath.Abs(rotation);
                w *= ratio;
            }
            c.x += v.x * h;
            c.y += v.y * h;
            a += h * w;
            this.m_positions[i].c.x = c.x;
            this.m_positions[i].c.y = c.y;
            this.m_positions[i].a = a;
            this.m_velocities[i].v.x = v.x;
            this.m_velocities[i].v.y = v.y;
            this.m_velocities[i].w = w;
            var body = this.m_bodies[i];
            body.m_sweep.c.x = c.x;
            body.m_sweep.c.y = c.y;
            body.m_sweep.a = a;
            body.m_linearVelocity.x = v.x;
            body.m_linearVelocity.y = v.y;
            body.m_angularVelocity = w;
            body.synchronizeTransform();
        }
        this.report(this.toiContactSolver.m_velocityConstraints);
    };
    Island.prototype.addBody = function (body) {
        body.m_islandIndex = this.m_bodyCount;
        this.m_bodies[this.m_bodyCount] = body;
        ++this.m_bodyCount;
    };
    Island.prototype.addContact = function (contact) {
        this.m_contacts[this.m_contactCount++] = contact;
    };
    Island.prototype.addJoint = function (joint) {
        this.m_joints[this.m_jointCount++] = joint;
    };
    Island.prototype.report = function (constraints) {
        if (this.m_listener == null) {
            return;
        }
        for (var i = 0; i < this.m_contactCount; ++i) {
            var c = this.m_contacts[i];
            var vc = constraints[i];
            this.impulse.count = vc.pointCount;
            for (var j = 0; j < vc.pointCount; ++j) {
                this.impulse.normalImpulses[j] = vc.points[j].normalImpulse;
                this.impulse.tangentImpulses[j] = vc.points[j].tangentImpulse;
            }
            this.m_listener.postSolve(c, this.impulse);
        }
    };
    return Island;
}());
var SolverData = (function () {
    function SolverData() {
        this.step = null;
        this.positions = null;
        this.velocities = null;
    }
    return SolverData;
}());
var TimeStep = (function () {
    function TimeStep() {
        this.dt = 0;
        this.inv_dt = 0;
        this.dtRatio = 0;
        this.velocityIterations = 0;
        this.positionIterations = 0;
        this.warmStarting = false;
    }
    return TimeStep;
}());
var Contact = (function () {
    function Contact(argPool) {
        this.m_flags = 0;
        this.m_prev = null;
        this.m_next = null;
        this.m_nodeA = null;
        this.m_nodeB = null;
        this.m_fixtureA = null;
        this.m_fixtureB = null;
        this.m_indexA = 0;
        this.m_indexB = 0;
        this.m_manifold = null;
        this.m_toiCount = 0;
        this.m_toi = 0;
        this.m_friction = 0;
        this.m_restitution = 0;
        this.m_tangentSpeed = 0;
        this.pool = null;
        this.oldManifold = new Manifold();
        this.m_fixtureA = null;
        this.m_fixtureB = null;
        this.m_nodeA = new ContactEdge();
        this.m_nodeB = new ContactEdge();
        this.m_manifold = new Manifold();
        this.pool = argPool;
    }
    Contact.prototype.init = function (fA, indexA, fB, indexB) {
        this.m_flags = Contact.ENABLED_FLAG;
        this.m_fixtureA = fA;
        this.m_fixtureB = fB;
        this.m_indexA = indexA;
        this.m_indexB = indexB;
        this.m_manifold.pointCount = 0;
        this.m_prev = null;
        this.m_next = null;
        this.m_nodeA.contact = null;
        this.m_nodeA.prev = null;
        this.m_nodeA.next = null;
        this.m_nodeA.other = null;
        this.m_nodeB.contact = null;
        this.m_nodeB.prev = null;
        this.m_nodeB.next = null;
        this.m_nodeB.other = null;
        this.m_toiCount = 0;
        this.m_friction = Contact.mixFriction(fA.m_friction, fB.m_friction);
        this.m_restitution = Contact.mixRestitution(fA.m_restitution, fB.m_restitution);
        this.m_tangentSpeed = 0;
    };
    Contact.prototype.getManifold = function () {
        return this.m_manifold;
    };
    Contact.prototype.getWorldManifold = function (worldManifold) {
        var bodyA = this.m_fixtureA.getBody();
        var bodyB = this.m_fixtureB.getBody();
        var shapeA = this.m_fixtureA.getShape();
        var shapeB = this.m_fixtureB.getShape();
        worldManifold.initialize(this.m_manifold, bodyA.getTransform(), shapeA.m_radius, bodyB.getTransform(), shapeB.m_radius);
    };
    Contact.prototype.isTouching = function () {
        return (this.m_flags & Contact.TOUCHING_FLAG) == Contact.TOUCHING_FLAG;
    };
    Contact.prototype.setEnabled = function (flag) {
        if (flag) {
            this.m_flags |= Contact.ENABLED_FLAG;
        }
        else {
            this.m_flags &= ~Contact.ENABLED_FLAG;
        }
    };
    Contact.prototype.isEnabled = function () {
        return (this.m_flags & Contact.ENABLED_FLAG) == Contact.ENABLED_FLAG;
    };
    Contact.prototype.getNext = function () {
        return this.m_next;
    };
    Contact.prototype.getFixtureA = function () {
        return this.m_fixtureA;
    };
    Contact.prototype.getChildIndexA = function () {
        return this.m_indexA;
    };
    Contact.prototype.getFixtureB = function () {
        return this.m_fixtureB;
    };
    Contact.prototype.getChildIndexB = function () {
        return this.m_indexB;
    };
    Contact.prototype.setFriction = function (friction) {
        this.m_friction = friction;
    };
    Contact.prototype.getFriction = function () {
        return this.m_friction;
    };
    Contact.prototype.resetFriction = function () {
        this.m_friction = Contact.mixFriction(this.m_fixtureA.m_friction, this.m_fixtureB.m_friction);
    };
    Contact.prototype.setRestitution = function (restitution) {
        this.m_restitution = restitution;
    };
    Contact.prototype.getRestitution = function () {
        return this.m_restitution;
    };
    Contact.prototype.resetRestitution = function () {
        this.m_restitution = Contact.mixRestitution(this.m_fixtureA.m_restitution, this.m_fixtureB.m_restitution);
    };
    Contact.prototype.setTangentSpeed = function (speed) {
        this.m_tangentSpeed = speed;
    };
    Contact.prototype.getTangentSpeed = function () {
        return this.m_tangentSpeed;
    };
    Contact.prototype.evaluate = function (manifold, xfA, xfB) {
    };
    Contact.prototype.flagForFiltering = function () {
        this.m_flags |= Contact.FILTER_FLAG;
    };
    Contact.prototype.update = function (listener) {
        this.oldManifold.set(this.m_manifold);
        this.m_flags |= Contact.ENABLED_FLAG;
        var touching = false;
        var wasTouching = (this.m_flags & Contact.TOUCHING_FLAG) == Contact.TOUCHING_FLAG;
        var sensorA = this.m_fixtureA.isSensor();
        var sensorB = this.m_fixtureB.isSensor();
        var sensor = sensorA || sensorB;
        var bodyA = this.m_fixtureA.getBody();
        var bodyB = this.m_fixtureB.getBody();
        var xfA = bodyA.getTransform();
        var xfB = bodyB.getTransform();
        if (sensor) {
            var shapeA = this.m_fixtureA.getShape();
            var shapeB = this.m_fixtureB.getShape();
            touching = this.pool.getCollision().testOverlap(shapeA, this.m_indexA, shapeB, this.m_indexB, xfA, xfB);
            this.m_manifold.pointCount = 0;
        }
        else {
            this.evaluate(this.m_manifold, xfA, xfB);
            touching = this.m_manifold.pointCount > 0;
            for (var i = 0; i < this.m_manifold.pointCount; ++i) {
                var mp2 = this.m_manifold.points[i];
                mp2.normalImpulse = 0.0;
                mp2.tangentImpulse = 0.0;
                var id2 = mp2.id;
                for (var j = 0; j < this.oldManifold.pointCount; ++j) {
                    var mp1 = this.oldManifold.points[j];
                    if (mp1.id.isEqual(id2)) {
                        mp2.normalImpulse = mp1.normalImpulse;
                        mp2.tangentImpulse = mp1.tangentImpulse;
                        break;
                    }
                }
            }
            if (touching != wasTouching) {
                bodyA.setAwake(true);
                bodyB.setAwake(true);
            }
        }
        if (touching) {
            this.m_flags |= Contact.TOUCHING_FLAG;
        }
        else {
            this.m_flags &= ~Contact.TOUCHING_FLAG;
        }
        if (listener == null) {
            return;
        }
        if (wasTouching == false && touching == true) {
            listener.beginContact(this);
        }
        if (wasTouching == true && touching == false) {
            listener.endContact(this);
        }
        if (sensor == false && touching) {
            listener.preSolve(this, this.oldManifold);
        }
    };
    Contact.mixFriction = function (friction1, friction2) {
        return MathUtils.sqrt(friction1 * friction2);
    };
    Contact.mixRestitution = function (restitution1, restitution2) {
        return restitution1 > restitution2 ? restitution1 : restitution2;
    };
    Contact.ISLAND_FLAG = 0x0001;
    Contact.TOUCHING_FLAG = 0x0002;
    Contact.ENABLED_FLAG = 0x0004;
    Contact.FILTER_FLAG = 0x0008;
    Contact.BULLET_HIT_FLAG = 0x0010;
    Contact.TOI_FLAG = 0x0020;
    return Contact;
}());
var ChainAndCircleContact = (function (_super) {
    __extends(ChainAndCircleContact, _super);
    function ChainAndCircleContact(argPool) {
        var _this = _super.call(this, argPool) || this;
        _this.edge = new EdgeShape();
        return _this;
    }
    ChainAndCircleContact.prototype.init = function (fA, indexA, fB, indexB) {
        _super.prototype.init.call(this, fA, indexA, fB, indexB);
    };
    ChainAndCircleContact.prototype.evaluate = function (manifold, xfA, xfB) {
        var chain = this.m_fixtureA.getShape();
        chain.getChildEdge(this.edge, this.m_indexA);
        this.pool.getCollision().collideEdgeAndCircle(manifold, this.edge, xfA, this.m_fixtureB.getShape(), xfB);
    };
    return ChainAndCircleContact;
}(Contact));
var ChainAndPolygonContact = (function (_super) {
    __extends(ChainAndPolygonContact, _super);
    function ChainAndPolygonContact(argPool) {
        var _this = _super.call(this, argPool) || this;
        _this.edge = new EdgeShape();
        return _this;
    }
    ChainAndPolygonContact.prototype.init = function (fA, indexA, fB, indexB) {
        _super.prototype.init.call(this, fA, indexA, fB, indexB);
    };
    ChainAndPolygonContact.prototype.evaluate = function (manifold, xfA, xfB) {
        var chain = this.m_fixtureA.getShape();
        chain.getChildEdge(this.edge, this.m_indexA);
        this.pool.getCollision().collideEdgeAndPolygon(manifold, this.edge, xfA, this.m_fixtureB.getShape(), xfB);
    };
    return ChainAndPolygonContact;
}(Contact));
var CircleContact = (function (_super) {
    __extends(CircleContact, _super);
    function CircleContact(argPool) {
        return _super.call(this, argPool) || this;
    }
    CircleContact.prototype.init = function (fA, indexA, fB, indexB) {
        _super.prototype.init.call(this, fA, 0, fB, 0);
    };
    CircleContact.prototype.evaluate = function (manifold, xfA, xfB) {
        this.pool.getCollision().collideCircles(manifold, this.m_fixtureA.getShape(), xfA, this.m_fixtureB.getShape(), xfB);
    };
    return CircleContact;
}(Contact));
var ContactCreator = (function () {
    function ContactCreator() {
    }
    ContactCreator.prototype.contactCreateFcn = function (argPool, fixtureA, fixtureB) {
        return null;
    };
    ContactCreator.prototype.contactDestroyFcn = function (argPool, contact) {
    };
    return ContactCreator;
}());
var ContactEdge = (function () {
    function ContactEdge() {
        this.other = null;
        this.contact = null;
        this.prev = null;
        this.next = null;
    }
    return ContactEdge;
}());
var ContactPositionConstraint = (function () {
    function ContactPositionConstraint() {
        this.localPoints = new Array(Settings.maxManifoldPoints);
        this.localNormal = new Vec2();
        this.localPoint = new Vec2();
        this.indexA = 0;
        this.indexB = 0;
        this.invMassA = 0;
        this.invMassB = 0;
        this.localCenterA = new Vec2();
        this.localCenterB = new Vec2();
        this.invIA = 0;
        this.invIB = 0;
        this.type = 0;
        this.radiusA = 0;
        this.radiusB = 0;
        this.pointCount = 0;
        for (var i = 0; i < this.localPoints.length; i++) {
            this.localPoints[i] = new Vec2();
        }
    }
    return ContactPositionConstraint;
}());
var ContactRegister = (function () {
    function ContactRegister() {
        this.creator = null;
        this.primary = false;
    }
    return ContactRegister;
}());
var ContactSolver = (function () {
    function ContactSolver() {
        this.m_step = null;
        this.m_positions = null;
        this.m_velocities = null;
        this.m_positionConstraints = null;
        this.m_velocityConstraints = null;
        this.m_contacts = null;
        this.m_count = 0;
        this.xfA = new Transform();
        this.xfB = new Transform();
        this.worldManifold = new WorldManifold();
        this.psolver = new PositionSolverManifold();
        this.m_positionConstraints = new Array(ContactSolver.INITIAL_NUM_CONSTRAINTS);
        this.m_velocityConstraints = new Array(ContactSolver.INITIAL_NUM_CONSTRAINTS);
        for (var i = 0; i < ContactSolver.INITIAL_NUM_CONSTRAINTS; i++) {
            this.m_positionConstraints[i] = new ContactPositionConstraint();
            this.m_velocityConstraints[i] = new ContactVelocityConstraint();
        }
    }
    ContactSolver.prototype.init = function (def) {
        this.m_step = def.step;
        this.m_count = def.count;
        if (this.m_positionConstraints.length < this.m_count) {
            var old = this.m_positionConstraints;
            this.m_positionConstraints = new Array(dMath.Max(old.length * 2, this.m_count));
            MathUtils.arraycopy(old, this.m_positionConstraints);
            for (var i = old.length; i < this.m_positionConstraints.length; i++) {
                this.m_positionConstraints[i] = new ContactPositionConstraint();
            }
        }
        if (this.m_velocityConstraints.length < this.m_count) {
            var old2 = this.m_velocityConstraints;
            this.m_velocityConstraints = new Array(dMath.Max(old2.length * 2, this.m_count));
            MathUtils.arraycopy(old2, this.m_velocityConstraints);
            for (var i = old2.length; i < this.m_velocityConstraints.length; i++) {
                this.m_velocityConstraints[i] = new ContactVelocityConstraint();
            }
        }
        this.m_positions = def.positions;
        this.m_velocities = def.velocities;
        this.m_contacts = def.contacts;
        for (var i = 0; i < this.m_count; ++i) {
            var contact = this.m_contacts[i];
            var fixtureA = contact.m_fixtureA;
            var fixtureB = contact.m_fixtureB;
            var shapeA = fixtureA.getShape();
            var shapeB = fixtureB.getShape();
            var radiusA = shapeA.m_radius;
            var radiusB = shapeB.m_radius;
            var bodyA = fixtureA.getBody();
            var bodyB = fixtureB.getBody();
            var manifold = contact.getManifold();
            var pointCount = manifold.pointCount;
            var vc = this.m_velocityConstraints[i];
            vc.friction = contact.m_friction;
            vc.restitution = contact.m_restitution;
            vc.tangentSpeed = contact.m_tangentSpeed;
            vc.indexA = bodyA.m_islandIndex;
            vc.indexB = bodyB.m_islandIndex;
            vc.invMassA = bodyA.m_invMass;
            vc.invMassB = bodyB.m_invMass;
            vc.invIA = bodyA.m_invI;
            vc.invIB = bodyB.m_invI;
            vc.contactIndex = i;
            vc.pointCount = pointCount;
            vc.K.setZero();
            vc.normalMass.setZero();
            var pc = this.m_positionConstraints[i];
            pc.indexA = bodyA.m_islandIndex;
            pc.indexB = bodyB.m_islandIndex;
            pc.invMassA = bodyA.m_invMass;
            pc.invMassB = bodyB.m_invMass;
            pc.localCenterA.set(bodyA.m_sweep.localCenter);
            pc.localCenterB.set(bodyB.m_sweep.localCenter);
            pc.invIA = bodyA.m_invI;
            pc.invIB = bodyB.m_invI;
            pc.localNormal.set(manifold.localNormal);
            pc.localPoint.set(manifold.localPoint);
            pc.pointCount = pointCount;
            pc.radiusA = radiusA;
            pc.radiusB = radiusB;
            pc.type = manifold.type;
            for (var j = 0; j < pointCount; j++) {
                var cp = manifold.points[j];
                var vcp = vc.points[j];
                if (this.m_step.warmStarting) {
                    vcp.normalImpulse = this.m_step.dtRatio * cp.normalImpulse;
                    vcp.tangentImpulse = this.m_step.dtRatio * cp.tangentImpulse;
                }
                else {
                    vcp.normalImpulse = 0;
                    vcp.tangentImpulse = 0;
                }
                vcp.rA.setZero();
                vcp.rB.setZero();
                vcp.normalMass = 0;
                vcp.tangentMass = 0;
                vcp.velocityBias = 0;
                pc.localPoints[j].x = cp.localPoint.x;
                pc.localPoints[j].y = cp.localPoint.y;
            }
        }
    };
    ContactSolver.prototype.warmStart = function () {
        for (var i = 0; i < this.m_count; ++i) {
            var vc = this.m_velocityConstraints[i];
            var indexA = vc.indexA;
            var indexB = vc.indexB;
            var mA = vc.invMassA;
            var iA = vc.invIA;
            var mB = vc.invMassB;
            var iB = vc.invIB;
            var pointCount = vc.pointCount;
            var vA = this.m_velocities[indexA].v;
            var wA = this.m_velocities[indexA].w;
            var vB = this.m_velocities[indexB].v;
            var wB = this.m_velocities[indexB].w;
            var normal = vc.normal;
            var tangentx = 1.0 * normal.y;
            var tangenty = -1.0 * normal.x;
            for (var j = 0; j < pointCount; ++j) {
                var vcp = vc.points[j];
                var Px = tangentx * vcp.tangentImpulse + normal.x * vcp.normalImpulse;
                var Py = tangenty * vcp.tangentImpulse + normal.y * vcp.normalImpulse;
                wA -= iA * (vcp.rA.x * Py - vcp.rA.y * Px);
                vA.x -= Px * mA;
                vA.y -= Py * mA;
                wB += iB * (vcp.rB.x * Py - vcp.rB.y * Px);
                vB.x += Px * mB;
                vB.y += Py * mB;
            }
            this.m_velocities[indexA].w = wA;
            this.m_velocities[indexB].w = wB;
        }
    };
    ContactSolver.prototype.initializeVelocityConstraints = function () {
        for (var i = 0; i < this.m_count; ++i) {
            var vc = this.m_velocityConstraints[i];
            var pc = this.m_positionConstraints[i];
            var radiusA = pc.radiusA;
            var radiusB = pc.radiusB;
            var manifold = this.m_contacts[vc.contactIndex].getManifold();
            var indexA = vc.indexA;
            var indexB = vc.indexB;
            var mA = vc.invMassA;
            var mB = vc.invMassB;
            var iA = vc.invIA;
            var iB = vc.invIB;
            var localCenterA = pc.localCenterA;
            var localCenterB = pc.localCenterB;
            var cA = this.m_positions[indexA].c;
            var aA = this.m_positions[indexA].a;
            var vA = this.m_velocities[indexA].v;
            var wA = this.m_velocities[indexA].w;
            var cB = this.m_positions[indexB].c;
            var aB = this.m_positions[indexB].a;
            var vB = this.m_velocities[indexB].v;
            var wB = this.m_velocities[indexB].w;
            var xfAq = this.xfA.q;
            var xfBq = this.xfB.q;
            xfAq.setValue(aA);
            xfBq.setValue(aB);
            this.xfA.p.x = cA.x - (xfAq.c * localCenterA.x - xfAq.s * localCenterA.y);
            this.xfA.p.y = cA.y - (xfAq.s * localCenterA.x + xfAq.c * localCenterA.y);
            this.xfB.p.x = cB.x - (xfBq.c * localCenterB.x - xfBq.s * localCenterB.y);
            this.xfB.p.y = cB.y - (xfBq.s * localCenterB.x + xfBq.c * localCenterB.y);
            this.worldManifold.initialize(manifold, this.xfA, radiusA, this.xfB, radiusB);
            var vcnormal = vc.normal;
            vcnormal.x = this.worldManifold.normal.x;
            vcnormal.y = this.worldManifold.normal.y;
            var pointCount = vc.pointCount;
            for (var j = 0; j < pointCount; ++j) {
                var vcp = vc.points[j];
                var wmPj = this.worldManifold.points[j];
                var vcprA = vcp.rA;
                var vcprB = vcp.rB;
                vcprA.x = wmPj.x - cA.x;
                vcprA.y = wmPj.y - cA.y;
                vcprB.x = wmPj.x - cB.x;
                vcprB.y = wmPj.y - cB.y;
                var rnA = vcprA.x * vcnormal.y - vcprA.y * vcnormal.x;
                var rnB = vcprB.x * vcnormal.y - vcprB.y * vcnormal.x;
                var kNormal = mA + mB + iA * rnA * rnA + iB * rnB * rnB;
                vcp.normalMass = kNormal > 0.0 ? 1.0 / kNormal : 0.0;
                var tangentx = 1.0 * vcnormal.y;
                var tangenty = -1.0 * vcnormal.x;
                var rtA = vcprA.x * tangenty - vcprA.y * tangentx;
                var rtB = vcprB.x * tangenty - vcprB.y * tangentx;
                var kTangent = mA + mB + iA * rtA * rtA + iB * rtB * rtB;
                vcp.tangentMass = kTangent > 0.0 ? 1.0 / kTangent : 0.0;
                vcp.velocityBias = 0.0;
                var tempx = vB.x + (-wB) * vcprB.y - vA.x - (-wA * vcprA.y);
                var tempy = vB.y + wB * vcprB.x - vA.y - (wA * vcprA.x);
                var vRel = vcnormal.x * tempx + vcnormal.y * tempy;
                if (vRel < -Settings.velocityThreshold) {
                    vcp.velocityBias = -vc.restitution * vRel;
                }
            }
            if (vc.pointCount == 2) {
                var vcp1 = vc.points[0];
                var vcp2 = vc.points[1];
                var rn1A = vcp1.rA.x * vcnormal.y - vcp1.rA.y * vcnormal.x;
                var rn1B = vcp1.rB.x * vcnormal.y - vcp1.rB.y * vcnormal.x;
                var rn2A = vcp2.rA.x * vcnormal.y - vcp2.rA.y * vcnormal.x;
                var rn2B = vcp2.rB.x * vcnormal.y - vcp2.rB.y * vcnormal.x;
                var k11 = mA + mB + iA * rn1A * rn1A + iB * rn1B * rn1B;
                var k22 = mA + mB + iA * rn2A * rn2A + iB * rn2B * rn2B;
                var k12 = mA + mB + iA * rn1A * rn2A + iB * rn1B * rn2B;
                if (k11 * k11 < ContactSolver.k_maxConditionNumber * (k11 * k22 - k12 * k12)) {
                    vc.K.ex.x = k11;
                    vc.K.ex.y = k12;
                    vc.K.ey.x = k12;
                    vc.K.ey.y = k22;
                    vc.K.invertToOut(vc.normalMass);
                }
                else {
                    vc.pointCount = 1;
                }
            }
        }
    };
    ContactSolver.prototype.solveVelocityConstraints = function () {
        for (var i = 0; i < this.m_count; ++i) {
            var vc = this.m_velocityConstraints[i];
            var indexA = vc.indexA;
            var indexB = vc.indexB;
            var mA = vc.invMassA;
            var mB = vc.invMassB;
            var iA = vc.invIA;
            var iB = vc.invIB;
            var pointCount = vc.pointCount;
            var vA = this.m_velocities[indexA].v;
            var wA = this.m_velocities[indexA].w;
            var vB = this.m_velocities[indexB].v;
            var wB = this.m_velocities[indexB].w;
            var normal = vc.normal;
            var normalx = normal.x;
            var normaly = normal.y;
            var tangentx = 1.0 * vc.normal.y;
            var tangenty = -1.0 * vc.normal.x;
            var friction = vc.friction;
            for (var j = 0; j < pointCount; ++j) {
                var vcp = vc.points[j];
                var a = vcp.rA;
                var dvx = -wB * vcp.rB.y + vB.x - vA.x + wA * a.y;
                var dvy = wB * vcp.rB.x + vB.y - vA.y - wA * a.x;
                var vt = dvx * tangentx + dvy * tangenty - vc.tangentSpeed;
                var lambda = vcp.tangentMass * (-vt);
                var maxFriction = friction * vcp.normalImpulse;
                var newImpulse = MathUtils.clamp(vcp.tangentImpulse + lambda, -maxFriction, maxFriction);
                lambda = newImpulse - vcp.tangentImpulse;
                vcp.tangentImpulse = newImpulse;
                var Px = tangentx * lambda;
                var Py = tangenty * lambda;
                vA.x -= Px * mA;
                vA.y -= Py * mA;
                wA -= iA * (vcp.rA.x * Py - vcp.rA.y * Px);
                vB.x += Px * mB;
                vB.y += Py * mB;
                wB += iB * (vcp.rB.x * Py - vcp.rB.y * Px);
            }
            if (vc.pointCount == 1) {
                var vcp = vc.points[0];
                var dvx = -wB * vcp.rB.y + vB.x - vA.x + wA * vcp.rA.y;
                var dvy = wB * vcp.rB.x + vB.y - vA.y - wA * vcp.rA.x;
                var vn = dvx * normalx + dvy * normaly;
                var lambda = -vcp.normalMass * (vn - vcp.velocityBias);
                var a2 = vcp.normalImpulse + lambda;
                var newImpulse = (a2 > 0.0 ? a2 : 0.0);
                lambda = newImpulse - vcp.normalImpulse;
                vcp.normalImpulse = newImpulse;
                var Px = normalx * lambda;
                var Py = normaly * lambda;
                vA.x -= Px * mA;
                vA.y -= Py * mA;
                wA -= iA * (vcp.rA.x * Py - vcp.rA.y * Px);
                vB.x += Px * mB;
                vB.y += Py * mB;
                wB += iB * (vcp.rB.x * Py - vcp.rB.y * Px);
            }
            else {
                var cp1 = vc.points[0];
                var cp2 = vc.points[1];
                var cp1rA = cp1.rA;
                var cp1rB = cp1.rB;
                var cp2rA = cp2.rA;
                var cp2rB = cp2.rB;
                var ax = cp1.normalImpulse;
                var ay = cp2.normalImpulse;
                var dv1x = -wB * cp1rB.y + vB.x - vA.x + wA * cp1rA.y;
                var dv1y = wB * cp1rB.x + vB.y - vA.y - wA * cp1rA.x;
                var dv2x = -wB * cp2rB.y + vB.x - vA.x + wA * cp2rA.y;
                var dv2y = wB * cp2rB.x + vB.y - vA.y - wA * cp2rA.x;
                var vn1 = dv1x * normalx + dv1y * normaly;
                var vn2 = dv2x * normalx + dv2y * normaly;
                var bx = vn1 - cp1.velocityBias;
                var by = vn2 - cp2.velocityBias;
                var R = vc.K;
                bx -= R.ex.x * ax + R.ey.x * ay;
                by -= R.ex.y * ax + R.ey.y * ay;
                for (;;) {
                    var R1 = vc.normalMass;
                    var xx = R1.ex.x * bx + R1.ey.x * by;
                    var xy = R1.ex.y * bx + R1.ey.y * by;
                    xx *= -1;
                    xy *= -1;
                    if (xx >= 0.0 && xy >= 0.0) {
                        var dx = xx - ax;
                        var dy = xy - ay;
                        var P1x = dx * normalx;
                        var P1y = dx * normaly;
                        var P2x = dy * normalx;
                        var P2y = dy * normaly;
                        vA.x -= mA * (P1x + P2x);
                        vA.y -= mA * (P1y + P2y);
                        vB.x += mB * (P1x + P2x);
                        vB.y += mB * (P1y + P2y);
                        wA -= iA * (cp1rA.x * P1y - cp1rA.y * P1x + (cp2rA.x * P2y - cp2rA.y * P2x));
                        wB += iB * (cp1rB.x * P1y - cp1rB.y * P1x + (cp2rB.x * P2y - cp2rB.y * P2x));
                        cp1.normalImpulse = xx;
                        cp2.normalImpulse = xy;
                        if (ContactSolver.DEBUG_SOLVER) {
                            var dv1 = vB.add(Vec2.crossF(wB, cp1rB).subLocal(vA).subLocal(Vec2.crossF(wA, cp1rA)));
                            var dv2 = vB.add(Vec2.crossF(wB, cp2rB).subLocal(vA).subLocal(Vec2.crossF(wA, cp2rA)));
                            vn1 = Vec2.dot(dv1, normal);
                            vn2 = Vec2.dot(dv2, normal);
                        }
                        break;
                    }
                    xx = -cp1.normalMass * bx;
                    xy = 0.0;
                    vn1 = 0.0;
                    vn2 = vc.K.ex.y * xx + by;
                    if (xx >= 0.0 && vn2 >= 0.0) {
                        var dx = xx - ax;
                        var dy = xy - ay;
                        var P1x = normalx * dx;
                        var P1y = normaly * dx;
                        var P2x = normalx * dy;
                        var P2y = normaly * dy;
                        vA.x -= mA * (P1x + P2x);
                        vA.y -= mA * (P1y + P2y);
                        vB.x += mB * (P1x + P2x);
                        vB.y += mB * (P1y + P2y);
                        wA -= iA * (cp1rA.x * P1y - cp1rA.y * P1x + (cp2rA.x * P2y - cp2rA.y * P2x));
                        wB += iB * (cp1rB.x * P1y - cp1rB.y * P1x + (cp2rB.x * P2y - cp2rB.y * P2x));
                        cp1.normalImpulse = xx;
                        cp2.normalImpulse = xy;
                        if (ContactSolver.DEBUG_SOLVER) {
                            var dv1 = vB.add(Vec2.crossF(wB, cp1rB).subLocal(vA).subLocal(Vec2.crossF(wA, cp1rA)));
                            vn1 = Vec2.dot(dv1, normal);
                        }
                        break;
                    }
                    xx = 0.0;
                    xy = -cp2.normalMass * by;
                    vn1 = vc.K.ey.x * xy + bx;
                    vn2 = 0.0;
                    if (xy >= 0.0 && vn1 >= 0.0) {
                        var dx = xx - ax;
                        var dy = xy - ay;
                        var P1x = normalx * dx;
                        var P1y = normaly * dx;
                        var P2x = normalx * dy;
                        var P2y = normaly * dy;
                        vA.x -= mA * (P1x + P2x);
                        vA.y -= mA * (P1y + P2y);
                        vB.x += mB * (P1x + P2x);
                        vB.y += mB * (P1y + P2y);
                        wA -= iA * (cp1rA.x * P1y - cp1rA.y * P1x + (cp2rA.x * P2y - cp2rA.y * P2x));
                        wB += iB * (cp1rB.x * P1y - cp1rB.y * P1x + (cp2rB.x * P2y - cp2rB.y * P2x));
                        cp1.normalImpulse = xx;
                        cp2.normalImpulse = xy;
                        if (ContactSolver.DEBUG_SOLVER) {
                            var dv2 = vB.add(Vec2.crossF(wB, cp2rB).subLocal(vA).subLocal(Vec2.crossF(wA, cp2rA)));
                            vn2 = Vec2.dot(dv2, normal);
                        }
                        break;
                    }
                    xx = 0.0;
                    xy = 0.0;
                    vn1 = bx;
                    vn2 = by;
                    if (vn1 >= 0.0 && vn2 >= 0.0) {
                        var dx = xx - ax;
                        var dy = xy - ay;
                        var P1x = normalx * dx;
                        var P1y = normaly * dx;
                        var P2x = normalx * dy;
                        var P2y = normaly * dy;
                        vA.x -= mA * (P1x + P2x);
                        vA.y -= mA * (P1y + P2y);
                        vB.x += mB * (P1x + P2x);
                        vB.y += mB * (P1y + P2y);
                        wA -= iA * (cp1rA.x * P1y - cp1rA.y * P1x + (cp2rA.x * P2y - cp2rA.y * P2x));
                        wB += iB * (cp1rB.x * P1y - cp1rB.y * P1x + (cp2rB.x * P2y - cp2rB.y * P2x));
                        cp1.normalImpulse = xx;
                        cp2.normalImpulse = xy;
                        break;
                    }
                    break;
                }
            }
            this.m_velocities[indexA].w = wA;
            this.m_velocities[indexB].w = wB;
        }
    };
    ContactSolver.prototype.storeImpulses = function () {
        for (var i = 0; i < this.m_count; i++) {
            var vc = this.m_velocityConstraints[i];
            var manifold = this.m_contacts[vc.contactIndex].getManifold();
            for (var j = 0; j < vc.pointCount; j++) {
                manifold.points[j].normalImpulse = vc.points[j].normalImpulse;
                manifold.points[j].tangentImpulse = vc.points[j].tangentImpulse;
            }
        }
    };
    ContactSolver.prototype.solvePositionConstraints = function () {
        var minSeparation = 0.0;
        for (var i = 0; i < this.m_count; ++i) {
            var pc = this.m_positionConstraints[i];
            var indexA = pc.indexA;
            var indexB = pc.indexB;
            var mA = pc.invMassA;
            var iA = pc.invIA;
            var localCenterA = pc.localCenterA;
            var localCenterAx = localCenterA.x;
            var localCenterAy = localCenterA.y;
            var mB = pc.invMassB;
            var iB = pc.invIB;
            var localCenterB = pc.localCenterB;
            var localCenterBx = localCenterB.x;
            var localCenterBy = localCenterB.y;
            var pointCount = pc.pointCount;
            var cA = this.m_positions[indexA].c;
            var aA = this.m_positions[indexA].a;
            var cB = this.m_positions[indexB].c;
            var aB = this.m_positions[indexB].a;
            for (var j = 0; j < pointCount; ++j) {
                var xfAq = this.xfA.q;
                var xfBq = this.xfB.q;
                xfAq.setValue(aA);
                xfBq.setValue(aB);
                this.xfA.p.x = cA.x - xfAq.c * localCenterAx + xfAq.s * localCenterAy;
                this.xfA.p.y = cA.y - xfAq.s * localCenterAx - xfAq.c * localCenterAy;
                this.xfB.p.x = cB.x - xfBq.c * localCenterBx + xfBq.s * localCenterBy;
                this.xfB.p.y = cB.y - xfBq.s * localCenterBx - xfBq.c * localCenterBy;
                var psm = this.psolver;
                psm.initialize(pc, this.xfA, this.xfB, j);
                var normal = psm.normal;
                var point = psm.point;
                var separation = psm.separation;
                var rAx = point.x - cA.x;
                var rAy = point.y - cA.y;
                var rBx = point.x - cB.x;
                var rBy = point.y - cB.y;
                minSeparation = dMath.Min(minSeparation, separation);
                var C = MathUtils.clamp(Settings.baumgarte * (separation + Settings.linearSlop), -Settings.maxLinearCorrection, 0.0);
                var rnA = rAx * normal.y - rAy * normal.x;
                var rnB = rBx * normal.y - rBy * normal.x;
                var K = mA + mB + iA * rnA * rnA + iB * rnB * rnB;
                var impulse = K > 0.0 ? -C / K : 0.0;
                var Px = normal.x * impulse;
                var Py = normal.y * impulse;
                cA.x -= Px * mA;
                cA.y -= Py * mA;
                aA -= iA * (rAx * Py - rAy * Px);
                cB.x += Px * mB;
                cB.y += Py * mB;
                aB += iB * (rBx * Py - rBy * Px);
            }
            this.m_positions[indexA].a = aA;
            this.m_positions[indexB].a = aB;
        }
        return minSeparation >= -3.0 * Settings.linearSlop;
    };
    ContactSolver.prototype.solveTOIPositionConstraints = function (toiIndexA, toiIndexB) {
        var minSeparation = 0.0;
        for (var i = 0; i < this.m_count; ++i) {
            var pc = this.m_positionConstraints[i];
            var indexA = pc.indexA;
            var indexB = pc.indexB;
            var localCenterA = pc.localCenterA;
            var localCenterB = pc.localCenterB;
            var localCenterAx = localCenterA.x;
            var localCenterAy = localCenterA.y;
            var localCenterBx = localCenterB.x;
            var localCenterBy = localCenterB.y;
            var pointCount = pc.pointCount;
            var mA = 0.0;
            var iA = 0.0;
            if (indexA == toiIndexA || indexA == toiIndexB) {
                mA = pc.invMassA;
                iA = pc.invIA;
            }
            var mB = 0;
            var iB = 0;
            if (indexB == toiIndexA || indexB == toiIndexB) {
                mB = pc.invMassB;
                iB = pc.invIB;
            }
            var cA = this.m_positions[indexA].c;
            var aA = this.m_positions[indexA].a;
            var cB = this.m_positions[indexB].c;
            var aB = this.m_positions[indexB].a;
            for (var j = 0; j < pointCount; ++j) {
                var xfAq = this.xfA.q;
                var xfBq = this.xfB.q;
                xfAq.setValue(aA);
                xfBq.setValue(aB);
                this.xfA.p.x = cA.x - xfAq.c * localCenterAx + xfAq.s * localCenterAy;
                this.xfA.p.y = cA.y - xfAq.s * localCenterAx - xfAq.c * localCenterAy;
                this.xfB.p.x = cB.x - xfBq.c * localCenterBx + xfBq.s * localCenterBy;
                this.xfB.p.y = cB.y - xfBq.s * localCenterBx - xfBq.c * localCenterBy;
                var psm = this.psolver;
                psm.initialize(pc, this.xfA, this.xfB, j);
                var normal = psm.normal;
                var point = psm.point;
                var separation = psm.separation;
                var rAx = point.x - cA.x;
                var rAy = point.y - cA.y;
                var rBx = point.x - cB.x;
                var rBy = point.y - cB.y;
                minSeparation = dMath.Min(minSeparation, separation);
                var C = MathUtils.clamp(Settings.toiBaugarte * (separation + Settings.linearSlop), -Settings.maxLinearCorrection, 0.0);
                var rnA = rAx * normal.y - rAy * normal.x;
                var rnB = rBx * normal.y - rBy * normal.x;
                var K = mA + mB + iA * rnA * rnA + iB * rnB * rnB;
                var impulse = K > 0.0 ? -C / K : 0.0;
                var Px = normal.x * impulse;
                var Py = normal.y * impulse;
                cA.x -= Px * mA;
                cA.y -= Py * mA;
                aA -= iA * (rAx * Py - rAy * Px);
                cB.x += Px * mB;
                cB.y += Py * mB;
                aB += iB * (rBx * Py - rBy * Px);
            }
            this.m_positions[indexA].a = aA;
            this.m_positions[indexB].a = aB;
        }
        return minSeparation >= -1.5 * Settings.linearSlop;
    };
    ContactSolver.DEBUG_SOLVER = false;
    ContactSolver.k_errorTol = 1e-3;
    ContactSolver.INITIAL_NUM_CONSTRAINTS = 256;
    ContactSolver.k_maxConditionNumber = 100.0;
    return ContactSolver;
}());
var ContactSolverDef = (function () {
    function ContactSolverDef() {
        this.step = null;
        this.contacts = null;
        this.count = 0;
        this.positions = null;
        this.velocities = null;
    }
    return ContactSolverDef;
}());
var PositionSolverManifold = (function () {
    function PositionSolverManifold() {
        this.normal = new Vec2();
        this.point = new Vec2();
        this.separation = 0;
    }
    PositionSolverManifold.prototype.initialize = function (pc, xfA, xfB, index) {
        var xfAq = xfA.q;
        var xfBq = xfB.q;
        var pcLocalPointsI = pc.localPoints[index];
        switch (pc.type) {
            case Manifold.ManifoldType_CIRCLES:
                {
                    var plocalPoint = pc.localPoint;
                    var pLocalPoints0 = pc.localPoints[0];
                    var pointAx = (xfAq.c * plocalPoint.x - xfAq.s * plocalPoint.y) + xfA.p.x;
                    var pointAy = (xfAq.s * plocalPoint.x + xfAq.c * plocalPoint.y) + xfA.p.y;
                    var pointBx = (xfBq.c * pLocalPoints0.x - xfBq.s * pLocalPoints0.y) + xfB.p.x;
                    var pointBy = (xfBq.s * pLocalPoints0.x + xfBq.c * pLocalPoints0.y) + xfB.p.y;
                    this.normal.x = pointBx - pointAx;
                    this.normal.y = pointBy - pointAy;
                    this.normal.normalize();
                    this.point.x = (pointAx + pointBx) * 0.5;
                    this.point.y = (pointAy + pointBy) * 0.5;
                    var tempx = pointBx - pointAx;
                    var tempy = pointBy - pointAy;
                    this.separation = tempx * this.normal.x + tempy * this.normal.y - pc.radiusA - pc.radiusB;
                    break;
                }
            case Manifold.ManifoldType_FACE_A:
                {
                    var pcLocalNormal = pc.localNormal;
                    var pcLocalPoint = pc.localPoint;
                    this.normal.x = xfAq.c * pcLocalNormal.x - xfAq.s * pcLocalNormal.y;
                    this.normal.y = xfAq.s * pcLocalNormal.x + xfAq.c * pcLocalNormal.y;
                    var planePointx = (xfAq.c * pcLocalPoint.x - xfAq.s * pcLocalPoint.y) + xfA.p.x;
                    var planePointy = (xfAq.s * pcLocalPoint.x + xfAq.c * pcLocalPoint.y) + xfA.p.y;
                    var clipPointx = (xfBq.c * pcLocalPointsI.x - xfBq.s * pcLocalPointsI.y) + xfB.p.x;
                    var clipPointy = (xfBq.s * pcLocalPointsI.x + xfBq.c * pcLocalPointsI.y) + xfB.p.y;
                    var tempx = clipPointx - planePointx;
                    var tempy = clipPointy - planePointy;
                    this.separation = tempx * this.normal.x + tempy * this.normal.y - pc.radiusA - pc.radiusB;
                    this.point.x = clipPointx;
                    this.point.y = clipPointy;
                    break;
                }
            case Manifold.ManifoldType_FACE_B:
                {
                    var pcLocalNormal = pc.localNormal;
                    var pcLocalPoint = pc.localPoint;
                    this.normal.x = xfBq.c * pcLocalNormal.x - xfBq.s * pcLocalNormal.y;
                    this.normal.y = xfBq.s * pcLocalNormal.x + xfBq.c * pcLocalNormal.y;
                    var planePointx = (xfBq.c * pcLocalPoint.x - xfBq.s * pcLocalPoint.y) + xfB.p.x;
                    var planePointy = (xfBq.s * pcLocalPoint.x + xfBq.c * pcLocalPoint.y) + xfB.p.y;
                    var clipPointx = (xfAq.c * pcLocalPointsI.x - xfAq.s * pcLocalPointsI.y) + xfA.p.x;
                    var clipPointy = (xfAq.s * pcLocalPointsI.x + xfAq.c * pcLocalPointsI.y) + xfA.p.y;
                    var tempx = clipPointx - planePointx;
                    var tempy = clipPointy - planePointy;
                    this.separation = tempx * this.normal.x + tempy * this.normal.y - pc.radiusA - pc.radiusB;
                    this.point.x = clipPointx;
                    this.point.y = clipPointy;
                    this.normal.x *= -1;
                    this.normal.y *= -1;
                }
                break;
        }
    };
    return PositionSolverManifold;
}());
var ContactVelocityConstraint = (function () {
    function ContactVelocityConstraint() {
        this.points = new Array(Settings.maxManifoldPoints);
        this.normal = new Vec2();
        this.normalMass = new Mat22();
        this.K = new Mat22();
        this.indexA = 0;
        this.indexB = 0;
        this.invMassA = 0;
        this.invMassB = 0;
        this.invIA = 0;
        this.invIB = 0;
        this.friction = 0;
        this.restitution = 0;
        this.tangentSpeed = 0;
        this.pointCount = 0;
        this.contactIndex = 0;
        for (var i = 0; i < this.points.length; i++) {
            this.points[i] = new ContactVelocityConstraint_VelocityConstraintPoint();
        }
    }
    return ContactVelocityConstraint;
}());
var ContactVelocityConstraint_VelocityConstraintPoint = (function () {
    function ContactVelocityConstraint_VelocityConstraintPoint() {
        this.rA = new Vec2();
        this.rB = new Vec2();
        this.normalImpulse = 0;
        this.tangentImpulse = 0;
        this.normalMass = 0;
        this.tangentMass = 0;
        this.velocityBias = 0;
    }
    return ContactVelocityConstraint_VelocityConstraintPoint;
}());
var EdgeAndCircleContact = (function (_super) {
    __extends(EdgeAndCircleContact, _super);
    function EdgeAndCircleContact(argPool) {
        return _super.call(this, argPool) || this;
    }
    EdgeAndCircleContact.prototype.init = function (fA, indexA, fB, indexB) {
        _super.prototype.init.call(this, fA, indexA, fB, indexB);
    };
    EdgeAndCircleContact.prototype.evaluate = function (manifold, xfA, xfB) {
        this.pool.getCollision().collideEdgeAndCircle(manifold, this.m_fixtureA.getShape(), xfA, this.m_fixtureB.getShape(), xfB);
    };
    return EdgeAndCircleContact;
}(Contact));
var EdgeAndPolygonContact = (function (_super) {
    __extends(EdgeAndPolygonContact, _super);
    function EdgeAndPolygonContact(argPool) {
        return _super.call(this, argPool) || this;
    }
    EdgeAndPolygonContact.prototype.init = function (fA, indexA, fB, indexB) {
        _super.prototype.init.call(this, fA, indexA, fB, indexB);
    };
    EdgeAndPolygonContact.prototype.evaluate = function (manifold, xfA, xfB) {
        this.pool.getCollision().collideEdgeAndPolygon(manifold, this.m_fixtureA.getShape(), xfA, this.m_fixtureB.getShape(), xfB);
    };
    return EdgeAndPolygonContact;
}(Contact));
var PolygonAndCircleContact = (function (_super) {
    __extends(PolygonAndCircleContact, _super);
    function PolygonAndCircleContact(argPool) {
        return _super.call(this, argPool) || this;
    }
    PolygonAndCircleContact.prototype.init = function (fA, indexA, fB, indexB) {
        _super.prototype.init.call(this, fA, 0, fB, 0);
    };
    PolygonAndCircleContact.prototype.evaluate = function (manifold, xfA, xfB) {
        this.pool.getCollision().collidePolygonAndCircle(manifold, this.m_fixtureA.getShape(), xfA, this.m_fixtureB.getShape(), xfB);
    };
    return PolygonAndCircleContact;
}(Contact));
var PolygonContact = (function (_super) {
    __extends(PolygonContact, _super);
    function PolygonContact(argPool) {
        return _super.call(this, argPool) || this;
    }
    PolygonContact.prototype.init = function (fA, indexA, fB, indexB) {
        _super.prototype.init.call(this, fA, 0, fB, 0);
    };
    PolygonContact.prototype.evaluate = function (manifold, xfA, xfB) {
        this.pool.getCollision().collidePolygons(manifold, this.m_fixtureA.getShape(), xfA, this.m_fixtureB.getShape(), xfB);
    };
    return PolygonContact;
}(Contact));
var Position = (function () {
    function Position() {
        this.c = new Vec2();
        this.a = 0;
    }
    return Position;
}());
var Velocity = (function () {
    function Velocity() {
        this.v = new Vec2();
        this.w = 0;
    }
    return Velocity;
}());
var Joint = (function () {
    function Joint(worldPool, def) {
        this.m_type = 0;
        this.m_prev = null;
        this.m_next = null;
        this.m_edgeA = null;
        this.m_edgeB = null;
        this.m_bodyA = null;
        this.m_bodyB = null;
        this.m_islandFlag = false;
        this.m_collideConnected = false;
        this.m_userData = null;
        this.pool = null;
        this.pool = worldPool;
        this.m_type = def.type;
        this.m_prev = null;
        this.m_next = null;
        this.m_bodyA = def.bodyA;
        this.m_bodyB = def.bodyB;
        this.m_collideConnected = def.collideConnected;
        this.m_islandFlag = false;
        this.m_userData = def.userData;
        this.m_edgeA = new JointEdge();
        this.m_edgeA.joint = null;
        this.m_edgeA.other = null;
        this.m_edgeA.prev = null;
        this.m_edgeA.next = null;
        this.m_edgeB = new JointEdge();
        this.m_edgeB.joint = null;
        this.m_edgeB.other = null;
        this.m_edgeB.prev = null;
        this.m_edgeB.next = null;
    }
    Joint.Create = function (world, def) {
        switch (def.type) {
            case JointType.MOUSE:
                return new MouseJoint(world.getPool(), def);
            case JointType.DISTANCE:
                return new DistanceJoint(world.getPool(), def);
            case JointType.PRISMATIC:
                return new PrismaticJoint(world.getPool(), def);
            case JointType.REVOLUTE:
                return new RevoluteJoint(world.getPool(), def);
            case JointType.WELD:
                return new WeldJoint(world.getPool(), def);
            case JointType.FRICTION:
                return new FrictionJoint(world.getPool(), def);
            case JointType.WHEEL:
                return new WheelJoint(world.getPool(), def);
            case JointType.GEAR:
                return new GearJoint(world.getPool(), def);
            case JointType.PULLEY:
                return new PulleyJoint(world.getPool(), def);
            case JointType.CONSTANT_VOLUME:
                return new ConstantVolumeJoint(world, def);
            case JointType.ROPE:
                return new RopeJoint(world.getPool(), def);
            case JointType.MOTOR:
                return new MotorJoint(world.getPool(), def);
            case JointType.UNKNOWN:
            default:
                return null;
        }
    };
    Joint.destroy = function (joint) {
        joint.destructor();
    };
    Joint.prototype.getType = function () {
        return this.m_type;
    };
    Joint.prototype.getBodyA = function () {
        return this.m_bodyA;
    };
    Joint.prototype.getBodyB = function () {
        return this.m_bodyB;
    };
    Joint.prototype.getAnchorA = function (outData) {
    };
    Joint.prototype.getAnchorB = function (outData) {
    };
    Joint.prototype.getReactionForce = function (inv_dt, outData) {
    };
    Joint.prototype.getReactionTorque = function (inv_dt) {
        return 0;
    };
    Joint.prototype.getNext = function () {
        return this.m_next;
    };
    Joint.prototype.getUserData = function () {
        return this.m_userData;
    };
    Joint.prototype.setUserData = function (data) {
        this.m_userData = data;
    };
    Joint.prototype.getCollideConnected = function () {
        return this.m_collideConnected;
    };
    Joint.prototype.isActive = function () {
        return this.m_bodyA.isActive() && this.m_bodyB.isActive();
    };
    Joint.prototype.initVelocityConstraints = function (data) {
    };
    Joint.prototype.solveVelocityConstraints = function (data) {
    };
    Joint.prototype.solvePositionConstraints = function (data) {
        return false;
    };
    Joint.prototype.destructor = function () { };
    return Joint;
}());
var ConstantVolumeJoint = (function (_super) {
    __extends(ConstantVolumeJoint, _super);
    function ConstantVolumeJoint(argWorld, def) {
        var _this = _super.call(this, argWorld.getPool(), def) || this;
        _this.bodies = null;
        _this.targetLengths = null;
        _this.targetVolume = 0;
        _this.normals = null;
        _this.m_impulse = 0.0;
        _this.world = null;
        _this.distanceJoints = null;
        _this.world = argWorld;
        if (def.bodies.length <= 2) {
            throw "You cannot create a constant volume joint with less than three bodies.";
        }
        var bodies = def.bodies;
        _this.targetLengths = new Array(bodies.length);
        for (var i = 0; i < _this.targetLengths.length; ++i) {
            var next = (i == _this.targetLengths.length - 1) ? 0 : i + 1;
            var dist = bodies[i].getWorldCenter().sub(bodies[next].getWorldCenter()).length();
            _this.targetLengths[i] = dist;
        }
        _this.targetVolume = _this.getBodyArea();
        if (def.joints != null && def.joints.length != def.bodies.length) {
            throw "Incorrect joint definition. Joints have to correspond to the bodies";
        }
        if (def.joints == null) {
            var djd = new DistanceJointDef();
            _this.distanceJoints = new Array(bodies.length);
            for (var i = 0; i < _this.targetLengths.length; ++i) {
                var next = (i == _this.targetLengths.length - 1) ? 0 : i + 1;
                djd.frequencyHz = def.frequencyHz;
                djd.dampingRatio = def.dampingRatio;
                djd.collideConnected = def.collideConnected;
                djd.initialize(bodies[i], bodies[next], bodies[i].getWorldCenter(), bodies[next].getWorldCenter());
                _this.distanceJoints[i] = _this.world.createJoint(djd);
            }
        }
        else {
            _this.distanceJoints = def.joints;
        }
        _this.normals = new Array(bodies.length);
        for (var i = 0; i < _this.normals.length; ++i) {
            _this.normals[i] = new Vec2();
        }
        return _this;
    }
    ConstantVolumeJoint.prototype.getBodies = function () {
        return this.bodies;
    };
    ConstantVolumeJoint.prototype.getJoints = function () {
        return this.distanceJoints;
    };
    ConstantVolumeJoint.prototype.inflate = function (factor) {
        this.targetVolume *= factor;
    };
    ConstantVolumeJoint.prototype.destructor = function () {
        for (var i = 0; i < this.distanceJoints.length; ++i) {
            this.world.destroyJoint(this.distanceJoints[i]);
        }
    };
    ConstantVolumeJoint.prototype.getBodyArea = function () {
        var area = 0.0;
        for (var i = 0; i < this.bodies.length; ++i) {
            var next = (i == this.bodies.length - 1) ? 0 : i + 1;
            area += this.bodies[i].getWorldCenter().x * this.bodies[next].getWorldCenter().y
                - this.bodies[next].getWorldCenter().x * this.bodies[i].getWorldCenter().y;
        }
        area *= 0.5;
        return area;
    };
    ConstantVolumeJoint.prototype.getSolverArea = function (positions) {
        var area = 0.0;
        for (var i = 0; i < this.bodies.length; ++i) {
            var next = (i == this.bodies.length - 1) ? 0 : i + 1;
            area += positions[this.bodies[i].m_islandIndex].c.x * positions[this.bodies[next].m_islandIndex].c.y
                - positions[this.bodies[next].m_islandIndex].c.x * positions[this.bodies[i].m_islandIndex].c.y;
        }
        area *= 0.5;
        return area;
    };
    ConstantVolumeJoint.prototype.constrainEdges = function (positions) {
        var perimeter = 0.0;
        for (var i = 0; i < this.bodies.length; ++i) {
            var next = (i == this.bodies.length - 1) ? 0 : i + 1;
            var dx = positions[this.bodies[next].m_islandIndex].c.x - positions[this.bodies[i].m_islandIndex].c.x;
            var dy = positions[this.bodies[next].m_islandIndex].c.y - positions[this.bodies[i].m_islandIndex].c.y;
            var dist = MathUtils.sqrt(dx * dx + dy * dy);
            if (dist < Settings.EPSILON) {
                dist = 1.0;
            }
            this.normals[i].x = dy / dist;
            this.normals[i].y = -dx / dist;
            perimeter += dist;
        }
        var delta = this.pool.popVec2();
        var deltaArea = this.targetVolume - this.getSolverArea(positions);
        var toExtrude = 0.5 * deltaArea / perimeter;
        var done = true;
        for (var i = 0; i < this.bodies.length; ++i) {
            var next = (i == this.bodies.length - 1) ? 0 : i + 1;
            delta.setValue(toExtrude * (this.normals[i].x + this.normals[next].x), toExtrude
                * (this.normals[i].y + this.normals[next].y));
            var normSqrd = delta.lengthSquared();
            if (normSqrd > Settings.maxLinearCorrection * Settings.maxLinearCorrection) {
                delta.mulLocal(Settings.maxLinearCorrection / MathUtils.sqrt(normSqrd));
            }
            if (normSqrd > Settings.linearSlop * Settings.linearSlop) {
                done = false;
            }
            positions[this.bodies[next].m_islandIndex].c.x += delta.x;
            positions[this.bodies[next].m_islandIndex].c.y += delta.y;
        }
        this.pool.pushVec2(1);
        return done;
    };
    ConstantVolumeJoint.prototype.initVelocityConstraints = function (step) {
        var velocities = step.velocities;
        var positions = step.positions;
        var d = new Array(this.bodies.length);
        for (var i = 0; i < this.bodies.length; ++i) {
            var prev = (i == 0) ? this.bodies.length - 1 : i - 1;
            var next = (i == this.bodies.length - 1) ? 0 : i + 1;
            d[i].set(positions[this.bodies[next].m_islandIndex].c);
            d[i].subLocal(positions[this.bodies[prev].m_islandIndex].c);
        }
        if (step.step.warmStarting) {
            this.m_impulse *= step.step.dtRatio;
            for (var i = 0; i < this.bodies.length; ++i) {
                velocities[this.bodies[i].m_islandIndex].v.x += this.bodies[i].m_invMass * d[i].y * 0.5 * this.m_impulse;
                velocities[this.bodies[i].m_islandIndex].v.y += this.bodies[i].m_invMass * (-d[i].x) * 0.5 * this.m_impulse;
            }
        }
        else {
            this.m_impulse = 0.0;
        }
    };
    ConstantVolumeJoint.prototype.solvePositionConstraints = function (step) {
        return this.constrainEdges(step.positions);
    };
    ConstantVolumeJoint.prototype.solveVelocityConstraints = function (step) {
        var crossMassSum = 0.0;
        var dotMassSum = 0.0;
        var velocities = step.velocities;
        var positions = step.positions;
        var d = new Array(this.bodies.length);
        for (var i = 0; i < this.bodies.length; ++i) {
            var prev = (i == 0) ? this.bodies.length - 1 : i - 1;
            var next = (i == this.bodies.length - 1) ? 0 : i + 1;
            d[i].set(positions[this.bodies[next].m_islandIndex].c);
            d[i].subLocal(positions[this.bodies[prev].m_islandIndex].c);
            dotMassSum += (d[i].lengthSquared()) / this.bodies[i].getMass();
            crossMassSum += Vec2.cross(velocities[this.bodies[i].m_islandIndex].v, d[i]);
        }
        var lambda = -2.0 * crossMassSum / dotMassSum;
        this.m_impulse += lambda;
        for (var i = 0; i < this.bodies.length; ++i) {
            velocities[this.bodies[i].m_islandIndex].v.x += this.bodies[i].m_invMass * d[i].y * 0.5 * lambda;
            velocities[this.bodies[i].m_islandIndex].v.y += this.bodies[i].m_invMass * (-d[i].x) * 0.5 * lambda;
        }
    };
    ConstantVolumeJoint.prototype.getAnchorA = function (argOut) { };
    ConstantVolumeJoint.prototype.getAnchorB = function (argOut) { };
    ConstantVolumeJoint.prototype.getReactionForce = function (inv_dt, argOut) { };
    ConstantVolumeJoint.prototype.getReactionTorque = function (inv_dt) {
        return 0;
    };
    return ConstantVolumeJoint;
}(Joint));
var JointDef = (function () {
    function JointDef(type) {
        this.type = type;
        this.userData = null;
        this.bodyA = null;
        this.bodyB = null;
        this.collideConnected = false;
    }
    return JointDef;
}());
var ConstantVolumeJointDef = (function (_super) {
    __extends(ConstantVolumeJointDef, _super);
    function ConstantVolumeJointDef() {
        var _this = _super.call(this, JointType.CONSTANT_VOLUME) || this;
        _this.frequencyHz = 0;
        _this.dampingRatio = 0;
        _this.bodies = null;
        _this.joints = null;
        _this.bodies = new Array();
        _this.joints = null;
        _this.collideConnected = false;
        _this.frequencyHz = 0.0;
        _this.dampingRatio = 0.0;
        return _this;
    }
    ConstantVolumeJointDef.prototype.addBody = function (argBody) {
        this.bodies.push(argBody);
        if (this.bodies.length == 1) {
            this.bodyA = argBody;
        }
        if (this.bodies.length == 2) {
            this.bodyB = argBody;
        }
    };
    ConstantVolumeJointDef.prototype.addBodyAndJoint = function (argBody, argJoint) {
        this.addBody(argBody);
        if (this.joints == null) {
            this.joints = new Array();
        }
        this.joints.push(argJoint);
    };
    return ConstantVolumeJointDef;
}(JointDef));
var DistanceJoint = (function (_super) {
    __extends(DistanceJoint, _super);
    function DistanceJoint(argWorld, def) {
        var _this = _super.call(this, argWorld, def) || this;
        _this.m_frequencyHz = 0;
        _this.m_dampingRatio = 0;
        _this.m_bias = 0;
        _this.m_localAnchorA = null;
        _this.m_localAnchorB = null;
        _this.m_gamma = 0;
        _this.m_impulse = 0;
        _this.m_length = 0;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_u = new Vec2();
        _this.m_rA = new Vec2();
        _this.m_rB = new Vec2();
        _this.m_localCenterA = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_invMassA = 0;
        _this.m_invMassB = 0;
        _this.m_invIA = 0;
        _this.m_invIB = 0;
        _this.m_mass = 0;
        _this.m_localAnchorA = def.localAnchorA.clone();
        _this.m_localAnchorB = def.localAnchorB.clone();
        _this.m_length = def.length;
        _this.m_impulse = 0.0;
        _this.m_frequencyHz = def.frequencyHz;
        _this.m_dampingRatio = def.dampingRatio;
        _this.m_gamma = 0.0;
        _this.m_bias = 0.0;
        return _this;
    }
    DistanceJoint.prototype.setFrequency = function (hz) {
        this.m_frequencyHz = hz;
    };
    DistanceJoint.prototype.getFrequency = function () {
        return this.m_frequencyHz;
    };
    DistanceJoint.prototype.getLength = function () {
        return this.m_length;
    };
    DistanceJoint.prototype.setLength = function (argLength) {
        this.m_length = argLength;
    };
    DistanceJoint.prototype.setDampingRatio = function (damp) {
        this.m_dampingRatio = damp;
    };
    DistanceJoint.prototype.getDampingRatio = function () {
        return this.m_dampingRatio;
    };
    DistanceJoint.prototype.getAnchorA = function (argOut) {
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, argOut);
    };
    DistanceJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    DistanceJoint.prototype.getLocalAnchorA = function () {
        return this.m_localAnchorA;
    };
    DistanceJoint.prototype.getLocalAnchorB = function () {
        return this.m_localAnchorB;
    };
    DistanceJoint.prototype.getReactionForce = function (inv_dt, argOut) {
        argOut.x = this.m_impulse * this.m_u.x * inv_dt;
        argOut.y = this.m_impulse * this.m_u.y * inv_dt;
    };
    DistanceJoint.prototype.getReactionTorque = function (inv_dt) {
        return 0.0;
    };
    DistanceJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassA = this.m_bodyA.m_invMass;
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIA = this.m_bodyA.m_invI;
        this.m_invIB = this.m_bodyB.m_invI;
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, this.m_u.set(this.m_localAnchorA).subLocal(this.m_localCenterA), this.m_rA);
        Rot.mulToOutUnsafe(qB, this.m_u.set(this.m_localAnchorB).subLocal(this.m_localCenterB), this.m_rB);
        this.m_u.set(cB).addLocal(this.m_rB).subLocal(cA).subLocal(this.m_rA);
        this.pool.pushRot(2);
        var length = this.m_u.length();
        if (length > Settings.linearSlop) {
            this.m_u.x *= 1.0 / length;
            this.m_u.y *= 1.0 / length;
        }
        else {
            this.m_u.setValue(0.0, 0.0);
        }
        var crAu = Vec2.cross(this.m_rA, this.m_u);
        var crBu = Vec2.cross(this.m_rB, this.m_u);
        var invMass = this.m_invMassA + this.m_invIA * crAu * crAu + this.m_invMassB + this.m_invIB * crBu * crBu;
        this.m_mass = invMass != 0.0 ? 1.0 / invMass : 0.0;
        if (this.m_frequencyHz > 0.0) {
            var C = length - this.m_length;
            var omega = 2.0 * MathUtils.PI * this.m_frequencyHz;
            var d = 2.0 * this.m_mass * this.m_dampingRatio * omega;
            var k = this.m_mass * omega * omega;
            var h = data.step.dt;
            this.m_gamma = h * (d + h * k);
            this.m_gamma = this.m_gamma != 0.0 ? 1.0 / this.m_gamma : 0.0;
            this.m_bias = C * h * k * this.m_gamma;
            invMass += this.m_gamma;
            this.m_mass = invMass != 0.0 ? 1.0 / invMass : 0.0;
        }
        else {
            this.m_gamma = 0.0;
            this.m_bias = 0.0;
        }
        if (data.step.warmStarting) {
            this.m_impulse *= data.step.dtRatio;
            var P = this.pool.popVec2();
            P.set(this.m_u).mulLocal(this.m_impulse);
            vA.x -= this.m_invMassA * P.x;
            vA.y -= this.m_invMassA * P.y;
            wA -= this.m_invIA * Vec2.cross(this.m_rA, P);
            vB.x += this.m_invMassB * P.x;
            vB.y += this.m_invMassB * P.y;
            wB += this.m_invIB * Vec2.cross(this.m_rB, P);
            this.pool.pushVec2(1);
        }
        else {
            this.m_impulse = 0.0;
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
    };
    DistanceJoint.prototype.solveVelocityConstraints = function (data) {
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var vpA = this.pool.popVec2();
        var vpB = this.pool.popVec2();
        Vec2.crossToOutUnsafe(this.m_rA, -wA, vpA);
        vpA.addLocal(vA);
        Vec2.crossToOutUnsafe(this.m_rB, -wB, vpB);
        vpB.addLocal(vB);
        var Cdot = Vec2.dot(this.m_u, vpB.subLocal(vpA));
        var impulse = -this.m_mass * (Cdot + this.m_bias + this.m_gamma * this.m_impulse);
        this.m_impulse += impulse;
        var Px = impulse * this.m_u.x;
        var Py = impulse * this.m_u.y;
        vA.x -= this.m_invMassA * Px;
        vA.y -= this.m_invMassA * Py;
        wA -= this.m_invIA * (this.m_rA.x * Py - this.m_rA.y * Px);
        vB.x += this.m_invMassB * Px;
        vB.y += this.m_invMassB * Py;
        wB += this.m_invIB * (this.m_rB.x * Py - this.m_rB.y * Px);
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(2);
    };
    DistanceJoint.prototype.solvePositionConstraints = function (data) {
        if (this.m_frequencyHz > 0.0) {
            return true;
        }
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var rA = this.pool.popVec2();
        var rB = this.pool.popVec2();
        var u = this.pool.popVec2();
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, u.set(this.m_localAnchorA).subLocal(this.m_localCenterA), rA);
        Rot.mulToOutUnsafe(qB, u.set(this.m_localAnchorB).subLocal(this.m_localCenterB), rB);
        u.set(cB).addLocal(rB).subLocal(cA).subLocal(rA);
        var length = u.normalize();
        var C = length - this.m_length;
        C = MathUtils.clamp(C, -Settings.maxLinearCorrection, Settings.maxLinearCorrection);
        var impulse = -this.m_mass * C;
        var Px = impulse * u.x;
        var Py = impulse * u.y;
        cA.x -= this.m_invMassA * Px;
        cA.y -= this.m_invMassA * Py;
        aA -= this.m_invIA * (rA.x * Py - rA.y * Px);
        cB.x += this.m_invMassB * Px;
        cB.y += this.m_invMassB * Py;
        aB += this.m_invIB * (rB.x * Py - rB.y * Px);
        data.positions[this.m_indexA].a = aA;
        data.positions[this.m_indexB].a = aB;
        this.pool.pushVec2(3);
        this.pool.pushRot(2);
        return dMath.Abs(C) < Settings.linearSlop;
    };
    return DistanceJoint;
}(Joint));
var DistanceJointDef = (function (_super) {
    __extends(DistanceJointDef, _super);
    function DistanceJointDef() {
        var _this = _super.call(this, JointType.DISTANCE) || this;
        _this.localAnchorA = null;
        _this.localAnchorB = null;
        _this.length = 0;
        _this.frequencyHz = 0;
        _this.dampingRatio = 0;
        _this.localAnchorA = new Vec2(0.0, 0.0);
        _this.localAnchorB = new Vec2(0.0, 0.0);
        _this.length = 1.0;
        _this.frequencyHz = 0.0;
        _this.dampingRatio = 0.0;
        return _this;
    }
    DistanceJointDef.prototype.initialize = function (b1, b2, anchor1, anchor2) {
        this.bodyA = b1;
        this.bodyB = b2;
        this.localAnchorA.set(this.bodyA.getLocalPoint(anchor1));
        this.localAnchorB.set(this.bodyB.getLocalPoint(anchor2));
        var d = anchor2.sub(anchor1);
        this.length = d.length();
    };
    return DistanceJointDef;
}(JointDef));
var FrictionJoint = (function (_super) {
    __extends(FrictionJoint, _super);
    function FrictionJoint(argWorldPool, def) {
        var _this = _super.call(this, argWorldPool, def) || this;
        _this.m_localAnchorA = null;
        _this.m_localAnchorB = null;
        _this.m_linearImpulse = null;
        _this.m_angularImpulse = 0;
        _this.m_maxForce = 0;
        _this.m_maxTorque = 0;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_rA = new Vec2();
        _this.m_rB = new Vec2();
        _this.m_localCenterA = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_invMassA = 0;
        _this.m_invMassB = 0;
        _this.m_invIA = 0;
        _this.m_invIB = 0;
        _this.m_linearMass = new Mat22();
        _this.m_angularMass = 0;
        _this.m_localAnchorA = new Vec2().set(def.localAnchorA);
        _this.m_localAnchorB = new Vec2().set(def.localAnchorB);
        _this.m_linearImpulse = new Vec2();
        _this.m_angularImpulse = 0.0;
        _this.m_maxForce = def.maxForce;
        _this.m_maxTorque = def.maxTorque;
        return _this;
    }
    FrictionJoint.prototype.getLocalAnchorA = function () {
        return this.m_localAnchorA;
    };
    FrictionJoint.prototype.getLocalAnchorB = function () {
        return this.m_localAnchorB;
    };
    FrictionJoint.prototype.getAnchorA = function (argOut) {
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, argOut);
    };
    FrictionJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    FrictionJoint.prototype.getReactionForce = function (inv_dt, argOut) {
        argOut.set(this.m_linearImpulse).mulLocal(inv_dt);
    };
    FrictionJoint.prototype.getReactionTorque = function (inv_dt) {
        return inv_dt * this.m_angularImpulse;
    };
    FrictionJoint.prototype.setMaxForce = function (force) {
        this.m_maxForce = force;
    };
    FrictionJoint.prototype.getMaxForce = function () {
        return this.m_maxForce;
    };
    FrictionJoint.prototype.setMaxTorque = function (torque) {
        this.m_maxTorque = torque;
    };
    FrictionJoint.prototype.getMaxTorque = function () {
        return this.m_maxTorque;
    };
    FrictionJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassA = this.m_bodyA.m_invMass;
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIA = this.m_bodyA.m_invI;
        this.m_invIB = this.m_bodyB.m_invI;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var temp = this.pool.popVec2();
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), this.m_rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), this.m_rB);
        var mA = this.m_invMassA;
        var mB = this.m_invMassB;
        var iA = this.m_invIA;
        var iB = this.m_invIB;
        var K = this.pool.popMat22();
        K.ex.x = mA + mB + iA * this.m_rA.y * this.m_rA.y + iB * this.m_rB.y * this.m_rB.y;
        K.ex.y = -iA * this.m_rA.x * this.m_rA.y - iB * this.m_rB.x * this.m_rB.y;
        K.ey.x = K.ex.y;
        K.ey.y = mA + mB + iA * this.m_rA.x * this.m_rA.x + iB * this.m_rB.x * this.m_rB.x;
        K.invertToOut(this.m_linearMass);
        this.m_angularMass = iA + iB;
        if (this.m_angularMass > 0.0) {
            this.m_angularMass = 1.0 / this.m_angularMass;
        }
        if (data.step.warmStarting) {
            this.m_linearImpulse.mulLocal(data.step.dtRatio);
            this.m_angularImpulse *= data.step.dtRatio;
            var P = this.pool.popVec2();
            P.set(this.m_linearImpulse);
            temp.set(P).mulLocal(mA);
            vA.subLocal(temp);
            wA -= iA * (Vec2.cross(this.m_rA, P) + this.m_angularImpulse);
            temp.set(P).mulLocal(mB);
            vB.addLocal(temp);
            wB += iB * (Vec2.cross(this.m_rB, P) + this.m_angularImpulse);
            this.pool.pushVec2(1);
        }
        else {
            this.m_linearImpulse.setZero();
            this.m_angularImpulse = 0.0;
        }
        if (data.velocities[this.m_indexA].w != wA) {
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushRot(2);
        this.pool.pushVec2(1);
        this.pool.pushMat22(1);
    };
    FrictionJoint.prototype.solveVelocityConstraints = function (data) {
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        var h = data.step.dt;
        {
            var Cdot = wB - wA;
            var impulseN = -this.m_angularMass * Cdot;
            var oldImpulseN = this.m_angularImpulse;
            var maxImpulse = h * this.m_maxTorque;
            this.m_angularImpulse = MathUtils.clamp(this.m_angularImpulse + impulseN, -maxImpulse, maxImpulse);
            impulseN = this.m_angularImpulse - oldImpulseN;
            wA -= iA * impulseN;
            wB += iB * impulseN;
        }
        {
            var Cdot2 = this.pool.popVec2();
            var temp = this.pool.popVec2();
            Vec2.crossToOutUnsafe(this.m_rA, -wA, temp);
            Vec2.crossToOutUnsafe(this.m_rB, -wB, Cdot2);
            Cdot2.addLocal(vB).subLocal(vA).subLocal(temp);
            var impulse = this.pool.popVec2();
            Mat22.mulToOutUnsafeVec2(this.m_linearMass, Cdot2, impulse);
            impulse.negateLocal();
            var oldImpulse = this.pool.popVec2();
            oldImpulse.set(this.m_linearImpulse);
            this.m_linearImpulse.addLocal(impulse);
            var maxImpulse = h * this.m_maxForce;
            if (this.m_linearImpulse.lengthSquared() > maxImpulse * maxImpulse) {
                this.m_linearImpulse.normalize();
                this.m_linearImpulse.mulLocal(maxImpulse);
            }
            impulse.set(this.m_linearImpulse).subLocal(oldImpulse);
            temp.set(impulse).mulLocal(mA);
            vA.subLocal(temp);
            wA -= iA * Vec2.cross(this.m_rA, impulse);
            temp.set(impulse).mulLocal(mB);
            vB.addLocal(temp);
            wB += iB * Vec2.cross(this.m_rB, impulse);
        }
        if (data.velocities[this.m_indexA].w != wA) {
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(4);
    };
    FrictionJoint.prototype.solvePositionConstraints = function (data) {
        return true;
    };
    return FrictionJoint;
}(Joint));
var FrictionJointDef = (function (_super) {
    __extends(FrictionJointDef, _super);
    function FrictionJointDef() {
        var _this = _super.call(this, JointType.FRICTION) || this;
        _this.localAnchorA = null;
        _this.localAnchorB = null;
        _this.maxForce = 0;
        _this.maxTorque = 0;
        _this.localAnchorA = new Vec2();
        _this.localAnchorB = new Vec2();
        _this.maxForce = 0;
        _this.maxTorque = 0;
        return _this;
    }
    FrictionJointDef.prototype.initialize = function (bA, bB, anchor) {
        this.bodyA = bA;
        this.bodyB = bB;
        bA.getLocalPointToOut(anchor, this.localAnchorA);
        bB.getLocalPointToOut(anchor, this.localAnchorB);
    };
    return FrictionJointDef;
}(JointDef));
var GearJoint = (function (_super) {
    __extends(GearJoint, _super);
    function GearJoint(argWorldPool, def) {
        var _this = _super.call(this, argWorldPool, def) || this;
        _this.m_joint1 = null;
        _this.m_joint2 = null;
        _this.m_typeA = 0;
        _this.m_typeB = 0;
        _this.m_bodyC = null;
        _this.m_bodyD = null;
        _this.m_localAnchorA = new Vec2();
        _this.m_localAnchorB = new Vec2();
        _this.m_localAnchorC = new Vec2();
        _this.m_localAnchorD = new Vec2();
        _this.m_localAxisC = new Vec2();
        _this.m_localAxisD = new Vec2();
        _this.m_referenceAngleA = 0;
        _this.m_referenceAngleB = 0;
        _this.m_constant = 0;
        _this.m_ratio = 0;
        _this.m_impulse = 0;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_indexC = 0;
        _this.m_indexD = 0;
        _this.m_lcA = new Vec2();
        _this.m_lcB = new Vec2();
        _this.m_lcC = new Vec2();
        _this.m_lcD = new Vec2();
        _this.m_mA = 0;
        _this.m_mB = 0;
        _this.m_mC = 0;
        _this.m_mD = 0;
        _this.m_iA = 0;
        _this.m_iB = 0;
        _this.m_iC = 0;
        _this.m_iD = 0;
        _this.m_JvAC = new Vec2();
        _this.m_JvBD = new Vec2();
        _this.m_JwA = 0;
        _this.m_JwB = 0;
        _this.m_JwC = 0;
        _this.m_JwD = 0;
        _this.m_mass = 0;
        _this.m_joint1 = def.joint1;
        _this.m_joint2 = def.joint2;
        _this.m_typeA = _this.m_joint1.getType();
        _this.m_typeB = _this.m_joint2.getType();
        var coordinateA = 0;
        var coordinateB = 0;
        _this.m_bodyC = _this.m_joint1.getBodyA();
        _this.m_bodyA = _this.m_joint1.getBodyB();
        var xfA = _this.m_bodyA.m_xf;
        var aA = _this.m_bodyA.m_sweep.a;
        var xfC = _this.m_bodyC.m_xf;
        var aC = _this.m_bodyC.m_sweep.a;
        if (_this.m_typeA == JointType.REVOLUTE) {
            var revolute = def.joint1;
            _this.m_localAnchorC.set(revolute.m_localAnchorA);
            _this.m_localAnchorA.set(revolute.m_localAnchorB);
            _this.m_referenceAngleA = revolute.m_referenceAngle;
            _this.m_localAxisC.setZero();
            coordinateA = aA - aC - _this.m_referenceAngleA;
        }
        else {
            var pA = _this.pool.popVec2();
            var temp = _this.pool.popVec2();
            var prismatic = def.joint1;
            _this.m_localAnchorC.set(prismatic.m_localAnchorA);
            _this.m_localAnchorA.set(prismatic.m_localAnchorB);
            _this.m_referenceAngleA = prismatic.m_referenceAngle;
            _this.m_localAxisC.set(prismatic.m_localXAxisA);
            var pC = _this.m_localAnchorC;
            Rot.mulToOutUnsafe(xfA.q, _this.m_localAnchorA, temp);
            temp.addLocal(xfA.p).subLocal(xfC.p);
            Rot.mulTransUnsafeVec2(xfC.q, temp, pA);
            coordinateA = Vec2.dot(pA.subLocal(pC), _this.m_localAxisC);
            _this.pool.pushVec2(2);
        }
        _this.m_bodyD = _this.m_joint2.getBodyA();
        _this.m_bodyB = _this.m_joint2.getBodyB();
        var xfB = _this.m_bodyB.m_xf;
        var aB = _this.m_bodyB.m_sweep.a;
        var xfD = _this.m_bodyD.m_xf;
        var aD = _this.m_bodyD.m_sweep.a;
        if (_this.m_typeB == JointType.REVOLUTE) {
            var revolute = def.joint2;
            _this.m_localAnchorD.set(revolute.m_localAnchorA);
            _this.m_localAnchorB.set(revolute.m_localAnchorB);
            _this.m_referenceAngleB = revolute.m_referenceAngle;
            _this.m_localAxisD.setZero();
            coordinateB = aB - aD - _this.m_referenceAngleB;
        }
        else {
            var pB = _this.pool.popVec2();
            var temp = _this.pool.popVec2();
            var prismatic = def.joint2;
            _this.m_localAnchorD.set(prismatic.m_localAnchorA);
            _this.m_localAnchorB.set(prismatic.m_localAnchorB);
            _this.m_referenceAngleB = prismatic.m_referenceAngle;
            _this.m_localAxisD.set(prismatic.m_localXAxisA);
            var pD = _this.m_localAnchorD;
            Rot.mulToOutUnsafe(xfB.q, _this.m_localAnchorB, temp);
            temp.addLocal(xfB.p).subLocal(xfD.p);
            Rot.mulTransUnsafeVec2(xfD.q, temp, pB);
            coordinateB = Vec2.dot(pB.subLocal(pD), _this.m_localAxisD);
            _this.pool.pushVec2(2);
        }
        _this.m_ratio = def.ratio;
        _this.m_constant = coordinateA + _this.m_ratio * coordinateB;
        _this.m_impulse = 0.0;
        return _this;
    }
    GearJoint.prototype.getAnchorA = function (argOut) {
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, argOut);
    };
    GearJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    GearJoint.prototype.getReactionForce = function (inv_dt, argOut) {
        argOut.set(this.m_JvAC).mulLocal(this.m_impulse);
        argOut.mulLocal(inv_dt);
    };
    GearJoint.prototype.getReactionTorque = function (inv_dt) {
        var L = this.m_impulse * this.m_JwA;
        return inv_dt * L;
    };
    GearJoint.prototype.setRatio = function (argRatio) {
        this.m_ratio = argRatio;
    };
    GearJoint.prototype.getRatio = function () {
        return this.m_ratio;
    };
    GearJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_indexC = this.m_bodyC.m_islandIndex;
        this.m_indexD = this.m_bodyD.m_islandIndex;
        this.m_lcA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_lcB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_lcC.set(this.m_bodyC.m_sweep.localCenter);
        this.m_lcD.set(this.m_bodyD.m_sweep.localCenter);
        this.m_mA = this.m_bodyA.m_invMass;
        this.m_mB = this.m_bodyB.m_invMass;
        this.m_mC = this.m_bodyC.m_invMass;
        this.m_mD = this.m_bodyD.m_invMass;
        this.m_iA = this.m_bodyA.m_invI;
        this.m_iB = this.m_bodyB.m_invI;
        this.m_iC = this.m_bodyC.m_invI;
        this.m_iD = this.m_bodyD.m_invI;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var aC = data.positions[this.m_indexC].a;
        var vC = data.velocities[this.m_indexC].v;
        var wC = data.velocities[this.m_indexC].w;
        var aD = data.positions[this.m_indexD].a;
        var vD = data.velocities[this.m_indexD].v;
        var wD = data.velocities[this.m_indexD].w;
        var qA = this.pool.popRot(), qB = this.pool.popRot(), qC = this.pool.popRot(), qD = this.pool.popRot();
        qA.setValue(aA);
        qB.setValue(aB);
        qC.setValue(aC);
        qD.setValue(aD);
        this.m_mass = 0.0;
        var temp = this.pool.popVec2();
        if (this.m_typeA == JointType.REVOLUTE) {
            this.m_JvAC.setZero();
            this.m_JwA = 1.0;
            this.m_JwC = 1.0;
            this.m_mass += this.m_iA + this.m_iC;
        }
        else {
            var rC = this.pool.popVec2();
            var rA = this.pool.popVec2();
            Rot.mulToOutUnsafe(qC, this.m_localAxisC, this.m_JvAC);
            Rot.mulToOutUnsafe(qC, temp.set(this.m_localAnchorC).subLocal(this.m_lcC), rC);
            Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_lcA), rA);
            this.m_JwC = Vec2.cross(rC, this.m_JvAC);
            this.m_JwA = Vec2.cross(rA, this.m_JvAC);
            this.m_mass += this.m_mC + this.m_mA + this.m_iC * this.m_JwC * this.m_JwC + this.m_iA * this.m_JwA * this.m_JwA;
            this.pool.pushVec2(2);
        }
        if (this.m_typeB == JointType.REVOLUTE) {
            this.m_JvBD.setZero();
            this.m_JwB = this.m_ratio;
            this.m_JwD = this.m_ratio;
            this.m_mass += this.m_ratio * this.m_ratio * (this.m_iB + this.m_iD);
        }
        else {
            var u = this.pool.popVec2();
            var rD = this.pool.popVec2();
            var rB = this.pool.popVec2();
            Rot.mulToOutUnsafe(qD, this.m_localAxisD, u);
            Rot.mulToOutUnsafe(qD, temp.set(this.m_localAnchorD).subLocal(this.m_lcD), rD);
            Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_lcB), rB);
            this.m_JvBD.set(u).mulLocal(this.m_ratio);
            this.m_JwD = this.m_ratio * Vec2.cross(rD, u);
            this.m_JwB = this.m_ratio * Vec2.cross(rB, u);
            this.m_mass += this.m_ratio * this.m_ratio * (this.m_mD + this.m_mB) + this.m_iD * this.m_JwD * this.m_JwD + this.m_iB * this.m_JwB * this.m_JwB;
            this.pool.pushVec2(3);
        }
        this.m_mass = this.m_mass > 0.0 ? 1.0 / this.m_mass : 0.0;
        if (data.step.warmStarting) {
            vA.x += (this.m_mA * this.m_impulse) * this.m_JvAC.x;
            vA.y += (this.m_mA * this.m_impulse) * this.m_JvAC.y;
            wA += this.m_iA * this.m_impulse * this.m_JwA;
            vB.x += (this.m_mB * this.m_impulse) * this.m_JvBD.x;
            vB.y += (this.m_mB * this.m_impulse) * this.m_JvBD.y;
            wB += this.m_iB * this.m_impulse * this.m_JwB;
            vC.x -= (this.m_mC * this.m_impulse) * this.m_JvAC.x;
            vC.y -= (this.m_mC * this.m_impulse) * this.m_JvAC.y;
            wC -= this.m_iC * this.m_impulse * this.m_JwC;
            vD.x -= (this.m_mD * this.m_impulse) * this.m_JvBD.x;
            vD.y -= (this.m_mD * this.m_impulse) * this.m_JvBD.y;
            wD -= this.m_iD * this.m_impulse * this.m_JwD;
        }
        else {
            this.m_impulse = 0.0;
        }
        this.pool.pushVec2(1);
        this.pool.pushRot(4);
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        data.velocities[this.m_indexC].w = wC;
        data.velocities[this.m_indexD].w = wD;
    };
    GearJoint.prototype.solveVelocityConstraints = function (data) {
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var vC = data.velocities[this.m_indexC].v;
        var wC = data.velocities[this.m_indexC].w;
        var vD = data.velocities[this.m_indexD].v;
        var wD = data.velocities[this.m_indexD].w;
        var temp1 = this.pool.popVec2();
        var temp2 = this.pool.popVec2();
        var Cdot = Vec2.dot(this.m_JvAC, temp1.set(vA).subLocal(vC)) + Vec2.dot(this.m_JvBD, temp2.set(vB).subLocal(vD));
        Cdot += (this.m_JwA * wA - this.m_JwC * wC) + (this.m_JwB * wB - this.m_JwD * wD);
        this.pool.pushVec2(2);
        var impulse = -this.m_mass * Cdot;
        this.m_impulse += impulse;
        vA.x += (this.m_mA * impulse) * this.m_JvAC.x;
        vA.y += (this.m_mA * impulse) * this.m_JvAC.y;
        wA += this.m_iA * impulse * this.m_JwA;
        vB.x += (this.m_mB * impulse) * this.m_JvBD.x;
        vB.y += (this.m_mB * impulse) * this.m_JvBD.y;
        wB += this.m_iB * impulse * this.m_JwB;
        vC.x -= (this.m_mC * impulse) * this.m_JvAC.x;
        vC.y -= (this.m_mC * impulse) * this.m_JvAC.y;
        wC -= this.m_iC * impulse * this.m_JwC;
        vD.x -= (this.m_mD * impulse) * this.m_JvBD.x;
        vD.y -= (this.m_mD * impulse) * this.m_JvBD.y;
        wD -= this.m_iD * impulse * this.m_JwD;
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        data.velocities[this.m_indexC].w = wC;
        data.velocities[this.m_indexD].w = wD;
    };
    GearJoint.prototype.getJoint1 = function () {
        return this.m_joint1;
    };
    GearJoint.prototype.getJoint2 = function () {
        return this.m_joint2;
    };
    GearJoint.prototype.solvePositionConstraints = function (data) {
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var cC = data.positions[this.m_indexC].c;
        var aC = data.positions[this.m_indexC].a;
        var cD = data.positions[this.m_indexD].c;
        var aD = data.positions[this.m_indexD].a;
        var qA = this.pool.popRot(), qB = this.pool.popRot(), qC = this.pool.popRot(), qD = this.pool.popRot();
        qA.setValue(aA);
        qB.setValue(aB);
        qC.setValue(aC);
        qD.setValue(aD);
        var linearError = 0.0;
        var coordinateA, coordinateB;
        var temp = this.pool.popVec2();
        var JvAC = this.pool.popVec2();
        var JvBD = this.pool.popVec2();
        var JwA, JwB, JwC, JwD;
        var mass = 0.0;
        if (this.m_typeA == JointType.REVOLUTE) {
            JvAC.setZero();
            JwA = 1.0;
            JwC = 1.0;
            mass += this.m_iA + this.m_iC;
            coordinateA = aA - aC - this.m_referenceAngleA;
        }
        else {
            var rC = this.pool.popVec2();
            var rA = this.pool.popVec2();
            var pC = this.pool.popVec2();
            var pA = this.pool.popVec2();
            Rot.mulToOutUnsafe(qC, this.m_localAxisC, JvAC);
            Rot.mulToOutUnsafe(qC, temp.set(this.m_localAnchorC).subLocal(this.m_lcC), rC);
            Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_lcA), rA);
            JwC = Vec2.cross(rC, JvAC);
            JwA = Vec2.cross(rA, JvAC);
            mass += this.m_mC + this.m_mA + this.m_iC * JwC * JwC + this.m_iA * JwA * JwA;
            pC.set(this.m_localAnchorC).subLocal(this.m_lcC);
            Rot.mulTransUnsafeVec2(qC, temp.set(rA).addLocal(cA).subLocal(cC), pA);
            coordinateA = Vec2.dot(pA.subLocal(pC), this.m_localAxisC);
            this.pool.pushVec2(4);
        }
        if (this.m_typeB == JointType.REVOLUTE) {
            JvBD.setZero();
            JwB = this.m_ratio;
            JwD = this.m_ratio;
            mass += this.m_ratio * this.m_ratio * (this.m_iB + this.m_iD);
            coordinateB = aB - aD - this.m_referenceAngleB;
        }
        else {
            var u = this.pool.popVec2();
            var rD = this.pool.popVec2();
            var rB = this.pool.popVec2();
            var pD = this.pool.popVec2();
            var pB = this.pool.popVec2();
            Rot.mulToOutUnsafe(qD, this.m_localAxisD, u);
            Rot.mulToOutUnsafe(qD, temp.set(this.m_localAnchorD).subLocal(this.m_lcD), rD);
            Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_lcB), rB);
            JvBD.set(u).mulLocal(this.m_ratio);
            JwD = Vec2.cross(rD, u);
            JwB = Vec2.cross(rB, u);
            mass += this.m_ratio * this.m_ratio * (this.m_mD + this.m_mB) + this.m_iD * JwD * JwD + this.m_iB * JwB * JwB;
            pD.set(this.m_localAnchorD).subLocal(this.m_lcD);
            Rot.mulTransUnsafeVec2(qD, temp.set(rB).addLocal(cB).subLocal(cD), pB);
            coordinateB = Vec2.dot(pB.subLocal(pD), this.m_localAxisD);
            this.pool.pushVec2(5);
        }
        var C = (coordinateA + this.m_ratio * coordinateB) - this.m_constant;
        var impulse = 0.0;
        if (mass > 0.0) {
            impulse = -C / mass;
        }
        this.pool.pushVec2(3);
        this.pool.pushRot(4);
        cA.x += (this.m_mA * impulse) * JvAC.x;
        cA.y += (this.m_mA * impulse) * JvAC.y;
        aA += this.m_iA * impulse * JwA;
        cB.x += (this.m_mB * impulse) * JvBD.x;
        cB.y += (this.m_mB * impulse) * JvBD.y;
        aB += this.m_iB * impulse * JwB;
        cC.x -= (this.m_mC * impulse) * JvAC.x;
        cC.y -= (this.m_mC * impulse) * JvAC.y;
        aC -= this.m_iC * impulse * JwC;
        cD.x -= (this.m_mD * impulse) * JvBD.x;
        cD.y -= (this.m_mD * impulse) * JvBD.y;
        aD -= this.m_iD * impulse * JwD;
        data.positions[this.m_indexA].a = aA;
        data.positions[this.m_indexB].a = aB;
        data.positions[this.m_indexC].a = aC;
        data.positions[this.m_indexD].a = aD;
        return linearError < Settings.linearSlop;
    };
    return GearJoint;
}(Joint));
var GearJointDef = (function (_super) {
    __extends(GearJointDef, _super);
    function GearJointDef() {
        var _this = _super.call(this, JointType.GEAR) || this;
        _this.joint1 = null;
        _this.joint2 = null;
        _this.ratio = 0;
        _this.joint1 = null;
        _this.joint2 = null;
        return _this;
    }
    return GearJointDef;
}(JointDef));
var Jacobian = (function () {
    function Jacobian() {
        this.linearA = new Vec2();
        this.angularA = 0;
        this.angularB = 0;
    }
    return Jacobian;
}());
var JointEdge = (function () {
    function JointEdge() {
        this.other = null;
        this.joint = null;
        this.prev = null;
        this.next = null;
    }
    return JointEdge;
}());
var JointType;
(function (JointType) {
    JointType[JointType["UNKNOWN"] = 0] = "UNKNOWN";
    JointType[JointType["REVOLUTE"] = 1] = "REVOLUTE";
    JointType[JointType["PRISMATIC"] = 2] = "PRISMATIC";
    JointType[JointType["DISTANCE"] = 3] = "DISTANCE";
    JointType[JointType["PULLEY"] = 4] = "PULLEY";
    JointType[JointType["MOUSE"] = 5] = "MOUSE";
    JointType[JointType["GEAR"] = 6] = "GEAR";
    JointType[JointType["WHEEL"] = 7] = "WHEEL";
    JointType[JointType["WELD"] = 8] = "WELD";
    JointType[JointType["FRICTION"] = 9] = "FRICTION";
    JointType[JointType["ROPE"] = 10] = "ROPE";
    JointType[JointType["CONSTANT_VOLUME"] = 11] = "CONSTANT_VOLUME";
    JointType[JointType["MOTOR"] = 12] = "MOTOR";
})(JointType || (JointType = {}));
var LimitState;
(function (LimitState) {
    LimitState[LimitState["INACTIVE"] = 0] = "INACTIVE";
    LimitState[LimitState["AT_LOWER"] = 1] = "AT_LOWER";
    LimitState[LimitState["AT_UPPER"] = 2] = "AT_UPPER";
    LimitState[LimitState["EQUAL"] = 3] = "EQUAL";
})(LimitState || (LimitState = {}));
var MotorJoint = (function (_super) {
    __extends(MotorJoint, _super);
    function MotorJoint(pool, def) {
        var _this = _super.call(this, pool, def) || this;
        _this.m_linearOffset = new Vec2();
        _this.m_angularOffset = 0;
        _this.m_linearImpulse = new Vec2();
        _this.m_angularImpulse = 0;
        _this.m_maxForce = 0;
        _this.m_maxTorque = 0;
        _this.m_correctionFactor = 0;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_rA = new Vec2();
        _this.m_rB = new Vec2();
        _this.m_localCenterA = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_linearError = new Vec2();
        _this.m_angularError = 0;
        _this.m_invMassA = 0;
        _this.m_invMassB = 0;
        _this.m_invIA = 0;
        _this.m_invIB = 0;
        _this.m_linearMass = new Mat22();
        _this.m_angularMass = 0;
        _this.m_linearOffset.set(def.linearOffset);
        _this.m_angularOffset = def.angularOffset;
        _this.m_angularImpulse = 0.0;
        _this.m_maxForce = def.maxForce;
        _this.m_maxTorque = def.maxTorque;
        _this.m_correctionFactor = def.correctionFactor;
        return _this;
    }
    MotorJoint.prototype.getAnchorA = function (outData) {
        outData.set(this.m_bodyA.getPosition());
    };
    MotorJoint.prototype.getAnchorB = function (outData) {
        outData.set(this.m_bodyB.getPosition());
    };
    MotorJoint.prototype.getReactionForce = function (inv_dt, outData) {
        outData.set(this.m_linearImpulse).mulLocal(inv_dt);
    };
    MotorJoint.prototype.getReactionTorque = function (inv_dt) {
        return this.m_angularImpulse * inv_dt;
    };
    MotorJoint.prototype.getCorrectionFactor = function () {
        return this.m_correctionFactor;
    };
    MotorJoint.prototype.setCorrectionFactor = function (correctionFactor) {
        this.m_correctionFactor = correctionFactor;
    };
    MotorJoint.prototype.setLinearOffset = function (linearOffset) {
        if (linearOffset.x != this.m_linearOffset.x || linearOffset.y != this.m_linearOffset.y) {
            this.m_bodyA.setAwake(true);
            this.m_bodyB.setAwake(true);
            this.m_linearOffset.set(linearOffset);
        }
    };
    MotorJoint.prototype.getLinearOffset = function (outData) {
        outData.set(this.m_linearOffset);
    };
    MotorJoint.prototype.getLinearOffset__2 = function () {
        return this.m_linearOffset;
    };
    MotorJoint.prototype.setAngularOffset = function (angularOffset) {
        if (angularOffset != this.m_angularOffset) {
            this.m_bodyA.setAwake(true);
            this.m_bodyB.setAwake(true);
            this.m_angularOffset = angularOffset;
        }
    };
    MotorJoint.prototype.getAngularOffset = function () {
        return this.m_angularOffset;
    };
    MotorJoint.prototype.setMaxForce = function (force) {
        this.m_maxForce = force;
    };
    MotorJoint.prototype.getMaxForce = function () {
        return this.m_maxForce;
    };
    MotorJoint.prototype.setMaxTorque = function (torque) {
        this.m_maxTorque = torque;
    };
    MotorJoint.prototype.getMaxTorque = function () {
        return this.m_maxTorque;
    };
    MotorJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassA = this.m_bodyA.m_invMass;
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIA = this.m_bodyA.m_invI;
        this.m_invIB = this.m_bodyB.m_invI;
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var temp = this.pool.popVec2();
        var K = this.pool.popMat22();
        qA.setValue(aA);
        qB.setValue(aB);
        this.m_rA.x = qA.c * (-this.m_localCenterA.x) - qA.s * (-this.m_localCenterA.y);
        this.m_rA.y = qA.s * (-this.m_localCenterA.x) + qA.c * (-this.m_localCenterA.y);
        this.m_rB.x = qB.c * (-this.m_localCenterB.x) - qB.s * (-this.m_localCenterB.y);
        this.m_rB.y = qB.s * (-this.m_localCenterB.x) + qB.c * (-this.m_localCenterB.y);
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        K.ex.x = mA + mB + iA * this.m_rA.y * this.m_rA.y + iB * this.m_rB.y * this.m_rB.y;
        K.ex.y = -iA * this.m_rA.x * this.m_rA.y - iB * this.m_rB.x * this.m_rB.y;
        K.ey.x = K.ex.y;
        K.ey.y = mA + mB + iA * this.m_rA.x * this.m_rA.x + iB * this.m_rB.x * this.m_rB.x;
        K.invertToOut(this.m_linearMass);
        this.m_angularMass = iA + iB;
        if (this.m_angularMass > 0.0) {
            this.m_angularMass = 1.0 / this.m_angularMass;
        }
        Rot.mulToOutUnsafe(qA, this.m_linearOffset, temp);
        this.m_linearError.x = cB.x + this.m_rB.x - cA.x - this.m_rA.x - temp.x;
        this.m_linearError.y = cB.y + this.m_rB.y - cA.y - this.m_rA.y - temp.y;
        this.m_angularError = aB - aA - this.m_angularOffset;
        if (data.step.warmStarting) {
            this.m_linearImpulse.x *= data.step.dtRatio;
            this.m_linearImpulse.y *= data.step.dtRatio;
            this.m_angularImpulse *= data.step.dtRatio;
            var P = this.m_linearImpulse;
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * (this.m_rA.x * P.y - this.m_rA.y * P.x + this.m_angularImpulse);
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * (this.m_rB.x * P.y - this.m_rB.y * P.x + this.m_angularImpulse);
        }
        else {
            this.m_linearImpulse.setZero();
            this.m_angularImpulse = 0.0;
        }
        this.pool.pushVec2(1);
        this.pool.pushMat22(1);
        this.pool.pushRot(2);
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
    };
    MotorJoint.prototype.solveVelocityConstraints = function (data) {
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        var h = data.step.dt;
        var inv_h = data.step.inv_dt;
        var temp = this.pool.popVec2();
        {
            var Cdot = wB - wA + inv_h * this.m_correctionFactor * this.m_angularError;
            var impulseN = -this.m_angularMass * Cdot;
            var oldImpulseN = this.m_angularImpulse;
            var maxImpulse = h * this.m_maxTorque;
            this.m_angularImpulse = MathUtils.clamp(this.m_angularImpulse + impulseN, -maxImpulse, maxImpulse);
            impulseN = this.m_angularImpulse - oldImpulseN;
            wA -= iA * impulseN;
            wB += iB * impulseN;
        }
        var Cdot2 = this.pool.popVec2();
        {
            Cdot2.x =
                vB.x + (-wB) * this.m_rB.y - vA.x - (-wA) * this.m_rA.y + inv_h * this.m_correctionFactor * this.m_linearError.x;
            Cdot2.y =
                vB.y + wB * this.m_rB.x - vA.y - wA * this.m_rA.x + inv_h * this.m_correctionFactor * this.m_linearError.y;
            var impulse = temp;
            Mat22.mulToOutUnsafeVec2(this.m_linearMass, Cdot2, impulse);
            impulse.negateLocal();
            var oldImpulse = this.pool.popVec2();
            oldImpulse.set(this.m_linearImpulse);
            this.m_linearImpulse.addLocal(impulse);
            var maxImpulse = h * this.m_maxForce;
            if (this.m_linearImpulse.lengthSquared() > maxImpulse * maxImpulse) {
                this.m_linearImpulse.normalize();
                this.m_linearImpulse.mulLocal(maxImpulse);
            }
            impulse.x = this.m_linearImpulse.x - oldImpulse.x;
            impulse.y = this.m_linearImpulse.y - oldImpulse.y;
            vA.x -= mA * impulse.x;
            vA.y -= mA * impulse.y;
            wA -= iA * (this.m_rA.x * impulse.y - this.m_rA.y * impulse.x);
            vB.x += mB * impulse.x;
            vB.y += mB * impulse.y;
            wB += iB * (this.m_rB.x * impulse.y - this.m_rB.y * impulse.x);
        }
        this.pool.pushVec2(3);
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
    };
    MotorJoint.prototype.solvePositionConstraints = function (data) {
        return true;
    };
    return MotorJoint;
}(Joint));
var MotorJointDef = (function (_super) {
    __extends(MotorJointDef, _super);
    function MotorJointDef() {
        var _this = _super.call(this, JointType.MOTOR) || this;
        _this.linearOffset = new Vec2();
        _this.angularOffset = 0;
        _this.maxForce = 1;
        _this.maxTorque = 1;
        _this.correctionFactor = 0.3;
        return _this;
    }
    MotorJointDef.prototype.initialize = function (bA, bB) {
        this.bodyA = bA;
        this.bodyB = bB;
        var xB = this.bodyB.getPosition();
        this.bodyA.getLocalPointToOut(xB, this.linearOffset);
        var angleA = this.bodyA.getAngle();
        var angleB = this.bodyB.getAngle();
        this.angularOffset = angleB - angleA;
    };
    return MotorJointDef;
}(JointDef));
var MouseJoint = (function (_super) {
    __extends(MouseJoint, _super);
    function MouseJoint(argWorld, def) {
        var _this = _super.call(this, argWorld, def) || this;
        _this.m_localAnchorB = new Vec2();
        _this.m_targetA = new Vec2();
        _this.m_frequencyHz = 0;
        _this.m_dampingRatio = 0;
        _this.m_beta = 0;
        _this.m_impulse = new Vec2();
        _this.m_maxForce = 0;
        _this.m_gamma = 0;
        _this.m_indexB = 0;
        _this.m_rB = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_invMassB = 0;
        _this.m_invIB = 0;
        _this.m_mass = new Mat22();
        _this.m_C = new Vec2();
        _this.m_targetA.set(def.target);
        Transform.mulTransToOutUnsafeVec2(_this.m_bodyB.getTransform(), _this.m_targetA, _this.m_localAnchorB);
        _this.m_maxForce = def.maxForce;
        _this.m_impulse.setZero();
        _this.m_frequencyHz = def.frequencyHz;
        _this.m_dampingRatio = def.dampingRatio;
        _this.m_beta = 0;
        _this.m_gamma = 0;
        return _this;
    }
    MouseJoint.prototype.getAnchorA = function (argOut) {
        argOut.set(this.m_targetA);
    };
    MouseJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    MouseJoint.prototype.getReactionForce = function (invDt, argOut) {
        argOut.set(this.m_impulse).mulLocal(invDt);
    };
    MouseJoint.prototype.getReactionTorque = function (invDt) {
        return invDt * 0.0;
    };
    MouseJoint.prototype.setTarget = function (target) {
        if (this.m_bodyB.isAwake() == false) {
            this.m_bodyB.setAwake(true);
        }
        this.m_targetA.set(target);
    };
    MouseJoint.prototype.getTarget = function () {
        return this.m_targetA;
    };
    MouseJoint.prototype.setMaxForce = function (force) {
        this.m_maxForce = force;
    };
    MouseJoint.prototype.getMaxForce = function () {
        return this.m_maxForce;
    };
    MouseJoint.prototype.setFrequency = function (hz) {
        this.m_frequencyHz = hz;
    };
    MouseJoint.prototype.getFrequency = function () {
        return this.m_frequencyHz;
    };
    MouseJoint.prototype.setDampingRatio = function (ratio) {
        this.m_dampingRatio = ratio;
    };
    MouseJoint.prototype.getDampingRatio = function () {
        return this.m_dampingRatio;
    };
    MouseJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIB = this.m_bodyB.m_invI;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var qB = this.pool.popRot();
        qB.setValue(aB);
        var mass = this.m_bodyB.getMass();
        var omega = 2.0 * MathUtils.PI * this.m_frequencyHz;
        var d = 2.0 * mass * this.m_dampingRatio * omega;
        var k = mass * (omega * omega);
        var h = data.step.dt;
        this.m_gamma = h * (d + h * k);
        if (this.m_gamma != 0.0) {
            this.m_gamma = 1.0 / this.m_gamma;
        }
        this.m_beta = h * k * this.m_gamma;
        var temp = this.pool.popVec2();
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), this.m_rB);
        var K = this.pool.popMat22();
        K.ex.x = this.m_invMassB + this.m_invIB * this.m_rB.y * this.m_rB.y + this.m_gamma;
        K.ex.y = -this.m_invIB * this.m_rB.x * this.m_rB.y;
        K.ey.x = K.ex.y;
        K.ey.y = this.m_invMassB + this.m_invIB * this.m_rB.x * this.m_rB.x + this.m_gamma;
        K.invertToOut(this.m_mass);
        this.m_C.set(cB).addLocal(this.m_rB).subLocal(this.m_targetA);
        this.m_C.mulLocal(this.m_beta);
        wB *= 0.98;
        if (data.step.warmStarting) {
            this.m_impulse.mulLocal(data.step.dtRatio);
            vB.x += this.m_invMassB * this.m_impulse.x;
            vB.y += this.m_invMassB * this.m_impulse.y;
            wB += this.m_invIB * Vec2.cross(this.m_rB, this.m_impulse);
        }
        else {
            this.m_impulse.setZero();
        }
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(1);
        this.pool.pushMat22(1);
        this.pool.pushRot(1);
    };
    MouseJoint.prototype.solvePositionConstraints = function (data) {
        return true;
    };
    MouseJoint.prototype.solveVelocityConstraints = function (data) {
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var Cdot = this.pool.popVec2();
        Vec2.crossToOutUnsafe(this.m_rB, -wB, Cdot);
        Cdot.addLocal(vB);
        var impulse = this.pool.popVec2();
        var temp = this.pool.popVec2();
        temp.set(this.m_impulse).mulLocal(this.m_gamma).addLocal(this.m_C).addLocal(Cdot).negateLocal();
        Mat22.mulToOutUnsafeVec2(this.m_mass, temp, impulse);
        var oldImpulse = temp;
        oldImpulse.set(this.m_impulse);
        this.m_impulse.addLocal(impulse);
        var maxImpulse = data.step.dt * this.m_maxForce;
        if (this.m_impulse.lengthSquared() > maxImpulse * maxImpulse) {
            this.m_impulse.mulLocal(maxImpulse / this.m_impulse.length());
        }
        impulse.set(this.m_impulse).subLocal(oldImpulse);
        vB.x += this.m_invMassB * impulse.x;
        vB.y += this.m_invMassB * impulse.y;
        wB += this.m_invIB * Vec2.cross(this.m_rB, impulse);
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(3);
    };
    return MouseJoint;
}(Joint));
var MouseJointDef = (function (_super) {
    __extends(MouseJointDef, _super);
    function MouseJointDef() {
        var _this = _super.call(this, JointType.MOUSE) || this;
        _this.target = new Vec2();
        _this.target.setValue(0, 0);
        _this.maxForce = 0;
        _this.frequencyHz = 5;
        _this.dampingRatio = 0.7;
        return _this;
    }
    return MouseJointDef;
}(JointDef));
var PrismaticJoint = (function (_super) {
    __extends(PrismaticJoint, _super);
    function PrismaticJoint(argWorld, def) {
        var _this = _super.call(this, argWorld, def) || this;
        _this.m_localAnchorA = null;
        _this.m_localAnchorB = null;
        _this.m_localXAxisA = null;
        _this.m_localYAxisA = null;
        _this.m_referenceAngle = 0;
        _this.m_impulse = null;
        _this.m_motorImpulse = 0;
        _this.m_lowerTranslation = 0;
        _this.m_upperTranslation = 0;
        _this.m_maxMotorForce = 0;
        _this.m_motorSpeed = 0;
        _this.m_enableLimit = false;
        _this.m_enableMotor = false;
        _this.m_limitState = null;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_localCenterA = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_invMassA = 0;
        _this.m_invMassB = 0;
        _this.m_invIA = 0;
        _this.m_invIB = 0;
        _this.m_axis = null;
        _this.m_perp = null;
        _this.m_s1 = 0;
        _this.m_s2 = 0;
        _this.m_a1 = 0;
        _this.m_a2 = 0;
        _this.m_K = null;
        _this.m_motorMass = 0;
        _this.m_localAnchorA = new Vec2().set(def.localAnchorA);
        _this.m_localAnchorB = new Vec2().set(def.localAnchorB);
        _this.m_localXAxisA = new Vec2().set(def.localAxisA);
        _this.m_localXAxisA.normalize();
        _this.m_localYAxisA = new Vec2();
        Vec2.crossToOutUnsafe(_this.m_localXAxisA, -1.0, _this.m_localYAxisA);
        _this.m_referenceAngle = def.referenceAngle;
        _this.m_impulse = new Vec3();
        _this.m_motorMass = 0.0;
        _this.m_motorImpulse = 0.0;
        _this.m_lowerTranslation = def.lowerTranslation;
        _this.m_upperTranslation = def.upperTranslation;
        _this.m_maxMotorForce = def.maxMotorForce;
        _this.m_motorSpeed = def.motorSpeed;
        _this.m_enableLimit = def.enableLimit;
        _this.m_enableMotor = def.enableMotor;
        _this.m_limitState = LimitState.INACTIVE;
        _this.m_K = new Mat33();
        _this.m_axis = new Vec2();
        _this.m_perp = new Vec2();
        return _this;
    }
    PrismaticJoint.prototype.getLocalAnchorA = function () {
        return this.m_localAnchorA;
    };
    PrismaticJoint.prototype.getLocalAnchorB = function () {
        return this.m_localAnchorB;
    };
    PrismaticJoint.prototype.getAnchorA = function (argOut) {
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, argOut);
    };
    PrismaticJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    PrismaticJoint.prototype.getReactionForce = function (inv_dt, argOut) {
        var temp = this.pool.popVec2();
        temp.set(this.m_axis).mulLocal(this.m_motorImpulse + this.m_impulse.z);
        argOut.set(this.m_perp).mulLocal(this.m_impulse.x).addLocal(temp).mulLocal(inv_dt);
        this.pool.pushVec2(1);
    };
    PrismaticJoint.prototype.getReactionTorque = function (inv_dt) {
        return inv_dt * this.m_impulse.y;
    };
    PrismaticJoint.prototype.getJointSpeed = function () {
        var bA = this.m_bodyA;
        var bB = this.m_bodyB;
        var temp = this.pool.popVec2();
        var rA = this.pool.popVec2();
        var rB = this.pool.popVec2();
        var p1 = this.pool.popVec2();
        var p2 = this.pool.popVec2();
        var d = this.pool.popVec2();
        var axis = this.pool.popVec2();
        var temp2 = this.pool.popVec2();
        var temp3 = this.pool.popVec2();
        temp.set(this.m_localAnchorA).subLocal(bA.m_sweep.localCenter);
        Rot.mulToOutUnsafe(bA.m_xf.q, temp, rA);
        temp.set(this.m_localAnchorB).subLocal(bB.m_sweep.localCenter);
        Rot.mulToOutUnsafe(bB.m_xf.q, temp, rB);
        p1.set(bA.m_sweep.c).addLocal(rA);
        p2.set(bB.m_sweep.c).addLocal(rB);
        d.set(p2).subLocal(p1);
        Rot.mulToOutUnsafe(bA.m_xf.q, this.m_localXAxisA, axis);
        var vA = bA.m_linearVelocity;
        var vB = bB.m_linearVelocity;
        var wA = bA.m_angularVelocity;
        var wB = bB.m_angularVelocity;
        Vec2.crossToOutUnsafe(axis, -wA, temp);
        Vec2.crossToOutUnsafe(rB, -wB, temp2);
        Vec2.crossToOutUnsafe(rA, -wA, temp3);
        temp2.addLocal(vB).subLocal(vA).subLocal(temp3);
        var speed = Vec2.dot(d, temp) + Vec2.dot(axis, temp2);
        this.pool.pushVec2(9);
        return speed;
    };
    PrismaticJoint.prototype.getJointTranslation = function () {
        var pA = this.pool.popVec2(), pB = this.pool.popVec2(), axis = this.pool.popVec2();
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, pA);
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, pB);
        this.m_bodyA.getWorldVectorToOutUnsafe(this.m_localXAxisA, axis);
        pB.subLocal(pA);
        var translation = Vec2.dot(pB, axis);
        this.pool.pushVec2(3);
        return translation;
    };
    PrismaticJoint.prototype.isLimitEnabled = function () {
        return this.m_enableLimit;
    };
    PrismaticJoint.prototype.enableLimit = function (flag) {
        if (flag != this.m_enableLimit) {
            this.m_bodyA.setAwake(true);
            this.m_bodyB.setAwake(true);
            this.m_enableLimit = flag;
            this.m_impulse.z = 0.0;
        }
    };
    PrismaticJoint.prototype.getLowerLimit = function () {
        return this.m_lowerTranslation;
    };
    PrismaticJoint.prototype.getUpperLimit = function () {
        return this.m_upperTranslation;
    };
    PrismaticJoint.prototype.setLimits = function (lower, upper) {
        if (lower != this.m_lowerTranslation || upper != this.m_upperTranslation) {
            this.m_bodyA.setAwake(true);
            this.m_bodyB.setAwake(true);
            this.m_lowerTranslation = lower;
            this.m_upperTranslation = upper;
            this.m_impulse.z = 0.0;
        }
    };
    PrismaticJoint.prototype.isMotorEnabled = function () {
        return this.m_enableMotor;
    };
    PrismaticJoint.prototype.enableMotor = function (flag) {
        this.m_bodyA.setAwake(true);
        this.m_bodyB.setAwake(true);
        this.m_enableMotor = flag;
    };
    PrismaticJoint.prototype.setMotorSpeed = function (speed) {
        this.m_bodyA.setAwake(true);
        this.m_bodyB.setAwake(true);
        this.m_motorSpeed = speed;
    };
    PrismaticJoint.prototype.getMotorSpeed = function () {
        return this.m_motorSpeed;
    };
    PrismaticJoint.prototype.setMaxMotorForce = function (force) {
        this.m_bodyA.setAwake(true);
        this.m_bodyB.setAwake(true);
        this.m_maxMotorForce = force;
    };
    PrismaticJoint.prototype.getMotorForce = function (inv_dt) {
        return this.m_motorImpulse * inv_dt;
    };
    PrismaticJoint.prototype.getMaxMotorForce = function () {
        return this.m_maxMotorForce;
    };
    PrismaticJoint.prototype.getReferenceAngle = function () {
        return this.m_referenceAngle;
    };
    PrismaticJoint.prototype.getLocalAxisA = function () {
        return this.m_localXAxisA;
    };
    PrismaticJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassA = this.m_bodyA.m_invMass;
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIA = this.m_bodyA.m_invI;
        this.m_invIB = this.m_bodyB.m_invI;
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var d = this.pool.popVec2();
        var temp = this.pool.popVec2();
        var rA = this.pool.popVec2();
        var rB = this.pool.popVec2();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, d.set(this.m_localAnchorA).subLocal(this.m_localCenterA), rA);
        Rot.mulToOutUnsafe(qB, d.set(this.m_localAnchorB).subLocal(this.m_localCenterB), rB);
        d.set(cB).subLocal(cA).addLocal(rB).subLocal(rA);
        var mA = this.m_invMassA;
        var mB = this.m_invMassB;
        var iA = this.m_invIA;
        var iB = this.m_invIB;
        {
            Rot.mulToOutUnsafe(qA, this.m_localXAxisA, this.m_axis);
            temp.set(d).addLocal(rA);
            this.m_a1 = Vec2.cross(temp, this.m_axis);
            this.m_a2 = Vec2.cross(rB, this.m_axis);
            this.m_motorMass = mA + mB + iA * this.m_a1 * this.m_a1 + iB * this.m_a2 * this.m_a2;
            if (this.m_motorMass > 0.0) {
                this.m_motorMass = 1.0 / this.m_motorMass;
            }
        }
        {
            Rot.mulToOutUnsafe(qA, this.m_localYAxisA, this.m_perp);
            temp.set(d).addLocal(rA);
            this.m_s1 = Vec2.cross(temp, this.m_perp);
            this.m_s2 = Vec2.cross(rB, this.m_perp);
            var k11 = mA + mB + iA * this.m_s1 * this.m_s1 + iB * this.m_s2 * this.m_s2;
            var k12 = iA * this.m_s1 + iB * this.m_s2;
            var k13 = iA * this.m_s1 * this.m_a1 + iB * this.m_s2 * this.m_a2;
            var k22 = iA + iB;
            if (k22 == 0.0) {
                k22 = 1.0;
            }
            var k23 = iA * this.m_a1 + iB * this.m_a2;
            var k33 = mA + mB + iA * this.m_a1 * this.m_a1 + iB * this.m_a2 * this.m_a2;
            this.m_K.ex.setValue(k11, k12, k13);
            this.m_K.ey.setValue(k12, k22, k23);
            this.m_K.ez.setValue(k13, k23, k33);
        }
        if (this.m_enableLimit) {
            var jointTranslation = Vec2.dot(this.m_axis, d);
            if (dMath.Abs(this.m_upperTranslation - this.m_lowerTranslation) < 2.0 * Settings.linearSlop) {
                this.m_limitState = LimitState.EQUAL;
            }
            else if (jointTranslation <= this.m_lowerTranslation) {
                if (this.m_limitState != LimitState.AT_LOWER) {
                    this.m_limitState = LimitState.AT_LOWER;
                    this.m_impulse.z = 0.0;
                }
            }
            else if (jointTranslation >= this.m_upperTranslation) {
                if (this.m_limitState != LimitState.AT_UPPER) {
                    this.m_limitState = LimitState.AT_UPPER;
                    this.m_impulse.z = 0.0;
                }
            }
            else {
                this.m_limitState = LimitState.INACTIVE;
                this.m_impulse.z = 0.0;
            }
        }
        else {
            this.m_limitState = LimitState.INACTIVE;
            this.m_impulse.z = 0.0;
        }
        if (this.m_enableMotor == false) {
            this.m_motorImpulse = 0.0;
        }
        if (data.step.warmStarting) {
            this.m_impulse.mulLocal(data.step.dtRatio);
            this.m_motorImpulse *= data.step.dtRatio;
            var P = this.pool.popVec2();
            temp.set(this.m_axis).mulLocal(this.m_motorImpulse + this.m_impulse.z);
            P.set(this.m_perp).mulLocal(this.m_impulse.x).addLocal(temp);
            var LA = this.m_impulse.x * this.m_s1 + this.m_impulse.y + (this.m_motorImpulse + this.m_impulse.z) * this.m_a1;
            var LB = this.m_impulse.x * this.m_s2 + this.m_impulse.y + (this.m_motorImpulse + this.m_impulse.z) * this.m_a2;
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * LA;
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * LB;
            this.pool.pushVec2(1);
        }
        else {
            this.m_impulse.setZero();
            this.m_motorImpulse = 0.0;
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushRot(2);
        this.pool.pushVec2(4);
    };
    PrismaticJoint.prototype.solveVelocityConstraints = function (data) {
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        var temp = this.pool.popVec2();
        if (this.m_enableMotor && this.m_limitState != LimitState.EQUAL) {
            temp.set(vB).subLocal(vA);
            var Cdot = Vec2.dot(this.m_axis, temp) + this.m_a2 * wB - this.m_a1 * wA;
            var impulse = this.m_motorMass * (this.m_motorSpeed - Cdot);
            var oldImpulse = this.m_motorImpulse;
            var maxImpulse = data.step.dt * this.m_maxMotorForce;
            this.m_motorImpulse = MathUtils.clamp(this.m_motorImpulse + impulse, -maxImpulse, maxImpulse);
            impulse = this.m_motorImpulse - oldImpulse;
            var P = this.pool.popVec2();
            P.set(this.m_axis).mulLocal(impulse);
            var LA = impulse * this.m_a1;
            var LB = impulse * this.m_a2;
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * LA;
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * LB;
            this.pool.pushVec2(1);
        }
        var Cdot1 = this.pool.popVec2();
        temp.set(vB).subLocal(vA);
        Cdot1.x = Vec2.dot(this.m_perp, temp) + this.m_s2 * wB - this.m_s1 * wA;
        Cdot1.y = wB - wA;
        if (this.m_enableLimit && this.m_limitState != LimitState.INACTIVE) {
            var CdotN;
            temp.set(vB).subLocal(vA);
            CdotN = Vec2.dot(this.m_axis, temp) + this.m_a2 * wB - this.m_a1 * wA;
            var Cdot2 = this.pool.popVec3();
            Cdot2.setValue(Cdot1.x, Cdot1.y, CdotN);
            var f1 = this.pool.popVec3();
            var df = this.pool.popVec3();
            f1.set(this.m_impulse);
            this.m_K.solve33ToOut(Cdot2.negateLocal(), df);
            this.m_impulse.addLocal(df);
            if (this.m_limitState == LimitState.AT_LOWER) {
                this.m_impulse.z = dMath.Max(this.m_impulse.z, 0.0);
            }
            else if (this.m_limitState == LimitState.AT_UPPER) {
                this.m_impulse.z = dMath.Min(this.m_impulse.z, 0.0);
            }
            var b = this.pool.popVec2();
            var f2r = this.pool.popVec2();
            temp.setValue(this.m_K.ez.x, this.m_K.ez.y).mulLocal(this.m_impulse.z - f1.z);
            b.set(Cdot1).negateLocal().subLocal(temp);
            this.m_K.solve22ToOut(b, f2r);
            f2r.addLocalValue(f1.x, f1.y);
            this.m_impulse.x = f2r.x;
            this.m_impulse.y = f2r.y;
            df.set(this.m_impulse).subLocal(f1);
            var P = this.pool.popVec2();
            temp.set(this.m_axis).mulLocal(df.z);
            P.set(this.m_perp).mulLocal(df.x).addLocal(temp);
            var LA = df.x * this.m_s1 + df.y + df.z * this.m_a1;
            var LB = df.x * this.m_s2 + df.y + df.z * this.m_a2;
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * LA;
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * LB;
            this.pool.pushVec2(3);
            this.pool.pushVec3(3);
        }
        else {
            var df2 = this.pool.popVec2();
            this.m_K.solve22ToOut(Cdot1.negateLocal(), df2);
            Cdot1.negateLocal();
            this.m_impulse.x += df2.x;
            this.m_impulse.y += df2.y;
            var P = this.pool.popVec2();
            P.set(this.m_perp).mulLocal(df2.x);
            var LA = df2.x * this.m_s1 + df2.y;
            var LB = df2.x * this.m_s2 + df2.y;
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * LA;
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * LB;
            this.pool.pushVec2(2);
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(2);
    };
    PrismaticJoint.prototype.solvePositionConstraints = function (data) {
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var rA = this.pool.popVec2();
        var rB = this.pool.popVec2();
        var d = this.pool.popVec2();
        var axis = this.pool.popVec2();
        var perp = this.pool.popVec2();
        var temp = this.pool.popVec2();
        var C1 = this.pool.popVec2();
        var impulse = this.pool.popVec3();
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        qA.setValue(aA);
        qB.setValue(aB);
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), rB);
        d.set(cB).addLocal(rB).subLocal(cA).subLocal(rA);
        Rot.mulToOutUnsafe(qA, this.m_localXAxisA, axis);
        var a1 = Vec2.cross(temp.set(d).addLocal(rA), axis);
        var a2 = Vec2.cross(rB, axis);
        Rot.mulToOutUnsafe(qA, this.m_localYAxisA, perp);
        var s1 = Vec2.cross(temp.set(d).addLocal(rA), perp);
        var s2 = Vec2.cross(rB, perp);
        C1.x = Vec2.dot(perp, d);
        C1.y = aB - aA - this.m_referenceAngle;
        var linearError = dMath.Abs(C1.x);
        var angularError = dMath.Abs(C1.y);
        var active = false;
        var C2 = 0.0;
        if (this.m_enableLimit) {
            var translation = Vec2.dot(axis, d);
            if (dMath.Abs(this.m_upperTranslation - this.m_lowerTranslation) < 2.0 * Settings.linearSlop) {
                C2 = MathUtils.clamp(translation, -Settings.maxLinearCorrection, Settings.maxLinearCorrection);
                linearError = dMath.Max(linearError, dMath.Abs(translation));
                active = true;
            }
            else if (translation <= this.m_lowerTranslation) {
                C2 = MathUtils.clamp(translation - this.m_lowerTranslation + Settings.linearSlop, -Settings.maxLinearCorrection, 0.0);
                linearError = dMath.Max(linearError, this.m_lowerTranslation - translation);
                active = true;
            }
            else if (translation >= this.m_upperTranslation) {
                C2 = MathUtils.clamp(translation - this.m_upperTranslation - Settings.linearSlop, 0.0, Settings.maxLinearCorrection);
                linearError = dMath.Max(linearError, translation - this.m_upperTranslation);
                active = true;
            }
        }
        if (active) {
            var k11 = mA + mB + iA * s1 * s1 + iB * s2 * s2;
            var k12 = iA * s1 + iB * s2;
            var k13 = iA * s1 * a1 + iB * s2 * a2;
            var k22 = iA + iB;
            if (k22 == 0.0) {
                k22 = 1.0;
            }
            var k23 = iA * a1 + iB * a2;
            var k33 = mA + mB + iA * a1 * a1 + iB * a2 * a2;
            var K3 = this.pool.popMat33();
            K3.ex.setValue(k11, k12, k13);
            K3.ey.setValue(k12, k22, k23);
            K3.ez.setValue(k13, k23, k33);
            var C = this.pool.popVec3();
            C.x = C1.x;
            C.y = C1.y;
            C.z = C2;
            K3.solve33ToOut(C.negateLocal(), impulse);
            this.pool.pushVec3(1);
            this.pool.pushMat33(1);
        }
        else {
            var k11 = mA + mB + iA * s1 * s1 + iB * s2 * s2;
            var k12 = iA * s1 + iB * s2;
            var k22 = iA + iB;
            if (k22 == 0.0) {
                k22 = 1.0;
            }
            var K = this.pool.popMat22();
            K.ex.setValue(k11, k12);
            K.ey.setValue(k12, k22);
            K.solveToOut(C1.negateLocal(), temp);
            C1.negateLocal();
            impulse.x = temp.x;
            impulse.y = temp.y;
            impulse.z = 0.0;
            this.pool.pushMat22(1);
        }
        var Px = impulse.x * perp.x + impulse.z * axis.x;
        var Py = impulse.x * perp.y + impulse.z * axis.y;
        var LA = impulse.x * s1 + impulse.y + impulse.z * a1;
        var LB = impulse.x * s2 + impulse.y + impulse.z * a2;
        cA.x -= mA * Px;
        cA.y -= mA * Py;
        aA -= iA * LA;
        cB.x += mB * Px;
        cB.y += mB * Py;
        aB += iB * LB;
        data.positions[this.m_indexA].a = aA;
        data.positions[this.m_indexB].a = aB;
        this.pool.pushVec2(7);
        this.pool.pushVec3(1);
        this.pool.pushRot(2);
        return linearError <= Settings.linearSlop && angularError <= Settings.angularSlop;
    };
    return PrismaticJoint;
}(Joint));
var PrismaticJointDef = (function (_super) {
    __extends(PrismaticJointDef, _super);
    function PrismaticJointDef() {
        var _this = _super.call(this, JointType.PRISMATIC) || this;
        _this.localAnchorA = new Vec2();
        _this.localAnchorB = new Vec2();
        _this.localAxisA = new Vec2(1.0, 0.0);
        _this.referenceAngle = 0.0;
        _this.enableLimit = false;
        _this.lowerTranslation = 0.0;
        _this.upperTranslation = 0.0;
        _this.enableMotor = false;
        _this.maxMotorForce = 0.0;
        _this.motorSpeed = 0.0;
        return _this;
    }
    PrismaticJointDef.prototype.initialize = function (b1, b2, anchor, axis) {
        this.bodyA = b1;
        this.bodyB = b2;
        this.bodyA.getLocalPointToOut(anchor, this.localAnchorA);
        this.bodyB.getLocalPointToOut(anchor, this.localAnchorB);
        this.bodyA.getLocalVectorToOut(axis, this.localAxisA);
        this.referenceAngle = this.bodyB.getAngle() - this.bodyA.getAngle();
    };
    return PrismaticJointDef;
}(JointDef));
var PulleyJoint = (function (_super) {
    __extends(PulleyJoint, _super);
    function PulleyJoint(argWorldPool, def) {
        var _this = _super.call(this, argWorldPool, def) || this;
        _this.m_groundAnchorA = new Vec2();
        _this.m_groundAnchorB = new Vec2();
        _this.m_lengthA = 0;
        _this.m_lengthB = 0;
        _this.m_localAnchorA = new Vec2();
        _this.m_localAnchorB = new Vec2();
        _this.m_constant = 0;
        _this.m_ratio = 0;
        _this.m_impulse = 0;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_uA = new Vec2();
        _this.m_uB = new Vec2();
        _this.m_rA = new Vec2();
        _this.m_rB = new Vec2();
        _this.m_localCenterA = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_invMassA = 0;
        _this.m_invMassB = 0;
        _this.m_invIA = 0;
        _this.m_invIB = 0;
        _this.m_mass = 0;
        _this.m_groundAnchorA.set(def.groundAnchorA);
        _this.m_groundAnchorB.set(def.groundAnchorB);
        _this.m_localAnchorA.set(def.localAnchorA);
        _this.m_localAnchorB.set(def.localAnchorB);
        _this.m_ratio = def.ratio;
        _this.m_lengthA = def.lengthA;
        _this.m_lengthB = def.lengthB;
        _this.m_constant = def.lengthA + _this.m_ratio * def.lengthB;
        _this.m_impulse = 0.0;
        return _this;
    }
    PulleyJoint.prototype.getLengthA = function () {
        return this.m_lengthA;
    };
    PulleyJoint.prototype.getLengthB = function () {
        return this.m_lengthB;
    };
    PulleyJoint.prototype.getCurrentLengthA = function () {
        var p = this.pool.popVec2();
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, p);
        p.subLocal(this.m_groundAnchorA);
        var length = p.length();
        this.pool.pushVec2(1);
        return length;
    };
    PulleyJoint.prototype.getCurrentLengthB = function () {
        var p = this.pool.popVec2();
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, p);
        p.subLocal(this.m_groundAnchorB);
        var length = p.length();
        this.pool.pushVec2(1);
        return length;
    };
    PulleyJoint.prototype.getLocalAnchorA = function () {
        return this.m_localAnchorA;
    };
    PulleyJoint.prototype.getLocalAnchorB = function () {
        return this.m_localAnchorB;
    };
    PulleyJoint.prototype.getAnchorA = function (argOut) {
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, argOut);
    };
    PulleyJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    PulleyJoint.prototype.getReactionForce = function (inv_dt, argOut) {
        argOut.set(this.m_uB).mulLocal(this.m_impulse).mulLocal(inv_dt);
    };
    PulleyJoint.prototype.getReactionTorque = function (inv_dt) {
        return 0;
    };
    PulleyJoint.prototype.getGroundAnchorA = function () {
        return this.m_groundAnchorA;
    };
    PulleyJoint.prototype.getGroundAnchorB = function () {
        return this.m_groundAnchorB;
    };
    PulleyJoint.prototype.getLength1 = function () {
        var p = this.pool.popVec2();
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, p);
        p.subLocal(this.m_groundAnchorA);
        var len = p.length();
        this.pool.pushVec2(1);
        return len;
    };
    PulleyJoint.prototype.getLength2 = function () {
        var p = this.pool.popVec2();
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, p);
        p.subLocal(this.m_groundAnchorB);
        var len = p.length();
        this.pool.pushVec2(1);
        return len;
    };
    PulleyJoint.prototype.getRatio = function () {
        return this.m_ratio;
    };
    PulleyJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassA = this.m_bodyA.m_invMass;
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIA = this.m_bodyA.m_invI;
        this.m_invIB = this.m_bodyB.m_invI;
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var temp = this.pool.popVec2();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), this.m_rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), this.m_rB);
        this.m_uA.set(cA).addLocal(this.m_rA).subLocal(this.m_groundAnchorA);
        this.m_uB.set(cB).addLocal(this.m_rB).subLocal(this.m_groundAnchorB);
        var lengthA = this.m_uA.length();
        var lengthB = this.m_uB.length();
        if (lengthA > 10 * Settings.linearSlop) {
            this.m_uA.mulLocal(1.0 / lengthA);
        }
        else {
            this.m_uA.setZero();
        }
        if (lengthB > 10 * Settings.linearSlop) {
            this.m_uB.mulLocal(1.0 / lengthB);
        }
        else {
            this.m_uB.setZero();
        }
        var ruA = Vec2.cross(this.m_rA, this.m_uA);
        var ruB = Vec2.cross(this.m_rB, this.m_uB);
        var mA = this.m_invMassA + this.m_invIA * ruA * ruA;
        var mB = this.m_invMassB + this.m_invIB * ruB * ruB;
        this.m_mass = mA + this.m_ratio * this.m_ratio * mB;
        if (this.m_mass > 0.0) {
            this.m_mass = 1.0 / this.m_mass;
        }
        if (data.step.warmStarting) {
            this.m_impulse *= data.step.dtRatio;
            var PA = this.pool.popVec2();
            var PB = this.pool.popVec2();
            PA.set(this.m_uA).mulLocal(-this.m_impulse);
            PB.set(this.m_uB).mulLocal(-this.m_ratio * this.m_impulse);
            vA.x += this.m_invMassA * PA.x;
            vA.y += this.m_invMassA * PA.y;
            wA += this.m_invIA * Vec2.cross(this.m_rA, PA);
            vB.x += this.m_invMassB * PB.x;
            vB.y += this.m_invMassB * PB.y;
            wB += this.m_invIB * Vec2.cross(this.m_rB, PB);
            this.pool.pushVec2(2);
        }
        else {
            this.m_impulse = 0.0;
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(1);
        this.pool.pushRot(2);
    };
    PulleyJoint.prototype.solveVelocityConstraints = function (data) {
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var vpA = this.pool.popVec2();
        var vpB = this.pool.popVec2();
        var PA = this.pool.popVec2();
        var PB = this.pool.popVec2();
        Vec2.crossToOutUnsafe(this.m_rA, -wA, vpA);
        vpA.addLocal(vA);
        Vec2.crossToOutUnsafe(this.m_rB, -wB, vpB);
        vpB.addLocal(vB);
        var Cdot = -Vec2.dot(this.m_uA, vpA) - this.m_ratio * Vec2.dot(this.m_uB, vpB);
        var impulse = -this.m_mass * Cdot;
        this.m_impulse += impulse;
        PA.set(this.m_uA).mulLocal(-impulse);
        PB.set(this.m_uB).mulLocal(-this.m_ratio * impulse);
        vA.x += this.m_invMassA * PA.x;
        vA.y += this.m_invMassA * PA.y;
        wA += this.m_invIA * Vec2.cross(this.m_rA, PA);
        vB.x += this.m_invMassB * PB.x;
        vB.y += this.m_invMassB * PB.y;
        wB += this.m_invIB * Vec2.cross(this.m_rB, PB);
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(4);
    };
    PulleyJoint.prototype.solvePositionConstraints = function (data) {
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var rA = this.pool.popVec2();
        var rB = this.pool.popVec2();
        var uA = this.pool.popVec2();
        var uB = this.pool.popVec2();
        var temp = this.pool.popVec2();
        var PA = this.pool.popVec2();
        var PB = this.pool.popVec2();
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), rB);
        uA.set(cA).addLocal(rA).subLocal(this.m_groundAnchorA);
        uB.set(cB).addLocal(rB).subLocal(this.m_groundAnchorB);
        var lengthA = uA.length();
        var lengthB = uB.length();
        if (lengthA > 10.0 * Settings.linearSlop) {
            uA.mulLocal(1.0 / lengthA);
        }
        else {
            uA.setZero();
        }
        if (lengthB > 10.0 * Settings.linearSlop) {
            uB.mulLocal(1.0 / lengthB);
        }
        else {
            uB.setZero();
        }
        var ruA = Vec2.cross(rA, uA);
        var ruB = Vec2.cross(rB, uB);
        var mA = this.m_invMassA + this.m_invIA * ruA * ruA;
        var mB = this.m_invMassB + this.m_invIB * ruB * ruB;
        var mass = mA + this.m_ratio * this.m_ratio * mB;
        if (mass > 0.0) {
            mass = 1.0 / mass;
        }
        var C = this.m_constant - lengthA - this.m_ratio * lengthB;
        var linearError = dMath.Abs(C);
        var impulse = -mass * C;
        PA.set(uA).mulLocal(-impulse);
        PB.set(uB).mulLocal(-this.m_ratio * impulse);
        cA.x += this.m_invMassA * PA.x;
        cA.y += this.m_invMassA * PA.y;
        aA += this.m_invIA * Vec2.cross(rA, PA);
        cB.x += this.m_invMassB * PB.x;
        cB.y += this.m_invMassB * PB.y;
        aB += this.m_invIB * Vec2.cross(rB, PB);
        data.positions[this.m_indexA].a = aA;
        data.positions[this.m_indexB].a = aB;
        this.pool.pushRot(2);
        this.pool.pushVec2(7);
        return linearError < Settings.linearSlop;
    };
    PulleyJoint.MIN_PULLEY_LENGTH = 2.0;
    return PulleyJoint;
}(Joint));
var PulleyJointDef = (function (_super) {
    __extends(PulleyJointDef, _super);
    function PulleyJointDef() {
        var _this = _super.call(this, JointType.PULLEY) || this;
        _this.groundAnchorA = new Vec2(-1.0, 1.0);
        _this.groundAnchorB = new Vec2(1.0, 1.0);
        _this.localAnchorA = new Vec2(-1.0, 0.0);
        _this.localAnchorB = new Vec2(1.0, 0.0);
        _this.lengthA = 0.0;
        _this.lengthB = 0.0;
        _this.ratio = 1.0;
        _this.collideConnected = true;
        return _this;
    }
    PulleyJointDef.prototype.initialize = function (b1, b2, ga1, ga2, anchor1, anchor2, r) {
        this.bodyA = b1;
        this.bodyB = b2;
        this.groundAnchorA = ga1;
        this.groundAnchorB = ga2;
        this.localAnchorA = this.bodyA.getLocalPoint(anchor1);
        this.localAnchorB = this.bodyB.getLocalPoint(anchor2);
        var d1 = anchor1.sub(ga1);
        this.lengthA = d1.length();
        var d2 = anchor2.sub(ga2);
        this.lengthB = d2.length();
        this.ratio = r;
    };
    return PulleyJointDef;
}(JointDef));
var RevoluteJoint = (function (_super) {
    __extends(RevoluteJoint, _super);
    function RevoluteJoint(argWorld, def) {
        var _this = _super.call(this, argWorld, def) || this;
        _this.m_localAnchorA = new Vec2();
        _this.m_localAnchorB = new Vec2();
        _this.m_impulse = new Vec3();
        _this.m_motorImpulse = 0;
        _this.m_enableMotor = false;
        _this.m_maxMotorTorque = 0;
        _this.m_motorSpeed = 0;
        _this.m_enableLimit = false;
        _this.m_referenceAngle = 0;
        _this.m_lowerAngle = 0;
        _this.m_upperAngle = 0;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_rA = new Vec2();
        _this.m_rB = new Vec2();
        _this.m_localCenterA = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_invMassA = 0;
        _this.m_invMassB = 0;
        _this.m_invIA = 0;
        _this.m_invIB = 0;
        _this.m_mass = new Mat33();
        _this.m_motorMass = 0;
        _this.m_limitState = null;
        _this.m_localAnchorA.set(def.localAnchorA);
        _this.m_localAnchorB.set(def.localAnchorB);
        _this.m_referenceAngle = def.referenceAngle;
        _this.m_motorImpulse = 0;
        _this.m_lowerAngle = def.lowerAngle;
        _this.m_upperAngle = def.upperAngle;
        _this.m_maxMotorTorque = def.maxMotorTorque;
        _this.m_motorSpeed = def.motorSpeed;
        _this.m_enableLimit = def.enableLimit;
        _this.m_enableMotor = def.enableMotor;
        _this.m_limitState = LimitState.INACTIVE;
        return _this;
    }
    RevoluteJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassA = this.m_bodyA.m_invMass;
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIA = this.m_bodyA.m_invI;
        this.m_invIB = this.m_bodyB.m_invI;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var temp = this.pool.popVec2();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), this.m_rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), this.m_rB);
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        var fixedRotation = (iA + iB == 0.0);
        this.m_mass.ex.x = mA + mB + this.m_rA.y * this.m_rA.y * iA + this.m_rB.y * this.m_rB.y * iB;
        this.m_mass.ey.x = -this.m_rA.y * this.m_rA.x * iA - this.m_rB.y * this.m_rB.x * iB;
        this.m_mass.ez.x = -this.m_rA.y * iA - this.m_rB.y * iB;
        this.m_mass.ex.y = this.m_mass.ey.x;
        this.m_mass.ey.y = mA + mB + this.m_rA.x * this.m_rA.x * iA + this.m_rB.x * this.m_rB.x * iB;
        this.m_mass.ez.y = this.m_rA.x * iA + this.m_rB.x * iB;
        this.m_mass.ex.z = this.m_mass.ez.x;
        this.m_mass.ey.z = this.m_mass.ez.y;
        this.m_mass.ez.z = iA + iB;
        this.m_motorMass = iA + iB;
        if (this.m_motorMass > 0.0) {
            this.m_motorMass = 1.0 / this.m_motorMass;
        }
        if (this.m_enableMotor == false || fixedRotation) {
            this.m_motorImpulse = 0.0;
        }
        if (this.m_enableLimit && fixedRotation == false) {
            var jointAngle = aB - aA - this.m_referenceAngle;
            if (dMath.Abs(this.m_upperAngle - this.m_lowerAngle) < 2.0 * Settings.angularSlop) {
                this.m_limitState = LimitState.EQUAL;
            }
            else if (jointAngle <= this.m_lowerAngle) {
                if (this.m_limitState != LimitState.AT_LOWER) {
                    this.m_impulse.z = 0.0;
                }
                this.m_limitState = LimitState.AT_LOWER;
            }
            else if (jointAngle >= this.m_upperAngle) {
                if (this.m_limitState != LimitState.AT_UPPER) {
                    this.m_impulse.z = 0.0;
                }
                this.m_limitState = LimitState.AT_UPPER;
            }
            else {
                this.m_limitState = LimitState.INACTIVE;
                this.m_impulse.z = 0.0;
            }
        }
        else {
            this.m_limitState = LimitState.INACTIVE;
        }
        if (data.step.warmStarting) {
            var P = this.pool.popVec2();
            this.m_impulse.x *= data.step.dtRatio;
            this.m_impulse.y *= data.step.dtRatio;
            this.m_motorImpulse *= data.step.dtRatio;
            P.x = this.m_impulse.x;
            P.y = this.m_impulse.y;
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * (Vec2.cross(this.m_rA, P) + this.m_motorImpulse + this.m_impulse.z);
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * (Vec2.cross(this.m_rB, P) + this.m_motorImpulse + this.m_impulse.z);
            this.pool.pushVec2(1);
        }
        else {
            this.m_impulse.setZero();
            this.m_motorImpulse = 0.0;
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(1);
        this.pool.pushRot(2);
    };
    RevoluteJoint.prototype.solveVelocityConstraints = function (data) {
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        var fixedRotation = (iA + iB == 0.0);
        if (this.m_enableMotor && this.m_limitState != LimitState.EQUAL && fixedRotation == false) {
            var CdotN = wB - wA - this.m_motorSpeed;
            var impulseN = -this.m_motorMass * CdotN;
            var oldImpulse = this.m_motorImpulse;
            var maxImpulse = data.step.dt * this.m_maxMotorTorque;
            this.m_motorImpulse = MathUtils.clamp(this.m_motorImpulse + impulseN, -maxImpulse, maxImpulse);
            impulseN = this.m_motorImpulse - oldImpulse;
            wA -= iA * impulseN;
            wB += iB * impulseN;
        }
        var temp = this.pool.popVec2();
        if (this.m_enableLimit && this.m_limitState != LimitState.INACTIVE && fixedRotation == false) {
            var Cdot1 = this.pool.popVec2();
            var Cdot3 = this.pool.popVec3();
            Vec2.crossToOutUnsafe(this.m_rA, -wA, temp);
            Vec2.crossToOutUnsafe(this.m_rB, -wB, Cdot1);
            Cdot1.addLocal(vB).subLocal(vA).subLocal(temp);
            var Cdot2 = wB - wA;
            Cdot3.setValue(Cdot1.x, Cdot1.y, Cdot2);
            var impulse = this.pool.popVec3();
            this.m_mass.solve33ToOut(Cdot3, impulse);
            impulse.negateLocal();
            if (this.m_limitState == LimitState.EQUAL) {
                this.m_impulse.addLocal(impulse);
            }
            else if (this.m_limitState == LimitState.AT_LOWER) {
                var newImpulse = this.m_impulse.z + impulse.z;
                if (newImpulse < 0.0) {
                    var rhs = this.pool.popVec2();
                    rhs.setValue(this.m_mass.ez.x, this.m_mass.ez.y).mulLocal(this.m_impulse.z).subLocal(Cdot1);
                    this.m_mass.solve22ToOut(rhs, temp);
                    impulse.x = temp.x;
                    impulse.y = temp.y;
                    impulse.z = -this.m_impulse.z;
                    this.m_impulse.x += temp.x;
                    this.m_impulse.y += temp.y;
                    this.m_impulse.z = 0.0;
                    this.pool.pushVec2(1);
                }
                else {
                    this.m_impulse.addLocal(impulse);
                }
            }
            else if (this.m_limitState == LimitState.AT_UPPER) {
                var newImpulse = this.m_impulse.z + impulse.z;
                if (newImpulse > 0.0) {
                    var rhs = this.pool.popVec2();
                    rhs.setValue(this.m_mass.ez.x, this.m_mass.ez.y).mulLocal(this.m_impulse.z).subLocal(Cdot1);
                    this.m_mass.solve22ToOut(rhs, temp);
                    impulse.x = temp.x;
                    impulse.y = temp.y;
                    impulse.z = -this.m_impulse.z;
                    this.m_impulse.x += temp.x;
                    this.m_impulse.y += temp.y;
                    this.m_impulse.z = 0.0;
                    this.pool.pushVec2(1);
                }
                else {
                    this.m_impulse.addLocal(impulse);
                }
            }
            var P = this.pool.popVec2();
            P.setValue(impulse.x, impulse.y);
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * (Vec2.cross(this.m_rA, P) + impulse.z);
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * (Vec2.cross(this.m_rB, P) + impulse.z);
            this.pool.pushVec2(2);
            this.pool.pushVec3(2);
        }
        else {
            var Cdot = this.pool.popVec2();
            var impulse3 = this.pool.popVec2();
            Vec2.crossToOutUnsafe(this.m_rA, -wA, temp);
            Vec2.crossToOutUnsafe(this.m_rB, -wB, Cdot);
            Cdot.addLocal(vB).subLocal(vA).subLocal(temp);
            this.m_mass.solve22ToOut(Cdot.negateLocal(), impulse3);
            this.m_impulse.x += impulse3.x;
            this.m_impulse.y += impulse3.y;
            vA.x -= mA * impulse3.x;
            vA.y -= mA * impulse3.y;
            wA -= iA * Vec2.cross(this.m_rA, impulse3);
            vB.x += mB * impulse3.x;
            vB.y += mB * impulse3.y;
            wB += iB * Vec2.cross(this.m_rB, impulse3);
            this.pool.pushVec2(2);
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(1);
    };
    RevoluteJoint.prototype.solvePositionConstraints = function (data) {
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        qA.setValue(aA);
        qB.setValue(aB);
        var angularError = 0.0;
        var positionError = 0.0;
        var fixedRotation = (this.m_invIA + this.m_invIB == 0.0);
        if (this.m_enableLimit && this.m_limitState != LimitState.INACTIVE && fixedRotation == false) {
            var angle = aB - aA - this.m_referenceAngle;
            var limitImpulse = 0.0;
            if (this.m_limitState == LimitState.EQUAL) {
                var C = MathUtils.clamp(angle - this.m_lowerAngle, -Settings.maxAngularCorrection, Settings.maxAngularCorrection);
                limitImpulse = -this.m_motorMass * C;
                angularError = dMath.Abs(C);
            }
            else if (this.m_limitState == LimitState.AT_LOWER) {
                var C = angle - this.m_lowerAngle;
                angularError = -C;
                C = MathUtils.clamp(C + Settings.angularSlop, -Settings.maxAngularCorrection, 0.0);
                limitImpulse = -this.m_motorMass * C;
            }
            else if (this.m_limitState == LimitState.AT_UPPER) {
                var C = angle - this.m_upperAngle;
                angularError = C;
                C = MathUtils.clamp(C - Settings.angularSlop, 0.0, Settings.maxAngularCorrection);
                limitImpulse = -this.m_motorMass * C;
            }
            aA -= this.m_invIA * limitImpulse;
            aB += this.m_invIB * limitImpulse;
        }
        {
            qA.setValue(aA);
            qB.setValue(aB);
            var rA = this.pool.popVec2();
            var rB = this.pool.popVec2();
            var C2 = this.pool.popVec2();
            var impulse = this.pool.popVec2();
            Rot.mulToOutUnsafe(qA, C2.set(this.m_localAnchorA).subLocal(this.m_localCenterA), rA);
            Rot.mulToOutUnsafe(qB, C2.set(this.m_localAnchorB).subLocal(this.m_localCenterB), rB);
            C2.set(cB).addLocal(rB).subLocal(cA).subLocal(rA);
            positionError = C2.length();
            var mA = this.m_invMassA, mB = this.m_invMassB;
            var iA = this.m_invIA, iB = this.m_invIB;
            var K = this.pool.popMat22();
            K.ex.x = mA + mB + iA * rA.y * rA.y + iB * rB.y * rB.y;
            K.ex.y = -iA * rA.x * rA.y - iB * rB.x * rB.y;
            K.ey.x = K.ex.y;
            K.ey.y = mA + mB + iA * rA.x * rA.x + iB * rB.x * rB.x;
            K.solveToOut(C2, impulse);
            impulse.negateLocal();
            cA.x -= mA * impulse.x;
            cA.y -= mA * impulse.y;
            aA -= iA * Vec2.cross(rA, impulse);
            cB.x += mB * impulse.x;
            cB.y += mB * impulse.y;
            aB += iB * Vec2.cross(rB, impulse);
            this.pool.pushVec2(4);
            this.pool.pushMat22(1);
        }
        data.positions[this.m_indexA].a = aA;
        data.positions[this.m_indexB].a = aB;
        this.pool.pushRot(2);
        return positionError <= Settings.linearSlop && angularError <= Settings.angularSlop;
    };
    RevoluteJoint.prototype.getLocalAnchorA = function () {
        return this.m_localAnchorA;
    };
    RevoluteJoint.prototype.getLocalAnchorB = function () {
        return this.m_localAnchorB;
    };
    RevoluteJoint.prototype.getReferenceAngle = function () {
        return this.m_referenceAngle;
    };
    RevoluteJoint.prototype.getAnchorA = function (argOut) {
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, argOut);
    };
    RevoluteJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    RevoluteJoint.prototype.getReactionForce = function (inv_dt, argOut) {
        argOut.setValue(this.m_impulse.x, this.m_impulse.y).mulLocal(inv_dt);
    };
    RevoluteJoint.prototype.getReactionTorque = function (inv_dt) {
        return inv_dt * this.m_impulse.z;
    };
    RevoluteJoint.prototype.getJointAngle = function () {
        var b1 = this.m_bodyA;
        var b2 = this.m_bodyB;
        return b2.m_sweep.a - b1.m_sweep.a - this.m_referenceAngle;
    };
    RevoluteJoint.prototype.getJointSpeed = function () {
        var b1 = this.m_bodyA;
        var b2 = this.m_bodyB;
        return b2.m_angularVelocity - b1.m_angularVelocity;
    };
    RevoluteJoint.prototype.isMotorEnabled = function () {
        return this.m_enableMotor;
    };
    RevoluteJoint.prototype.enableMotor = function (flag) {
        this.m_bodyA.setAwake(true);
        this.m_bodyB.setAwake(true);
        this.m_enableMotor = flag;
    };
    RevoluteJoint.prototype.getMotorTorque = function (inv_dt) {
        return this.m_motorImpulse * inv_dt;
    };
    RevoluteJoint.prototype.setMotorSpeed = function (speed) {
        this.m_bodyA.setAwake(true);
        this.m_bodyB.setAwake(true);
        this.m_motorSpeed = speed;
    };
    RevoluteJoint.prototype.setMaxMotorTorque = function (torque) {
        this.m_bodyA.setAwake(true);
        this.m_bodyB.setAwake(true);
        this.m_maxMotorTorque = torque;
    };
    RevoluteJoint.prototype.getMotorSpeed = function () {
        return this.m_motorSpeed;
    };
    RevoluteJoint.prototype.getMaxMotorTorque = function () {
        return this.m_maxMotorTorque;
    };
    RevoluteJoint.prototype.isLimitEnabled = function () {
        return this.m_enableLimit;
    };
    RevoluteJoint.prototype.enableLimit = function (flag) {
        if (flag != this.m_enableLimit) {
            this.m_bodyA.setAwake(true);
            this.m_bodyB.setAwake(true);
            this.m_enableLimit = flag;
            this.m_impulse.z = 0.0;
        }
    };
    RevoluteJoint.prototype.getLowerLimit = function () {
        return this.m_lowerAngle;
    };
    RevoluteJoint.prototype.getUpperLimit = function () {
        return this.m_upperAngle;
    };
    RevoluteJoint.prototype.setLimits = function (lower, upper) {
        if (lower != this.m_lowerAngle || upper != this.m_upperAngle) {
            this.m_bodyA.setAwake(true);
            this.m_bodyB.setAwake(true);
            this.m_impulse.z = 0.0;
            this.m_lowerAngle = lower;
            this.m_upperAngle = upper;
        }
    };
    return RevoluteJoint;
}(Joint));
var RevoluteJointDef = (function (_super) {
    __extends(RevoluteJointDef, _super);
    function RevoluteJointDef() {
        var _this = _super.call(this, JointType.REVOLUTE) || this;
        _this.localAnchorA = new Vec2(0.0, 0.0);
        _this.localAnchorB = new Vec2(0.0, 0.0);
        _this.referenceAngle = 0.0;
        _this.lowerAngle = 0.0;
        _this.upperAngle = 0.0;
        _this.maxMotorTorque = 0.0;
        _this.motorSpeed = 0.0;
        _this.enableLimit = false;
        _this.enableMotor = false;
        return _this;
    }
    RevoluteJointDef.prototype.initialize = function (b1, b2, anchor) {
        this.bodyA = b1;
        this.bodyB = b2;
        this.bodyA.getLocalPointToOut(anchor, this.localAnchorA);
        this.bodyB.getLocalPointToOut(anchor, this.localAnchorB);
        this.referenceAngle = this.bodyB.getAngle() - this.bodyA.getAngle();
    };
    return RevoluteJointDef;
}(JointDef));
var RopeJoint = (function (_super) {
    __extends(RopeJoint, _super);
    function RopeJoint(worldPool, def) {
        var _this = _super.call(this, worldPool, def) || this;
        _this.m_localAnchorA = new Vec2();
        _this.m_localAnchorB = new Vec2();
        _this.m_maxLength = 0;
        _this.m_length = 0;
        _this.m_impulse = 0;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_u = new Vec2();
        _this.m_rA = new Vec2();
        _this.m_rB = new Vec2();
        _this.m_localCenterA = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_invMassA = 0;
        _this.m_invMassB = 0;
        _this.m_invIA = 0;
        _this.m_invIB = 0;
        _this.m_mass = 0;
        _this.m_state = null;
        _this.m_localAnchorA.set(def.localAnchorA);
        _this.m_localAnchorB.set(def.localAnchorB);
        _this.m_maxLength = def.maxLength;
        _this.m_mass = 0.0;
        _this.m_impulse = 0.0;
        _this.m_state = LimitState.INACTIVE;
        _this.m_length = 0.0;
        return _this;
    }
    RopeJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassA = this.m_bodyA.m_invMass;
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIA = this.m_bodyA.m_invI;
        this.m_invIB = this.m_bodyB.m_invI;
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var temp = this.pool.popVec2();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), this.m_rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), this.m_rB);
        this.m_u.set(cB).addLocal(this.m_rB).subLocal(cA).subLocal(this.m_rA);
        this.m_length = this.m_u.length();
        var C = this.m_length - this.m_maxLength;
        if (C > 0.0) {
            this.m_state = LimitState.AT_UPPER;
        }
        else {
            this.m_state = LimitState.INACTIVE;
        }
        if (this.m_length > Settings.linearSlop) {
            this.m_u.mulLocal(1.0 / this.m_length);
        }
        else {
            this.m_u.setZero();
            this.m_mass = 0.0;
            this.m_impulse = 0.0;
            this.pool.pushRot(2);
            this.pool.pushVec2(1);
            return;
        }
        var crA = Vec2.cross(this.m_rA, this.m_u);
        var crB = Vec2.cross(this.m_rB, this.m_u);
        var invMass = this.m_invMassA + this.m_invIA * crA * crA + this.m_invMassB + this.m_invIB * crB * crB;
        this.m_mass = invMass != 0.0 ? 1.0 / invMass : 0.0;
        if (data.step.warmStarting) {
            this.m_impulse *= data.step.dtRatio;
            var Px = this.m_impulse * this.m_u.x;
            var Py = this.m_impulse * this.m_u.y;
            vA.x -= this.m_invMassA * Px;
            vA.y -= this.m_invMassA * Py;
            wA -= this.m_invIA * (this.m_rA.x * Py - this.m_rA.y * Px);
            vB.x += this.m_invMassB * Px;
            vB.y += this.m_invMassB * Py;
            wB += this.m_invIB * (this.m_rB.x * Py - this.m_rB.y * Px);
        }
        else {
            this.m_impulse = 0.0;
        }
        this.pool.pushRot(2);
        this.pool.pushVec2(1);
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
    };
    RopeJoint.prototype.solveVelocityConstraints = function (data) {
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var vpA = this.pool.popVec2();
        var vpB = this.pool.popVec2();
        var temp = this.pool.popVec2();
        Vec2.crossToOutUnsafe(this.m_rA, -wA, vpA);
        vpA.addLocal(vA);
        Vec2.crossToOutUnsafe(this.m_rB, -wB, vpB);
        vpB.addLocal(vB);
        var C = this.m_length - this.m_maxLength;
        var Cdot = Vec2.dot(this.m_u, temp.set(vpB).subLocal(vpA));
        if (C < 0.0) {
            Cdot += data.step.inv_dt * C;
        }
        var impulse = -this.m_mass * Cdot;
        var oldImpulse = this.m_impulse;
        this.m_impulse = dMath.Min(0.0, this.m_impulse + impulse);
        impulse = this.m_impulse - oldImpulse;
        var Px = impulse * this.m_u.x;
        var Py = impulse * this.m_u.y;
        vA.x -= this.m_invMassA * Px;
        vA.y -= this.m_invMassA * Py;
        wA -= this.m_invIA * (this.m_rA.x * Py - this.m_rA.y * Px);
        vB.x += this.m_invMassB * Px;
        vB.y += this.m_invMassB * Py;
        wB += this.m_invIB * (this.m_rB.x * Py - this.m_rB.y * Px);
        this.pool.pushVec2(3);
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
    };
    RopeJoint.prototype.solvePositionConstraints = function (data) {
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var u = this.pool.popVec2();
        var rA = this.pool.popVec2();
        var rB = this.pool.popVec2();
        var temp = this.pool.popVec2();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), rB);
        u.set(cB).addLocal(rB).subLocal(cA).subLocal(rA);
        var length = u.normalize();
        var C = length - this.m_maxLength;
        C = MathUtils.clamp(C, 0.0, Settings.maxLinearCorrection);
        var impulse = -this.m_mass * C;
        var Px = impulse * u.x;
        var Py = impulse * u.y;
        cA.x -= this.m_invMassA * Px;
        cA.y -= this.m_invMassA * Py;
        aA -= this.m_invIA * (rA.x * Py - rA.y * Px);
        cB.x += this.m_invMassB * Px;
        cB.y += this.m_invMassB * Py;
        aB += this.m_invIB * (rB.x * Py - rB.y * Px);
        this.pool.pushRot(2);
        this.pool.pushVec2(4);
        data.positions[this.m_indexA].a = aA;
        data.positions[this.m_indexB].a = aB;
        return length - this.m_maxLength < Settings.linearSlop;
    };
    RopeJoint.prototype.getAnchorA = function (argOut) {
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, argOut);
    };
    RopeJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    RopeJoint.prototype.getReactionForce = function (inv_dt, argOut) {
        argOut.set(this.m_u).mulLocal(inv_dt).mulLocal(this.m_impulse);
    };
    RopeJoint.prototype.getReactionTorque = function (inv_dt) {
        return 0;
    };
    RopeJoint.prototype.getLocalAnchorA = function () {
        return this.m_localAnchorA;
    };
    RopeJoint.prototype.getLocalAnchorB = function () {
        return this.m_localAnchorB;
    };
    RopeJoint.prototype.getMaxLength = function () {
        return this.m_maxLength;
    };
    RopeJoint.prototype.setMaxLength = function (maxLength) {
        this.m_maxLength = maxLength;
    };
    RopeJoint.prototype.getLimitState = function () {
        return this.m_state;
    };
    return RopeJoint;
}(Joint));
var RopeJointDef = (function (_super) {
    __extends(RopeJointDef, _super);
    function RopeJointDef() {
        var _this = _super.call(this, JointType.ROPE) || this;
        _this.localAnchorA = new Vec2();
        _this.localAnchorB = new Vec2();
        _this.maxLength = 0;
        _this.localAnchorA.setValue(-1.0, 0.0);
        _this.localAnchorB.setValue(1.0, 0.0);
        return _this;
    }
    return RopeJointDef;
}(JointDef));
var WeldJoint = (function (_super) {
    __extends(WeldJoint, _super);
    function WeldJoint(argWorld, def) {
        var _this = _super.call(this, argWorld, def) || this;
        _this.m_frequencyHz = 0;
        _this.m_dampingRatio = 0;
        _this.m_bias = 0;
        _this.m_localAnchorA = null;
        _this.m_localAnchorB = null;
        _this.m_referenceAngle = 0;
        _this.m_gamma = 0;
        _this.m_impulse = null;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_rA = new Vec2();
        _this.m_rB = new Vec2();
        _this.m_localCenterA = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_invMassA = 0;
        _this.m_invMassB = 0;
        _this.m_invIA = 0;
        _this.m_invIB = 0;
        _this.m_mass = new Mat33();
        _this.m_localAnchorA = new Vec2().set(def.localAnchorA);
        _this.m_localAnchorB = new Vec2().set(def.localAnchorB);
        _this.m_referenceAngle = def.referenceAngle;
        _this.m_frequencyHz = def.frequencyHz;
        _this.m_dampingRatio = def.dampingRatio;
        _this.m_impulse = new Vec3();
        _this.m_impulse.setZero();
        return _this;
    }
    WeldJoint.prototype.getReferenceAngle = function () {
        return this.m_referenceAngle;
    };
    WeldJoint.prototype.getLocalAnchorA = function () {
        return this.m_localAnchorA;
    };
    WeldJoint.prototype.getLocalAnchorB = function () {
        return this.m_localAnchorB;
    };
    WeldJoint.prototype.getFrequency = function () {
        return this.m_frequencyHz;
    };
    WeldJoint.prototype.setFrequency = function (frequencyHz) {
        this.m_frequencyHz = frequencyHz;
    };
    WeldJoint.prototype.getDampingRatio = function () {
        return this.m_dampingRatio;
    };
    WeldJoint.prototype.setDampingRatio = function (dampingRatio) {
        this.m_dampingRatio = dampingRatio;
    };
    WeldJoint.prototype.getAnchorA = function (argOut) {
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, argOut);
    };
    WeldJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    WeldJoint.prototype.getReactionForce = function (inv_dt, argOut) {
        argOut.setValue(this.m_impulse.x, this.m_impulse.y);
        argOut.mulLocal(inv_dt);
    };
    WeldJoint.prototype.getReactionTorque = function (inv_dt) {
        return inv_dt * this.m_impulse.z;
    };
    WeldJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassA = this.m_bodyA.m_invMass;
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIA = this.m_bodyA.m_invI;
        this.m_invIB = this.m_bodyB.m_invI;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var temp = this.pool.popVec2();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), this.m_rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), this.m_rB);
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        var K = this.pool.popMat33();
        K.ex.x = mA + mB + this.m_rA.y * this.m_rA.y * iA + this.m_rB.y * this.m_rB.y * iB;
        K.ey.x = -this.m_rA.y * this.m_rA.x * iA - this.m_rB.y * this.m_rB.x * iB;
        K.ez.x = -this.m_rA.y * iA - this.m_rB.y * iB;
        K.ex.y = K.ey.x;
        K.ey.y = mA + mB + this.m_rA.x * this.m_rA.x * iA + this.m_rB.x * this.m_rB.x * iB;
        K.ez.y = this.m_rA.x * iA + this.m_rB.x * iB;
        K.ex.z = K.ez.x;
        K.ey.z = K.ez.y;
        K.ez.z = iA + iB;
        if (this.m_frequencyHz > 0.0) {
            K.getInverse22(this.m_mass);
            var invM = iA + iB;
            var m = invM > 0.0 ? 1.0 / invM : 0.0;
            var C = aB - aA - this.m_referenceAngle;
            var omega = 2.0 * MathUtils.PI * this.m_frequencyHz;
            var d = 2.0 * m * this.m_dampingRatio * omega;
            var k = m * omega * omega;
            var h = data.step.dt;
            this.m_gamma = h * (d + h * k);
            this.m_gamma = this.m_gamma != 0.0 ? 1.0 / this.m_gamma : 0.0;
            this.m_bias = C * h * k * this.m_gamma;
            invM += this.m_gamma;
            this.m_mass.ez.z = invM != 0.0 ? 1.0 / invM : 0.0;
        }
        else {
            K.getSymInverse33(this.m_mass);
            this.m_gamma = 0.0;
            this.m_bias = 0.0;
        }
        if (data.step.warmStarting) {
            var P = this.pool.popVec2();
            this.m_impulse.mulLocal(data.step.dtRatio);
            P.setValue(this.m_impulse.x, this.m_impulse.y);
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * (Vec2.cross(this.m_rA, P) + this.m_impulse.z);
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * (Vec2.cross(this.m_rB, P) + this.m_impulse.z);
            this.pool.pushVec2(1);
        }
        else {
            this.m_impulse.setZero();
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(1);
        this.pool.pushRot(2);
        this.pool.pushMat33(1);
    };
    WeldJoint.prototype.solveVelocityConstraints = function (data) {
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        var Cdot1 = this.pool.popVec2();
        var P = this.pool.popVec2();
        var temp = this.pool.popVec2();
        if (this.m_frequencyHz > 0.0) {
            var Cdot2 = wB - wA;
            var impulse2 = -this.m_mass.ez.z * (Cdot2 + this.m_bias + this.m_gamma * this.m_impulse.z);
            this.m_impulse.z += impulse2;
            wA -= iA * impulse2;
            wB += iB * impulse2;
            Vec2.crossToOutUnsafe(this.m_rB, -wB, Cdot1);
            Vec2.crossToOutUnsafe(this.m_rA, -wA, temp);
            Cdot1.addLocal(vB).subLocal(vA).subLocal(temp);
            var impulse1 = P;
            Mat33.mul22ToOutUnsafe(this.m_mass, Cdot1, impulse1);
            impulse1.negateLocal();
            this.m_impulse.x += impulse1.x;
            this.m_impulse.y += impulse1.y;
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * Vec2.cross(this.m_rA, P);
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * Vec2.cross(this.m_rB, P);
        }
        else {
            Vec2.crossToOutUnsafe(this.m_rA, -wA, temp);
            Vec2.crossToOutUnsafe(this.m_rB, -wB, Cdot1);
            Cdot1.addLocal(vB).subLocal(vA).subLocal(temp);
            var Cdot2 = wB - wA;
            var Cdot = this.pool.popVec3();
            Cdot.setValue(Cdot1.x, Cdot1.y, Cdot2);
            var impulse = this.pool.popVec3();
            Mat33.mulToOutUnsafe(this.m_mass, Cdot, impulse);
            impulse.negateLocal();
            this.m_impulse.addLocal(impulse);
            P.setValue(impulse.x, impulse.y);
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * (Vec2.cross(this.m_rA, P) + impulse.z);
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * (Vec2.cross(this.m_rB, P) + impulse.z);
            this.pool.pushVec3(2);
        }
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
        this.pool.pushVec2(3);
    };
    WeldJoint.prototype.solvePositionConstraints = function (data) {
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var temp = this.pool.popVec2();
        var rA = this.pool.popVec2();
        var rB = this.pool.popVec2();
        qA.setValue(aA);
        qB.setValue(aB);
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), rB);
        var positionError, angularError;
        var K = this.pool.popMat33();
        var C1 = this.pool.popVec2();
        var P = this.pool.popVec2();
        K.ex.x = mA + mB + rA.y * rA.y * iA + rB.y * rB.y * iB;
        K.ey.x = -rA.y * rA.x * iA - rB.y * rB.x * iB;
        K.ez.x = -rA.y * iA - rB.y * iB;
        K.ex.y = K.ey.x;
        K.ey.y = mA + mB + rA.x * rA.x * iA + rB.x * rB.x * iB;
        K.ez.y = rA.x * iA + rB.x * iB;
        K.ex.z = K.ez.x;
        K.ey.z = K.ez.y;
        K.ez.z = iA + iB;
        if (this.m_frequencyHz > 0.0) {
            C1.set(cB).addLocal(rB).subLocal(cA).subLocal(rA);
            positionError = C1.length();
            angularError = 0.0;
            K.solve22ToOut(C1, P);
            P.negateLocal();
            cA.x -= mA * P.x;
            cA.y -= mA * P.y;
            aA -= iA * Vec2.cross(rA, P);
            cB.x += mB * P.x;
            cB.y += mB * P.y;
            aB += iB * Vec2.cross(rB, P);
        }
        else {
            C1.set(cB).addLocal(rB).subLocal(cA).subLocal(rA);
            var C2 = aB - aA - this.m_referenceAngle;
            positionError = C1.length();
            angularError = dMath.Abs(C2);
            var C = this.pool.popVec3();
            var impulse = this.pool.popVec3();
            C.setValue(C1.x, C1.y, C2);
            K.solve33ToOut(C, impulse);
            impulse.negateLocal();
            P.setValue(impulse.x, impulse.y);
            cA.x -= mA * P.x;
            cA.y -= mA * P.y;
            aA -= iA * (Vec2.cross(rA, P) + impulse.z);
            cB.x += mB * P.x;
            cB.y += mB * P.y;
            aB += iB * (Vec2.cross(rB, P) + impulse.z);
            this.pool.pushVec3(2);
        }
        data.positions[this.m_indexA].a = aA;
        data.positions[this.m_indexB].a = aB;
        this.pool.pushVec2(5);
        this.pool.pushRot(2);
        this.pool.pushMat33(1);
        return positionError <= Settings.linearSlop && angularError <= Settings.angularSlop;
    };
    return WeldJoint;
}(Joint));
var WeldJointDef = (function (_super) {
    __extends(WeldJointDef, _super);
    function WeldJointDef() {
        var _this = _super.call(this, JointType.WELD) || this;
        _this.referenceAngle = 0;
        _this.frequencyHz = 0;
        _this.dampingRatio = 0;
        _this.localAnchorA = new Vec2();
        _this.localAnchorB = new Vec2();
        _this.referenceAngle = 0.0;
        return _this;
    }
    WeldJointDef.prototype.initialize = function (bA, bB, anchor) {
        this.bodyA = bA;
        this.bodyB = bB;
        this.bodyA.getLocalPointToOut(anchor, this.localAnchorA);
        this.bodyB.getLocalPointToOut(anchor, this.localAnchorB);
        this.referenceAngle = this.bodyB.getAngle() - this.bodyA.getAngle();
    };
    return WeldJointDef;
}(JointDef));
var WheelJoint = (function (_super) {
    __extends(WheelJoint, _super);
    function WheelJoint(argPool, def) {
        var _this = _super.call(this, argPool, def) || this;
        _this.m_frequencyHz = 0;
        _this.m_dampingRatio = 0;
        _this.m_localAnchorA = new Vec2();
        _this.m_localAnchorB = new Vec2();
        _this.m_localXAxisA = new Vec2();
        _this.m_localYAxisA = new Vec2();
        _this.m_impulse = 0;
        _this.m_motorImpulse = 0;
        _this.m_springImpulse = 0;
        _this.m_maxMotorTorque = 0;
        _this.m_motorSpeed = 0;
        _this.m_enableMotor = false;
        _this.m_indexA = 0;
        _this.m_indexB = 0;
        _this.m_localCenterA = new Vec2();
        _this.m_localCenterB = new Vec2();
        _this.m_invMassA = 0;
        _this.m_invMassB = 0;
        _this.m_invIA = 0;
        _this.m_invIB = 0;
        _this.m_ax = new Vec2();
        _this.m_ay = new Vec2();
        _this.m_sAx = 0;
        _this.m_sBx = 0;
        _this.m_sAy = 0;
        _this.m_sBy = 0;
        _this.m_mass = 0;
        _this.m_motorMass = 0;
        _this.m_springMass = 0;
        _this.m_bias = 0;
        _this.m_gamma = 0;
        _this.rA = new Vec2();
        _this.rB = new Vec2();
        _this.d = new Vec2();
        _this.m_localAnchorA.set(def.localAnchorA);
        _this.m_localAnchorB.set(def.localAnchorB);
        _this.m_localXAxisA.set(def.localAxisA);
        Vec2.crossToOutUnsafe(_this.m_localXAxisA, -1.0, _this.m_localYAxisA);
        _this.m_motorMass = 0.0;
        _this.m_motorImpulse = 0.0;
        _this.m_maxMotorTorque = def.maxMotorTorque;
        _this.m_motorSpeed = def.motorSpeed;
        _this.m_enableMotor = def.enableMotor;
        _this.m_frequencyHz = def.frequencyHz;
        _this.m_dampingRatio = def.dampingRatio;
        return _this;
    }
    WheelJoint.prototype.getLocalAnchorA = function () {
        return this.m_localAnchorA;
    };
    WheelJoint.prototype.getLocalAnchorB = function () {
        return this.m_localAnchorB;
    };
    WheelJoint.prototype.getAnchorA = function (argOut) {
        this.m_bodyA.getWorldPointToOut(this.m_localAnchorA, argOut);
    };
    WheelJoint.prototype.getAnchorB = function (argOut) {
        this.m_bodyB.getWorldPointToOut(this.m_localAnchorB, argOut);
    };
    WheelJoint.prototype.getReactionForce = function (inv_dt, argOut) {
        var temp = this.pool.popVec2();
        temp.set(this.m_ay).mulLocal(this.m_impulse);
        argOut.set(this.m_ax).mulLocal(this.m_springImpulse).addLocal(temp).mulLocal(inv_dt);
        this.pool.pushVec2(1);
    };
    WheelJoint.prototype.getReactionTorque = function (inv_dt) {
        return inv_dt * this.m_motorImpulse;
    };
    WheelJoint.prototype.getJointTranslation = function () {
        var b1 = this.m_bodyA;
        var b2 = this.m_bodyB;
        var p1 = this.pool.popVec2();
        var p2 = this.pool.popVec2();
        var axis = this.pool.popVec2();
        b1.getWorldPointToOut(this.m_localAnchorA, p1);
        b2.getWorldPointToOut(this.m_localAnchorA, p2);
        p2.subLocal(p1);
        b1.getWorldVectorToOut(this.m_localXAxisA, axis);
        var translation = Vec2.dot(p2, axis);
        this.pool.pushVec2(3);
        return translation;
    };
    WheelJoint.prototype.getLocalAxisA = function () {
        return this.m_localXAxisA;
    };
    WheelJoint.prototype.getJointSpeed = function () {
        return this.m_bodyA.m_angularVelocity - this.m_bodyB.m_angularVelocity;
    };
    WheelJoint.prototype.isMotorEnabled = function () {
        return this.m_enableMotor;
    };
    WheelJoint.prototype.enableMotor = function (flag) {
        this.m_bodyA.setAwake(true);
        this.m_bodyB.setAwake(true);
        this.m_enableMotor = flag;
    };
    WheelJoint.prototype.setMotorSpeed = function (speed) {
        this.m_bodyA.setAwake(true);
        this.m_bodyB.setAwake(true);
        this.m_motorSpeed = speed;
    };
    WheelJoint.prototype.getMotorSpeed = function () {
        return this.m_motorSpeed;
    };
    WheelJoint.prototype.getMaxMotorTorque = function () {
        return this.m_maxMotorTorque;
    };
    WheelJoint.prototype.setMaxMotorTorque = function (torque) {
        this.m_bodyA.setAwake(true);
        this.m_bodyB.setAwake(true);
        this.m_maxMotorTorque = torque;
    };
    WheelJoint.prototype.getMotorTorque = function (inv_dt) {
        return this.m_motorImpulse * inv_dt;
    };
    WheelJoint.prototype.setSpringFrequencyHz = function (hz) {
        this.m_frequencyHz = hz;
    };
    WheelJoint.prototype.getSpringFrequencyHz = function () {
        return this.m_frequencyHz;
    };
    WheelJoint.prototype.setSpringDampingRatio = function (ratio) {
        this.m_dampingRatio = ratio;
    };
    WheelJoint.prototype.getSpringDampingRatio = function () {
        return this.m_dampingRatio;
    };
    WheelJoint.prototype.initVelocityConstraints = function (data) {
        this.m_indexA = this.m_bodyA.m_islandIndex;
        this.m_indexB = this.m_bodyB.m_islandIndex;
        this.m_localCenterA.set(this.m_bodyA.m_sweep.localCenter);
        this.m_localCenterB.set(this.m_bodyB.m_sweep.localCenter);
        this.m_invMassA = this.m_bodyA.m_invMass;
        this.m_invMassB = this.m_bodyB.m_invMass;
        this.m_invIA = this.m_bodyA.m_invI;
        this.m_invIB = this.m_bodyB.m_invI;
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var temp = this.pool.popVec2();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOutUnsafe(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), this.rA);
        Rot.mulToOutUnsafe(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), this.rB);
        this.d.set(cB).addLocal(this.rB).subLocal(cA).subLocal(this.rA);
        {
            Rot.mulToOut(qA, this.m_localYAxisA, this.m_ay);
            this.m_sAy = Vec2.cross(temp.set(this.d).addLocal(this.rA), this.m_ay);
            this.m_sBy = Vec2.cross(this.rB, this.m_ay);
            this.m_mass = mA + mB + iA * this.m_sAy * this.m_sAy + iB * this.m_sBy * this.m_sBy;
            if (this.m_mass > 0.0) {
                this.m_mass = 1.0 / this.m_mass;
            }
        }
        this.m_springMass = 0.0;
        this.m_bias = 0.0;
        this.m_gamma = 0.0;
        if (this.m_frequencyHz > 0.0) {
            Rot.mulToOut(qA, this.m_localXAxisA, this.m_ax);
            this.m_sAx = Vec2.cross(temp.set(this.d).addLocal(this.rA), this.m_ax);
            this.m_sBx = Vec2.cross(this.rB, this.m_ax);
            var invMass = mA + mB + iA * this.m_sAx * this.m_sAx + iB * this.m_sBx * this.m_sBx;
            if (invMass > 0.0) {
                this.m_springMass = 1.0 / invMass;
                var C = Vec2.dot(this.d, this.m_ax);
                var omega = 2.0 * dMath.dPI * this.m_frequencyHz;
                var d = 2.0 * this.m_springMass * this.m_dampingRatio * omega;
                var k = this.m_springMass * omega * omega;
                var h = data.step.dt;
                this.m_gamma = h * (d + h * k);
                if (this.m_gamma > 0.0) {
                    this.m_gamma = 1.0 / this.m_gamma;
                }
                this.m_bias = C * h * k * this.m_gamma;
                this.m_springMass = invMass + this.m_gamma;
                if (this.m_springMass > 0.0) {
                    this.m_springMass = 1.0 / this.m_springMass;
                }
            }
        }
        else {
            this.m_springImpulse = 0.0;
        }
        if (this.m_enableMotor) {
            this.m_motorMass = iA + iB;
            if (this.m_motorMass > 0.0) {
                this.m_motorMass = 1.0 / this.m_motorMass;
            }
        }
        else {
            this.m_motorMass = 0.0;
            this.m_motorImpulse = 0.0;
        }
        if (data.step.warmStarting) {
            var P = this.pool.popVec2();
            this.m_impulse *= data.step.dtRatio;
            this.m_springImpulse *= data.step.dtRatio;
            this.m_motorImpulse *= data.step.dtRatio;
            P.x = this.m_impulse * this.m_ay.x + this.m_springImpulse * this.m_ax.x;
            P.y = this.m_impulse * this.m_ay.y + this.m_springImpulse * this.m_ax.y;
            var LA = this.m_impulse * this.m_sAy + this.m_springImpulse * this.m_sAx + this.m_motorImpulse;
            var LB = this.m_impulse * this.m_sBy + this.m_springImpulse * this.m_sBx + this.m_motorImpulse;
            vA.x -= this.m_invMassA * P.x;
            vA.y -= this.m_invMassA * P.y;
            wA -= this.m_invIA * LA;
            vB.x += this.m_invMassB * P.x;
            vB.y += this.m_invMassB * P.y;
            wB += this.m_invIB * LB;
            this.pool.pushVec2(1);
        }
        else {
            this.m_impulse = 0.0;
            this.m_springImpulse = 0.0;
            this.m_motorImpulse = 0.0;
        }
        this.pool.pushRot(2);
        this.pool.pushVec2(1);
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
    };
    WheelJoint.prototype.solveVelocityConstraints = function (data) {
        var mA = this.m_invMassA, mB = this.m_invMassB;
        var iA = this.m_invIA, iB = this.m_invIB;
        var vA = data.velocities[this.m_indexA].v;
        var wA = data.velocities[this.m_indexA].w;
        var vB = data.velocities[this.m_indexB].v;
        var wB = data.velocities[this.m_indexB].w;
        var temp = this.pool.popVec2();
        var P = this.pool.popVec2();
        {
            var Cdot = Vec2.dot(this.m_ax, temp.set(vB).subLocal(vA)) + this.m_sBx * wB - this.m_sAx * wA;
            var impulse = -this.m_springMass * (Cdot + this.m_bias + this.m_gamma * this.m_springImpulse);
            this.m_springImpulse += impulse;
            P.x = impulse * this.m_ax.x;
            P.y = impulse * this.m_ax.y;
            var LA = impulse * this.m_sAx;
            var LB = impulse * this.m_sBx;
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * LA;
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * LB;
        }
        {
            var Cdot = wB - wA - this.m_motorSpeed;
            var impulse = -this.m_motorMass * Cdot;
            var oldImpulse = this.m_motorImpulse;
            var maxImpulse = data.step.dt * this.m_maxMotorTorque;
            this.m_motorImpulse = MathUtils.clamp(this.m_motorImpulse + impulse, -maxImpulse, maxImpulse);
            impulse = this.m_motorImpulse - oldImpulse;
            wA -= iA * impulse;
            wB += iB * impulse;
        }
        {
            var Cdot = Vec2.dot(this.m_ay, temp.set(vB).subLocal(vA)) + this.m_sBy * wB - this.m_sAy * wA;
            var impulse = -this.m_mass * Cdot;
            this.m_impulse += impulse;
            P.x = impulse * this.m_ay.x;
            P.y = impulse * this.m_ay.y;
            var LA = impulse * this.m_sAy;
            var LB = impulse * this.m_sBy;
            vA.x -= mA * P.x;
            vA.y -= mA * P.y;
            wA -= iA * LA;
            vB.x += mB * P.x;
            vB.y += mB * P.y;
            wB += iB * LB;
        }
        this.pool.pushVec2(2);
        data.velocities[this.m_indexA].w = wA;
        data.velocities[this.m_indexB].w = wB;
    };
    WheelJoint.prototype.solvePositionConstraints = function (data) {
        var cA = data.positions[this.m_indexA].c;
        var aA = data.positions[this.m_indexA].a;
        var cB = data.positions[this.m_indexB].c;
        var aB = data.positions[this.m_indexB].a;
        var qA = this.pool.popRot();
        var qB = this.pool.popRot();
        var temp = this.pool.popVec2();
        qA.setValue(aA);
        qB.setValue(aB);
        Rot.mulToOut(qA, temp.set(this.m_localAnchorA).subLocal(this.m_localCenterA), this.rA);
        Rot.mulToOut(qB, temp.set(this.m_localAnchorB).subLocal(this.m_localCenterB), this.rB);
        this.d.set(cB).subLocal(cA).addLocal(this.rB).subLocal(this.rA);
        var ay = this.pool.popVec2();
        Rot.mulToOut(qA, this.m_localYAxisA, ay);
        var sAy = Vec2.cross(temp.set(this.d).addLocal(this.rA), ay);
        var sBy = Vec2.cross(this.rB, ay);
        var C = Vec2.dot(this.d, ay);
        var k = this.m_invMassA + this.m_invMassB + this.m_invIA * this.m_sAy * this.m_sAy + this.m_invIB * this.m_sBy * this.m_sBy;
        var impulse;
        if (k != 0.0) {
            impulse = -C / k;
        }
        else {
            impulse = 0.0;
        }
        var P = this.pool.popVec2();
        P.x = impulse * ay.x;
        P.y = impulse * ay.y;
        var LA = impulse * sAy;
        var LB = impulse * sBy;
        cA.x -= this.m_invMassA * P.x;
        cA.y -= this.m_invMassA * P.y;
        aA -= this.m_invIA * LA;
        cB.x += this.m_invMassB * P.x;
        cB.y += this.m_invMassB * P.y;
        aB += this.m_invIB * LB;
        this.pool.pushVec2(3);
        this.pool.pushRot(2);
        data.positions[this.m_indexA].a = aA;
        data.positions[this.m_indexB].a = aB;
        return dMath.Abs(C) <= Settings.linearSlop;
    };
    return WheelJoint;
}(Joint));
var WheelJointDef = (function (_super) {
    __extends(WheelJointDef, _super);
    function WheelJointDef() {
        var _this = _super.call(this, JointType.WHEEL) || this;
        _this.localAnchorA = new Vec2();
        _this.localAnchorB = new Vec2();
        _this.localAxisA = new Vec2();
        _this.frequencyHz = 0;
        _this.dampingRatio = 0;
        _this.localAxisA.setValue(1, 0);
        _this.enableMotor = false;
        _this.maxMotorTorque = 0;
        _this.motorSpeed = 0;
        return _this;
    }
    WheelJointDef.prototype.initialize = function (b1, b2, anchor, axis) {
        this.bodyA = b1;
        this.bodyB = b2;
        b1.getLocalPointToOut(anchor, this.localAnchorA);
        b2.getLocalPointToOut(anchor, this.localAnchorB);
        this.bodyA.getLocalVectorToOut(axis, this.localAxisA);
    };
    return WheelJointDef;
}(JointDef));
var DefaultWorldPool = (function () {
    function DefaultWorldPool(argSize) {
        this.vecs = null;
        this.vec3s = null;
        this.mats = null;
        this.mat33s = null;
        this.aabbs = null;
        this.rots = null;
        this.pcstack = null;
        this.ccstack = null;
        this.cpstack = null;
        this.ecstack = null;
        this.epstack = null;
        this.chcstack = null;
        this.chpstack = null;
        this.collision = null;
        this.toi = null;
        this.dist = null;
        DefaultWorldPool.world = this;
        this.vecs = new OrderedStack(argSize, function () {
            return new Vec2();
        });
        this.vec3s = new OrderedStack(argSize, function () {
            return new Vec3();
        });
        this.mats = new OrderedStack(argSize, function () {
            return new Mat22();
        });
        this.aabbs = new OrderedStack(argSize, function () {
            return new AABB();
        });
        this.rots = new OrderedStack(argSize, function () {
            return new Rot();
        });
        this.mat33s = new OrderedStack(argSize, function () {
            return new Mat33();
        });
        this.pcstack = new MutableStack(Settings.CONTACT_STACK_INIT_SIZE, function () {
            return new PolygonContact(DefaultWorldPool.world);
        });
        this.ccstack = new MutableStack(Settings.CONTACT_STACK_INIT_SIZE, function () {
            return new CircleContact(DefaultWorldPool.world);
        });
        this.cpstack = new MutableStack(Settings.CONTACT_STACK_INIT_SIZE, function () {
            return new PolygonAndCircleContact(DefaultWorldPool.world);
        });
        this.ecstack = new MutableStack(Settings.CONTACT_STACK_INIT_SIZE, function () {
            return new EdgeAndCircleContact(DefaultWorldPool.world);
        });
        this.epstack = new MutableStack(Settings.CONTACT_STACK_INIT_SIZE, function () {
            return new EdgeAndPolygonContact(DefaultWorldPool.world);
        });
        this.chcstack = new MutableStack(Settings.CONTACT_STACK_INIT_SIZE, function () {
            return new ChainAndCircleContact(DefaultWorldPool.world);
        });
        this.dist = new Distance();
        this.collision = new Collision(this);
        this.toi = new TimeOfImpact(this);
    }
    DefaultWorldPool.prototype.getPolyContactStack = function () {
        return this.pcstack;
    };
    DefaultWorldPool.prototype.getCircleContactStack = function () {
        return this.ccstack;
    };
    DefaultWorldPool.prototype.getPolyCircleContactStack = function () {
        return this.cpstack;
    };
    DefaultWorldPool.prototype.getEdgeCircleContactStack = function () {
        return this.ecstack;
    };
    DefaultWorldPool.prototype.getEdgePolyContactStack = function () {
        return this.epstack;
    };
    DefaultWorldPool.prototype.getChainCircleContactStack = function () {
        return this.chcstack;
    };
    DefaultWorldPool.prototype.getChainPolyContactStack = function () {
        return this.chpstack;
    };
    DefaultWorldPool.prototype.popVec2 = function () {
        return this.vecs.pop();
    };
    DefaultWorldPool.prototype.pushVec2 = function (argNum) {
        this.vecs.push(argNum);
    };
    DefaultWorldPool.prototype.popVec3 = function () {
        return this.vec3s.pop();
    };
    DefaultWorldPool.prototype.pushVec3 = function (argNum) {
        this.vec3s.push(argNum);
    };
    DefaultWorldPool.prototype.popMat22 = function () {
        return this.mats.pop();
    };
    DefaultWorldPool.prototype.pushMat22 = function (argNum) {
        this.mats.push(argNum);
    };
    DefaultWorldPool.prototype.popMat33 = function () {
        return this.mat33s.pop();
    };
    DefaultWorldPool.prototype.pushMat33 = function (argNum) {
        this.mat33s.push(argNum);
    };
    DefaultWorldPool.prototype.popAABB = function () {
        return this.aabbs.pop();
    };
    DefaultWorldPool.prototype.pushAABB = function (argNum) {
        this.aabbs.push(argNum);
    };
    DefaultWorldPool.prototype.popRot = function () {
        return this.rots.pop();
    };
    DefaultWorldPool.prototype.pushRot = function (num) {
        this.rots.push(num);
    };
    DefaultWorldPool.prototype.getCollision = function () {
        return this.collision;
    };
    DefaultWorldPool.prototype.getTimeOfImpact = function () {
        return this.toi;
    };
    DefaultWorldPool.prototype.getDistance = function () {
        return this.dist;
    };
    DefaultWorldPool.world = null;
    return DefaultWorldPool;
}());
var MutableStack = (function () {
    function MutableStack(argInitSize, onNewInstance) {
        this.stack = null;
        this.index = 0;
        this.size = 0;
        this.onNewInstance = null;
        this.index = 0;
        this.stack = null;
        this.index = 0;
        this.onNewInstance = onNewInstance;
        this.extendStack(argInitSize);
    }
    MutableStack.prototype.extendStack = function (argSize) {
        var newStack = new Array(argSize);
        if (this.stack != null) {
            for (var i = 0; i < this.size; i++)
                newStack[i] = this.stack[i];
        }
        for (var i = 0; i < newStack.length; i++) {
            newStack[i] = this.onNewInstance();
        }
        this.stack = newStack;
        this.size = newStack.length;
    };
    MutableStack.prototype.pop = function () {
        if (this.index >= this.size) {
            this.extendStack(this.size * 2);
        }
        return this.stack[this.index++];
    };
    MutableStack.prototype.push = function (argObject) {
        this.stack[--this.index] = argObject;
    };
    return MutableStack;
}());
var OrderedStack = (function () {
    function OrderedStack(argStackSize, onNewInstance) {
        this.pool = null;
        this.index = 0;
        this.size = 0;
        this.onNewInstance = null;
        this.size = argStackSize;
        this.onNewInstance = onNewInstance;
        this.pool = new Array(argStackSize);
        for (var i = 0; i < argStackSize; i++) {
            this.pool[i] = this.onNewInstance();
        }
        this.index = 0;
    }
    OrderedStack.prototype.pop = function () {
        if (this.index >= this.size) {
            var newPool = new Array(this.size * 2);
            for (var i = 0; i < this.size; i++)
                newPool[i] = this.pool[i];
            for (var i = this.size; i < this.size * 2; i++)
                newPool[i] = this.onNewInstance();
            this.size *= 2;
        }
        return this.pool[this.index++];
    };
    OrderedStack.prototype.push = function (argNum) {
        this.index -= argNum;
    };
    return OrderedStack;
}());
var FloatArray = (function () {
    function FloatArray() {
        this.map = new Map();
    }
    FloatArray.prototype.get = function (argLength) {
        if (!this.map.has(argLength)) {
            this.map.set(argLength, this.getInitializedArray(argLength));
        }
        return this.map.get(argLength);
    };
    FloatArray.prototype.getInitializedArray = function (argLength) {
        return new Array(argLength);
    };
    return FloatArray;
}());
var IntArray = (function () {
    function IntArray() {
        this.map = new Map();
    }
    IntArray.prototype.get = function (argLength) {
        if (!this.map.has(argLength)) {
            this.map.set(argLength, this.getInitializedArray(argLength));
        }
        return this.map.get(argLength);
    };
    IntArray.prototype.getInitializedArray = function (argLength) {
        return new Array(argLength);
    };
    return IntArray;
}());
var Vec2Array = (function () {
    function Vec2Array() {
        this.map = new Map();
    }
    Vec2Array.prototype.get = function (argLength) {
        if (!this.map.has(argLength)) {
            this.map.set(argLength, this.getInitializedArray(argLength));
        }
        return this.map.get(argLength);
    };
    Vec2Array.prototype.getInitializedArray = function (argLength) {
        var ray = new Array(argLength);
        for (var i = 0; i < ray.length; i++) {
            ray[i] = new Vec2();
        }
        return ray;
    };
    return Vec2Array;
}());
//# sourceMappingURL=MainGame.js.map